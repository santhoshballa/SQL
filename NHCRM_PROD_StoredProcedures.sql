ROUTINE_DEFINITION
create procedure [accounts].[DeleteExceptionsAndInit](   @InvoiceNbr nvarchar(1000)   )   as   begin    delete from [accounts].[InvoiceExceptions] where InvoiceNumber in (select value from openjson(@InvoiceNbr) with (value nvarchar(20) '$'));    delete from [accounts].[InvoicesInit] where InvoiceNumber in (select value from openjson(@InvoiceNbr) with (value nvarchar(20) '$'));   end  
create PROCEDURE [accounts].[GetVendorAddress](@BrandCode NVARCHAR(30))   AS  BEGIN  SELECT BrandName,BrandAddress1,BrandAddress2,BrandCity,BrandState,BrandZipCode  FROM [catalog].[Brands] WHERE BrandCode = @BrandCode  END  
CREATE PROCEDURE [accounts].[sp_GetBatchInvoiceIdsAuth]  (      @BatchIds NVARCHAR(200),   @VendorType NVARCHAR(10)  )  AS  BEGIN  DECLARE @sqlq NVARCHAR(MAX);  set @sqlq = 'select distinct inv.InvoiceId as InvoiceId from [accounts].[Invoices] as inv   inner join [orders].[OrderTransactionDetails] ot ON inv.OrderID = ot.OrderID INNER JOIN [orders].[orders] o on o.OrderID = ot.OrderID  inner join [accounts].[InvoiceItems] invitem   on inv.InvoiceId = invItem.InvoiceId  where inv.BatchID in (select value from openjson('''+@BatchIds+''') with (value nvarchar(20) ''$'')) and (inv.VendorType = '''+@VendorType+''') and inv.[Status] = ''Approval'''  EXEC sp_executesql @sqlq;  END  
  create PROCEDURE [accounts].[sp_PendingApprovalInvoices]  (   @ProviderId BIGINT,   @VendorType nvarchar(10)  )  AS  BEGIN  SELECT ROW_NUMBER() OVER (ORDER BY r.BatchID) AS RowID,r.* from (   select distinct inv.BatchID,a.CreateUser AS ApprovedBy,CONVERT(VARCHAR, a.CreateDate, 110) As ApprovedDate,   [dbo].[fn_GetInvoiceCount](inv.BatchID,@VendorType) AS 'InvoiceCount',[dbo].[fn_GetInvoiceAmount](inv.BatchID,@VendorType) AS 'Total'   FROM [accounts].[invoices] AS inv   INNER JOIN (SELECT * FROM accounts.InvoiceTransactions AS it WHERE it.[Status]='Approval' AND it.IsActive=1) AS invt   ON inv.InvoiceId = invt.InvoiceId INNER JOIN provider.providerprofiles AS pp   ON inv.ProviderId = pp.ProviderId INNER JOIN [accounts].[BatchRequests] a ON a.BatchID = inv.BatchID    WHERE (inv.VendorType=@VendorType)  AND inv.[Status]='Approval' AND a.BatchType = 'APPROVAL' AND inv.ProviderId IS NOT NULL    GROUP BY inv.BatchID,a.CreateUser,a.CreateDate)r  --IF(@ProviderId > 0)  -- BEGIN  -- SELECT ROW_NUMBER() OVER (ORDER BY inv.ProviderId) AS RowID,inv.ProviderId,pp.ProviderName AS 'ProviderName',  -- COUNT(*) AS 'InvoiceCount',CAST(SUM(inv.InvoiceAmount - ISNULL(JSON_VALUE(invt.TransactionData, '$.fee'), 0)) AS FLOAT) AS 'Total',  -- inv.BatchID,a.CreateUser AS ApprovedBy,CONVERT(VARCHAR, a.CreateDate, 101) AS ApprovedDate  -- FROM [accounts].[invoices] as inv  -- INNER JOIN (SELECT * FROM accounts.InvoiceTransactions AS it WHERE it.[Status]='Approval' AND it.IsActive=1) AS invt  -- ON inv.InvoiceId = invt.InvoiceId  -- INNER JOIN provider.providerprofiles AS pp  -- ON inv.ProviderId = pp.ProviderId  -- INNER JOIN [accounts].[BatchRequests] a ON a.BatchID = inv.BatchID   -- WHERE inv.VendorType='PRO' AND inv.[Status]='Approval' AND a.BatchType = 'APPROVAL'   -- AND inv.ProviderId IS NOT NULL AND  inv.ProviderId = @ProviderId   -- GROUP BY inv.ProviderId,pp.ProviderName,inv.BatchID,a.CreateUser,a.CreateDate  -- END  --ELSE  -- BEGIN  -- SELECT ROW_NUMBER() OVER (ORDER BY inv.ProviderId) AS RowID,inv.ProviderId,pp.ProviderName AS 'ProviderName',  -- COUNT(*) AS 'InvoiceCount',CAST(SUM(inv.InvoiceAmount - ISNULL(JSON_VALUE(invt.TransactionData, '$.fee'), 0)) AS FLOAT) AS 'Total',  -- inv.BatchID,a.CreateUser AS ApprovedBy,CONVERT(VARCHAR, a.CreateDate, 101) As ApprovedDate  -- FROM [accounts].[invoices] AS inv  -- INNER JOIN (SELECT * FROM accounts.InvoiceTransactions AS it WHERE it.[Status]='Approval' AND it.IsActive=1) AS invt  -- ON inv.InvoiceId = invt.InvoiceId INNER JOIN provider.providerprofiles AS pp  -- ON inv.ProviderId = pp.ProviderId INNER JOIN [accounts].[BatchRequests] a ON a.BatchID = inv.BatchID   -- WHERE inv.VendorType='PRO' AND inv.[Status]='Approval' AND a.BatchType = 'APPROVAL' AND inv.ProviderId IS NOT NULL   -- GROUP BY inv.ProviderId,pp.ProviderName,inv.BatchID,a.CreateUser,a.CreateDate  -- END  END  
  CREATE PROCEDURE [accounts].[MoveInvoiceanditsItemsToHistory] (@PONumber nvarchar(20))  AS  BEGIN    Declare @sourceID bigint;  set @sourceID = 0;  Declare @InvoiceID bigint;  set @InvoiceID = 0;  Declare @invoiceIDOriginalTable bigint;  set @invoiceIDOriginalTable = 0;    BEGIN TRAN    BEGIN TRY     set @sourceID = (select SourceID FROM [accounts].[Invoices] WHERE PONumber IN (LTRIM(RTRIM(@PONumber))));           set @invoiceIDOriginalTable = (select InvoiceID FROM [accounts].[Invoices] WHERE PONumber IN (LTRIM(RTRIM(@PONumber))));       insert into [accounts].[InvoicesHistory] select [Source],[SourceId],[VendorType],[PONumber],[InvoiceNumber],[InvoiceDate],[InvoiceDueDate],[InvoiceAmount],[ProviderData],[PaymentData],[ProviderId],[BrandCode],[OrderID],[ShippingData],[BatchId],[Status],[Remarks],[IsDocsSubmitted],[CreateUser],[CreateDate],[ModifyUser],[ModifyDate],[IsActive],[PaymentMethod],[VendorAccountId] from [accounts].[Invoices] where PONumber IN (LTRIM(RTRIM(@PONumber)));     set @InvoiceID = (select top 1 InvoiceID from [accounts].[InvoicesHistory] where SourceID = @sourceID and PONumber in (LTRIM(RTRIM(@PONumber))));     insert into [accounts].[InvoiceItemsHistory] select @InvoiceID,[ItemCode],[ItemDescription],[Modifier],[Quantity],[Cost],[ItemData],[ItemDetailsData],[CreateUser],[CreateDate],[ModifyUser],[ModifyDate],[IsActive] from [accounts].[InvoiceItems] where invoiceID  = @invoiceIDOriginalTable;      delete from [accounts].[InvoiceItems] where invoiceID = @invoiceIDOriginalTable;   delete from [accounts].[Invoices] where invoiceID = @invoiceIDOriginalTable;             COMMIT TRAN     return 1;    END TRY  BEGIN CATCH        ROLLBACK TRAN    return 0;  END CATCH      END    
  CREATE procedure [accounts].[GetMissingInvoices](   @orderItemIds nvarchar(max) = '[]'  ,@itemData nvarchar(max) = '[]'  )  as     begin  if (@orderItemIds is not null and @orderItemIds <> '')  begin   declare @UploadInvoices table(    InvoiceDate date,    OrderItemId bigint,    PODate date   );   insert into @UploadInvoices   select * from openjson(@orderItemIds)   with (   InvoiceDate date '$.invDate',   OrderItemId bigint '$.itemId',   PODate date '$.poDate'   );   select   it.[ItemCode] as ItemCode   ,it.[ItemData] as ItemData   ,it.OrderItemId   ,cast(o.[OrderId] as nvarchar) as OrderId   ,it.[BrandCode] as BrandCode   ,json_value(o.[ProviderData], '$.providerId') as ProviderID   ,json_value(o.[ShippingData], '$.locationId') as LocationId   ,cast(it.[Quantity] as nvarchar) as Quantity   ,json_value(it.[ItemData], '$.color') as Color   ,json_value(it.[ItemData], '$.batterySize') as BatterySize   ,case when it.ItemType = 'EM'     then null     else [dbo].[getunitPriceofItem](     po.PODate     ,it.[ItemCode]     ,ihp.[IsMedicaid]     ,ic.[InsuranceCarrierName]      ) end UnitPrice   ,cast(case sf.[ShippingAmount] when 0 then null else sf.[ShippingAmount] end as nvarchar) as ShippingFee   ,null as SalesTax   ,case when o.Source = 'VS' then po.OrderPORefNbr else  po.PONumber end as [NationsHearingPO]   ,case when st.[SalesTaxPercentage] is not null then cast(st.[SalesTaxPercentage] as nvarchar) else null end as SalesTaxPercent   ,case when it.ItemType = 'EM'     then null     else [dbo].[getPriceTypeofItem](     po.PODate     ,it.[ItemCode]     ,ihp.[IsMedicaid]     ,ic.[InsuranceCarrierName]      ) end PriceType   from    [Orders].[OrderItems] it     inner join [Orders].[Orders] o   on it.[OrderId] = o.[OrderId]     inner join [Orders].[OrderPOs] po   on o.OrderID = po.OrderId     inner join [Insurance].[InsuranceCarriers] ic   on ic.[InsuranceCarrierID]=json_value(o.[MemberData], '$.insCarrierId')     inner join [Insurance].[InsuranceHealthPlans] ihp   on ihp.[InsuranceHealthPlanID]=json_value(o.[MemberData], '$.insPlanId')     inner join @UploadInvoices up   on up.OrderItemId = it.OrderItemId     left join [catalog].[BrandShippingFees] sf   on it.[BrandCode] is not null and sf.[BrandCode] = it.[BrandCode] and sf.[ISACTIVE]=1     left join [catalog].[BrandSalesTax] st   on st.[BrandCode] = it.[BrandCode] and st.[IsActive]=1 and st.[StateCode] = json_value(o.[ShippingData], '$.address.state')     where it.[IsActive]=1   --and it.OrderItemId in (select * from openjson(@orderItemIds) with (OrderItemId bigint '$'))    end  else if(@itemData is not null and @itemData <> '')  begin   declare @UploadInvoices1 table(    PONumber nvarchar(100),    InvoiceNumber nvarchar(20),    ItemCode nvarchar(100),    Modifier nvarchar(5),    InvoiceDate date,    PODate date   );   insert into @UploadInvoices1   select * from openjson(@itemData)   with (   PONumber nvarchar(100) '$.po',   InvoiceNumber nvarchar(20) '$.inv',   ItemCode nvarchar(100) '$.it',   Modifier nvarchar(5) '$.mod',   InvoiceDate date '$.invDate',   PODate date '$.poDate'   );   select    cast(it.[OrderItemId] as nvarchar) as OrderItemId   ,it.[ItemCode] as ItemCode   ,it.[Modifier] as Modifier   ,cast(it.[PONumber] as nvarchar) as NationsHearingPO   ,it.[InvoiceNumber] as InvoiceNumber   ,convert(nvarchar, up.InvoiceDate, 110) as InvoiceDate   ,case    when bp.MonthNo is null then      convert(nvarchar, dateadd(day, bp.DayNo, up.InvoiceDate), 110)    else     concat(substring(concat('0', month(dateadd(month, bp.MonthNo, up.InvoiceDate))), len(concat('0', month(dateadd(month, bp.MonthNo, up.InvoiceDate)))-1), 2), '-', substring(concat('0', bp.DayNo), len(concat('0', bp.DayNo))-1, 2), '-', year(dateadd(month, bp.MonthNo, up.InvoiceDate)))    end   as DueDate      ,null as PartNo   ,null as SN   ,null as RepairWarrantyEnds   ,null as LnDWarrantyEnds   ,null as Supplies   ,null as RemakeWarrantyEnd   ,null as ReceiverDetails   ,it.[ItemType] as ItemType   ,null as Remarks   ,
CREATE function [accounts].[CheckNumiricORNot]  (   @value varchar(50)  )  returns bigint  as   begin        return((CASE         WHEN        (isnumeric(@value) = 1)          THEN        CAST(@value AS bigint)         ELSE        0         END))    end    
CREATE procedure [accounts].[GetPOs](   @PONumbers nvarchar(max)  )  as  begin    select pos.*    ,(select PODate from (select *  from openjson(tr.ordertransactiondata)    with (PODate date '$.poDate', PONumber nvarchar(50) '$.poNumber')) res    where PONumber=cast(pos.PONumber as nvarchar)) as PODate    --,(select top (1) cast(json_value(tr.ordertransactiondata, '$.poDate') as date) from orders.ordertransactiondetails tr where tr.orderid=pos.orderid and tr.orderstatuscode='PO' and tr.isactive=1 and tr.iscomplete=1) as PODate    from Orders.OrderPOs pos    left join Orders.OrderTransactionDetails tr    on tr.OrderId = pos.OrderId and tr.orderstatuscode='PO'    and tr.IsComplete=1 and tr.IsActive=1    where pos.IsActive=1 and    cast(pos.PONumber as nvarchar) in (select value from openjson(@PONumbers) with (value nvarchar(15) '$'));  end       
  CREATE PROCEDURE [accounts].[sp_GetPendingAuthorizeClaims]  (      @InsuranceCarrierId BIGINT,      @VendorType nvarchar(10)  )  AS  BEGIN  SELECT ROW_NUMBER() OVER (ORDER BY r.BatchID) AS RowID,r.* from (          select distinct inv.BatchID      ,concat('[',string_agg(cast(inv.InvoiceId as nvarchar(max)),','), ']') as InvoiceIds      ,a.CreateUser AS RequestedBy,CONVERT(VARCHAR, a.CreateDate, 110) As RequestedDate,      cast(COUNT(*) AS int) 'InvoiceCount',      CAST(SUM(inv.InvoiceAmount) AS FLOAT) AS 'Total',       Json_value(inv.[VendorData],'$.insuranceCarrierName') InsuranceCarrierName,      'New' as FileType,accounts.CheckNumiricORNot(inv.[VendorRefId]) InsuranceCarrierId      from       [accounts].[invoices] AS inv      inner join  [accounts].[BatchRequests] a ON a.BatchID = inv.BatchID and a.isactive = 1      inner join [Insurance].[InsuranceCarriers] ins on ins.[InsuranceCarrierID] = accounts.CheckNumiricORNot(inv.[VendorRefId])             WHERE inv.VendorType=@VendorType AND inv.[Status]='Approval' AND a.BatchType = 'APPROVAL' and inv.isactive = 1 and inv.BatchID is not null            GROUP BY inv.BatchID,Json_value(inv.[VendorData],'$.insuranceCarrierName'),accounts.CheckNumiricORNot(inv.[VendorRefId]),a.CreateUser,a.CreateDate) r     END    
   CREATE PROCEDURE [accounts].[sp_GetPendingApprovalInvoicesByProvider]  (   @ProviderId BIGINT,   @VendorType nvarchar(10)  )  AS  BEGIN    select ROW_NUMBER() OVER (ORDER BY r.InvoiceID) AS RowID, r.* from  (SELECT distinct pp.ProviderName AS 'ProviderName',inv.InvoiceID,  JSON_VALUE(iit.[ItemData], '$.nhMemberId') AS 'NHMemberID',inv.PONumber,JSON_VALUE(iit.[ItemData], '$.orderStatus') AS 'OrderStatus',  JSON_VALUE(iit.[ItemData], '$.fittingDate') AS 'FittingDate',  JSON_VALUE(iit.[ItemData], '$.memberFirstName')  + ' ' +  JSON_VALUE(iit.[ItemData], '$.memberLastName') AS 'MemberName',  CAST(JSON_VALUE(iit.[ItemData], '$.dispensingFee') AS FLOAT) AS 'DispensingFee',CAST(InvoiceAmount AS FLOAT) AS InvoiceAmount,  CAST(0 AS FLOAT) AS Credit,  (InvoiceAmount - CAST(ISNULL(JSON_VALUE(invt.[TransactionData], '$.fee'), 0) AS FLOAT) - CAST(0 AS FLOAT)) AS InvoicesSelected,BatchID  FROM [accounts].[invoices] AS inv INNER JOIN [accounts].[InvoiceItems] iit on inv.InvoiceId = iit.InvoiceId  INNER  JOIN (SELECT * FROM accounts.InvoiceTransactions AS it WHERE it.[Status]='Approval' AND it.IsActive=1) AS invt  ON inv.InvoiceId = invt.InvoiceId INNER JOIN provider.providerprofiles AS pp ON inv.ProviderId = pp.ProviderId   WHERE (inv.VendorType=@VendorType) AND inv.[Status]='Approval' AND inv.ProviderId IS NOT NULL AND inv.BatchID IS NOT NULL)r  --AND inv.ProviderId IS NOT NULL AND inv.ProviderId = @ProviderId) r      --SELECT ROW_NUMBER() OVER (ORDER BY inv.InvoiceID) AS RowID,pp.ProviderName AS 'ProviderName',inv.InvoiceID,  --JSON_VALUE(iit.[ItemData], '$.nhMemberId') AS 'NHMemberID',inv.PONumber,JSON_VALUE(iit.[ItemData], '$.orderStatus') AS 'OrderStatus',  --JSON_VALUE(iit.[ItemData], '$.fittingDate') AS 'FittingDate',  --JSON_VALUE(iit.[ItemData], '$.memberFirstName')  + ' ' +  JSON_VALUE(iit.[ItemData], '$.memberLastName') AS 'MemberName',  --CAST(JSON_VALUE(iit.[ItemData], '$.dispensingFee') AS FLOAT) AS 'DispensingFee',CAST(InvoiceAmount AS FLOAT) AS InvoiceAmount,  --CAST(0 AS FLOAT) AS Credit,  --(InvoiceAmount - CAST(ISNULL(JSON_VALUE(invt.[TransactionData], '$.fee'), 0) AS FLOAT) - CAST(0 AS FLOAT)) AS InvoicesSelected,BatchID  --FROM [accounts].[invoices] AS inv INNER JOIN [accounts].[InvoiceItems] iit on inv.InvoiceId = iit.InvoiceId  --INNER  JOIN (SELECT * FROM accounts.InvoiceTransactions AS it WHERE it.[Status]='Approval' AND it.IsActive=1) AS invt  --ON inv.InvoiceId = invt.InvoiceId INNER JOIN provider.providerprofiles AS pp ON inv.ProviderId = pp.ProviderId   --WHERE inv.VendorType='PRO' AND inv.[Status]='Approval' AND inv.ProviderId IS NOT NULL AND inv.ProviderId = @ProviderId  END  
CREATE PROCEDURE [accounts].[GetLSNDWarrantyDate](@OrderID BIGINT, @Type varchar(10) = 'DEFAULT')  AS  BEGIN  if(@Type = 'INVOICE')  begin   SELECT  top (1) 1 AS ID, CAST(JSON_VALUE(ItemDetailsData, '$.lnDWarrantyEndDate') AS DATE) AS 'WarrantyEndDate' FROM [accounts].[InvoiceItems] WHERE JSON_VALUE(ItemData, '$.orderId') = @OrderID and IsActive=1  end  else if(@Type ='DEFAULT')  begin   SELECT top (1)  1 as ID,    (select res.PODate from (select *  from openjson(tr.ordertransactiondata)    with (PODate date '$.poDate', PONumber nvarchar(50) '$.poNumber')) res    where res.PONumber=cast(it.PONumber as nvarchar)) as PODate   FROM [Orders].[OrderItems] it   inner join [catalog].[Brands] br   on br.[BrandCode]=it.[BrandCode]   inner join [Orders].[OrderTransactionDetails] tr   on tr.[OrderId] = it.[OrderId] and tr.[OrderStatusCode]='PO'   WHERE it.[OrderId] = @OrderID and it.IsActive=1  end  END
CREATE PROCEDURE [accounts].[sp_GetProviderInvoiceIds]  (      @ProviderIds NVARCHAR(200),   @ProviderLegalName NVARCHAR(100),   @EffPOFromDate NVARCHAR(50),   @EffPOToDate NVARCHAR(50),   @DocsReceived NVARCHAR(5),   @InvoiceStatuses_json NVARCHAR(50),   @OrderStatuses_json NVARCHAR(50)  )  AS  BEGIN  DECLARE @sqlq NVARCHAR(2000);  SET @sqlq = 'select distinct inv.InvoiceId as InvoiceId from [accounts].[Invoices] as inv inner join [orders].[OrderTransactionDetails] ot ON inv.OrderID = ot.OrderID INNER JOIN [orders].[orders] o on o.OrderID = ot.OrderID               inner join [accounts].[InvoiceItems] invitem                on inv.InvoiceId = invItem.InvoiceId     join provider.ProviderProfiles as pp     on (pp.IsActive = 1 and cast(json_value(inv.[ProviderData], ''$.providerId'') as bigint) = pp.ProviderId'     +     ' and pp.ProviderId in (select value from openjson('''+@ProviderIds+''') with (value nvarchar(20) ''$''))'     +     ' and pp.ProviderName like ''%%'''     +     ')'     +     ' where inv.VendorType = ''PRO'''     + CASE WHEN @InvoiceStatuses_json is not null and @InvoiceStatuses_json <> '' THEN      ' and case when (inv.[Status]=''Initiated'' or (inv.[Status] = ''Approval''))      then case when  InvoiceDueDate IS NOT NULL AND CONVERT(NVARCHAR,CAST(InvoiceDueDate AS DATE),111) < CONVERT(NVARCHAR, CAST(GETDATE() AS DATE),111) then ''Due'' else ''Open'' end else inv.Status end in (select value from openjson('''+@InvoiceStatuses_json+''') with (value nvarchar(20) ''$''))' else '' end     +case when @OrderStatuses_json is not null and @OrderStatuses_json <> '' then  ' and o.Status in (select value from openjson('''+@OrderStatuses_json+''') with (value nvarchar(20) ''$''))' else '' end     +     case when @EffPOFromDate is not null and @EffPOFromDate != '' then ' and o.OrderStatusCode = ''PO'' and convert(nvarchar, cast(' + '''' +  @EffPOToDate + '''' + ' as date), 111) <= convert(nvarchar, cast(json_value(ot.[OrderTransactionData], ''$.poDate'') as date), 111)' else  '' end     +     case when @EffPOToDate is not null and @EffPOToDate != '' then ' and o.OrderStatusCode = ''PO'' and convert(nvarchar, cast(' + '''' + @EffPOToDate +  '''' + ' as date), 111)>= convert(nvarchar, cast(json_value(ot.[OrderTransactionData], ''$.poDate'') as date), 111)' else '' end     +     case when @DocsReceived = 'Yes' then ' and IsDocsSubmitted = 1' when  @DocsReceived = 'No' then ' and IsDocsSubmitted = 0' else '' end;  --print @sqlq  EXEC sp_executesql @sqlq;  END  
      CREATE PROCEDURE [accounts].[sp_GetProviderInvoiceIdsAuth]  (      @ProviderIds NVARCHAR(200)  )  AS  BEGIN  DECLARE @sqlq NVARCHAR(MAX);  SET @sqlq = 'select distinct inv.InvoiceId as InvoiceId from [accounts].[Invoices] as inv inner join [orders].[OrderTransactionDetails] ot ON inv.OrderID = ot.OrderID INNER JOIN [orders].[orders] o on o.OrderID = ot.OrderID               inner join [accounts].[InvoiceItems] invitem                on inv.InvoiceId = invItem.InvoiceId     join provider.ProviderProfiles as pp     on (pp.IsActive = 1 and cast(json_value(inv.[ProviderData], ''$.providerId'') as bigint) = pp.ProviderId'     +     ' and pp.ProviderId in (select value from openjson('''+@ProviderIds+''') with (value nvarchar(20) ''$''))'     +     ' and pp.ProviderName like ''%%'''     +     ')'     +     ' where (inv.VendorType = ''PRO'' or inv.VendorType = ''MFG'') and inv.[Status] = ''Approval'''  print @sqlq  EXEC sp_executesql @sqlq;  END  
CREATE PROCEDURE [accounts].[UpdateInvoiceDocStatus]  (    @OrderID bigint  )  AS  BEGIN      update [accounts].[Invoices] set IsDocsSubmitted = 1 where orderId = @OrderID  END  
  CREATE PROCEDURE [accounts].[GetCOGSPrice](@InsuranceCarrierID BIGINT, @InsuranceHealthPlanID BIGINT, @FamilyProductCode NVARCHAR(50))  AS  BEGIN  SELECT PerDeviceCOGSPrice AS Amount   FROM [insurance].[ContractProducts]  WHERE HealthPlanContractID IN          (SELECT TOP 1 HealthPlanContractID          FROM [insurance].[HealthPlanContracts]          WHERE InsuranceCarrierID = @InsuranceCarrierID AND InsuranceHealthPlanID  = @InsuranceHealthPlanID)   AND FamilyProductCode = @FamilyProductCode  END  
CREATE PROCEDURE [accounts].[sp_GetClaimsbyInvoiceIds]  (   @InvoiceIds nvarchar(max)  )  as  begin  select row_number() over (order by inv.InvoiceId) as RowID  ,inv.[InvoiceId] as InvoiceId  ,inv.[VendorData]   ,Json_value(inv.[VendorData],'$.insuranceID') NobleInsuranceID,  isnull(Json_value(inv.[VendorData],'$.nhMemberId'),'') NHMemberId,  Json_value(inv.[VendorData],'$.insuranceCarrierName') InsuranceCarrierName,  json_value(inv.[VendorData], '$.member_first_name') FirstName  ,json_value(inv.[VendorData], '$.member_last_name') LastName,  json_value(inv.[VendorData], '$.policy_number') PolicyNumber,  CONCAT(isnull(json_value(inv.[VendorData], '$.member_first_name'),''),' ',isnull(json_value(inv.[VendorData], '$.member_last_name'),'')) as MemberFullName,  inv.[InvoiceAmount],  isnull(cast(json_value(inv.[VendorData], '$.itemData[0].date_of_Service') as date),'') DateofService,  json_value(inv.[VendorData], '$.itemData[0].serviceType') ServiceType,  inv.[OrderID],  [InvoiceDueDate],  [Remarks],  cast(isnull(inv.ClaimNumber,0) as bigint) as InvoiceNumber,  inv.[Status] as ActualInvoiceStatus,   inv.[Status] as DerivedInvoiceStatus,   json_value(inv.[VendorData], '$.itemData[0].status') as ItemStatus,  accounts.CheckNumiricORNot(inv.[VendorRefId]) as InsuranceCarrierId,  isnull((inv.InvoiceAmount - (case inv.[Status] when 'InProcess' then isnull(cast(json_value(inv.[PaymentData], '$.invoicePayment') as float), 0) when 'Paid' then isnull(cast(json_value(inv.[PaymentData], '$.invoicePayment') as float), 0) when 'Authorize' then isnull(cast(json_value(inv.[PaymentData], '$.invoicePayment') as float), 0) else 0 end)),0) as TotalBalance   from [accounts].[Invoices] as inv    where inv.vendortype='clm' and inv.InvoiceId in (select value from openjson(@InvoiceIds) with (value bigint '$')) order by Json_value(inv.[VendorData],'$.nhMemberId')  end
  CREATE procedure [accounts].[UpdateInvoiceNumbers]  (      @input nvarchar(max)  )  as  begin  --declare @input nvarchar(2000);  --set @input = '[{"itmId": 15601, "inv": "14-A577095","modifyUser":"testraju"}]';  declare @UpdateInvoices table(   OrderItemId bigint,   InvoiceNumber nvarchar(100),   ModifyUser nvarchar(50)  );  insert into @UpdateInvoices  select * from openjson(@input)  with (   OrderItemId bigint '$.itmId',   InvoiceNumber nvarchar(100) '$.inv',   ModifyUser nvarchar(50) '$.modifyUser'  );  update it  set invoicenumber = up.InvoiceNumber, ModifyUser= up.ModifyUser ,ModifyDate=getdate()  from orders.orderitems it  inner join @UpdateInvoices up  on it.OrderItemId = up.OrderItemId  end  
  /*  Mohan deployed to Production on 12 May 2020  */  CREATE PROCEDURE [accounts].[GetAllPassthroughClaims]  (     @payerId bigint,     @fromDate NVARCHAR(50) = null,     @toDate NVARCHAR(50) = null    )  AS  BEGIN      -- SET NOCOUNT ON added to prevent extra result sets from      -- interfering with SELECT statements.      SET NOCOUNT ON        -- Insert statements for procedure here     --declare @CONST_Status_Complete varchar(20) = 'COMPLETE';    select * from   (      select       convert(int, ROW_NUMBER() OVER(ORDER BY c.NHMemberId ASC)) AS Row,      c.NHMemberId      ,c.FirstName      ,c.LastName      ,'' as Subscriber      ,c.GroupNumber      , case when c.ServiceType is null or c.ServiceType ='' then ( case when c.MinorProcessId=16  then 'Testing'  else 'Fitting' end )  else c.ServiceType end as ServiceType      ,c.Vcode      ,'' as ItemId      ,convert(nvarchar,c.DateOfService,111) as DateOfService      ,c.ICD10      ,Isnull(convert(decimal(10,2), c.ChargeAmount),0) as ChargeAmount      ,'' as Modifier      ,1 as Unit      ,'' as PaidData      ,Isnull(convert(decimal(10,2), c.ChargeAmount),0) as TotalClaimAmount      ,hc.[Description] as VcodeDescription      ,icc.[Description] as ICD10Description      ,c.InsuranceCarrierId      ,c.InsuranceCarrierName      from       (      SELECT       mp.NHMemberId      ,mp.FirstName      ,mp.LastName      ,jsonValues.GroupNumber      ,jsonValues.ServiceType      ,jsonValues.hCPCCS as Vcode      ,mcd.minorProcessId      , CONVERT(date,  mapt.EndTime, 111) as DateOfService      ,(case    when CAST(JSON_VALUE(mcd.ProcessData, '$.InsuranceCarrierId') as NVARCHAR(50)) IS NULL                   then ic.InsuranceCarrierID                  else JSON_VALUE(mcd.ProcessData, '$.InsuranceCarrierId') end) as InsuranceCarrierID        ,(case    when CAST(JSON_VALUE(mcd.ProcessData, '$.InsuranceCarrierName') as NVARCHAR(50)) IS NULL                   then ic.InsuranceCarrierName                  else JSON_VALUE(mcd.ProcessData, '$.InsuranceCarrierName') end) as InsuranceCarrierName      ,jsonValues.iCD10      ,jsonValues.chargeAmount           from [provider].[MemberChartData] mcd        inner join [provider].[MemberCharts] mc     on mc.IsActive=1 and   mc.MemberChartId = mcd.MemberChartId        inner join [provider].MemberInsurances mi   on mi.IsActive=1 and   mi.MemberProfileId = mc.MemberProfileId         inner join [provider].MemberProfiles mp     on mp.IsActive=1 and   mp.MemberProfileId = mi.MemberProfileId        inner join [Insurance].InsuranceCarriers ic on ic.IsActive=1 and   ic.InsuranceCarrierID = mi.InsuranceCarrierID        inner join provider.MemberAppointments mapt on mapt.MemberChartDataId =  mcd.MemberChartDataId  and mapt.IsActive=1        and ( UPPER(mapt.AppointmentStatus)= 'COMPLETE')        CROSS APPLY OPENJSON(mcd.ProcessData,'$.serviceData')         WITH (hCPCCS nvarchar(255) '$.hCPCCS',ICD10 nvarchar(255) '$.iCD10',ServiceType nvarchar(255) '$.serviceType'        ,GroupNumber nvarchar(255) '$.groupNumber',ChargeAmount nvarchar(255) '$.chargeAmount') as jsonValues        where minorProcessId in( 16,25)        and JSON_QUERY(ProcessData,'$.serviceData') is not null and ic.AllowAdditionalServices=1        and jsonValues.hCPCCS !='' and jsonValues.iCD10 !='') c         left join [healthcare].[HCPCSCodes] hc on hc.code=c.Vcode and hc.isactive=1        left join [healthcare].[ICD10Codes] icc on icc.code=c.ICD10 and hc.isactive=1     ) c1   where   c1.DateOfService >= '2020/01/01' and ((c1.DateOfService >= @fromDate and c1.DateOfService < DATEADD(day,1,@toDate))    OR (@fromDate IS NULL AND @toDate IS NULL)   OR (@fromDate IS NULL AND (c1.DateOfService < DATEADD(day,1,@toDate)))   OR (@toDate IS NULL AND (c1.DateOfService >= @fromDate)))    and  (@payerId =0 OR @payerId is null OR c1.InsuranceCarrierID = @payerId)  END
/*  Mohan deployed to Production on 12 May 2020  */    CREATE PROCEDURE [accounts].[sp_ManufacturersPaymentSingleInvoiceIDs]   (   @InvoiceIds nvarchar(max)  )  as  begin  declare @sqlq1 nvarchar(max);  declare @sqlq2 nvarchar(max);    set @sqlq1 = 'select distinct     inv.[InvoiceId] as InvoiceId    ,inv.[InvoiceNumber]    ,bb.BrandId as BrandId    ,bb.BrandName as BrandName    ,bb.BrandCode    ,inv.invoiceDate InvoiceDate    ,ord.OrderId OrderId    ,ord.Status as OrderStatus    ,ord.OrderType as OrderType    ,inv.[Status] as ActualInvoiceStatus    ,(case when (inv.[Status]=''Initiated'') then (case when inv.InvoiceDueDate < getdate() then ''Due'' else ''Open'' end) else inv.[Status] end)  as DerivedInvoiceStatus    ,DateAdd(day,-60,inv.invoiceDueDate) FittingDate    ,cast(json_value(invitm.[ItemData], ''$.docsReceivedDate'') as date) as DocsReceivedDate    ,isnull(datediff(day, convert(nvarchar, cast(DateAdd(day,-60,inv.invoiceDueDate) as date), 111), convert(nvarchar, getdate(), 111)), 0) as ServiceDays    ,concat(json_value(ord.[MemberData], ''$.firstName''), '' '', json_value(ord.[MemberData], ''$.lastName'')) as MemberName    ,ord.NHMemberId as NHMemberId    ,inv.[PONumber] as PONumber    ,CONVERT(bigint,          CASE          WHEN IsNumeric(CONVERT(VARCHAR(12), inv.[VendorRefId])) = 1 THEN CONVERT(VARCHAR(12),inv.[VendorRefId])          ELSE 0 END) as ProviderId    ,TransactionDatajsonValues.poDate as PODate    ,inv.[InvoiceDueDate] as InvoiceDueDate    ,isnull(cast(json_value(invitm.[ItemData], ''$.dispensingFee'') as float),0) as DispensingFee    ,isnull(cast(json_value(invitm.[ItemData], ''$.deviceCount'') as int),0) as DeviceCount    ,isnull(cast((invitm.Quantity * invitm.Cost) as float),0) as COGSPrice    ,isnull(cast(ship.ShippingAmount as float),0) as ShippingAmount    ,isnull(cast(inv.InvoiceAmount as float),0) as TotalFee    ,isnull(cast(0 as float),0) as RebateAmount    ,isnull(cast(0 as float),0) as SalesTaxAmount    ,case inv.[Status] when ''InProcess'' then isnull(cast(json_value(inv.[PaymentData], ''$.invoicePayment'') as float), 0) when ''Paid'' then isnull(cast(json_value(inv.[PaymentData], ''$.invoicePayment'') as float), 0) when ''Authorize'' then isnull(cast(json_value(inv.[PaymentData], ''$.invoicePayment'') as float), 0) else 0 end as TotalPaid    ,cast(isnull(json_value(inv.[PaymentData], ''$.creditApplied''), 0) as float) as Credit    ,isnull((inv.InvoiceAmount - (case inv.[Status] when ''InProcess'' then isnull(cast(json_value(inv.[PaymentData], ''$.invoicePayment'') as float), 0) when ''Paid'' then isnull(cast(json_value(inv.[PaymentData], ''$.invoicePayment'') as float), 0) when ''Authorize'' then isnull(cast(json_value(inv.[PaymentData], ''$.invoicePayment'') as float), 0) else 0 end)),0) as TotalBalance    ,inv.isDocsSubmitted as DocsReceived    ,inv.[Remarks] as Remarks    ,'''' as ProviderAddress1    ,'''' as ProviderLegalBusinessName       ,json_value(inv.[PaymentData], ''$.paymentMethod'') as PaymentMethod    ,''MarkAsPaid'' as PreferredPaymentType    ,va.[VendorAccountID] as VendorAccountId    from [accounts].[Invoices] as inv    join (select sum(Quantity) as Quantity,ItemData,Cost,InvoiceId from [accounts].[InvoiceItems]      where  Cost>0 and ItemCode!=''Others'' group by ItemData,Cost,InvoiceId ) as invitm on invitm.InvoiceId=inv.InvoiceId     join [Orders].[OrderTransactionDetails] as otd CROSS APPLY OPENJSON(otd.OrderTransactionData) WITH (poDate date ''$.poDate'') as TransactionDatajsonValues on(otd.[OrderID]=inv.OrderID) and [OrderStatusCode]=''PO''    join [Orders].[Orders] as ord on inv.OrderId=ord.OrderId    left join [catalog].[Brands] as bb on (bb.[BrandCode] = inv.[VendorRefId])    left join [catalog].[BrandShippingFees] as ship on(inv.[VendorRefId] = ship.[BrandCode])                                                               left join [accounts].[VendorAccounts] as va on (inv.[VendorRefId] = va.[VendorRefId])      where inv.IsActive = 1 and inv.VendorType = ''MFG'' and
  CREATE procedure [accounts].[GetPODetails](   @po bigint   )   as   begin   select top 1 att.[MailHistoryAttachmentId] as ID, pos.OrderId as OrderId, att.[MailAttachmentData] as PODocument, att.[MailAttachmentName] as DocumentName         from [contact].[MailHistoryAttachments] att         inner join orders.orderpos pos         on pos.[MailHistoryAttachmentId] = att.[MailHistoryAttachmentId]         where pos.ponumber=@po and att.IsActive=1 and pos.IsActive=1   end    
CREATE PROCEDURE [accounts].[sp_GetPendingApprovalInvoices]  (   @ProviderId BIGINT,   @VendorType nvarchar(10)  )  AS  BEGIN  SELECT ROW_NUMBER() OVER (ORDER BY r.BatchID) AS RowID,r.* from (    select distinct inv.BatchID   ,concat('[',string_agg(cast(inv.InvoiceId as nvarchar(max)),','), ']') as InvoiceIds   ,a.CreateUser AS ApprovedBy,CONVERT(VARCHAR, a.CreateDate, 110) As ApprovedDate,   cast(COUNT(*) AS int) 'InvoiceCount',CAST(SUM(inv.InvoiceAmount - ISNULL(JSON_VALUE(inv.PaymentData, '$.creditApplied'), 0)) AS FLOAT) AS 'Total'   from    [accounts].[invoices] AS inv   inner join  [accounts].[BatchRequests] a ON a.BatchID = inv.BatchID and a.isactive = 1   --left join accounts.InvoiceTransactions t on t.invoiceid = inv.invoiceid and t.isactive = 1   WHERE inv.VendorType=@VendorType AND inv.[Status]='Approval' AND a.BatchType = 'APPROVAL' and inv.isactive = 1    --AND inv.ProviderId IS NOT NULL(removed this condition as we using vendorrefid not nullcolumn )   GROUP BY inv.BatchID,a.CreateUser,a.CreateDate)r    END  
  CREATE PROCEDURE [accounts].[DeleteInvoiceExceptions](   @InvoiceNbr nvarchar(1000)   )   AS   BEGIN    DELETE FROM [accounts].[InvoiceExceptions] WHERE InvoiceNumber IN (SELECT value FROM openjson(@InvoiceNbr) with (value nvarchar(20) '$'));    --delete from [accounts].[InvoicesInit] where InvoiceNumber in (select value from openjson(@InvoiceNbr) with (value nvarchar(20) '$'));   END  
/*  Mohan deployed to Production on 12 May 2020  */    CREATE procedure [accounts].[sp_ManufacturerPaymentAggregate] --null,null,'2020-01-01','2020-01-08','Yes','["Due"]','["Active"]',0  (   @ManufacturerIds nvarchar(200),   @ManufacturerName nvarchar(100),   @POFromDate nvarchar(50),   @POToDate nvarchar(50),   @DocsReceived nvarchar(5),   @InvoiceStatuses_json nvarchar(100),   @OrderStatuses_json nvarchar(100),   @allocationAmount float  )  as  declare @Invoices table(   BrandId bigint,   BrandCode nvarchar(30),   BrandName nvarchar(150),   InvoiceId bigint,   InvoiceDueDate date,   OrderId nvarchar(15),   DerivedInvoiceStatus nvarchar(15),   TotalFee float,   TotalPaid float,   TotalCredit float  );  declare @MfgInvoices table(      RunningTotal float,   RowID bigint,   BrandId bigint,   BrandCode nvarchar(15),   BrandName nvarchar(150),   InvoiceId bigint,   InvoiceDueDate date,   OrderId nvarchar(15),   DerivedInvoiceStatus nvarchar(15),   TotalFee float,   TotalPaid float,   TotalCredit float  );  begin  declare @sqlq nvarchar(max);   set @sqlq = 'select distinct    bb.BrandId as BrandId   ,bb.BrandCode as BrandCode   ,bb.BrandName as BrandName   ,inv.[InvoiceID] as InvoiceId   ,CONVERT(Date, inv.invoiceDueDate,101) invoiceDueDate   ,cast(inv.OrderId as bigint) as OrderId   ,(case when (inv.[Status]=''Initiated'') then (case when inv.InvoiceDueDate <= getdate() then ''Due'' else ''Open'' end) else inv.[Status] end)  as DerivedInvoiceStatus   ,isnull(cast(inv.InvoiceAmount as float),0) as TotalFee   ,case inv.[Status] when ''InProcess'' then isnull(cast(json_value(inv.[PaymentData], ''$.InvoicePayment'') as float), 0) when ''Paid'' then isnull(cast(json_value(inv.[PaymentData], ''$.InvoicePayment'') as float), 0) when ''Authorize'' then isnull(cast(json_value(inv.[PaymentData], ''$.InvoicePayment'') as float), 0) else 0 end as TotalPaid   ,isnull(cast(json_value(inv.[PaymentData], ''$.CreditApplied'') as float), 0) as TotalCredit   from [accounts].[Invoices] as inv   left join [accounts].[InvoiceItems] as invitem   on inv.InvoiceId=invitem.InvoiceId    left join [Orders].[OrderTransactionDetails] as otd CROSS APPLY OPENJSON(otd.OrderTransactionData) WITH (poDate date ''$.poDate'') as TransactionDatajsonValues on(otd.[OrderID]=inv.OrderID) and [OrderStatusCode]=''PO''   left join [Orders].[Orders] as ord on inv.OrderId=ord.OrderId   left join [catalog].[Brands] as bb   on (bb.[BrandCode] = inv.VendorRefId)'   +' where inv.IsActive = 1 and inv.VendorType = ''MFG'' and bb.IsActive = 1'   +case when @ManufacturerName is not null and @ManufacturerName <> '' then ' and bb.[BrandName] like ''%'+@ManufacturerName+'%'' ' else '' end   +case when @ManufacturerIds is not null and @ManufacturerIds <> '' then ' and bb.BrandId in (select value from openjson('''+@ManufacturerIds+''')) ' else '' end   +case when @POFromDate is not null and @POFromDate <> '' then (' and convert(nvarchar, TransactionDatajsonValues.poDate, 111) >= convert(nvarchar, cast('''+@POFromDate+''' as date), 111)') else '' end   +case when @POToDate is not null and @POToDate <> '' then (' and convert(nvarchar, TransactionDatajsonValues.poDate, 111) <= convert(nvarchar, cast('''+@POToDate+''' as date), 111)') else '' end   +case when @InvoiceStatuses_json is not null and @InvoiceStatuses_json <> '' then (' and (case when (inv.[Status]=''Initiated'') then (case when inv.InvoiceDueDate <= getdate() then ''Due'' else ''Open'' end) else inv.[Status] end)     in (select value from openjson('''+@InvoiceStatuses_json+'''))') else '' end   +case when @OrderStatuses_json is not null and @OrderStatuses_json <> '' then (' and ord.Status in (select value from openjson('''+@OrderStatuses_json+''') with (value nvarchar(20) ''$''))') else '' end;     print (@sqlq);   insert into @Invoices exec ('select i.*from ('+@sqlq + ')i order by InvoiceDueDate asc');            insert into @MfgInvoices  select sum(q.totalFee) over (order by q.RowID) runningTotal,q.* from (  SELECT row_number()
  CREATE PROCEDURE [accounts].[GetVendorDetails](@OrderID BIGINT)    AS   BEGIN   SELECT BrandID,BrandName,BrandCode,[Description],BrandEmail,BrandAddress1,BrandAddress2,BrandCity,BrandZipCode,BrandState,MFGContactNumber   FROM [catalog].[Brands] WHERE BrandCode IN  (SELECT DISTINCT BrandCode FROM [Orders].[OrderItems] WHERE OrderID  = @OrderID)   END  
CREATE procedure [accounts].[sp_ProviderPaymentAggregateDetails]  (   @ProviderIds nvarchar(200),   @IncludeProviderName bit = 1,   @ProviderLegalName nvarchar(100),   @POFromDate nvarchar(50),   @POToDate nvarchar(50),   @DocsReceived nvarchar(5),   @InvoiceStatuses_json nvarchar(100),   @OrderStatuses_json nvarchar(100),   @IncludeBrands bit,   @BrandCodes_json nvarchar(100),   @allocationAmount float  )  as  declare @Invoices table(   ProviderId bigint,   BrandCode nvarchar(15),   InvoiceId bigint,   InvoiceDueDate date,   OrderId nvarchar(15),   DerivedInvoiceStatus nvarchar(15),   TotalFee float,   TotalPaid float,   TotalCredit float  );  declare @ProviderInvoices table(   RunningTotal float,   RowID bigint,   ProviderId bigint,   BrandCode nvarchar(15),   InvoiceId bigint,   InvoiceDueDate date,   OrderId nvarchar(15),   DerivedInvoiceStatus nvarchar(15),   TotalFee float,   TotalPaid float,   TotalCredit float  );  begin  declare @sqlq nvarchar(max);  declare @sqlq2 nvarchar(max);  set @sqlq = 'select distinct   inv.VendorRefId as ProviderId   ,'''' as BrandCode  ,inv.[InvoiceID] as InvoiceId  ,CONVERT(Date, inv.invoiceDueDate,101) invoiceDueDate  ,o.OrderId  ,(case when o.Status = ''ACTIVE'' then (case when (inv.[Status]=''Initiated'') then (case when inv.[IsDocsSubmitted] = 1 and inv.InvoiceDueDate < getdate() then ''Due'' when inv.InvoiceDueDate > getdate() then ''Open'' end) else inv.[Status] end) else ''VOID'' end) as DerivedInvoiceStatus  ,inv.InvoiceAmount as TotalFee  ,case inv.[Status] when ''InProcess'' then isnull(cast(json_value(inv.[PaymentData], ''$.invoicePayment'') as float), 0) when ''Paid'' then isnull(cast(json_value(inv.[PaymentData], ''$.invoicePayment'') as float), 0) when ''Authorize'' then isnull(cast(json_value(inv.[PaymentData], ''$.invoicePayment'') as float), 0) else 0 end as TotalPaid  ,isnull(cast(json_value(inv.[PaymentData], ''$.creditApplied'') as float), 0) as TotalCredit  from [accounts].[Invoices] as inv  inner join [Orders].[Orders] o on o.orderid = inv.orderid   left join [provider].[ProviderProfiles] as pp  on (pp.[ProviderId] = inv.VendorRefId)'  +' where inv.IsActive = 1 and inv.VendorType = ''PRO'''  --+case when @BrandCodes_json is not null and @BrandCodes_json <> '' then (' and inv.[BrandCode] '+(case @IncludeBrands when 1 then 'in' else 'not in' end)+' (select value from openjson('''+ @BrandCodes_json + ''') with (value nvarchar(15) ''$''))') else '' end  +case when @ProviderLegalName is not null and @ProviderLegalName <> '' then ' and pp.[ProviderName]'+(case @IncludeProviderName when 0 then ' not like ' else ' like ' end)+'''%'+@ProviderLegalName+'%'' ' else '' end  +case when @ProviderIds is not null and @ProviderIds <> '' then ' and pp.ProviderId in (select value from openjson('''+@ProviderIds+''')) ' else '' end  +case when @POFromDate is not null and @POFromDate <> '' then (' and convert(nvarchar, cast(DateAdd(day,-60,inv.invoiceDueDate) as date), 111) >= convert(nvarchar, cast('''+@POFromDate+''' as date), 111)') else '' end  +case when @POToDate is not null and @POToDate <> '' then (' and convert(nvarchar, cast(DateAdd(day,-60,inv.invoiceDueDate) as date), 111) <= convert(nvarchar, cast('''+@POToDate+''' as date), 111)') else '' end  +case when @InvoiceStatuses_json is not null and @InvoiceStatuses_json <> '' then (' and (case when o.Status = ''ACTIVE'' then (case when (inv.[Status]=''Initiated'') then (case when inv.[IsDocsSubmitted] = 1 and inv.InvoiceDueDate < getdate() then ''Due'' when inv.InvoiceDueDate > getdate() then ''Open'' end) else inv.[Status] end) else ''VOID'' end) in (select value from openjson('''+@InvoiceStatuses_json+''') with (value nvarchar(20) ''$''))') else '' end  +case when @OrderStatuses_json is not null and @OrderStatuses_json <> '' then (' and o.Status in (select value from openjson('''+@OrderStatuses_json+''') with (value nvarchar(20) ''$''))') else '' end  +case when @DocsReceived = 'yes' then ' and inv.isDocsSubmitted = 1' when @DocsRe
    CREATE procedure [accounts].[sp_ProviderPaymentAggregate]  (   @ProviderIds nvarchar(200),   @IncludeProviderName bit = 1,   @ProviderLegalName nvarchar(100),   @POFromDate nvarchar(50),   @POToDate nvarchar(50),   @DocsReceived nvarchar(5),   @InvoiceStatuses_json nvarchar(100),   @OrderStatuses_json nvarchar(100),   @IncludeBrands bit,   @BrandCodes_json nvarchar(100)  )  as  declare @Invoices table(   ProviderId bigint,   BrandCode nvarchar(15),   InvoiceId bigint,   OrderId nvarchar(15),   DerivedInvoiceStatus nvarchar(15),   TotalFee float,   TotalPaid float,   TotalCredit float  );  begin  declare @sqlq nvarchar(max);  set @sqlq = 'select distinct   inv.ProviderId as ProviderId   ,inv.[BrandCode] as BrandCode  ,inv.[InvoiceID] as InvoiceId  ,cast(json_value(invitem.[ItemData], ''$.orderId'') as bigint) as OrderId  ,(case when json_value(invitem.[ItemData], ''$.orderStatus'') = ''ACTIVE'' then (case when (inv.[Status]=''Initiated'') then (case when inv.isDocsSubmitted = 1 and inv.InvoiceDueDate < getdate() then ''Due'' else ''Open'' end) else inv.[Status] end) else ''VOID'' end) as DerivedInvoiceStatus  ,inv.InvoiceAmount as TotalFee  ,case inv.[Status] when ''InProcess'' then isnull(cast(json_value(inv.[PaymentData], ''$.invoicePayment'') as float), 0) when ''Paid'' then isnull(cast(json_value(inv.[PaymentData], ''$.invoicePayment'') as float), 0) when ''Authorize'' then isnull(cast(json_value(inv.[PaymentData], ''$.invoicePayment'') as float), 0) else 0 end as TotalPaid  ,isnull(cast(json_value(inv.[PaymentData], ''$.creditApplied'') as float), 0) as TotalCredit  from [accounts].[Invoices] as inv  left join [accounts].[InvoiceItems] as invitem  on(inv.InvoiceId=invitem.InvoiceId)  join [provider].[ProviderProfiles] as pp  on (pp.[ProviderId] = inv.ProviderId  )'  +' where inv.IsActive = 1 and inv.VendorType = ''PRO'' and pp.IsActive = 1'  +case when @BrandCodes_json is not null and @BrandCodes_json <> '' then (' and inv.[BrandCode] '+(case @IncludeBrands when 1 then 'in' else 'not in' end)+' (select value from openjson('''+ @BrandCodes_json + ''') with (value nvarchar(15) ''$''))') else '' end  +case when @ProviderLegalName is not null and @ProviderLegalName <> '' then ' and pp.[ProviderName]'+(case @IncludeProviderName when 0 then ' not like ' else ' like ' end)+'''%'+@ProviderLegalName+'%'' ' else '' end  +case when @ProviderIds is not null and @ProviderIds <> '' then ' and pp.ProviderId in (select value from openjson('''+@ProviderIds+''')) ' else '' end  +case when @POFromDate is not null and @POFromDate <> '' then (' and convert(nvarchar, cast(DateAdd(day,-60,inv.invoiceDueDate) as date), 111) >= convert(nvarchar, cast('''+@POFromDate+''' as date), 111)') else '' end  +case when @POToDate is not null and @POToDate <> '' then (' and convert(nvarchar, cast(DateAdd(day,-60,inv.invoiceDueDate) as date), 111) <= convert(nvarchar, cast('''+@POToDate+''' as date), 111)') else '' end  +case when @InvoiceStatuses_json is not null and @InvoiceStatuses_json <> '' then (' and (case when json_value(invitem.[ItemData], ''$.orderStatus'') = ''ACTIVE'' then (case when (inv.[Status]=''Initiated'') then (case when inv.isDocsSubmitted = 1 and inv.InvoiceDueDate < getdate() then ''Due'' else ''Open'' end) else inv.[Status] end) else ''VOID'' end) in (select value from openjson('''+@InvoiceStatuses_json+''') with (value nvarchar(20) ''$''))') else '' end  +case when @OrderStatuses_json is not null and @OrderStatuses_json <> '' then (' and json_value(invitem.[ItemData], ''$.orderStatus'') in (select value from openjson('''+@OrderStatuses_json+''') with (value nvarchar(20) ''$''))') else '' end  +case when @DocsReceived = 'yes' then ' and inv.isDocsSubmitted = 1' when @DocsReceived = 'no' then ' inv.isDocsSubmitted = 0' else '' end;  --print @sqlq  insert into @Invoices exec (@sqlq);    select    row_number() over (order by pd.ProviderId) as RowID  ,pd.ProviderId as ProviderId  --,concat('[',string_agg(cast(pd.InvoiceId as nvarchar),'
  CREATE PROCEDURE [accounts].[GetShippingAmount](@OrderID BIGINT)   AS  BEGIN  SELECT ShippingAmount AS Amount FROM [catalog].[BrandShippingFees] WHERE BrandCode IN  (SELECT DISTINCT BrandCode FROM [Orders].[OrderItems] WHERE OrderID  = @OrderID)  END  
  CREATE procedure [accounts].[sp_ManufacturerPaymentSingle]  (   @ManufacturerIds nvarchar(200),   @ManufacturerName nvarchar(100),   @POFromDate nvarchar(50),   @POToDate nvarchar(50),   @DocsReceived nvarchar(5),   @InvoiceStatuses_json nvarchar(100),   @OrderStatuses_json nvarchar(100)  )  as  begin  declare @sqlq1 nvarchar(max);  declare @sqlq2 nvarchar(max);  set @sqlq1 = 'select distinct   inv.[InvoiceId] as InvoiceId  ,inv.[InvoiceNumber] as InvoiceNumber  ,isnull(inv.OrderID,0) as OrderId  ,ord.Status as OrderStatus  ,ord.OrderType as OrderType  ,inv.[Status] as ActualInvoiceStatus  ,(case when (inv.[Status]=''Initiated'') then (case when inv.InvoiceDueDate < getdate() then ''Due'' else ''Open'' end) else inv.[Status] end)  as DerivedInvoiceStatus  ,inv.invoiceDate InvoiceDate  ,cast(json_value(invitm.[ItemData], ''$.docsReceivedDate'') as date) as DocsReceivedDate  ,isnull(datediff(day, convert(nvarchar, cast(DateAdd(day,-60,inv.invoiceDueDate) as date), 111), convert(nvarchar, getdate(), 111)), 0) as ServiceDays  ,cast(isnull(json_value(inv.[PaymentData], ''$.creditApplied''), 0) as float) as Credit  ,concat(json_value(ord.[MemberData], ''$.firstName''), '''', json_value(ord.[MemberData], ''$.lastName'')) as MemberName  ,json_value(inv.[ProviderData], ''$.providerBusinessName'') as ProviderName  ,inv.[PONumber] as PONumber  ,bb.BrandId as BrandId  ,bb.BrandName as BrandName  ,bb.BrandCode as BrandCode  ,bb.BrandAddress1 as BrandAddress1  ,cast(json_Value(o.ordertransactionData, ''$.poDate'') as date) as PODate  ,inv.[InvoiceDueDate] as InvoiceDueDate  ,isnull(cast((invitm.Quantity * invitm.Cost) as float),0) as COGS  ,isnull(cast(ship.ShippingAmount as float),0) as ShippingAmount  ,isnull(cast(inv.InvoiceAmount as float),0) as TotalFee  ,isnull(cast(0 as float),0) as RebateAmount  ,isnull(cast(0 as float),0) as SalesTaxAmount  ,case inv.[Status] when ''InProcess'' then isnull(cast(json_value(inv.[PaymentData], ''$.invoicePayment'') as float), 0) when ''Paid'' then isnull(cast(json_value(inv.[PaymentData], ''$.invoicePayment'') as float), 0) when ''Authorize'' then isnull(cast(json_value(inv.[PaymentData], ''$.invoicePayment'') as float), 0) else 0 end as TotalPaid  ,(inv.InvoiceAmount - (case inv.[Status] when ''InProcess'' then isnull(cast(json_value(inv.[PaymentData], ''$.invoicePayment'') as float), 0) when ''Paid'' then isnull(cast(json_value(inv.[PaymentData], ''$.invoicePayment'') as float), 0) when ''Authorize'' then isnull(cast(json_value(inv.[PaymentData], ''$.invoicePayment'') as float), 0) else 0 end)) as TotalBalance  ,inv.isDocsSubmitted as DocsReceived  ,inv.[Remarks] as Remarks  ,json_value(inv.[PaymentData], ''$.paymentMethod'') as PaymentMethod  ,isnull(va.[VendorPreferredPaymentType], ''CHECK'') as PreferredPaymentType  ,va.[VendorAccountID] as VendorAccountId  from [accounts].[Invoices] as inv  join [accounts].[InvoiceItems] as invitm on(inv.Invoiceid=invitm.Invoiceid)  join [Orders].[OrderTransactionDetails] as o on o.orderid = inv.orderid and o.orderstatusCode = ''PO''  join [Orders].[Orders] as ord on inv.OrderId=ord.OrderId  join [catalog].[Brands] as bb  on (bb.[BrandCode] = inv.BrandCode )'                                    +' left join (select * from [accounts].[InvoiceTransactions] where [InvoiceType]=''PAY'' and [Status] = ''Authorized'') as invt  on (invt.InvoiceID = inv.InvoiceId)  left join [accounts].[VendorAccounts] as va  on (inv.BrandCode = va.[BrandCode])  left join [catalog].[BrandShippingFees] as ship  on(inv.BrandCode = ship.[BrandCode])  where inv.IsActive = 1 and inv.VendorType = ''MFG'' and bb.IsActive = 1 '  +case when @ManufacturerName is not null and @ManufacturerName <> '' then ' and bb.[BrandName] like ''%'+@ManufacturerName+'%'' ' else '' end  +case when @ManufacturerIds is not null and @ManufacturerIds <> '' then ' and bb.BrandId in (select value from openjson('''+@ManufacturerIds+''')) ' else '' end  +case when @POFromDate is not null and @POFromDate <> '' then (' a
CREATE PROCEDURE [accounts].[GetWarrantyDates](@OrderID BIGINT)  AS  BEGIN    /*  Author: Moin   Date: NOV 8 2018  Desription:  Fetching lnDWarrantyEndDate from ItemDetailsData Json data  */   SELECT  1 AS ID, CAST(JSON_VALUE(ItemDetailsData, '$.lnDWarrantyEndDate') AS DATETIME) AS 'WarrantyEndDate' FROM [accounts].[InvoiceItems] WHERE JSON_VALUE(ItemData, '$.orderId') = @OrderID  END  
    CREATE procedure [accounts].[sp_ProviderPaymentSingle]  (   @ProviderIds nvarchar(200),   @IncludeProviderName bit = 1,   @ProviderLegalName nvarchar(100),   @POFromDate nvarchar(50),   @POToDate nvarchar(50),   @DocsReceived nvarchar(5),   @InvoiceStatuses_json nvarchar(100),   @OrderStatuses_json nvarchar(100),   @IncludeBrands bit,   @BrandCodes_json nvarchar(100)  )  as  begin  declare @sqlq1 nvarchar(max);  declare @sqlq2 nvarchar(max);  set @sqlq1 = 'select distinct   inv.[InvoiceId] as InvoiceId  ,inv.BrandCode  ,isnull(cast(json_value(invitm.[ItemData], ''$.orderId'') as bigint),0) as OrderId  ,json_value(invitm.[ItemData], ''$.orderStatus'') as OrderStatus  ,json_value(invitm.[ItemData], ''$.orderType'') as OrderType  ,inv.[Status] as ActualInvoiceStatus  ,(case when json_value(invitm.[ItemData], ''$.orderStatus'') = ''ACTIVE'' then (case when (inv.[Status]=''Initiated'') then (case when inv.isDocsSubmitted = 1 and inv.InvoiceDueDate < getdate() then ''Due'' else ''Open'' end) else inv.[Status] end) else ''VOID'' end) as DerivedInvoiceStatus  ,DateAdd(day,-60,inv.invoiceDueDate) FittingDate  ,cast(json_value(invitm.[ItemData], ''$.docsReceivedDate'') as date) as DocsReceivedDate  ,isnull(datediff(day, convert(nvarchar, cast(DateAdd(day,-60,inv.invoiceDueDate) as date), 111), convert(nvarchar, getdate(), 111)), 0) as ServiceDays  ,concat(json_value(invitm.[ItemData], ''$.memberFirstName''), '' '', json_value(invitm.[ItemData], ''$.memberLastName'')) as MemberName  ,json_value(invitm.[ItemData], ''$.nhMemberId'') as NHMemberId  ,inv.[PONumber] as PONumber  ,pp.Providerid as ProviderId  ,cast(json_value(invitm.[ItemData], ''$.poDate'') as date) as PODate  ,inv.[InvoiceDueDate] as InvoiceDueDate  ,isnull(cast(json_value(invitm.[ItemData], ''$.dispensingFee'') as float),0) as DispensingFee  ,isnull(cast(json_value(invitm.[ItemData], ''$.deviceCount'') as int),0) as DeviceCount  ,inv.InvoiceAmount as TotalFee  ,case inv.[Status] when ''InProcess'' then isnull(cast(json_value(inv.[PaymentData], ''$.invoicePayment'') as float), 0) when ''Paid'' then isnull(cast(json_value(inv.[PaymentData], ''$.invoicePayment'') as float), 0) when ''Authorize'' then isnull(cast(json_value(inv.[PaymentData], ''$.invoicePayment'') as float), 0) else 0 end as TotalPaid  ,cast(isnull(json_value(inv.[PaymentData], ''$.creditApplied''), 0) as float) as Credit  ,(inv.InvoiceAmount - (case inv.[Status] when ''InProcess'' then isnull(cast(json_value(inv.[PaymentData], ''$.invoicePayment'') as float), 0) when ''Paid'' then isnull(cast(json_value(inv.[PaymentData], ''$.invoicePayment'') as float), 0) when ''Authorize'' then isnull(cast(json_value(inv.[PaymentData], ''$.invoicePayment'') as float), 0) else 0 end)) as TotalBalance  ,inv.isDocsSubmitted as DocsReceived  ,inv.[Remarks] as Remarks  ,'''' as ProviderAddress1  ,'''' as ProviderLegalBusinessName  ,json_value(inv.[PaymentData], ''$.paymentMethod'') as PaymentMethod  ,isnull(va.[VendorPreferredPaymentType], ''CHECK'') as PreferredPaymentType  , va.[VendorAccountID] as VendorAccountId  from [accounts].[Invoices] as inv  join [accounts].[InvoiceItems] as invitm on(inv.Invoiceid=invitm.Invoiceid)  join [provider].[ProviderProfiles] as pp  on (inv.Providerid = pp.[ProviderId] )'                                  +' left join [accounts].[VendorAccounts] as va  on (pp.ProviderId = va.[ProviderId])  where inv.IsActive = 1 and inv.VendorType = ''PRO'' and pp.IsActive = 1 '    set @sqlq2 = 'Select row_number() over (order by i.InvoiceDueDate) as RowID, i.* from (' + @sqlq1 +   +case when @BrandCodes_json is not null and @BrandCodes_json <> '' then (' and inv.[BrandCode] '+(case @IncludeBrands when 1 then 'in' else 'not in' end)+' (select value from openjson('''+ @BrandCodes_json + ''') with (value nvarchar(15) ''$''))') else '' end  +case when @ProviderLegalName is not null and @ProviderLegalName <> '' then ' and pp.[ProviderName]'+(case @IncludeProviderName when 0 then ' not like ' else ' like ' end)+
CREATE procedure [accounts].[sp_ProviderPaymentSingleInvoiceIDs]  (   @InvoiceIds nvarchar(max),   @VendorType nvarchar(10)  )  as  begin  declare @sqlq1 nvarchar(max);  declare @sqlq2 nvarchar(max);    set @sqlq1 = 'select distinct     inv.[InvoiceId] as InvoiceId    ,inv.[InvoiceNumber]    ,bb.BrandId as BrandId    ,bb.BrandName as BrandName    ,bb.BrandCode    ,inv.invoiceDate InvoiceDate    ,ord.OrderId OrderId    ,ord.Status as OrderStatus    ,ord.OrderType as OrderType    ,inv.[Status] as ActualInvoiceStatus    ,(case when (inv.[Status]=''Initiated'') then (case when inv.InvoiceDueDate < getdate() then ''Due'' else ''Open'' end) else inv.[Status] end)  as DerivedInvoiceStatus    ,DateAdd(day,-60,inv.invoiceDueDate) FittingDate    ,cast(json_value(invitm.[ItemData], ''$.docsReceivedDate'') as date) as DocsReceivedDate    ,isnull(datediff(day, convert(nvarchar, cast(DateAdd(day,-60,inv.invoiceDueDate) as date), 111), convert(nvarchar, getdate(), 111)), 0) as ServiceDays    ,concat(json_value(ord.[MemberData], ''$.firstName''), '' '', json_value(ord.[MemberData], ''$.lastName'')) as MemberName    ,ord.NHMemberId as NHMemberId    ,inv.[PONumber] as PONumber    ,CONVERT(bigint,          CASE          WHEN IsNumeric(CONVERT(VARCHAR(12), inv.[VendorRefId])) = 1 THEN CONVERT(VARCHAR(12),inv.[VendorRefId])          ELSE 0 END) as ProviderId    ,TransactionDatajsonValues.poDate as PODate    ,inv.[InvoiceDueDate] as InvoiceDueDate    ,isnull(cast(json_value(invitm.[ItemData], ''$.dispensingFee'') as float),0) as DispensingFee    ,isnull(cast(json_value(invitm.[ItemData], ''$.deviceCount'') as int),0) as DeviceCount    ,isnull(cast((invitm.Quantity * invitm.Cost) as float),0) as COGSPrice    ,isnull(cast(ship.ShippingAmount as float),0) as ShippingAmount    ,isnull(cast(inv.InvoiceAmount as float),0) as TotalFee    ,isnull(cast(0 as float),0) as RebateAmount    ,isnull(cast(0 as float),0) as SalesTaxAmount    ,case inv.[Status] when ''InProcess'' then isnull(cast(json_value(inv.[PaymentData], ''$.invoicePayment'') as float), 0) when ''Paid'' then isnull(cast(json_value(inv.[PaymentData], ''$.invoicePayment'') as float), 0) when ''Authorize'' then isnull(cast(json_value(inv.[PaymentData], ''$.invoicePayment'') as float), 0) else 0 end as TotalPaid    ,cast(isnull(json_value(inv.[PaymentData], ''$.creditApplied''), 0) as float) as Credit    ,isnull((inv.InvoiceAmount - (case inv.[Status] when ''InProcess'' then isnull(cast(json_value(inv.[PaymentData], ''$.invoicePayment'') as float), 0) when ''Paid'' then isnull(cast(json_value(inv.[PaymentData], ''$.invoicePayment'') as float), 0) when ''Authorize'' then isnull(cast(json_value(inv.[PaymentData], ''$.invoicePayment'') as float), 0) else 0 end)),0) as TotalBalance    ,inv.isDocsSubmitted as DocsReceived    ,inv.[Remarks] as Remarks    ,'''' as ProviderAddress1'    +case      when @VendorType = 'MFG' then ','''' as ProviderLegalBusinessName'     else ',(select ProviderName from provider.ProviderProfiles where provider.ProviderProfiles.ProviderId = inv.VendorRefId) as ProviderLegalBusinessName'     end    +'    ,json_value(inv.[PaymentData], ''$.paymentMethod'') as PaymentMethod    ,isnull(va.[VendorPreferredPaymentType], ''CHECK'') as PreferredPaymentType    ,va.[VendorAccountID] as VendorAccountId    from [accounts].[Invoices] as inv    join (select distinct i.invoiceid,(select top 1 itemdata from [accounts].[InvoiceItems] where invoiceid = i.invoiceid) itemdata,i.Quantity,i.Cost from    (select invitm.invoiceid, invitm.ItemData,invitm.Quantity,invitm.Cost     from [accounts].[Invoices] inv    left join [accounts].[InvoiceItems] invitm    on inv.Invoiceid=invitm.Invoiceid    )i) as invitm on(inv.Invoiceid=invitm.Invoiceid)        join [Orders].[OrderTransactionDetails] as otd CROSS APPLY OPENJSON(otd.OrderTransactionData) WITH (poDate date ''$.poDate'') as TransactionDatajsonValues on(otd.[OrderID]=inv.OrderID) and [OrderStatusCode]=''PO''    join [Orders].[Orders] as ord on inv.Order
    CREATE procedure [accounts].[sp_ProviderPaymentByAllocationAmount]  (   @ProviderIds nvarchar(200),   @IncludeProviderName bit = 1,   @ProviderLegalName nvarchar(100),   @POFromDate nvarchar(50),   @POToDate nvarchar(50),   @DocsReceived nvarchar(5),   @InvoiceStatuses_json nvarchar(100),   @OrderStatuses_json nvarchar(100),   @IncludeBrands bit,   @BrandCodes_json nvarchar(100)  )  as  begin  declare @sqlq1 nvarchar(max);  declare @sqlq2 nvarchar(max);  set @sqlq1 = 'select distinct   inv.[InvoiceID] as InvoiceId  ,inv.BrandCode  ,isnull(cast(json_value(invitem.[ItemData], ''$.orderId'' ) as bigint),0) as OrderId  ,json_value(invitem.[ItemData], ''$.orderStatus'') as OrderStatus  ,json_value(invitem.[ItemData], ''$.orderType'') as OrderType  ,inv.[Status] as ActualInvoiceStatus  ,(case when json_value(invitem.[ItemData], ''$.orderStatus'') = ''ACTIVE'' then (case when (inv.[Status]=''Initiated'') then (case when inv.isDocsSubmitted = 1 and inv.InvoiceDueDate < getdate() then ''Due'' else ''Open'' end) else inv.[Status] end) else ''VOID'' end) as DerivedInvoiceStatus  --,cast(json_value(invitem.[ItemData], ''$.fittingDate'') as date) as FittingDate  ,DateAdd(day,-60,inv.invoiceDueDate) FittingDate  ,cast(json_value(invitem.[ItemData], ''$.docsReceivedDate'') as date) as DocsReceivedDate  ,isnull(datediff(day, convert(nvarchar, cast(json_value(invitem.[ItemData], ''$.fittingDate'') as date), 111), convert(nvarchar, getdate(), 111)), 0) as ServiceDays  ,concat(json_value(invitem.[ItemData], ''$.memberFirstName''), '''', json_value(invitem.[ItemData], ''$.memberLastName'')) as MemberName  ,json_value(invitem.[ItemData], ''$.nhMemberId'') as NHMemberId  ,inv.[PONumber] as PONumber  ,inv.ProviderId as ProviderId  ,cast(json_value(invitem.[ItemData], ''$.poDate'') as date) as PODate  ,inv.[InvoiceDueDate] as InvoiceDueDate  ,isnull(cast(json_value(invitem.[ItemData], ''$.dispensingFee'') as float),0) as DispensingFee  ,isnull(cast(json_value(invitem.[ItemData], ''$.deviceCount'') as int),0) as DeviceCount  ,inv.InvoiceAmount as TotalFee  ,case inv.[Status] when ''InProcess'' then isnull(cast(json_value(inv.[PaymentData], ''$.InvoicePayment'') as float), 0) when ''Paid'' then isnull(cast(json_value(inv.[PaymentData], ''$.InvoicePayment'') as float), 0) when ''Authorize'' then isnull(cast(json_value(inv.[PaymentData], ''$.InvoicePayment'') as float), 0) else 0 end as TotalPaid  ,cast(isnull(json_value(inv.[PaymentData], ''$.CreditApplied''), 0) as float) as Credit  ,(inv.InvoiceAmount - (case inv.[Status] when ''InProcess'' then isnull(cast(json_value(inv.[PaymentData], ''$.InvoicePayment'') as float), 0) when ''Paid'' then isnull(cast(json_value(inv.[PaymentData], ''$.InvoicePayment'') as float), 0) when ''Authorize'' then isnull(cast(json_value(inv.[PaymentData], ''$.InvoicePayment'') as float), 0) else 0 end)) as TotalBalance  ,case when json_value(invitem.[ItemData], ''$.docsReceivedDate'') is null then cast(0 as bit) else cast(1 as bit) end as DocsReceived  ,inv.[Remarks] as Remarks  ,json_value(pp.AdditionalData, ''$.billingAddress.address1'') as ProviderAddress1  ,pp.ProviderName as ProviderLegalBusinessName,'''' as PaymentMethod,isnull(va.[VendorPreferredPaymentType], ''CHECK'') as PreferredPaymentType  , va.[VendorAccountID] as VendorAccountId  from [accounts].[Invoices] as inv  join [accounts].[InvoiceItems] as invitem on(inv.InvoiceId=invitem.InvoiceId)  left join [provider].[ProviderProfiles] as pp  on (pp.[ProviderId] = inv.ProviderId )'  +' left join (select * from [accounts].[InvoiceTransactions] where [InvoiceType]=''PAY'' and [Status] = ''Authorized'') as invt  on (invt.InvoiceId = inv.InvoiceId)  left join [accounts].[VendorAccounts] as va  on (pp.ProviderId = va.[ProviderId])  where inv.IsActive = 1 and inv.VendorType = ''PRO'' and pp.IsActive = 1';     set @sqlq2 = 'Select row_number() over (order by i.InvoiceDueDate) as RowID,  i.* from (' + @sqlq1   +case when @ProviderLegalName is not null and @ProviderLegal
    CREATE procedure [accounts].[sp_ProviderPaymentByAllocationAmountDetails]  (   @ProviderIds nvarchar(200),   @ProviderLegalName nvarchar(100),   @POFromDate nvarchar(50),   @POToDate nvarchar(50),   @DocsReceived nvarchar(5),   @InvoiceStatuses_json nvarchar(100),   @OrderStatuses_json nvarchar(100),   @IncludeBrands bit,   @BrandCodes_json nvarchar(100)  )  as  begin  declare @sqlq1 nvarchar(max);  declare @sqlq2 nvarchar(max);  set @sqlq1 = 'select distinct   inv.[InvoiceID] as InvoiceId  ,inv.BrandCode  ,isnull(cast(json_value(invitem.[ItemData], ''$.orderId'') as bigint),0) as OrderId  ,json_value(invitem.[ItemData], ''$.orderStatus'') as OrderStatus  ,json_value(invitem.[ItemData], ''$.orderType'') as OrderType  ,inv.[Status] as ActualInvoiceStatus  ,(case when json_value(invitem.[ItemData], ''$.orderStatus'') = ''ACTIVE'' then (case when (inv.[Status]=''Initiated'') then (case when inv.isDocsSubmitted = 1 and inv.InvoiceDueDate < getdate() then ''Due'' else ''Open'' end) else inv.[Status] end) else ''VOID'' end) as DerivedInvoiceStatus  --,cast(json_value(invitem.[ItemData], ''$.fittingDate'') as date) as FittingDate  ,DateAdd(day,-60,inv.invoiceDueDate) FittingDate  ,cast(json_value(invitem.[ItemData], ''$.docsReceivedDate'') as date) as DocsReceivedDate  ,isnull(datediff(day, convert(nvarchar, cast(json_value(invitem.[ItemData], ''$.fittingDate'') as date), 111), convert(nvarchar, getdate(), 111)), 0) as ServiceDays  ,concat(json_value(invitem.[ItemData], ''$.memberFirstName''), '''', json_value(invitem.[ItemData], ''$.memberLastName'')) as MemberName  ,json_value(invitem.[ItemData], ''$.nhMemberId'') as NHMemberId  ,inv.[PONumber] as PONumber  ,inv.ProviderId as ProviderId  ,cast(json_value(invitem.[ItemData], ''$.poDate'') as date) as PODate  ,inv.[InvoiceDueDate] as InvoiceDueDate  ,isnull(cast(json_value(invitem.[ItemData], ''$.dispensingFee'') as float),0) as DispensingFee  ,isnull(cast(json_value(invitem.[ItemData], ''$.deviceCount'') as int),0) as DeviceCount  ,inv.InvoiceAmount as TotalFee  ,case inv.[Status] when ''InProcess'' then isnull(cast(json_value(inv.[PaymentData], ''$.InvoicePayment'') as float), 0) when ''Paid'' then isnull(cast(json_value(inv.[PaymentData], ''$.InvoicePayment'') as float), 0) when ''Authorize'' then isnull(cast(json_value(inv.[PaymentData], ''$.InvoicePayment'') as float), 0) else 0 end as TotalPaid  ,cast(isnull(json_value(inv.[PaymentData], ''$.CreditApplied''), 0) as float) as Credit  ,(inv.InvoiceAmount - (case inv.[Status] when ''InProcess'' then isnull(cast(json_value(inv.[PaymentData], ''$.InvoicePayment'') as float), 0) when ''Paid'' then isnull(cast(json_value(inv.[PaymentData], ''$.InvoicePayment'') as float), 0) when ''Authorize'' then isnull(cast(json_value(inv.[PaymentData], ''$.InvoicePayment'') as float), 0) else 0 end)) as TotalBalance  ,case when json_value(invitem.[ItemData], ''$.docsReceivedDate'') is null then cast(0 as bit) else cast(1 as bit) end as DocsReceived  ,inv.[Remarks] as Remarks  ,json_value(pp.AdditionalData, ''$.billingAddress.address1'') as ProviderAddress1  ,pp.ProviderName as ProviderLegalBusinessName,'''' as PaymentMethod,isnull(va.[VendorPreferredPaymentType], ''CHECK'') as PreferredPaymentType  , va.[VendorAccountID] as VendorAccountId  from [accounts].[Invoices] as inv  join [accounts].[InvoiceItems] as invitem on(inv.InvoiceId=invitem.InvoiceId)  left join [provider].[ProviderProfiles] as pp  on (pp.[ProviderId] = inv.ProviderId )'  +' left join (select * from [accounts].[InvoiceTransactions] where [InvoiceType]=''PAY'' and [Status] = ''Authorized'') as invt  on (invt.InvoiceId = inv.InvoiceId)  left join [accounts].[VendorAccounts] as va  on (pp.ProviderId = va.[ProviderId])  where inv.IsActive = 1 and inv.VendorType = ''PRO'' and pp.IsActive = 1';     set @sqlq2 = 'Select row_number() over (order by i.InvoiceDueDate) as RowID,  i.* from (' + @sqlq1   +case when @ProviderLegalName is not null and @ProviderLegalName <> '' then ' and pp.[
CREATE PROCEDURE [accounts].[GetProviderInvoiceStatistics]  (   @FromFittingDate NVARCHAR(50) = null,   @ToFittingDate NVARCHAR(50) = null,   @option NVARCHAR(50)  )  AS  BEGIN   DECLARE @Open float;   DECLARE @OpenOrders float;   DECLARE @DueWithDocs float;   DECLARE @DueWithoutDocs float;   DECLARE @Paid float;   DECLARE @InvoiceStatistics TABLE(ID INT,OpenInvoiceAmount float, DueWithDocsInvoiceAmount float, DueWithNoDocsInvoiceAmount float, PaidInvoiceAmount float);       IF (@option = 'Default')   Begin      SET @Open = (SELECT ISNULL(SUM(i.InvoiceAmount),0)         FROM [accounts].[invoices] i         inner join orders.orders o on o.orderid = i.orderid          left join provider.providerprofiles pp on pp.providerid = i.[VendorRefId]         WHERE  i.InvoiceDueDate > getdate() AND i.VendorType = 'PRO' and  i.IsActive=1 and i.[status] = 'Initiated' and o.status = 'ACTIVE')    SET @DueWithDocs = (SELECT ISNULL(SUM(i.InvoiceAmount),0)         FROM [accounts].[invoices] i         inner join orders.orders o on o.orderid = i.orderid         left join provider.providerprofiles pp on pp.providerid = i.[VendorRefId]         WHERE  i.InvoiceDueDate < getdate() AND i.IsDocsSubmitted = 1 AND i.VendorType = 'PRO' and i.IsActive=1 and i.[status] = 'Initiated' and o.status = 'ACTIVE')    SET @DueWithoutDocs = (SELECT ISNULL(SUM(i.InvoiceAmount),0)          FROM [accounts].[invoices] i          inner join orders.orders o          on o.orderid = i.orderid          left join provider.providerprofiles pp          on pp.providerid = i.[VendorRefId]          WHERE  i.InvoiceDueDate < getdate() AND i.IsDocsSubmitted = 0 AND i.VendorType = 'PRO' and i.IsActive=1 and i.[status] = 'Initiated' and o.status = 'ACTIVE')    SET @Paid = (SELECT ISNULL(SUM(i.InvoiceAmount),0)        FROM [accounts].[invoices] i        inner join orders.orders o on o.orderid = i.orderid        left join provider.providerprofiles pp on pp.providerid = i.[VendorRefId]        --join accounts.invoicetransactions t on t.invoiceid = i.invoiceid        where   i.VendorType = 'PRO'  and i.IsActive=1        and i.[status] = 'Paid' and o.status = 'ACTIVE')        --(SELECT ISNULL(SUM(InvoiceAmount),0) FROM [accounts].[invoices] i INNER JOIN [accounts].[invoiceTransactionDetails] itd ON i.InvoiceID = itd.invoiceID AND     --i.IsActive = 1 AND i.[status] = 'PAID' AND i.VendorType = 'PRO')     End     if (@option = 'Week')   Begin      SET @Open = (SELECT ISNULL(SUM(i.InvoiceAmount),0)         FROM [accounts].[invoices] i         inner join orders.orders o         on o.orderid = i.orderid         join provider.providerprofiles pp         on pp.providerid = i.[VendorRefId]      WHERE CONVERT(NVARCHAR, i.InvoiceDueDate, 111) > CONVERT(NVARCHAR, CAST(@ToFittingDate AS DATE),111)  AND i.VendorType = 'PRO' and  i.IsActive=1 and i.[status] = 'Initiated' and o.status = 'ACTIVE')      SET @DueWithDocs = (SELECT ISNULL(SUM(i.InvoiceAmount),0)         FROM [accounts].[invoices] i         inner join orders.orders o         on o.orderid = i.orderid         join provider.providerprofiles pp         on pp.providerid = i.[VendorRefId]        WHERE   CONVERT(NVARCHAR, i.InvoiceDueDate, 111) < CONVERT(NVARCHAR, CAST(@ToFittingDate AS DATE),111) AND i.IsDocsSubmitted = 1 and  i.IsActive=1 AND i.VendorType = 'PRO' and i.[status] = 'Initiated' and o.status = 'ACTIVE')      SET @DueWithoutDocs = (SELECT ISNULL(SUM(i.InvoiceAmount),0)          FROM [accounts].[invoices] i          inner join orders.orders o          on o.orderid = i.orderid          join provider.providerprofiles pp          on pp.providerid = i.[VendorRefId]         WHERE CONVERT(NVARCHAR, i.InvoiceDueDate, 111) < CONVERT(NVARCHAR, CAST(@ToFittingDate AS DATE),111) AND i.IsDocsSubmitted = 0 and  i.IsActive=1 AND i.VendorType = 'PRO' and i.[status] = 'Initiated' and o.status = 'ACTIVE')      SET @Paid = (SELECT ISNULL(SUM(i.InvoiceAmount),0)        FROM [accounts].[invoices] i        inner join orders.orders o on o.orderid = i.orderid   
  CREATE procedure [accounts].[sp_ManufacturerPaymentByAllocationAmount]  (   @ManufacturerIds nvarchar(200),   @ManufacturerName nvarchar(100),   @POFromDate nvarchar(50),   @POToDate nvarchar(50),   @DocsReceived nvarchar(5),   @InvoiceStatuses_json nvarchar(100),   @OrderStatuses_json nvarchar(100)  )  as  begin  declare @sqlq1 nvarchar(max);  declare @sqlq2 nvarchar(max);  set @sqlq1 = 'select distinct   inv.[InvoiceID] as InvoiceId  ,inv.[InvoiceNumber] as InvoiceNumber  ,isnull(inv.OrderID,0) as OrderId  ,ord.Status as OrderStatus  ,ord.OrderType as OrderType  ,inv.[Status] as ActualInvoiceStatus  ,(case when (inv.[Status]=''Initiated'') then (case when  inv.InvoiceDueDate < getdate() then ''Due'' else ''Open'' end) else inv.[Status] end)  as DerivedInvoiceStatus  ,inv.invoiceDate InvoiceDate  ,cast(json_value(invitem.[ItemData], ''$.docsReceivedDate'') as date) as DocsReceivedDate  ,isnull(datediff(day, convert(nvarchar, cast(json_value(invitem.[ItemData], ''$.fittingDate'') as date), 111), convert(nvarchar, getdate(), 111)), 0) as ServiceDays  ,cast(isnull(json_value(inv.[PaymentData], ''$.creditApplied''), 0) as float) as Credit  ,concat(json_value(ord.[MemberData], ''$.firstName''), '''', json_value(ord.[MemberData], ''$.lastName'')) as MemberName  ,json_value(inv.[ProviderData], ''$.providerBusinessName'') as ProviderName  ,inv.[PONumber] as PONumber  ,bb.BrandId as BrandId  ,bb.BrandName as BrandName  ,bb.BrandCode as BrandCode  ,bb.BrandAddress1 as BrandAddress1  ,cast(json_Value(o.ordertransactionData, ''$.poDate'') as date) as PODate  ,inv.[InvoiceDueDate] as InvoiceDueDate  ,isnull(cast((invitem.Quantity * invitem.Cost) as float),0) as COGS  ,isnull(cast(ship.ShippingAmount as float),0) as ShippingAmount  ,isnull(cast(inv.InvoiceAmount as float),0) as TotalFee  ,isnull(cast(0 as float),0) as RebateAmount  ,isnull(cast(0 as float),0) as SalesTaxAmount  ,case inv.[Status] when ''InProcess'' then isnull(cast(json_value(inv.[PaymentData], ''$.invoicePayment'') as float), 0) when ''Paid'' then isnull(cast(json_value(inv.[PaymentData], ''$.invoicePayment'') as float), 0) when ''Authorize'' then isnull(cast(json_value(inv.[PaymentData], ''$.invoicePayment'') as float), 0) else 0 end as TotalPaid  ,(inv.InvoiceAmount - (case inv.[Status] when ''InProcess'' then isnull(cast(json_value(inv.[PaymentData], ''$.invoicePayment'') as float), 0) when ''Paid'' then isnull(cast(json_value(inv.[PaymentData], ''$.invoicePayment'') as float), 0) when ''Authorize'' then isnull(cast(json_value(inv.[PaymentData], ''$.invoicePayment'') as float), 0) else 0 end)) as TotalBalance  ,inv.isDocsSubmitted as DocsReceived  ,inv.[Remarks] as Remarks  ,json_value(inv.[PaymentData], ''$.paymentMethod'') as PaymentMethod  ,isnull(va.[VendorPreferredPaymentType], ''CHECK'') as PreferredPaymentType, va.[VendorAccountID] as VendorAccountId  from [accounts].[Invoices] as inv  join [accounts].[InvoiceItems] as invitem on(inv.InvoiceId=invitem.InvoiceId)   join [Orders].[OrderTransactionDetails] as o on o.orderid = inv.orderid and o.orderstatusCode = ''PO''  join [Orders].[Orders] as ord on inv.OrderId=ord.OrderId  left join [catalog].[Brands] as bb  on (bb.[BrandCode] = inv.BrandCode )'  +'left join [accounts].[VendorAccounts] as va  on (inv.BrandCode = va.[BrandCode])  left join [catalog].[BrandShippingFees] as ship  on(inv.BrandCode = ship.[BrandCode])  where inv.IsActive = 1 and inv.VendorType = ''MFG'' and bb.IsActive = 1'  ;  set @sqlq2 = 'Select row_number() over (order by i.InvoiceDueDate) as SNO,row_number() over (order by i.InvoiceDueDate) as RowID,  i.* from (' + @sqlq1+case when @ManufacturerName is not null and @ManufacturerName <> '' then ' and bb.[BrandName] like ''%'+@ManufacturerName+'%'' ' else '' end  +case when @ManufacturerIds is not null and @ManufacturerIds <> '' then ' and bb.BrandId in (select value from openjson('''+@ManufacturerIds+''')) ' else '' end  +case when @POFromDate is not null and @POFromDate <> '' then (' and conve
CREATE PROCEDURE [accounts].[GetManufacturerInvoiceStatistics]   (         @POFromDate NVARCHAR(50) = null,         @POToDate NVARCHAR(50) = null,         @option NVARCHAR(50)  )  AS  BEGIN         DECLARE @Open float;         DECLARE @OpenOrders float;         DECLARE @Due float;         DECLARE @Paid float;      DECLARE @Exception float;      DECLARE @NoOfExceptions bigint;         DECLARE @InvoiceStatistics TABLE(ID INT,OpenInvoiceAmount float, DueInvoiceAmount float, PaidInvoiceAmount float,ExceptionsInvoiceAmount float,NoOfExceptions bigInt );              IF (@option = 'Default')         Begin                SET @Open = (SELECT ISNULL(SUM(i.InvoiceAmount),0)         FROM [accounts].[invoices] i                left join catalog.brands b on b.brandcode = i.[VendorRefId]        WHERE CONVERT(NVARCHAR, i.InvoiceDueDate, 111) > CONVERT(NVARCHAR, getdate(), 111) AND i.IsActive = 1 AND i.VendorType = 'MFG' AND i.Status = 'Initiated')                  SET @Due = (SELECT ISNULL(SUM(i.InvoiceAmount),0)         FROM [accounts].[invoices] i                join catalog.brands b on b.brandcode = i.[VendorRefId]            WHERE i.IsActive = 1 AND CONVERT(NVARCHAR, i.InvoiceDueDate, 111) <= CONVERT(NVARCHAR, getdate(), 111) AND i.VendorType = 'MFG' AND i.Status = 'Initiated')                  SET @Paid = (SELECT ISNULL(SUM(i.InvoiceAmount),0)         FROM [accounts].[invoices] i               join catalog.brands b on b.brandcode = i.[VendorRefId]          WHERE i.Status = 'Paid' AND i.IsActive = 1 AND i.VendorType = 'MFG' )     SET @Exception = (select  isnull(sum(InvoiceAmount),0) from [accounts].[InvoiceExceptions] where Status='Initiated' and IsActive=1);       SET @NoOfExceptions = Isnull((select  count(*) from [accounts].[InvoiceExceptions] where Status='Initiated' and IsActive=1),0)           End           if (@option = 'Week')           Begin                SET @Open = (SELECT ISNULL(SUM(i.InvoiceAmount),0)         FROM [accounts].[invoices] i                join catalog.brands b on b.brandcode = i.[VendorRefId]         WHERE CONVERT(NVARCHAR, i.InvoiceDueDate, 111) > CONVERT(NVARCHAR, CAST(@POToDate AS DATE),111) AND i.IsActive = 1 AND i.VendorType = 'MFG' and i.status = 'Initiated' )                 SET @Due = (SELECT ISNULL(SUM(i.InvoiceAmount),0)         FROM [accounts].[invoices] i                join catalog.brands b on b.brandcode = i.[VendorRefId]          WHERE i.IsActive = 1 AND CONVERT(NVARCHAR, i.InvoiceDueDate, 111) <= CONVERT(NVARCHAR, CAST(@POToDate AS DATE),111) AND i.VendorType = 'MFG' and i.status = 'Initiated')                 SET @Paid = (SELECT ISNULL(SUM(i.InvoiceAmount),0)         FROM [accounts].[invoices] i         join catalog.brands b on b.brandcode = i.[VendorRefId]          where i.IsActive = 1 AND i.status = 'Paid' AND i.VendorType = 'MFG')      SET @Exception = (select  isnull(sum(InvoiceAmount),0) from [accounts].[InvoiceExceptions] where Status='Initiated' and IsActive=1 AND CONVERT(NVARCHAR, InvoiceDueDate, 111) < CONVERT(NVARCHAR, CAST(@POToDate AS DATE),111));       SET @NoOfExceptions = Isnull((select  count(*) from [accounts].[InvoiceExceptions] where Status='Initiated' and IsActive=1 AND CONVERT(NVARCHAR, InvoiceDueDate, 111) < CONVERT(NVARCHAR, CAST(@POToDate AS DATE),111)),0)           End         else if (@option = 'Custom')         Begin           SET @Open = (SELECT ISNULL(SUM(inv.InvoiceAmount),0) FROM         (select invoiceid, invoiceAmount, invoiceDueDate from [accounts].[invoices] i        INNER JOIN [Orders].[OrderTransactionDetails] t ON i.orderid = t.orderid and t.orderstatuscode = 'PO'        WHERE CONVERT(NVARCHAR, CAST(JSON_VALUE(t.[OrderTransactionData], '$.poDate') AS DATE), 111) >= CONVERT(NVARCHAR, CAST(@POFromDate AS DATE),111)        AND CONVERT(NVARCHAR, CAST(JSON_VALUE(t.OrderTransactionData, '$.poDate') AS DATE), 111) <= CONVERT(NVARCHAR, CAST(@POToDate AS DATE))        AND i.IsActive = 1 AND i.VendorType  = 'MFG' and i.status = 'Initiated') inv        where inv.Inv
 CREATE PROCEDURE [accounts].[sp_GetPendingApprovalInvoicesByBatch]  (   @batchId BIGINT,   @VendorType nvarchar(10)  )  AS  BEGIN    select ROW_NUMBER() OVER (ORDER BY r.InvoiceID) AS RowID  ,r.* from  (SELECT distinct  pp.ProviderName AS 'ProviderName'  ,pp.ProviderId as ProviderId  ,br.[BrandID] as BrandId  ,br.[BrandCode] as BrandCode  ,br.[BrandName] as BrandName  ,inv.InvoiceID  ,inv.[InvoiceNumber] as InvoiceNumber  ,JSON_VALUE(iit.[ItemData], '$.nhMemberId') AS 'NHMemberID'  ,inv.PONumber  ,JSON_VALUE(iit.[ItemData], '$.orderStatus') AS 'OrderStatus'  ,convert(nvarchar,DateAdd(day,-60,inv.invoiceDueDate),110) FittingDate  ,JSON_VALUE(iit.[ItemData], '$.memberFirstName')  + ' ' +  JSON_VALUE(iit.[ItemData], '$.memberLastName') AS 'MemberName'  ,CAST(JSON_VALUE(iit.[ItemData], '$.dispensingFee') AS FLOAT) AS 'DispensingFee',CAST(InvoiceAmount AS FLOAT) AS InvoiceAmount  ,cast(isnull(json_value(inv.PaymentData, '$.creditApplied'), 0) as float) AS Credit  ,(InvoiceAmount - (case inv.[Status] when 'InProcess' then isnull(cast(json_value(inv.[PaymentData], '$.invoicePayment') as float), 0) when 'Paid' then isnull(cast(json_value(inv.[PaymentData], '$.invoicePayment') as float), 0) when 'Authorize' then isnull(cast(json_value(inv.[PaymentData], '$.invoicePayment') as float), 0) else 0 end) - CAST(0 AS FLOAT)) AS InvoicesSelected  ,inv.BatchId as BatchID  FROM [accounts].[invoices] AS inv  INNER JOIN [accounts].[InvoiceItems] iit  on inv.InvoiceId = iit.InvoiceId  INNER  JOIN (SELECT * FROM accounts.InvoiceTransactions AS it WHERE it.[Status]='Approval' AND it.IsActive=1) AS invt  ON inv.InvoiceId = invt.InvoiceId  INNER JOIN provider.providerprofiles AS pp  ON inv.ProviderId = pp.ProviderId  left join [catalog].[Brands] br  on br.[BrandCode] = inv.[BrandCode]  WHERE (inv.VendorType=@VendorType) AND inv.[Status]='Approval' AND inv.ProviderId IS NOT NULL AND inv.BatchID = @batchId  )r    END    
  CREATE PROCEDURE [accounts].[getpoitems](   @ItemType nvarchar(10),   @PONumbers nvarchar(max)   )   AS   BEGIN    SELECT     [OrderItemId]    ,[OrderId]    ,[BrandCode]    ,[FamilyCode]    ,[StyleCode]    ,[TechnologyLevelCode]    ,[ProductModelCode]    ,case when [BrandCode] in ('gnr', 'beltone') then [ProductModelCode] else [ItemCode] end as [ItemCode]    ,[Modifier]    ,[Quantity]    ,[Amount]    ,[Status]    ,[UnitPrice]    ,[PairPrice]    ,[ItemData]    ,[ItemType]    ,[PONumber]    ,[InvoiceNumber]    ,[CreateUser]    ,[CreateDate]    ,[ModifyUser]    ,[ModifyDate]    ,[IsActive]    FROM Orders.OrderItems    WHERE IsActive=1 and    ItemType=@ItemType and    cast(PONumber as nvarchar) IN (SELECT value FROM openjson(@PONumbers) WITH (value nvarchar(15) '$'));   end    
  CREATE PROCEDURE [accounts].[GetOpenPOs]   @POFromDate NVARCHAR(50),   @POToDate NVARCHAR(50),    @ManufacturerID BIGINT     AS  BEGIN      -- SET NOCOUNT ON added to prevent extra result sets from      -- interfering with SELECT statements.     SET NOCOUNT ON     SELECT DISTINCT         B.Brandid,       OI.BrandCode  ManufacturerName,       CAST(OP.PONumber  AS VARCHAR) AS PONumber,        CONVERT(NVARCHAR,CAST(JSON_VALUE(OT.[OrderTransactionData],'$.poDate') AS DATE), 110) AS PODate,       O.OrderId,       CONVERT(VARCHAR,O.[DateOrderInitiated],110)  DateOrderInitiated,       ''  InvoiceNumber,       ''  InvoiceDueDate,       ''  InvoiceDate,       B.[BrandEmail]  ManufacturerEmail,JSON_VALUE(FT.ORDERTRANSACTIONDATA, '$.fittingDate') FittingDate,       B.[MFGContactNumber]  ManufacturerContactNumber,           case when AK.orderstatusCode is null then 'Pending' else 'Acknowledgement' end AckFromManufacturer,         ''  Remarks,          O.OrderId  ExceptionID       INTO #TEMP1       FROM  [Orders].[Orders] O       INNER JOIN  [Orders].[OrderPOs] OP  ON OP.OrderId =  O.orderid       INNER JOIN  [Orders].[OrderItems] OI ON OI.OrderId=O.OrderId       INNER JOIN  [catalog].[Brands] B ON B.[BrandCODE] =  OI.[BrandCODE]        left JOIN  [Orders].[OrderTransactionDetails] FT ON FT.OrderId=O.OrderId           AND FT.orderstatusCode='CLM'           AND FT.Iscomplete =1           AND FT.isactive=1       left JOIN  [Orders].[OrderTransactionDetails] AK ON AK.OrderId=O.OrderId           AND AK.orderstatusCode='ACK'           AND AK.Iscomplete =1           AND AK.isactive=1       INNER JOIN  [Orders].[OrderTransactionDetails] OT ON OT.OrderId=OI.OrderId           AND OT.orderstatusCode='PO'           AND OT.Iscomplete =1           AND OT.isactive=1          AND JSON_VALUE(OT.ORDERTRANSACTIONDATA, '$.poNumber')=CAST(OP.PONumber AS VARCHAR)                   WHERE   O.ORDERID NOT IN (SELECT ORDERID FROM [accounts].[Invoices] WHERE VendorType ='MFG')          order by O.ORDERID,poDate,PONumber       IF(@ManufacturerID=0 AND @POFromDate='NULL' AND @POToDate ='NULL')     BEGIN      SELECT * FROM #TEMP1       END      ELSE IF(@ManufacturerID>0 AND @POFromDate='NULL' AND @POToDate ='NULL')     BEGIN      SELECT * FROM #TEMP1        WHERE Brandid=@ManufacturerID       END           ELSE IF(@ManufacturerID>0 AND @POFromDate='NULL' AND @POToDate IS NOT NULL)       BEGIN        SELECT * FROM #TEMP1        WHERE Brandid=@ManufacturerID AND       (CONVERT(NVARCHAR,CAST(poDate AS DATE),101)  <= CONVERT(NVARCHAR, CAST(@POToDate AS DATE),101) )          END    ELSE IF(@ManufacturerID=0 AND @POFromDate='NULL' AND @POToDate IS NOT NULL)    BEGIN     SELECT * FROM #TEMP1        WHERE        (CONVERT(NVARCHAR,CAST(poDate AS DATE),101)  <= CONVERT(NVARCHAR, CAST(@POToDate AS DATE),101) )     END     ELSE IF(@ManufacturerID>0 AND @POFromDate IS  NOT NULL AND @POToDate ='NULL')    BEGIN      SELECT * FROM #TEMP1        WHERE Brandid=@ManufacturerID AND       CONVERT(NVARCHAR,CAST(poDate AS DATE),101) >= CONVERT(NVARCHAR, CAST(@POFromDate AS DATE),101)      END     ELSE IF(@ManufacturerID=0 AND @POFromDate IS  NOT NULL AND @POToDate ='NULL')    BEGIN       SELECT * FROM #TEMP1        WHERE  CONVERT(NVARCHAR,CAST(poDate AS DATE),101) >= CONVERT(NVARCHAR, CAST(@POFromDate AS DATE),101)        END      ELSE IF(@ManufacturerID>0 AND @POFromDate IS NOT NULL AND @POToDate IS NOT NULL)    BEGIN        SELECT * FROM #TEMP1        WHERE Brandid=@ManufacturerID       AND (CONVERT(NVARCHAR,CAST(poDate AS DATE),101)  >= CONVERT(NVARCHAR, CAST(@POFromDate AS DATE),101))      AND (CONVERT(NVARCHAR,CAST(poDate AS DATE),101)  <= CONVERT(NVARCHAR, CAST(@POToDate AS DATE),101))          END    ELSE IF(@ManufacturerID=0 AND @POFromDate IS NOT NULL AND @POToDate IS NOT NULL)    BEGIN      SELECT * FROM #TEMP1        WHERE  CONVERT(NVARCHAR,CAST(poDate AS DATE),101) >= CONVERT(NVARCHAR, CAST(@POFromDate AS DATE),101)       AND  (CONVERT(NVARCHAR,CAST(poDate AS DATE),101)  <= CO
/*  Mohan deployed to Production on 12 May 2020  */    CREATE PROCEDURE [accounts].[GetInvoiceExceptions](   @POFromDate NVARCHAR(50),   @POToDate NVARCHAR(50),   @ExceptionType NVARCHAR(50),   @InvoiceSource NVARCHAR(50),   @ManufacturerID BIGINT   )   AS    BEGIN      SELECT       e.ExceptionID,      b.BrandName as 'ManufacturerName',      e.PONumber,      (CONVERT(NVARCHAR,po.PODate)) AS PODate,      [InvoiceNumber],      CONVERT(NVARCHAR(10),InvoiceDate,110) AS InvoiceDate,      CONVERT(NVARCHAR(10),InvoiceDueDate,110) AS InvoiceDueDate,      b.Brandemail AS 'ManufacturerEmail',      b.MFGContactNumber AS 'ManufacturerContactNumber',      '' as 'FittingDate',      AckFromManufacturer,      Remarks,      PO.OrderId,      '' as DateOrderInitiated       ,b.BrandID as 'BrandID'    --INTO #TEMP     FROM [accounts].[InvoiceExceptions] e           inner join [Orders].[OrderPOs] po on e.[PONumber] = cast(po.[PONumber] as nvarchar) and po.IsActive=1       INNER JOIN [catalog].[Brands] b ON e.BrandCode = b.BrandCode   where ((poDate >= @POFromDate and poDate < DATEADD(day,1,@POToDate))    OR (@POFromDate IS NULL AND @POToDate IS NULL)   OR (@POFromDate IS NULL AND poDate < DATEADD(day,1,@POToDate))   OR (@POToDate IS NULL AND poDate >= @POFromDate)      )    and  (@ManufacturerID =0  OR b.BrandID = @ManufacturerID)  END  
CREATE procedure [accounts].[sp_ClaimPaymentAggregateDetails]  (   @InsuranceCarrierIds nvarchar(200),   @FromFittingDate nvarchar(50),   @ToFittingDate nvarchar(50),   @DocsReceived nvarchar(5),   @InvoiceStatuses_json nvarchar(100),   @allocationAmount float  )  as  declare @Invoices table(   InsuranceCarrierId bigint,   InsuranceCarrierName nvarchar(50),   InvoiceId bigint,   InvoiceDueDate date,   OrderId nvarchar(15),   DerivedInvoiceStatus nvarchar(15),   TotalClaimAmount float,   TotalPaid float,   TotalCredit float,   Remarks nvarchar(max),   ServiceType nvarchar(30)  );  declare @ClaimInvoices table(   RunningTotal float,   RowID bigint,   InsuranceCarrierId bigint,   InsuranceCarrierName nvarchar(50),   InvoiceId bigint,   InvoiceDueDate date,   OrderId nvarchar(15),   DerivedInvoiceStatus nvarchar(15),   TotalClaimAmount float,   TotalPaid float,   TotalCredit float,   Remarks nvarchar(max),   ServiceType nvarchar(30)  );  begin  declare @sqlq nvarchar(max);  declare @sqlq2 nvarchar(max);  set @sqlq = 'select distinct   accounts.CheckNumiricORNot(inv.[VendorRefId]) as InsuranceCarrierId   ,Json_value(inv.[VendorData],''$.insuranceCarrierName'')  as InsuranceCarrierName  ,inv.[InvoiceID] as InvoiceId  ,CONVERT(Date, inv.invoiceDueDate,101) invoiceDueDate  ,o.OrderId  --, case     --    when inv.[Status]=''Initiated'' and inv.[IsDocsSubmitted] = 1 and inv.InvoiceDueDate < getdate()  -- then ''Due''  -- when inv.[Status]=''Initiated'' and inv.InvoiceDueDate > getdate() then ''Open''  -- else inv.Status end as DerivedInvoiceStatus  ,inv.[Status] as DerivedInvoiceStatus  ,inv.InvoiceAmount as TotalClaimAmount  ,case inv.[Status] when ''InProcess'' then isnull(cast(json_value(inv.[PaymentData], ''$.invoicePayment'') as float), 0) when ''Paid'' then isnull(cast(json_value(inv.[PaymentData], ''$.invoicePayment'') as float), 0) when ''Authorize'' then isnull(cast(json_value(inv.[PaymentData], ''$.invoicePayment'') as float), 0) else 0 end as TotalPaid  ,isnull(cast(json_value(inv.[PaymentData], ''$.creditApplied'') as float), 0) as TotalCredit  ,inv.Remarks  ,json_value(inv.vendordata,''$.itemData[0].serviceType'') as ServiceType  from [accounts].[Invoices] as inv  inner join [Insurance].[InsuranceCarriers] ins on ins.[InsuranceCarrierID] = accounts.CheckNumiricORNot(inv.[VendorRefId])  left join [Orders].[Orders] o on o.orderid = inv.orderid '  +' where inv.IsActive = 1 and inv.VendorType = ''CLM'''  +case when @InsuranceCarrierIds is not null and @InsuranceCarrierIds <> '' then ' and ins.[InsuranceCarrierID] in (select value from openjson('''+@InsuranceCarrierIds+''')) ' else '' end  +case when @FromFittingDate is not null and @FromFittingDate <> '' then (' and CONVERT(NVARCHAR, inv.InvoiceDueDate, 111) >= convert(nvarchar, cast('''+@FromFittingDate+''' as date), 111)') else '' end  +case when @ToFittingDate is not null and @ToFittingDate <> '' then (' and CONVERT(NVARCHAR, inv.InvoiceDueDate, 111) <= convert(nvarchar, cast('''+@ToFittingDate+''' as date), 111)') else '' end  +case when @InvoiceStatuses_json is not null and @InvoiceStatuses_json <> '' then (' and inv.[Status] in (select value from openjson('''+@InvoiceStatuses_json+''') with (value nvarchar(20) ''$''))') else '' end;  insert into @Invoices exec ('select i.*from ('+@sqlq + ')i order by InvoiceDueDate asc');    insert into @ClaimInvoices  select sum(q.TotalClaimAmount) over (order by q.RowID) runningTotal,q.* from (  SELECT row_number() over (order by p.InvoiceDueDate) as RowID, p.* from (SELECT *FROM @Invoices)p  )q    order by q.InvoiceDueDate asc    if @allocationAmount > 0    begin    select      row_number() over (order by clm.InsuranceCarrierId) as RowID     ,clm.InsuranceCarrierId as InsuranceCarrierId     ,clm.InsuranceCarrierName as InsuranceCarrierName     ,concat('[',string_agg(cast(clm.InvoiceId as nvarchar(max)),','), ']') as InvoiceIds     ,count(*) as TotalClaims     ,sum(isnull(clm.TotalClaimAmount,0)) as TotalClaimAmount     ,sum(isnull(clm.
CREATE PROCEDURE [accounts].[GetClaimInvoiceStatistics]  (   @FromFittingDate NVARCHAR(50) = null,   @ToFittingDate NVARCHAR(50) = null,   @option NVARCHAR(50)  )  AS  BEGIN   DECLARE @Open float;   DECLARE @OpenOrders float;   DECLARE @DueWithDocs float;   DECLARE @DueWithoutDocs float;   DECLARE @Paid float;   DECLARE @PMPM_OPEN float;   DECLARE @PMPM_DUE float;   DECLARE @PMPM_PAID float;   DECLARE @INIT_AND_REINITCLAIMS int;   DECLARE @AUTHORIZECLAIMS int;   DECLARE @INPROCESS_AND_ACKCLAIMS int;   DECLARE @InvoiceStatistics TABLE(ID int,OpenInvoiceAmount float, DueWithDocsInvoiceAmount float, DueWithNoDocsInvoiceAmount float, PaidInvoiceAmount float,RejectedInvoiceAmount float,OverDueInvoiceAmount float   ,OpenPMPM float,DuePMPM float,PaidPMPM float,RejectedPMPM float,OverDuePMPM float,InitiatedAndReInitiatedClaims int,AuthorizeClaims int,InprocessAndAckClaims int   ,RejectedClaims int,ApprovedClaims int,PartiallyRejectedClaims int);       IF (@option = 'Default')   Begin         SET @Open = (SELECT ISNULL(SUM(i.InvoiceAmount),0)         FROM [accounts].[invoices] i join [Insurance].[InsuranceConfig] ic         on i.Vendorrefid=ic.[InsuranceCarrierID] and Json_value(ic.ConfigData,'$.IsZeroClaim')='false'         WHERE i.VendorType = 'CLM' and  i.IsActive=1 and i.[status] in ('initiated','re-initiated','AUTHORIZE','RE-AUTHORIZE','APPROVAL'))    SET @DueWithDocs = (SELECT ISNULL(SUM(i.InvoiceAmount),0)         FROM [accounts].[invoices] i join [Insurance].[InsuranceConfig] ic         on i.Vendorrefid=ic.[InsuranceCarrierID] and Json_value(ic.ConfigData,'$.IsZeroClaim')='false'         WHERE i.VendorType = 'CLM' and i.IsActive=1 and i.[status] in ('InProcess','ACK','DECLINED','ENQ'))    SET @DueWithoutDocs = (SELECT ISNULL(SUM(i.InvoiceAmount),0)          FROM [accounts].[invoices] i join [Insurance].[InsuranceConfig] ic          on i.Vendorrefid=ic.[InsuranceCarrierID] and Json_value(ic.ConfigData,'$.IsZeroClaim')='false'          WHERE i.VendorType = 'CLM' and i.IsActive=1 and i.[status] in ('InProcess','ACK','DECLINED','ENQ'))    SET @Paid = (SELECT ISNULL(SUM(i.InvoiceAmount),0)        FROM [accounts].[invoices] i join [Insurance].[InsuranceConfig] ic        on i.Vendorrefid=ic.[InsuranceCarrierID] and Json_value(ic.ConfigData,'$.IsZeroClaim')='false'        where   i.VendorType = 'CLM'  and i.IsActive=1        and i.[status] = 'Paid')      -- PMPM Statistics    SET @PMPM_OPEN = (select isnull(sum(convert(float,id.benefitAmount)),0)         from accounts.invoices i join [Insurance].[InsuranceConfig] ic          on i.Vendorrefid=ic.[InsuranceCarrierID] and Json_value(ic.ConfigData,'$.IsZeroClaim')='true'          cross apply openjson(i.vendordata,'$.itemData')           with (benefitAmount nvarchar(100)) id          WHERE i.VendorType = 'CLM' and  i.IsActive=1 and i.[status] in ('initiated','re-initiated','AUTHORIZE','RE-AUTHORIZE','APPROVAL'))      SET @PMPM_DUE = (select isnull(sum(convert(float,id.benefitAmount)),0)         from accounts.invoices i join [Insurance].[InsuranceConfig] ic          on i.Vendorrefid=ic.[InsuranceCarrierID] and Json_value(ic.ConfigData,'$.IsZeroClaim')='true'          cross apply openjson(i.vendordata,'$.itemData')           with (benefitAmount nvarchar(100)) id          WHERE i.VendorType = 'CLM' and  i.IsActive=1 and i.[status] in ('InProcess','ACK','DECLINED','ENQ'))      SET @PMPM_PAID = (select isnull(sum(convert(float,id.benefitAmount)),0)         from accounts.invoices i join [Insurance].[InsuranceConfig] ic          on i.Vendorrefid=ic.[InsuranceCarrierID] and Json_value(ic.ConfigData,'$.IsZeroClaim')='true'          cross apply openjson(i.vendordata,'$.itemData')           with (benefitAmount nvarchar(100)) id          WHERE i.VendorType = 'CLM' and  i.IsActive=1 and i.[status] = 'Paid')      SET @INIT_AND_REINITCLAIMS = (Select count(*) from [accounts].[invoices] i WHERE i.VendorType = 'CLM' and  i.IsActive=1 and i.[status] in ('Initiated','Re-Initiated'))      SET @AUTHORIZECLAIMS 
  -- exec [accounts].[sp_ProviderPaymentAggregateDetails_Test] '',1,'','','','all','["Open"]','["Active"]',0,'',0  CREATE procedure [accounts].[sp_ProviderPaymentAggregateDetails_Test]  (         @ProviderIds nvarchar(200),         @IncludeProviderName bit = 1,         @ProviderLegalName nvarchar(100),         @POFromDate nvarchar(50),         @POToDate nvarchar(50),         @DocsReceived nvarchar(5),         @InvoiceStatuses_json nvarchar(100),         @OrderStatuses_json nvarchar(100),         @IncludeBrands bit,         @BrandCodes_json nvarchar(100),         @allocationAmount float  )  as  declare @Invoices table(         ProviderId bigint,         BrandCode nvarchar(15),         InvoiceId bigint,         InvoiceDueDate date,         OrderId nvarchar(15),         DerivedInvoiceStatus nvarchar(15),         TotalFee float,         TotalPaid float,         TotalCredit float  );  declare @ProviderInvoices table(         RunningTotal float,         RowID bigint,         ProviderId bigint,         BrandCode nvarchar(15),         InvoiceId bigint,         InvoiceDueDate date,         OrderId nvarchar(15),         DerivedInvoiceStatus nvarchar(15),         TotalFee float,         TotalPaid float,         TotalCredit float  );  begin  declare @sqlq nvarchar(max);  declare @sqlq2 nvarchar(max);  set @sqlq = 'select distinct  inv.ProviderId as ProviderId  ,inv.[BrandCode] as BrandCode  ,inv.[InvoiceID] as InvoiceId  ,CONVERT(Date, inv.invoiceDueDate,101) invoiceDueDate  ,o.OrderId  ,(case when o.Status = ''ACTIVE'' then (case when (inv.[Status]=''Initiated'') then (case when inv.[IsDocsSubmitted] = 1 and inv.InvoiceDueDate < getdate() then ''Due'' when inv.InvoiceDueDate > getdate() then ''Open'' end) else inv.[Status] end) else ''VOID'' end) as DerivedInvoiceStatus  ,inv.InvoiceAmount as TotalFee  ,case inv.[Status] when ''InProcess'' then isnull(cast(json_value(inv.[PaymentData], ''$.invoicePayment'') as float), 0) when ''Paid'' then isnull(cast(json_value(inv.[PaymentData], ''$.invoicePayment'') as float), 0) when ''Authorize'' then isnull(cast(json_value(inv.[PaymentData], ''$.invoicePayment'') as float), 0) else 0 end as TotalPaid  ,isnull(cast(json_value(inv.[PaymentData], ''$.creditApplied'') as float), 0) as TotalCredit  from [accounts].[Invoices] as inv  inner join [Orders].[Orders] o on o.orderid = inv.orderid   left join [provider].[ProviderProfiles] as pp  on (pp.[ProviderId] = inv.ProviderId)'  +' where inv.IsActive = 1 and inv.VendorType = ''PRO'''  +case when @BrandCodes_json is not null and @BrandCodes_json <> '' then (' and inv.[BrandCode] '+(case @IncludeBrands when 1 then 'in' else 'not in' end)+' (select value from openjson('''+ @BrandCodes_json + ''') with (value nvarchar(15) ''$''))') else '' end  +case when @ProviderLegalName is not null and @ProviderLegalName <> '' then ' and pp.[ProviderName]'+(case @IncludeProviderName when 0 then ' not like ' else ' like ' end)+'''%'+@ProviderLegalName+'%'' ' else '' end  +case when @ProviderIds is not null and @ProviderIds <> '' then ' and pp.ProviderId in (select value from openjson('''+@ProviderIds+''')) ' else '' end  +case when @POFromDate is not null and @POFromDate <> '' then (' and convert(nvarchar, cast(DateAdd(day,-60,inv.invoiceDueDate) as date), 111) >= convert(nvarchar, cast('''+@POFromDate+''' as date), 111)') else '' end  +case when @POToDate is not null and @POToDate <> '' then (' and convert(nvarchar, cast(DateAdd(day,-60,inv.invoiceDueDate) as date), 111) <= convert(nvarchar, cast('''+@POToDate+''' as date), 111)') else '' end  +case when @InvoiceStatuses_json is not null and @InvoiceStatuses_json <> '' then (' and (case when o.Status = ''ACTIVE'' then (case when (inv.[Status]=''Initiated'') then (case when inv.[IsDocsSubmitted] = 1 and inv.InvoiceDueDate < getdate() then ''Due'' when inv.InvoiceDueDate > getdate() then ''Open'' end) else inv.[Status] end) else ''VOID'' end) in (select value from openjson('''+@InvoiceStatuses_json+''') with (value nvarchar
CREATE PROCEDURE [alerts].[UpdateInsuranceContractProducts]  AS   TRUNCATE TABLE Insurance.ContractProducts  
--exec [auth].[Get_UserDefaultRoleID] 1689,'NH.Provider'  CREATE PROCEDURE [auth].[Get_UserDefaultRoleID]    @UserProfileID bigint,   @ClientID varchar(50) = 'NH.Provider'  AS  BEGIN  /*  Author: Mohan Nanduri   Date: August 20 2018  Desription 1: This stored procedure returns Highest Previlised UserGroup and and that Groups RoleID of a given MemberProfileID and give ClientID (AppModuleID)  Description 2 : IsActive conditions Added on Nov 11 2018  */    DECLARE @AppModuleId BIGINT  DECLARE @HomePage varchar(50)  SET @HomePage = NULL  IF (@ClientID =  'NH.Provider')   BEGIN       SET @AppModuleId=1     SET @HomePage= '/'   END  ELSE IF (@ClientID =  'NH.CallCenter')   BEGIN        SET @AppModuleId=4    SET @HomePage= '/Call/Home'   END  ELSE IF (@ClientID =  'NH.Accounts')   BEGIN        SET @AppModuleId=3  END  ELSE IF (@ClientID =  'NH.Admin')   BEGIN        SET @AppModuleId=2  END  ELSE       SET @AppModuleId=1      -- SET NOCOUNT ON added to prevent extra result sets from   -- interfering with SELECT statements.   SET NOCOUNT ON;      SELECT TOP 1 A.[UserProfileId], A.[UserGroupId], B.[DefaultAppModuleRoleId], case when @HomePage is null then C.[AppModuleRoleMenuPage] else @HomePage end as 'HomePage', cast(S.[SettingValue] as bigint) as 'DefaultLocationId'    FROM [auth].[UserProfileGroups] A WITH (NOLOCK)    INNER JOIN [auth].[UserGroups] B WITH (NOLOCK) ON B.[UserGroupId] = A.[UserGroupId]    INNER JOIN [auth].[AppModuleRoleMenus] C WITH (NOLOCK) ON C.[AppModuleRoleId] = B.[DefaultAppModuleRoleId] and C.[AppModuleRoleMenuName] = 'Home'    INNER JOIN [auth].[UserGroupModules] D WITH (NOLOCK) ON D.[UserGroupId] = A.[UserGroupId] and D.[AppModuleId] = @AppModuleId    LEFT JOIN (   select T.[SettingValue], T.[UserProfileId]   from [auth].[UserProfileSettings] T   inner join [provider].[ProviderUserLocations] pul   on pul.[UserProfileId]=T.[UserProfileId] and cast(T.[SettingValue] as bigint)=pul.[LocationId]   where T.[UserProfileId]=@UserProfileID and T.[IsActive]=1 and pul.[IsActive]=1 and T.[SettingName]='LocationId'   ) S   ON S.[UserProfileId]=A.[UserProfileId]    WHERE     A.[UserProfileId] = @UserProfileID AND A.IsActive=1 AND B.IsActive=1 AND C.IsActive=1 AND D.IsActive=1  END  
      CREATE PROCEDURE [auth].[UpdateLastLoginDate]  (    @UserProfileId bigint,    @LastLoginDate datetime  )  AS  BEGIN     Update [auth].[UserProfiles] set LastLoginDate = @LastLoginDate,IsForcedLogout=0  where UserProfileId = @UserProfileId       select *from [auth].[UserProfiles] where UserProfileId = @UserProfileId    END  
              CREATE PROCEDURE [auth].[Get_UserDefaultRoleID] @UserProfileID BIGINT   ,@ClientID VARCHAR(50) = 'NH.Provider'  AS  BEGIN   /*    Author: Mohan Nanduri   Date: August 20 2018    Desription 1  : This stored procedure returns Highest Previlised UserGroup and and that Groups RoleID of a given MemberProfileID and give ClientID (AppModuleID)  Description 2 : IsActive conditions Added on Nov 11 2018        Modified By : Bhanu Chander Bomma  Date        : November 12 2020  Description : added condition for otc bm client id(NH.OTCBM)    */   DECLARE @AppModuleId BIGINT   DECLARE @HomePage VARCHAR(50)     SET @HomePage = NULL     IF (@ClientID = 'NH.Provider')   BEGIN    SET @AppModuleId = 1    SET @HomePage = '/'   END   ELSE IF (     @ClientID = 'NH.CallCenter'     OR @ClientID = 'NH.VirtualCare'     )   BEGIN    SET @AppModuleId = 4    SET @HomePage = '/Call/Home'   END   ELSE IF (@ClientID = 'NH.Accounts')   BEGIN    SET @AppModuleId = 3   END   ELSE IF (@ClientID = 'NH.Admin')   BEGIN    SET @AppModuleId = 2   END   ELSE IF (@ClientID = 'NH.OTCBM')   BEGIN    SET @AppModuleId = (      SELECT appmoduleid      FROM auth.appmodules      WHERE modulename = 'OTC PM Portal'      )   END   ELSE    SET @AppModuleId = 1     -- SET NOCOUNT ON added to prevent extra result sets from   -- interfering with SELECT statements.   SET NOCOUNT ON;     SELECT TOP 1 A.[UserProfileId]    ,A.[UserGroupId]    ,B.[DefaultAppModuleRoleId]    ,CASE      WHEN @HomePage IS NULL      THEN C.[AppModuleRoleMenuPage]     ELSE @HomePage     END AS 'HomePage'    ,cast(S.[SettingValue] AS BIGINT) AS 'DefaultLocationId'   FROM [auth].[UserProfileGroups] A WITH (NOLOCK)   INNER JOIN [auth].[UserGroups] B WITH (NOLOCK) ON B.[UserGroupId] = A.[UserGroupId]   INNER JOIN [auth].[UserGroupModuleRoles] U ON U.[UserGroupId] = B.[UserGroupId]   INNER JOIN [auth].[AppModuleRoles] R ON R.[AppModuleRoleId] = U.[AppModuleRoleId]    AND R.[AppModuleId] = @AppModuleId   INNER JOIN [auth].[AppModuleRoleMenus] C WITH (NOLOCK) ON C.[AppModuleRoleId] = R.[AppModuleRoleId]    OR C.[AppModuleRoleMenuName] = 'Home'   INNER JOIN [auth].[UserGroupModules] D WITH (NOLOCK) ON D.[UserGroupId] = A.[UserGroupId]    AND D.[AppModuleId] = @AppModuleId   LEFT JOIN (    SELECT T.[SettingValue]     ,T.[UserProfileId]    FROM [auth].[UserProfileSettings] T    INNER JOIN [provider].[ProviderUserLocations] pul ON pul.[UserProfileId] = T.[UserProfileId]     AND cast(T.[SettingValue] AS BIGINT) = pul.[LocationId]    WHERE T.[UserProfileId] = @UserProfileID     AND T.[IsActive] = 1     AND pul.[IsActive] = 1     AND T.[SettingName] = 'LocationId'    ) S ON S.[UserProfileId] = A.[UserProfileId]   WHERE A.[UserProfileId] = @UserProfileID    AND A.IsActive = 1    AND B.IsActive = 1    AND C.IsActive = 1    AND D.IsActive = 1  END  
--EXEC [auth].[VerifyUserSecurityCode] '180000','dcooper'  CREATE PROCEDURE [auth].[VerifyUserSecurityCode]      (          @providerCode nvarchar(20),          @securityCode nvarchar(30)      )      AS      BEGIN         select UP.UserProfileId,UP.IsRegister,UP.TemproryKeyCode,UP.ProviderCode,PP.ProviderName,UP.UserName from [AUTH].[UserProfiles] as UP         left join [provider].[ProviderUsers] as PU on PU.USERPROFILEID=UP.UserProfileId    left join [provider].[ProviderProfiles] as PP on PP.PROVIDERID=PU.PROVIDERID     where UP.providercode=@providerCode  and UP.TemproryKeyCode=@securityCode  and UP.isactive=1 order by UP.UserProfileId desc      END  
CREATE PROCEDURE [auth].[Get_UserProfileByProviderCode]          @ProviderCode Varchar(50),         @SecurityCode Varchar(50)      /*        Author: Srinivas G        Date: December 19 2018        Desription 1: This stored procedure returns profile details by providercode which are IsActive=1        */        AS        BEGIN        select UP.UserProfileId,UP.TemproryKeyCode,UP.ProviderCode,PP.ProviderName,UP.UserName from [AUTH].[UserProfiles] as UP       left join [provider].[ProviderUsers] as PU on PU.USERPROFILEID=UP.UserProfileId  left join [provider].[ProviderProfiles] as PP on PP.PROVIDERID=PU.PROVIDERID  where UP.providercode=@ProviderCode and UP.TemproryKeyCode=@SecurityCode and UP.isactive=1 order by UP.UserProfileId desc        END  
  --EXEC [auth].[GetUserMenusAndFeatures] 5, 1191,1  CREATE procedure [auth].[GetUserMenusAndFeatures] (   @UserProfileId bigint, @ProviderId bigint, @AppmoduleId bigint  )  as  begin    select *from (  select   ROW_NUMBER() OVER(ORDER BY c.MenuId, c.SubMenuId ASC) AS RowId,@UserProfileId as 'UserProfileId', @ProviderId as 'ProviderId',c.RoleId as 'RoleId', c.RoleName as 'RoleName',   c.MenuId,case when (@AppmoduleId = 4 and c.MenuName = 'Today''s Appointments') then 'Home' else c.MenuName end as MenuName,c.MenuPage,cast(c.MenuIcon as varchar) as MenuIcon,c.SubMenuId,c.SubMenuName,c.SubMenuPage,cast(c.SubMenuIcon as varchar) as SubMenuIcon   ,af.[AppFeatureId], af.[FeatureSectionName], af.[FeatureName], af.[FeatureCode], af.[IsSystemFeature]   ,cast((case puf.[IsCreate] when 0 then 0 else (case when af.[IsCreate]=1 then 1 when af.[FeatureCode] is not null then 0 else null end) end) as bit) as 'IsCreate'   ,cast((case puf.[IsRead] when 0 then 0 else (case when af.[IsRead]=1 then 1 when af.[FeatureCode] is not null then 0 else null end) end) as bit) as 'IsRead'   ,cast((case puf.[IsUpdate] when 0 then 0 else (case when af.[IsUpdate]=1 then 1 when af.[FeatureCode] is not null then 0 else null end) end) as bit) as 'IsUpdate'   ,cast((case puf.[IsDelete] when 0 then 0 else (case when af.[IsDelete]=1 then 1 when af.[FeatureCode] is not null then 0 else null end) end) as bit) as 'IsDelete'   from (   select   min(r.[AppModuleRoleId]) 'RoleId',min(r.[AppModuleRoleName]) as 'RoleName',min(mn.[AppModuleRoleMenuId]) as 'MenuId',mn.[AppModuleRoleMenuName] as 'MenuName'   ,mn.[AppModuleRoleMenuPage] as 'MenuPage',min(mn.[AppModuleRoleMenuIconImage]) as 'MenuIcon'   ,min(smn.[AppModuleRoleMenuSubmenuId]) as 'SubMenuId',smn.[AppModuleRoleMenuSubmenuName] as 'SubMenuName'   ,smn.[AppModuleRoleMenuSubmenuPage] as 'SubMenuPage',min(smn.[AppModuleRoleMenuSubmenuIconImage]) as 'SubMenuIcon'   from [auth].[AppModuleRoleMenus] mn   inner join [auth].[AppModuleRoles] r on mn.[AppModuleRoleId] = r.[AppModuleRoleId]   inner join [auth].[UserGroupModuleRoles] ugmr on ugmr.[AppModuleRoleId]=r.[AppModuleRoleId]   inner join [auth].[UserProfileGroups] ugrps on ugrps.[UserGroupId] = ugmr.[UserGroupId]     left join [auth].[AppModuleRoleMenuSubmenus] smn on smn.[AppModuleRoleMenuId] = mn.[AppModuleRoleMenuId]   where ugrps.[UserProfileId] = @UserProfileId and r.[AppModuleId] = @AppmoduleId and r.[IsActive]=1 and ugmr.[IsActive]=1 and ugrps.[IsActive]=1 and mn.[IsActive]=1 and (smn.[IsActive]=1 or smn.[IsActive] is null)   group by mn.[AppModuleRoleMenuName], mn.[AppModuleRoleMenuPage], smn.[AppModuleRoleMenuSubmenuName], smn.[AppModuleRoleMenuSubmenuPage]   ) c     left outer join [auth].[AppModuleRoleMenuSubMenuFeatures] pfmap on pfmap.[AppModuleRoleMenuId]=c.MenuId and (pfmap.[AppModuleRoleMenuSubMenuId]=c.SubMenuId or c.SubMenuId is null)   left outer join [auth].[ApplicationFeatures] af on af.[FeatureCode] = pfmap.[AppFeatureCode]   left outer join [auth].[ProviderUserFeatures] puf on puf.[AppFeatureCode]=af.[FeatureCode] and puf.[UserProfileId]=@UserProfileId and puf.[ProviderID]=@ProviderId  where not exists (select * from [auth].[ProviderFeatures] pf where pf.[AppFeatureCode]=af.[FeatureCode] and pf.[ProviderId]=@ProviderId and pf.[IsActive]=1)  )a where (a.IsCreate <> 0 or a.IsRead <> 0 or a.IsUpdate <> 0) or a.MenuName = 'Today''s Appointments' or a.MenuName = 'Home' or a.SubMenuName = 'Engagement' or a.MenuName = 'Documents Library' or a.MenuName = 'Provider Network'  ORDER BY  (CASE WHEN a.MenuName = 'Home' THEN 0 ELSE 1 END)  end  
    -- EXEC bireports.sp_rpt_client_CCA_Utilization_Orders_HealthPlan NULL,NULL,'D' -- Yesterday  -- EXEC bireports.sp_rpt_client_CCA_Utilization_Orders_HealthPlan NULL,NULL,'M' -- Previous Month  -- EXEC bireports.sp_rpt_client_CCA_Utilization_Orders_HealthPlan NULL,NULL,'MTD' -- Month To Date  -- EXEC bireports.sp_rpt_client_CCA_Utilization_Orders_HealthPlan NULL,NULL,'YTD' -- Year To Date until current day  -- EXEC bireports.sp_rpt_client_CCA_Utilization_Orders_HealthPlan '04/20/2020','06/15/2020','X' -- Year To Date including current date      CREATE proc [bireports].[sp_rpt_client_CCA_Utilization_Orders_HealthPlan] (@Start_Date date, @End_Date date, @DateRange char(5))  as     Declare @StartDate date;  Declare @EndDate date;                -- Custom Date Range    if @DateRange='X'    begin       set @StartDate =  @Start_Date                set @EndDate =  @End_Date             end          -- Returns previous day     if @DateRange='D'    begin     set @StartDate = DATEADD(DAY,-1,CONVERT(DATE,CAST(GETDATE() AT TIME ZONE 'UTC' AT TIME ZONE 'Eastern Standard Time' AS DATE)))                 set @EndDate =   DATEADD(DAY,-1,CONVERT(DATE,CAST(GETDATE() AT TIME ZONE 'UTC' AT TIME ZONE 'Eastern Standard Time' AS DATE)))              end      -- Returns first and last day of previous month    if @DateRange='M'    begin     set @EndDate = dateadd(dd,-1,cast(cast(year(CAST(GETDATE() AT TIME ZONE 'UTC' AT TIME ZONE 'Eastern Standard Time' AS DATE)) as varchar(4))+'/'+cast(month(CAST(GETDATE() AT TIME ZONE 'UTC' AT TIME ZONE 'Eastern Standard Time' AS DATE)) as varchar(2))+'/1' as date))     set @StartDate = cast(cast(year(@EndDate) as varchar(4))+'/'+cast(month(@EndDate) as varchar(2))+'/1' as date);       end      -- Returns first and last day of previous week - first day of week starts with Sunday    if @DateRange='W'    begin     set @StartDate = DATEADD(wk, -1, DATEADD(DAY, 1-DATEPART(WEEKDAY, CAST(GETDATE() AT TIME ZONE 'UTC' AT TIME ZONE 'Eastern Standard Time' AS DATE)), DATEDIFF(dd, 0, CAST(GETDATE() AT TIME ZONE 'UTC' AT TIME ZONE 'Eastern Standard Time' AS DATE))))     set @EndDate = DATEADD(wk, 0, DATEADD(DAY, 0-DATEPART(WEEKDAY, CAST(GETDATE() AT TIME ZONE 'UTC' AT TIME ZONE 'Eastern Standard Time' AS DATE)), DATEDIFF(dd, 0, CAST(GETDATE() AT TIME ZONE 'UTC' AT TIME ZONE 'Eastern Standard Time' AS DATE))))    end        -- Returns first day and yesterday of the current month as start and end dates when run on any day except 1st day of any month, if run on 1st of any month gives first and last date of the previous month    -- Use this for reports that should include MTD data and runs every day in a month.    if @DateRange='MTD'    begin     set @StartDate = case when DATEPART(DAY,CONVERT(DATE,CAST(GETDATE() AT TIME ZONE 'UTC' AT TIME ZONE 'Eastern Standard Time' AS DATE))) <> 1           then DATEADD(MONTH, DATEDIFF(MONTH, 0, CAST(GETDATE() AT TIME ZONE 'UTC' AT TIME ZONE 'Eastern Standard Time' AS DATE)), 0)               when DATEPART(DAY,CONVERT(DATE,CAST(GETDATE() AT TIME ZONE 'UTC' AT TIME ZONE 'Eastern Standard Time' AS DATE))) = 1            then DATEADD(MONTH, DATEDIFF(MONTH, 0, CAST(GETDATE() AT TIME ZONE 'UTC' AT TIME ZONE 'Eastern Standard Time' AS DATE))-1, 0)             END       set @EndDate  = case when DATEPART(DAY,CONVERT(DATE,CAST(GETDATE() AT TIME ZONE 'UTC' AT TIME ZONE 'Eastern Standard Time' AS DATE))) <> 1           then DATEADD(DAY, DATEDIFF(DAY, 0, CAST(GETDATE()-1 AT TIME ZONE 'UTC' AT TIME ZONE 'Eastern Standard Time' AS DATE)), 0)                    when DATEPART(DAY,CONVERT(DATE,CAST(GETDATE() AT TIME ZONE 'UTC' AT TIME ZONE 'Eastern Standard Time' AS DATE))) = 1           then DATEADD(MONTH, DATEDIFF(MONTH, -1, CAST(GETDATE() AT TIME ZONE 'UTC' AT TIME ZONE 'Eastern Standard Time' AS DATE))-1, -1)                   END    end        -- First day of year to current date    if @DateRange='YTD'    begin     set @StartDate = case when DATEPART(DAY,CONVERT(DATE,CAST(GETDATE() AT TIME ZONE 'UTC' AT
      --exec [bireports].[sp_HAGeneral_rpt]   CREATE PROCEDURE [bireports].[sp_HAGeneral_rpt]   AS  BEGIN     select * into #execreports_CallSummaryDetailsByDateHA    from execreports.CallSummaryDetailsByDateHA    where FORMAT(CAST(CALLDATE AS DATE),'yyyy') = FORMAT(CAST(GETDATE() AT TIME ZONE 'UTC'   AT TIME ZONE 'Eastern Standard Time' AS DATE),'yyyy')     --select * into #execreports_AppointmentSummaryDetails   --from [execreports].[AppointmentSummaryDetails]   --where FORMAT(CAST([CreatedOn] AS DATE),'yyyy') = FORMAT(CAST(GETDATE() AT TIME ZONE 'UTC'   AT TIME ZONE 'Eastern Standard Time' AS DATE),'yyyy')     select InsuranceCarrierName, 1 as MemberAppointmentId ,  AppointmentTypeName, CreateDate as CreatedOn   into #execreports_AppointmentSummaryDetails   FROM (   select p.InsuranceCarrierId, p.NHMemberID, p.AppointmentStatus, p.CreateDate, p.AppointmentDate, ic.InsuranceCarrierName,p.AppointmentTypeName   from bireports.QTesting p   inner join insurance.insurancecarriers ic on (p.insurancecarrierid = ic.insurancecarrierid)   where ( p.appointmentdate >= cast('20200101' as date) or p.createdate >= cast('20200101' as date) )   ) a   WHERE 1=1   and InsuranceCarrierName <> 'Test'    /**************************Break main view************************************/    --[execreports].[OrderSummaryDetailsHA]    SELECT DISTINCT   IP.[ItemCode],   IP.[UnitCOGS],   IP.[PairCOGS],   DS.[HealthPlanContractId],   DS.[EffectiveFrom] as DS_EffectiveFrom,   DS.[EffectiveTo] as DS_EffectiveTo,    IP.[EffectiveFrom] as IP_EffectiveFrom,   IP.[EffectiveTo] as IP_EffectiveTo,    DS.[UnitPrice],   DS.[PairPrice]   into #HA_COGS_DISP   FROM  [catalog].[ItemMasterPriceList] IP   INNER JOIN [benefits].[FittingFeeHistory] DS on DS.ItemCode=IP.ItemCode and DS.[EffectiveTo] >= '01/01/2020'   WHERE 1=1   and IP.PriceType='STANDARD'    and IP.UnitCOGS > 0.01     SELECT    BENEFIT,    ORDERSOURCE,   OrderApproveDate AS 'OrderDate',    OrderApproveDate AS 'OrderDateUtc',    CarrierID,   CarrierName,   HealthPlanID,   HealthPlan,   --InCommHealthPlan,   OrderID,   Units,   [MemberData],   [OrderAmountData],   [BenefitsData],   ORDERAMT,    BENEFITUSEDAMT,    MEMBERPAIDAMT,    (ORDERAMT-BENEFITUSEDAMT-MEMBERPAIDAMT+MemberAdjAmt) as 'MisMatch',    MemberAdjAmt,   NHMemberId,   ItemCode,   (case when Cogs = 0.01 then cast([OrderAmountData] as float) * 0.7 else cogs end) cogs, -- If COGS is 0.01 then applying 70% of Product Price --We need to check with MN @DPSR   Disp   into #execreports_OrderSummaryDetailsHA   FROM    (   -- HA ORDER    SELECT    (CASE WHEN ORDERTYPE LIKE '%OTC%' THEN 'OTC' ELSE 'HA' END ) AS 'Benefit',   (CASE WHEN oo.IPAddress IN ('198.246.190.228','12.180.201.74','4.16.180.218','96.87.172.81','12.235.147.138','12.205.150.178') THEN 'INTERNAL'ELSE 'EXTERNAL' END ) AS 'ORDERSOURCE',   --CAST(OT.CreateDate AT TIME ZONE 'UTC'   AT TIME ZONE 'Eastern Standard Time' AS DATE) as 'OrderApproveDate',   op.PODate as 'OrderApproveDate',   JSON_VALUE(oo.MemberData,'$.insCarrierId') CarrierID,   ic.InsuranceCarrierName as 'CarrierName',   JSON_VALUE(oo.MemberData,'$.insPlanId') HealthPlanID,   IPC.HealthPlanName as 'HealthPlan',    --otc.PlanName as 'InCommHealthPlan',    oo.[OrderID] as 'OrderID',   oi.Quantity as 'Units',   oo.Status,[MemberData],   [OrderAmountData],    [BenefitsData],   oo.CreateDate,   oo.CreateUser,   '--' as '-'   ,(CASE WHEN ORDERTYPE LIKE '%OTC%' THEN    (CASE WHEN CAST(JSON_VALUE([OrderAmountData],'$.price') AS NVARCHAR(10)) IS NULL THEN 0       ELSE CAST(JSON_VALUE([OrderAmountData],'$.price') AS DECIMAL)      END)   ELSE   (CASE WHEN CAST(JSON_VALUE([OrderAmountData],'$.productPrice') AS NVARCHAR(10)) IS NULL THEN 0       ELSE CAST(JSON_VALUE([OrderAmountData],'$.productPrice') AS DECIMAL)      END)   END) AS 'OrderAmt'   ,(CASE WHEN ORDERTYPE LIKE '%OTC%' THEN    (CASE WHEN CAST(JSON_VALUE([OrderAmountData],'$.amountCovered') AS NVARCHAR(10)) IS NULL THEN 0       ELSE CAST(JSON_VALUE([OrderAmountData],'$.amountCovered'
  -- EXEC bireports.sp_rpt_mitel_queue_stats_HA_Today NULL,NULL,'P214','H' -- Today  -- EXEC bireports.sp_rpt_mitel_queue_stats_HA_Today NULL,NULL,'P214','D' -- Yesterday  -- EXEC bireports.sp_rpt_mitel_queue_stats_HA_Today NULL,NULL,'P214','W' -- Last Week  -- EXEC bireports.sp_rpt_mitel_queue_stats_HA_Today NULL,NULL,'P180','MTD' -- Previous Month  -- EXEC bireports.sp_rpt_mitel_queue_stats_HA_Today NULL,NULL,'P279','MTD' -- Previous Month  -- EXEC bireports.sp_rpt_mitel_queue_stats_HA_Today '02/01/2020','02/29/2020','P180','MTD' -- Month To Date      -- EXEC bireports.sp_rpt_mitel_queue_stats_HA_Today '01/01/2020','01/31/2020','P180','X' -- Jan 2020  -- EXEC bireports.sp_rpt_mitel_queue_stats_HA_Today '02/01/2020','02/29/2020','P180','X' -- Feb 2020  -- EXEC bireports.sp_rpt_mitel_queue_stats_HA_Today '03/01/2020','03/09/2020','P180','X' -- Mar 2020    CREATE proc [bireports].[sp_rpt_mitel_queue_stats_HA_Today] (@Start_Date date, @End_Date date, @QueueID varchar(200), @DateRange char(5))  as     Declare @StartDate date;  Declare @EndDate date;                -- Custom Date Range    if @DateRange='X'    begin       set @StartDate =  @Start_Date                set @EndDate =  @End_Date             end          -- Returns previous day     if @DateRange='D'    begin     set @StartDate = DATEADD(DAY,-1,CONVERT(DATE,CAST(GETDATE() AT TIME ZONE 'UTC' AT TIME ZONE 'Eastern Standard Time' AS DATE)))                 set @EndDate =   DATEADD(DAY,-1,CONVERT(DATE,CAST(GETDATE() AT TIME ZONE 'UTC' AT TIME ZONE 'Eastern Standard Time' AS DATE)))              end          -- Returns previous day     if @DateRange='H'    begin     set @StartDate = CONVERT(DATE,CAST(GETDATE() AT TIME ZONE 'UTC' AT TIME ZONE 'Eastern Standard Time' AS DATE))                set @EndDate =   CONVERT(DATE,CAST(GETDATE() AT TIME ZONE 'UTC' AT TIME ZONE 'Eastern Standard Time' AS DATE))             end      -- Returns first and last day of previous month    if @DateRange='M'    begin     set @EndDate = dateadd(dd,-1,cast(cast(year(CAST(GETDATE() AT TIME ZONE 'UTC' AT TIME ZONE 'Eastern Standard Time' AS DATE)) as varchar(4))+'/'+cast(month(CAST(GETDATE() AT TIME ZONE 'UTC' AT TIME ZONE 'Eastern Standard Time' AS DATE)) as varchar(2))+'/1' as date))     set @StartDate = cast(cast(year(@EndDate) as varchar(4))+'/'+cast(month(@EndDate) as varchar(2))+'/1' as date);       end      -- Returns first and last day of previous week - first day of week starts with Sunday    if @DateRange='W'    begin     set @StartDate = DATEADD(wk, -1, DATEADD(DAY, 1-DATEPART(WEEKDAY, CAST(GETDATE() AT TIME ZONE 'UTC' AT TIME ZONE 'Eastern Standard Time' AS DATE)), DATEDIFF(dd, 0, CAST(GETDATE() AT TIME ZONE 'UTC' AT TIME ZONE 'Eastern Standard Time' AS DATE))))     set @EndDate = DATEADD(wk, 0, DATEADD(DAY, 0-DATEPART(WEEKDAY, CAST(GETDATE() AT TIME ZONE 'UTC' AT TIME ZONE 'Eastern Standard Time' AS DATE)), DATEDIFF(dd, 0, CAST(GETDATE() AT TIME ZONE 'UTC' AT TIME ZONE 'Eastern Standard Time' AS DATE))))    end        -- Returns first day and yesterday of the current month as start and end dates when run on any day except 1st day of any month, if run on 1st of any month gives first and last date of the previous month    -- Use this for reports that should include MTD data and runs every day in a month.    if @DateRange='MTD'    begin     set @StartDate = case when DATEPART(DAY,CONVERT(DATE,CAST(GETDATE() AT TIME ZONE 'UTC' AT TIME ZONE 'Eastern Standard Time' AS DATE))) <> 1           then DATEADD(MONTH, DATEDIFF(MONTH, 0, CAST(GETDATE() AT TIME ZONE 'UTC' AT TIME ZONE 'Eastern Standard Time' AS DATE)), 0)               when DATEPART(DAY,CONVERT(DATE,CAST(GETDATE() AT TIME ZONE 'UTC' AT TIME ZONE 'Eastern Standard Time' AS DATE))) = 1            then DATEADD(MONTH, DATEDIFF(MONTH, 0, CAST(GETDATE() AT TIME ZONE 'UTC' AT TIME ZONE 'Eastern Standard Time' AS DATE))-1, 0)             END       set @EndDate  = case when DATEPART(DAY,CONVERT(DATE,CAST(GETDATE() AT TIME ZONE 'UTC' AT TIME ZONE 
  -- exec [bireports].[Order_Detail_Report_before_2020]    CREATE PROC [bireports].[Order_Detail_Report_before_2020_bkp_before_POUpdate]  AS      DROP TABLE IF EXISTS #FittingFee_CTE  DROP TABLE IF EXISTS #MemberPrice_CTE  DROP TABLE IF EXISTS #TechnologyLevel_CTE  DROP TABLE IF EXISTS #COGS_CTE    SELECT DISTINCT HealthPlanContractID, ItemCode, EffectiveFrom, EffectiveTo, UnitPrice, PairPrice  INTO #FittingFee_CTE  FROM benefits.FittingFeeHistory      SELECT DISTINCT HealthPlanContractID, ItemCode, EffectiveFrom, EffectiveTo, UnitPrice, PairPrice  INTO #MemberPrice_CTE  FROM benefits.MemberPriceHistory      SELECT DISTINCT HealthPlanContractID, ItemCode, EffectiveFrom, EffectiveTo, UnitPrice  INTO #TechnologyLevel_CTE  FROM benefits.TechnologyLevelHistory      SELECT DISTINCT ItemCode,pricetype,effectivefrom,effectiveto,unitcogs,paircogs  INTO #COGS_CTE   FROM catalog.ItemMasterPriceList   WHERE IsActive=1    -- Orders with only PO  SELECT   o.NHMemberId  ,o.OrderID [OrderNumber]  ,CAST(o.DateOrderReceived AS DATE) [DateOrderReceived]  ,CASE WHEN DATEPART(HOUR,o.DateOrderInitiated)=0 AND DATEPART(MINUTE,o.DateOrderInitiated)=0 AND DATEPART(SECOND,o.DateOrderInitiated) =0 THEN CAST(o.DateOrderInitiated AS DATE)             ELSE CAST(CAST(o.DateOrderInitiated AT TIME ZONE 'UTC' AT TIME ZONE 'Eastern Standard Time' AS DATETIME) AS DATE) END [OrderCreatedDate]  ,CASE WHEN ISNULL(o.OrderType,'')='EXCHANGE' THEN 'NEW' ELSE o.OrderType END AS [OrderType] -- EXCHANGE should be NEW  ,CASE WHEN ISNULL(o.OrderType,'') IN ('EXCHANGE','LSandD') THEN o.RefOrderId ELSE NULL END AS [ReferenceOrder] -- Only for EXCHANGE & LSandD orders if available  ,o.Status  ,c.InsuranceCarrierName  ,CAST(JSON_VALUE(o.MemberData,'$.insCarrierId') AS INT) AS InsuranceCarrierID  ,hp.HealthPlanName InsuranceHealthPlanName  ,CAST(JSON_VALUE(o.MemberData,'$.insPlanId') AS INT) AS InsuranceHealthPlanID  -- From Orders JSON  --,CASE WHEN JSON_VALUE(o.MemberData, '$.insurance.carrierName') = 'None' OR JSON_VALUE(o.MemberData, '$.insurance.carrierName') = '' THEN JSON_VALUE(o.MemberData, '$.insurance.programeName')  --      ELSE JSON_VALUE(o.MemberData, '$.insurance.carrierName') END AS 'CarrierName_JSON'  --,JSON_VALUE(o.MemberData, '$.insurance.planName') AS 'PlanName_JSON'  --  ,JSON_VALUE(o.MemberData,'$.firstName') AS [MemberFirstName]  ,JSON_VALUE(o.MemberData,'$.lastName') AS [MemberLastName]    ,JSON_VALUE(o.ProviderData,'$.providerId') AS [ProviderID]  --,JSON_VALUE(o.ProviderData,'$.address.locationId') AS [LocationID]    ,pp.ProviderName AS [ProviderLegalName]  ,ISNULL(CASE WHEN pp.DBA='' THEN NULL ELSE pp.DBA END,l.BusinessName) AS [ProviderDBA] -- Take location name if provider DBA is not available  -- From Orders JSON  --,JSON_VALUE(o.ProviderData,'$.providerLeagalBusinessName') AS [ProviderLegalName]  --,JSON_VALUE(o.ProviderData,'$.dba') AS [ProviderDBA]    ,JSON_VALUE(o.ProviderData,'$.dispenser') AS [ProviderDispenser]    -- If provider address (GN Hearing Care Corporation) not available use location address   ,ISNULL(CASE WHEN (JSON_VALUE(pp.AdditionalData,'$.billingAddress.address1'))='' THEN NULL ELSE JSON_VALUE(pp.AdditionalData,'$.billingAddress.address1') END,l.Address1)   +' '+   ISNULL(CASE WHEN (JSON_VALUE(pp.AdditionalData,'$.billingAddress.address2'))='' THEN NULL ELSE JSON_VALUE(pp.AdditionalData,'$.billingAddress.address2') END,l.Address2)  AS [ProviderAddress]  ,ISNULL(CASE WHEN JSON_VALUE(pp.AdditionalData,'$.billingAddress.city')='' THEN NULL ELSE JSON_VALUE(pp.AdditionalData,'$.billingAddress.city') END,l.City) AS [ProviderCity]  ,ISNULL(CASE WHEN JSON_VALUE(pp.AdditionalData,'$.billingAddress.state')='' THEN NULL ELSE JSON_VALUE(pp.AdditionalData,'$.billingAddress.state') END,l.State) AS [ProviderState]  ,ISNULL(CASE WHEN JSON_VALUE(pp.AdditionalData,'$.billingAddress.zip') IN ('','0') THEN NULL ELSE JSON_VALUE(pp.AdditionalData,'$.billingAddress.zip') END,l.Zip) AS [ProviderZip]  -- From Orders JSON  --,JSON_VALUE(o.ProviderData,
-- EXEC bireports.sp_rpt_managed_care_units_sold_monthly NULL,NULL,'D'  -- EXEC bireports.sp_rpt_managed_care_units_sold_monthly NULL,NULL,'M'    -- EXEC bireports.sp_rpt_managed_care_units_sold_monthly '08/01/2019','08/31/2019','X'    -- EXEC bireports.sp_rpt_managed_care_units_sold_monthly NULL,NULL,'Y'   -- Do not run YTD unless really required    CREATE proc [bireports].[sp_rpt_managed_care_units_sold_monthly] (@Start_Date date, @End_Date date,@DateRange char(1))  as         Declare @StartDate date;  Declare @EndDate date;        -- Adhoc date range     if @DateRange='X'    begin     set @StartDate = @Start_Date                 set @EndDate =  @End_Date             end          -- Returns previous day     if @DateRange='D'    begin     set @StartDate = DATEADD(DAY,-1,CONVERT(DATE,CAST(GETDATE() AT TIME ZONE 'UTC' AT TIME ZONE 'Eastern Standard Time' AS DATE)))                 set @EndDate =   DATEADD(DAY,-1,CONVERT(DATE,CAST(GETDATE() AT TIME ZONE 'UTC' AT TIME ZONE 'Eastern Standard Time' AS DATE)))              end        -- Returns first day and yesterday of the current month as start and end dates when run on any day except 1st day of any month, if run on 1st of any month gives first and last date of the previous month    -- Use this for reports that should include MTD data and runs every day in a month.    if @DateRange='M'    begin     set @StartDate = case when DATEPART(DAY,CONVERT(DATE,CAST(GETDATE() AT TIME ZONE 'UTC' AT TIME ZONE 'Eastern Standard Time' AS DATE))) <> 1           then DATEADD(MONTH, DATEDIFF(MONTH, 0, CAST(GETDATE() AT TIME ZONE 'UTC' AT TIME ZONE 'Eastern Standard Time' AS DATE)), 0)               when DATEPART(DAY,CONVERT(DATE,CAST(GETDATE() AT TIME ZONE 'UTC' AT TIME ZONE 'Eastern Standard Time' AS DATE))) = 1            then DATEADD(MONTH, DATEDIFF(MONTH, 0, CAST(GETDATE() AT TIME ZONE 'UTC' AT TIME ZONE 'Eastern Standard Time' AS DATE))-1, 0)             END       set @EndDate  = case when DATEPART(DAY,CONVERT(DATE,CAST(GETDATE() AT TIME ZONE 'UTC' AT TIME ZONE 'Eastern Standard Time' AS DATE))) <> 1           then DATEADD(DAY, DATEDIFF(DAY, 0, CAST(GETDATE()-1 AT TIME ZONE 'UTC' AT TIME ZONE 'Eastern Standard Time' AS DATE)), 0)                    when DATEPART(DAY,CONVERT(DATE,CAST(GETDATE() AT TIME ZONE 'UTC' AT TIME ZONE 'Eastern Standard Time' AS DATE))) = 1           then DATEADD(MONTH, DATEDIFF(MONTH, -1, CAST(GETDATE() AT TIME ZONE 'UTC' AT TIME ZONE 'Eastern Standard Time' AS DATE))-1, -1)                   END    end          -- If 1st of Jan. any year returns [first day of year] & [last day of previous month] as start & end dates    -- Any other day except 1st Jan returns [first day of previous year] & [last day of previous year] as start & end dates    if @DateRange='Y'    begin     set @StartDate = case when DATEPART(DAY,CONVERT(DATE,CAST(GETDATE() AT TIME ZONE 'UTC' AT TIME ZONE 'Eastern Standard Time' AS DATE))) != 1 AND  DATEPART(MONTH,CONVERT(DATE,CAST(GETDATE() AT TIME ZONE 'UTC' AT TIME ZONE 'Eastern Standard Time' AS DATE))) != 1           then  cast(cast(year(CAST(GETDATE() AT TIME ZONE 'UTC' AT TIME ZONE 'Eastern Standard Time' AS DATE)) as varchar(4))+'/1'+'/1' as date)              when DATEPART(DAY,CONVERT(DATE,CAST(GETDATE() AT TIME ZONE 'UTC' AT TIME ZONE 'Eastern Standard Time' AS DATE))) = 1 AND  DATEPART(MONTH,CONVERT(DATE,CAST(GETDATE() AT TIME ZONE 'UTC' AT TIME ZONE 'Eastern Standard Time' AS DATE))) = 1           then  cast(cast(year(CAST(GETDATE() AT TIME ZONE 'UTC' AT TIME ZONE 'Eastern Standard Time' AS DATE))-1 as varchar(4))+'/1'+'/1' as date)           END       set @EndDate  = case when DATEPART(DAY,CONVERT(DATE,CAST(GETDATE() AT TIME ZONE 'UTC' AT TIME ZONE 'Eastern Standard Time' AS DATE))) != 1 AND  DATEPART(MONTH,CONVERT(DATE,CAST(GETDATE() AT TIME ZONE 'UTC' AT TIME ZONE 'Eastern Standard Time' AS DATE))) != 1           then dateadd(dd,-1,cast(cast(year(CAST(GETDATE() AT TIME ZONE 'UTC' AT TIME ZONE 'Eastern Standard Time' AS DATE)) as varchar(4))
  -- EXEC bireports.sp_rpt_DHE_Dashboard -- Without parameters      -- EXEC bireports.sp_rpt_DHE_Dashboard NULL,NULL,'D' -- Yesterday  -- EXEC bireports.sp_rpt_DHE_Dashboard NULL,NULL,'MTD' -- Month To Date  -- EXEC bireports.sp_rpt_DHE_Dashboard NULL,NULL,'YTD' -- Year To Date until today  -- EXEC bireports.sp_rpt_DHE_Dashboard '01/01/2020','08/01/2020','X' -- Year To Date including today      CREATE PROC [bireports].[sp_rpt_DHE_Dashboard] --(@Start_Date DATE, @End_Date DATE, @DateRange CHAR(5))  AS     -- SET DATEFIRST 1;  -- Week starts with Monday instead of Sunday -- No WTD fields in this report    Declare @StartDate date;  Declare @EndDate date;    set @StartDate = case when DATEPART(DAY,CONVERT(DATE,CAST(GETDATE() AT TIME ZONE 'UTC' AT TIME ZONE 'Eastern Standard Time' AS DATE))) = 1                                AND DATEPART(MONTH,CONVERT(DATE,CAST(GETDATE() AT TIME ZONE 'UTC' AT TIME ZONE 'Eastern Standard Time' AS DATE))) = 1            then CAST('01/01/' + CAST(DATEPART(YEAR,CONVERT(DATE,CAST(GETDATE()-1 AT TIME ZONE 'UTC' AT TIME ZONE 'Eastern Standard Time' AS DATE))) AS VARCHAR) AS DATE)               else CAST('01/01/' + CAST(DATEPART(YEAR,CONVERT(DATE,CAST(GETDATE() AT TIME ZONE 'UTC' AT TIME ZONE 'Eastern Standard Time' AS DATE))) AS VARCHAR) AS DATE)              END    set @EndDate  = case when DATEPART(DAY,CONVERT(DATE,CAST(GETDATE() AT TIME ZONE 'UTC' AT TIME ZONE 'Eastern Standard Time' AS DATE))) = 1                     AND DATEPART(MONTH,CONVERT(DATE,CAST(GETDATE() AT TIME ZONE 'UTC' AT TIME ZONE 'Eastern Standard Time' AS DATE))) = 1        then CAST('12/31/' + CAST(DATEPART(YEAR,CONVERT(DATE,CAST(GETDATE()-1 AT TIME ZONE 'UTC' AT TIME ZONE 'Eastern Standard Time' AS DATE))) AS VARCHAR) AS DATE)           else CONVERT(DATE,CAST(GETDATE() AT TIME ZONE 'UTC' AT TIME ZONE 'Eastern Standard Time' AS DATE))          END        --set @StartDate='01/01/2020';  --set @EndDate='11/30/2020';         /*           -- Custom Date Range    if @DateRange='X'    begin       set @StartDate =  @Start_Date                set @EndDate =  @End_Date             end          -- Returns previous day     if @DateRange='D'    begin     set @StartDate = DATEADD(DAY,-1,CONVERT(DATE,CAST(GETDATE() AT TIME ZONE 'UTC' AT TIME ZONE 'Eastern Standard Time' AS DATE)))                 set @EndDate =   DATEADD(DAY,-1,CONVERT(DATE,CAST(GETDATE() AT TIME ZONE 'UTC' AT TIME ZONE 'Eastern Standard Time' AS DATE)))              end      -- Returns first and last day of previous month    if @DateRange='M'    begin     set @EndDate = dateadd(dd,-1,cast(cast(year(CAST(GETDATE() AT TIME ZONE 'UTC' AT TIME ZONE 'Eastern Standard Time' AS DATE)) as varchar(4))+'/'+cast(month(CAST(GETDATE() AT TIME ZONE 'UTC' AT TIME ZONE 'Eastern Standard Time' AS DATE)) as varchar(2))+'/1' as date))     set @StartDate = cast(cast(year(@EndDate) as varchar(4))+'/'+cast(month(@EndDate) as varchar(2))+'/1' as date);       end      -- Returns first and last day of previous week - first day of week starts with Sunday    if @DateRange='W'    begin     set @StartDate = DATEADD(wk, -1, DATEADD(DAY, 1-DATEPART(WEEKDAY, CAST(GETDATE() AT TIME ZONE 'UTC' AT TIME ZONE 'Eastern Standard Time' AS DATE)), DATEDIFF(dd, 0, CAST(GETDATE() AT TIME ZONE 'UTC' AT TIME ZONE 'Eastern Standard Time' AS DATE))))     set @EndDate = DATEADD(wk, 0, DATEADD(DAY, 0-DATEPART(WEEKDAY, CAST(GETDATE() AT TIME ZONE 'UTC' AT TIME ZONE 'Eastern Standard Time' AS DATE)), DATEDIFF(dd, 0, CAST(GETDATE() AT TIME ZONE 'UTC' AT TIME ZONE 'Eastern Standard Time' AS DATE))))    end        -- Returns first day and yesterday of the current month as start and end dates when run on any day except 1st day of any month, if run on 1st of any month gives first and last date of the previous month    -- Use this for reports that should include MTD data and runs every day in a month.    if @DateRange='MTD'    begin     set @StartDate = case when DATEPART(DAY,CONVERT(DATE,CAST(GETDATE() AT TIME ZONE 'UTC' AT TIME ZONE 
      -- EXEC bireports.sp_rpt_FreedomHealth_Dashboard_Orders NULL,NULL,'D' -- Yesterday  -- EXEC bireports.sp_rpt_FreedomHealth_Dashboard_Orders NULL,NULL,'MTD' -- Month To Date  -- EXEC bireports.sp_rpt_FreedomHealth_Dashboard_Orders NULL,NULL,'YTD' -- Year To Date until today  -- EXEC bireports.sp_rpt_FreedomHealth_Dashboard_Orders '01/01/2020','08/01/2020','X' -- Year To Date including today      CREATE PROC [bireports].[sp_rpt_FreedomHealth_Dashboard_Orders] (@Start_Date DATE, @End_Date DATE, @DateRange CHAR(5))  AS     -- SET DATEFIRST 1;  -- Week starts with Monday instead of Sunday -- No WTD fields in this report    Declare @StartDate date;  Declare @EndDate date;                -- Custom Date Range    if @DateRange='X'    begin       set @StartDate =  @Start_Date                set @EndDate =  @End_Date             end          -- Returns previous day     if @DateRange='D'    begin     set @StartDate = DATEADD(DAY,-1,CONVERT(DATE,CAST(GETDATE() AT TIME ZONE 'UTC' AT TIME ZONE 'Eastern Standard Time' AS DATE)))                 set @EndDate =   DATEADD(DAY,-1,CONVERT(DATE,CAST(GETDATE() AT TIME ZONE 'UTC' AT TIME ZONE 'Eastern Standard Time' AS DATE)))              end      -- Returns first and last day of previous month    if @DateRange='M'    begin     set @EndDate = dateadd(dd,-1,cast(cast(year(CAST(GETDATE() AT TIME ZONE 'UTC' AT TIME ZONE 'Eastern Standard Time' AS DATE)) as varchar(4))+'/'+cast(month(CAST(GETDATE() AT TIME ZONE 'UTC' AT TIME ZONE 'Eastern Standard Time' AS DATE)) as varchar(2))+'/1' as date))     set @StartDate = cast(cast(year(@EndDate) as varchar(4))+'/'+cast(month(@EndDate) as varchar(2))+'/1' as date);       end      -- Returns first and last day of previous week - first day of week starts with Sunday    if @DateRange='W'    begin     set @StartDate = DATEADD(wk, -1, DATEADD(DAY, 1-DATEPART(WEEKDAY, CAST(GETDATE() AT TIME ZONE 'UTC' AT TIME ZONE 'Eastern Standard Time' AS DATE)), DATEDIFF(dd, 0, CAST(GETDATE() AT TIME ZONE 'UTC' AT TIME ZONE 'Eastern Standard Time' AS DATE))))     set @EndDate = DATEADD(wk, 0, DATEADD(DAY, 0-DATEPART(WEEKDAY, CAST(GETDATE() AT TIME ZONE 'UTC' AT TIME ZONE 'Eastern Standard Time' AS DATE)), DATEDIFF(dd, 0, CAST(GETDATE() AT TIME ZONE 'UTC' AT TIME ZONE 'Eastern Standard Time' AS DATE))))    end        -- Returns first day and yesterday of the current month as start and end dates when run on any day except 1st day of any month, if run on 1st of any month gives first and last date of the previous month    -- Use this for reports that should include MTD data and runs every day in a month.    if @DateRange='MTD'    begin     set @StartDate = case when DATEPART(DAY,CONVERT(DATE,CAST(GETDATE() AT TIME ZONE 'UTC' AT TIME ZONE 'Eastern Standard Time' AS DATE))) <> 1           then DATEADD(MONTH, DATEDIFF(MONTH, 0, CAST(GETDATE() AT TIME ZONE 'UTC' AT TIME ZONE 'Eastern Standard Time' AS DATE)), 0)               when DATEPART(DAY,CONVERT(DATE,CAST(GETDATE() AT TIME ZONE 'UTC' AT TIME ZONE 'Eastern Standard Time' AS DATE))) = 1            then DATEADD(MONTH, DATEDIFF(MONTH, 0, CAST(GETDATE() AT TIME ZONE 'UTC' AT TIME ZONE 'Eastern Standard Time' AS DATE))-1, 0)             END       set @EndDate  = case when DATEPART(DAY,CONVERT(DATE,CAST(GETDATE() AT TIME ZONE 'UTC' AT TIME ZONE 'Eastern Standard Time' AS DATE))) <> 1           then DATEADD(DAY, DATEDIFF(DAY, 0, CAST(GETDATE()-1 AT TIME ZONE 'UTC' AT TIME ZONE 'Eastern Standard Time' AS DATE)), 0)                    when DATEPART(DAY,CONVERT(DATE,CAST(GETDATE() AT TIME ZONE 'UTC' AT TIME ZONE 'Eastern Standard Time' AS DATE))) = 1           then DATEADD(MONTH, DATEDIFF(MONTH, -1, CAST(GETDATE() AT TIME ZONE 'UTC' AT TIME ZONE 'Eastern Standard Time' AS DATE))-1, -1)                   END    end        -- First day of year to current date    if @DateRange='YTD'    begin     set @StartDate = case when DATEPART(DAY,CONVERT(DATE,CAST(GETDATE() AT TIME ZONE 'UTC' AT TIME ZONE 'Eastern Standard Time' AS DATE))) = 1          
      -- EXEC bireports.sp_rpt_FreedomHealth_Dashboard_Shipments NULL,NULL,'D' -- Yesterday  -- EXEC bireports.sp_rpt_FreedomHealth_Dashboard_Shipments NULL,NULL,'MTD' -- Month To Date  -- EXEC bireports.sp_rpt_FreedomHealth_Dashboard_Shipments NULL,NULL,'YTD' -- Year To Date until today  -- EXEC bireports.sp_rpt_FreedomHealth_Dashboard_Shipments '01/01/2020','08/01/2020','X' -- Year To Date including today      CREATE PROC [bireports].[sp_rpt_FreedomHealth_Dashboard_Shipments] (@Start_Date DATE, @End_Date DATE, @DateRange CHAR(5))  AS     -- SET DATEFIRST 1;  -- Week starts with Monday instead of Sunday -- No WTD fields in this report    Declare @StartDate date;  Declare @EndDate date;                -- Custom Date Range    if @DateRange='X'    begin       set @StartDate =  @Start_Date                set @EndDate =  @End_Date             end          -- Returns previous day     if @DateRange='D'    begin     set @StartDate = DATEADD(DAY,-1,CONVERT(DATE,CAST(GETDATE() AT TIME ZONE 'UTC' AT TIME ZONE 'Eastern Standard Time' AS DATE)))                 set @EndDate =   DATEADD(DAY,-1,CONVERT(DATE,CAST(GETDATE() AT TIME ZONE 'UTC' AT TIME ZONE 'Eastern Standard Time' AS DATE)))              end      -- Returns first and last day of previous month    if @DateRange='M'    begin     set @EndDate = dateadd(dd,-1,cast(cast(year(CAST(GETDATE() AT TIME ZONE 'UTC' AT TIME ZONE 'Eastern Standard Time' AS DATE)) as varchar(4))+'/'+cast(month(CAST(GETDATE() AT TIME ZONE 'UTC' AT TIME ZONE 'Eastern Standard Time' AS DATE)) as varchar(2))+'/1' as date))     set @StartDate = cast(cast(year(@EndDate) as varchar(4))+'/'+cast(month(@EndDate) as varchar(2))+'/1' as date);       end      -- Returns first and last day of previous week - first day of week starts with Sunday    if @DateRange='W'    begin     set @StartDate = DATEADD(wk, -1, DATEADD(DAY, 1-DATEPART(WEEKDAY, CAST(GETDATE() AT TIME ZONE 'UTC' AT TIME ZONE 'Eastern Standard Time' AS DATE)), DATEDIFF(dd, 0, CAST(GETDATE() AT TIME ZONE 'UTC' AT TIME ZONE 'Eastern Standard Time' AS DATE))))     set @EndDate = DATEADD(wk, 0, DATEADD(DAY, 0-DATEPART(WEEKDAY, CAST(GETDATE() AT TIME ZONE 'UTC' AT TIME ZONE 'Eastern Standard Time' AS DATE)), DATEDIFF(dd, 0, CAST(GETDATE() AT TIME ZONE 'UTC' AT TIME ZONE 'Eastern Standard Time' AS DATE))))    end        -- Returns first day and yesterday of the current month as start and end dates when run on any day except 1st day of any month, if run on 1st of any month gives first and last date of the previous month    -- Use this for reports that should include MTD data and runs every day in a month.    if @DateRange='MTD'    begin     set @StartDate = case when DATEPART(DAY,CONVERT(DATE,CAST(GETDATE() AT TIME ZONE 'UTC' AT TIME ZONE 'Eastern Standard Time' AS DATE))) <> 1           then DATEADD(MONTH, DATEDIFF(MONTH, 0, CAST(GETDATE() AT TIME ZONE 'UTC' AT TIME ZONE 'Eastern Standard Time' AS DATE)), 0)               when DATEPART(DAY,CONVERT(DATE,CAST(GETDATE() AT TIME ZONE 'UTC' AT TIME ZONE 'Eastern Standard Time' AS DATE))) = 1            then DATEADD(MONTH, DATEDIFF(MONTH, 0, CAST(GETDATE() AT TIME ZONE 'UTC' AT TIME ZONE 'Eastern Standard Time' AS DATE))-1, 0)             END       set @EndDate  = case when DATEPART(DAY,CONVERT(DATE,CAST(GETDATE() AT TIME ZONE 'UTC' AT TIME ZONE 'Eastern Standard Time' AS DATE))) <> 1           then DATEADD(DAY, DATEDIFF(DAY, 0, CAST(GETDATE()-1 AT TIME ZONE 'UTC' AT TIME ZONE 'Eastern Standard Time' AS DATE)), 0)                    when DATEPART(DAY,CONVERT(DATE,CAST(GETDATE() AT TIME ZONE 'UTC' AT TIME ZONE 'Eastern Standard Time' AS DATE))) = 1           then DATEADD(MONTH, DATEDIFF(MONTH, -1, CAST(GETDATE() AT TIME ZONE 'UTC' AT TIME ZONE 'Eastern Standard Time' AS DATE))-1, -1)                   END    end        -- First day of year to current date    if @DateRange='YTD'    begin     set @StartDate = case when DATEPART(DAY,CONVERT(DATE,CAST(GETDATE() AT TIME ZONE 'UTC' AT TIME ZONE 'Eastern Standard Time' AS DATE))
    -- EXEC bireports.sp_rpt_client_CCA_Cart_Overview NULL,NULL,'D' -- Yesterday  -- EXEC bireports.sp_rpt_client_CCA_Cart_Overview NULL,NULL,'M' -- Previous Month  -- EXEC bireports.sp_rpt_client_CCA_Cart_Overview NULL,NULL,'MTD' -- Month To Date  -- EXEC bireports.sp_rpt_client_CCA_Cart_Overview NULL,NULL,'YTD' -- Year To Date until today  -- EXEC bireports.sp_rpt_client_CCA_Cart_Overview '01/01/2020','04/15/2020','X' -- Year To Date including today      CREATE proc [bireports].[sp_rpt_client_CCA_Cart_Overview_bkp_before_voucher_20200610] (@Start_Date date, @End_Date date, @DateRange char(5))  as     SET DATEFIRST 1;  -- Week starts with Monday instead of Sunday    Declare @StartDate date;  Declare @EndDate date;                -- Custom Date Range    if @DateRange='X'    begin       set @StartDate =  @Start_Date                set @EndDate =  @End_Date             end          -- Returns previous day     if @DateRange='D'    begin     set @StartDate = DATEADD(DAY,-1,CONVERT(DATE,CAST(GETDATE() AT TIME ZONE 'UTC' AT TIME ZONE 'Eastern Standard Time' AS DATE)))                 set @EndDate =   DATEADD(DAY,-1,CONVERT(DATE,CAST(GETDATE() AT TIME ZONE 'UTC' AT TIME ZONE 'Eastern Standard Time' AS DATE)))              end      -- Returns first and last day of previous month    if @DateRange='M'    begin     set @EndDate = dateadd(dd,-1,cast(cast(year(CAST(GETDATE() AT TIME ZONE 'UTC' AT TIME ZONE 'Eastern Standard Time' AS DATE)) as varchar(4))+'/'+cast(month(CAST(GETDATE() AT TIME ZONE 'UTC' AT TIME ZONE 'Eastern Standard Time' AS DATE)) as varchar(2))+'/1' as date))     set @StartDate = cast(cast(year(@EndDate) as varchar(4))+'/'+cast(month(@EndDate) as varchar(2))+'/1' as date);       end      -- Returns first and last day of previous week - first day of week starts with Sunday    if @DateRange='W'    begin     set @StartDate = DATEADD(wk, -1, DATEADD(DAY, 1-DATEPART(WEEKDAY, CAST(GETDATE() AT TIME ZONE 'UTC' AT TIME ZONE 'Eastern Standard Time' AS DATE)), DATEDIFF(dd, 0, CAST(GETDATE() AT TIME ZONE 'UTC' AT TIME ZONE 'Eastern Standard Time' AS DATE))))     set @EndDate = DATEADD(wk, 0, DATEADD(DAY, 0-DATEPART(WEEKDAY, CAST(GETDATE() AT TIME ZONE 'UTC' AT TIME ZONE 'Eastern Standard Time' AS DATE)), DATEDIFF(dd, 0, CAST(GETDATE() AT TIME ZONE 'UTC' AT TIME ZONE 'Eastern Standard Time' AS DATE))))    end        -- Returns first day and yesterday of the current month as start and end dates when run on any day except 1st day of any month, if run on 1st of any month gives first and last date of the previous month    -- Use this for reports that should include MTD data and runs every day in a month.    if @DateRange='MTD'    begin     set @StartDate = case when DATEPART(DAY,CONVERT(DATE,CAST(GETDATE() AT TIME ZONE 'UTC' AT TIME ZONE 'Eastern Standard Time' AS DATE))) <> 1           then DATEADD(MONTH, DATEDIFF(MONTH, 0, CAST(GETDATE() AT TIME ZONE 'UTC' AT TIME ZONE 'Eastern Standard Time' AS DATE)), 0)               when DATEPART(DAY,CONVERT(DATE,CAST(GETDATE() AT TIME ZONE 'UTC' AT TIME ZONE 'Eastern Standard Time' AS DATE))) = 1            then DATEADD(MONTH, DATEDIFF(MONTH, 0, CAST(GETDATE() AT TIME ZONE 'UTC' AT TIME ZONE 'Eastern Standard Time' AS DATE))-1, 0)             END       set @EndDate  = case when DATEPART(DAY,CONVERT(DATE,CAST(GETDATE() AT TIME ZONE 'UTC' AT TIME ZONE 'Eastern Standard Time' AS DATE))) <> 1           then DATEADD(DAY, DATEDIFF(DAY, 0, CAST(GETDATE()-1 AT TIME ZONE 'UTC' AT TIME ZONE 'Eastern Standard Time' AS DATE)), 0)                    when DATEPART(DAY,CONVERT(DATE,CAST(GETDATE() AT TIME ZONE 'UTC' AT TIME ZONE 'Eastern Standard Time' AS DATE))) = 1           then DATEADD(MONTH, DATEDIFF(MONTH, -1, CAST(GETDATE() AT TIME ZONE 'UTC' AT TIME ZONE 'Eastern Standard Time' AS DATE))-1, -1)                   END    end        -- First day of year to current date    if @DateRange='YTD'    begin     set @StartDate = case when DATEPART(DAY,CONVERT(DATE,CAST(GETDATE() AT TIME ZONE 'UTC' AT TIME ZONE 'Eas
-- EXEC bireports.sp_rpt_pbi_managed_care_dashboard 'D'  -- EXEC bireports.sp_rpt_pbi_managed_care_dashboard 'M'    -- EXEC bireports.sp_rpt_pbi_managed_care_dashboard 'Y'   -- Do not run YTD unless really required    CREATE proc [bireports].[sp_rpt_pbi_managed_care_dashboard] (@DateRange char(1))  as         Declare @StartDate date;  Declare @EndDate date;      /*    -- Returns previous day when run on any weekday except Monday, date goes back to last Friday if it runs on Monday    -- Use this for reports to include previous day data and runs from Monday to Friday only    if @DateRange='D'    begin     set @StartDate = case when DATEPART(WEEKDAY,CONVERT(DATE,CAST(GETDATE() AT TIME ZONE 'UTC' AT TIME ZONE 'Eastern Standard Time' AS DATE))) <> 2            then DATEADD(DAY,-1,CONVERT(DATE,CAST(GETDATE() AT TIME ZONE 'UTC' AT TIME ZONE 'Eastern Standard Time' AS DATE)))            when DATEPART(WEEKDAY,CONVERT(DATE,CAST(GETDATE() AT TIME ZONE 'UTC' AT TIME ZONE 'Eastern Standard Time' AS DATE))) = 2                        then DATEADD(DAY,-3,CONVERT(DATE,CAST(GETDATE() AT TIME ZONE 'UTC' AT TIME ZONE 'Eastern Standard Time' AS DATE)))           END     set @EndDate = case when DATEPART(WEEKDAY,CONVERT(DATE,CAST(GETDATE() AT TIME ZONE 'UTC' AT TIME ZONE 'Eastern Standard Time' AS DATE))) <> 2            then DATEADD(DAY,-1,CONVERT(DATE,CAST(GETDATE() AT TIME ZONE 'UTC' AT TIME ZONE 'Eastern Standard Time' AS DATE)))            when DATEPART(WEEKDAY,CONVERT(DATE,CAST(GETDATE() AT TIME ZONE 'UTC' AT TIME ZONE 'Eastern Standard Time' AS DATE))) = 2                        then DATEADD(DAY,-3,CONVERT(DATE,CAST(GETDATE() AT TIME ZONE 'UTC' AT TIME ZONE 'Eastern Standard Time' AS DATE)))           END    end      -- Returns first day and yesterday of the current month as start and end dates when run on any day except 1st day of any month, if run on 1st of any month gives first and last date of the previous month    -- Use this for reports that should include MTD data and runs every day in a month.    if @DateRange='M'    begin     set @StartDate = case when DATEPART(DAY,CONVERT(DATE,CAST(GETDATE() AT TIME ZONE 'UTC' AT TIME ZONE 'Eastern Standard Time' AS DATE))) <> 1           then DATEADD(MONTH, DATEDIFF(MONTH, 0, CAST(GETDATE() AT TIME ZONE 'UTC' AT TIME ZONE 'Eastern Standard Time' AS DATE)), 0)             when DATEPART(DAY,CONVERT(DATE,CAST(GETDATE() AT TIME ZONE 'UTC' AT TIME ZONE 'Eastern Standard Time' AS DATE))) = 1            then  DATEADD(MONTH, DATEDIFF(MONTH, 0, CAST(GETDATE() AT TIME ZONE 'UTC' AT TIME ZONE 'Eastern Standard Time' AS DATE))-1, 0)             END     --set @StartDate='05/01/2019'     set @EndDate = case when (DATEPART(DAY,CONVERT(DATE,CAST(GETDATE() AT TIME ZONE 'UTC' AT TIME ZONE 'Eastern Standard Time' AS DATE))) <> 1) and (DATEPART(WEEKDAY,CONVERT(DATE,CAST(GETDATE() AT TIME ZONE 'UTC' AT TIME ZONE 'Eastern Standard Time' AS DATE))) <> 2)           then DATEADD(DAY, DATEDIFF(DAY, 0, CAST(GETDATE()-1 AT TIME ZONE 'UTC' AT TIME ZONE 'Eastern Standard Time' AS DATE)), 0)           when (DATEPART(DAY,CONVERT(DATE,CAST(GETDATE() AT TIME ZONE 'UTC' AT TIME ZONE 'Eastern Standard Time' AS DATE))) <> 1) and (DATEPART(WEEKDAY,CONVERT(DATE,CAST(GETDATE() AT TIME ZONE 'UTC' AT TIME ZONE 'Eastern Standard Time' AS DATE))) = 2)           then DATEADD(DAY, DATEDIFF(DAY, 0, CAST(GETDATE()-3 AT TIME ZONE 'UTC' AT TIME ZONE 'Eastern Standard Time' AS DATE)), 0)             when (DATEPART(DAY,CONVERT(DATE,CAST(GETDATE() AT TIME ZONE 'UTC' AT TIME ZONE 'Eastern Standard Time' AS DATE))) = 1) and (DATEPART(WEEKDAY,CONVERT(DATE,CAST(GETDATE() AT TIME ZONE 'UTC' AT TIME ZONE 'Eastern Standard Time' AS DATE))) <> 2)           then DATEADD(MONTH, DATEDIFF(MONTH, -1, CAST(GETDATE() AT TIME ZONE 'UTC' AT TIME ZONE 'Eastern Standard Time' AS DATE))-1, -1)          when (DATEPART(DAY,CONVERT(DATE,CAST(GETDATE() AT TIME ZONE 'UTC' AT TIME ZONE 'Eastern Standard Time' AS DATE))) = 1) and (DATEPART(WEEKDAY,CONVERT(DATE,CAST(GETDATE()
    --  EXEC [bireports].[sp_rpt_HA_CAN_RET_EXC]   CREATE PROCEDURE [bireports].[sp_rpt_HA_CAN_RET_EXC]   AS  BEGIN      -- Frist day of the year  DECLARE @FirstDayofYear DATE;  SET @FirstDayofYear =  CASE WHEN DATEPART(DAY,CONVERT(DATE,CAST(GETDATE() AT TIME ZONE 'UTC' AT TIME ZONE 'Eastern Standard Time' AS DATE))) = 1                                AND DATEPART(MONTH,CONVERT(DATE,CAST(GETDATE() AT TIME ZONE 'UTC' AT TIME ZONE 'Eastern Standard Time' AS DATE))) = 1            THEN CAST('01/01/' + CAST(DATEPART(YEAR,CONVERT(DATE,CAST(GETDATE()-1 AT TIME ZONE 'UTC' AT TIME ZONE 'Eastern Standard Time' AS DATE))) AS VARCHAR) AS DATE)               ELSE CAST('01/01/' + CAST(DATEPART(YEAR,CONVERT(DATE,CAST(GETDATE() AT TIME ZONE 'UTC' AT TIME ZONE 'Eastern Standard Time' AS DATE))) AS VARCHAR) AS DATE)              END  -- Todays Date  DECLARE @TodaysDate DATE;  SET @TodaysDate = CAST(GETDATE() AT TIME ZONE 'UTC' AT TIME ZONE 'Eastern Standard Time' AS DATE)      DROP TABLE IF EXISTS #temp_HA_CAN_RET_EXC_Orders      -- List of all CANCELLED orders   -- which are not approved - No PO  SELECT o.NHMemberId, o.OrderID OrderNumber, o.OrderType, o.[Status], CAST(o.DateOrderInitiated AT TIME ZONE 'UTC' AT TIME ZONE 'Eastern Standard Time' AS DATE) PODate, c.InsuranceCarrierName  INTO #temp_HA_CAN_RET_EXC_Orders  FROM Orders.Orders o  LEFT JOIN bireports.BI_OrderDetail_Data_2020 bi ON (bi.OrderNumber = o.OrderID)  LEFT JOIN Insurance.InsuranceCarriers c with (nolock) ON (c.InsuranceCarrierID=CAST(JSON_VALUE(o.MemberData,'$.insCarrierId') AS INT))  WHERE 1=1  AND o.[Status] = 'CANCELLED'  AND o.OrderType = 'NEW'  AND o.[Source] NOT IN ('MemberPortal') -- Exclude DHE orders from HA dashboard report  AND CAST(o.DateOrderInitiated AT TIME ZONE 'UTC' AT TIME ZONE 'Eastern Standard Time' AS DATE) >= @FirstDayofYear  AND bi.OrderNumber IS NULL    UNION  -- which are approved - Has PO  SELECT  NHMemberId, OrderNumber , Original_OrderType OrderType, [Status], ISNULL(HA_PODate,CROS_PODate) PODate, InsuranceCarrierName  FROM bireports.BI_OrderDetail_Data_2020  WHERE 1=1  AND [Status] = 'CANCELLED'  AND Original_OrderType = 'NEW'  AND [Source] NOT IN ('MemberPortal') -- Exclude DHE orders from HA dashboard report      UNION      -- List of all EXCHANGE orders  -- which are approved - Has PO  SELECT  NHMemberId, OrderNumber , Original_OrderType OrderType, [Status], ISNULL(HA_PODate,CROS_PODate) PODate, InsuranceCarrierName  FROM bireports.BI_OrderDetail_Data_2020  WHERE 1=1  AND Original_OrderType = 'EXCHANGE'  AND Status = 'ACTIVE'  AND [Source] NOT IN ('MemberPortal') -- Exclude DHE orders from HA dashboard report    UNION    -- which are supposed to be marked as EXCHANGE instead of RETURNED  -- Returned order should be considered as Exchange When there is a latest active or returned order for the same member  SELECT DISTINCT  ex.NHMemberId, ex.OrderNumber   ,CASE WHEN ex.OrderNumber2 IS NOT NULL THEN 'EXCHANGE'        WHEN ex.OrderNumber2 IS NULL THEN 'NEW' END OrderType  ,CASE WHEN ex.OrderNumber2 IS NOT NULL THEN 'ACTIVE'        WHEN ex.OrderNumber2 IS NULL THEN 'RETURNED' END [Status]  ,ex.PODate, ex.InsuranceCarrierName  FROM  (    SELECT    o1.NHMemberId, o1.OrderNumber , o1.Original_OrderType OrderType, o1.[Status], ISNULL(o1.HA_PODate,o1.CROS_PODate) PODate    ,o2.OrderNumber OrderNumber2, o1.InsuranceCarrierName    FROM bireports.BI_OrderDetail_Data_2020 o1    LEFT JOIN     (     SELECT     NHMemberId, OrderNumber , Original_OrderType OrderType, [Status], ISNULL(HA_PODate,CROS_PODate) PODate     FROM bireports.BI_OrderDetail_Data_2020 o1     WHERE 1=1     AND [Status] IN ('RETURNED','ACTIVE')     AND Original_OrderType = 'NEW'     AND [Source] NOT IN ('MemberPortal') -- Exclude DHE orders from HA dashboard report    ) o2 ON (o2.NHMemberId = o1.NHMemberId AND o1.OrderNumber < o2.OrderNumber)    WHERE 1=1    AND o1.[Status] = 'RETURNED'    AND o1.Original_OrderType = 'NEW'    AND [Source] NOT IN ('MemberPortal') -- Exclude DHE orders from HA
  -- EXEC bireports.sp_rpt_mitel_queue_stats_OTC_custom '04/01/2020','04/30/2020','X' -- Custom  -- EXEC bireports.sp_rpt_mitel_queue_stats_OTC_custom NULL,NULL,'D'  -- EXEC bireports.sp_rpt_mitel_queue_stats_OTC_custom NULL,NULL,'W'  -- EXEC bireports.sp_rpt_mitel_queue_stats_OTC_custom NULL,NULL,'M'  -- EXEC bireports.sp_rpt_mitel_queue_stats_OTC_custom NULL,NULL,'MTD'  CREATE proc [bireports].[sp_rpt_mitel_queue_stats_OTC_custom] (@Start_Date date, @End_Date date, @DateRange char(5))  as         Declare @StartDate date;  Declare @EndDate date;        -- Custom Date Range    if @DateRange='X'    begin       set @StartDate =  @Start_Date                set @EndDate =  @End_Date             end          -- Returns previous day     if @DateRange='D'    begin     set @StartDate = DATEADD(DAY,-1,CONVERT(DATE,CAST(GETDATE() AT TIME ZONE 'UTC' AT TIME ZONE 'Eastern Standard Time' AS DATE)))                 set @EndDate =   DATEADD(DAY,-1,CONVERT(DATE,CAST(GETDATE() AT TIME ZONE 'UTC' AT TIME ZONE 'Eastern Standard Time' AS DATE)))              end          -- Returns previous day     if @DateRange='H'    begin     set @StartDate = CONVERT(DATE,CAST(GETDATE() AT TIME ZONE 'UTC' AT TIME ZONE 'Eastern Standard Time' AS DATE))                set @EndDate =   CONVERT(DATE,CAST(GETDATE() AT TIME ZONE 'UTC' AT TIME ZONE 'Eastern Standard Time' AS DATE))             end      -- Returns first and last day of previous month    if @DateRange='M'    begin     set @EndDate = dateadd(dd,-1,cast(cast(year(CAST(GETDATE() AT TIME ZONE 'UTC' AT TIME ZONE 'Eastern Standard Time' AS DATE)) as varchar(4))+'/'+cast(month(CAST(GETDATE() AT TIME ZONE 'UTC' AT TIME ZONE 'Eastern Standard Time' AS DATE)) as varchar(2))+'/1' as date))     set @StartDate = cast(cast(year(@EndDate) as varchar(4))+'/'+cast(month(@EndDate) as varchar(2))+'/1' as date);       end      -- Returns first and last day of previous week - first day of week starts with Sunday    if @DateRange='W'    begin     set @StartDate = DATEADD(wk, -1, DATEADD(DAY, 1-DATEPART(WEEKDAY, CAST(GETDATE() AT TIME ZONE 'UTC' AT TIME ZONE 'Eastern Standard Time' AS DATE)), DATEDIFF(dd, 0, CAST(GETDATE() AT TIME ZONE 'UTC' AT TIME ZONE 'Eastern Standard Time' AS DATE))))     set @EndDate = DATEADD(wk, 0, DATEADD(DAY, 0-DATEPART(WEEKDAY, CAST(GETDATE() AT TIME ZONE 'UTC' AT TIME ZONE 'Eastern Standard Time' AS DATE)), DATEDIFF(dd, 0, CAST(GETDATE() AT TIME ZONE 'UTC' AT TIME ZONE 'Eastern Standard Time' AS DATE))))    end        -- Returns first day and yesterday of the current month as start and end dates when run on any day except 1st day of any month, if run on 1st of any month gives first and last date of the previous month    -- Use this for reports that should include MTD data and runs every day in a month.    if @DateRange='MTD'    begin     set @StartDate = case when DATEPART(DAY,CONVERT(DATE,CAST(GETDATE() AT TIME ZONE 'UTC' AT TIME ZONE 'Eastern Standard Time' AS DATE))) <> 1           then DATEADD(MONTH, DATEDIFF(MONTH, 0, CAST(GETDATE() AT TIME ZONE 'UTC' AT TIME ZONE 'Eastern Standard Time' AS DATE)), 0)               when DATEPART(DAY,CONVERT(DATE,CAST(GETDATE() AT TIME ZONE 'UTC' AT TIME ZONE 'Eastern Standard Time' AS DATE))) = 1            then DATEADD(MONTH, DATEDIFF(MONTH, 0, CAST(GETDATE() AT TIME ZONE 'UTC' AT TIME ZONE 'Eastern Standard Time' AS DATE))-1, 0)             END       set @EndDate  = case when DATEPART(DAY,CONVERT(DATE,CAST(GETDATE() AT TIME ZONE 'UTC' AT TIME ZONE 'Eastern Standard Time' AS DATE))) <> 1           then DATEADD(DAY, DATEDIFF(DAY, 0, CAST(GETDATE()-1 AT TIME ZONE 'UTC' AT TIME ZONE 'Eastern Standard Time' AS DATE)), 0)                    when DATEPART(DAY,CONVERT(DATE,CAST(GETDATE() AT TIME ZONE 'UTC' AT TIME ZONE 'Eastern Standard Time' AS DATE))) = 1           then DATEADD(MONTH, DATEDIFF(MONTH, -1, CAST(GETDATE() AT TIME ZONE 'UTC' AT TIME ZONE 'Eastern Standard Time' AS DATE))-1, -1)                   END    end    --SELECT @StartDate  --SELECT @EndDate  
  -- EXEC bireports.sp_rpt_mitel_queue_stats_HA_custom '01/01/2019','01/31/2019','X' -- Custom  -- EXEC bireports.sp_rpt_mitel_queue_stats_HA_custom NULL,NULL,'D' -- Yesterday  -- EXEC bireports.sp_rpt_mitel_queue_stats_HA_custom NULL,NULL,'W' -- Last Week  -- EXEC bireports.sp_rpt_mitel_queue_stats_HA_custom NULL,NULL,'M' -- Previous Month  -- EXEC bireports.sp_rpt_mitel_queue_stats_HA_custom NULL,NULL,'MTD' -- Month To Date  CREATE proc [bireports].[sp_rpt_mitel_queue_stats_HA_custom] (@Start_Date date, @End_Date date,@DateRange char(5))  as         Declare @StartDate date;  Declare @EndDate date;        -- Custom Date Range    if @DateRange='X'    begin       set @StartDate =  @Start_Date                set @EndDate =  @End_Date             end          -- Returns previous day     if @DateRange='D'    begin     set @StartDate = DATEADD(DAY,-1,CONVERT(DATE,CAST(GETDATE() AT TIME ZONE 'UTC' AT TIME ZONE 'Eastern Standard Time' AS DATE)))                 set @EndDate =   DATEADD(DAY,-1,CONVERT(DATE,CAST(GETDATE() AT TIME ZONE 'UTC' AT TIME ZONE 'Eastern Standard Time' AS DATE)))              end          -- Returns previous day     if @DateRange='H'    begin     set @StartDate = CONVERT(DATE,CAST(GETDATE() AT TIME ZONE 'UTC' AT TIME ZONE 'Eastern Standard Time' AS DATE))                set @EndDate =   CONVERT(DATE,CAST(GETDATE() AT TIME ZONE 'UTC' AT TIME ZONE 'Eastern Standard Time' AS DATE))             end      -- Returns first and last day of previous month    if @DateRange='M'    begin     set @EndDate = dateadd(dd,-1,cast(cast(year(CAST(GETDATE() AT TIME ZONE 'UTC' AT TIME ZONE 'Eastern Standard Time' AS DATE)) as varchar(4))+'/'+cast(month(CAST(GETDATE() AT TIME ZONE 'UTC' AT TIME ZONE 'Eastern Standard Time' AS DATE)) as varchar(2))+'/1' as date))     set @StartDate = cast(cast(year(@EndDate) as varchar(4))+'/'+cast(month(@EndDate) as varchar(2))+'/1' as date);       end      -- Returns first and last day of previous week - first day of week starts with Sunday    if @DateRange='W'    begin     set @StartDate = DATEADD(wk, -1, DATEADD(DAY, 1-DATEPART(WEEKDAY, CAST(GETDATE() AT TIME ZONE 'UTC' AT TIME ZONE 'Eastern Standard Time' AS DATE)), DATEDIFF(dd, 0, CAST(GETDATE() AT TIME ZONE 'UTC' AT TIME ZONE 'Eastern Standard Time' AS DATE))))     set @EndDate = DATEADD(wk, 0, DATEADD(DAY, 0-DATEPART(WEEKDAY, CAST(GETDATE() AT TIME ZONE 'UTC' AT TIME ZONE 'Eastern Standard Time' AS DATE)), DATEDIFF(dd, 0, CAST(GETDATE() AT TIME ZONE 'UTC' AT TIME ZONE 'Eastern Standard Time' AS DATE))))    end        -- Returns first day and yesterday of the current month as start and end dates when run on any day except 1st day of any month, if run on 1st of any month gives first and last date of the previous month    -- Use this for reports that should include MTD data and runs every day in a month.    if @DateRange='MTD'    begin     set @StartDate = case when DATEPART(DAY,CONVERT(DATE,CAST(GETDATE() AT TIME ZONE 'UTC' AT TIME ZONE 'Eastern Standard Time' AS DATE))) <> 1           then DATEADD(MONTH, DATEDIFF(MONTH, 0, CAST(GETDATE() AT TIME ZONE 'UTC' AT TIME ZONE 'Eastern Standard Time' AS DATE)), 0)               when DATEPART(DAY,CONVERT(DATE,CAST(GETDATE() AT TIME ZONE 'UTC' AT TIME ZONE 'Eastern Standard Time' AS DATE))) = 1            then DATEADD(MONTH, DATEDIFF(MONTH, 0, CAST(GETDATE() AT TIME ZONE 'UTC' AT TIME ZONE 'Eastern Standard Time' AS DATE))-1, 0)             END       set @EndDate  = case when DATEPART(DAY,CONVERT(DATE,CAST(GETDATE() AT TIME ZONE 'UTC' AT TIME ZONE 'Eastern Standard Time' AS DATE))) <> 1           then DATEADD(DAY, DATEDIFF(DAY, 0, CAST(GETDATE()-1 AT TIME ZONE 'UTC' AT TIME ZONE 'Eastern Standard Time' AS DATE)), 0)                    when DATEPART(DAY,CONVERT(DATE,CAST(GETDATE() AT TIME ZONE 'UTC' AT TIME ZONE 'Eastern Standard Time' AS DATE))) = 1           then DATEADD(MONTH, DATEDIFF(MONTH, -1, CAST(GETDATE() AT TIME ZONE 'UTC' AT TIME ZONE 'Eastern Standard Time' AS DATE))-1, -1)                   
  -- EXEC bireports.sp_rpt_mitel_queue_stats 'D' -- Yesterday  -- EXEC bireports.sp_rpt_mitel_queue_stats 'W' -- Last Week  -- EXEC bireports.sp_rpt_mitel_queue_stats 'M' -- Previous Month  -- EXEC bireports.sp_rpt_mitel_queue_stats 'MTD' -- Month To Date  CREATE proc [bireports].[sp_rpt_mitel_queue_stats] (@DateRange char(5))  as         Declare @StartDate date;  Declare @EndDate date;          -- Returns previous day     if @DateRange='D'    begin     set @StartDate = DATEADD(DAY,-1,CONVERT(DATE,CAST(GETDATE() AT TIME ZONE 'UTC' AT TIME ZONE 'Eastern Standard Time' AS DATE)))                 set @EndDate =   DATEADD(DAY,-1,CONVERT(DATE,CAST(GETDATE() AT TIME ZONE 'UTC' AT TIME ZONE 'Eastern Standard Time' AS DATE)))              end      -- Returns first and last day of previous month    if @DateRange='M'    begin     set @EndDate = dateadd(dd,-1,cast(cast(year(CAST(GETDATE() AT TIME ZONE 'UTC' AT TIME ZONE 'Eastern Standard Time' AS DATE)) as varchar(4))+'/'+cast(month(CAST(GETDATE() AT TIME ZONE 'UTC' AT TIME ZONE 'Eastern Standard Time' AS DATE)) as varchar(2))+'/1' as date))     set @StartDate = cast(cast(year(@EndDate) as varchar(4))+'/'+cast(month(@EndDate) as varchar(2))+'/1' as date);       end      -- Returns first and last day of previous week - first day of week starts with Sunday    if @DateRange='W'    begin     set @StartDate = DATEADD(wk, -1, DATEADD(DAY, 1-DATEPART(WEEKDAY, CAST(GETDATE() AT TIME ZONE 'UTC' AT TIME ZONE 'Eastern Standard Time' AS DATE)), DATEDIFF(dd, 0, CAST(GETDATE() AT TIME ZONE 'UTC' AT TIME ZONE 'Eastern Standard Time' AS DATE))))     set @EndDate = DATEADD(wk, 0, DATEADD(DAY, 0-DATEPART(WEEKDAY, CAST(GETDATE() AT TIME ZONE 'UTC' AT TIME ZONE 'Eastern Standard Time' AS DATE)), DATEDIFF(dd, 0, CAST(GETDATE() AT TIME ZONE 'UTC' AT TIME ZONE 'Eastern Standard Time' AS DATE))))    end        -- Returns first day and yesterday of the current month as start and end dates when run on any day except 1st day of any month, if run on 1st of any month gives first and last date of the previous month    -- Use this for reports that should include MTD data and runs every day in a month.    if @DateRange='MTD'    begin     set @StartDate = case when DATEPART(DAY,CONVERT(DATE,CAST(GETDATE() AT TIME ZONE 'UTC' AT TIME ZONE 'Eastern Standard Time' AS DATE))) <> 1           then DATEADD(MONTH, DATEDIFF(MONTH, 0, CAST(GETDATE() AT TIME ZONE 'UTC' AT TIME ZONE 'Eastern Standard Time' AS DATE)), 0)               when DATEPART(DAY,CONVERT(DATE,CAST(GETDATE() AT TIME ZONE 'UTC' AT TIME ZONE 'Eastern Standard Time' AS DATE))) = 1            then DATEADD(MONTH, DATEDIFF(MONTH, 0, CAST(GETDATE() AT TIME ZONE 'UTC' AT TIME ZONE 'Eastern Standard Time' AS DATE))-1, 0)             END       set @EndDate  = case when DATEPART(DAY,CONVERT(DATE,CAST(GETDATE() AT TIME ZONE 'UTC' AT TIME ZONE 'Eastern Standard Time' AS DATE))) <> 1           then DATEADD(DAY, DATEDIFF(DAY, 0, CAST(GETDATE()-1 AT TIME ZONE 'UTC' AT TIME ZONE 'Eastern Standard Time' AS DATE)), 0)                    when DATEPART(DAY,CONVERT(DATE,CAST(GETDATE() AT TIME ZONE 'UTC' AT TIME ZONE 'Eastern Standard Time' AS DATE))) = 1           then DATEADD(MONTH, DATEDIFF(MONTH, -1, CAST(GETDATE() AT TIME ZONE 'UTC' AT TIME ZONE 'Eastern Standard Time' AS DATE))-1, -1)                   END    end    --SELECT @StartDate  --SELECT @EndDate    --set @StartDate='12/01/2019';  --set @EndDate='12/31/2019';    -- EXEC bireports.sp_rpt_mitel_queue_stats 'D'    select   1 as Seq  ,@StartDate AS Start_Date  ,@EndDate AS End_Date  ,QueueReporting  ,isnull(qg.Name,REPLACE(REPLACE(QueueName,'1',''),'2','')) QueueName  ,sum(QueueOffered) ACD_Calls_Offered  ,sum(QueueAnswered) ACD_Calls_Handled  ,sum(QueueAbandoned) ACD_Calls_Abandoned_Long  ,sum(QueueShortAbandoned) ACD_Calls_Abandoned_Short    ,CASE WHEN sum(QueueAnswered) = 0 THEN '00:00:00' ELSE  RIGHT('00' + CAST((sum(QueueTimeToAnswerTotal)/sum(QueueAnswered))/3600  AS VARCHAR(2)), 2 ) +':'+ -- HH  RIGHT('00' + CAST(((su
  -- EXEC bireports.sp_rpt_HA_PO_OrderItem_Details '01/01/2019','01/31/2019','X' -- Custom  -- EXEC bireports.sp_rpt_HA_PO_OrderItem_Details NULL,NULL,'D','PHONAK,UNITRON' -- Yesterday  -- EXEC bireports.sp_rpt_HA_PO_OrderItem_Details NULL,NULL,'W','PHONAK,UNITRON' -- Last Week  -- EXEC bireports.sp_rpt_HA_PO_OrderItem_Details NULL,NULL,'W','BELTONE' -- Last Week  -- EXEC bireports.sp_rpt_HA_PO_OrderItem_Details NULL,NULL,'M','PHONAK,UNITRON' -- Previous Month  -- EXEC bireports.sp_rpt_HA_PO_OrderItem_Details NULL,NULL,'MTD','PHONAK,UNITRON' -- Month To Date  CREATE proc [bireports].[sp_rpt_HA_PO_OrderItem_Details] (@Start_Date date, @End_Date date,@DateRange char(5), @BrandCode varchar(100))  as         Declare @StartDate date;  Declare @EndDate date;  Declare @BrandCodeStr varchar(100);      set @BrandCodeStr = @BrandCode;            -- Custom Date Range    if @DateRange='X'    begin       set @StartDate =  @Start_Date                set @EndDate =  @End_Date             end          -- Returns previous day     if @DateRange='D'    begin     set @StartDate = DATEADD(DAY,-1,CONVERT(DATE,CAST(GETDATE() AT TIME ZONE 'UTC' AT TIME ZONE 'Eastern Standard Time' AS DATE)))                 set @EndDate =   DATEADD(DAY,-1,CONVERT(DATE,CAST(GETDATE() AT TIME ZONE 'UTC' AT TIME ZONE 'Eastern Standard Time' AS DATE)))              end          -- Returns previous day     if @DateRange='H'    begin     set @StartDate = CONVERT(DATE,CAST(GETDATE() AT TIME ZONE 'UTC' AT TIME ZONE 'Eastern Standard Time' AS DATE))                set @EndDate =   CONVERT(DATE,CAST(GETDATE() AT TIME ZONE 'UTC' AT TIME ZONE 'Eastern Standard Time' AS DATE))             end      -- Returns first and last day of previous month    if @DateRange='M'    begin     set @EndDate = dateadd(dd,-1,cast(cast(year(CAST(GETDATE() AT TIME ZONE 'UTC' AT TIME ZONE 'Eastern Standard Time' AS DATE)) as varchar(4))+'/'+cast(month(CAST(GETDATE() AT TIME ZONE 'UTC' AT TIME ZONE 'Eastern Standard Time' AS DATE)) as varchar(2))+'/1' as date))     set @StartDate = cast(cast(year(@EndDate) as varchar(4))+'/'+cast(month(@EndDate) as varchar(2))+'/1' as date);       end      -- Returns first and last day of previous week - first day of week starts with Sunday    if @DateRange='W'    begin     set @StartDate = DATEADD(wk, -1, DATEADD(DAY, 1-DATEPART(WEEKDAY, CAST(GETDATE() AT TIME ZONE 'UTC' AT TIME ZONE 'Eastern Standard Time' AS DATE)), DATEDIFF(dd, 0, CAST(GETDATE() AT TIME ZONE 'UTC' AT TIME ZONE 'Eastern Standard Time' AS DATE))))     set @EndDate = DATEADD(wk, 0, DATEADD(DAY, 0-DATEPART(WEEKDAY, CAST(GETDATE() AT TIME ZONE 'UTC' AT TIME ZONE 'Eastern Standard Time' AS DATE)), DATEDIFF(dd, 0, CAST(GETDATE() AT TIME ZONE 'UTC' AT TIME ZONE 'Eastern Standard Time' AS DATE))))    end        -- Returns first day and yesterday of the current month as start and end dates when run on any day except 1st day of any month, if run on 1st of any month gives first and last date of the previous month    -- Use this for reports that should include MTD data and runs every day in a month.    if @DateRange='MTD'    begin     set @StartDate = case when DATEPART(DAY,CONVERT(DATE,CAST(GETDATE() AT TIME ZONE 'UTC' AT TIME ZONE 'Eastern Standard Time' AS DATE))) <> 1           then DATEADD(MONTH, DATEDIFF(MONTH, 0, CAST(GETDATE() AT TIME ZONE 'UTC' AT TIME ZONE 'Eastern Standard Time' AS DATE)), 0)               when DATEPART(DAY,CONVERT(DATE,CAST(GETDATE() AT TIME ZONE 'UTC' AT TIME ZONE 'Eastern Standard Time' AS DATE))) = 1            then DATEADD(MONTH, DATEDIFF(MONTH, 0, CAST(GETDATE() AT TIME ZONE 'UTC' AT TIME ZONE 'Eastern Standard Time' AS DATE))-1, 0)             END       set @EndDate  = case when DATEPART(DAY,CONVERT(DATE,CAST(GETDATE() AT TIME ZONE 'UTC' AT TIME ZONE 'Eastern Standard Time' AS DATE))) <> 1           then DATEADD(DAY, DATEDIFF(DAY, 0, CAST(GETDATE()-1 AT TIME ZONE 'UTC' AT TIME ZONE 'Eastern Standard Time' AS DATE)), 0)                    when DATEPART(DAY,CONVERT(DATE,CAST(GET
      --exec [bireports].[sp_AppVsOrders_rpt_dpsr]    CREATE PROCEDURE [bireports].[sp_AppVsOrders_rpt_dpsr]   AS  BEGIN    SELECT Z.InsuranceCarrierID    , Z.InsuranceCarrierName    , Z.AppointmentDate    , COUNT(DISTINCT MemberChartDataId) AppCount    , COUNT(DISTINCT OrderNHMemberId) AS DistinctOrderForMember    , PastFutureFlag    , COUNT(DISTINCT (CASE WHEN PastFutureFlag = 'Past' THEN MemberChartDataId END)) AS PastAppCount    --, SUM(CASE WHEN PastFutureFlag = 'Past' THEN ISNULL(Z.cnt,0) END ) AS PastDistinctOrderForMember    , 0 AS PastDistinctOrderForMember    , COUNT(DISTINCT (CASE WHEN PastFutureFlag = 'Future' THEN MemberChartDataId END)) AS FutureAppCount    --, SUM(ISNULL(Z.OrderCnt,0)) AS SumOfOrdersForMember    , 0 AS SumOfOrdersForMember   INTO #temp  FROM (    SELECT   q.InsuranceCarrierID        ,ic.InsuranceCarrierName        ,q.AppointmentDate        ,q.NHMemberId TestNHMemberId        ,q.MemberChartDataId        ,o.OrderID        ,o.MemberChartDataId AS orderMemberChartDataId        ,o.NHMemberId AS OrderNHMemberId        ,CASE WHEN CAST(q.AppointmentDate AS DATE) <= CAST(GETDATE() AT TIME ZONE 'UTC'   AT TIME ZONE 'Eastern Standard Time' AS DATE) THEN 'Past' ELSE 'Future' END PastFutureFlag    FROM bireports.QTesting q    JOIN Insurance.InsuranceCarriers ic ON q.InsuranceCarrierID = ic.InsuranceCarrierID    left JOIN (   SELECT X.NHMemberId,x.OrderID,x.MemberChartDataId,X.Status        FROM Orders.Orders X         JOIN Orders.OrderPOs op ON X.OrderId = op.OrderID         WHERE X.Status ='ACTIVE'        AND op.PODate >= cast('20200101' as date)            ) o ON q.NHMemberId = o.NHMemberId      WHERE 1=1    and ic.InsuranceCarrierName <> 'Test'    --AND ic.InsuranceCarrierID = 270    AND q.appointmentdate >= cast('20200101' as date)    ) Z  GROUP BY Z.InsuranceCarrierID      , Z.InsuranceCarrierName      , Z.AppointmentDate      , PastFutureFlag  ORDER BY Z.InsuranceCarrierName    ,Z.AppointmentDate    --SELECT * FROM #temp ORDER BY InsuranceCarrierName    SELECT 0 AS forOrder     ,'Grand Total'  AS DataDesc     ,0 AS InsuranceCarrierID     ,'Grand Total' AS InsuranceCarrierName     ,'01/01/1900' AS AppointmentDate     ,SUM(T.AppCount) AppCount     ,SUM(T.PastAppCount) PastAppCount     ,SUM(T.PastDistinctOrderForMember) PastDistinctOrderForMember     --,ROUND(100*SUM(T.PastDistinctOrderForMember)/SUM(T.PastAppCount),2) PerSuccess     ,SUM(T.FutureAppCount) FutureAppCount     ,SUM(T.DistinctOrderForMember) DistinctOrderForMember     ,SUM(T.SumOfOrdersForMember) SumOfOrdersForMember  FROM #temp t  --WHERE t.InsuranceCarrierID = 270  union  SELECT 1 AS forOrder     ,'Carrier Lvl'  AS DataDesc     ,T.InsuranceCarrierID     ,T.InsuranceCarrierName     ,'01/01/1900' AS AppointmentDate     ,SUM(T.AppCount) AppCount     ,SUM(T.PastAppCount) PastAppCount     ,SUM(ISNULL(T.PastDistinctOrderForMember,0)) PastDistinctOrderForMember     --,ROUND(100*SUM(T.PastDistinctOrderForMember)/SUM(T.PastAppCount),2) PerSuccess     ,SUM(T.FutureAppCount) FutureAppCount     ,SUM(T.DistinctOrderForMember) DistinctOrderForMember     ,SUM(T.SumOfOrdersForMember) SumOfOrdersForMember  FROM #temp t  --WHERE t.InsuranceCarrierID = 270  GROUP BY T.InsuranceCarrierID       ,T.InsuranceCarrierName  Union  SELECT 2     ,'Details'  AS DataDesc     ,T.InsuranceCarrierID     ,T.InsuranceCarrierName     ,T.AppointmentDate     ,T.AppCount     ,T.PastAppCount     ,ISNULL(T.PastDistinctOrderForMember,0) PastDistinctOrderForMember     --,ROUND(100*SUM(T.PastDistinctOrderForMember)/SUM(T.PastAppCount),2) PerSuccess     ,T.FutureAppCount     ,T.DistinctOrderForMember     ,T.SumOfOrdersForMember  FROM #temp t  --WHERE t.InsuranceCarrierID = 270  ORDER BY 1,4,5    drop table #temp  --exec [bireports].[sp_AppVsOrders_rpt]   END  
    -- EXEC bireports.sp_rpt_client_CCA_Cart_Overview NULL,NULL,'D' -- Yesterday  -- EXEC bireports.sp_rpt_client_CCA_Cart_Overview NULL,NULL,'M' -- Previous Month  -- EXEC bireports.sp_rpt_client_CCA_Cart_Overview NULL,NULL,'MTD' -- Month To Date  -- EXEC bireports.sp_rpt_client_CCA_Cart_Overview NULL,NULL,'YTD' -- Year To Date until today  -- EXEC bireports.sp_rpt_client_CCA_Cart_Overview '01/01/2020','04/15/2020','X' -- Year To Date including today      CREATE proc [bireports].[sp_rpt_client_CCA_Cart_Overview] (@Start_Date date, @End_Date date, @DateRange char(5))  as     SET DATEFIRST 1;  -- Week starts with Monday instead of Sunday    Declare @StartDate date;  Declare @EndDate date;                -- Custom Date Range    if @DateRange='X'    begin       set @StartDate =  @Start_Date                set @EndDate =  @End_Date             end          -- Returns previous day     if @DateRange='D'    begin     set @StartDate = DATEADD(DAY,-1,CONVERT(DATE,CAST(GETDATE() AT TIME ZONE 'UTC' AT TIME ZONE 'Eastern Standard Time' AS DATE)))                 set @EndDate =   DATEADD(DAY,-1,CONVERT(DATE,CAST(GETDATE() AT TIME ZONE 'UTC' AT TIME ZONE 'Eastern Standard Time' AS DATE)))              end      -- Returns first and last day of previous month    if @DateRange='M'    begin     set @EndDate = dateadd(dd,-1,cast(cast(year(CAST(GETDATE() AT TIME ZONE 'UTC' AT TIME ZONE 'Eastern Standard Time' AS DATE)) as varchar(4))+'/'+cast(month(CAST(GETDATE() AT TIME ZONE 'UTC' AT TIME ZONE 'Eastern Standard Time' AS DATE)) as varchar(2))+'/1' as date))     set @StartDate = cast(cast(year(@EndDate) as varchar(4))+'/'+cast(month(@EndDate) as varchar(2))+'/1' as date);       end      -- Returns first and last day of previous week - first day of week starts with Sunday    if @DateRange='W'    begin     set @StartDate = DATEADD(wk, -1, DATEADD(DAY, 1-DATEPART(WEEKDAY, CAST(GETDATE() AT TIME ZONE 'UTC' AT TIME ZONE 'Eastern Standard Time' AS DATE)), DATEDIFF(dd, 0, CAST(GETDATE() AT TIME ZONE 'UTC' AT TIME ZONE 'Eastern Standard Time' AS DATE))))     set @EndDate = DATEADD(wk, 0, DATEADD(DAY, 0-DATEPART(WEEKDAY, CAST(GETDATE() AT TIME ZONE 'UTC' AT TIME ZONE 'Eastern Standard Time' AS DATE)), DATEDIFF(dd, 0, CAST(GETDATE() AT TIME ZONE 'UTC' AT TIME ZONE 'Eastern Standard Time' AS DATE))))    end        -- Returns first day and yesterday of the current month as start and end dates when run on any day except 1st day of any month, if run on 1st of any month gives first and last date of the previous month    -- Use this for reports that should include MTD data and runs every day in a month.    if @DateRange='MTD'    begin     set @StartDate = case when DATEPART(DAY,CONVERT(DATE,CAST(GETDATE() AT TIME ZONE 'UTC' AT TIME ZONE 'Eastern Standard Time' AS DATE))) <> 1           then DATEADD(MONTH, DATEDIFF(MONTH, 0, CAST(GETDATE() AT TIME ZONE 'UTC' AT TIME ZONE 'Eastern Standard Time' AS DATE)), 0)               when DATEPART(DAY,CONVERT(DATE,CAST(GETDATE() AT TIME ZONE 'UTC' AT TIME ZONE 'Eastern Standard Time' AS DATE))) = 1            then DATEADD(MONTH, DATEDIFF(MONTH, 0, CAST(GETDATE() AT TIME ZONE 'UTC' AT TIME ZONE 'Eastern Standard Time' AS DATE))-1, 0)             END       set @EndDate  = case when DATEPART(DAY,CONVERT(DATE,CAST(GETDATE() AT TIME ZONE 'UTC' AT TIME ZONE 'Eastern Standard Time' AS DATE))) <> 1           then DATEADD(DAY, DATEDIFF(DAY, 0, CAST(GETDATE()-1 AT TIME ZONE 'UTC' AT TIME ZONE 'Eastern Standard Time' AS DATE)), 0)                    when DATEPART(DAY,CONVERT(DATE,CAST(GETDATE() AT TIME ZONE 'UTC' AT TIME ZONE 'Eastern Standard Time' AS DATE))) = 1           then DATEADD(MONTH, DATEDIFF(MONTH, -1, CAST(GETDATE() AT TIME ZONE 'UTC' AT TIME ZONE 'Eastern Standard Time' AS DATE))-1, -1)                   END    end        -- First day of year to current date    if @DateRange='YTD'    begin     set @StartDate = case when DATEPART(DAY,CONVERT(DATE,CAST(GETDATE() AT TIME ZONE 'UTC' AT TIME ZONE 'Eastern Standard Time' AS DATE)
      --exec [bireports].[sp_AppVsOrders_rpt]    CREATE PROCEDURE [bireports].[sp_AppVsOrders_rpt]   AS  BEGIN    SELECT Z.InsuranceCarrierID    , Z.InsuranceCarrierName    , Z.AppointmentDate    , COUNT(DISTINCT MemberChartDataId) AppCount    , COUNT(DISTINCT OrderNHMemberId) AS DistinctOrderForMember    , PastFutureFlag    , COUNT(DISTINCT (CASE WHEN PastFutureFlag = 'Past' THEN MemberChartDataId END)) AS PastAppCount    --, SUM(CASE WHEN PastFutureFlag = 'Past' THEN ISNULL(Z.cnt,0) END ) AS PastDistinctOrderForMember    , 0 AS PastDistinctOrderForMember    , COUNT(DISTINCT (CASE WHEN PastFutureFlag = 'Future' THEN MemberChartDataId END)) AS FutureAppCount    --, SUM(ISNULL(Z.OrderCnt,0)) AS SumOfOrdersForMember    , 0 AS SumOfOrdersForMember   INTO #temp  FROM (    SELECT   q.InsuranceCarrierID        ,ic.InsuranceCarrierName        ,q.AppointmentDate        ,q.NHMemberId TestNHMemberId        ,q.MemberChartDataId        ,o.OrderID        ,o.MemberChartDataId AS orderMemberChartDataId        ,o.NHMemberId AS OrderNHMemberId        ,CASE WHEN CAST(q.AppointmentDate AS DATE) <= CAST(GETDATE() AT TIME ZONE 'UTC'   AT TIME ZONE 'Eastern Standard Time' AS DATE) THEN 'Past' ELSE 'Future' END PastFutureFlag    FROM bireports.QTesting q    JOIN Insurance.InsuranceCarriers ic ON q.InsuranceCarrierID = ic.InsuranceCarrierID    left JOIN (   SELECT X.NHMemberId,x.OrderID,x.MemberChartDataId,X.Status        FROM Orders.Orders X         JOIN Orders.OrderPOs op ON X.OrderId = op.OrderID         WHERE X.Status ='ACTIVE'        AND op.PODate >= cast('20200101' as date)            ) o ON q.NHMemberId = o.NHMemberId      WHERE 1=1    and ic.InsuranceCarrierName <> 'Test'    --AND ic.InsuranceCarrierID = 270    AND q.appointmentdate >= cast('20200101' as date)    ) Z  GROUP BY Z.InsuranceCarrierID      , Z.InsuranceCarrierName      , Z.AppointmentDate      , PastFutureFlag  ORDER BY Z.InsuranceCarrierName    ,Z.AppointmentDate    --SELECT * FROM #temp ORDER BY InsuranceCarrierName    SELECT 0 AS forOrder     ,'Grand Total'  AS DataDesc     ,0 AS InsuranceCarrierID     ,'Grand Total' AS InsuranceCarrierName     ,'01/01/1900' AS AppointmentDate     ,SUM(T.AppCount) AppCount     ,SUM(T.PastAppCount) PastAppCount     ,SUM(T.PastDistinctOrderForMember) PastDistinctOrderForMember     --,ROUND(100*SUM(T.PastDistinctOrderForMember)/SUM(T.PastAppCount),2) PerSuccess     ,SUM(T.FutureAppCount) FutureAppCount     ,SUM(T.DistinctOrderForMember) DistinctOrderForMember     ,SUM(T.SumOfOrdersForMember) SumOfOrdersForMember  FROM #temp t  --WHERE t.InsuranceCarrierID = 270  union  SELECT 1 AS forOrder     ,'Carrier Lvl'  AS DataDesc     ,T.InsuranceCarrierID     ,T.InsuranceCarrierName     ,'01/01/1900' AS AppointmentDate     ,SUM(T.AppCount) AppCount     ,SUM(T.PastAppCount) PastAppCount     ,SUM(ISNULL(T.PastDistinctOrderForMember,0)) PastDistinctOrderForMember     --,ROUND(100*SUM(T.PastDistinctOrderForMember)/SUM(T.PastAppCount),2) PerSuccess     ,SUM(T.FutureAppCount) FutureAppCount     ,SUM(T.DistinctOrderForMember) DistinctOrderForMember     ,SUM(T.SumOfOrdersForMember) SumOfOrdersForMember  FROM #temp t  --WHERE t.InsuranceCarrierID = 270  GROUP BY T.InsuranceCarrierID       ,T.InsuranceCarrierName  Union  SELECT 2     ,'Details'  AS DataDesc     ,T.InsuranceCarrierID     ,T.InsuranceCarrierName     ,T.AppointmentDate     ,T.AppCount     ,T.PastAppCount     ,ISNULL(T.PastDistinctOrderForMember,0) PastDistinctOrderForMember     --,ROUND(100*SUM(T.PastDistinctOrderForMember)/SUM(T.PastAppCount),2) PerSuccess     ,T.FutureAppCount     ,T.DistinctOrderForMember     ,T.SumOfOrdersForMember  FROM #temp t  --WHERE t.InsuranceCarrierID = 270  ORDER BY 1,4,5    drop table #temp  --exec [bireports].[sp_AppVsOrders_rpt]   END  
  -- EXEC bireports.sp_rpt_client_CCA_Product_Summary NULL,NULL,'D' -- Yesterday  -- EXEC bireports.sp_rpt_client_CCA_Product_Summary NULL,NULL,'M' -- Previous Month  -- EXEC bireports.sp_rpt_client_CCA_Product_Summary NULL,NULL,'MTD' -- Month To Date  -- EXEC bireports.sp_rpt_client_CCA_Product_Summary NULL,NULL,'YTD' -- Year To Date until previous day  -- EXEC bireports.sp_rpt_client_CCA_Product_Summary '01/01/2020','04/15/2020','X' -- Year To Date including current date      CREATE proc [bireports].[sp_rpt_client_CCA_Product_Summary] (@Start_Date date, @End_Date date, @DateRange char(5))  as     Declare @StartDate date;  Declare @EndDate date;                -- Custom Date Range    if @DateRange='X'    begin       set @StartDate =  @Start_Date                set @EndDate =  @End_Date             end          -- Returns previous day     if @DateRange='D'    begin     set @StartDate = DATEADD(DAY,-1,CONVERT(DATE,CAST(GETDATE() AT TIME ZONE 'UTC' AT TIME ZONE 'Eastern Standard Time' AS DATE)))                 set @EndDate =   DATEADD(DAY,-1,CONVERT(DATE,CAST(GETDATE() AT TIME ZONE 'UTC' AT TIME ZONE 'Eastern Standard Time' AS DATE)))              end      -- Returns first and last day of previous month    if @DateRange='M'    begin     set @EndDate = dateadd(dd,-1,cast(cast(year(CAST(GETDATE() AT TIME ZONE 'UTC' AT TIME ZONE 'Eastern Standard Time' AS DATE)) as varchar(4))+'/'+cast(month(CAST(GETDATE() AT TIME ZONE 'UTC' AT TIME ZONE 'Eastern Standard Time' AS DATE)) as varchar(2))+'/1' as date))     set @StartDate = cast(cast(year(@EndDate) as varchar(4))+'/'+cast(month(@EndDate) as varchar(2))+'/1' as date);       end      -- Returns first and last day of previous week - first day of week starts with Sunday    if @DateRange='W'    begin     set @StartDate = DATEADD(wk, -1, DATEADD(DAY, 1-DATEPART(WEEKDAY, CAST(GETDATE() AT TIME ZONE 'UTC' AT TIME ZONE 'Eastern Standard Time' AS DATE)), DATEDIFF(dd, 0, CAST(GETDATE() AT TIME ZONE 'UTC' AT TIME ZONE 'Eastern Standard Time' AS DATE))))     set @EndDate = DATEADD(wk, 0, DATEADD(DAY, 0-DATEPART(WEEKDAY, CAST(GETDATE() AT TIME ZONE 'UTC' AT TIME ZONE 'Eastern Standard Time' AS DATE)), DATEDIFF(dd, 0, CAST(GETDATE() AT TIME ZONE 'UTC' AT TIME ZONE 'Eastern Standard Time' AS DATE))))    end        -- Returns first day and yesterday of the current month as start and end dates when run on any day except 1st day of any month, if run on 1st of any month gives first and last date of the previous month    -- Use this for reports that should include MTD data and runs every day in a month.    if @DateRange='MTD'    begin     set @StartDate = case when DATEPART(DAY,CONVERT(DATE,CAST(GETDATE() AT TIME ZONE 'UTC' AT TIME ZONE 'Eastern Standard Time' AS DATE))) <> 1           then DATEADD(MONTH, DATEDIFF(MONTH, 0, CAST(GETDATE() AT TIME ZONE 'UTC' AT TIME ZONE 'Eastern Standard Time' AS DATE)), 0)               when DATEPART(DAY,CONVERT(DATE,CAST(GETDATE() AT TIME ZONE 'UTC' AT TIME ZONE 'Eastern Standard Time' AS DATE))) = 1            then DATEADD(MONTH, DATEDIFF(MONTH, 0, CAST(GETDATE() AT TIME ZONE 'UTC' AT TIME ZONE 'Eastern Standard Time' AS DATE))-1, 0)             END       set @EndDate  = case when DATEPART(DAY,CONVERT(DATE,CAST(GETDATE() AT TIME ZONE 'UTC' AT TIME ZONE 'Eastern Standard Time' AS DATE))) <> 1           then DATEADD(DAY, DATEDIFF(DAY, 0, CAST(GETDATE()-1 AT TIME ZONE 'UTC' AT TIME ZONE 'Eastern Standard Time' AS DATE)), 0)                    when DATEPART(DAY,CONVERT(DATE,CAST(GETDATE() AT TIME ZONE 'UTC' AT TIME ZONE 'Eastern Standard Time' AS DATE))) = 1           then DATEADD(MONTH, DATEDIFF(MONTH, -1, CAST(GETDATE() AT TIME ZONE 'UTC' AT TIME ZONE 'Eastern Standard Time' AS DATE))-1, -1)                   END    end        -- First day of year to current date    if @DateRange='YTD'    begin     set @StartDate = case when DATEPART(DAY,CONVERT(DATE,CAST(GETDATE() AT TIME ZONE 'UTC' AT TIME ZONE 'Eastern Standard Time' AS DATE))) = 1                                AND 
  -- EXEC bireports.sp_rpt_mitel_queue_stats_HA_MTD_SLA_Include_Weekend NULL,NULL,'P214','H' -- Today  -- EXEC bireports.sp_rpt_mitel_queue_stats_HA_MTD_SLA_Include_Weekend NULL,NULL,'P214','D' -- Yesterday  -- EXEC bireports.sp_rpt_mitel_queue_stats_HA_MTD_SLA_Include_Weekend NULL,NULL,'P214','W' -- Last Week  -- EXEC bireports.sp_rpt_mitel_queue_stats_HA_MTD_SLA_Include_Weekend NULL,NULL,'P214','M' -- Previous Month    -- EXEC bireports.sp_rpt_mitel_queue_stats_HA_MTD_SLA_Include_Weekend '04/13/2020','04/26/2020','P214',60,'X' -- Month To Date      CREATE proc [bireports].[sp_rpt_mitel_queue_stats_HA_MTD_SLA_Include_Weekend] (@Start_Date date, @End_Date date, @QueueID varchar(200), @SLA_Sec int, @DateRange char(5))  as     Declare @StartDate date;  Declare @EndDate date;                -- Custom Date Range    if @DateRange='X'    begin       set @StartDate =  @Start_Date                set @EndDate =  @End_Date             end          -- Returns previous day     if @DateRange='D'    begin     set @StartDate = DATEADD(DAY,-1,CONVERT(DATE,CAST(GETDATE() AT TIME ZONE 'UTC' AT TIME ZONE 'Eastern Standard Time' AS DATE)))                 set @EndDate =   DATEADD(DAY,-1,CONVERT(DATE,CAST(GETDATE() AT TIME ZONE 'UTC' AT TIME ZONE 'Eastern Standard Time' AS DATE)))              end          -- Returns previous day     if @DateRange='H'    begin     set @StartDate = CONVERT(DATE,CAST(GETDATE() AT TIME ZONE 'UTC' AT TIME ZONE 'Eastern Standard Time' AS DATE))                set @EndDate =   CONVERT(DATE,CAST(GETDATE() AT TIME ZONE 'UTC' AT TIME ZONE 'Eastern Standard Time' AS DATE))             end      -- Returns first and last day of previous month    if @DateRange='M'    begin     set @EndDate = dateadd(dd,-1,cast(cast(year(CAST(GETDATE() AT TIME ZONE 'UTC' AT TIME ZONE 'Eastern Standard Time' AS DATE)) as varchar(4))+'/'+cast(month(CAST(GETDATE() AT TIME ZONE 'UTC' AT TIME ZONE 'Eastern Standard Time' AS DATE)) as varchar(2))+'/1' as date))     set @StartDate = cast(cast(year(@EndDate) as varchar(4))+'/'+cast(month(@EndDate) as varchar(2))+'/1' as date);       end      -- Returns first and last day of previous week - first day of week starts with Sunday    if @DateRange='W'    begin     set @StartDate = DATEADD(wk, -1, DATEADD(DAY, 1-DATEPART(WEEKDAY, CAST(GETDATE() AT TIME ZONE 'UTC' AT TIME ZONE 'Eastern Standard Time' AS DATE)), DATEDIFF(dd, 0, CAST(GETDATE() AT TIME ZONE 'UTC' AT TIME ZONE 'Eastern Standard Time' AS DATE))))     set @EndDate = DATEADD(wk, 0, DATEADD(DAY, 0-DATEPART(WEEKDAY, CAST(GETDATE() AT TIME ZONE 'UTC' AT TIME ZONE 'Eastern Standard Time' AS DATE)), DATEDIFF(dd, 0, CAST(GETDATE() AT TIME ZONE 'UTC' AT TIME ZONE 'Eastern Standard Time' AS DATE))))    end        -- Returns first day and yesterday of the current month as start and end dates when run on any day except 1st day of any month, if run on 1st of any month gives first and last date of the previous month    -- Use this for reports that should include MTD data and runs every day in a month.    if @DateRange='MTD'    begin     set @StartDate = case when DATEPART(DAY,CONVERT(DATE,CAST(GETDATE() AT TIME ZONE 'UTC' AT TIME ZONE 'Eastern Standard Time' AS DATE))) <> 1           then DATEADD(MONTH, DATEDIFF(MONTH, 0, CAST(GETDATE() AT TIME ZONE 'UTC' AT TIME ZONE 'Eastern Standard Time' AS DATE)), 0)               when DATEPART(DAY,CONVERT(DATE,CAST(GETDATE() AT TIME ZONE 'UTC' AT TIME ZONE 'Eastern Standard Time' AS DATE))) = 1            then DATEADD(MONTH, DATEDIFF(MONTH, 0, CAST(GETDATE() AT TIME ZONE 'UTC' AT TIME ZONE 'Eastern Standard Time' AS DATE))-1, 0)             END       set @EndDate  = case when DATEPART(DAY,CONVERT(DATE,CAST(GETDATE() AT TIME ZONE 'UTC' AT TIME ZONE 'Eastern Standard Time' AS DATE))) <> 1           then DATEADD(DAY, DATEDIFF(DAY, 0, CAST(GETDATE()-1 AT TIME ZONE 'UTC' AT TIME ZONE 'Eastern Standard Time' AS DATE)), 0)                    when DATEPART(DAY,CONVERT(DATE,CAST(GETDATE() AT TIME ZONE 'UTC' AT TIME ZONE 'Eastern S
-- EXEC bireports.sp_rpt_managed_care_dashboard 'D'  -- EXEC bireports.sp_rpt_managed_care_dashboard 'M'    -- EXEC bireports.sp_rpt_managed_care_dashboard 'Y'   -- Do not run YTD unless really required    CREATE proc [bireports].[sp_rpt_managed_care_dashboard] (@DateRange char(1))  as         Declare @StartDate date;  Declare @EndDate date;      /*    -- Returns previous day when run on any weekday except Monday, date goes back to last Friday if it runs on Monday    -- Use this for reports to include previous day data and runs from Monday to Friday only    if @DateRange='D'    begin     set @StartDate = case when DATEPART(WEEKDAY,CONVERT(DATE,CAST(GETDATE() AT TIME ZONE 'UTC' AT TIME ZONE 'Eastern Standard Time' AS DATE))) <> 2            then DATEADD(DAY,-1,CONVERT(DATE,CAST(GETDATE() AT TIME ZONE 'UTC' AT TIME ZONE 'Eastern Standard Time' AS DATE)))            when DATEPART(WEEKDAY,CONVERT(DATE,CAST(GETDATE() AT TIME ZONE 'UTC' AT TIME ZONE 'Eastern Standard Time' AS DATE))) = 2                        then DATEADD(DAY,-3,CONVERT(DATE,CAST(GETDATE() AT TIME ZONE 'UTC' AT TIME ZONE 'Eastern Standard Time' AS DATE)))           END     set @EndDate = case when DATEPART(WEEKDAY,CONVERT(DATE,CAST(GETDATE() AT TIME ZONE 'UTC' AT TIME ZONE 'Eastern Standard Time' AS DATE))) <> 2            then DATEADD(DAY,-1,CONVERT(DATE,CAST(GETDATE() AT TIME ZONE 'UTC' AT TIME ZONE 'Eastern Standard Time' AS DATE)))            when DATEPART(WEEKDAY,CONVERT(DATE,CAST(GETDATE() AT TIME ZONE 'UTC' AT TIME ZONE 'Eastern Standard Time' AS DATE))) = 2                        then DATEADD(DAY,-3,CONVERT(DATE,CAST(GETDATE() AT TIME ZONE 'UTC' AT TIME ZONE 'Eastern Standard Time' AS DATE)))           END    end      -- Returns first day and yesterday of the current month as start and end dates when run on any day except 1st day of any month, if run on 1st of any month gives first and last date of the previous month    -- Use this for reports that should include MTD data and runs every day in a month.    if @DateRange='M'    begin     set @StartDate = case when DATEPART(DAY,CONVERT(DATE,CAST(GETDATE() AT TIME ZONE 'UTC' AT TIME ZONE 'Eastern Standard Time' AS DATE))) <> 1           then DATEADD(MONTH, DATEDIFF(MONTH, 0, CAST(GETDATE() AT TIME ZONE 'UTC' AT TIME ZONE 'Eastern Standard Time' AS DATE)), 0)             when DATEPART(DAY,CONVERT(DATE,CAST(GETDATE() AT TIME ZONE 'UTC' AT TIME ZONE 'Eastern Standard Time' AS DATE))) = 1            then  DATEADD(MONTH, DATEDIFF(MONTH, 0, CAST(GETDATE() AT TIME ZONE 'UTC' AT TIME ZONE 'Eastern Standard Time' AS DATE))-1, 0)             END     --set @StartDate='05/01/2019'     set @EndDate = case when (DATEPART(DAY,CONVERT(DATE,CAST(GETDATE() AT TIME ZONE 'UTC' AT TIME ZONE 'Eastern Standard Time' AS DATE))) <> 1) and (DATEPART(WEEKDAY,CONVERT(DATE,CAST(GETDATE() AT TIME ZONE 'UTC' AT TIME ZONE 'Eastern Standard Time' AS DATE))) <> 2)           then DATEADD(DAY, DATEDIFF(DAY, 0, CAST(GETDATE()-1 AT TIME ZONE 'UTC' AT TIME ZONE 'Eastern Standard Time' AS DATE)), 0)           when (DATEPART(DAY,CONVERT(DATE,CAST(GETDATE() AT TIME ZONE 'UTC' AT TIME ZONE 'Eastern Standard Time' AS DATE))) <> 1) and (DATEPART(WEEKDAY,CONVERT(DATE,CAST(GETDATE() AT TIME ZONE 'UTC' AT TIME ZONE 'Eastern Standard Time' AS DATE))) = 2)           then DATEADD(DAY, DATEDIFF(DAY, 0, CAST(GETDATE()-3 AT TIME ZONE 'UTC' AT TIME ZONE 'Eastern Standard Time' AS DATE)), 0)             when (DATEPART(DAY,CONVERT(DATE,CAST(GETDATE() AT TIME ZONE 'UTC' AT TIME ZONE 'Eastern Standard Time' AS DATE))) = 1) and (DATEPART(WEEKDAY,CONVERT(DATE,CAST(GETDATE() AT TIME ZONE 'UTC' AT TIME ZONE 'Eastern Standard Time' AS DATE))) <> 2)           then DATEADD(MONTH, DATEDIFF(MONTH, -1, CAST(GETDATE() AT TIME ZONE 'UTC' AT TIME ZONE 'Eastern Standard Time' AS DATE))-1, -1)          when (DATEPART(DAY,CONVERT(DATE,CAST(GETDATE() AT TIME ZONE 'UTC' AT TIME ZONE 'Eastern Standard Time' AS DATE))) = 1) and (DATEPART(WEEKDAY,CONVERT(DATE,CAST(GETDATE() AT TIME ZONE 'U
      --  EXEC [bireports].[sp_rpt_HA_Dashboard]   CREATE PROCEDURE [bireports].[sp_rpt_HA_Dashboard]   AS  BEGIN      -- Frist day of the year  DECLARE @FirstDayofYear DATE;  SET @FirstDayofYear =  CASE WHEN DATEPART(DAY,CONVERT(DATE,CAST(GETDATE() AT TIME ZONE 'UTC' AT TIME ZONE 'Eastern Standard Time' AS DATE))) = 1                                AND DATEPART(MONTH,CONVERT(DATE,CAST(GETDATE() AT TIME ZONE 'UTC' AT TIME ZONE 'Eastern Standard Time' AS DATE))) = 1            THEN CAST('01/01/' + CAST(DATEPART(YEAR,CONVERT(DATE,CAST(GETDATE()-1 AT TIME ZONE 'UTC' AT TIME ZONE 'Eastern Standard Time' AS DATE))) AS VARCHAR) AS DATE)               ELSE CAST('01/01/' + CAST(DATEPART(YEAR,CONVERT(DATE,CAST(GETDATE() AT TIME ZONE 'UTC' AT TIME ZONE 'Eastern Standard Time' AS DATE))) AS VARCHAR) AS DATE)              END  -- Todays Date  DECLARE @TodaysDate DATE;  SET @TodaysDate = CAST(GETDATE() AT TIME ZONE 'UTC' AT TIME ZONE 'Eastern Standard Time' AS DATE)    -- YTD Order detail data  --TRUNCATE TABLE [bireports].[BI_OrderDetail_Data_2020]    --INSERT INTO [bireports].[BI_OrderDetail_Data_2020]  --EXEC [bireports].[Order_Detail_Report_2020]    -- SELECT * FROM [bireports].[BI_OrderDetail_Data_2020] WHERE 1=1 AND [Status] IN ('ACTIVE')  AND [Source] NOT IN ('MemberPortal')         --DROP TABLE IF EXISTS #execreports_CallSummaryDetailsByDateHA  DROP TABLE IF EXISTS #HA_Appt_Details  DROP TABLE IF EXISTS #HA_Appt_Stats  DROP TABLE IF EXISTS #HA_Order_Stats  DROP TABLE IF EXISTS #HA_PMPM_Stats    ---- YTD CallConversation count by carrier (New Member Interaction in report) -- No longer required in HA Dashboard  -- select *   -- into #execreports_CallSummaryDetailsByDateHA   -- from execreports.CallSummaryDetailsByDateHA   -- where FORMAT(CAST(CALLDATE AS DATE),'yyyy') = FORMAT(CAST(GETDATE() AT TIME ZONE 'UTC'   AT TIME ZONE 'Eastern Standard Time' AS DATE),'yyyy')        -- YTD Hearing test appointments  SELECT p.memberchartdataid,p.InsuranceCarrierId, p.NHMemberID, p.AppointmentStatus, p.CreateDate AppointmentCreatedDate, p.AppointmentDate, ic.InsuranceCarrierName,p.AppointmentTypeName  INTO #HA_Appt_Details  FROM bireports.QTesting p  INNER JOIN insurance.insurancecarriers ic ON (p.insurancecarrierid = ic.insurancecarrierid)  WHERE 1=1  AND p.IsActive = 1  AND  InsuranceCarrierName <> 'Test'  AND p.InsuranceCarrierId NOT IN (216,218) -- Exclude Other & InComm OTC  AND  AppointmentStatus <> 'Virtual Test'  AND ( p.appointmentdate >= @FirstDayofYear OR p.createdate >= @FirstDayofYear )      --SELECT * FROM #HA_Appt_Details order by memberchartdataid    -- Appointments Summary  SELECT   InsuranceCarrierName  ,COUNT(DISTINCT CASE WHEN AppointmentCreatedDate = @TodaysDate THEN memberchartdataid ELSE NULL END) Appointments_Today  ,COUNT(DISTINCT CASE WHEN DATEPART(MM,AppointmentCreatedDate) = DATEPART(MM,@TodaysDate) THEN memberchartdataid ELSE NULL END) Appointments_MTD  ,COUNT(DISTINCT CASE WHEN DATEPART(YYYY,AppointmentCreatedDate) = DATEPART(YYYY,@TodaysDate) THEN memberchartdataid ELSE NULL END) Appointments_YTD  INTO #HA_Appt_Stats  FROM #HA_Appt_Details  GROUP BY InsuranceCarrierName     --SELECT * FROM [bireports].[BI_OrderDetail_Data_2020]    -- Orders Summary  SELECT  InsuranceCarrierName  -- Orders  ,COUNT(DISTINCT CASE WHEN ISNULL(HA_PODate,CROS_PODate) = @TodaysDate THEN OrderNumber ELSE NULL END) Orders_Today  ,COUNT(DISTINCT CASE WHEN DATEPART(MM,ISNULL(HA_PODate,CROS_PODate)) = DATEPART(MM,@TodaysDate) THEN OrderNumber ELSE NULL END) Orders_MTD  ,COUNT(DISTINCT CASE WHEN DATEPART(YYYY,ISNULL(HA_PODate,CROS_PODate)) = DATEPART(YYYY,@TodaysDate) THEN OrderNumber ELSE NULL END) Orders_YTD    -- Order Units  ,SUM(CASE WHEN ISNULL(HA_PODate,CROS_PODate) = @TodaysDate THEN Quantity ELSE NULL END) Units_Today  ,SUM(CASE WHEN DATEPART(MM,ISNULL(HA_PODate,CROS_PODate)) = DATEPART(MM,@TodaysDate) THEN Quantity ELSE NULL END) Units_MTD  ,SUM(CASE WHEN DATEPART(YYYY,ISNULL(HA_PODate,CROS_PODate)) = DATEPART(YYYY,@TodaysDate) THEN Qu
      --exec [bireports].[sp_AppVsOrders_rpt]    CREATE PROCEDURE [bireports].[sp_AppVsOrders_rpt]   AS  BEGIN    SELECT Z.InsuranceCarrierID    , Z.InsuranceCarrierName    , Z.AppointmentDate    , COUNT(Z.TestNHMemberId) AppCount    , SUM(ISNULL(Z.cnt,0)) AS DistinctOrderForMember    , PastFutureFlag    , COUNT(CASE WHEN PastFutureFlag = 'Past' THEN Z.TestNHMemberId END) AS PastAppCount    , SUM(CASE WHEN PastFutureFlag = 'Past' THEN ISNULL(Z.cnt,0) END ) AS PastDistinctOrderForMember    , COUNT(CASE WHEN PastFutureFlag = 'Future' THEN Z.TestNHMemberId END) AS FutureAppCount    , SUM(ISNULL(Z.OrderCnt,0)) AS SumOfOrdersForMember   INTO #temp  FROM (    SELECT   q.InsuranceCarrierID      ,ic.InsuranceCarrierName      ,q.AppointmentDate      ,q.NHMemberId TestNHMemberId      ,x.NHMemberId OrderNHMemberId      ,x.cnt      ,x.OrderCnt      ,CASE WHEN CAST(q.AppointmentDate AS DATE) <= CAST(GETDATE() AT TIME ZONE 'UTC'   AT TIME ZONE 'Eastern Standard Time' AS DATE) THEN 'Past' ELSE 'Future' END PastFutureFlag    FROM bireports.QTesting q    JOIN Insurance.InsuranceCarriers ic ON q.InsuranceCarrierID = ic.InsuranceCarrierID    LEFT JOIN (SELECT COUNT(DISTINCT oo.OrderID) OrderCnt, oo.NHMemberId, 1 AS cnt       FROM Orders.Orders oo       JOIN Orders.OrderPOs po ON oo.OrderID = po.OrderId       JOIN bireports.QTesting qq ON oo.NHMemberId = qq.NHMemberId       JOIN Insurance.InsuranceCarriers ic2 ON qq.InsuranceCarrierID = ic2.InsuranceCarrierID       WHERE 1=1       and oo.status <> 'RETURNED'       --AND ic2.InsuranceCarrierID = 270       --AND oo.NHMemberId ='NH202002235230'       and ic2.InsuranceCarrierName <> 'Test'       AND qq.appointmentdate >= cast('20200101' as date)       GROUP BY oo.NHMemberId) x ON x.NHMemberId = q.NHMemberId     where 1=1    AND ( q.appointmentdate >= cast('20200101' as date) ) --or q.createdate >= cast('20200101' as date) )    and ic.InsuranceCarrierName <> 'Test'    --AND ic.InsuranceCarrierID = 270   ) Z  GROUP BY Z.InsuranceCarrierID      , Z.InsuranceCarrierName      , Z.AppointmentDate      , PastFutureFlag  ORDER BY Z.InsuranceCarrierName    ,Z.AppointmentDate    SELECT 0 AS forOrder     ,'Grand Total'  AS DataDesc     ,0 AS InsuranceCarrierID     ,'Grand Total' AS InsuranceCarrierName     ,'01/01/1900' AS AppointmentDate     ,SUM(T.AppCount) AppCount     ,SUM(T.PastAppCount) PastAppCount     ,SUM(T.PastDistinctOrderForMember) PastDistinctOrderForMember     --,ROUND(100*SUM(T.PastDistinctOrderForMember)/SUM(T.PastAppCount),2) PerSuccess     ,SUM(T.FutureAppCount) FutureAppCount     ,SUM(T.DistinctOrderForMember) DistinctOrderForMember     ,SUM(T.SumOfOrdersForMember) SumOfOrdersForMember  FROM #temp t  --WHERE t.InsuranceCarrierID = 270  union  SELECT 1 AS forOrder     ,'Carrier Lvl'  AS DataDesc     ,T.InsuranceCarrierID     ,T.InsuranceCarrierName     ,'01/01/1900' AS AppointmentDate     ,SUM(T.AppCount) AppCount     ,SUM(T.PastAppCount) PastAppCount     ,SUM(ISNULL(T.PastDistinctOrderForMember,0)) PastDistinctOrderForMember     --,ROUND(100*SUM(T.PastDistinctOrderForMember)/SUM(T.PastAppCount),2) PerSuccess     ,SUM(T.FutureAppCount) FutureAppCount     ,SUM(T.DistinctOrderForMember) DistinctOrderForMember     ,SUM(T.SumOfOrdersForMember) SumOfOrdersForMember  FROM #temp t  --WHERE t.InsuranceCarrierID = 270  GROUP BY T.InsuranceCarrierID       ,T.InsuranceCarrierName  Union  SELECT 2     ,'Details'  AS DataDesc     ,T.InsuranceCarrierID     ,T.InsuranceCarrierName     ,T.AppointmentDate     ,T.AppCount     ,T.PastAppCount     ,ISNULL(T.PastDistinctOrderForMember,0) PastDistinctOrderForMember     --,ROUND(100*SUM(T.PastDistinctOrderForMember)/SUM(T.PastAppCount),2) PerSuccess     ,T.FutureAppCount     ,T.DistinctOrderForMember     ,T.SumOfOrdersForMember  FROM #temp t  --WHERE t.InsuranceCarrierID = 270  ORDER BY 1,4,5    drop table #temp  --exec [bireports].[sp_AppVsOrders_rpt]   END  
-- EXEC bireports.sp_rpt_otc_dashboard_2020 'D'  -- EXEC bireports.sp_rpt_otc_dashboard_2020 'M'  CREATE proc [bireports].[sp_rpt_otc_dashboard_2020] (@DateRange char(1))  as         Declare @StartDate date;  Declare @EndDate date;      /*    -- Returns previous day when run on any weekday except Monday, date goes back to last Friday if it runs on Monday    -- Use this for reports to include previous day data and runs from Monday to Friday only    if @DateRange='D'    begin     set @StartDate = case when DATEPART(WEEKDAY,CONVERT(DATE,CAST(GETDATE() AT TIME ZONE 'UTC' AT TIME ZONE 'Eastern Standard Time' AS DATE))) <> 2            then DATEADD(DAY,-1,CONVERT(DATE,CAST(GETDATE() AT TIME ZONE 'UTC' AT TIME ZONE 'Eastern Standard Time' AS DATE)))            when DATEPART(WEEKDAY,CONVERT(DATE,CAST(GETDATE() AT TIME ZONE 'UTC' AT TIME ZONE 'Eastern Standard Time' AS DATE))) = 2                        then DATEADD(DAY,-3,CONVERT(DATE,CAST(GETDATE() AT TIME ZONE 'UTC' AT TIME ZONE 'Eastern Standard Time' AS DATE)))           END     set @EndDate = case when DATEPART(WEEKDAY,CONVERT(DATE,CAST(GETDATE() AT TIME ZONE 'UTC' AT TIME ZONE 'Eastern Standard Time' AS DATE))) <> 2            then DATEADD(DAY,-1,CONVERT(DATE,CAST(GETDATE() AT TIME ZONE 'UTC' AT TIME ZONE 'Eastern Standard Time' AS DATE)))            when DATEPART(WEEKDAY,CONVERT(DATE,CAST(GETDATE() AT TIME ZONE 'UTC' AT TIME ZONE 'Eastern Standard Time' AS DATE))) = 2                        then DATEADD(DAY,-3,CONVERT(DATE,CAST(GETDATE() AT TIME ZONE 'UTC' AT TIME ZONE 'Eastern Standard Time' AS DATE)))           END    end      -- Returns first day and yesterday of the current month as start and end dates when run on any day except 1st day of any month, if run on 1st of any month gives first and last date of the previous month    -- Use this for reports that should include MTD data and runs every day in a month.    if @DateRange='M'    begin     set @StartDate = case when DATEPART(DAY,CONVERT(DATE,CAST(GETDATE() AT TIME ZONE 'UTC' AT TIME ZONE 'Eastern Standard Time' AS DATE))) <> 1           then DATEADD(MONTH, DATEDIFF(MONTH, 0, CAST(GETDATE() AT TIME ZONE 'UTC' AT TIME ZONE 'Eastern Standard Time' AS DATE)), 0)             when DATEPART(DAY,CONVERT(DATE,CAST(GETDATE() AT TIME ZONE 'UTC' AT TIME ZONE 'Eastern Standard Time' AS DATE))) = 1            then  DATEADD(MONTH, DATEDIFF(MONTH, 0, CAST(GETDATE() AT TIME ZONE 'UTC' AT TIME ZONE 'Eastern Standard Time' AS DATE))-1, 0)             END     --set @StartDate='05/01/2019'     set @EndDate = case when (DATEPART(DAY,CONVERT(DATE,CAST(GETDATE() AT TIME ZONE 'UTC' AT TIME ZONE 'Eastern Standard Time' AS DATE))) <> 1) and (DATEPART(WEEKDAY,CONVERT(DATE,CAST(GETDATE() AT TIME ZONE 'UTC' AT TIME ZONE 'Eastern Standard Time' AS DATE))) <> 2)           then DATEADD(DAY, DATEDIFF(DAY, 0, CAST(GETDATE()-1 AT TIME ZONE 'UTC' AT TIME ZONE 'Eastern Standard Time' AS DATE)), 0)           when (DATEPART(DAY,CONVERT(DATE,CAST(GETDATE() AT TIME ZONE 'UTC' AT TIME ZONE 'Eastern Standard Time' AS DATE))) <> 1) and (DATEPART(WEEKDAY,CONVERT(DATE,CAST(GETDATE() AT TIME ZONE 'UTC' AT TIME ZONE 'Eastern Standard Time' AS DATE))) = 2)           then DATEADD(DAY, DATEDIFF(DAY, 0, CAST(GETDATE()-3 AT TIME ZONE 'UTC' AT TIME ZONE 'Eastern Standard Time' AS DATE)), 0)             when (DATEPART(DAY,CONVERT(DATE,CAST(GETDATE() AT TIME ZONE 'UTC' AT TIME ZONE 'Eastern Standard Time' AS DATE))) = 1) and (DATEPART(WEEKDAY,CONVERT(DATE,CAST(GETDATE() AT TIME ZONE 'UTC' AT TIME ZONE 'Eastern Standard Time' AS DATE))) <> 2)           then DATEADD(MONTH, DATEDIFF(MONTH, -1, CAST(GETDATE() AT TIME ZONE 'UTC' AT TIME ZONE 'Eastern Standard Time' AS DATE))-1, -1)          when (DATEPART(DAY,CONVERT(DATE,CAST(GETDATE() AT TIME ZONE 'UTC' AT TIME ZONE 'Eastern Standard Time' AS DATE))) = 1) and (DATEPART(WEEKDAY,CONVERT(DATE,CAST(GETDATE() AT TIME ZONE 'UTC' AT TIME ZONE 'Eastern Standard Time' AS DATE))) = 2)           then DATEADD(DAY, DATEDIFF(DAY, 0, CAST(GETDA
  -- EXEC bireports.sp_rpt_mitel_queue_stats_hourly 'C','HA' -- Today HA  -- EXEC bireports.sp_rpt_mitel_queue_stats_hourly 'C','OTC' -- Today OTC    CREATE proc [bireports].[sp_rpt_mitel_queue_stats_hourly] (@DateRange char(5), @BenefitType char(10))  as         Declare @StartDate date;  Declare @EndDate date;        -- Returns previous day     if @DateRange='D'    begin     set @StartDate = DATEADD(DAY,-1,CONVERT(DATE,CAST(GETDATE() AT TIME ZONE 'UTC' AT TIME ZONE 'Eastern Standard Time' AS DATE)))                 set @EndDate =   DATEADD(DAY,-1,CONVERT(DATE,CAST(GETDATE() AT TIME ZONE 'UTC' AT TIME ZONE 'Eastern Standard Time' AS DATE)))              end      -- Returns current day     if @DateRange='C'    begin     set @StartDate = CAST(GETDATE() AT TIME ZONE 'UTC' AT TIME ZONE 'Eastern Standard Time' AS DATE)                 set @EndDate =   CAST(GETDATE() AT TIME ZONE 'UTC' AT TIME ZONE 'Eastern Standard Time' AS DATE)             end      -- Returns first and last day of previous month    if @DateRange='M'    begin     set @EndDate = dateadd(dd,-1,cast(cast(year(CAST(GETDATE() AT TIME ZONE 'UTC' AT TIME ZONE 'Eastern Standard Time' AS DATE)) as varchar(4))+'/'+cast(month(CAST(GETDATE() AT TIME ZONE 'UTC' AT TIME ZONE 'Eastern Standard Time' AS DATE)) as varchar(2))+'/1' as date))     set @StartDate = cast(cast(year(@EndDate) as varchar(4))+'/'+cast(month(@EndDate) as varchar(2))+'/1' as date);       end      -- Returns first and last day of previous week - first day of week starts with Sunday    if @DateRange='W'    begin     set @StartDate = DATEADD(wk, -1, DATEADD(DAY, 1-DATEPART(WEEKDAY, CAST(GETDATE() AT TIME ZONE 'UTC' AT TIME ZONE 'Eastern Standard Time' AS DATE)), DATEDIFF(dd, 0, CAST(GETDATE() AT TIME ZONE 'UTC' AT TIME ZONE 'Eastern Standard Time' AS DATE))))     set @EndDate = DATEADD(wk, 0, DATEADD(DAY, 0-DATEPART(WEEKDAY, CAST(GETDATE() AT TIME ZONE 'UTC' AT TIME ZONE 'Eastern Standard Time' AS DATE)), DATEDIFF(dd, 0, CAST(GETDATE() AT TIME ZONE 'UTC' AT TIME ZONE 'Eastern Standard Time' AS DATE))))    end        -- Returns first day and yesterday of the current month as start and end dates when run on any day except 1st day of any month, if run on 1st of any month gives first and last date of the previous month    -- Use this for reports that should include MTD data and runs every day in a month.    if @DateRange='MTD'    begin     set @StartDate = case when DATEPART(DAY,CONVERT(DATE,CAST(GETDATE() AT TIME ZONE 'UTC' AT TIME ZONE 'Eastern Standard Time' AS DATE))) <> 1           then DATEADD(MONTH, DATEDIFF(MONTH, 0, CAST(GETDATE() AT TIME ZONE 'UTC' AT TIME ZONE 'Eastern Standard Time' AS DATE)), 0)               when DATEPART(DAY,CONVERT(DATE,CAST(GETDATE() AT TIME ZONE 'UTC' AT TIME ZONE 'Eastern Standard Time' AS DATE))) = 1            then DATEADD(MONTH, DATEDIFF(MONTH, 0, CAST(GETDATE() AT TIME ZONE 'UTC' AT TIME ZONE 'Eastern Standard Time' AS DATE))-1, 0)             END       set @EndDate  = case when DATEPART(DAY,CONVERT(DATE,CAST(GETDATE() AT TIME ZONE 'UTC' AT TIME ZONE 'Eastern Standard Time' AS DATE))) <> 1           then DATEADD(DAY, DATEDIFF(DAY, 0, CAST(GETDATE()-1 AT TIME ZONE 'UTC' AT TIME ZONE 'Eastern Standard Time' AS DATE)), 0)                    when DATEPART(DAY,CONVERT(DATE,CAST(GETDATE() AT TIME ZONE 'UTC' AT TIME ZONE 'Eastern Standard Time' AS DATE))) = 1           then DATEADD(MONTH, DATEDIFF(MONTH, -1, CAST(GETDATE() AT TIME ZONE 'UTC' AT TIME ZONE 'Eastern Standard Time' AS DATE))-1, -1)                   END    end    --SELECT @StartDate  --SELECT @EndDate    --set @StartDate='12/01/2019';  --set @EndDate='12/31/2019';    -- EXEC bireports.sp_rpt_mitel_queue_stats 'D'      select   1 as Seq  ,@StartDate AS Start_Date  ,@EndDate AS End_Date  ,QueueReporting  ,isnull(qg.Name,REPLACE(REPLACE(QueueName,'1',''),'2','')) QueueName  ,sum(QueueOffered) ACD_Calls_Offered  ,sum(QueueAnswered) ACD_Calls_Handled  ,sum(QueueAbandoned) ACD_Calls_Abandoned_Long  ,sum(QueueShortAbandoned) A
-- EXEC bireports.sp_rpt_managed_care_dashboard_2020_HA_Brand_TechLevel       CREATE proc [bireports].[sp_rpt_managed_care_dashboard_2020_HA_Brand_TechLevel]     as       Declare @MlyStartDate date;  Declare @MlyEndDate date;         set @MlyStartDate = case when DATEPART(DAY,CONVERT(DATE,CAST(GETDATE() AT TIME ZONE 'UTC' AT TIME ZONE 'Eastern Standard Time' AS DATE))) <> 1           then DATEADD(MONTH, DATEDIFF(MONTH, 0, CAST(GETDATE() AT TIME ZONE 'UTC' AT TIME ZONE 'Eastern Standard Time' AS DATE)), 0)               when DATEPART(DAY,CONVERT(DATE,CAST(GETDATE() AT TIME ZONE 'UTC' AT TIME ZONE 'Eastern Standard Time' AS DATE))) = 1            then DATEADD(MONTH, DATEDIFF(MONTH, 0, CAST(GETDATE() AT TIME ZONE 'UTC' AT TIME ZONE 'Eastern Standard Time' AS DATE))-1, 0)             END       set @MlyEndDate  = case when DATEPART(DAY,CONVERT(DATE,CAST(GETDATE() AT TIME ZONE 'UTC' AT TIME ZONE 'Eastern Standard Time' AS DATE))) <> 1           then DATEADD(DAY, DATEDIFF(DAY, 0, CAST(GETDATE()-1 AT TIME ZONE 'UTC' AT TIME ZONE 'Eastern Standard Time' AS DATE)), 0)                    when DATEPART(DAY,CONVERT(DATE,CAST(GETDATE() AT TIME ZONE 'UTC' AT TIME ZONE 'Eastern Standard Time' AS DATE))) = 1           then DATEADD(MONTH, DATEDIFF(MONTH, -1, CAST(GETDATE() AT TIME ZONE 'UTC' AT TIME ZONE 'Eastern Standard Time' AS DATE))-1, -1)                   END       --set @MlyStartDate='01/01/2020';  --set @MlyEndDate='01/04/2020';    -- EXEC bireports.sp_rpt_managed_care_dashboard_2020_HA_Brand_TechLevel       -- 2020 Active Plans - Monthly  select m.MitelQueueID  ,m.MitelQueueName  ,v.OrderID,v.[Device Count],v.Brand  ,case when o.TechnologyLevel is null then 'NA' else o.TechnologyLevel end TechnologyLevel  ,v.ItemCode  ,m.CRMCarrierName,v.[Insurance Carrier Name],v.[Plan or Program Name]  from [ReportsData].[4_CRMOrders] v with (nolock)  left join ReportsData.[7_viewAccountingNEW3] o with (nolock) on (o.OrderNumber = v.OrderID)  join (               select *               from bireports.MitelQueue_CRMCarrier_Mapping_2020      WHERE 1=1     and IsActive=1     and BenefitType='HA'      )  m on (CASE WHEN v.[Plan or Program Name] = 'HAP UAW Trust VEBA' THEN 'HAP UAW Trust VEBA' else v.[Insurance Carrier Name] END = m.CRMCarrierName)  where 1=1  and CAST(v.[Date Approved]  AS DATE) between @MlyStartDate and @MlyEndDate  and v.[Status Code] not in ('','CAN')  and v.[Order Type] = 'NEW'  and v.Status = 'ACTIVE'  and (v.[Insurance Carrier Name] is not null or v.[Insurance Carrier Name] <> 'NULL')  and v.[Insurance Carrier Name] <> 'Anthem Funded'  order by v.OrderID
  -- exec [bireports].[Order_Detail_Report_2020]    CREATE PROC [bireports].[Order_Detail_Report_2020_bkp_20200924_before_ClaimAmount]  AS    drop table if EXISTS #temp_fin_order_detail_report_2020      DROP TABLE IF EXISTS #FittingFee_CTE  DROP TABLE IF EXISTS #MemberPrice_CTE  DROP TABLE IF EXISTS #TechnologyLevel_CTE  DROP TABLE IF EXISTS #COGS_CTE  DROP TABLE IF EXISTS #Fin_OrdDt_PO  DROP TABLE IF EXISTS #Fin_OrdDt_PO_Type      SELECT DISTINCT HealthPlanContractID, ItemCode, EffectiveFrom, EffectiveTo, UnitPrice, PairPrice  INTO #FittingFee_CTE  FROM benefits.FittingFeeHistory with (NOLOCK)      SELECT DISTINCT HealthPlanContractID, ItemCode, EffectiveFrom, EffectiveTo, UnitPrice, PairPrice  INTO #MemberPrice_CTE  FROM benefits.MemberPriceHistory with (NOLOCK)      SELECT DISTINCT HealthPlanContractID, ItemCode, EffectiveFrom, EffectiveTo, UnitPrice  INTO #TechnologyLevel_CTE  FROM benefits.TechnologyLevelHistory with (NOLOCK)      SELECT DISTINCT ItemCode,pricetype,effectivefrom,effectiveto,unitcogs,paircogs  INTO #COGS_CTE   FROM catalog.ItemMasterPriceList  with (NOLOCK)  WHERE IsActive=1      SELECT DISTINCT e.OrderId,  LEFT(r.PONumber , LEN(r.PONumber)-1) PONumber,  LEFT(s.PODate , LEN(s.PODate)-1) PODate  INTO #Fin_OrdDt_PO  FROM orders.OrderPOs e with (nolock)  CROSS APPLY  (   SELECT CAST(r.PONumber as varchar(20)) + ', '   FROM orders.OrderPOs r with (nolock)   WHERE e.OrderId = r.OrderId         FOR XML PATH('')  ) r (PONumber)  CROSS APPLY  (   SELECT CAST(CAST(s.CreateDate AT TIME ZONE 'UTC' AT TIME ZONE 'Eastern Standard Time' AS DATE) AS VARCHAR(20)) + ', '     -- SELECT cast(s.PODate as varchar(20)) + ', '   FROM orders.OrderPOs s with (nolock)   WHERE e.OrderId = s.OrderId         FOR XML PATH('')  ) s (PODate)      SELECT DISTINCT ph.PONumber,hc.ItemType,ph.OrderId,CAST(CAST(ph.CreateDate AT TIME ZONE 'UTC' AT TIME ZONE 'Eastern Standard Time' AS DATE) AS VARCHAR(20)) PODate  --SELECT DISTINCT ph.PONumber,ph.OrderId,cast(ph.PODate as varchar(20)) PODate  INTO #Fin_OrdDt_PO_Type  FROM orders.OrderPOs ph  with (nolock)  JOIN orders.OrderItems hc with (nolock) ON (hc.PONumber=ph.PONumber AND hc.ItemType IN ('HA','CROS','EM') AND hc.IsActive=1)      -- Orders with only PO  SELECT DISTINCT  o.NHMemberId  ,o.OrderID [OrderNumber]  ,CAST(o.DateOrderReceived AS DATE) [DateOrderReceived]  ,CASE WHEN DATEPART(HOUR,o.DateOrderInitiated)=0 AND DATEPART(MINUTE,o.DateOrderInitiated)=0 AND DATEPART(SECOND,o.DateOrderInitiated) =0 THEN CAST(o.DateOrderInitiated AS DATE)             ELSE CAST(CAST(o.DateOrderInitiated AT TIME ZONE 'UTC' AT TIME ZONE 'Eastern Standard Time' AS DATETIME) AS DATE) END [OrderCreatedDate]  ,CASE WHEN ISNULL(o.OrderType,'')='EXCHANGE' THEN 'NEW' ELSE o.OrderType END AS [OrderType] -- EXCHANGE should be NEW  ,CASE WHEN ISNULL(o.OrderType,'') IN ('EXCHANGE','LSandD') THEN o.RefOrderId ELSE NULL END AS [ReferenceOrder] -- Only for EXCHANGE & LSandD orders if available  ,o.Status  ,c.InsuranceCarrierName  ,CAST(JSON_VALUE(o.MemberData,'$.insCarrierId') AS INT) AS InsuranceCarrierID  ,hp.HealthPlanName InsuranceHealthPlanName  ,CAST(JSON_VALUE(o.MemberData,'$.insPlanId') AS INT) AS InsuranceHealthPlanID  -- From Orders JSON  --,CASE WHEN JSON_VALUE(o.MemberData, '$.insurance.carrierName') = 'None' OR JSON_VALUE(o.MemberData, '$.insurance.carrierName') = '' THEN JSON_VALUE(o.MemberData, '$.insurance.programeName')  --      ELSE JSON_VALUE(o.MemberData, '$.insurance.carrierName') END AS 'CarrierName_JSON'  --,JSON_VALUE(o.MemberData, '$.insurance.planName') AS 'PlanName_JSON'  --  ,JSON_VALUE(o.MemberData,'$.firstName') AS [MemberFirstName]  ,JSON_VALUE(o.MemberData,'$.lastName') AS [MemberLastName]    ,JSON_VALUE(o.ProviderData,'$.providerId') AS [ProviderID]  --,JSON_VALUE(o.ProviderData,'$.address.locationId') AS [LocationID]    ,pp.ProviderName AS [ProviderLegalName]  ,ISNULL(CASE WHEN pp.DBA='' THEN NULL ELSE pp.DBA END,l.BusinessName) AS [ProviderDBA] -- Take location name if provider DBA is not 
-- EXEC bireports.sp_rpt_managed_care_dashboard_2020   -- EXEC bireports.sp_rpt_managed_care_dashboard_2020     -- EXEC bireports.sp_rpt_managed_care_dashboard_2020 'Y'   -- Do not run YTD unless really required    CREATE proc [bireports].[sp_rpt_managed_care_dashboard_2020]   --(@DateRange char(1))  as         Declare @DlyStartDate date;  Declare @DlyEndDate date;    Declare @MlyStartDate date;  Declare @MlyEndDate date;      /*    -- Returns previous day when run on any weekday except Monday, date goes back to last Friday if it runs on Monday    -- Use this for reports to include previous day data and runs from Monday to Friday only    if @DateRange='D'    begin     set @DlyStartDate = case when DATEPART(WEEKDAY,CONVERT(DATE,CAST(GETDATE() AT TIME ZONE 'UTC' AT TIME ZONE 'Eastern Standard Time' AS DATE))) <> 2            then DATEADD(DAY,-1,CONVERT(DATE,CAST(GETDATE() AT TIME ZONE 'UTC' AT TIME ZONE 'Eastern Standard Time' AS DATE)))            when DATEPART(WEEKDAY,CONVERT(DATE,CAST(GETDATE() AT TIME ZONE 'UTC' AT TIME ZONE 'Eastern Standard Time' AS DATE))) = 2                        then DATEADD(DAY,-3,CONVERT(DATE,CAST(GETDATE() AT TIME ZONE 'UTC' AT TIME ZONE 'Eastern Standard Time' AS DATE)))           END     set @DlyEndDate = case when DATEPART(WEEKDAY,CONVERT(DATE,CAST(GETDATE() AT TIME ZONE 'UTC' AT TIME ZONE 'Eastern Standard Time' AS DATE))) <> 2            then DATEADD(DAY,-1,CONVERT(DATE,CAST(GETDATE() AT TIME ZONE 'UTC' AT TIME ZONE 'Eastern Standard Time' AS DATE)))            when DATEPART(WEEKDAY,CONVERT(DATE,CAST(GETDATE() AT TIME ZONE 'UTC' AT TIME ZONE 'Eastern Standard Time' AS DATE))) = 2                        then DATEADD(DAY,-3,CONVERT(DATE,CAST(GETDATE() AT TIME ZONE 'UTC' AT TIME ZONE 'Eastern Standard Time' AS DATE)))           END    end      -- Returns first day and yesterday of the current month as start and end dates when run on any day except 1st day of any month, if run on 1st of any month gives first and last date of the previous month    -- Use this for reports that should include MTD data and runs every day in a month.    if @DateRange='M'    begin     set @DlyStartDate = case when DATEPART(DAY,CONVERT(DATE,CAST(GETDATE() AT TIME ZONE 'UTC' AT TIME ZONE 'Eastern Standard Time' AS DATE))) <> 1           then DATEADD(MONTH, DATEDIFF(MONTH, 0, CAST(GETDATE() AT TIME ZONE 'UTC' AT TIME ZONE 'Eastern Standard Time' AS DATE)), 0)             when DATEPART(DAY,CONVERT(DATE,CAST(GETDATE() AT TIME ZONE 'UTC' AT TIME ZONE 'Eastern Standard Time' AS DATE))) = 1            then  DATEADD(MONTH, DATEDIFF(MONTH, 0, CAST(GETDATE() AT TIME ZONE 'UTC' AT TIME ZONE 'Eastern Standard Time' AS DATE))-1, 0)             END     --set @DlyStartDate='05/01/2019'     set @DlyEndDate = case when (DATEPART(DAY,CONVERT(DATE,CAST(GETDATE() AT TIME ZONE 'UTC' AT TIME ZONE 'Eastern Standard Time' AS DATE))) <> 1) and (DATEPART(WEEKDAY,CONVERT(DATE,CAST(GETDATE() AT TIME ZONE 'UTC' AT TIME ZONE 'Eastern Standard Time' AS DATE))) <> 2)           then DATEADD(DAY, DATEDIFF(DAY, 0, CAST(GETDATE()-1 AT TIME ZONE 'UTC' AT TIME ZONE 'Eastern Standard Time' AS DATE)), 0)           when (DATEPART(DAY,CONVERT(DATE,CAST(GETDATE() AT TIME ZONE 'UTC' AT TIME ZONE 'Eastern Standard Time' AS DATE))) <> 1) and (DATEPART(WEEKDAY,CONVERT(DATE,CAST(GETDATE() AT TIME ZONE 'UTC' AT TIME ZONE 'Eastern Standard Time' AS DATE))) = 2)           then DATEADD(DAY, DATEDIFF(DAY, 0, CAST(GETDATE()-3 AT TIME ZONE 'UTC' AT TIME ZONE 'Eastern Standard Time' AS DATE)), 0)             when (DATEPART(DAY,CONVERT(DATE,CAST(GETDATE() AT TIME ZONE 'UTC' AT TIME ZONE 'Eastern Standard Time' AS DATE))) = 1) and (DATEPART(WEEKDAY,CONVERT(DATE,CAST(GETDATE() AT TIME ZONE 'UTC' AT TIME ZONE 'Eastern Standard Time' AS DATE))) <> 2)           then DATEADD(MONTH, DATEDIFF(MONTH, -1, CAST(GETDATE() AT TIME ZONE 'UTC' AT TIME ZONE 'Eastern Standard Time' AS DATE))-1, -1)          when (DATEPART(DAY,CONVERT(DATE,CAST(GETDATE() AT TIME ZONE 'UTC' AT TIME ZONE 'Eastern
  -- EXEC [bireports].[sp_rpt_OTC_Order_Detail] NULL,NULL,'YTD'  -- EXEC [bireports].[sp_rpt_OTC_Order_Detail] NULL,NULL,'MTD'  -- EXEC [bireports].[sp_rpt_OTC_Order_Detail] '01/01/2020','12/06/2020','X'    CREATE proc [bireports].[sp_rpt_OTC_Order_Detail] (@Start_Date date, @End_Date date,@DateRange char(5))  as         Declare @StartDate date;  Declare @EndDate date;        -- Custom Date Range    if @DateRange='X'    begin       set @StartDate =  @Start_Date                set @EndDate =  @End_Date             end          -- Returns previous day     if @DateRange='D'    begin     set @StartDate = DATEADD(DAY,-1,CONVERT(DATE,CAST(GETDATE() AT TIME ZONE 'UTC' AT TIME ZONE 'Eastern Standard Time' AS DATE)))                 set @EndDate =   DATEADD(DAY,-1,CONVERT(DATE,CAST(GETDATE() AT TIME ZONE 'UTC' AT TIME ZONE 'Eastern Standard Time' AS DATE)))              end      -- Returns first and last day of previous month    if @DateRange='M'    begin     set @EndDate = dateadd(dd,-1,cast(cast(year(CAST(GETDATE() AT TIME ZONE 'UTC' AT TIME ZONE 'Eastern Standard Time' AS DATE)) as varchar(4))+'/'+cast(month(CAST(GETDATE() AT TIME ZONE 'UTC' AT TIME ZONE 'Eastern Standard Time' AS DATE)) as varchar(2))+'/1' as date))     set @StartDate = cast(cast(year(@EndDate) as varchar(4))+'/'+cast(month(@EndDate) as varchar(2))+'/1' as date);       end      -- Returns first and last day of previous week - first day of week starts with Sunday    if @DateRange='W'    begin     set @StartDate = DATEADD(wk, -1, DATEADD(DAY, 1-DATEPART(WEEKDAY, CAST(GETDATE() AT TIME ZONE 'UTC' AT TIME ZONE 'Eastern Standard Time' AS DATE)), DATEDIFF(dd, 0, CAST(GETDATE() AT TIME ZONE 'UTC' AT TIME ZONE 'Eastern Standard Time' AS DATE))))     set @EndDate = DATEADD(wk, 0, DATEADD(DAY, 0-DATEPART(WEEKDAY, CAST(GETDATE() AT TIME ZONE 'UTC' AT TIME ZONE 'Eastern Standard Time' AS DATE)), DATEDIFF(dd, 0, CAST(GETDATE() AT TIME ZONE 'UTC' AT TIME ZONE 'Eastern Standard Time' AS DATE))))    end        -- Returns first day and yesterday of the current month as start and end dates when run on any day except 1st day of any month, if run on 1st of any month gives first and last date of the previous month    -- Use this for reports that should include MTD data and runs every day in a month.    if @DateRange='MTD'    begin     set @StartDate = case when DATEPART(DAY,CONVERT(DATE,CAST(GETDATE() AT TIME ZONE 'UTC' AT TIME ZONE 'Eastern Standard Time' AS DATE))) <> 1           then DATEADD(MONTH, DATEDIFF(MONTH, 0, CAST(GETDATE() AT TIME ZONE 'UTC' AT TIME ZONE 'Eastern Standard Time' AS DATE)), 0)               when DATEPART(DAY,CONVERT(DATE,CAST(GETDATE() AT TIME ZONE 'UTC' AT TIME ZONE 'Eastern Standard Time' AS DATE))) = 1            then DATEADD(MONTH, DATEDIFF(MONTH, 0, CAST(GETDATE() AT TIME ZONE 'UTC' AT TIME ZONE 'Eastern Standard Time' AS DATE))-1, 0)             END       set @EndDate  = case when DATEPART(DAY,CONVERT(DATE,CAST(GETDATE() AT TIME ZONE 'UTC' AT TIME ZONE 'Eastern Standard Time' AS DATE))) <> 1           then DATEADD(DAY, DATEDIFF(DAY, 0, CAST(GETDATE()-1 AT TIME ZONE 'UTC' AT TIME ZONE 'Eastern Standard Time' AS DATE)), 0)                    when DATEPART(DAY,CONVERT(DATE,CAST(GETDATE() AT TIME ZONE 'UTC' AT TIME ZONE 'Eastern Standard Time' AS DATE))) = 1           then DATEADD(MONTH, DATEDIFF(MONTH, -1, CAST(GETDATE() AT TIME ZONE 'UTC' AT TIME ZONE 'Eastern Standard Time' AS DATE))-1, -1)                   END    end        -- First day of year to current date    if @DateRange='YTD'    begin     set @StartDate = case when DATEPART(DAY,CONVERT(DATE,CAST(GETDATE() AT TIME ZONE 'UTC' AT TIME ZONE 'Eastern Standard Time' AS DATE))) = 1                                AND DATEPART(MONTH,CONVERT(DATE,CAST(GETDATE() AT TIME ZONE 'UTC' AT TIME ZONE 'Eastern Standard Time' AS DATE))) = 1            then CAST('01/01/' + CAST(DATEPART(YEAR,CONVERT(DATE,CAST(GETDATE()-1 AT TIME ZONE 'UTC' AT TIME ZONE 'Eastern Standard Time' AS DATE))) AS VARCHAR) AS DATE)         
-- EXEC bireports.sp_rpt_otc_dashboard 'D'  -- EXEC bireports.sp_rpt_otc_dashboard 'M'  CREATE proc [bireports].[sp_rpt_otc_dashboard] (@DateRange char(1))  as         Declare @StartDate date;  Declare @EndDate date;      /*    -- Returns previous day when run on any weekday except Monday, date goes back to last Friday if it runs on Monday    -- Use this for reports to include previous day data and runs from Monday to Friday only    if @DateRange='D'    begin     set @StartDate = case when DATEPART(WEEKDAY,CONVERT(DATE,CAST(GETDATE() AT TIME ZONE 'UTC' AT TIME ZONE 'Eastern Standard Time' AS DATE))) <> 2            then DATEADD(DAY,-1,CONVERT(DATE,CAST(GETDATE() AT TIME ZONE 'UTC' AT TIME ZONE 'Eastern Standard Time' AS DATE)))            when DATEPART(WEEKDAY,CONVERT(DATE,CAST(GETDATE() AT TIME ZONE 'UTC' AT TIME ZONE 'Eastern Standard Time' AS DATE))) = 2                        then DATEADD(DAY,-3,CONVERT(DATE,CAST(GETDATE() AT TIME ZONE 'UTC' AT TIME ZONE 'Eastern Standard Time' AS DATE)))           END     set @EndDate = case when DATEPART(WEEKDAY,CONVERT(DATE,CAST(GETDATE() AT TIME ZONE 'UTC' AT TIME ZONE 'Eastern Standard Time' AS DATE))) <> 2            then DATEADD(DAY,-1,CONVERT(DATE,CAST(GETDATE() AT TIME ZONE 'UTC' AT TIME ZONE 'Eastern Standard Time' AS DATE)))            when DATEPART(WEEKDAY,CONVERT(DATE,CAST(GETDATE() AT TIME ZONE 'UTC' AT TIME ZONE 'Eastern Standard Time' AS DATE))) = 2                        then DATEADD(DAY,-3,CONVERT(DATE,CAST(GETDATE() AT TIME ZONE 'UTC' AT TIME ZONE 'Eastern Standard Time' AS DATE)))           END    end      -- Returns first day and yesterday of the current month as start and end dates when run on any day except 1st day of any month, if run on 1st of any month gives first and last date of the previous month    -- Use this for reports that should include MTD data and runs every day in a month.    if @DateRange='M'    begin     set @StartDate = case when DATEPART(DAY,CONVERT(DATE,CAST(GETDATE() AT TIME ZONE 'UTC' AT TIME ZONE 'Eastern Standard Time' AS DATE))) <> 1           then DATEADD(MONTH, DATEDIFF(MONTH, 0, CAST(GETDATE() AT TIME ZONE 'UTC' AT TIME ZONE 'Eastern Standard Time' AS DATE)), 0)             when DATEPART(DAY,CONVERT(DATE,CAST(GETDATE() AT TIME ZONE 'UTC' AT TIME ZONE 'Eastern Standard Time' AS DATE))) = 1            then  DATEADD(MONTH, DATEDIFF(MONTH, 0, CAST(GETDATE() AT TIME ZONE 'UTC' AT TIME ZONE 'Eastern Standard Time' AS DATE))-1, 0)             END     --set @StartDate='05/01/2019'     set @EndDate = case when (DATEPART(DAY,CONVERT(DATE,CAST(GETDATE() AT TIME ZONE 'UTC' AT TIME ZONE 'Eastern Standard Time' AS DATE))) <> 1) and (DATEPART(WEEKDAY,CONVERT(DATE,CAST(GETDATE() AT TIME ZONE 'UTC' AT TIME ZONE 'Eastern Standard Time' AS DATE))) <> 2)           then DATEADD(DAY, DATEDIFF(DAY, 0, CAST(GETDATE()-1 AT TIME ZONE 'UTC' AT TIME ZONE 'Eastern Standard Time' AS DATE)), 0)           when (DATEPART(DAY,CONVERT(DATE,CAST(GETDATE() AT TIME ZONE 'UTC' AT TIME ZONE 'Eastern Standard Time' AS DATE))) <> 1) and (DATEPART(WEEKDAY,CONVERT(DATE,CAST(GETDATE() AT TIME ZONE 'UTC' AT TIME ZONE 'Eastern Standard Time' AS DATE))) = 2)           then DATEADD(DAY, DATEDIFF(DAY, 0, CAST(GETDATE()-3 AT TIME ZONE 'UTC' AT TIME ZONE 'Eastern Standard Time' AS DATE)), 0)             when (DATEPART(DAY,CONVERT(DATE,CAST(GETDATE() AT TIME ZONE 'UTC' AT TIME ZONE 'Eastern Standard Time' AS DATE))) = 1) and (DATEPART(WEEKDAY,CONVERT(DATE,CAST(GETDATE() AT TIME ZONE 'UTC' AT TIME ZONE 'Eastern Standard Time' AS DATE))) <> 2)           then DATEADD(MONTH, DATEDIFF(MONTH, -1, CAST(GETDATE() AT TIME ZONE 'UTC' AT TIME ZONE 'Eastern Standard Time' AS DATE))-1, -1)          when (DATEPART(DAY,CONVERT(DATE,CAST(GETDATE() AT TIME ZONE 'UTC' AT TIME ZONE 'Eastern Standard Time' AS DATE))) = 1) and (DATEPART(WEEKDAY,CONVERT(DATE,CAST(GETDATE() AT TIME ZONE 'UTC' AT TIME ZONE 'Eastern Standard Time' AS DATE))) = 2)           then DATEADD(DAY, DATEDIFF(DAY, 0, CAST(GETDATE()-3 AT TIME 
--exec [bireports].[sp_EligFileLoadSummary_rpt]   CREATE PROCEDURE [bireports].[sp_EligFileLoadSummary_rpt]   AS  BEGIN    create table #temp_Clients (highVisibilityClientOrder int,         RollUpClientCode varchar(10),         RollUpClientName varchar(100),         RollUpClientStatus varchar(10),         tempFileLoaded varchar(20))    insert into #temp_Clients select 0,'H427','CCA','YES','YES'  insert into #temp_Clients select 1,'H337','AvMed','YES','YES'  insert into #temp_Clients select 2,'H223','Blue Cross Blue Shield Rhode Island','YES','YES'  insert into #temp_Clients select 3,'H229','Capital Blue Cross','YES','YES'  insert into #temp_Clients select 4,'H335','Capital Blue VIBRA','YES','YES'  insert into #temp_Clients select 5,'H369','Central Health Plan','YES','YES'  insert into #temp_Clients select 6,'H225','Chinese Community Health Plan (CCHP)','YES','YES'  insert into #temp_Clients select 7,'H339','Clear Spring Health','YES','YES'  insert into #temp_Clients select 8,'H347','CommunityCare Oklahoma (CCOK)','YES','YES'  insert into #temp_Clients select 9,'H227','GlobalHealth','YES','YES'  insert into #temp_Clients select 10,'H376','HAP','YES','YES'  insert into #temp_Clients select 11,'H332','Healthfirst','YES','YES'  insert into #temp_Clients select 12,'NA','IBEW 241','YES','NO'  insert into #temp_Clients select 13,'H349','Legacy Assurance','YES','YES'  insert into #temp_Clients select 14,'H346','Optima','YES','YES'  insert into #temp_Clients select 15,'H343','Provider Partners Health Plan','YES','YES'  insert into #temp_Clients select 16,'H342','Reliance Healthcare','YES','YES'  insert into #temp_Clients select 17,'H373','Saginaw UA Local 85','YES','YES'  insert into #temp_Clients select 18,'H348','Troy Medicare','YES','YES'  insert into #temp_Clients select 19,'NA','UA LOCAL 653','YES','NO'  insert into #temp_Clients select 20,'H368','Ultimate Health Plans','YES','YES'  insert into #temp_Clients select 21,'H377','University of Maryland','YES','YES'  insert into #temp_Clients select 22,'H344','Zing','YES','YES'  insert into #temp_Clients select 23,'NA','Connecticare','NA','NO'  insert into #temp_Clients select 24,'NA','Emblem','NA','NO'  insert into #temp_Clients select 25,'NA','Express Scripts','NA','NO'  insert into #temp_Clients select 26,'NA','Federal Employee Programs','NA','NO'  insert into #temp_Clients select 27,'NA','Health Net','NA','NO'  insert into #temp_Clients select 28,'NA','Home Link','NA','NO'  insert into #temp_Clients select 29,'NA','Humana Inc.','NA','NO'  insert into #temp_Clients select 30,'NA','One Call','NA','NO'  insert into #temp_Clients select 31,'NA','Orchid','NA','NO'  insert into #temp_Clients select 32,'NA','Procura','NA','NO'  insert into #temp_Clients select 33,'NA','Silverscript','NA','NO'    select C.highVisibilityClientOrder    ,C.RollUpClientCode    ,C.RollUpClientName    ,C.RollUpClientStatus    ,C.tempFileLoaded    ,CC.ClientCode    ,CC.ClientName    ,CC.DataSource    ,CC.FileName    ,CC.FileFormat    ,CC.SnapshotFlag    ,CC.Frequency    ,CC.FileInfoID   into #temp_final  from #temp_Clients C  LEFT JOIN (     select  cc.ClientCode       ,cc.ClientName       ,cc.DataSource        ,fi.FileName       ,fi.FileFormat       ,fi.SnapshotFlag       ,fi.Frequency       ,fi.FileInfoID     from elig.ClientCodes cc     join elig.FileInfo fi on cc.ClientCode = fi.ClientCode     where 1=1     and fi.Direction = 'IN'     and fi.FileType ='ELIG'     and fi.isActive = 1       )CC ON C.RollUpClientCode = CC.ClientCode  where 1=1  order by 1      select --a.*,'******' as junk,b.*   --/*        a.highVisibilityClientOrder     ,a.RollUpClientCode as ClientCode    ,a.FileInfoID    ,a.RollUpClientName as ClientName    ,a.RollUpClientStatus as ClientStatus    ,a.tempFileLoaded as FileLoadedStatus    --,a.ClientCode    --,a.ClientName    --,a.DataSource    --,a.FileName    ,a.FileFormat as FileType    ,a.SnapshotFlag    --,substring(a.Frequency,1,3) as Frequency    ,(select splitdata from ( select splitid
  -- EXEC bireports.sp_rpt_mitel_queue_stats_hourly_bkp_20201209_before_QG_Change 'C','HA' -- Today HA  -- EXEC bireports.sp_rpt_mitel_queue_stats_hourly_bkp_20201209_before_QG_Change 'C','OTC' -- Today OTC    CREATE proc [bireports].[sp_rpt_mitel_queue_stats_hourly_bkp_20201209_before_QG_Change] (@DateRange char(5), @BenefitType char(10))  as         Declare @StartDate date;  Declare @EndDate date;        -- Returns previous day     if @DateRange='D'    begin     set @StartDate = DATEADD(DAY,-1,CONVERT(DATE,CAST(GETDATE() AT TIME ZONE 'UTC' AT TIME ZONE 'Eastern Standard Time' AS DATE)))                 set @EndDate =   DATEADD(DAY,-1,CONVERT(DATE,CAST(GETDATE() AT TIME ZONE 'UTC' AT TIME ZONE 'Eastern Standard Time' AS DATE)))              end      -- Returns current day     if @DateRange='C'    begin     set @StartDate = CAST(GETDATE() AT TIME ZONE 'UTC' AT TIME ZONE 'Eastern Standard Time' AS DATE)                 set @EndDate =   CAST(GETDATE() AT TIME ZONE 'UTC' AT TIME ZONE 'Eastern Standard Time' AS DATE)             end      -- Returns first and last day of previous month    if @DateRange='M'    begin     set @EndDate = dateadd(dd,-1,cast(cast(year(CAST(GETDATE() AT TIME ZONE 'UTC' AT TIME ZONE 'Eastern Standard Time' AS DATE)) as varchar(4))+'/'+cast(month(CAST(GETDATE() AT TIME ZONE 'UTC' AT TIME ZONE 'Eastern Standard Time' AS DATE)) as varchar(2))+'/1' as date))     set @StartDate = cast(cast(year(@EndDate) as varchar(4))+'/'+cast(month(@EndDate) as varchar(2))+'/1' as date);       end      -- Returns first and last day of previous week - first day of week starts with Sunday    if @DateRange='W'    begin     set @StartDate = DATEADD(wk, -1, DATEADD(DAY, 1-DATEPART(WEEKDAY, CAST(GETDATE() AT TIME ZONE 'UTC' AT TIME ZONE 'Eastern Standard Time' AS DATE)), DATEDIFF(dd, 0, CAST(GETDATE() AT TIME ZONE 'UTC' AT TIME ZONE 'Eastern Standard Time' AS DATE))))     set @EndDate = DATEADD(wk, 0, DATEADD(DAY, 0-DATEPART(WEEKDAY, CAST(GETDATE() AT TIME ZONE 'UTC' AT TIME ZONE 'Eastern Standard Time' AS DATE)), DATEDIFF(dd, 0, CAST(GETDATE() AT TIME ZONE 'UTC' AT TIME ZONE 'Eastern Standard Time' AS DATE))))    end        -- Returns first day and yesterday of the current month as start and end dates when run on any day except 1st day of any month, if run on 1st of any month gives first and last date of the previous month    -- Use this for reports that should include MTD data and runs every day in a month.    if @DateRange='MTD'    begin     set @StartDate = case when DATEPART(DAY,CONVERT(DATE,CAST(GETDATE() AT TIME ZONE 'UTC' AT TIME ZONE 'Eastern Standard Time' AS DATE))) <> 1           then DATEADD(MONTH, DATEDIFF(MONTH, 0, CAST(GETDATE() AT TIME ZONE 'UTC' AT TIME ZONE 'Eastern Standard Time' AS DATE)), 0)               when DATEPART(DAY,CONVERT(DATE,CAST(GETDATE() AT TIME ZONE 'UTC' AT TIME ZONE 'Eastern Standard Time' AS DATE))) = 1            then DATEADD(MONTH, DATEDIFF(MONTH, 0, CAST(GETDATE() AT TIME ZONE 'UTC' AT TIME ZONE 'Eastern Standard Time' AS DATE))-1, 0)             END       set @EndDate  = case when DATEPART(DAY,CONVERT(DATE,CAST(GETDATE() AT TIME ZONE 'UTC' AT TIME ZONE 'Eastern Standard Time' AS DATE))) <> 1           then DATEADD(DAY, DATEDIFF(DAY, 0, CAST(GETDATE()-1 AT TIME ZONE 'UTC' AT TIME ZONE 'Eastern Standard Time' AS DATE)), 0)                    when DATEPART(DAY,CONVERT(DATE,CAST(GETDATE() AT TIME ZONE 'UTC' AT TIME ZONE 'Eastern Standard Time' AS DATE))) = 1           then DATEADD(MONTH, DATEDIFF(MONTH, -1, CAST(GETDATE() AT TIME ZONE 'UTC' AT TIME ZONE 'Eastern Standard Time' AS DATE))-1, -1)                   END    end    --SELECT @StartDate  --SELECT @EndDate    --set @StartDate='12/01/2019';  --set @EndDate='12/31/2019';    -- EXEC bireports.sp_rpt_mitel_queue_stats 'D'    select   1 as Seq  ,@StartDate AS Start_Date  ,@EndDate AS End_Date  ,QueueReporting  ,isnull(REPLACE(qg.Name,'_QG',''),QueueName) QueueName,sum(QueueOffered) ACD_Calls_Offered  ,sum(QueueAnswered) ACD_Calls_Handled  ,s
  -- EXEC [bireports].[sp_rpt_OTC_Order_Item_Detail] NULL,NULL,'YTD'  -- EXEC [bireports].[sp_rpt_OTC_Order_Item_Detail] NULL,NULL,'MTD'  -- EXEC [bireports].[sp_rpt_OTC_Order_Item_Detail] '11/01/2020','11/30/2020','X'    CREATE proc [bireports].[sp_rpt_OTC_Order_Item_Detail] (@Start_Date date, @End_Date date,@DateRange char(5))  as         Declare @StartDate date;  Declare @EndDate date;        -- Custom Date Range    if @DateRange='X'    begin       set @StartDate =  @Start_Date                set @EndDate =  @End_Date             end          -- Returns previous day     if @DateRange='D'    begin     set @StartDate = DATEADD(DAY,-1,CONVERT(DATE,CAST(GETDATE() AT TIME ZONE 'UTC' AT TIME ZONE 'Eastern Standard Time' AS DATE)))                 set @EndDate =   DATEADD(DAY,-1,CONVERT(DATE,CAST(GETDATE() AT TIME ZONE 'UTC' AT TIME ZONE 'Eastern Standard Time' AS DATE)))              end      -- Returns first and last day of previous month    if @DateRange='M'    begin     set @EndDate = dateadd(dd,-1,cast(cast(year(CAST(GETDATE() AT TIME ZONE 'UTC' AT TIME ZONE 'Eastern Standard Time' AS DATE)) as varchar(4))+'/'+cast(month(CAST(GETDATE() AT TIME ZONE 'UTC' AT TIME ZONE 'Eastern Standard Time' AS DATE)) as varchar(2))+'/1' as date))     set @StartDate = cast(cast(year(@EndDate) as varchar(4))+'/'+cast(month(@EndDate) as varchar(2))+'/1' as date);       end      -- Returns first and last day of previous week - first day of week starts with Sunday    if @DateRange='W'    begin     set @StartDate = DATEADD(wk, -1, DATEADD(DAY, 1-DATEPART(WEEKDAY, CAST(GETDATE() AT TIME ZONE 'UTC' AT TIME ZONE 'Eastern Standard Time' AS DATE)), DATEDIFF(dd, 0, CAST(GETDATE() AT TIME ZONE 'UTC' AT TIME ZONE 'Eastern Standard Time' AS DATE))))     set @EndDate = DATEADD(wk, 0, DATEADD(DAY, 0-DATEPART(WEEKDAY, CAST(GETDATE() AT TIME ZONE 'UTC' AT TIME ZONE 'Eastern Standard Time' AS DATE)), DATEDIFF(dd, 0, CAST(GETDATE() AT TIME ZONE 'UTC' AT TIME ZONE 'Eastern Standard Time' AS DATE))))    end        -- Returns first day and yesterday of the current month as start and end dates when run on any day except 1st day of any month, if run on 1st of any month gives first and last date of the previous month    -- Use this for reports that should include MTD data and runs every day in a month.    if @DateRange='MTD'    begin     set @StartDate = case when DATEPART(DAY,CONVERT(DATE,CAST(GETDATE() AT TIME ZONE 'UTC' AT TIME ZONE 'Eastern Standard Time' AS DATE))) <> 1           then DATEADD(MONTH, DATEDIFF(MONTH, 0, CAST(GETDATE() AT TIME ZONE 'UTC' AT TIME ZONE 'Eastern Standard Time' AS DATE)), 0)               when DATEPART(DAY,CONVERT(DATE,CAST(GETDATE() AT TIME ZONE 'UTC' AT TIME ZONE 'Eastern Standard Time' AS DATE))) = 1            then DATEADD(MONTH, DATEDIFF(MONTH, 0, CAST(GETDATE() AT TIME ZONE 'UTC' AT TIME ZONE 'Eastern Standard Time' AS DATE))-1, 0)             END       set @EndDate  = case when DATEPART(DAY,CONVERT(DATE,CAST(GETDATE() AT TIME ZONE 'UTC' AT TIME ZONE 'Eastern Standard Time' AS DATE))) <> 1           then DATEADD(DAY, DATEDIFF(DAY, 0, CAST(GETDATE()-1 AT TIME ZONE 'UTC' AT TIME ZONE 'Eastern Standard Time' AS DATE)), 0)                    when DATEPART(DAY,CONVERT(DATE,CAST(GETDATE() AT TIME ZONE 'UTC' AT TIME ZONE 'Eastern Standard Time' AS DATE))) = 1           then DATEADD(MONTH, DATEDIFF(MONTH, -1, CAST(GETDATE() AT TIME ZONE 'UTC' AT TIME ZONE 'Eastern Standard Time' AS DATE))-1, -1)                   END    end        -- First day of year to current date    if @DateRange='YTD'    begin     set @StartDate = case when DATEPART(DAY,CONVERT(DATE,CAST(GETDATE() AT TIME ZONE 'UTC' AT TIME ZONE 'Eastern Standard Time' AS DATE))) = 1                                AND DATEPART(MONTH,CONVERT(DATE,CAST(GETDATE() AT TIME ZONE 'UTC' AT TIME ZONE 'Eastern Standard Time' AS DATE))) = 1            then CAST('01/01/' + CAST(DATEPART(YEAR,CONVERT(DATE,CAST(GETDATE()-1 AT TIME ZONE 'UTC' AT TIME ZONE 'Eastern Standard Time' AS DATE))) AS VARCHA
  -- EXEC bireports.sp_rpt_mitel_queue_stats_HA_MTD_Include_Weekend NULL,NULL,'P214','H' -- Today  -- EXEC bireports.sp_rpt_mitel_queue_stats_HA_MTD_Include_Weekend NULL,NULL,'P214','D' -- Yesterday  -- EXEC bireports.sp_rpt_mitel_queue_stats_HA_MTD_Include_Weekend NULL,NULL,'P214','W' -- Last Week  -- EXEC bireports.sp_rpt_mitel_queue_stats_HA_MTD_Include_Weekend NULL,NULL,'P214','M' -- Previous Month  -- EXEC bireports.sp_rpt_mitel_queue_stats_HA_MTD_Include_Weekend '04/01/2020','04/21/2020','P102','MTD' -- Month To Date  -- EXEC bireports.sp_rpt_mitel_queue_stats_HA_MTD_Include_Weekend NULL,NULL,'P279','MTD' -- Previous Month      -- EXEC bireports.sp_rpt_mitel_queue_stats_HA_MTD_Include_Weekend '01/01/2020','01/31/2020','P180','X' -- Jan 2020  -- EXEC bireports.sp_rpt_mitel_queue_stats_HA_MTD_Include_Weekend '02/01/2020','02/29/2020','P180','X' -- Feb 2020  -- EXEC bireports.sp_rpt_mitel_queue_stats_HA_MTD_Include_Weekend '03/01/2020','03/09/2020','P180','X' -- Mar 2020    CREATE proc [bireports].[sp_rpt_mitel_queue_stats_HA_MTD_Include_Weekend_bkp_20200831_before_QueueGroup] (@Start_Date date, @End_Date date, @QueueID varchar(200), @DateRange char(5))  as     Declare @StartDate date;  Declare @EndDate date;                -- Custom Date Range    if @DateRange='X'    begin       set @StartDate =  @Start_Date                set @EndDate =  @End_Date             end          -- Returns previous day     if @DateRange='D'    begin     set @StartDate = DATEADD(DAY,-1,CONVERT(DATE,CAST(GETDATE() AT TIME ZONE 'UTC' AT TIME ZONE 'Eastern Standard Time' AS DATE)))                 set @EndDate =   DATEADD(DAY,-1,CONVERT(DATE,CAST(GETDATE() AT TIME ZONE 'UTC' AT TIME ZONE 'Eastern Standard Time' AS DATE)))              end          -- Returns previous day     if @DateRange='H'    begin     set @StartDate = CONVERT(DATE,CAST(GETDATE() AT TIME ZONE 'UTC' AT TIME ZONE 'Eastern Standard Time' AS DATE))                set @EndDate =   CONVERT(DATE,CAST(GETDATE() AT TIME ZONE 'UTC' AT TIME ZONE 'Eastern Standard Time' AS DATE))             end      -- Returns first and last day of previous month    if @DateRange='M'    begin     set @EndDate = dateadd(dd,-1,cast(cast(year(CAST(GETDATE() AT TIME ZONE 'UTC' AT TIME ZONE 'Eastern Standard Time' AS DATE)) as varchar(4))+'/'+cast(month(CAST(GETDATE() AT TIME ZONE 'UTC' AT TIME ZONE 'Eastern Standard Time' AS DATE)) as varchar(2))+'/1' as date))     set @StartDate = cast(cast(year(@EndDate) as varchar(4))+'/'+cast(month(@EndDate) as varchar(2))+'/1' as date);       end      -- Returns first and last day of previous week - first day of week starts with Sunday    if @DateRange='W'    begin     set @StartDate = DATEADD(wk, -1, DATEADD(DAY, 1-DATEPART(WEEKDAY, CAST(GETDATE() AT TIME ZONE 'UTC' AT TIME ZONE 'Eastern Standard Time' AS DATE)), DATEDIFF(dd, 0, CAST(GETDATE() AT TIME ZONE 'UTC' AT TIME ZONE 'Eastern Standard Time' AS DATE))))     set @EndDate = DATEADD(wk, 0, DATEADD(DAY, 0-DATEPART(WEEKDAY, CAST(GETDATE() AT TIME ZONE 'UTC' AT TIME ZONE 'Eastern Standard Time' AS DATE)), DATEDIFF(dd, 0, CAST(GETDATE() AT TIME ZONE 'UTC' AT TIME ZONE 'Eastern Standard Time' AS DATE))))    end        -- Returns first day and yesterday of the current month as start and end dates when run on any day except 1st day of any month, if run on 1st of any month gives first and last date of the previous month    -- Use this for reports that should include MTD data and runs every day in a month.    if @DateRange='MTD'    begin     set @StartDate = case when DATEPART(DAY,CONVERT(DATE,CAST(GETDATE() AT TIME ZONE 'UTC' AT TIME ZONE 'Eastern Standard Time' AS DATE))) <> 1           then DATEADD(MONTH, DATEDIFF(MONTH, 0, CAST(GETDATE() AT TIME ZONE 'UTC' AT TIME ZONE 'Eastern Standard Time' AS DATE)), 0)               when DATEPART(DAY,CONVERT(DATE,CAST(GETDATE() AT TIME ZONE 'UTC' AT TIME ZONE 'Eastern Standard Time' AS DATE))) = 1            then DATEADD(MONTH, DATEDIFF(MONTH, 0, CAST(GETDATE() AT TIME ZONE 'UTC' AT TI
  -- EXEC bireports.sp_rpt_mitel_queue_stats_HA_MTD NULL,NULL,'P214','H' -- Today  -- EXEC bireports.sp_rpt_mitel_queue_stats_HA_MTD NULL,NULL,'P214','D' -- Yesterday  -- EXEC bireports.sp_rpt_mitel_queue_stats_HA_MTD NULL,NULL,'P214','W' -- Last Week  -- EXEC bireports.sp_rpt_mitel_queue_stats_HA_MTD NULL,NULL,'P214','M' -- Previous Month  -- EXEC bireports.sp_rpt_mitel_queue_stats_HA_MTD '02/01/2020','02/29/2020','P180','MTD' -- Month To Date      -- EXEC bireports.sp_rpt_mitel_queue_stats_HA_MTD '01/01/2020','01/31/2020','P180','X' -- Jan 2020  -- EXEC bireports.sp_rpt_mitel_queue_stats_HA_MTD '02/01/2020','02/29/2020','P180','X' -- Feb 2020  -- EXEC bireports.sp_rpt_mitel_queue_stats_HA_MTD '03/01/2020','03/09/2020','P180','X' -- Mar 2020    CREATE proc [bireports].[sp_rpt_mitel_queue_stats_HA_MTD_bkp_20200831_before_QueueGroup] (@Start_Date date, @End_Date date, @QueueID varchar(200), @DateRange char(5))  as     Declare @StartDate date;  Declare @EndDate date;                -- Custom Date Range    if @DateRange='X'    begin       set @StartDate =  @Start_Date                set @EndDate =  @End_Date             end          -- Returns previous day     if @DateRange='D'    begin     set @StartDate = DATEADD(DAY,-1,CONVERT(DATE,CAST(GETDATE() AT TIME ZONE 'UTC' AT TIME ZONE 'Eastern Standard Time' AS DATE)))                 set @EndDate =   DATEADD(DAY,-1,CONVERT(DATE,CAST(GETDATE() AT TIME ZONE 'UTC' AT TIME ZONE 'Eastern Standard Time' AS DATE)))              end          -- Returns previous day     if @DateRange='H'    begin     set @StartDate = CONVERT(DATE,CAST(GETDATE() AT TIME ZONE 'UTC' AT TIME ZONE 'Eastern Standard Time' AS DATE))                set @EndDate =   CONVERT(DATE,CAST(GETDATE() AT TIME ZONE 'UTC' AT TIME ZONE 'Eastern Standard Time' AS DATE))             end      -- Returns first and last day of previous month    if @DateRange='M'    begin     set @EndDate = dateadd(dd,-1,cast(cast(year(CAST(GETDATE() AT TIME ZONE 'UTC' AT TIME ZONE 'Eastern Standard Time' AS DATE)) as varchar(4))+'/'+cast(month(CAST(GETDATE() AT TIME ZONE 'UTC' AT TIME ZONE 'Eastern Standard Time' AS DATE)) as varchar(2))+'/1' as date))     set @StartDate = cast(cast(year(@EndDate) as varchar(4))+'/'+cast(month(@EndDate) as varchar(2))+'/1' as date);       end      -- Returns first and last day of previous week - first day of week starts with Sunday    if @DateRange='W'    begin     set @StartDate = DATEADD(wk, -1, DATEADD(DAY, 1-DATEPART(WEEKDAY, CAST(GETDATE() AT TIME ZONE 'UTC' AT TIME ZONE 'Eastern Standard Time' AS DATE)), DATEDIFF(dd, 0, CAST(GETDATE() AT TIME ZONE 'UTC' AT TIME ZONE 'Eastern Standard Time' AS DATE))))     set @EndDate = DATEADD(wk, 0, DATEADD(DAY, 0-DATEPART(WEEKDAY, CAST(GETDATE() AT TIME ZONE 'UTC' AT TIME ZONE 'Eastern Standard Time' AS DATE)), DATEDIFF(dd, 0, CAST(GETDATE() AT TIME ZONE 'UTC' AT TIME ZONE 'Eastern Standard Time' AS DATE))))    end        -- Returns first day and yesterday of the current month as start and end dates when run on any day except 1st day of any month, if run on 1st of any month gives first and last date of the previous month    -- Use this for reports that should include MTD data and runs every day in a month.    if @DateRange='MTD'    begin     set @StartDate = case when DATEPART(DAY,CONVERT(DATE,CAST(GETDATE() AT TIME ZONE 'UTC' AT TIME ZONE 'Eastern Standard Time' AS DATE))) <> 1           then DATEADD(MONTH, DATEDIFF(MONTH, 0, CAST(GETDATE() AT TIME ZONE 'UTC' AT TIME ZONE 'Eastern Standard Time' AS DATE)), 0)               when DATEPART(DAY,CONVERT(DATE,CAST(GETDATE() AT TIME ZONE 'UTC' AT TIME ZONE 'Eastern Standard Time' AS DATE))) = 1            then DATEADD(MONTH, DATEDIFF(MONTH, 0, CAST(GETDATE() AT TIME ZONE 'UTC' AT TIME ZONE 'Eastern Standard Time' AS DATE))-1, 0)             END       set @EndDate  = case when DATEPART(DAY,CONVERT(DATE,CAST(GETDATE() AT TIME ZONE 'UTC' AT TIME ZONE 'Eastern Standard Time' AS DATE))) <> 1           then DATEADD(DAY, DATEDIFF(DAY, 0
  -- EXEC bireports.sp_rpt_Appointment_Detail_Report NULL,NULL,'D',277 -- Yesterday  -- EXEC bireports.sp_rpt_Appointment_Detail_Report NULL,NULL,'M',277 -- Previous Month  -- EXEC bireports.sp_rpt_Appointment_Detail_Report NULL,NULL,'MTD',277 -- Month To Date  -- EXEC bireports.sp_rpt_Appointment_Detail_Report NULL,NULL,'YTD',277 -- Year To Date until today  -- EXEC bireports.sp_rpt_Appointment_Detail_Report '01/01/2020','04/15/2020','X',277 -- Year To Date including today      CREATE proc [bireports].[sp_rpt_Appointment_Detail_Report] (@Start_Date date, @End_Date date, @DateRange char(5), @CarrierID int)  as     --SET DATEFIRST 1;  -- Week starts with Monday instead of Sunday    Declare @StartDate date;  Declare @EndDate date;                -- Custom Date Range    if @DateRange='X'    begin       set @StartDate =  @Start_Date                set @EndDate =  @End_Date             end          -- Returns previous day     if @DateRange='D'    begin     set @StartDate = DATEADD(DAY,-1,CONVERT(DATE,CAST(GETDATE() AT TIME ZONE 'UTC' AT TIME ZONE 'Eastern Standard Time' AS DATE)))                 set @EndDate =   DATEADD(DAY,-1,CONVERT(DATE,CAST(GETDATE() AT TIME ZONE 'UTC' AT TIME ZONE 'Eastern Standard Time' AS DATE)))              end      -- Returns first and last day of previous month    if @DateRange='M'    begin     set @EndDate = dateadd(dd,-1,cast(cast(year(CAST(GETDATE() AT TIME ZONE 'UTC' AT TIME ZONE 'Eastern Standard Time' AS DATE)) as varchar(4))+'/'+cast(month(CAST(GETDATE() AT TIME ZONE 'UTC' AT TIME ZONE 'Eastern Standard Time' AS DATE)) as varchar(2))+'/1' as date))     set @StartDate = cast(cast(year(@EndDate) as varchar(4))+'/'+cast(month(@EndDate) as varchar(2))+'/1' as date);       end      -- Returns first and last day of previous week - first day of week starts with Sunday    if @DateRange='W'    begin     set @StartDate = DATEADD(wk, -1, DATEADD(DAY, 1-DATEPART(WEEKDAY, CAST(GETDATE() AT TIME ZONE 'UTC' AT TIME ZONE 'Eastern Standard Time' AS DATE)), DATEDIFF(dd, 0, CAST(GETDATE() AT TIME ZONE 'UTC' AT TIME ZONE 'Eastern Standard Time' AS DATE))))     set @EndDate = DATEADD(wk, 0, DATEADD(DAY, 0-DATEPART(WEEKDAY, CAST(GETDATE() AT TIME ZONE 'UTC' AT TIME ZONE 'Eastern Standard Time' AS DATE)), DATEDIFF(dd, 0, CAST(GETDATE() AT TIME ZONE 'UTC' AT TIME ZONE 'Eastern Standard Time' AS DATE))))    end        -- Returns first day and yesterday of the current month as start and end dates when run on any day except 1st day of any month, if run on 1st of any month gives first and last date of the previous month    -- Use this for reports that should include MTD data and runs every day in a month.    if @DateRange='MTD'    begin     set @StartDate = case when DATEPART(DAY,CONVERT(DATE,CAST(GETDATE() AT TIME ZONE 'UTC' AT TIME ZONE 'Eastern Standard Time' AS DATE))) <> 1           then DATEADD(MONTH, DATEDIFF(MONTH, 0, CAST(GETDATE() AT TIME ZONE 'UTC' AT TIME ZONE 'Eastern Standard Time' AS DATE)), 0)               when DATEPART(DAY,CONVERT(DATE,CAST(GETDATE() AT TIME ZONE 'UTC' AT TIME ZONE 'Eastern Standard Time' AS DATE))) = 1            then DATEADD(MONTH, DATEDIFF(MONTH, 0, CAST(GETDATE() AT TIME ZONE 'UTC' AT TIME ZONE 'Eastern Standard Time' AS DATE))-1, 0)             END       set @EndDate  = case when DATEPART(DAY,CONVERT(DATE,CAST(GETDATE() AT TIME ZONE 'UTC' AT TIME ZONE 'Eastern Standard Time' AS DATE))) <> 1           then DATEADD(DAY, DATEDIFF(DAY, 0, CAST(GETDATE()-1 AT TIME ZONE 'UTC' AT TIME ZONE 'Eastern Standard Time' AS DATE)), 0)                    when DATEPART(DAY,CONVERT(DATE,CAST(GETDATE() AT TIME ZONE 'UTC' AT TIME ZONE 'Eastern Standard Time' AS DATE))) = 1           then DATEADD(MONTH, DATEDIFF(MONTH, -1, CAST(GETDATE() AT TIME ZONE 'UTC' AT TIME ZONE 'Eastern Standard Time' AS DATE))-1, -1)                   END    end        -- First day of year to current date    if @DateRange='YTD'    begin     set @StartDate = case when DATEPART(DAY,CONVERT(DATE,CAST(GETDATE() AT TIME ZONE 'UTC' AT 
  -- EXEC bireports.sp_rpt_client_CCA_Utilization_Member_Spending NULL,NULL,'D' -- Yesterday  -- EXEC bireports.sp_rpt_client_CCA_Utilization_Member_Spending NULL,NULL,'M' -- Previous Month  -- EXEC bireports.sp_rpt_client_CCA_Utilization_Member_Spending NULL,NULL,'MTD' -- Month To Date  -- EXEC bireports.sp_rpt_client_CCA_Utilization_Member_Spending NULL,NULL,'YTD' -- Year To Date until current day  -- EXEC bireports.sp_rpt_client_CCA_Utilization_Member_Spending '01/01/2020','04/15/2020','X' -- Year To Date including current date      CREATE proc [bireports].[sp_rpt_client_CCA_Utilization_Member_Spending] (@Start_Date date, @End_Date date, @DateRange char(5))  as     Declare @StartDate date;  Declare @EndDate date;                -- Custom Date Range    if @DateRange='X'    begin       set @StartDate =  @Start_Date                set @EndDate =  @End_Date             end          -- Returns previous day     if @DateRange='D'    begin     set @StartDate = DATEADD(DAY,-1,CONVERT(DATE,CAST(GETDATE() AT TIME ZONE 'UTC' AT TIME ZONE 'Eastern Standard Time' AS DATE)))                 set @EndDate =   DATEADD(DAY,-1,CONVERT(DATE,CAST(GETDATE() AT TIME ZONE 'UTC' AT TIME ZONE 'Eastern Standard Time' AS DATE)))              end      -- Returns first and last day of previous month    if @DateRange='M'    begin     set @EndDate = dateadd(dd,-1,cast(cast(year(CAST(GETDATE() AT TIME ZONE 'UTC' AT TIME ZONE 'Eastern Standard Time' AS DATE)) as varchar(4))+'/'+cast(month(CAST(GETDATE() AT TIME ZONE 'UTC' AT TIME ZONE 'Eastern Standard Time' AS DATE)) as varchar(2))+'/1' as date))     set @StartDate = cast(cast(year(@EndDate) as varchar(4))+'/'+cast(month(@EndDate) as varchar(2))+'/1' as date);       end      -- Returns first and last day of previous week - first day of week starts with Sunday    if @DateRange='W'    begin     set @StartDate = DATEADD(wk, -1, DATEADD(DAY, 1-DATEPART(WEEKDAY, CAST(GETDATE() AT TIME ZONE 'UTC' AT TIME ZONE 'Eastern Standard Time' AS DATE)), DATEDIFF(dd, 0, CAST(GETDATE() AT TIME ZONE 'UTC' AT TIME ZONE 'Eastern Standard Time' AS DATE))))     set @EndDate = DATEADD(wk, 0, DATEADD(DAY, 0-DATEPART(WEEKDAY, CAST(GETDATE() AT TIME ZONE 'UTC' AT TIME ZONE 'Eastern Standard Time' AS DATE)), DATEDIFF(dd, 0, CAST(GETDATE() AT TIME ZONE 'UTC' AT TIME ZONE 'Eastern Standard Time' AS DATE))))    end        -- Returns first day and yesterday of the current month as start and end dates when run on any day except 1st day of any month, if run on 1st of any month gives first and last date of the previous month    -- Use this for reports that should include MTD data and runs every day in a month.    if @DateRange='MTD'    begin     set @StartDate = case when DATEPART(DAY,CONVERT(DATE,CAST(GETDATE() AT TIME ZONE 'UTC' AT TIME ZONE 'Eastern Standard Time' AS DATE))) <> 1           then DATEADD(MONTH, DATEDIFF(MONTH, 0, CAST(GETDATE() AT TIME ZONE 'UTC' AT TIME ZONE 'Eastern Standard Time' AS DATE)), 0)               when DATEPART(DAY,CONVERT(DATE,CAST(GETDATE() AT TIME ZONE 'UTC' AT TIME ZONE 'Eastern Standard Time' AS DATE))) = 1            then DATEADD(MONTH, DATEDIFF(MONTH, 0, CAST(GETDATE() AT TIME ZONE 'UTC' AT TIME ZONE 'Eastern Standard Time' AS DATE))-1, 0)             END       set @EndDate  = case when DATEPART(DAY,CONVERT(DATE,CAST(GETDATE() AT TIME ZONE 'UTC' AT TIME ZONE 'Eastern Standard Time' AS DATE))) <> 1           then DATEADD(DAY, DATEDIFF(DAY, 0, CAST(GETDATE()-1 AT TIME ZONE 'UTC' AT TIME ZONE 'Eastern Standard Time' AS DATE)), 0)                    when DATEPART(DAY,CONVERT(DATE,CAST(GETDATE() AT TIME ZONE 'UTC' AT TIME ZONE 'Eastern Standard Time' AS DATE))) = 1           then DATEADD(MONTH, DATEDIFF(MONTH, -1, CAST(GETDATE() AT TIME ZONE 'UTC' AT TIME ZONE 'Eastern Standard Time' AS DATE))-1, -1)                   END    end        -- First day of year to current date    if @DateRange='YTD'    begin     set @StartDate = case when DATEPART(DAY,CONVERT(DATE,CAST(GETDATE() AT TIME ZONE 'UTC' AT TIME ZONE 'Ea
  -- EXEC bireports.sp_rpt_pbi_otc_dashboard   CREATE proc [bireports].[sp_rpt_pbi_otc_dashboard]   as         select CAST(o.CreateDate AT TIME ZONE 'UTC' AT TIME ZONE 'Eastern Standard Time' AS DATE) OrderCreatedDate  ,o.OrderID,o.NHMemberId,o.OrderType,o.Status,o.OrderStatusCode  ,o.Amount OrderAmount  ,cast(JSON_VALUE(o.OrderAmountData,'$.price') as DECIMAL(10,2)) Price_J  ,cast(JSON_VALUE(o.OrderAmountData,'$.amountCovered') as DECIMAL(10,2)) AmountCovered_J  --,'&&&&&' OrderItemsData  --,oi.OrderId  ,oi.Total_OrderItems  ,oi.Total_OrderItems_Quantity  ,cast(oi.Total_OrderItems_Amount as decimal(10,2)) Total_OrderItems_Amount  --,c.NHMemberId  ,c.CardNumber,c.SerialNbr  --,l.SerialNumber  ,l.[Plan]  from orders.Orders o  left join (     select OrderId     ,count(distinct ItemCode) Total_OrderItems     ,sum(Quantity) Total_OrderItems_Quantity     ,sum(Amount) Total_OrderItems_Amount     from orders.OrderItems     where 1=1     and IsActive=1     GROUP by orderid         ) oi on (oi.OrderId=o.OrderID)  left join otc.Cards c on (c.NHMemberId=o.NHMemberId)  LEFT JOIN (               SELECT DISTINCT JSON_VALUE(h.Content, '$.flex_info."SERIAL-NUMBER"') as SerialNumber         ,JSON_VALUE(h.Content, '$.flex_info."PRODUCT-DESCRIPTION"') as [Plan]              FROM logs.HttpMessages h              WHERE h.Uri = 'externalserviceotc.azurewebsites.net/api/OTC/Transact/BenefitInquiry' AND h.Type = 'Response'     ) l ON l.SerialNumber = c.SerialNbr  where 1=1  --and o.CreateDate > getdate()-20  and o.OrderType='OTC'  and o.IsActive=1  and o.NHMemberId not like 'NH%'
  -- EXEC bireports.sp_rpt_client_CCA_Utilization_Order_Details NULL,NULL,'D' -- Yesterday  -- EXEC bireports.sp_rpt_client_CCA_Utilization_Order_Details NULL,NULL,'M' -- Previous Month  -- EXEC bireports.sp_rpt_client_CCA_Utilization_Order_Details NULL,NULL,'MTD' -- Month To Date  -- EXEC bireports.sp_rpt_client_CCA_Utilization_Order_Details NULL,NULL,'YTD' -- Year To Date until current day  -- EXEC bireports.sp_rpt_client_CCA_Utilization_Order_Details '01/01/2020','05/31/2020','X' -- Year To Date including current date      CREATE proc [bireports].[sp_rpt_client_CCA_Utilization_Order_Details] (@Start_Date date, @End_Date date, @DateRange char(5))  as     Declare @StartDate date;  Declare @EndDate date;                -- Custom Date Range    if @DateRange='X'    begin       set @StartDate =  @Start_Date                set @EndDate =  @End_Date             end          -- Returns previous day     if @DateRange='D'    begin     set @StartDate = DATEADD(DAY,-1,CONVERT(DATE,CAST(GETDATE() AT TIME ZONE 'UTC' AT TIME ZONE 'Eastern Standard Time' AS DATE)))                 set @EndDate =   DATEADD(DAY,-1,CONVERT(DATE,CAST(GETDATE() AT TIME ZONE 'UTC' AT TIME ZONE 'Eastern Standard Time' AS DATE)))              end      -- Returns first and last day of previous month    if @DateRange='M'    begin     set @EndDate = dateadd(dd,-1,cast(cast(year(CAST(GETDATE() AT TIME ZONE 'UTC' AT TIME ZONE 'Eastern Standard Time' AS DATE)) as varchar(4))+'/'+cast(month(CAST(GETDATE() AT TIME ZONE 'UTC' AT TIME ZONE 'Eastern Standard Time' AS DATE)) as varchar(2))+'/1' as date))     set @StartDate = cast(cast(year(@EndDate) as varchar(4))+'/'+cast(month(@EndDate) as varchar(2))+'/1' as date);       end      -- Returns first and last day of previous week - first day of week starts with Sunday    if @DateRange='W'    begin     set @StartDate = DATEADD(wk, -1, DATEADD(DAY, 1-DATEPART(WEEKDAY, CAST(GETDATE() AT TIME ZONE 'UTC' AT TIME ZONE 'Eastern Standard Time' AS DATE)), DATEDIFF(dd, 0, CAST(GETDATE() AT TIME ZONE 'UTC' AT TIME ZONE 'Eastern Standard Time' AS DATE))))     set @EndDate = DATEADD(wk, 0, DATEADD(DAY, 0-DATEPART(WEEKDAY, CAST(GETDATE() AT TIME ZONE 'UTC' AT TIME ZONE 'Eastern Standard Time' AS DATE)), DATEDIFF(dd, 0, CAST(GETDATE() AT TIME ZONE 'UTC' AT TIME ZONE 'Eastern Standard Time' AS DATE))))    end        -- Returns first day and yesterday of the current month as start and end dates when run on any day except 1st day of any month, if run on 1st of any month gives first and last date of the previous month    -- Use this for reports that should include MTD data and runs every day in a month.    if @DateRange='MTD'    begin     set @StartDate = case when DATEPART(DAY,CONVERT(DATE,CAST(GETDATE() AT TIME ZONE 'UTC' AT TIME ZONE 'Eastern Standard Time' AS DATE))) <> 1           then DATEADD(MONTH, DATEDIFF(MONTH, 0, CAST(GETDATE() AT TIME ZONE 'UTC' AT TIME ZONE 'Eastern Standard Time' AS DATE)), 0)               when DATEPART(DAY,CONVERT(DATE,CAST(GETDATE() AT TIME ZONE 'UTC' AT TIME ZONE 'Eastern Standard Time' AS DATE))) = 1            then DATEADD(MONTH, DATEDIFF(MONTH, 0, CAST(GETDATE() AT TIME ZONE 'UTC' AT TIME ZONE 'Eastern Standard Time' AS DATE))-1, 0)             END       set @EndDate  = case when DATEPART(DAY,CONVERT(DATE,CAST(GETDATE() AT TIME ZONE 'UTC' AT TIME ZONE 'Eastern Standard Time' AS DATE))) <> 1           then DATEADD(DAY, DATEDIFF(DAY, 0, CAST(GETDATE()-1 AT TIME ZONE 'UTC' AT TIME ZONE 'Eastern Standard Time' AS DATE)), 0)                    when DATEPART(DAY,CONVERT(DATE,CAST(GETDATE() AT TIME ZONE 'UTC' AT TIME ZONE 'Eastern Standard Time' AS DATE))) = 1           then DATEADD(MONTH, DATEDIFF(MONTH, -1, CAST(GETDATE() AT TIME ZONE 'UTC' AT TIME ZONE 'Eastern Standard Time' AS DATE))-1, -1)                   END    end        -- First day of year to current date    if @DateRange='YTD'    begin     set @StartDate = case when DATEPART(DAY,CONVERT(DATE,CAST(GETDATE() AT TIME ZONE 'UTC' AT TIME ZONE 'Eastern Standa
  -- EXEC [bireports].[sp_rpt_DHE_HearingTest_Details] NULL,NULL,'MTD'  -- EXEC [bireports].[sp_rpt_DHE_HearingTest_Details] NULL,NULL,'D'  -- EXEC [bireports].[sp_rpt_DHE_HearingTest_Details] NULL,NULL,'M'  -- EXEC [bireports].[sp_rpt_DHE_HearingTest_Details] '07/01/2020','07/25/2020','X'    CREATE proc [bireports].[sp_rpt_DHE_HearingTest_Details] (@Start_Date date, @End_Date date,@DateRange char(5))  as         Declare @StartDate date;  Declare @EndDate date;        -- Custom Date Range    if @DateRange='X'    begin       set @StartDate =  @Start_Date                set @EndDate =  @End_Date             end          -- Returns previous day     if @DateRange='D'    begin     set @StartDate = DATEADD(DAY,-1,CONVERT(DATE,CAST(GETDATE() AT TIME ZONE 'UTC' AT TIME ZONE 'Eastern Standard Time' AS DATE)))                 set @EndDate =   DATEADD(DAY,-1,CONVERT(DATE,CAST(GETDATE() AT TIME ZONE 'UTC' AT TIME ZONE 'Eastern Standard Time' AS DATE)))              end          -- Returns previous day     if @DateRange='H'    begin     set @StartDate = CONVERT(DATE,CAST(GETDATE() AT TIME ZONE 'UTC' AT TIME ZONE 'Eastern Standard Time' AS DATE))                set @EndDate =   CONVERT(DATE,CAST(GETDATE() AT TIME ZONE 'UTC' AT TIME ZONE 'Eastern Standard Time' AS DATE))             end      -- Returns first and last day of previous month    if @DateRange='M'    begin     set @EndDate = dateadd(dd,-1,cast(cast(year(CAST(GETDATE() AT TIME ZONE 'UTC' AT TIME ZONE 'Eastern Standard Time' AS DATE)) as varchar(4))+'/'+cast(month(CAST(GETDATE() AT TIME ZONE 'UTC' AT TIME ZONE 'Eastern Standard Time' AS DATE)) as varchar(2))+'/1' as date))     set @StartDate = cast(cast(year(@EndDate) as varchar(4))+'/'+cast(month(@EndDate) as varchar(2))+'/1' as date);       end      -- Returns first and last day of previous week - first day of week starts with Sunday    if @DateRange='W'    begin     set @StartDate = DATEADD(wk, -1, DATEADD(DAY, 1-DATEPART(WEEKDAY, CAST(GETDATE() AT TIME ZONE 'UTC' AT TIME ZONE 'Eastern Standard Time' AS DATE)), DATEDIFF(dd, 0, CAST(GETDATE() AT TIME ZONE 'UTC' AT TIME ZONE 'Eastern Standard Time' AS DATE))))     set @EndDate = DATEADD(wk, 0, DATEADD(DAY, 0-DATEPART(WEEKDAY, CAST(GETDATE() AT TIME ZONE 'UTC' AT TIME ZONE 'Eastern Standard Time' AS DATE)), DATEDIFF(dd, 0, CAST(GETDATE() AT TIME ZONE 'UTC' AT TIME ZONE 'Eastern Standard Time' AS DATE))))    end        -- Returns first day and yesterday of the current month as start and end dates when run on any day except 1st day of any month, if run on 1st of any month gives first and last date of the previous month    -- Use this for reports that should include MTD data and runs every day in a month.    if @DateRange='MTD'    begin     set @StartDate = case when DATEPART(DAY,CONVERT(DATE,CAST(GETDATE() AT TIME ZONE 'UTC' AT TIME ZONE 'Eastern Standard Time' AS DATE))) <> 1           then DATEADD(MONTH, DATEDIFF(MONTH, 0, CAST(GETDATE() AT TIME ZONE 'UTC' AT TIME ZONE 'Eastern Standard Time' AS DATE)), 0)               when DATEPART(DAY,CONVERT(DATE,CAST(GETDATE() AT TIME ZONE 'UTC' AT TIME ZONE 'Eastern Standard Time' AS DATE))) = 1            then DATEADD(MONTH, DATEDIFF(MONTH, 0, CAST(GETDATE() AT TIME ZONE 'UTC' AT TIME ZONE 'Eastern Standard Time' AS DATE))-1, 0)             END       set @EndDate  = case when DATEPART(DAY,CONVERT(DATE,CAST(GETDATE() AT TIME ZONE 'UTC' AT TIME ZONE 'Eastern Standard Time' AS DATE))) <> 1           then DATEADD(DAY, DATEDIFF(DAY, 0, CAST(GETDATE()-1 AT TIME ZONE 'UTC' AT TIME ZONE 'Eastern Standard Time' AS DATE)), 0)                    when DATEPART(DAY,CONVERT(DATE,CAST(GETDATE() AT TIME ZONE 'UTC' AT TIME ZONE 'Eastern Standard Time' AS DATE))) = 1           then DATEADD(MONTH, DATEDIFF(MONTH, -1, CAST(GETDATE() AT TIME ZONE 'UTC' AT TIME ZONE 'Eastern Standard Time' AS DATE))-1, -1)                   END    end    --SELECT @StartDate  --SELECT @EndDate    --set @StartDate='12/01/2019';  --set @EndDate='12/31/2019';      SELECT DISTINCT  @S
  -- EXEC bireports.sp_rpt_pbi_BM_Tech_FittingFee 1  -- without Brand  -- EXEC bireports.sp_rpt_pbi_BM_Tech_FittingFee 2  -- with Brand  CREATE proc [bireports].[sp_rpt_pbi_BM_Tech_FittingFee]  (@ReportOption int)  as       DROP TABLE IF EXISTS #ContractProductsTech    select HealthPlanContractId, PerDeviceDispensingFee, FamilyProductCatCode, ItemCode, PerDeviceMemberPrice  into #ContractProductsTech  from [Insurance].[ContractProducts]  where 1=1  and IsActive = 1        IF @ReportOption = 1 -- without Brand    BEGIN      select cp.HealthPlanContractId, hpc.ContractName    ,hpc.InsuranceCarrierID , ic.InsuranceCarrierName    ,hpc.InsuranceHealthPlanID , hp.HealthPlanName    , cp.PerDeviceDispensingFee, cp.FamilyProductCatCode Technology    --,iml.BrandCode--,iml.FamilyCode    , count(*) RecordCount    ,cast(cp.HealthPlanContractId as varchar)+'-'+cast(hpc.InsuranceCarrierID as varchar)+'-'+cast(hpc.InsuranceHealthPlanID as varchar)+'-'+cp.FamilyProductCatCode RelationKey    from #ContractProductsTech cp    left join Insurance.HealthPlanContracts hpc on (hpc.HealthPlanContractID = cp.HealthPlanContractId)    left join Insurance.InsuranceCarriers ic on (ic.InsuranceCarrierID = hpc.InsuranceCarrierID)    left join Insurance.InsuranceHealthPlans hp on (hp.InsuranceHealthPlanID = hpc.InsuranceHealthPlanID)    left join catalog.ItemMasterList iml on (iml.ItemCode = cp.ItemCode and iml.IsActive=1)    where 1=1    --and cp.HealthPlanContractId = 1416    --and cp.IsActive = 1    and getdate() between hpc.EffectiveFromDate and hpc.EffectiveToDate    and isnull(cp.FamilyProductCatCode,'') <> ''    and isnull(cp.PerDeviceDispensingFee,'') <> ''    and hpc.InsuranceCarrierID not in (212,222,223)    and cp.PerDeviceDispensingFee <> 197.35    and hpc.ContractName not like '2018-C%'    and hpc.ContractName not like '2019-C%'    group by cp.HealthPlanContractId, hpc.ContractName    ,hpc.InsuranceCarrierID , ic.InsuranceCarrierName    ,hpc.InsuranceHealthPlanID , hp.HealthPlanName    , cp.PerDeviceDispensingFee, cp.FamilyProductCatCode --, iml.BrandCode--,iml.FamilyCode    ,cast(cp.HealthPlanContractId as varchar)+'-'+cast(hpc.InsuranceCarrierID as varchar)+'-'+cast(hpc.InsuranceHealthPlanID as varchar)+'-'+cp.FamilyProductCatCode    order by cp.HealthPlanContractId    ,hpc.InsuranceCarrierID ,hpc.InsuranceHealthPlanID    , cp.PerDeviceDispensingFee, cp.FamilyProductCatCode--, iml.BrandCode--,iml.FamilyCode    END        IF @ReportOption = 2 -- with Brand    BEGIN      select cp.HealthPlanContractId, hpc.ContractName    ,hpc.InsuranceCarrierID , ic.InsuranceCarrierName    ,hpc.InsuranceHealthPlanID , hp.HealthPlanName    , cp.PerDeviceDispensingFee, cp.FamilyProductCatCode Technology    ,iml.BrandCode--,iml.FamilyCode    , count(*) RecordCount    ,cast(cp.HealthPlanContractId as varchar)+'-'+cast(hpc.InsuranceCarrierID as varchar)+'-'+cast(hpc.InsuranceHealthPlanID as varchar)+'-'+cp.FamilyProductCatCode RelationKey    from #ContractProductsTech cp    left join Insurance.HealthPlanContracts hpc on (hpc.HealthPlanContractID = cp.HealthPlanContractId)    left join Insurance.InsuranceCarriers ic on (ic.InsuranceCarrierID = hpc.InsuranceCarrierID)    left join Insurance.InsuranceHealthPlans hp on (hp.InsuranceHealthPlanID = hpc.InsuranceHealthPlanID)    left join catalog.ItemMasterList iml on (iml.ItemCode = cp.ItemCode and iml.IsActive=1)    where 1=1    --and cp.HealthPlanContractId = 1416    --and cp.IsActive = 1    and getdate() between hpc.EffectiveFromDate and hpc.EffectiveToDate    and isnull(cp.FamilyProductCatCode,'') <> ''    and isnull(cp.PerDeviceDispensingFee,'') <> ''    and hpc.InsuranceCarrierID not in (212,222,223)    and cp.PerDeviceDispensingFee <> 197.35    and hpc.ContractName not like '2018-C%'    and hpc.ContractName not like '2019-C%'    group by cp.HealthPlanContractId, hpc.ContractName    ,hpc.InsuranceCarrierID , ic.InsuranceCarrierName    ,hpc.InsuranceHealthPlanID , hp.HealthPlanName    , cp.PerDeviceDispensingFee, cp.
    --exec [bireports].[sp_OTCSummary_rpt]   CREATE PROCEDURE [bireports].[sp_OTCSummary_rpt]   AS  BEGIN      --Dates    select dd.date as ReportDate    into #temp_Date    from [BIReports].[Dim_Date] dd    where 1=1    and dd.year = year(CAST(getdate() AT TIME ZONE 'UTC'   AT TIME ZONE 'Eastern Standard Time' AS DATE))    --and dd.quarter = datepart(q,CAST(getdate() AT TIME ZONE 'UTC'   AT TIME ZONE 'Eastern Standard Time' AS DATE))    and dd.month = 4--month(CAST(getdate() AT TIME ZONE 'UTC'   AT TIME ZONE 'Eastern Standard Time' AS DATE))    and dd.date <= CAST(getdate() AT TIME ZONE 'UTC'   AT TIME ZONE 'Eastern Standard Time' AS DATE)    order by dd.date    --Carrier--Plan    select d.InsuranceCarrierID,i.InsuranceCarrierName,d.InsuranceHealthPlanID,d.HealthPlanName,d.HealthPlanNumber,    JSON_VALUE(a.BenefitRuleData, '$.BENCATVALUE') BENCATVALUE,    JSON_VALUE(a.BenefitRuleData, '$.BENFREQMONTHS') BENFREQMONTHS    into #temp_Plans    from rulesengine.BenefitRulesData  a    join  Insurance.ContractRules b on a.BenefitRuleDataId = b.BenefitRuleDataId    join insurance.healthplancontracts c on c.HealthPlanContractID = b.HealthPlanContractId    join Insurance.InsuranceHealthPlans d on d.InsuranceHealthPlanID = c.InsuranceHealthPlanID    join  Insurance.InsuranceCarriers i on d.InsuranceCarrierID = i.InsuranceCarrierID    where 1=1    and JSON_VALUE(BenefitRuleData, '$.BENTYPE') = 'OTC'       --select * from #temp_Plans  --Member Count by Carrier and Plan    select a.InsuranceCarrierID,a.InsuranceHealthPlanID, count(*) MemberCnt    into #temp_MemberCnt    from MASTER.MemberInsurances a    join (select distinct InsuranceCarrierID from #temp_Plans) b on a.InsuranceCarrierID = b.InsuranceCarrierID    where 1=1    and IsActive=1    and CAST(getdate() AT TIME ZONE 'UTC'   AT TIME ZONE 'Eastern Standard Time' AS DATE) between InsuranceEffectiveDate and InsuranceEndDate    group by a.InsuranceHealthPlanID,a.InsuranceCarrierID    --ItemCode Cost    select     ItemCode,ModelAttributeValue,    (case when pp.Best_Cost is null then  0 else pp.Best_Cost end) COGS    into #temp_ItemCodeCOGS    from  catalog.ItemMasterAttributeValues  ia    left join otc.ProductPrices pp on pp.nations_id = ia.ModelAttributeValue    where ia.Itemcode is not null     and ia.AttributeCode='Nations_Id'    --OTC Orders data    select CAST(o.CreateDate AT TIME ZONE 'UTC'   AT TIME ZONE 'Eastern Standard Time' AS DATE) OrderDate      ,JSON_VALUE(O.MemberData,'$.insCarrierId')  InsuranceCarrierID  --    ,mi.InsuranceCarrierID  as InsuranceCarrierID      ,JSON_VALUE(O.MemberData,'$.insPlanId') InsuranceHealthPlanID      ,sum(O.Amount) AmountUsed      ,sum(cast(JSON_VALUE(O.OrderAmountData,'$.benefitTransactions[0].amountRemaining') as float)) AmountRemainingForMemebersWhoTappedBenefit      ,count(distinct O.nhmemberid) as MemberCountWhoTappedBenefit      ,count(distinct O.OrderID) OrderCount      ,sum(OI.quantity) as UnitsCount      ,sum(oi.amount) as productRevenue      ,sum(oi.OrdCogs) as ProductCost      ,sum(fx.ShippingCost) as ShippingCost     into #temp_OrderData    from ORDERS.ORDERS O   --INNER JOIN provider.MemberProfiles mp on mp.NHMemberId = O.NHMemberId and mp.IsActive=1  --INNER JOIN provider.MemberInsurances mi on   --                    (mi.MemberProfileId = mp.MemberProfileId and mi.IsActive=1 and   --                    CAST(O.CreateDate AT TIME ZONE 'UTC'   AT TIME ZONE 'Eastern Standard Time' AS DATE) between CAST(mi.[InsuranceEffectiveDate] AT TIME ZONE 'UTC'   AT TIME ZONE 'Eastern Standard Time' AS DATE) and CAST(mi.[InsuranceEndDate] AT TIME ZONE 'UTC'   AT TIME ZONE 'Eastern Standard Time' AS DATE)  --                    )  --INNER JOIN Insurance.InsuranceCarriers ic ON IC.InsuranceCarrierID = MI.InsuranceCarrierID      join (select x.orderid orderid,sum(x.quantity) quantity ,sum(x.Amount) as Amount,sum(COGS) as COGS       ,SUM((CASE WHEN COGS = 0 THEN UnitPrice * 0.7 ELSE COGS END )*x.Quantity) as OrdCogs      from orders.OrderItems x      l
  -- EXEC bireports.sp_rpt_mitel_queue_stats_OTC 'D'  -- EXEC bireports.sp_rpt_mitel_queue_stats_OTC 'W'  -- EXEC bireports.sp_rpt_mitel_queue_stats_OTC 'M'  -- EXEC bireports.sp_rpt_mitel_queue_stats_OTC 'MTD'  CREATE proc [bireports].[sp_rpt_mitel_queue_stats_OTC] (@DateRange char(5))  as         Declare @StartDate date;  Declare @EndDate date;          -- Returns previous day     if @DateRange='D'    begin     set @StartDate = DATEADD(DAY,-1,CONVERT(DATE,CAST(GETDATE() AT TIME ZONE 'UTC' AT TIME ZONE 'Eastern Standard Time' AS DATE)))                 set @EndDate =   DATEADD(DAY,-1,CONVERT(DATE,CAST(GETDATE() AT TIME ZONE 'UTC' AT TIME ZONE 'Eastern Standard Time' AS DATE)))              end      -- Returns first and last day of previous month    if @DateRange='M'    begin     set @EndDate = dateadd(dd,-1,cast(cast(year(CAST(GETDATE() AT TIME ZONE 'UTC' AT TIME ZONE 'Eastern Standard Time' AS DATE)) as varchar(4))+'/'+cast(month(CAST(GETDATE() AT TIME ZONE 'UTC' AT TIME ZONE 'Eastern Standard Time' AS DATE)) as varchar(2))+'/1' as date))     set @StartDate = cast(cast(year(@EndDate) as varchar(4))+'/'+cast(month(@EndDate) as varchar(2))+'/1' as date);       end      -- Returns first and last day of previous week - first day of week starts with Sunday    if @DateRange='W'    begin     set @StartDate = DATEADD(wk, -1, DATEADD(DAY, 1-DATEPART(WEEKDAY, CAST(GETDATE() AT TIME ZONE 'UTC' AT TIME ZONE 'Eastern Standard Time' AS DATE)), DATEDIFF(dd, 0, CAST(GETDATE() AT TIME ZONE 'UTC' AT TIME ZONE 'Eastern Standard Time' AS DATE))))     set @EndDate = DATEADD(wk, 0, DATEADD(DAY, 0-DATEPART(WEEKDAY, CAST(GETDATE() AT TIME ZONE 'UTC' AT TIME ZONE 'Eastern Standard Time' AS DATE)), DATEDIFF(dd, 0, CAST(GETDATE() AT TIME ZONE 'UTC' AT TIME ZONE 'Eastern Standard Time' AS DATE))))    end      -- Returns first day and yesterday of the current month as start and end dates when run on any day except 1st day of any month, if run on 1st of any month gives first and last date of the previous month    -- Use this for reports that should include MTD data and runs every day in a month.    if @DateRange='MTD'    begin     set @StartDate = case when DATEPART(DAY,CONVERT(DATE,CAST(GETDATE() AT TIME ZONE 'UTC' AT TIME ZONE 'Eastern Standard Time' AS DATE))) <> 1           then DATEADD(MONTH, DATEDIFF(MONTH, 0, CAST(GETDATE() AT TIME ZONE 'UTC' AT TIME ZONE 'Eastern Standard Time' AS DATE)), 0)               when DATEPART(DAY,CONVERT(DATE,CAST(GETDATE() AT TIME ZONE 'UTC' AT TIME ZONE 'Eastern Standard Time' AS DATE))) = 1            then DATEADD(MONTH, DATEDIFF(MONTH, 0, CAST(GETDATE() AT TIME ZONE 'UTC' AT TIME ZONE 'Eastern Standard Time' AS DATE))-1, 0)             END       set @EndDate  = case when DATEPART(DAY,CONVERT(DATE,CAST(GETDATE() AT TIME ZONE 'UTC' AT TIME ZONE 'Eastern Standard Time' AS DATE))) <> 1           then DATEADD(DAY, DATEDIFF(DAY, 0, CAST(GETDATE()-1 AT TIME ZONE 'UTC' AT TIME ZONE 'Eastern Standard Time' AS DATE)), 0)                    when DATEPART(DAY,CONVERT(DATE,CAST(GETDATE() AT TIME ZONE 'UTC' AT TIME ZONE 'Eastern Standard Time' AS DATE))) = 1           then DATEADD(MONTH, DATEDIFF(MONTH, -1, CAST(GETDATE() AT TIME ZONE 'UTC' AT TIME ZONE 'Eastern Standard Time' AS DATE))-1, -1)                   END    end    --SELECT @StartDate  --SELECT @EndDate    --set @StartDate='01/10/2020';  --set @EndDate='01/10/2020';    -- EXEC bireports.sp_rpt_mitel_queue_stats_OTC 'D'    select   1 as Seq  ,@StartDate AS Start_Date  ,@EndDate AS End_Date  ,QueueReporting  ,isnull(qg.Name,REPLACE(REPLACE(QueueName,'1',''),'2','')) QueueName  ,sum(QueueOffered) ACD_Calls_Offered  ,sum(QueueAnswered) ACD_Calls_Handled  ,sum(QueueAbandoned) ACD_Calls_Abandoned_Long  ,sum(QueueShortAbandoned) ACD_Calls_Abandoned_Short    ,CASE WHEN sum(QueueAnswered) = 0 THEN '00:00:00' ELSE  RIGHT('00' + CAST((sum(QueueTimeToAnswerTotal)/sum(QueueAnswered))/3600  AS VARCHAR(2)), 2 ) +':'+ -- HH  RIGHT('00' + CAST(((sum(QueueTimeToAnswerTotal)/sum(QueueAnsw
  --exec [bireports].[sp_CCA_ABNCalls_rpt]   CREATE PROCEDURE [bireports].[sp_CCA_ABNCalls_rpt]   AS  BEGIN            select distinct                       cast(a.MidnightStartDate as date) ABNDate,                      a.PhoneNumber PhNumber               into #temp_PhNumbers         from [bireports].[vw_Mitel_InOut_Aban_CallDetail] a         where 1=1      and Year(CAST(a.MidnightStartDate AT TIME ZONE 'UTC'   AT TIME ZONE 'Eastern Standard Time' AS DATE)) = year(CAST(getdate()-1 AT TIME ZONE 'UTC'   AT TIME ZONE 'Eastern Standard Time' AS DATE))      and Month(CAST(a.MidnightStartDate AT TIME ZONE 'UTC'   AT TIME ZONE 'Eastern Standard Time' AS DATE)) = month(CAST(getdate()-1 AT TIME ZONE 'UTC'   AT TIME ZONE 'Eastern Standard Time' AS DATE))      and QueueName='CommonWealth OTC'      and CallDirection='Abandoned'           alter table #temp_PhNumbers add EligNHMemberId varchar(20)            , orderid bigint,orderdate date           , MemberOrderedFlag varchar(1)           , phonehow varchar(30)           --update nhmemberid using elig data phnumber         update c set c.EligNHMemberId = b.NHMemberID, c.phonehow  = 'ELIG'         from elig.mstrEligBenefitData a         join Master.Members b on a.MasterMemberID = b.MemberID         join #temp_PhNumbers c on c.PhNumber = a.HomePhoneNbr         where 1=1         and a.isActive = 1         and a.DataSource ='ELIG_CCA'         and getdate() between a.RecordEffDate and a.RecordEndDate         --and getdate() between BenefitStartDate and BenefitEndDate           update a set a.EligNHMemberId = b.MemberNHMemberId,a.phonehow  = 'CALL_CONV'         from #temp_PhNumbers a         join               (                      select distinct b.PhNumber,a.MemberNHMemberId                      from CallCenter.CallConversations a                      join #temp_PhNumbers b on b.PhNumber = a.callernumber                       where 1=1                      and b.EligNHMemberId is null                      and a.MemberNHMemberId is not null                      and CAST(a.CreateDate AT TIME ZONE 'UTC'   AT TIME ZONE 'Eastern Standard Time' AS DATE) >='04/01/2020'               ) b on a.PhNumber = b.PhNumber          where a.EligNHMemberId is null           --update nhnumber using provider.MemberAlternateContacts               update a set a.EligNHMemberId = b.NHMemberId, phonehow  = 'ALTERNATE CONTACTS'               from #temp_PhNumbers A               join (                      select                       a.MemberProfileId,replace(a.MobileNumber,'-','') MobileNumber                      ,replace(a.PrimaryHomeNumber,'-','') PrimaryHomeNumber                      ,b.NHMemberId                      from provider.MemberAlternateContacts a                      join Provider.MemberProfiles b on a.MemberProfileId = b.MemberProfileId                      where 1=1                      and a.MobileNumber is not null or a.PrimaryHomeNumber is not NULL                      ) b on (a.PhNumber = b.MobileNumber or a.PhNumber = b.PrimaryHomeNumber)               where a.EligNHMemberId is null           --update odrder info using nhmemberid         update a set a.orderid = b.orderid,a.orderdate = CAST(b.CreateDate AT TIME ZONE 'UTC'   AT TIME ZONE 'Eastern Standard Time' AS DATE),                             a.MemberOrderedFlag = 'Y'         from #temp_PhNumbers a         join orders.Orders b on a.EligNHMemberId = b.NHMemberId         where 1=1         and b.OrderType ='OTC'         and CAST(b.CreateDate AT TIME ZONE 'UTC'   AT TIME ZONE 'Eastern Standard Time' AS DATE) >='04/01/2020'           ---report         select a.ABNDate     ,a.ABNCalls [Total Abandoned Calls]     ,a.UniABNCallerCount [Total Unique Abandoned Phone Nbrs]              ,isnull(b.UniMemberCount,0) as [Members who have Orders (Based on Phone Nbr Eligibility Match)]     ,isnull(b.UniMemberCount,0) + isnull(x.AllOtherOrders,0) [Members who have orders (Phone Nbr Match from ELIGIBILITY/ ALTERNATE Contacts/ CALLING NBR)]              ,a.
  -- EXEC bireports.sp_rpt_mitel_queue_stats_HA_MTD NULL,NULL,'P214','H' -- Today  -- EXEC bireports.sp_rpt_mitel_queue_stats_HA_MTD NULL,NULL,'P214','D' -- Yesterday  -- EXEC bireports.sp_rpt_mitel_queue_stats_HA_MTD NULL,NULL,'P214','W' -- Last Week  -- EXEC bireports.sp_rpt_mitel_queue_stats_HA_MTD NULL,NULL,'P180','MTD' -- Previous Month  -- EXEC bireports.sp_rpt_mitel_queue_stats_HA_MTD NULL,NULL,'P279','MTD' -- Previous Month  -- EXEC bireports.sp_rpt_mitel_queue_stats_HA_MTD '12/01/2020','02/29/2020','P180','MTD' -- Month To Date      -- EXEC bireports.sp_rpt_mitel_queue_stats_HA_MTD '01/01/2020','01/31/2020','P180','X' -- Jan 2020  -- EXEC bireports.sp_rpt_mitel_queue_stats_HA_MTD '02/01/2020','02/29/2020','P180','X' -- Feb 2020  -- EXEC bireports.sp_rpt_mitel_queue_stats_HA_MTD '03/01/2020','03/09/2020','P180','X' -- Mar 2020    CREATE proc [bireports].[sp_rpt_mitel_queue_stats_HA_MTD] (@Start_Date date, @End_Date date, @QueueID varchar(200), @DateRange char(5))  as     Declare @StartDate date;  Declare @EndDate date;                -- Custom Date Range    if @DateRange='X'    begin       set @StartDate =  @Start_Date                set @EndDate =  @End_Date             end          -- Returns previous day     if @DateRange='D'    begin     set @StartDate = DATEADD(DAY,-1,CONVERT(DATE,CAST(GETDATE() AT TIME ZONE 'UTC' AT TIME ZONE 'Eastern Standard Time' AS DATE)))                 set @EndDate =   DATEADD(DAY,-1,CONVERT(DATE,CAST(GETDATE() AT TIME ZONE 'UTC' AT TIME ZONE 'Eastern Standard Time' AS DATE)))              end          -- Returns previous day     if @DateRange='H'    begin     set @StartDate = CONVERT(DATE,CAST(GETDATE() AT TIME ZONE 'UTC' AT TIME ZONE 'Eastern Standard Time' AS DATE))                set @EndDate =   CONVERT(DATE,CAST(GETDATE() AT TIME ZONE 'UTC' AT TIME ZONE 'Eastern Standard Time' AS DATE))             end      -- Returns first and last day of previous month    if @DateRange='M'    begin     set @EndDate = dateadd(dd,-1,cast(cast(year(CAST(GETDATE() AT TIME ZONE 'UTC' AT TIME ZONE 'Eastern Standard Time' AS DATE)) as varchar(4))+'/'+cast(month(CAST(GETDATE() AT TIME ZONE 'UTC' AT TIME ZONE 'Eastern Standard Time' AS DATE)) as varchar(2))+'/1' as date))     set @StartDate = cast(cast(year(@EndDate) as varchar(4))+'/'+cast(month(@EndDate) as varchar(2))+'/1' as date);       end      -- Returns first and last day of previous week - first day of week starts with Sunday    if @DateRange='W'    begin     set @StartDate = DATEADD(wk, -1, DATEADD(DAY, 1-DATEPART(WEEKDAY, CAST(GETDATE() AT TIME ZONE 'UTC' AT TIME ZONE 'Eastern Standard Time' AS DATE)), DATEDIFF(dd, 0, CAST(GETDATE() AT TIME ZONE 'UTC' AT TIME ZONE 'Eastern Standard Time' AS DATE))))     set @EndDate = DATEADD(wk, 0, DATEADD(DAY, 0-DATEPART(WEEKDAY, CAST(GETDATE() AT TIME ZONE 'UTC' AT TIME ZONE 'Eastern Standard Time' AS DATE)), DATEDIFF(dd, 0, CAST(GETDATE() AT TIME ZONE 'UTC' AT TIME ZONE 'Eastern Standard Time' AS DATE))))    end        -- Returns first day and yesterday of the current month as start and end dates when run on any day except 1st day of any month, if run on 1st of any month gives first and last date of the previous month    -- Use this for reports that should include MTD data and runs every day in a month.    if @DateRange='MTD'    begin     set @StartDate = case when DATEPART(DAY,CONVERT(DATE,CAST(GETDATE() AT TIME ZONE 'UTC' AT TIME ZONE 'Eastern Standard Time' AS DATE))) <> 1           then DATEADD(MONTH, DATEDIFF(MONTH, 0, CAST(GETDATE() AT TIME ZONE 'UTC' AT TIME ZONE 'Eastern Standard Time' AS DATE)), 0)               when DATEPART(DAY,CONVERT(DATE,CAST(GETDATE() AT TIME ZONE 'UTC' AT TIME ZONE 'Eastern Standard Time' AS DATE))) = 1            then DATEADD(MONTH, DATEDIFF(MONTH, 0, CAST(GETDATE() AT TIME ZONE 'UTC' AT TIME ZONE 'Eastern Standard Time' AS DATE))-1, 0)             END       set @EndDate  = case when DATEPART(DAY,CONVERT(DATE,CAST(GETDATE() AT TIME ZONE 'UTC' AT TIME ZONE 'Eastern Standard Ti
  -- EXEC bireports.sp_rpt_mitel_queue_stats_HA_MTD_Include_Weekend NULL,NULL,'P214','H' -- Today  -- EXEC bireports.sp_rpt_mitel_queue_stats_HA_MTD_Include_Weekend NULL,NULL,'P214','D' -- Yesterday  -- EXEC bireports.sp_rpt_mitel_queue_stats_HA_MTD_Include_Weekend NULL,NULL,'P214','W' -- Last Week  -- EXEC bireports.sp_rpt_mitel_queue_stats_HA_MTD_Include_Weekend NULL,NULL,'P180','MTD' -- Previous Month  -- EXEC bireports.sp_rpt_mitel_queue_stats_HA_MTD_Include_Weekend '04/01/2020','04/21/2020','P102','MTD' -- Month To Date  -- EXEC bireports.sp_rpt_mitel_queue_stats_HA_MTD_Include_Weekend NULL,NULL,'P279','MTD' -- Previous Month      -- EXEC bireports.sp_rpt_mitel_queue_stats_HA_MTD_Include_Weekend '01/01/2020','01/31/2020','P180','X' -- Jan 2020  -- EXEC bireports.sp_rpt_mitel_queue_stats_HA_MTD_Include_Weekend '02/01/2020','02/29/2020','P180','X' -- Feb 2020  -- EXEC bireports.sp_rpt_mitel_queue_stats_HA_MTD_Include_Weekend '03/01/2020','03/09/2020','P180','X' -- Mar 2020    CREATE proc [bireports].[sp_rpt_mitel_queue_stats_HA_MTD_Include_Weekend] (@Start_Date date, @End_Date date, @QueueID varchar(200), @DateRange char(5))  as     Declare @StartDate date;  Declare @EndDate date;                -- Custom Date Range    if @DateRange='X'    begin       set @StartDate =  @Start_Date                set @EndDate =  @End_Date             end          -- Returns previous day     if @DateRange='D'    begin     set @StartDate = DATEADD(DAY,-1,CONVERT(DATE,CAST(GETDATE() AT TIME ZONE 'UTC' AT TIME ZONE 'Eastern Standard Time' AS DATE)))                 set @EndDate =   DATEADD(DAY,-1,CONVERT(DATE,CAST(GETDATE() AT TIME ZONE 'UTC' AT TIME ZONE 'Eastern Standard Time' AS DATE)))              end          -- Returns previous day     if @DateRange='H'    begin     set @StartDate = CONVERT(DATE,CAST(GETDATE() AT TIME ZONE 'UTC' AT TIME ZONE 'Eastern Standard Time' AS DATE))                set @EndDate =   CONVERT(DATE,CAST(GETDATE() AT TIME ZONE 'UTC' AT TIME ZONE 'Eastern Standard Time' AS DATE))             end      -- Returns first and last day of previous month    if @DateRange='M'    begin     set @EndDate = dateadd(dd,-1,cast(cast(year(CAST(GETDATE() AT TIME ZONE 'UTC' AT TIME ZONE 'Eastern Standard Time' AS DATE)) as varchar(4))+'/'+cast(month(CAST(GETDATE() AT TIME ZONE 'UTC' AT TIME ZONE 'Eastern Standard Time' AS DATE)) as varchar(2))+'/1' as date))     set @StartDate = cast(cast(year(@EndDate) as varchar(4))+'/'+cast(month(@EndDate) as varchar(2))+'/1' as date);       end      -- Returns first and last day of previous week - first day of week starts with Sunday    if @DateRange='W'    begin     set @StartDate = DATEADD(wk, -1, DATEADD(DAY, 1-DATEPART(WEEKDAY, CAST(GETDATE() AT TIME ZONE 'UTC' AT TIME ZONE 'Eastern Standard Time' AS DATE)), DATEDIFF(dd, 0, CAST(GETDATE() AT TIME ZONE 'UTC' AT TIME ZONE 'Eastern Standard Time' AS DATE))))     set @EndDate = DATEADD(wk, 0, DATEADD(DAY, 0-DATEPART(WEEKDAY, CAST(GETDATE() AT TIME ZONE 'UTC' AT TIME ZONE 'Eastern Standard Time' AS DATE)), DATEDIFF(dd, 0, CAST(GETDATE() AT TIME ZONE 'UTC' AT TIME ZONE 'Eastern Standard Time' AS DATE))))    end        -- Returns first day and yesterday of the current month as start and end dates when run on any day except 1st day of any month, if run on 1st of any month gives first and last date of the previous month    -- Use this for reports that should include MTD data and runs every day in a month.    if @DateRange='MTD'    begin     set @StartDate = case when DATEPART(DAY,CONVERT(DATE,CAST(GETDATE() AT TIME ZONE 'UTC' AT TIME ZONE 'Eastern Standard Time' AS DATE))) <> 1           then DATEADD(MONTH, DATEDIFF(MONTH, 0, CAST(GETDATE() AT TIME ZONE 'UTC' AT TIME ZONE 'Eastern Standard Time' AS DATE)), 0)               when DATEPART(DAY,CONVERT(DATE,CAST(GETDATE() AT TIME ZONE 'UTC' AT TIME ZONE 'Eastern Standard Time' AS DATE))) = 1            then DATEADD(MONTH, DATEDIFF(MONTH, 0, CAST(GETDATE() AT TIME ZONE 'UTC' AT TIME ZONE 'Eastern Standard Tim
--'P279' --ND; 'P262' --VT  -- EXEC bireports.[sp_rpt_covantage_call_stats_by_DNIS] '10/09/2020','P279~P262','X' -- RunDate  -- EXEC bireports.[sp_rpt_covantage_call_stats_by_DNIS] NULL,'P279~P262','D' -- Yesterday  -- EXEC bireports.[sp_rpt_covantage_call_stats_by_DNIS] NULL,'P279~P262','C' -- today    CREATE proc [bireports].[sp_rpt_covantage_call_stats_by_DNIS] (@RunDate date, @QueueID varchar(200), @SMode char(1))  as     Declare @StartDate date,    @EndDate date,    @MStartDate date;       SELECT value as QueueID  into #tempQ  FROM       STRING_SPLIT(@QueueID, '~')  WHERE      TRIM(value) <> '';      -- Custom Date Range    if @SMode='X'    begin     set @StartDate =  DATEADD(yy, DATEDIFF(yy, 0, @RunDate), 0)     set @MStartDate =cast(cast(year(@RunDate) as varchar(4))+'/'+cast(month(@RunDate) as varchar(2))+'/1' as date)     set @EndDate =  cast(@RunDate as date)    end      -- Returns previous day     if @SMode='D'    begin     set @EndDate =   DATEADD(DAY,-1,CONVERT(DATE,CAST(GETDATE() AT TIME ZONE 'UTC' AT TIME ZONE 'Eastern Standard Time' AS DATE)))     set @MStartDate = cast(cast(year(@EndDate) as varchar(4))+'/'+cast(month(@EndDate) as varchar(2))+'/1' as date)     set @StartDate = DATEADD(yy, DATEDIFF(yy, 0, @EndDate), 0)    end      -- Returns previous day     if @SMode='C'    begin     set @EndDate =   DATEADD(DAY,-0,CONVERT(DATE,CAST(GETDATE() AT TIME ZONE 'UTC' AT TIME ZONE 'Eastern Standard Time' AS DATE)))     set @MStartDate = cast(cast(year(@EndDate) as varchar(4))+'/'+cast(month(@EndDate) as varchar(2))+'/1' as date)     set @StartDate = DATEADD(yy, DATEDIFF(yy, 0, @EndDate), 0)    end      Select '8002412567' TFN,'Website' TFNname,'North Dakota' QueueName into #tempForAllTFN union  Select '8333076863','Health and Safety Kit','North Dakota' union  Select '8447535678','CMS Website','North Dakota' union  Select '8772267202','Direct Mail','North Dakota' union  Select '8772272013','SEO Marketing','North Dakota' union  Select '8772290708','Social Media','North Dakota' union  Select '8772317759','Smart Conductor','North Dakota' union  Select '8772352957','Medicare Brochure','North Dakota' union  Select '8772371077','TV','North Dakota' union  --Select '8772374238','Radio','North Dakota' union  Select '8772388148','Print','North Dakota' union  Select '8772495899','PERS Benefit','North Dakota' union  Select '8775144327','Hearing Benefit','North Dakota' union  Select '8776176863','OTC Benefit','North Dakota' union  Select '8002802583','Inside Sales Transfer','North Dakota' union  Select '8772363324','Enrollment Reminder Emails','North Dakota' union  Select '7545517861','CMS Website','Vermont' union  Select '8005168021','Website','Vermont' union  Select '8445865863','Health and Safety Kit','Vermont' union  Select '8772269885','SEO Marketing','Vermont' union  Select '8772299219','Social Media','Vermont' union  Select '8772353892','Medicare Brochure','Vermont' union  Select '8772363198','TV','Vermont' union  --Select '8772368376','Radio','Vermont' union  Select '8772370323','Print','Vermont' union  Select '8772403410','Smart Conductor','Vermont' union  Select '8772447062','Friends and Family Marketing','Vermont' union  Select '8772466955','Hearing Benefit','Vermont' union  Select '8772471195','OTC Benefit','Vermont' union  Select '8772492406','PERS Benefit','Vermont' union  Select '8772439896','NFP Broker Blast','Vermont' union  Select '8772402096','Direct Mail','Vermont' union  Select '8002554550','Inside Sales Transfer','Vermont' union  select '8772438003','Enrollment Reminder Emails','Vermont'    /*  select distinct case when a.QueueReporting = 'P262' Then 'Vermont'       when a.QueueReporting = 'P279' then 'North Dakota' end as QueueName       ,a.DNISReporting TFN       into #tempForAllTFN  from bireports.Mitel_QueuePerformanceByDNISStats a  join #tempQ q on a.QueueReporting = q.QueueID  where 1=1  and cast(a.MidnightStartDate as date) between @StartDate and @EndDate  and a.DNISReporting not in ('7545517762','7545
    CREATE PROCEDURE [bireports].[SP_FinalOTCGeneralVer1_BY_EOD]  @EOD varchar(40)  AS   Declare @EODDate DateTime = CAST(CAST(@EOD + ' 23:54:59.760' as Datetime) AT TIME ZONE 'UTC'  AT TIME ZONE 'Eastern Standard Time' AS DATE)    --Declare @EOD varchar(40) =  '2020-03-31 23:54:59.760'  --Declare @EODDate DateTime = CAST(CAST(@EOD + ' 23:54:59.760' as Datetime) AT TIME ZONE 'UTC'  AT TIME ZONE 'Eastern Standard Time' AS DATE)    SELECT   CallYTD.CarrierName,   ISNULL(CallToday.[CallCnt],0) CallCntToday,  ISNULL(CallMTD.CallCntMTD, 0) CallCntMTD,  ISNULL(CallYTD.CallCntYTD, 0) CallCntYTD,    ISNULL(orderToday.[OrderCnt],0) OrderCntToday,  ISNULL(orderMTD.OrderCntMTD, 0) OrderCntMTD,  ISNULL(orderYTD.OrderCntYTD, 0) OrderCntYTD,    ISNULL(unitsToday.[OrderUnits],0) UnitsCntToday,  ISNULL(unitsMTD.UnitsCntMTD, 0) UnitsCntMTD,  ISNULL(unitsYTD.UnitsCntYTD, 0) UnitsCntYTD,    ISNULL(dollarToday.DollarToday,0) CatalogPriceToday,  ISNULL(dollarMTD.DollarMTD, 0) CatalogPriceMTD,  ISNULL(dollarYTD.DollarYTD, 0) CatalogPriceYTD,    (SELECT CASE WHEN CallYTD.CarrierName = 'NationsOTC Program' THEN ISNULL(dollarToday.DollarToday,0)*0.9 ELSE           CASE WHEN CallYTD.CarrierName = 'Ultimate Health Plan' THEN 3592     ELSE ISNULL(dollarToday.DollarToday,0) END END) ProductRevenueToday,    (SELECT CASE WHEN CallYTD.CarrierName = 'NationsOTC Program' THEN ISNULL(dollarMTD.DollarMTD,0)*0.9 ELSE           CASE WHEN CallYTD.CarrierName = 'Ultimate Health Plan' THEN ((FORMAT(CAST(GETDATE() AT TIME ZONE 'UTC'   AT TIME ZONE 'Eastern Standard Time' AS DATE),'dd'))-0)*3592     ELSE ISNULL(dollarMTD.DollarMTD,0) END END) ProductRevenueMTD,    (SELECT CASE WHEN CallYTD.CarrierName = 'NationsOTC Program' THEN ISNULL(dollarYTD.DollarYTD,0)*0.9 ELSE           CASE WHEN CallYTD.CarrierName = 'Ultimate Health Plan' THEN (DATEDIFF(day, CAST('01/01/2020' AS DATE), CAST(GETDATE() AT TIME ZONE 'UTC'   AT TIME ZONE 'Eastern Standard Time' AS DATE))+1)*3592     ELSE ISNULL(dollarYTD.DollarYTD,0) END END) ProductRevenueYTD,    ISNULL(ProductCostToday.ProductCostToday,0) ProductCostToday,   ISNULL(ProductCostMTD.ProductCostMTD,0) ProductCostMTD,   ISNULL(ProductCostYTD.ProductCostYTD,0) ProductCostYTD,     ISNULL(ShippingCostToday.ShippingCostToday,0) ShippingCostToday,   ISNULL(ShippingCostMTD.ShippingCostMTD,0) ShippingCostMTD,   ISNULL(ShippingCostYTD.ShippingCostYTD,0) ShippingCostYTD,       'TBD' TotalCostToday,  'TBD' TotalCostMTD,  'TBD' TotalCostYTD,    (SELECT CASE WHEN CallYTD.CarrierName IN ('Clear Spring','EON Health Plan') THEN ISNULL(orderToday.[OrderCnt],0)*3 ELSE           CASE WHEN CallYTD.CarrierName IN ('OptimaHealth','Troy') THEN ISNULL(orderToday.[OrderCnt],0)*4     ELSE 0 END END ) ShippingRevenueToday,  (SELECT CASE WHEN CallYTD.CarrierName IN ('Clear Spring','EON Health Plan') THEN ISNULL(orderMTD.OrderCntMTD,0)*3 ELSE           CASE WHEN CallYTD.CarrierName IN ('OptimaHealth','Troy') THEN ISNULL(orderMTD.OrderCntMTD,0)*4     ELSE 0 END END ) ShippingRevenueMTD,  (SELECT CASE WHEN CallYTD.CarrierName IN ('Clear Spring','EON Health Plan') THEN ISNULL(orderYTD.OrderCntYTD,0)*3 ELSE           CASE WHEN CallYTD.CarrierName IN ('OptimaHealth','Troy') THEN ISNULL(orderYTD.OrderCntYTD,0)*4     ELSE 0 END END ) ShippingRevenueYTD,    'TBD' MarginToday,  'TBD' MarginMTD,  'TBD' MarginYTD,    ISNULL(callOrdersMTD.CallOrderMTD,0) as CallOrdersMTD,  ISNULL(callOrdersYTD.CallOrderYTD,0) as CallOrdersYTD,  ISNULL(onlineOrdersMTD.OnlineOrderMTD,0) as OnlineOrdersMTD,  ISNULL(onlineOrdersYTD.OnlineOrderYTD,0) as OnlineOrdersYTD,  --FullFillment   ISNULL(fullfillToday.FullFilledToday,0) as FullFilledToday,  ISNULL(fullfillMTD.FullFilledMTD,0) as FullFilledMTD    ------------------------------------------------END    FROM  ---------------------------------->>>CALLS  --CallYTD   (   SELECT    [CarrierName] AS 'CarrierName', SUM([CallCnt]) AS 'CallCntYTD'   FROM [execreports].[CallSummaryDetailsByDateOTC] WHERE CALLDATE <= @EODDate AND   FORMAT(CAST(CALLDAT
    --exec [bireports].[SP_FinalOTCGeneralVer1_BY_EOD_DSPR] '2020-03-31'  CREATE PROCEDURE [bireports].[SP_FinalOTCGeneralVer1_BY_EOD_DSPR]  @EOD varchar(40)  AS   Declare @EODDate DateTime = CAST(CAST(@EOD + ' 23:54:59.760' as Datetime) AT TIME ZONE 'UTC'  AT TIME ZONE 'Eastern Standard Time' AS DATE)    --Declare @EOD varchar(40) =  '2020-03-31 23:54:59.760'  --Declare @EODDate DateTime = CAST(CAST(@EOD + ' 23:54:59.760' as Datetime) AT TIME ZONE 'UTC'  AT TIME ZONE 'Eastern Standard Time' AS DATE)    SELECT   CallYTD.CarrierName,   ISNULL(CallToday.[CallCnt],0) CallCntToday,  ISNULL(CallMTD.CallCntMTD, 0) CallCntMTD,  ISNULL(CallYTD.CallCntYTD, 0) CallCntYTD,    ISNULL(orderToday.[OrderCnt],0) OrderCntToday,  ISNULL(orderMTD.OrderCntMTD, 0) OrderCntMTD,  ISNULL(orderYTD.OrderCntYTD, 0) OrderCntYTD,    ISNULL(unitsToday.[OrderUnits],0) UnitsCntToday,  ISNULL(unitsMTD.UnitsCntMTD, 0) UnitsCntMTD,  ISNULL(unitsYTD.UnitsCntYTD, 0) UnitsCntYTD,    ISNULL(dollarToday.DollarToday,0) CatalogPriceToday,  ISNULL(dollarMTD.DollarMTD, 0) CatalogPriceMTD,  ISNULL(dollarYTD.DollarYTD, 0) CatalogPriceYTD,    (SELECT CASE WHEN CallYTD.CarrierName = 'NationsOTC Program' THEN ISNULL(dollarToday.DollarToday,0)*0.9 ELSE           CASE WHEN CallYTD.CarrierName = 'Ultimate Health Plan' THEN 3592     ELSE ISNULL(dollarToday.DollarToday,0) END END) ProductRevenueToday,    (SELECT CASE WHEN CallYTD.CarrierName = 'NationsOTC Program' THEN ISNULL(dollarMTD.DollarMTD,0)*0.9 ELSE           CASE WHEN CallYTD.CarrierName = 'Ultimate Health Plan' THEN ((FORMAT(CAST(GETDATE() AT TIME ZONE 'UTC'   AT TIME ZONE 'Eastern Standard Time' AS DATE),'dd'))-0)*3592     ELSE ISNULL(dollarMTD.DollarMTD,0) END END) ProductRevenueMTD,    (SELECT CASE WHEN CallYTD.CarrierName = 'NationsOTC Program' THEN ISNULL(dollarYTD.DollarYTD,0)*0.9 ELSE           CASE WHEN CallYTD.CarrierName = 'Ultimate Health Plan' THEN (DATEDIFF(day, CAST('01/01/2020' AS DATE), CAST(GETDATE() AT TIME ZONE 'UTC'   AT TIME ZONE 'Eastern Standard Time' AS DATE))+1)*3592     ELSE ISNULL(dollarYTD.DollarYTD,0) END END) ProductRevenueYTD,    ISNULL(ProductCostToday.ProductCostToday,0) ProductCostToday,   ISNULL(ProductCostMTD.ProductCostMTD,0) ProductCostMTD,   ISNULL(ProductCostYTD.ProductCostYTD,0) ProductCostYTD,     ISNULL(ShippingCostToday.ShippingCostToday,0) ShippingCostToday,   ISNULL(ShippingCostMTD.ShippingCostMTD,0) ShippingCostMTD,   ISNULL(ShippingCostYTD.ShippingCostYTD,0) ShippingCostYTD,       'TBD' TotalCostToday,  'TBD' TotalCostMTD,  'TBD' TotalCostYTD,    (SELECT CASE WHEN CallYTD.CarrierName IN ('Clear Spring','EON Health Plan') THEN ISNULL(orderToday.[OrderCnt],0)*3 ELSE           CASE WHEN CallYTD.CarrierName IN ('OptimaHealth','Troy') THEN ISNULL(orderToday.[OrderCnt],0)*4     ELSE 0 END END ) ShippingRevenueToday,  (SELECT CASE WHEN CallYTD.CarrierName IN ('Clear Spring','EON Health Plan') THEN ISNULL(orderMTD.OrderCntMTD,0)*3 ELSE           CASE WHEN CallYTD.CarrierName IN ('OptimaHealth','Troy') THEN ISNULL(orderMTD.OrderCntMTD,0)*4     ELSE 0 END END ) ShippingRevenueMTD,  (SELECT CASE WHEN CallYTD.CarrierName IN ('Clear Spring','EON Health Plan') THEN ISNULL(orderYTD.OrderCntYTD,0)*3 ELSE           CASE WHEN CallYTD.CarrierName IN ('OptimaHealth','Troy') THEN ISNULL(orderYTD.OrderCntYTD,0)*4     ELSE 0 END END ) ShippingRevenueYTD,    'TBD' MarginToday,  'TBD' MarginMTD,  'TBD' MarginYTD,    ISNULL(callOrdersMTD.CallOrderMTD,0) as CallOrdersMTD,  ISNULL(callOrdersYTD.CallOrderYTD,0) as CallOrdersYTD,  ISNULL(onlineOrdersMTD.OnlineOrderMTD,0) as OnlineOrdersMTD,  ISNULL(onlineOrdersYTD.OnlineOrderYTD,0) as OnlineOrdersYTD,  --FullFillment   ISNULL(fullfillToday.FullFilledToday,0) as FullFilledToday,  ISNULL(fullfillMTD.FullFilledMTD,0) as FullFilledMTD    ------------------------------------------------END  into #tempJunk    FROM  ---------------------------------->>>CALLS  --CallYTD   (   SELECT    [CarrierName] AS 'CarrierName', SUM([CallCnt]) AS 'CallCntYTD'   FROM [exec
  --exec [bireports].[sp_FinalOTCGeneralVer1_rpt]   CREATE PROCEDURE [bireports].[sp_FinalOTCGeneralVer1_rpt]   AS  BEGIN     select * into #execreports_CallSummaryDetailsByDateOTC   from [execreports].[CallSummaryDetailsByDateOTC]   WHERE 1=1   and FORMAT(CAST(CALLDATE AS DATE),'yyyy') = FORMAT(CAST(GETDATE() AT TIME ZONE 'UTC'   AT TIME ZONE 'Eastern Standard Time' AS DATE),'yyyy')      CREATE NONCLUSTERED INDEX ix_tempCallSummaryDetailsByDateOTC ON #execreports_CallSummaryDetailsByDateOTC (CALLDATE);     select * into #execreports_OrderSummaryByDate   from [execreports].[OrderSummaryByDate]   where 1=1   and FORMAT(CAST([OrderDate] AS DATE),'yyyy') = FORMAT(CAST(GETDATE() AT TIME ZONE 'UTC'   AT TIME ZONE 'Eastern Standard Time' AS DATE),'yyyy')      CREATE NONCLUSTERED INDEX ix_tempOrderSummaryByDate ON #execreports_OrderSummaryByDate (OrderDate);     select * into #execreports_OrderSummaryDetails   from [execreports].[OrderSummaryDetails]   where 1=1   and FORMAT(CAST([OrderDate] AS DATE),'yyyy') = FORMAT(CAST(GETDATE() AT TIME ZONE 'UTC'   AT TIME ZONE 'Eastern Standard Time' AS DATE),'yyyy')     CREATE NONCLUSTERED INDEX ix_tempOrderSummaryDetails ON #execreports_OrderSummaryDetails (OrderDate);     SELECT   OI.ORDERID,   SUM(   (CASE WHEN OPP.[COGS] = 0 THEN OI.UnitPrice * 0.7          ELSE OPP.[COGS] END )*OI.Quantity   ) OrdCogs   into #ORDER_ITEM_COGS   FROM Orders.OrderItems OI   LEFT JOIN [execreports].[OTCProductPrices] OPP ON OPP.ITEMCODE= OI.ItemCode   WHERE OI.ItemType='OTC'   GROUP BY OI.OrderId       select   --from [execreports].[OrderSummaryOTCDetails] --this view moved to sp below   OS.[BENEFIT],   OS.[CarrierName],   OS.[OrderID],   OS.[Units],   OS.ORDERSOURCE,   OS.[ORDERAMT],   --SH.[OrderTransactionData],   ISNULL(CONVERT(VARCHAR,[OrderDate],101),'') AS 'OrderDate',   CAST(FX.CreateDate AT TIME ZONE 'UTC'   AT TIME ZONE 'Eastern Standard Time' AS DATE)  AS 'ShipDate',   CAST(ISNULL(FX.ShippingCost,0) as FLOAT) as 'ShippingCost',   ISNULL(FX.TrackingNumber,'') as 'TrackingNumber',   ISNULl(Cogs.OrdCogs,0) as 'COGS'   into #execreports_OrderSummaryOTCDetails   FROM [execreports].[OrderSummaryDetails] OS   --LEFT JOIN ORDERS.OrderTransactionDetails SH ON SH.OrderID=OS.OrderID AND SH.OrderStatusCode='SHI'   LEFT JOIN DBO.FedExShippingDetails FX ON case when isnumeric(FX.OrderId)=1 then cast(FX.OrderId as bigint) else 0 end = OS.OrderID --added by @DPSR 2272020             --FX.OrderId = OS.OrderID              --and FX.OrderId <> 'x' --added @DPSR on 2272020   LEFT JOIN ( SELECT * FROM #ORDER_ITEM_COGS ) Cogs ON Cogs.OrderId = OS.OrderID   WHERE [BENEFIT]='OTC'   and (     FORMAT(CAST(CreateDate AS DATE),'yyyy') = FORMAT(CAST(GETDATE() AT TIME ZONE 'UTC'   AT TIME ZONE 'Eastern Standard Time' AS DATE),'yyyy') OR     FORMAT(CAST([OrderDate] AS DATE),'yyyy') = FORMAT(CAST(GETDATE() AT TIME ZONE 'UTC'   AT TIME ZONE 'Eastern Standard Time' AS DATE),'yyyy')    )       CREATE NONCLUSTERED INDEX ix_tempOrderSummaryOTCDetails ON #execreports_OrderSummaryOTCDetails (OrderDate);   CREATE NONCLUSTERED INDEX ix_tempOrderSummaryOTCDetails2 ON #execreports_OrderSummaryOTCDetails (ShipDate);    SELECT   CallYTD.CarrierName,   ISNULL(CallYTD.CALLDATE, 0) CallCntToday,  ISNULL(CallYTD.CallCntMTD, 0) CallCntMTD,  ISNULL(CallYTD.CallCntYTD, 0) CallCntYTD,    ISNULL(orderYTD.OrderDate, 0) OrderCntToday,  ISNULL(orderYTD.OrderCntMTD, 0) OrderCntMTD,  ISNULL(orderYTD.OrderCntYTD, 0) OrderCntYTD,    ISNULL(unitsYTD.OrderUnits, 0) UnitsCntToday,  ISNULL(unitsYTD.UnitsCntMTD, 0) UnitsCntMTD,  ISNULL(unitsYTD.UnitsCntYTD, 0) UnitsCntYTD,    ISNULL(dollarYTD.DollarToday,0) CatalogPriceToday,  ISNULL(dollarYTD.DollarMTD, 0) CatalogPriceMTD,  ISNULL(dollarYTD.DollarYTD, 0) CatalogPriceYTD,    (SELECT CASE WHEN CallYTD.CarrierName = 'NationsOTC Program' THEN ISNULL(dollarYTD.DollarToday,0)*0.9 ELSE           CASE WHEN CallYTD.CarrierName = 'Ultimate Health Plan' THEN 3592     ELSE ISNULL(dollarYTD.DollarToday,0) END END) ProductReve
  -- exec [bireports].[Order_Detail_Report_2020]    CREATE PROC [bireports].[Order_Detail_Report_2020]  AS    --/****** Object:  StoredProcedure [bireports].[Order_Detail_Report_2020_SD_20200916]    Script Date: 9/23/2020 10:45:00 AM ******/  --SET ANSI_NULLS ON  --GO  --SET QUOTED_IDENTIFIER ON  --GO    ---- exec [bireports].[Order_Detail_Report_2020_SD_20200916]    --ALTER PROC [bireports].[Order_Detail_Report_2020_SD_20200916]  --AS    drop table if EXISTS #temp_fin_order_detail_report_2020      DROP TABLE IF EXISTS #FittingFee_CTE  DROP TABLE IF EXISTS #MemberPrice_CTE  DROP TABLE IF EXISTS #TechnologyLevel_CTE  DROP TABLE IF EXISTS #COGS_CTE    DROP TABLE IF EXISTS #Fin_OrdDt_PO  DROP TABLE IF EXISTS #Fin_OrdDt_PO_Type      SELECT DISTINCT HealthPlanContractID, ItemCode, EffectiveFrom, EffectiveTo, UnitPrice, PairPrice  INTO #FittingFee_CTE  FROM benefits.FittingFeeHistory with (NOLOCK)      SELECT DISTINCT HealthPlanContractID, ItemCode, EffectiveFrom, EffectiveTo, UnitPrice, PairPrice  INTO #MemberPrice_CTE  FROM benefits.MemberPriceHistory with (NOLOCK)      SELECT DISTINCT HealthPlanContractID, ItemCode, EffectiveFrom, EffectiveTo, UnitPrice  INTO #TechnologyLevel_CTE  FROM benefits.TechnologyLevelHistory with (NOLOCK)      SELECT DISTINCT ItemCode,pricetype,effectivefrom,effectiveto,unitcogs,paircogs  INTO #COGS_CTE   FROM catalog.ItemMasterPriceList  with (NOLOCK)  WHERE IsActive=1      SELECT DISTINCT e.OrderId,  LEFT(r.PONumber , LEN(r.PONumber)-1) PONumber,  LEFT(s.PODate , LEN(s.PODate)-1) PODate  INTO #Fin_OrdDt_PO  FROM orders.OrderPOs e with (nolock)  CROSS APPLY  (   SELECT CAST(r.PONumber as varchar(20)) + ', '   FROM orders.OrderPOs r with (nolock)   WHERE e.OrderId = r.OrderId         FOR XML PATH('')  ) r (PONumber)  CROSS APPLY  (   SELECT CAST(CAST(s.CreateDate AT TIME ZONE 'UTC' AT TIME ZONE 'Eastern Standard Time' AS DATE) AS VARCHAR(20)) + ', '     -- SELECT cast(s.PODate as varchar(20)) + ', '   FROM orders.OrderPOs s with (nolock)   WHERE e.OrderId = s.OrderId         FOR XML PATH('')  ) s (PODate)      SELECT DISTINCT ph.PONumber,hc.ItemType,ph.OrderId,CAST(CAST(ph.CreateDate AT TIME ZONE 'UTC' AT TIME ZONE 'Eastern Standard Time' AS DATE) AS VARCHAR(20)) PODate  --SELECT DISTINCT ph.PONumber,ph.OrderId,cast(ph.PODate as varchar(20)) PODate  INTO #Fin_OrdDt_PO_Type  FROM orders.OrderPOs ph  with (nolock)  JOIN orders.OrderItems hc with (nolock) ON (hc.PONumber=ph.PONumber AND hc.ItemType IN ('HA','CROS','EM') AND hc.IsActive=1)      -- Orders with only PO  SELECT DISTINCT  -- Order details  o.NHMemberId  ,o.OrderID [OrderNumber]  ,CAST(o.DateOrderReceived AS DATE) [DateOrderReceived]  ,CASE WHEN DATEPART(HOUR,o.DateOrderInitiated)=0 AND DATEPART(MINUTE,o.DateOrderInitiated)=0 AND DATEPART(SECOND,o.DateOrderInitiated) =0 THEN CAST(o.DateOrderInitiated AS DATE)             ELSE CAST(CAST(o.DateOrderInitiated AT TIME ZONE 'UTC' AT TIME ZONE 'Eastern Standard Time' AS DATETIME) AS DATE) END [OrderCreatedDate]  ,CASE WHEN ISNULL(o.OrderType,'')='EXCHANGE' THEN 'NEW' ELSE o.OrderType END AS [OrderType] -- EXCHANGE should be NEW  ,CASE WHEN ISNULL(o.OrderType,'') IN ('EXCHANGE','LSandD') THEN o.RefOrderId ELSE NULL END AS [ReferenceOrder] -- Only for EXCHANGE & LSandD orders if available  ,o.Status    -- Carrier & Healthplan  ,c.InsuranceCarrierName  ,CAST(JSON_VALUE(o.MemberData,'$.insCarrierId') AS INT) AS InsuranceCarrierID  ,hp.HealthPlanName InsuranceHealthPlanName  ,CAST(JSON_VALUE(o.MemberData,'$.insPlanId') AS INT) AS InsuranceHealthPlanID  -- From Orders JSON  --,CASE WHEN JSON_VALUE(o.MemberData, '$.insurance.carrierName') = 'None' OR JSON_VALUE(o.MemberData, '$.insurance.carrierName') = '' THEN JSON_VALUE(o.MemberData, '$.insurance.programeName')  --      ELSE JSON_VALUE(o.MemberData, '$.insurance.carrierName') END AS 'CarrierName_JSON'  --,JSON_VALUE(o.MemberData, '$.insurance.planName') AS 'PlanName_JSON'      -- Member Details   ,JSON_VALUE(o.MemberData,'$.firstName') AS [MemberFirstName] 
  -- exec [bireports].[Order_Detail_Report_before_2020]    CREATE PROC [bireports].[Order_Detail_Report_before_2020]  AS      DROP TABLE IF EXISTS #FittingFee_CTE  DROP TABLE IF EXISTS #MemberPrice_CTE  DROP TABLE IF EXISTS #TechnologyLevel_CTE  DROP TABLE IF EXISTS #COGS_CTE    DROP TABLE IF EXISTS #Fin_OrdDt_PO  DROP TABLE IF EXISTS #Fin_OrdDt_PO_Type    SELECT DISTINCT HealthPlanContractID, ItemCode, EffectiveFrom, EffectiveTo, UnitPrice, PairPrice  INTO #FittingFee_CTE  FROM benefits.FittingFeeHistory with (NOLOCK)      SELECT DISTINCT HealthPlanContractID, ItemCode, EffectiveFrom, EffectiveTo, UnitPrice, PairPrice  INTO #MemberPrice_CTE  FROM benefits.MemberPriceHistory with (NOLOCK)      SELECT DISTINCT HealthPlanContractID, ItemCode, EffectiveFrom, EffectiveTo, UnitPrice  INTO #TechnologyLevel_CTE  FROM benefits.TechnologyLevelHistory with (NOLOCK)      SELECT DISTINCT ItemCode,pricetype,effectivefrom,effectiveto,unitcogs,paircogs  INTO #COGS_CTE   FROM catalog.ItemMasterPriceList  with (NOLOCK)  WHERE IsActive=1        SELECT DISTINCT e.OrderId,  LEFT(r.PONumber , LEN(r.PONumber)-1) PONumber,  LEFT(s.PODate , LEN(s.PODate)-1) PODate  INTO #Fin_OrdDt_PO  FROM orders.OrderPOs e with (nolock)  CROSS APPLY  (   SELECT CAST(r.PONumber as varchar(20)) + ', '   FROM orders.OrderPOs r with (nolock)   WHERE e.OrderId = r.OrderId         FOR XML PATH('')  ) r (PONumber)  CROSS APPLY  (   SELECT CAST(CAST(s.CreateDate AT TIME ZONE 'UTC' AT TIME ZONE 'Eastern Standard Time' AS DATE) AS VARCHAR(20)) + ', '     -- SELECT cast(s.PODate as varchar(20)) + ', '   FROM orders.OrderPOs s with (nolock)   WHERE e.OrderId = s.OrderId         FOR XML PATH('')  ) s (PODate)      SELECT DISTINCT ph.PONumber,hc.ItemType,ph.OrderId,CAST(CAST(ph.CreateDate AT TIME ZONE 'UTC' AT TIME ZONE 'Eastern Standard Time' AS DATE) AS VARCHAR(20)) PODate  --SELECT DISTINCT ph.PONumber,ph.OrderId,cast(ph.PODate as varchar(20)) PODate  INTO #Fin_OrdDt_PO_Type  FROM orders.OrderPOs ph  with (nolock)  JOIN orders.OrderItems hc with (nolock) ON (hc.PONumber=ph.PONumber AND hc.ItemType IN ('HA','CROS','EM') AND hc.IsActive=1)      -- Orders with only PO  SELECT DISTINCT  -- Order details  o.NHMemberId  ,o.OrderID [OrderNumber]  ,CAST(o.DateOrderReceived AS DATE) [DateOrderReceived]  ,CASE WHEN DATEPART(HOUR,o.DateOrderInitiated)=0 AND DATEPART(MINUTE,o.DateOrderInitiated)=0 AND DATEPART(SECOND,o.DateOrderInitiated) =0 THEN CAST(o.DateOrderInitiated AS DATE)             ELSE CAST(CAST(o.DateOrderInitiated AT TIME ZONE 'UTC' AT TIME ZONE 'Eastern Standard Time' AS DATETIME) AS DATE) END [OrderCreatedDate]  ,CASE WHEN ISNULL(o.OrderType,'')='EXCHANGE' THEN 'NEW' ELSE o.OrderType END AS [OrderType] -- EXCHANGE should be NEW  ,CASE WHEN ISNULL(o.OrderType,'') IN ('EXCHANGE','LSandD') THEN o.RefOrderId ELSE NULL END AS [ReferenceOrder] -- Only for EXCHANGE & LSandD orders if available  ,o.Status    -- Carrier & Healthplan  ,c.InsuranceCarrierName  ,CAST(JSON_VALUE(o.MemberData,'$.insCarrierId') AS INT) AS InsuranceCarrierID  ,hp.HealthPlanName InsuranceHealthPlanName  ,CAST(JSON_VALUE(o.MemberData,'$.insPlanId') AS INT) AS InsuranceHealthPlanID  -- From Orders JSON  --,CASE WHEN JSON_VALUE(o.MemberData, '$.insurance.carrierName') = 'None' OR JSON_VALUE(o.MemberData, '$.insurance.carrierName') = '' THEN JSON_VALUE(o.MemberData, '$.insurance.programeName')  --      ELSE JSON_VALUE(o.MemberData, '$.insurance.carrierName') END AS 'CarrierName_JSON'  --,JSON_VALUE(o.MemberData, '$.insurance.planName') AS 'PlanName_JSON'    -- Member Details   ,JSON_VALUE(o.MemberData,'$.firstName') AS [MemberFirstName]  ,JSON_VALUE(o.MemberData,'$.lastName') AS [MemberLastName]    -- Provider Data  ,JSON_VALUE(o.ProviderData,'$.providerId') AS [ProviderID]  --,JSON_VALUE(o.ProviderData,'$.address.locationId') AS [LocationID]    ,pp.ProviderName AS [ProviderLegalName]  ,ISNULL(CASE WHEN pp.DBA='' THEN NULL ELSE pp.DBA END,l.BusinessName) AS [ProviderDBA] -- Take location name if provider DBA i
      --exec [bireports].[sp_OrderItemDetails_By_BrandTech_rpt]   CREATE PROCEDURE [bireports].[sp_OrderItemDetails_By_BrandTech_rpt]   AS  BEGIN      select distinct BrandCode,FamilyProductCatCode, HealthPlanContractId, IsActive, ItemCode    into #CONTRACT_PRODUCTS_EXECRPT    from Insurance.ContractProducts    where  BrandCode IS NOT NULL      SELECT     JSON_VALUE(OS.MemberData,'$.insCarrierId') CarrierID,     JSON_VALUE(OS.MemberData,'$.insPlanId') PlanID,     ic.InsuranceCarrierName as 'CarrierName',     OS.OrderID,      --HC.HealthPlanContractID,     --CAST(OS.CREATEDATE  AT TIME ZONE 'UTC'   AT TIME ZONE 'Eastern Standard Time' AS DATE) AS 'OrderDate',     OS.CREATEDATE as 'OrderDate',     OI.BrandCode,      OI.OrderItemId,     OI.ItemCode,     CP.FamilyProductCatCode as 'TechLevel'     into #OrderItemDetails_rawdata    FROM Insurance.InsuranceCarriers IC     INNER JOIN ORDERS.Orders OS ON (OS.ISACTIVE=1        AND OS.OrderID > 200000000        AND OS.Status NOT in ('CANCELLED')        AND OS.OrderStatusCode NOT IN ('CAN')       AND OS.OrderType NOT LIKE '%OTC%'        AND JSON_VALUE(OS.MemberData,'$.insCarrierId') = IC.InsuranceCarrierID       --AND FORMAT(CAST(OS.[CreateDate] AS DATE),'MM-yyyy') = FORMAT(CAST(GETDATE() AT TIME ZONE 'UTC'   AT TIME ZONE 'Eastern Standard Time' AS DATE),'MM-yyyy')       --AND FORMAT(CAST(OS.[CreateDate] AS DATE),'yyyy') = FORMAT(CAST(GETDATE() AT TIME ZONE 'UTC'   AT TIME ZONE 'Eastern Standard Time' AS DATE),'yyyy')       )    INNER JOIN Insurance.HealthPlanContracts HC ON HC.IsActive=1        AND HC.InsuranceCarrierID=JSON_VALUE(OS.MemberData,'$.insCarrierId')        AND HC.InsuranceHealthPlanID=JSON_VALUE(OS.MemberData,'$.insPlanId')     INNER JOIN ORDERS.OrderItems OI ON OI.IsActive=1 AND OI.ItemType='HA'      AND OI.OrderId=OS.OrderID        AND OI.Status NOT IN ('CANCELLED')    INNER JOIN (select * from #CONTRACT_PRODUCTS_EXECRPT) CP ON CP.IsActive=1        AND CP.HealthPlanContractId = HC.HealthPlanContractID        AND OI.ItemCode=CP.ItemCode    WHERE IC.IsContracted=1 AND IC.IsActive=1        --select * from #OrderItemDetails_rawdata where 1=1    SELECT 'Brand' as ReportType, 'MTD' as SummaryTypr ,     CarrierName, [BELTONE],[GNR],[STARKEY],[PHONAK],[UNITRON],[OTICON],[SIGNIA],[WIDEX]  into #temp_pivot  FROM  (     SELECT CarrierName, BrandCode, OrderItemId    from #OrderItemDetails_rawdata    where 1=1    AND FORMAT(CAST(OrderDate AS DATE),'MM-yyyy') = FORMAT(CAST(GETDATE() AT TIME ZONE 'UTC'   AT TIME ZONE 'Eastern Standard Time' AS DATE),'MM-yyyy')    ) SRC  PIVOT  (     COUNT(OrderItemId)     FOR BrandCode IN ([BELTONE],[GNR],[STARKEY],[PHONAK],[UNITRON],[OTICON],[SIGNIA],[WIDEX])  ) PIV    union     SELECT 'Tech' as ReportType, 'MTD' as SummaryTypr,     CarrierName, [Entry],[Basic],[Advanced],[Prime],[Premium],[Superior],[Peak],[Peak Pro]  FROM  (     SELECT CarrierName, TechLevel, OrderItemId     from #OrderItemDetails_rawdata     where 1=1     AND FORMAT(CAST(OrderDate AS DATE),'MM-yyyy') = FORMAT(CAST(GETDATE() AT TIME ZONE 'UTC'   AT TIME ZONE 'Eastern Standard Time' AS DATE),'MM-yyyy')    ) SRC  PIVOT  (     COUNT(OrderItemId)     FOR TechLevel IN ([Entry],[Basic],[Advanced],[Prime],[Premium],[Superior],[Peak],[Peak Pro])  ) PIV    union --YTD    SELECT 'Brand' as ReportType, 'YTD' as SummaryTypr ,     CarrierName, [BELTONE],[GNR],[STARKEY],[PHONAK],[UNITRON],[OTICON],[SIGNIA],[WIDEX]  FROM  (     SELECT CarrierName, BrandCode, OrderItemId    from #OrderItemDetails_rawdata    where 1=1    AND FORMAT(CAST(OrderDate AS DATE),'yyyy') = FORMAT(CAST(GETDATE() AT TIME ZONE 'UTC'   AT TIME ZONE 'Eastern Standard Time' AS DATE),'yyyy')  ) SRC  PIVOT  (     COUNT(OrderItemId)     FOR BrandCode IN ([BELTONE],[GNR],[STARKEY],[PHONAK],[UNITRON],[OTICON],[SIGNIA],[WIDEX])  ) PIV    union     SELECT 'Tech' as ReportType, 'YTD' as SummaryTypr,     CarrierName, [Entry],[Basic],[Advanced],[Prime],[Premium],[Superior],[Peak],[Peak Pro]  FROM  (     SELECT CarrierName, TechLevel, OrderIt
  --exec [bireports].[sp_DHCSummary_rpt]   CREATE PROCEDURE [bireports].[sp_DHCSummary_rpt]   AS  BEGIN      SELECT       DeviceId     ,MemberInfo     ,CreateDate AS CreateDateOrg     ,CAST(CreateDate AT TIME ZONE 'UTC'   AT TIME ZONE 'Eastern Standard Time' AS DATE) AS CreateDate     ,SessionStatus     ,CAST(StartDateTime AT TIME ZONE 'UTC'   AT TIME ZONE 'Eastern Standard Time' AS DATETIME) AS StartDateTime     ,CAST(EndDateTime AT TIME ZONE 'UTC'   AT TIME ZONE 'Eastern Standard Time' AS DATETIME) AS EndDateTime     ,Name     ,SessionId     ,JSON_VALUE(MemberInfo, '$.MemberInsuranceID') MemberInsuranceID     ,JSON_VALUE(MemberInfo, '$.InsuranceType') InsuranceType     ,JSON_VALUE(MemberInfo, '$.InsurerInsuranceNbr') InsurerInsuranceNbr --search number     ,JSON_VALUE(MemberInfo, '$.IsAdvanceMember') IsAdvanceMember ----if found in search then true else false     ,JSON_VALUE(MemberInfo, '$.PolicyNumber') PolicyNumber     ,JSON_VALUE(MemberInfo, '$.IsMedicaid') IsMedicaid     ,JSON_VALUE(MemberInfo, '$.IsMedicare') IsMedicare     ,JSON_VALUE(MemberInfo, '$.IsDiscountProgram') IsDiscountProgram     INTO #temp    FROM dhc.DeviceSession    WHERE 1=1    AND DeviceId >=5    AND FORMAT(CAST(CreateDate AS DATE),'yyyy') = FORMAT(CAST(GETDATE() AT TIME ZONE 'UTC'   AT TIME ZONE 'Eastern Standard Time' AS DATE),'yyyy')        --SELECT * FROM #temp t WHERE t.SessionStatus IN ('E','T')      ALTER TABLE #temp ADD userType VARCHAR(100)      UPDATE #temp SET CreateDate = DATEADD(MONTH,1,CreateDate),CreateDateOrg = DATEADD(MONTH,1,CreateDateOrg),        StartDateTime = DATEADD(MONTH,1,StartDateTime),        EndDateTime = DATEADD(MONTH,1,EndDateTime)    WHERE CreateDate BETWEEN '02/01/2020' AND '02/24/2020'        --SELECT * FROM #temp t WHERE t.SessionStatus IN ('E','T') ORDER BY 3 desc      UPDATE #temp SET SessionStatus='E',EndDateTime= DATEADD(MINUTE,3,CAST(EndDateTime AS DATETIME)) WHERE StartDateTime='2020-03-21 09:21:00.593'    UPDATE #temp SET SessionStatus='E',EndDateTime= DATEADD(MINUTE,3,CAST(EndDateTime AS DATETIME)) WHERE StartDateTime='2020-03-24 09:36:57.443'      UPDATE #temp SET InsurerInsuranceNbr = 'H4577579' WHERE SessionStatus = 'E' AND DeviceId = 5 AND InsurerInsuranceNbr = ''     UPDATE #temp SET InsurerInsuranceNbr = 'H45456579' WHERE SessionStatus = 'E' AND DeviceId = 6 AND InsurerInsuranceNbr = ''       --SELECT * FROM #temp t WHERE t.SessionStatus IN ('E') AND t.DeviceId = 6 AND InsurerInsuranceNbr IS NOT NULL      UPDATE #temp SET IsAdvanceMember='TRUE' WHERE SessionStatus IN ('E') AND DeviceId = 6 AND InsurerInsuranceNbr IS NOT NULL AND CreateDate ='2020-03-20'    UPDATE #temp SET IsAdvanceMember='TRUE' WHERE SessionStatus IN ('E') AND DeviceId = 6 AND InsurerInsuranceNbr IS NOT NULL AND StartDateTime ='2020-03-19 10:05:37.250'      UPDATE #temp SET usertype = 'Florida Blue, Medicare Advantage' WHERE InsurerInsuranceNbr IS NOT NULL AND IsAdvanceMember ='True'      UPDATE #temp SET usertype = 'Florida Blue, but not Medicare Advantage' WHERE InsurerInsuranceNbr IS NOT NULL AND IsAdvanceMember ='False'      UPDATE #temp SET usertype = 'Non-Florida Blue Member' WHERE usertype IS NULL AND name =''      update #temp SET usertype ='No Demographics Collected' WHERE usertype IS NULL AND Name='Guest'        update #temp SET usertype ='No Demographics Collected'  WHERE usertype IS NULL AND SessionStatus IN ('E','T')      DECLARE @DGetDate AS DATETIME    SELECT @DGetDate=CAST(GETDATE()-3 AT TIME ZONE 'UTC'   AT TIME ZONE 'Eastern Standard Time' AS DATE)    select     1 AS forGroupOrder    ,  DeviceId          , 'All Users' AS UserType    , SUM(CASE WHEN SessionStatus = 'E' AND CreateDate  = (@DGetDate - 1) THEN 1 ELSE 0 END) AS 'Completed Tests Yesterday'    , SUM(CASE WHEN SessionStatus = 'E' AND CreateDate = @DGetDate THEN 1 ELSE 0 END) AS 'Completed Tests Today'    , SUM(CASE WHEN SessionStatus = 'E' AND DATEPART(wk,CreateDate) = datepart(wk,@DGetDate) THEN 1 ELSE 0 END) AS 'Completed Tests WTD'        , SUM(CASE WHEN Sess
  -- EXEC bireports.sp_rpt_client_CCA_Utilization_Member_Spending NULL,NULL,'D' -- Yesterday  -- EXEC bireports.sp_rpt_client_CCA_Utilization_Member_Spending NULL,NULL,'M' -- Previous Month  -- EXEC bireports.sp_rpt_client_CCA_Utilization_Member_Spending NULL,NULL,'MTD' -- Month To Date  -- EXEC bireports.sp_rpt_client_CCA_Utilization_Member_Spending NULL,NULL,'YTD' -- Year To Date until current day  -- EXEC bireports.sp_rpt_client_CCA_Utilization_Member_Spending '01/01/2020','04/15/2020','X' -- Year To Date including current date      create proc [bireports].[sp_rpt_client_CCA_Utilization_Member_Spending_bkp_20200518] (@Start_Date date, @End_Date date, @DateRange char(5))  as     Declare @StartDate date;  Declare @EndDate date;                -- Custom Date Range    if @DateRange='X'    begin       set @StartDate =  @Start_Date                set @EndDate =  @End_Date             end          -- Returns previous day     if @DateRange='D'    begin     set @StartDate = DATEADD(DAY,-1,CONVERT(DATE,CAST(GETDATE() AT TIME ZONE 'UTC' AT TIME ZONE 'Eastern Standard Time' AS DATE)))                 set @EndDate =   DATEADD(DAY,-1,CONVERT(DATE,CAST(GETDATE() AT TIME ZONE 'UTC' AT TIME ZONE 'Eastern Standard Time' AS DATE)))              end      -- Returns first and last day of previous month    if @DateRange='M'    begin     set @EndDate = dateadd(dd,-1,cast(cast(year(CAST(GETDATE() AT TIME ZONE 'UTC' AT TIME ZONE 'Eastern Standard Time' AS DATE)) as varchar(4))+'/'+cast(month(CAST(GETDATE() AT TIME ZONE 'UTC' AT TIME ZONE 'Eastern Standard Time' AS DATE)) as varchar(2))+'/1' as date))     set @StartDate = cast(cast(year(@EndDate) as varchar(4))+'/'+cast(month(@EndDate) as varchar(2))+'/1' as date);       end      -- Returns first and last day of previous week - first day of week starts with Sunday    if @DateRange='W'    begin     set @StartDate = DATEADD(wk, -1, DATEADD(DAY, 1-DATEPART(WEEKDAY, CAST(GETDATE() AT TIME ZONE 'UTC' AT TIME ZONE 'Eastern Standard Time' AS DATE)), DATEDIFF(dd, 0, CAST(GETDATE() AT TIME ZONE 'UTC' AT TIME ZONE 'Eastern Standard Time' AS DATE))))     set @EndDate = DATEADD(wk, 0, DATEADD(DAY, 0-DATEPART(WEEKDAY, CAST(GETDATE() AT TIME ZONE 'UTC' AT TIME ZONE 'Eastern Standard Time' AS DATE)), DATEDIFF(dd, 0, CAST(GETDATE() AT TIME ZONE 'UTC' AT TIME ZONE 'Eastern Standard Time' AS DATE))))    end        -- Returns first day and yesterday of the current month as start and end dates when run on any day except 1st day of any month, if run on 1st of any month gives first and last date of the previous month    -- Use this for reports that should include MTD data and runs every day in a month.    if @DateRange='MTD'    begin     set @StartDate = case when DATEPART(DAY,CONVERT(DATE,CAST(GETDATE() AT TIME ZONE 'UTC' AT TIME ZONE 'Eastern Standard Time' AS DATE))) <> 1           then DATEADD(MONTH, DATEDIFF(MONTH, 0, CAST(GETDATE() AT TIME ZONE 'UTC' AT TIME ZONE 'Eastern Standard Time' AS DATE)), 0)               when DATEPART(DAY,CONVERT(DATE,CAST(GETDATE() AT TIME ZONE 'UTC' AT TIME ZONE 'Eastern Standard Time' AS DATE))) = 1            then DATEADD(MONTH, DATEDIFF(MONTH, 0, CAST(GETDATE() AT TIME ZONE 'UTC' AT TIME ZONE 'Eastern Standard Time' AS DATE))-1, 0)             END       set @EndDate  = case when DATEPART(DAY,CONVERT(DATE,CAST(GETDATE() AT TIME ZONE 'UTC' AT TIME ZONE 'Eastern Standard Time' AS DATE))) <> 1           then DATEADD(DAY, DATEDIFF(DAY, 0, CAST(GETDATE()-1 AT TIME ZONE 'UTC' AT TIME ZONE 'Eastern Standard Time' AS DATE)), 0)                    when DATEPART(DAY,CONVERT(DATE,CAST(GETDATE() AT TIME ZONE 'UTC' AT TIME ZONE 'Eastern Standard Time' AS DATE))) = 1           then DATEADD(MONTH, DATEDIFF(MONTH, -1, CAST(GETDATE() AT TIME ZONE 'UTC' AT TIME ZONE 'Eastern Standard Time' AS DATE))-1, -1)                   END    end        -- First day of year to current date    if @DateRange='YTD'    begin     set @StartDate = case when DATEPART(DAY,CONVERT(DATE,CAST(GETDATE() AT TIME ZONE 'UTC' AT 
            CREATE PROCEDURE [CallCenter].[Get_AvailableAgents]     AS  BEGIN     -- drop table #ActiveConversations   select AgentuserProfileId INTO #ActiveConversations    from callcenter.callconversations where CONVERT(VARCHAR, CreateDate, 23) >= CONVERT(VARCHAR, GETDATE(), 23) and EndCallSummaryEnd IS NULL    group by AgentuserProfileId     -- drop table #EndConversations   select AgentuserProfileId, max(endtime) as endtime INTO #EndConversations      from callcenter.callconversations where CONVERT(VARCHAR, CreateDate, 23) >= CONVERT(VARCHAR, GETDATE(), 23)    and AgentuserProfileId not in    (    select AgentuserProfileId from #ActiveConversations    --from callcenter.callconversations where CONVERT(VARCHAR, CreateDate, 23) >= CONVERT(VARCHAR, GETDATE(), 23) and processflag =0    --group by AgentuserProfileId   )      group by AgentuserProfileId     -- select * from #EndConversations     SELECT CAST(up.UserProfileId AS bigint) AS UserProfileId,up.UserProfileImage, up.UserName,(up.FirstName +' '+ up.LastName) as FullName,   up.LastLoginDate,   --cc.endtime as LastLoginDate,   CAST(upg.UserGroupId AS bigint) AS UserGroupId FROM [auth].[UserProfiles] up   INNER JOIN [auth].UserProfileGroups upg WITH (NOLOCK)   ON up.UserProfileId = upg.UserProfileId    LEFT JOIN #EndConversations cc on cc.AgentUserProfileId = up.UserProfileId    WHERE CONVERT(VARCHAR, up.LastLoginDate, 23) >= CONVERT(VARCHAR, GETDATE(), 23) and upg.UserGroupId IN( 6500, 6400) and up.IsForcedLogOut = 0   AND up.UserProfileId NOT IN (select AgentuserProfileId from #ActiveConversations)   ORDER BY cc.endtime    END  
            CREATE PROCEDURE [CallCenter].[Get_AvailableAgents_V2]   @sessionId VARCHAR(50)  AS  BEGIN     select AgentuserProfileId INTO #ActiveConversations    from callcenter.callconversations where CONVERT(VARCHAR, CreateDate, 23) >= CONVERT(VARCHAR, GETDATE(), 23) and EndCallSummaryEnd IS NULL    group by AgentuserProfileId   select AgentuserProfileId, max(endtime) as endtime INTO #EndConversations      from callcenter.callconversations where CONVERT(VARCHAR, CreateDate, 23) >= CONVERT(VARCHAR, GETDATE(), 23)    and AgentuserProfileId not in    (    select AgentuserProfileId from #ActiveConversations    --from callcenter.callconversations where CONVERT(VARCHAR, CreateDate, 23) >= CONVERT(VARCHAR, GETDATE(), 23) and processflag =0    --group by AgentuserProfileId   )      group by AgentuserProfileId     SELECT CAST(up.UserProfileId AS bigint) AS UserProfileId,up.UserProfileImage, up.UserName,(up.FirstName +' '+ up.LastName) as FullName,   --up.LastLoginDate,   cc.endtime as LastLoginDate,   CAST(upg.UserGroupId AS bigint) AS UserGroupId INTO #ActiveAgents FROM [auth].[UserProfiles] up   INNER JOIN [auth].UserProfileGroups upg WITH (NOLOCK)   ON up.UserProfileId = upg.UserProfileId    LEFT JOIN #EndConversations cc on cc.AgentUserProfileId = up.UserProfileId    WHERE CONVERT(VARCHAR, up.LastLoginDate, 23) >= CONVERT(VARCHAR, GETDATE(), 23) and upg.UserGroupId IN( 6500, 6400) and up.IsForcedLogOut = 0   AND up.UserProfileId NOT IN (select AgentuserProfileId from #ActiveConversations)   AND up.UserProfileId NOT IN    (    SELECT AgentuserProfileId FROM (    SELECT *, ROW_NUMBER() OVER (PARTITION BY AgentuserProfileId ORDER BY CreateDate desc) AS ROWNUM     FROM [dhc].[AgentCallPerfomanceLogs] ) x WHERE ROWNUM = 1  AND  CONVERT(VARCHAR, CreateDate, 23) >= CONVERT(VARCHAR, GETDATE(), 23)  AND DATEDIFF(SECOND, CreateDate, GETDATE()) <= 10    )   ORDER BY cc.endtime      IF EXISTS (select TOP 1 UserProfileId from #ActiveAgents )    BEGIN     INSERT INTO dhc.Agentcallperfomancelogs(AgentUserProfileId, SessionID,CallSource, CreateDateTime, IsActive, CreateDate, CreateUser,ModifyUser,CallStatus)     VALUES     ((select TOP 1 UserProfileId from #ActiveAgents), @sessionId, 'DHC', GETDATE(), 1, GETDATE(), 'SystemUser','SystemUser', 100)   END      select * from #ActiveAgents order by LastLoginDate    END  
-- =============================================  -- Author:      Micah Elliott  -- Create Date: 9/13/2019  -- Description: Creates a new MEA Account    -- EXEC [CallCenter].[CreateMEAAccount] 'Benjamin','Earle','bearle'    -- =============================================  CREATE PROCEDURE [CallCenter].[CreateMEAAccount]  (      @FirstName varchar(50) = '',   @LastName varchar(100) = '',   @Username varchar(50) = NULL  )  AS  BEGIN      -- SET NOCOUNT ON added to prevent extra result sets from      -- interfering with SELECT statements.      SET NOCOUNT ON     declare @createuser varchar(100)     declare @appmoduleroleid bigint   declare @appmoduleid bigint   declare @userprofileid bigint   declare @usergroupid bigint   declare @usergroupmoduleid bigint   declare @usergroupmoduleroleid bigint   declare @appmodulerolemenuid bigint     declare @output table (id bigint)     -------------------   set @createuser = 'NHAdmin'   -------------------     -- Get Module   set @appmoduleid = (select AppModuleId from auth.AppModules where ModuleName = 'CallCenter Portal')     -- Get role   set @appmoduleroleid = (select AppModuleRoleId from auth.AppModuleRoles where AppModuleId = @appmoduleid and AppModuleRoleName = 'CallCenter Agent')     -- Get Menus for Role   set @appmodulerolemenuid = (select AppModuleRoleMenuId from auth.AppModuleRoleMenus where AppModuleRoleId = @appmoduleroleid and AppModuleRoleMenuName = 'Home')     -- Get User Groups for Role   set @usergroupid = (select UserGroupId from auth.UserGroups where UserGroupName = 'NH-CallCenter Agent Group')     -- Get usergroup<-->appmodule connection for Role   set @usergroupmoduleid = (select UserGroupModuleId from auth.UserGroupModules where AppModuleId = @appmoduleid and UserGroupId = @usergroupid)     -- Get usergroup<-->appmodulerole connection for Role   set @usergroupmoduleroleid = (select UserGroupModuleRoleId from auth.UserGroupModuleRoles where UserGroupId = @usergroupid and AppModuleRoleId = @appmoduleroleid)     declare @keycode varchar(10) = (SELECT REPLACE(LOWER(LEFT(NEWID(), 10)), '-', ''))     -- Create new user    insert into auth.UserProfiles(FirstName, MiddleName, LastName, IsBlocked, IsEnabled, IsRegister, TemproryKeyCode, UserName,     CreateUser, CreateDate, ModifyUser, ModifyDate, IsActive)   output inserted.UserProfileId into @output   values (    @firstname,    '',    @lastname,    0, 1, 0,    @keycode,    ISNULL(@Username, LOWER(CONCAT(LEFT(@firstname, 1), @lastname))),    @createuser, GETDATE(), @createuser, GETDATE(), 1   )   set @userprofileid = (select top 1 id from @output)   delete from @output     -- Add user group   insert into auth.UserProfileGroups(UserGroupId, UserProfileId, CreateUser, CreateDate, ModifyUser, ModifyDate, IsActive)   values (    @usergroupid,    @userprofileid,    @createuser, GETDATE(), @createuser, GETDATE(), 1   )     -- Add user settings   insert into auth.UserProfileSettings(UserProfileId, SettingName, SettingValue, CreateUser, CreateDate, ModifyUser, ModifyDate, IsActive)   values (    @userprofileid,    'Roles',    '["'+ cast(@appmoduleroleid as varchar) +'"]',    @createuser, GETDATE(), @createuser, GETDATE(), 1   )     insert into provider.providerusers   select    (select top 1 ProviderId from provider.providerprofiles where providercode = 180000),    @userprofileid,    GETDATE(),    @createuser,    1,    GETDATE(),    @createuser     insert into provider.provideruserlocations   select    (select top 1 ProviderId from provider.providerprofiles where providercode = 180000),    (select top 1 LocationId from provider.provideruserlocations where providerid = (select top 1 ProviderId from provider.providerprofiles where providercode = 180000)),    @userprofileid,    GETDATE(),    @createuser,    1,    GETDATE(),    @createuser     -- Set default NH Provider Code   update auth.UserProfiles set ProviderCode = 180000 where UserProfileId = @userprofileid      select @userprofileid, ISNULL(@Username, LOWER(CONCAT(LEFT(@firstname,
  -- =============================================  -- Author:      <Author, , Suneetha>  -- Create Date: <Create Date, , 4th April 2019>  -- Description: <Description, , Gets the Member Call conversation notes and provider notes together>  -- =============================================  CREATE PROCEDURE [CallCenter].[GetMemberCallLogHistory]  (     @nhMemberId nvarchar(150)  )  AS  BEGIN  select ROW_NUMBER() OVER(ORDER BY AgentId) as RowId,* from(   select c.AgentUserProfileName as AgentName,c.AgentUserProfileId as AgentId,e.eventCode as DispositionCode,   e.eventName as DispositionText,c.createDate as CallDateAndTime,'' as LeadStatus,   c.CallEndSummary as EndCallSummary,c.CallBound as CallType    from [CallCenter].[CallConversations] c    inner join [CallCenter].[CallPageEvents] p on p.[CallConversationId] = c.[CallConversationId]   inner join [jobs].[Events] e on e.eventId = p.eventId   where c.MemberNHMemberId = @nhMemberId AND EventTriggerBy = 'DISPOSITION'   UNION   select n.CreateUser,n.ProviderId, null,null,n.createDate,null,n.Notes,case when PP.ProviderCode=180000 then 'ADM' else 'PRV' end    from [provider].[ConsultationNotes] n    join [provider].[ProviderProfiles] as PP on PP.providerid=n.providerid   where n.nhmemberid=@nhMemberId and  n.isactive=1   UNION   SELECT CreateUser,MemberNoteId,'','',CreateDate,'' as LeadStatus,    MemberNoteText,'NOTE'   FROM [provider].[MemberNotes]  WHERE NHMemberId= @nhMemberId   )s order by CallDateAndTime desc  END
-- 11/09/2020 - Damian Montero - Ran on stage.  --11/21/2020 - Mohan Deployed to PROD    /*  Author: Harika Date: 11-05-2020  Comments: Added Copay unit and pair prices.  */  CREATE PROCEDURE [catalog].[getModelDetailsByModelCode]   @modelCode varchar(30),   @insuranceCarrierID int = 0 ,   @healthPlanID int = 0,   @itemCode varchar(100) = ''   AS   BEGIN     IF @itemCode = ''     BEGIN      SELECT DISTINCT      vm.ModelCode AS ProductModelCode,      vm.BrandCode AS BrandCode,      vm.FamilyCode AS BrandFamilyCode,      NULL AS EarmoldTypeCode,      vm.TechnologyCode AS FamilyProductCode,      NULL AS ProductTypeCode,      vm.StyleCode as ShellCode,      vm.TechnologyCode AS TechnologyLevelCode,      mContent.ModelOverview AS ModelOverview,      mContent.ModelLongDescription AS ModelLongDescription,      ISNULL(conProd.[PerDeviceMemberPrice],0) AS UnitProductPrice,      conProd.[FamilyProductCatCode] AS TechnologyLevel,      ISNULL([PerPairMemberPrice],0) AS PairProductPrice,      CAST(0 AS FLOAT) AS Benefit,      mContent.ModelShortDescription AS [Description],      mContent.DefaultImage AS MediaURL,      mContent.FamilyLogoImage AS FamilyLogoImage,      mContent.FamilyBannerImage AS FamilyBannerImage,      vm.StyleCode AS StyleName,      0 AS StyleID,      vm.StyleCode AS StyleCode,      vm.ItemCode AS ItemCode      ,CAST(0 AS FLOAT) AS CopayUnitPrice --Added by Harika      ,CAST(0 AS FLOAT) AS CopayPairPrice --Added by Harika          FROM [catalog].[ItemMasterList] vm      INNER JOIN (      SELECT * FROM insurance.ContractProducts WHERE HealthPlanContractID = (       SELECT TOP 1 HealthPlanContractID FROM insurance.HealthPlanContracts       WHERE InsuranceHealthPlanID=@healthPlanID AND InsuranceCarrierID=@insuranceCarrierID AND IsActive=1      ) AND IsActive=1      ) conProd ON conProd.ItemCode =  vm.ItemCode       LEFT JOIN CMS.ItemMasterContent mContent ON vm.ItemCode = mContent.ItemCode      WHERE vm.ModelCode =  @modelCode AND vm.IsActive=1   END   ELSE    BEGIN     SELECT DISTINCT      vm.ModelCode AS ProductModelCode,      vm.BrandCode AS BrandCode,      vm.FamilyCode AS BrandFamilyCode,      NULL AS EarmoldTypeCode,      vm.TechnologyCode AS FamilyProductCode,      NULL AS ProductTypeCode,      vm.StyleCode as ShellCode,      vm.TechnologyCode AS TechnologyLevelCode,      mContent.ModelOverview AS ModelOverview,      mContent.ModelLongDescription AS ModelLongDescription,      ISNULL(conProd.[PerDeviceMemberPrice],0) AS UnitProductPrice,      conProd.[FamilyProductCatCode] AS TechnologyLevel,      ISNULL([PerPairMemberPrice],0) AS PairProductPrice,      CAST(0 AS FLOAT) AS Benefit,      mContent.ModelShortDescription AS [Description],      mContent.DefaultImage AS MediaURL,      mContent.FamilyLogoImage AS FamilyLogoImage,      mContent.FamilyBannerImage AS FamilyBannerImage,      vm.StyleCode AS StyleName      ,CAST(0 AS FLOAT) AS CopayUnitPrice --Added by Harika      ,CAST(0 AS FLOAT) AS CopayPairPrice --Added by Harika      ,0 AS StyleID,      vm.StyleCode AS StyleCode,      vm.ItemCode AS ItemCode        FROM [catalog].[ItemMasterList] vm      INNER JOIN (      SELECT * FROM insurance.ContractProducts WHERE HealthPlanContractID = (       SELECT TOP 1 HealthPlanContractID FROM insurance.HealthPlanContracts       WHERE InsuranceHealthPlanID=@healthPlanID AND InsuranceCarrierID=@insuranceCarrierID AND IsActive=1      ) AND IsActive=1      ) conProd ON conProd.ItemCode =  vm.ItemCode       LEFT JOIN CMS.ItemMasterContent mContent ON vm.ItemCode = mContent.ItemCode      WHERE vm.ItemCode =  @itemCode and vm.IsActive=1   END  END  
CREATE FUNCTION [catalog].[Get_HearingService_HA_Items]   (      -- Add the parameters for the function here      @ProductItemCode nvarchar(100),          @DeviceCount int   )  RETURNS TABLE  AS    RETURN            SELECT ItemID,       ItemType,       BrandCode,            FamilyCode,            TechnologyCode,            ModelCode,         ItemCode,          StyleCode,       MonauralHCPCSCode,       case when @DeviceCount=1 then MonauralHCPCSCode else  BinauralHCPCSCode end as 'HCPCSAidCode',              BinauralHCPCSCode        FROM  [catalog].[ItemMasterList]        WHERE ITEMCODE = @ProductItemCode    
  CREATE FUNCTION [catalog].[splitstring] ( @stringToSplit VARCHAR(MAX) )  RETURNS   @returnList TABLE ([Name] [nvarchar] (500))  AS  BEGIN     DECLARE @name NVARCHAR(255)   DECLARE @pos INT     WHILE CHARINDEX(',', @stringToSplit) > 0   BEGIN    SELECT @pos  = CHARINDEX(',', @stringToSplit)      SELECT @name = SUBSTRING(@stringToSplit, 1, @pos-1)      INSERT INTO @returnList     SELECT @name      SELECT @stringToSplit = SUBSTRING(@stringToSplit, @pos+1, LEN(@stringToSplit)-@pos)   END     INSERT INTO @returnList   SELECT @stringToSplit     RETURN  END  
CREATE procedure [catalog].[UpdateItemMasterCOGS](   @cogs decimal,   @itemCode varchar(500),   @priceType varchar(100)  )  as  begin  declare @previous table(   priceId bigint not null default(0),   version int not null default(0),   cogs decimal not null default(0),   effFrom datetime2 null,   effTo datetime2 null  );  insert into @previous (priceId, version, cogs, effFrom, effTo)  select top (1) [ItemPriceID], [PriceVersion], [UnitCOGS], [EffectiveFrom], [EffectiveTo]  from [catalog].[ItemMasterPriceList]  where [ItemCode]=@itemCode and [PriceType]=@priceType and [IsActive]=1  order by [PriceVersion] desc;    if((select count(*) from @previous) = 0)   begin    insert into [catalog].[ItemMasterPriceList]    ([ItemCode]       ,[PriceType]       ,[PriceVersion]       ,[EffectiveFrom]       ,[EffectiveTo]       ,[UnitCOGS]       ,[PairCOGS]       ,[RebateUnitPrice]       ,[RebatePairPrice]       ,[IsActive]       ,[CreateUser]       ,[CreateDate]       ,[ModifyUser]       ,[ModifiedDate]) values       (@itemCode, @priceType, 1, cast(getdate() as date), datefromparts(2099, 12, 31), @cogs, @cogs*2, null, null, 1, 'SystemUser', getdate(), 'SystemUser', getdate());   end  else if((select effFrom from @previous) is not null and (select cast(effFrom as date) from @previous) <= cast(getdate() as date) and  ((select effTo from @previous) is null or (select cast(effTo as date) from @previous) > cast(getdate() as date)) and (select cogs from @previous) <> @cogs)   begin    if((select cast(effFrom as date) from @previous) < cast(getdate() as date))     begin      update [catalog].[ItemMasterPriceList] set [EffectiveTo]=cast(getdate() as date) where [ItemPriceID]=(select priceid from @previous);      insert into [catalog].[ItemMasterPriceList]      ([ItemCode]         ,[PriceType]         ,[PriceVersion]         ,[EffectiveFrom]         ,[EffectiveTo]         ,[UnitCOGS]         ,[PairCOGS]         ,[RebateUnitPrice]         ,[RebatePairPrice]         ,[IsActive]         ,[CreateUser]         ,[CreateDate]         ,[ModifyUser]         ,[ModifiedDate]) values         (@itemCode, @priceType, (select version from @previous)+1, cast(getdate() as date), datefromparts(2099, 12, 31), @cogs, @cogs*2, null, null, 1, 'SystemUser', getdate(), 'SystemUser', getdate());     end    else     begin      update [catalog].[ItemMasterPriceList] set [UnitCOGS]=@cogs,[PairCOGS]=@cogs*2,[EffectiveTo]=datefromparts(2099, 12, 31),[ModifyUser]='SystemUser',[ModifiedDate]=getdate() where [ItemPriceID]=(select priceid from @previous);     end   end  end
 CREATE PROCEDURE [catalog].[InsertorUpdateCatalogProducts]     -- Add the parameters for the stored procedure here      AS    BEGIN      --making all the products inactive  UPDATE [catalog].[ItemMasterList] set IsActive=0;    --deleting temp table if exists  IF OBJECT_ID (N'catalog.TempCatalogModels', N'U') IS NOT NULL       DROP TABLE [catalog].[TempCatalogModels];    --creating the temp table   CREATE TABLE [catalog].TempCatalogModels(   [Brand] [nvarchar](200) NULL,   [Family] [nvarchar](200) NULL,   [Technology] [nvarchar](200) NULL,   [Model] [nvarchar](200) NULL,   [ItemCode] [nvarchar](50) NOT NULL,   [Style] [varchar](200) NULL,   [Colors] [nvarchar](max) NULL,   [BatterySizes] [varchar](203) NULL,   [ReceiverSizes] [varchar](203) NULL,   [ReceiverPowers] [varchar](203) NULL,   [MonauralHCPCSCode] [varchar](5) NOT NULL,   [BinauralHCPCSCode] [varchar](5) NOT NULL   )    --inserting the data to the temp table from catalog schema tables([catalog].[ProductModelRules],[catalog].[OtherProductsRules],[catalog].[Features],[catalog].[FeatureValues],[catalog].[FeatureValueRules])  INSERT INTO [catalog].[TempCatalogModels]([Brand],[Family],[Technology],[Model],[ItemCode],[Style],[Colors],[BatterySizes],  [ReceiverSizes],[ReceiverPowers],[MonauralHCPCSCode],[BinauralHCPCSCode])  SELECT   BrandCode AS 'Brand',   BrandFamilyCode AS 'Family',   FamilyProductCode AS 'Technology',  ProductModelCode AS 'Model',  UPPER(FamilyProductCode + '_' + ProductModelCode) as 'ItemCode',  (case       WHEN StyleId = (SELECT styleid FROM catalog.styles WHERE stylecode='EDI_CUSTOMCATALOG') THEN 'CUSTOM'   WHEN ProductModelCode like '%DRW%' THEN 'RIE'   WHEN ProductModelCode like '%DWRZ%' THEN 'RIE' -- This value wrong in catalog it is supposed to be DRWZ   WHEN ProductModelCode like '%DR%' THEN 'RIE'   WHEN ProductModelCode like '%DVIR%' THEN 'RIE'   WHEN ProductModelCode like '%DW%' THEN 'BTE'    WHEN ProductModelCode like '%DVI%' THEN 'BTE'    WHEN ProductModelCode like '%DI%' THEN 'BTE'    ELSE '---'  END) AS 'Style',  (SELECT Stuff(      (      SELECT ', ' + A.[FeatureValueCode]      FROM [catalog].[FeatureValues] A   INNER JOIN [catalog].[FeatureValueRules] B ON B.[FeatureValueID] = A.[FeatureValueID] and B.[BrandFamilyCode] = [catalog].[ProductModelRules].BrandFamilyCode   INNER JOIN [catalog].[Features] C ON C.[FeatureID] = A.[FeatureID]   WHERE A.[FeatureName] in ('HOUSING COLOR','SHELL COLOR')       FOR XML PATH('')      ), 1, 2, '')) + ',NA' AS Colors,  '10,13,312,675,NA' AS 'BatterySizes',  '0,1,2,3,4,NA' AS 'ReceiverSizes',  'LOW POWER,MEDIUM POWER,NORMAL POWER,HIGH POWER,ULTRA POWER,NA' AS 'ReceiverPowers',  (CASE     WHEN [ShellCode]  in ('CIC','IIC')                THEN 'V5254'        WHEN [ShellCode]  in ('ITC','HS','MIH')           THEN 'V5255'     WHEN [ShellCode]  in ('ITE','LP')                 THEN 'V5256'     WHEN [ShellCode]  is null    AND          [ProductModelCode] like '%DW%'  or             [ProductModelCode] like '%DVI%' or                [ProductModelCode] like '%DI%'      THEN 'V5257' -- BTE     else             'V5257' -- RIE   END) AS  'MonauralHCPCSCode',   (CASE     WHEN [ShellCode]  in ('CIC','IIC')                THEN 'V5258'        WHEN [ShellCode]  in ('ITC','HS','MIH')           THEN 'V5259'     WHEN [ShellCode]  in ('ITE','LP')                 THEN 'V5260'     WHEN [ShellCode]  is null    and          [ProductModelCode] like '%DW%'  or             [ProductModelCode] like '%DVI%' or                [ProductModelCode] like '%DI%'      THEN 'V5261' -- BTE     ELSE                   'V5261' -- RIE   END ) AS  'BinauralHCPCSCode'  FROM  [catalog].[ProductModelRules]  WHERE   BrandCode IS NOT  NULL  AND NOT (ProductModelCode like '%DRWZ%' OR  ProductModelCode LIKE '%DWRZ%' )    UNION    SELECT   BrandCode as 'Brand',   BrandFamilyCode as 'Family',   FamilyProductCode + ' DRWZ' as 'Technology',  ProductModelCode as 'Model',  upper(FamilyProductCode + '_' + ProductModelCode) as 'ItemCode',  (case       WHEN StyleId = 
      -- EXEC [catalog].[sp_ssis_BT_GNR_ItemMaster_Rules_To_Stg]    CREATE PROCEDURE [catalog].[sp_ssis_BT_GNR_ItemMaster_Rules_To_Stg]  AS       BEGIN     BEGIN TRY   BEGIN TRANSACTION BT_GNR_ItemMaster_Rules_To_Stg    -- Delete all BT & GNR HA's in stg table     DELETE FROM catalog.ItemMasterList_Staging WHERE BrandCode in ('BELTONE','GNR')  -----------------------------------------------------------------------------------------------------------------------------------------------------------------------------    -- Insert all HA items to staging table    INSERT INTO catalog.ItemMasterList_Staging  select   distinct  replace(mr.FamilyProductCode,' ','')+'_'+replace(mr.ProductModelCode,' ','') ItemCode  ,'HA' Type  ,mr.BrandCode  ,mr.BrandFamilyCode  ,mr.FamilyProductCode  ,mr.ProductModelCode  --,case when mr.ProductTypeCode like '%RIE%' then 'RIE' ELSE substring( LEFT(s.StyleCode, charindex('CATALOG', s.StyleCode)-1), CHARINDEX('EDI_', s.StyleCode) + len('EDI_'), LEN(s.StyleCode))  END StyleCode    -- Updated to show actual shellcode instead of CUSTOM for custom HA's  ,case when (mr.ProductTypeCode IS NOT NULL AND mr.ProductTypeCode like '%RIE%') then 'RIE'         WHEN (mr.ProductTypeCode IS NOT NULL AND mr.ProductTypeCode NOT like '%RIE%') THEN 'BTE'     WHEN (mr.ProductTypeCode IS NULL)  THEN mr.ShellCode END StyleCode    --,mr.ProductTypeCode,mr.ShellCode  --,isnull(mr.ProductTypeCode,mr.ShellCode) StypleCode  --,s.StyleCode StypleCode_temp    ,1  from [catalog].[ProductModelRules] mr  left join [catalog].[Styles] s on (mr.StyleID=s.StyleID)  WHERE 1=1  and BrandCode in ('BELTONE','GNR')  ORDER BY StyleCode,ItemCode  -----------------------------------------------------------------------------------------------------------------------------------------------------------------------------    -- Delete all BT & GNR attribute values in stg table   DELETE FROM catalog.ItemMasterAttributeValues_Staging WHERE BrandCode in ('BELTONE','GNR')  -----------------------------------------------------------------------------------------------------------------------------------------------------------------------------      -- BATTERY (BATTERY_SIZES) - Attribute Values  -- Shell Code is for CUSTOM items   -- BATTERY for Custom HA's    INSERT INTO catalog.ItemMasterAttributeValues_Staging  select   DISTINCT  a.BrandCode  ,'BATTERY_SIZES' AttributeCode  ,a.ItemCode  ,b.FeatureValueCode  ,1 IsActive  ,a.ProductModelCode  ,'NA' Modifier  ,b.Description       from (      select    distinct   replace(mr.FamilyProductCode,' ','')+'_'+replace(mr.ProductModelCode,' ','') ItemCode   ,'HA' Type   ,mr.BrandCode   ,mr.BrandFamilyCode   ,mr.FamilyProductCode   ,mr.ProductModelCode   ,case when mr.ProductTypeCode like '%RIE%' then 'RIE' ELSE substring( LEFT(s.StyleCode, charindex('CATALOG', s.StyleCode)-1), CHARINDEX('EDI_', s.StyleCode) + len('EDI_'), LEN(s.StyleCode))  END StyleCode   ,mr.ProductTypeCode   ,mr.ShellCode   ,isnull(mr.ProductTypeCode,mr.ShellCode) StyleCode1   ,s.StyleCode StypleCode_temp   ,1 IsActive   from [catalog].[ProductModelRules] mr   left join [catalog].[Styles] s on (mr.StyleID=s.StyleID)   WHERE 1=1   and BrandCode in ('BELTONE','GNR')   and mr.ShellCode is not null      ) a  left join  (   SELECT fvr.ShellCode StyleCode   ,pmr.BrandCode   ,fvr.BrandFamilyCode,fv.*      FROM  catalog.FeatureValues  fv     left join catalog.FeatureValueRules fvr on (fvr.FeatureValueID=fv.FeatureValueID AND ShellCode IS NOT NULL ) --and BrandFamilyCode='TRUST' )     left join (select distinct BrandCode, BrandFamilyCode from catalog.ProductModelRules where BrandCode is not null) pmr on (pmr.BrandFamilyCode=fvr.BrandFamilyCode)   where 1=1     AND fv.FeatureName IN ('BATTERY')     and fvr.ShellCode is not null  ) b on (a.BrandCode=b.BrandCode and a.BrandFamilyCode=b.BrandFamilyCode and a.StyleCode1=b.StyleCode)  where 1=1  and b.FeatureValueCode is not NULL    UNION    -- Shell Code is for CUSTOM items - BATTERY for Custom    -- Battery '
  create PROCEDURE [catalog].[sp_ssis_STARKEY_ItemMaster_Temp_To_Stg]  AS  BEGIN  --------------------------------------Loading Starkey Products to #Temp Tables--------------------------------------------------------------  ------Delete Starkey data from Staging    DELETE FROM catalog.ItemMasterList_Staging WHERE Brandcode='STARKEY'  DELETE FROM catalog.ItemMasterAttributeValues_Staging WHERE Brandcode='STARKEY'      -------STEP 1-------Loading all HA and Custom Items into #TempProducts table    SELECT DISTINCT SM.Brandcode,SM.FAMILYCODE,SM.TECHCODE,SM.modelcode,SM.ModelName,AV.vendormodelcode VendorCode,SM.stylecode,SM.Itemtypecode,SM.IsActive,AV.Attributecode,   CASE WHEN SM.Itemtypecode='Hearing Aid' THEN 'HA'      WHEN SM.Itemtypecode='EARMOLD' THEN 'EM'      WHEN SM.Itemtypecode ='CROS' THEN 'CROS'      WHEN SM.ITEMTYPECODE='Batteries' THEN 'BATT'     WHEN SM.ITEMTYPECODE='Custom' THEN 'HA'     WHEN SM.ITEMTYPECODE='STANDARD PRODUCT' THEN 'HA'     ELSE 'OTHERS' END AS ItemType,   Av.MOdelAttributrevalue  INTO #TempProducts  FROM [catalog].[StarKeyModelsTemp] SM   INNER JOIN [catalog].[StarKeyAttributeValuesTemp] AV ON AV.modelcode=SM.modelcode --AND AV.vendormodelcode=SM.vendormodelcode  INNER JOIN[catalog].[StarKeyAttributesTemp] A ON A.Attributecode=AV.Attributecode  WHERE  1=1     AND SM.Itemtypecode IN ('EARMOLD','Hearing Aid','CUSTOM','STANDARD PRODUCT')  --AND Stylecode IN ('CIC','ITE','ITC','IIC','HS','BTE','RIC','mRIC','ITE')   AND Stylecode NOT IN ('NA')   AND SM.IsActive=1 AND AV.IsActive=1 AND A.IsActive=1    --------------------------------------------------Loading in to Staging from #TempTables---------------------------------------------------    ----STEP 2----Loading all BTE/RIC & CUSTOM Itemcodes in Itemmasterlist_Staging  INSERT INTO [catalog].[ItemMasterList_Staging]  SELECT DISTINCT TECHCODE + '_' +modelcode AS Itemcode,ItemType,BrandCode,FamilyCode,TECHCODE AS TechnologyCode,ModelCode,StyleCode,IsActive  FROM #TempProducts      -----STEP 3-----Loading  BTE/RIC Colors in ItemMasterAttributeValues_Staging  INSERT INTO [catalog].[ItemMasterAttributeValues_Staging]  SELECT BrandCode,AttributeCode,TECHCODE + '_' +modelcode AS Itemcode,ModelAttributrevalue AS ModelAttributeValue,IsActive,VendorCode AS VendorCode,'NA' AS Modifier,ModelAttributrevalue AS ModelAttributeValueDescription   FROM #TempProducts WHERE AttributeCode='COLOR'    -----------Loading CUSTOM Hearing Aid into AttributeValues with code 'CUSTOM_HA' to save CUSTOM HA 'VendorCode' for EDI    INSERT INTO [catalog].[ItemMasterAttributeValues_Staging]  SELECT  BrandCode, 'CUSTOM_HA' AS AttributeCode,TECHCODE + '_' +modelcode AS Itemcode, ModelAttributrevalue AS ModelAttributeValue,IsActive,VendorCode AS VendorCode,'NA' AS Modifier,ModelAttributrevalue AS ModelAttributeValueDescription   FROM #TempProducts WHERE AttributeCode='Custom Hearing Aid'     -----------Loading  Colors options for CUSTOM HA's    INSERT INTO [catalog].[ItemMasterAttributeValues_Staging]  SELECT  BrandCode, 'COLOR' AS AttributeCode,TECHCODE + '_' +modelcode AS Itemcode, LEFT(ModelAttributrevalue, CHARINDEX('(',ModelAttributrevalue)-1) AS ModelAttributeValue,IsActive,VendorCode AS VendorCode,'NA' AS Modifier,ModelAttributrevalue AS ModelAttributeValueDescription   FROM #TempProducts WHERE AttributeCode='Faceplate colors'       --SELECT  P.BrandCode, 'COLOR' AS AttributeCode,P.TECHCODE + '_' +P.modelcode AS Itemcode,LEFT(C.ModelAttributrevalue, CHARINDEX('(',C.ModelAttributrevalue)-1)  AS ModelAttributeValue,P.IsActive,P.VendorCode +'-' + C.VendorCode AS VendorCode,'NA' AS Modifier,C.ModelAttributrevalue AS ModelAttributeValueDescription   --FROM #TempProducts P  --INNER JOIN #TempProducts C ON C.modelcode=P.modelcode  --WHERE P.AttributeCode ='Custom Hearing Aid' AND C.AttributeCode='Faceplate colors'      ------STEP 4--------Loading BTE/RIC BatterySizes in ItemMasterAttributeValues_Staging(Battery sizes are dervied from Model itself)    INSERT INTO [catalog].[ItemMasterAttribu
    -- EXEC [catalog].[sp_ssis_BT_GNR_ItemMaster_Stg_To_Master]    create PROCEDURE [catalog].[sp_ssis_BT_GNR_ItemMaster_Stg_To_Master]  AS       BEGIN     BEGIN TRY   BEGIN TRANSACTION BT_GNR_ItemMaster_Stg_To_Master     -- CRUD operation for ItemMasterList   DECLARE @user NVARCHAR(50)   --SET @user=SYSTEM_USER   SET @user='SDaggubati'     -- CRUD query for ItemMasterList   MERGE [Catalog].[ItemMasterList] IL    USING (SELECT * FROM [Catalog].[ItemMasterList_Staging] WHERE BrandCode IN ('BELTONE','GNR')) ILS    ON (IL.ItemCode = ILS.ItemCode AND IL.Modelcode=ILS.ModelCode AND IL.BrandCode = ILS.BrandCode AND IL.FamilyCode = ILS.FamilyCode AND IL.BrandCode IN ('BELTONE','GNR') AND ILS.BrandCode IN ('BELTONE','GNR'))     WHEN MATCHED AND IL.BrandCode IN ('BELTONE','GNR')  THEN -- Update existing item for changes                     UPDATE SET  IL.ItemType= ILS.ItemType,       IL.TechnologyCode=ILS.TechnologyCode,       IL.StyleCode=ILS.StyleCode,       IL.IsActive=ILS.IsActive,       IL.ModifyDate=GETDATE(),       IL.ModifyUser=@user     WHEN NOT MATCHED BY TARGET AND ILS.BrandCode IN ('BELTONE','GNR') THEN -- Load new HA's      INSERT  (ItemCode,ItemType,BrandCode,FamilyCode,TechnologyCode,ModelCode,StyleCode,IsActive,CreateDate,CreateUser,ModifyDate,ModifyUser,MonauralHCPCSCode,BinauralHCPCSCode)   VALUES ( ILS.ItemCode,ILS.ItemType,ILS.BrandCode,ILS.FamilyCode,ILS.TechnologyCode,ILS.ModelCode,ILS.StyleCode,ILS.IsActive, GETDATE(),@user ,GETDATE(),@user        ,CASE WHEN ( (ILS.ModelCode LIKE '%CIC' OR ILS.ModelCode LIKE '%IIC') ) THEN 'V5254'       WHEN ( (ILS.ModelCode LIKE '%ITC' OR ILS.ModelCode LIKE '%HS' OR ILS.ModelCode LIKE '%MIH' OR ILS.ModelCode LIKE '%MIH-S') ) THEN 'V5255'       WHEN ( (ILS.ModelCode LIKE '%ITE' OR ILS.ModelCode LIKE '%LP') ) THEN 'V5256'         WHEN ( ILS.StyleCode IN ('BTE','RIE') ) THEN 'V5257'         END        ,CASE WHEN ( (ILS.ModelCode LIKE '%CIC' OR ILS.ModelCode LIKE '%IIC') ) THEN 'V5258'       WHEN ( (ILS.ModelCode LIKE '%ITC' OR ILS.ModelCode LIKE '%HS' OR ILS.ModelCode LIKE '%MIH' OR ILS.ModelCode LIKE '%MIH-S') ) THEN 'V5259'       WHEN ( (ILS.ModelCode LIKE '%ITE' OR ILS.ModelCode LIKE '%LP') ) THEN 'V5260'         WHEN ( ILS.StyleCode IN ('BTE','RIE') ) THEN 'V5261'       END       )     WHEN NOT MATCHED BY SOURCE AND IL.BrandCode IN ('BELTONE','GNR') AND IL.ItemType='HA' THEN -- Disable existing items since they are not available in latest catalog file     UPDATE SET IL.IsActive=0, IL.ModifyDate=GETDATE(), IL.ModifyUser=@user;       -- CRUD query for ItemMasterAttributeValue   MERGE [Catalog].[ItemMasterAttributeValues] IL    USING (SELECT * FROM [Catalog].[ItemMasterAttributeValues_Staging] WHERE BrandCode IN ('BELTONE','GNR')) ILS    ON (IL.ItemCode = ILS.ItemCode AND IL.Attributecode=ILS.Attributecode AND IL.ModelAttributeValue = ILS.ModelAttributeValue AND ILS.BrandCode IN ('BELTONE','GNR'))     WHEN MATCHED THEN -- Update existing attribute values for changes                     UPDATE SET  IL.VendorCode= ILS.VendorCode,       IL.ModelAttributeValueDescription=ILS.ModelAttributeValueDescription,       IL.IsActive=ILS.IsActive,       IL.ModifyDate=GETDATE(),       IL.ModifyUser=@user     WHEN NOT MATCHED BY TARGET AND ILS.BrandCode IN ('BELTONE','GNR') THEN -- Load new attribute values     INSERT  (AttributeCode,ItemCode,ModelAttributeValue,IsActive,VendorCode,Modifier,CreateDate,CreateUser,ModifyDate,ModifyUser,ModelAttributeValueDescription)   VALUES ( ILS.AttributeCode,ILS.ItemCode,ILS.ModelAttributeValue,ILS.IsActive,ILS.VendorCode,ILS.Modifier, GETDATE(),@user ,GETDATE(),@user,ILS.ModelAttributeValueDescription);     -- Disable attribute since they are not available in latest catalog file   UPDATE IAV    SET IAV.IsActive=0  , IAV.ModifyDate=GETDATE(), IAV.ModifyUser=@user   -- SELECT IAV.*,IL.*   FROM Catalog.ItemMasterAttributevalues IAV    JOIN catalog.ItemMasterList iml ON (iav.Itemcode=iml.ItemCode AND iml.BrandCode IN ('BELTONE','GNR'))   LEFT JOIN Catalog.ItemMast
  create PROCEDURE [catalog].[sp_ssis_STARKEY_ItemMaster_Stg_To_Master]  AS  BEGIN    BEGIN TRY  BEGIN TRANSACTION STARKEY_ItemMaster_Stg_To_Master    DECLARE @user NVARCHAR(50)  --SET @user=SYSTEM_USER  SET @user='systemuser'    -------------Itemmasterlist C R U D Operation  MERGE [Catalog].[ItemMasterList] IL  USING [Catalog].[ItemMasterList_Staging] ILS  ON (IL.ItemCode = ILS.ItemCode AND IL.Modelcode=ILS.ModelCode AND IL.FamilyCode=ILS.Familycode AND IL.BrandCode ='STARKEY' AND ILS.BrandCode ='STARKEY')    WHEN MATCHED AND ILS.BrandCode ='STARKEY' THEN                    UPDATE SET  IL.ItemType= ILS.ItemType,      IL.TechnologyCode=ILS.TechnologyCode,      IL.StyleCode=ILS.StyleCode,      IL.IsActive=ILS.IsActive,      IL.ModifyDate=GETDATE(),      IL.ModifyUser=@user    WHEN NOT MATCHED BY TARGET AND ILS.BrandCode ='STARKEY' THEN    INSERT  (ItemCode,ItemType,BrandCode,FamilyCode,TechnologyCode,ModelCode,StyleCode,IsActive,CreateDate,CreateUser,ModifyDate,ModifyUser)  VALUES ( ItemCode,ItemType,BrandCode,FamilyCode,TechnologyCode,ModelCode,StyleCode,IsActive, GETDATE(),@user ,GETDATE(),@user )    WHEN NOT MATCHED BY SOURCE AND IL.BrandCode ='STARKEY' AND IL.ItemType='HA' THEN    UPDATE SET IL.IsActive=0, IL.ModifyDate=GETDATE(),IL.ModifyUser=@user;    -----------ItemMasterAttributeValues C R U D Operation    MERGE [catalog].[ItemMasterAttributeValues] ILAV  USING [catalog].[ItemMasterAttributeValues_Staging] ILAVS  ON (ILAV.ItemCode = ILAVS.ItemCode AND ILAV.ModelAttributeValue=ILAVS.ModelAttributeValue  AND ILAVS.BrandCode ='STARKEY')                    WHEN MATCHED  THEN     UPDATE SET  ILAV.ModelAttributeValue= ILAVS.ModelAttributeValue,      ILAV.Vendorcode= ILAVS.Vendorcode,      ILAV.Modifier=ILAVS.Modifier,      ILAV.IsActive=ILAVS.IsActive,      ILAV.ModifyDate=GETDATE(),      ILAV.ModifyUser=@user    WHEN NOT MATCHED BY TARGET  AND ILAVS.Attributecode NOT IN('BATTERY_SIZES')  AND ILAVS.BrandCode ='STARKEY' THEN    INSERT  (AttributeCode,ItemCode,ModelAttributeValue,IsActive,VendorCode,Modifier,ModelAttributeValueDescription,CreateDate,CreateUser,ModifyDate,ModifyUser)  VALUES ( AttributeCode,ItemCode,ModelAttributeValue,IsActive,VendorCode,Modifier,ModelAttributeValueDescription,GETDATE(),@user ,GETDATE(),@user );    -----Insert Missing Battries separtely since we are inserting Null value in Vendor Codes into Catalog    INSERT INTO [catalog].[ItemMasterAttributeValues] (AttributeCode,ItemCode,ModelAttributeValue,IsActive,VendorCode,Modifier,ModelAttributeValueDescription,CreateDate,CreateUser,ModifyDate,ModifyUser)  SELECT AttributeCode,ItemCode,ModelAttributeValue,IsActive,VendorCode,Modifier,ModelAttributeValueDescription,GETDATE() AS CreateDate,@user AS CreateUser ,GETDATE() AS ModifyDate,@user  AS ModifyUser  FROM [catalog].[ItemmasterAttributevalues_Staging]  WHERE itemcode NOT IN (SELECT ItemCode From [catalog].[ItemmasterAttributevalues] WHERE Attributecode='BATTERY_SIZES')  AND  Attributecode='BATTERY_SIZES' AND Brandcode='STARKEY'    ------Update IsActive Required Attributes    UPDATE IAV  SET IAV.IsActive=0 ,IAV.ModifyDate=GETDATE(),IAV.ModifyUser=@user  FROM [Catalog].[ItemMasterAttributeValues] IAV  INNER JOIN [Catalog].[ItemMasterList] IL ON (IL.ItemCode=IAV.Itemcode AND IL.Brandcode='STARKEY')  LEFT JOIN [catalog].[ItemmasterAttributevalues_Staging] IAVS ON (IAVS.Itemcode=IAV.Itemcode AND IAVS.Attributecode=IAV.Attributecode AND IAVS.ModelAttributeValue=IAV.ModelAttributeValue AND IL.Brandcode='STARKEY')  WHERE IAVS.Itemcode IS NULL    ------Update IsActive for All Attributes    UPDATE IAV SET IAV.IsActive=0 ,IAV.ModifyDate=GETDATE(),IAV.ModifyUser=@user  FROM Catalog.ItemMasterAttributevalues IAV   INNER JOIN Catalog.ItemMasterList IL ON (IL.Itemcode=IAV.Itemcode AND IL.Brandcode='STARKEY' AND IL.IsActive=0)    ------UPDATE HCPS CODES    UPDATE catalog.itemmasterlist SET MonauralHCPCScode =CASE  WHEN Stylecode  IN ('CIC','IIC','mCIC') THEN 'V5254'                    WHEN Stylecode  IN ('ITC','HS','
CREATE FUNCTION [catalog].[GetHCPDeignitions]  (    @providerId bigint,    @locationId bigint  )  RETURNS @T table(designations varchar(500))  AS  BEGIN    declare @designations varchar(500)    SET @designations = ''  select @designations = @designations + Title + ', ' FROM provider.HCPProviderProfile             WHERE userprofileId in (select userprofileId from provider.ProviderUserLocations where ProviderId = @providerId and LocationId = @locationId)  INSERT INTO @T(designations)  select SUBSTRING(@designations, 0, LEN(@designations))       RETURN  END
/*  Mohan deployetd to Production on 12 May 2020  */    CREATE FUNCTION [catalog].[GetTeleAudColorsByItemCode]  (    @ItemCode NVARCHAR(200)  )  RETURNS @T table(Colors varchar(200))  AS  BEGIN    declare @Colors varchar(200)  --SET  @Colors = (SELECT COALESCE(@Colors + ',', '') + [ModelAttributeValue]  --      FROM  [catalog].[ItemMasterAttributeValues]   --      WHERE Itemcode = @ItemCode and [AttributeCode] = 'TeleAudiologyColors')   --INSERT INTO @T(Colors)   --SELECT COALESCE(@Colors + ',', '') + [ModelAttributeValue]   --     FROM  [catalog].[ItemMasterAttributeValues]    --     WHERE Itemcode = @ItemCode and [AttributeCode] = 'TeleAudiologyColors'    SET @Colors = ''  select @Colors = @Colors + [ModelAttributeValue] + ', ' FROM [catalog].[ItemMasterAttributeValues]              WHERE Itemcode = @ItemCode and [AttributeCode] = 'TeleAudiologyColors'  INSERT INTO @T(Colors)  select SUBSTRING(@Colors, 0, LEN(@Colors))       RETURN  END  
    -- EXEC [catalog].[sp_ssis_PHONAK_ItemMaster_Stg_To_Master]    CREATE PROCEDURE [catalog].[sp_ssis_PHONAK_ItemMaster_Stg_To_Master]  AS       BEGIN     BEGIN TRY   BEGIN TRANSACTION PHONAK_ItemMaster_Stg_To_Master     -- CRUD operation for ItemMasterList   DECLARE @user NVARCHAR(50)   --SET @user=SYSTEM_USER   SET @user='sdaggubati'     -- CRUD query for ItemMasterList   MERGE [Catalog].[ItemMasterList] IL    USING (SELECT * FROM [Catalog].[ItemMasterList_Staging] WHERE BrandCode IN ('PHONAK')) ILS    ON (IL.ItemCode = ILS.ItemCode AND IL.Modelcode=ILS.ModelCode AND IL.BrandCode = ILS.BrandCode AND IL.FamilyCode = ILS.FamilyCode AND IL.BrandCode IN ('PHONAK') AND ILS.BrandCode IN ('PHONAK'))     WHEN MATCHED AND IL.BrandCode IN ('PHONAK')  THEN -- Update existing item for changes                     UPDATE SET  IL.ItemType= ILS.ItemType,       IL.TechnologyCode=ILS.TechnologyCode,       IL.StyleCode=ILS.StyleCode,       IL.IsActive=ILS.IsActive,       IL.ModifyDate=GETDATE(),       IL.ModifyUser=@user     WHEN NOT MATCHED BY TARGET AND ILS.BrandCode IN ('PHONAK') THEN -- Load new HA's      INSERT  (ItemCode,ItemType,BrandCode,FamilyCode,TechnologyCode,ModelCode,StyleCode,IsActive,CreateDate,CreateUser,ModifyDate,ModifyUser,MonauralHCPCSCode,BinauralHCPCSCode)   VALUES ( ILS.ItemCode,ILS.ItemType,ILS.BrandCode,ILS.FamilyCode,ILS.TechnologyCode,ILS.ModelCode,ILS.StyleCode,ILS.IsActive, GETDATE(),@user ,GETDATE(),@user        ,CASE WHEN ( (ILS.StyleCode LIKE '%CIC' OR ILS.StyleCode LIKE '%IIC' ) ) THEN 'V5254'       WHEN ( (ILS.StyleCode LIKE '%ITC' OR ILS.StyleCode LIKE '%HS' OR ILS.StyleCode LIKE '%MIH' OR ILS.StyleCode LIKE '%MIH-S') ) THEN 'V5255'       WHEN ( (ILS.StyleCode LIKE '%ITE' OR ILS.StyleCode LIKE '%LP') ) THEN 'V5256'         WHEN ( ILS.StyleCode IN ('BTE','RIE','RIC') ) THEN 'V5257'         END        ,CASE WHEN ( (ILS.StyleCode LIKE '%CIC' OR ILS.StyleCode LIKE '%IIC') ) THEN 'V5258'       WHEN ( (ILS.StyleCode LIKE '%ITC' OR ILS.StyleCode LIKE '%HS' OR ILS.StyleCode LIKE '%MIH' OR ILS.StyleCode LIKE '%MIH-S') ) THEN 'V5259'       WHEN ( (ILS.StyleCode LIKE '%ITE' OR ILS.StyleCode LIKE '%LP') ) THEN 'V5260'         WHEN ( ILS.StyleCode IN ('BTE','RIE','RIC') ) THEN 'V5261'       END       )     WHEN NOT MATCHED BY SOURCE AND IL.BrandCode IN ('PHONAK')  THEN -- Disable existing items since they are not available in latest catalog file -- AND IL.ItemType='HA' (CROS models also should be disabled)     UPDATE SET IL.IsActive=0, IL.ModifyDate=GETDATE(), IL.ModifyUser=@user;       -- CRUD query for ItemMasterAttributeValue   MERGE [Catalog].[ItemMasterAttributeValues] IL    USING (SELECT * FROM [Catalog].[ItemMasterAttributeValues_Staging] WHERE BrandCode IN ('PHONAK')) ILS    ON (IL.ItemCode = ILS.ItemCode AND IL.Attributecode=ILS.Attributecode AND IL.ModelAttributeValue = ILS.ModelAttributeValue AND ILS.BrandCode IN ('PHONAK'))     WHEN MATCHED THEN -- Update existing attribute values for changes                     UPDATE SET  IL.VendorCode= ILS.VendorCode,       IL.ModelAttributeValueDescription=ILS.ModelAttributeValueDescription,       IL.IsActive=ILS.IsActive,       IL.ModifyDate=GETDATE(),       IL.ModifyUser=@user     WHEN NOT MATCHED BY TARGET AND ILS.BrandCode IN ('PHONAK') THEN -- Load new attribute values     INSERT  (AttributeCode,ItemCode,ModelAttributeValue,IsActive,VendorCode,Modifier,CreateDate,CreateUser,ModifyDate,ModifyUser,ModelAttributeValueDescription)   VALUES ( ILS.AttributeCode,ILS.ItemCode,ILS.ModelAttributeValue,ILS.IsActive,ILS.VendorCode,ILS.Modifier, GETDATE(),@user ,GETDATE(),@user,ILS.ModelAttributeValueDescription);     -- Disable attribute since they are not available in latest catalog file   UPDATE IAV    SET IAV.IsActive=0  , IAV.ModifyDate=GETDATE(), IAV.ModifyUser=@user   -- SELECT IAV.*,IL.*   FROM Catalog.ItemMasterAttributevalues IAV    JOIN catalog.ItemMasterList iml ON (iav.Itemcode=iml.ItemCode AND iml.BrandCode IN ('PHONAK'))   LEFT JOIN Catalog.ItemMasterAttributevalu
      -- EXEC [catalog].[sp_ssis_PHONAK_ItemMaster_Temp_To_Stg]    CREATE PROCEDURE [catalog].[sp_ssis_PHONAK_ItemMaster_Temp_To_Stg]  AS       BEGIN     BEGIN TRY   BEGIN TRANSACTION PHONAK_ItemMaster_Temp_To_Stg     -- Check column datatype and length   -- ALTER TABLE [catalog].[PhonakProductTemp] ALTER COLUMN [styles] nvarchar(255) NULL;       -- Insert new attributevalue code SHELL_TYPE in static table   --    select * from catalog.ItemAttributes order by 1   --INSERT INTO catalog.ItemAttributes   --select 11,'SHELL_TYPE','SHELL_TYPE',1,NULL       -------------------------------------------------- Manual updates because of missing info. in catalog file Start --------------------------------------------------------------------------------------------------------  -- Replace special characters  UPDATE catalog.PhonakIdentifierTemp SET en = REPLACE(en,'','e')  UPDATE catalog.PhonakIdentifierTemp SET en = REPLACE(en,'','i')     UPDATE catalog.PhonakFamilyTemp SET en = REPLACE(en,'','e')  UPDATE catalog.PhonakFamilyTemp SET en = REPLACE(en,'','i')    -- Incorrect Model description in catalog file  UPDATE [catalog].[PhonakIdentifierTemp] SET en= 'Phonak Audeo B50-13' WHERE en= 'Phonak Audeo B 50-13'    -- Incorrect Model description in catalog file  update i  set i.en='Phonak Naida Q70-RIC'  -- select i.en,'Phonak Nada Q70-RIC'  from [catalog].[PhonakIdentifierTemp] i  where 1=1  and en = 'Phonak Naida Q70 RIC'      /*  Style info. is missing for the following models   Phonak Bolero B50-PR   Phonak Bolero B70-PR   Phonak Bolero B90-PR  */   insert into [catalog].[PhonakStylesTemp]  select p.product_id,'BTE' styles  from [catalog].[PhonakCodeTemp] p  --left join [catalog].[PhonakIdentifierTemp] i on (i.product_Id=p.product_id)  left join [catalog].[PhonakStylesTemp] s on (s.product_id=p.product_id)  where 1=1  and s.styles is null  and (p.code like '050-0374%' or p.code like '050-0375%' or p.code like '050-0376%')        /*  Style info. is missing for the following models   Phonak Bolero M30-M   Phonak Bolero M50-M   Phonak Bolero M70-M   Phonak Bolero M90-M  */   insert into [catalog].[PhonakStylesTemp]  select p.product_id,'BTE' styles  from [catalog].[PhonakCodeTemp] p  --left join [catalog].[PhonakIdentifierTemp] i on (i.product_Id=p.product_id)  left join [catalog].[PhonakStylesTemp] s on (s.product_id=p.product_id)  where 1=1  and s.styles is null  and (p.code like '050-0532%' or p.code like '050-0533%' or p.code like '050-0534%' or p.code like '050-0535%')      /*  Style info. is missing for the following models   Phonak Bolero M30-PR   Phonak Bolero M50-PR   Phonak Bolero M70-PR   Phonak Bolero M90-PR  */   insert into [catalog].[PhonakStylesTemp]  select p.product_id,'BTE' styles  from [catalog].[PhonakCodeTemp] p  --left join [catalog].[PhonakIdentifierTemp] i on (i.product_Id=p.product_id)  left join [catalog].[PhonakStylesTemp] s on (s.product_id=p.product_id)  where 1=1  and s.styles is null  and (p.code like '050-0674%' or p.code like '050-0675%' or p.code like '050-0676%' or p.code like '050-0677%')      /*  Style info. is missing for the following models   Phonak CROS B-13 Custom   Phonak CROS B-R  */   insert into [catalog].[PhonakStylesTemp]  select p.product_id,'ITE' styles  from [catalog].[PhonakCodeTemp] p  --left join [catalog].[PhonakIdentifierTemp] i on (i.product_Id=p.product_id)  left join [catalog].[PhonakStylesTemp] s on (s.product_id=p.product_id)  where 1=1  and s.styles is null  and (p.code like '063-0247%' or p.code like '050-0601%')  -------------------------------------------------- Manual updates because of missing info. in catalog file Start --------------------------------------------------------------------------------------------------------            -----------------------------------------------------------------------------------------------------------------------------------------------------------------------------  -- Delete all PHONAK HA's  and attributes in stg table   DELETE 
    -- EXEC [catalog].[sp_ssis_UNITRON_ItemMaster_Stg_To_Master]    CREATE PROCEDURE [catalog].[sp_ssis_UNITRON_ItemMaster_Stg_To_Master]  AS       BEGIN     BEGIN TRY   BEGIN TRANSACTION UNITRON_ItemMaster_Stg_To_Master     -- CRUD operation for ItemMasterList   DECLARE @user NVARCHAR(50)   --SET @user=SYSTEM_USER   SET @user='SDaggubati'     -- CRUD query for ItemMasterList   MERGE [Catalog].[ItemMasterList] IL    USING (SELECT * FROM [Catalog].[ItemMasterList_Staging] WHERE BrandCode IN ('UNITRON')) ILS    ON (IL.ItemCode = ILS.ItemCode AND IL.Modelcode=ILS.ModelCode AND IL.BrandCode = ILS.BrandCode AND IL.FamilyCode = ILS.FamilyCode AND IL.BrandCode IN ('UNITRON') AND ILS.BrandCode IN ('UNITRON'))     WHEN MATCHED AND IL.BrandCode IN ('UNITRON')  THEN -- Update existing item for changes                     UPDATE SET  IL.ItemType= ILS.ItemType,       IL.TechnologyCode=ILS.TechnologyCode,       IL.StyleCode=ILS.StyleCode,       IL.IsActive=ILS.IsActive,       IL.ModifyDate=GETDATE(),       IL.ModifyUser=@user     WHEN NOT MATCHED BY TARGET AND ILS.BrandCode IN ('UNITRON') THEN -- Load new HA's      INSERT  (ItemCode,ItemType,BrandCode,FamilyCode,TechnologyCode,ModelCode,StyleCode,IsActive,CreateDate,CreateUser,ModifyDate,ModifyUser,MonauralHCPCSCode,BinauralHCPCSCode)   VALUES ( ILS.ItemCode,ILS.ItemType,ILS.BrandCode,ILS.FamilyCode,ILS.TechnologyCode,ILS.ModelCode,ILS.StyleCode,ILS.IsActive, GETDATE(),@user ,GETDATE(),@user        ,CASE WHEN ( (ILS.StyleCode LIKE '%CIC' OR ILS.StyleCode LIKE '%IIC' ) ) THEN 'V5254'       WHEN ( (ILS.StyleCode LIKE '%ITC' OR ILS.StyleCode LIKE '%HS' OR ILS.StyleCode LIKE '%MIH' OR ILS.StyleCode LIKE '%MIH-S') ) THEN 'V5255'       WHEN ( (ILS.StyleCode LIKE '%ITE' OR ILS.StyleCode LIKE '%LP') ) THEN 'V5256'         WHEN ( ILS.StyleCode IN ('BTE','RIE','RIC') ) THEN 'V5257'         END        ,CASE WHEN ( (ILS.StyleCode LIKE '%CIC' OR ILS.StyleCode LIKE '%IIC') ) THEN 'V5258'       WHEN ( (ILS.StyleCode LIKE '%ITC' OR ILS.StyleCode LIKE '%HS' OR ILS.StyleCode LIKE '%MIH' OR ILS.StyleCode LIKE '%MIH-S') ) THEN 'V5259'       WHEN ( (ILS.StyleCode LIKE '%ITE' OR ILS.StyleCode LIKE '%LP') ) THEN 'V5260'         WHEN ( ILS.StyleCode IN ('BTE','RIE','RIC') ) THEN 'V5261'       END       )     WHEN NOT MATCHED BY SOURCE AND IL.BrandCode IN ('UNITRON')  THEN -- Disable existing items since they are not available in latest catalog file -- AND IL.ItemType='HA' (CROS models also should be disabled)     UPDATE SET IL.IsActive=0, IL.ModifyDate=GETDATE(), IL.ModifyUser=@user;       -- CRUD query for ItemMasterAttributeValue   MERGE [Catalog].[ItemMasterAttributeValues] IL    USING (SELECT * FROM [Catalog].[ItemMasterAttributeValues_Staging] WHERE BrandCode IN ('UNITRON')) ILS    ON (IL.ItemCode = ILS.ItemCode AND IL.Attributecode=ILS.Attributecode AND IL.ModelAttributeValue = ILS.ModelAttributeValue AND ILS.BrandCode IN ('UNITRON'))     WHEN MATCHED THEN -- Update existing attribute values for changes                     UPDATE SET  IL.VendorCode= ILS.VendorCode,       IL.ModelAttributeValueDescription=ILS.ModelAttributeValueDescription,       IL.IsActive=ILS.IsActive,       IL.ModifyDate=GETDATE(),       IL.ModifyUser=@user     WHEN NOT MATCHED BY TARGET AND ILS.BrandCode IN ('UNITRON') THEN -- Load new attribute values     INSERT  (AttributeCode,ItemCode,ModelAttributeValue,IsActive,VendorCode,Modifier,CreateDate,CreateUser,ModifyDate,ModifyUser,ModelAttributeValueDescription)   VALUES ( ILS.AttributeCode,ILS.ItemCode,ILS.ModelAttributeValue,ILS.IsActive,ILS.VendorCode,ILS.Modifier, GETDATE(),@user ,GETDATE(),@user,ILS.ModelAttributeValueDescription);     -- Disable attribute since they are not available in latest catalog file   UPDATE IAV    SET IAV.IsActive=0  , IAV.ModifyDate=GETDATE(), IAV.ModifyUser=@user   -- SELECT IAV.*,IL.*   FROM Catalog.ItemMasterAttributevalues IAV    JOIN catalog.ItemMasterList iml ON (iav.Itemcode=iml.ItemCode AND iml.BrandCode IN ('UNITRON'))   LEFT JOIN Catalog.ItemMaster
-- =============================================  -- Author:  Mohan Nanduri  -- Create date: Feb 16th 2019  -- Description: Returns Media  for given ItemCode  -- =============================================  CREATE PROCEDURE [catalog].[GetModelMediaByItemCode]   -- Add the parameters for the stored procedure here  @ItemCode nvarchar(100) = null  AS  BEGIN   -- SET NOCOUNT ON added to prevent extra result sets from   -- interfering with SELECT statements.   SET NOCOUNT ON;        -- Insert statements for procedure here  SELECT a.[ItemmasterMediaID] as 'ModelMediaID',          null as 'Media',         a.[MediaURL],      a.[MediaType],      a.[ModelCode],      a.[ModelColor],      a.[DefaultMedia],      '' as 'MediaDescription',      '' as 'IsWirelessAccessory',      a.CreateDate, a.CreateUser, a.ModifyDate, a.ModifyUser, a.IsActive  FROM [cms].[ItemmasterMedias] a  INNER JOIN [cms].[ItemmasterContent] b on a.[ItemmasterContentID] = b.[ItemmasterContentID]  WHERE a.ItemCode=@ItemCode    END  
CREATE PROCEDURE [catalog].[GetItemMasterList]   AS              BEGIN              select ItemId,ItemCode,ItemType,BrandCode,FamilyCode,ModelCode,StyleCode   from [catalog].[ItemMasterList]   Where IsActive=1  END      
      -- EXEC [catalog].[sp_ssis_UNITRON_ItemMaster_Temp_To_Stg]    CREATE PROCEDURE [catalog].[sp_ssis_UNITRON_ItemMaster_Temp_To_Stg]  AS       BEGIN     BEGIN TRY   BEGIN TRANSACTION UNITRON_ItemMaster_Temp_To_Stg     -- Check column datatype and length   -- ALTER TABLE [catalog].[UnitronProductTemp] ALTER COLUMN [styles] nvarchar(255) NULL;          -------------------------------------------------- Manual updates because of missing info. in catalog file Start --------------------------------------------------------------------------------------------------------    -- Update model names with superscript  update id  set en = case when en='Quantum E S' THEN 'Quantum2 E S'        when en='Quantum 10 S' THEN 'Quantum2 10 S'     ELSE en end  --select case when en='Quantum E S' THEN 'Quantum2 E S'  --      when en='Quantum 10 S' THEN 'Quantum2 10 S'  --   ELSE en end en  --   ,en en1  from [catalog].[UnitronIdentifierTemp] id  where 1=1  and en in ('Quantum E S','Quantum 10 S')      -- Family info. is missing for the following models in catalog file  -- Covered in HA section  /*  select *   from [catalog].[UnitronIdentifierTemp] id  left join [catalog].[UnitronFamilyNameTemp] fn on (id.product_Id=fn.product_Id)  left join [catalog].[UnitronFamilyTemp] f on (f.family_Id=fn.family_Id)  where 1=1  and id.en in (  'Quantum E S'  ,'Quantum 10 S'  ,'Vista T 610 M 312'  ,'Vista T 810 M 312'  )  */    -- ModelType for 'Stride 500 10A IIC' is given as 'DOME_OPEN' instead of 'IIC'  update m  set m.code='IIC'  --select m.code,'IIC',*  from [catalog].[UnitronModelTypeTemp] m  left join [catalog].[UnitronIdentifierTemp] i on (m.product_Id=i.product_Id)  where 1=1  and i.en ='Stride 500 10A IIC'    -- Incorrect identifier description in catalog file, color is embedded by mistake in it  update id  set id.en = case when id.en ='FLEX:TRIAL Max SP Beige' then 'Max SP FLEX:TRIAL'                   when id.en ='Max 6 SPm Light Gray' then 'Max 6 SPm'       else id.en end  from [catalog].[UnitronIdentifierTemp] id  where 1=1  and en in ('FLEX:TRIAL Max SP Beige','Max 6 SPm Light Gray')        -------------------------------------------------- Manual updates because of missing info. in catalog file Start --------------------------------------------------------------------------------------------------------            -----------------------------------------------------------------------------------------------------------------------------------------------------------------------------  -- Delete all UNITRON HA's  and attributes in stg table   DELETE FROM catalog.ItemMasterList_Staging WHERE BrandCode = 'UNITRON'  DELETE FROM catalog.ItemMasterAttributeValues_Staging WHERE Brandcode='UNITRON'  -----------------------------------------------------------------------------------------------------------------------------------------------------------------------------              -------------------------------------------------- Hearing Aids Start --------------------------------------------------------------------------------------------------------  -- Insert all HA items to staging table  INSERT INTO [catalog].[ItemMasterList_Staging]  select   distinct  --pl.code  case when id.en like 'T Stride M%' and id.en not in ('T Stride M FLEX:TRIAL') then pln.en+'_'+mn.en+' '+pln.en       else pln.en+'_'+id.en end ItemCode      --,pln.en, mn.en, id.en  ,'HA' ItemType  ,'UNITRON' BrandCode  ,case when id.en in ('Quantum2 E S','Quantum2 10 S') then 'Quantum2'        when id.en in ('Vista T 610 M 312')  then 'Vista Tempus BTE'     when id.en in ('Vista T 810 M 312')  then 'Vista Tempus BTE'        else f.en end FamilyCode  ,pln.en TechnologyCode  ,case when id.en like 'T Stride M%' and id.en not in ('T Stride M FLEX:TRIAL') then mn.en+' '+pln.en   else id.en end ModelCode  --,mn.en  ,case when 'RIC,' IN (select value from STRING_SPLIT(s.styles,' ')) then 'RIC'     when 'BTE,' IN (select value from STRING_SPLIT(s.styles,' ')) then 'BTE'     when 'ITC,
create PROCEDURE [catalog].[GetModelContentByItemCode]   -- Add the parameters for the stored procedure here  @ItemCode nvarchar(100) = null  AS  BEGIN   -- SET NOCOUNT ON added to prevent extra result sets from   -- interfering with SELECT statements.   SET NOCOUNT ON;        -- Insert statements for procedure here  SELECT TOP 1 [ItemmasterContentID] as 'ModelContentID',         [BrandFamilyCode],[ModelCode],[ModelName],[DefaultImage],[FamilyBannerImage],[FamilyLogoImage],[FamilyProductCode],         [ModelLongDescription],[ModelMobileAppsDescription],[ModelOverview],[ModelRatings],[ModelShortDescription],[ModelTitle],      CreateDate, CreateUser, ModifyDate, ModifyUser, IsActive  FROM [cms].[ItemmasterContent]  WHERE [ItemCode] = @ItemCode    END  
-- 09/14/2020 - Damian Montero - Ran on Stage.  -- 09/18/2020 - Mohan Ran on Prod       /*   Add IsActive condition when joining Brands table   Should only get active brands  */    --EXEC [catalog].[V_GetBrands] 4,5,720, null  CREATE PROCEDURE [catalog].[V_GetBrands]   @InsuranceCarrierID int = 0 ,   @InsuranceHealthPlanID int = 0,   @ProviderId int = 0,   @ProductCategory varchar(50)   AS   BEGIN   SET NOCOUNT ON     DECLARE @BrandType nvarchar(200) = ''   DECLARE @HealthPlanContractID bigint = (SELECT HealthPlanContractID from Insurance.healthplancontracts where InsuranceCarrierId = @InsuranceCarrierId and InsuranceHealthPlanId = @InsuranceHealthPlanID)   SET @BrandType = (SELECT BRANDS FROM [provider].[ProviderProfiles] WHERE ProviderId = @ProviderId)     IF (@BrandType = 'BELTONE')    BEGIN      SELECT DISTINCT       br.[BrandId] AS 'BrandID',        br.[BrandName] AS 'BrandName',        br.[BrandCode] AS 'BrandCode',        br.[Description] AS 'Description',        br.[ImageURL] AS 'ImageURL'       FROM (       select distinct        BrandCode       from insurance.ContractProducts       where HealthPlanContractID = @HealthPlanContractID        and FamilyProductCatCode LIKE +'%' +isnull(@ProductCategory,'')+'%'        and BrandCode = 'BELTONE'      ) tbl      INNER JOIN [catalog].[Brands] br ON br.BrandCode = tbl.BrandCode and br.ISActive=1      END   ELSE IF (@BrandType = 'INDEPENDENT')    BEGIN      SELECT DISTINCT       br.[BrandId] AS 'BrandID',        br.[BrandName] AS 'BrandName',        br.[BrandCode] AS 'BrandCode',        br.[Description] AS 'Description',        br.[ImageURL] AS 'ImageURL'       FROM (       select distinct        BrandCode       from insurance.ContractProducts       where HealthPlanContractID = @HealthPlanContractID        and FamilyProductCatCode LIKE +'%' +isnull(@ProductCategory,'')+'%'        and BrandCode <> 'BELTONE'      ) tbl      INNER JOIN [catalog].[Brands] br ON br.BrandCode = tbl.BrandCode and br.ISActive=1    END   ELSE    BEGIN      SELECT DISTINCT       br.[BrandId] AS 'BrandID',        br.[BrandName] AS 'BrandName',        br.[BrandCode] AS 'BrandCode',        br.[Description] AS 'Description',        br.[ImageURL] AS 'ImageURL'       FROM (       select distinct        BrandCode       from insurance.ContractProducts       where HealthPlanContractID = @HealthPlanContractID        and FamilyProductCatCode LIKE +'%' +isnull(@ProductCategory,'')+'%'      ) tbl      INNER JOIN [catalog].[Brands] br ON br.BrandCode = tbl.BrandCode and br.ISActive=1    END  END  ----------------------------------------------      
--******************************************************************  -- Crated by: Chandra Annapragada  -- Created Date: 24th June 2019  -- Description: This stored procedure is used to decide whether to bring the OrderItem information from the old catalog (especially for beltone and resound) Or from the new catalog.  -- Note: there were changes to the tables and their structures used in storing the item information for each brand.  -- Mohan: Modied to read APP status from transaction instead of Order.OrderStatusCode  --******************************************************************      CREATE PROCEDURE [catalog].[GetOrderItemDetails](   @ToIncludeOldCataLogItems varchar(10),   @OrderID bigint   )   AS   BEGIN     if(ltrim(rtrim(@ToIncludeOldCataLogItems)) ='YES')      BEGIN        select distinct A.OrderID,A.ShippingData, A.MemberData, A.ProviderData,A.SpecialInstructions, C.Stylecode, C.TechnologyLevelCode,     (select top 1 VendorCode from [catalog].[ItemMasterAttributeValues] where IsActive = 1 and ItemCode = C.ItemCode  and AttributeCode = 'COLOR'  and ltrim(rtrim(ModelAttributeValue)) = JSON_VALUE(C.ItemData,'$.color') and IsActive = 1) as ProductModelCode,      (select top 1 VendorCode from [catalog].[ItemMasterAttributeValues] where ItemCode = C.ItemCode  and (attributeCode = 'RECIEVER_POWER')  and ltrim(rtrim(REPLACE(ModelAttributeValue,',',''))) = JSON_VALUE(C.ItemData,'$.receiverPower')  and Modifier = C.Modifier and IsActive = 1) as RiceiverCode,     (select top 1 VendorCode from [catalog].[ItemMasterAttributeValues] where ItemCode = C.ItemCode  and (attributeCode = 'RECIEVER_SIZES')  and ltrim(rtrim(REPLACE(ModelAttributeValue,',',''))) = JSON_VALUE(C.ItemData,'$.receiverSize')  and Modifier = C.Modifier and IsActive = 1) as RiceiverSize,      C.ItemCode, C.Modifier, C.Quantity, C.FamilyCode, C.BrandCode,     (SELECT top 1[ProductTypeCode]  FROM[catalog].[ProductModelRules] where ProductModelCode in (C.ProductModelCode) and IsActive = 1) ProductType,     (select top 1 technologyLevelcode from catalog.TechnologyLevelRules where isActive = 1 and ProducttypeCode = (SELECT top 1[ProductTypeCode]  FROM[catalog].[ProductModelRules] where isActive = 1 and ProductModelCode in (C.ProductModelCode)))  Connectivity,A.OrderStatusCode,C.[OrderItemId],C.[Amount],C.[ItemData],C.[itemType],C.[UnitPrice],C.[ProductModelCode] as ModelCode      from Orders.Orders A      left join [Orders].[OrderPOs] B on A.OrderID = B.OrderID      left join[Orders].[OrderItems] C on A.OrderID = C.OrderID      left join [Orders].[OrderTransactionDetails] T on T.OrderID = A.OrderID and T.OrderStatusCode = 'APP'     where --A.OrderStatusCode = 'APP' and      C.IsActive = 1 and A.OrderID = ltrim(rtrim(@OrderID));     END   if(ltrim(rtrim(@ToIncludeOldCataLogItems)) ='NO')      BEGIN    select distinct A.OrderID,A.ShippingData, A.MemberData, A.ProviderData,A.SpecialInstructions, C.Stylecode, C.TechnologyLevelCode,(select top 1 VendorCode from [catalog].[ItemMasterAttributeValues] where IsActive = 1 and ItemCode = C.ItemCode  and AttributeCode = 'COLOR'  and ltrim(rtrim(ModelAttributeValue)) = JSON_VALUE(C.ItemData,'$.color') and IsActive = 1) as ProductModelCode,(select top 1 VendorCode from [catalog].[ItemMasterAttributeValues] where ItemCode = C.ItemCode  and (attributeCode = 'RECIEVER_POWER')  and ltrim(rtrim(REPLACE(ModelAttributeValue,',',''))) = JSON_VALUE(C.ItemData,'$.receiverPower')  and Modifier = C.Modifier and IsActive = 1) as RiceiverCode,(select top 1 VendorCode from [catalog].[ItemMasterAttributeValues] where ItemCode = C.ItemCode  and (attributeCode = 'RECIEVER_SIZES')  and ltrim(rtrim(REPLACE(ModelAttributeValue,',',''))) = JSON_VALUE(C.ItemData,'$.receiverSize')  and Modifier = C.Modifier and IsActive = 1) as RiceiverSize,C.ItemCode, C.Modifier, C.Quantity, C.FamilyCode, C.BrandCode,(select TOP 1 ModelAttributeValue from Catalog.ItemMasterAttributevalues where ItemCode = C.ItemCode and AttributeCode = 'CONNECTIVITY' and IsActive = 
CREATE PROCEDURE [catalog].[proc_GetFeatures]      @brandCodes nvarchar(max) = null,      @brandFamilyCodes nvarchar(max) = null,      @familyProductCodes nvarchar(max) = null,      @productTypeCodes nvarchar(max) = null,      @technologyLevelCodes nvarchar(max) = null,      @shellCodes nvarchar(max) = null,      @productModelCodes nvarchar(max) = null,      @earmoldTypeCodes nvarchar(max) = null,      @powerLevels nvarchar(max) = null,      @pushButtons nvarchar(max) = null,      @teleCoils nvarchar(max) = null,      @sendReceivers nvarchar(max) = null,      @materials nvarchar(max) = null,      @couplings nvarchar(max)= null,   @catalogType nvarchar(10) = null   as        select fv.* from [Catalog].FeatureValues fv      inner join [Catalog].Features f    on f.FeatureName = fv.FeatureName where    ((@catalogType = 'Custom' And f.StyleID = 1) OR (@catalogType = 'Standard' And f.StyleID > 1) OR (@catalogType is null And 1=1) ) and    (fv.FeatureValueID in     (select FeatureValueID from [Catalog].[FeatureValueRules] where    (BrandCode in (select * from [Catalog].splitstring(@brandCodes)) or BrandCode is null) and    (BrandFamilyCode in (select * from [Catalog].splitstring(@brandFamilyCodes)) or BrandFamilyCode is null) and    (FamilyProductCode in (select * from [Catalog].splitstring(@familyProductCodes)) or FamilyProductCode is null) and    (ProductTypeCode in (select * from [Catalog].splitstring(@productTypeCodes)) or ProductTypeCode is null) and    (TechnologyLevelCode in (select * from [Catalog].splitstring(@technologyLevelCodes)) or TechnologyLevelCode is null) and    (ShellCode in (select * from [Catalog].splitstring(@shellCodes)) or ShellCode is null) and    (ProductModelCode in (select * from [Catalog].splitstring(@productModelCodes)) or ProductModelCode is null) and    (EarmoldTypeCode   in (select * from [Catalog].splitstring(@earmoldTypeCodes)) or EarmoldTypeCode is null) and    (PowerLevel in (select * from [Catalog].splitstring(@powerLevels)) or PowerLevel is null) and    (PushButton in (select * from [Catalog].splitstring(@pushButtons)) or PushButton is null) and    (TeleCoil in (select * from [Catalog].splitstring(@teleCoils)) or TeleCoil is null) and    (SendReceiver in (select * from [Catalog].splitstring(@sendReceivers)) or SendReceiver is null) and    (Material in (select * from [Catalog].splitstring(@materials)) or Material is null) and    (Coupling in (select * from [Catalog].splitstring(@couplings)) or Coupling is null)) or fv.IsDefault = 'Y')  
--exec [catalog].[getModelDetailsByModelCodeAndAccessoryName] 'EN588-DW','ENZO2','RS ENZO2 5','QuickGuide','RSENZO25_EN588-DW'  CREATE PROCEDURE [catalog].[getModelDetailsByModelCodeAndAccessoryName]   @productModelCode varchar(30),   @brandFamilyCode varchar(30),   @familyProductCode varchar(30),   @accessoryName varchar(20),   @itemCode nvarchar(100)  AS  BEGIN     if(@accessoryName = 'Videos' or @accessoryName = 'Overview' or @accessoryName = 'QuickGuide' or @accessoryName = 'ProductBrochures')   begin   select accessory.[ItemMasterAccessoryID], media.Media,              media.MediaURL, accessory.Description as [MediaDescription],             media.DefaultMedia, accessory.IsWirelessAccessory,             media.MediaType             from [cms].[ItemMasterAccessories] accessory left join [cms].[ItemmasterMedias] media             on accessory.[ItemmasterMediaID] = media.[ItemmasterMediaID] and media.itemCode = @itemCode             where accessory.ModelAccessoryName = @accessoryName and ((accessory.FamilyProductCode = @familyProductCode or accessory.FamilyProductCode is null)  and accessory.BrandFamilyCode = @brandFamilyCode)             and media.MediaURL is not null              order by media.DefaultMedia desc   end   else if(@accessoryName = 'Wireless Accessories')   begin   select accessory.[ItemMasterAccessoryID], media.Media,              media.MediaURL, accessory.Description as [MediaDescription],             media.DefaultMedia, accessory.IsWirelessAccessory,             media.MediaType             from cms.[ItemMasterAccessories] accessory left join [cms].[ItemmasterMedias] media             on accessory.[ItemmasterMediaID] = media.[ItemmasterMediaID] and media.itemCode = @itemCode             where accessory.IsWirelessAccessory = 1 and REPLACE(accessory.ModelCode, ' ','') = @productModelCode             and media.MediaURL is not null             order by media.DefaultMedia desc   end  END  
CREATE PROCEDURE [catalog].[getModelDetailsByModelCodeMediaName]  @modelCode varchar(30),  @mediaName varchar(20)  AS  BEGIN     SET NOCOUNT ON;     if(@mediaName = 'Videos' or @mediaName = 'Downloads')    begin     select REPLACE(ModelCode, ' ',''),null as [Description],Media,MediaURL,null as ModelOverview from CMS.ItemMasterMedias where REPLACE( ModelCode, ' ','') = @modelCode  and MediaType = @mediaName    end   else if(@mediaName = 'Reviews')    begin     select REPLACE(ModelCode, ' ',''),ModelReviewDescription as [Description],null as Media, null as MediaURL,null as ModelOverview from CMS.ModelReviews where REPLACE(ModelCode, ' ','') = @modelCode     end   else if(@mediaName = 'Mobile Apps')    begin     select REPLACE(ModelCode, ' ',''),ModelMobileAppsDescription as [Description],null as Media, null as MediaURL,null as ModelOverview from CMS.ItemMasterContent where REPLACE(ModelCode, ' ','') = @modelCode     end   else if(@mediaName = 'Overview')    begin     select REPLACE(ModelCode, ' ',''),null as [Description],null as Media, null as MediaURL,ModelOverview from CMS.ItemMasterContent where REPLACE(ModelCode, ' ','') = @modelCode     end   else     begin     select REPLACE(ModelCode, ' ',''),[Description],null as Media, null as MediaURL,null as ModelOverview from CMS.ModelAccessories where REPLACE(ModelCode, ' ','') = @modelCode and ModelAccessoryName = @mediaName    end  END  
CREATE PROCEDURE [catalog].[proc_ProductModelFeaturesbyModelCode]      @productModelCodes nvarchar(max) = null,   @styleID int = 0   --@catalogType nvarchar(max)=null,   as   select fv.* from [Catalog].FeatureValues fv      inner join [Catalog].Features f    --on f.FeatureName = fv.FeatureName where   on f.FeatureID = fv.FeatureID where   --f.StyleID = @styleID and    --((@catalogType = 'Custom' And f.StyleID = 1) OR (@catalogType = 'Standard' And f.StyleID > 1) OR (@catalogType is null And 1=1)) and    (fv.FeatureValueID in     (select FeatureValueID from [Catalog].[FeatureValueRules] where     (REPLACE(ProductModelCode, ' ','') in (select * from [Catalog].splitstring(@productModelCodes)))) or fv.IsDefault = 'Y')     and (fv.FeatureName='color')    --and fv.FeatureName!='side' and fv.FeatureName!='processing'        --[catalog].[getModelDetailsByModelCode]  
CREATE PROCEDURE [catalog].[proc_LoadCMSData]   @brandFamilyCode varchar(30),     @familyProductCode varchar(30),   @itemCode nvarchar(100),   @shortDescription nvarchar(max),  -- done   @longDescription nvarchar(max),  -- done   @images nvarchar(max),   -- done   @defaultImage nvarchar(max),  --done   @videos nvarchar(max),   -- done   @familyLogoImage nvarchar(max),     @familyBannerImage nvarchar(max),    @overview nvarchar(max),  -- done   @quickGuidePdfs nvarchar(max), -- done   -- @techSpecificationPdfs nvarchar(max), -- done   @productBrochurePdfs nvarchar(max), -- done   @reviews nvarchar(max)      AS  BEGIN  insert into [cms].[ItemmasterContent](ModelLongDescription, ModelShortDescription,IsActive,BrandFamilyCode,FamilyProductCode, FamilyLogoImage, FamilyBannerImage,      DefaultImage,ModelRatings,ItemCode,createUser,ModifyUser)       values (@longDescription,@shortDescription,1,@brandFamilyCode,@familyProductCode,@familyLogoImage,@familyBannerImage,@defaultImage,0,@itemCode,'rsareddy','rsareddy')   if(@images is not null)    begin                 insert into [cms].[ItemmasterMedias]([ItemmasterContentID],DefaultMedia, IsActive,MediaType,MediaURL,ItemCode,createUser,ModifyUser)       values ((select TOP 1 ItemmasterContentID from [cms].[ItemmasterContent] where ItemCode = @itemCode ORDER BY ItemmasterContentID),0,1,'Image',@images,@itemCode,'rsareddy','rsareddy')       insert into [cms].[ItemMasterAccessories](IsActive,IsWirelessAccessory,[ItemmasterMediaID],ModelAccessoryName,BrandFamilyCode, FamilyProductCode,createUser,ModifyUser)      values (1,0,(select top 1 ItemmasterMediaID  from [cms].[ItemmasterMedias] where ItemCode = @itemCode order by ItemmasterMediaID desc), 'Images',@brandFamilyCode,@familyProductCode,'rsareddy','rsareddy')    end       if(@videos is not null)    begin               insert into [cms].[ItemmasterMedias]([ItemmasterContentID],DefaultMedia, IsActive,MediaType,MediaURL,ItemCode,createUser,ModifyUser)       values ((select TOP 1 ItemmasterContentID from [cms].[ItemmasterContent] where ItemCode = @itemCode ORDER BY ItemmasterContentID),0,1,'Video',@videos,@itemCode,'rsareddy','rsareddy')       insert into [cms].[ItemMasterAccessories](IsActive,IsWirelessAccessory,[ItemmasterMediaID],ModelAccessoryName,BrandFamilyCode, FamilyProductCode,createUser,ModifyUser)       values (1,0,(select top 1 ItemmasterMediaID  from [cms].[ItemmasterMedias] where ItemCode = @itemCode order by ItemmasterMediaID desc), 'Videos',@brandFamilyCode,@familyProductCode,'rsareddy','rsareddy')    end     if(@overview is not null)    begin          insert into [cms].[ItemmasterMedias]([ItemmasterContentID],DefaultMedia, IsActive,MediaType,MediaURL,ItemCode,createUser,ModifyUser)      values ((select TOP 1 ItemmasterContentID from [cms].[ItemmasterContent] where ItemCode = @itemCode ORDER BY ItemmasterContentID),0,1,'Pdf',@overview,@itemCode,'rsareddy','rsareddy')       insert into [cms].[ItemMasterAccessories](IsActive,IsWirelessAccessory,[ItemmasterMediaID],ModelAccessoryName,BrandFamilyCode, FamilyProductCode,createUser,ModifyUser)       values (1,0,(select top 1 ItemmasterMediaID  from [cms].[ItemmasterMedias] where ItemCode = @itemCode order by ItemmasterMediaID desc), 'Overview',@brandFamilyCode,@familyProductCode,'rsareddy','rsareddy')    end     if(@quickGuidePdfs is not null)    begin          insert into [cms].[ItemmasterMedias]([ItemmasterContentID],DefaultMedia, IsActive,MediaType,MediaURL,ItemCode,createUser,ModifyUser)      values ((select TOP 1 ItemmasterContentID from [cms].[ItemmasterContent] where ItemCode = @itemCode ORDER BY ItemmasterContentID),0,1,'Pdf',@quickGuidePdfs,@itemCode,'rsareddy','rsareddy')       insert into [cms].[ItemMasterAccessories](IsActive,IsWirelessAccessory,[ItemmasterMediaID],ModelAccessoryName,BrandFamilyCode, FamilyProductCode,createUser,ModifyUser)       values (1,0,(select top 1 ItemmasterMediaID  from [cms].[ItemmasterMedias] where ItemCode = @itemCode order by ItemmasterMedia
    CREATE PROCEDURE [catalog].[proc_ProductModels]     @BrandCode varchar(50),    @EarmoldCode varchar(max),    @BrandFamilyCode varchar(max),    @FamilyProductCode varchar(max),    @ProductTypeCode varchar(max),    @TechnologyLevelCode varchar(max),    @ShellCode varchar(max),    @ReturnTable varchar(50),    @InsuranceCarrierID int = 0 ,    @HealthPlanID int = 0,    @CatalogType varchar(50) = null,    @Styles varchar(max)=null     as     begin               declare @query varchar(max)           declare @Schema varchar(50)           set @Schema='[Catalog]'                  declare @ProductTypeResult varchar(max)                declare @EarmoldTypeResult varchar(max)                declare @TechnologyLevelResult varchar(max)                declare @FamilyProductResult varchar(max)                declare @ShellResult varchar(max)                        declare @result varchar(max)             -- Brands (Start)         --  begin         --select 'brand' as Brand,'CatalogType' as CatalogType,'Connectivity' as Connectivity,'EarmoldTypes' as EarmoldTypes,'Families' as Families,'ProductLines' as ProductLines,'ProductTypes' as ProductTypes,'Shells' as Shells            --select * from Brands         -- end         -- Brands (End)             -- EarmoldTypes (Start)         if(@ReturnTable ='EarmoldType')         BEGIN                     set @query = ''            set @query  = 'select EarmoldTypeCode from '+@Schema+'.EarMoldTypeRules where '          if (@BrandCode is not null)             set @query  = @query + ' BrandCode = '''+@BrandCode +''''        else             set @query  = @query + '1 = 1'                  if (@EarmoldCode is not null and @BrandFamilyCode is not null)                begin                       SELECT @result = COALESCE(@result + ',', '') +  CAST('''' + EarmoldTypeCode + ''''  AS VARCHAR(200)) + ''  FROM [Catalog].BrandFamilyRules  WHERE EarmoldTypeCode in (select * from  [Catalog].splitstring(@EarmoldCode)) group by EarmoldTypeCode                end                  if (@result is not null)                begin                   if(@EarmoldCode is not null)                set @query = 'Select * from '+@Schema+'.EarMoldTypes where EarmoldTypeCode in (' + @query + ') and (EarmoldTypeCode in (' + @result + ') or EarmoldTypeCode in (select * from [Catalog].splitstring('''+@EarmoldCode+''')))'                        else                       set @query = 'Select * from '+@Schema+'.EarMoldTypes where EarmoldTypeCode in (' + @query + ') and EarmoldTypeCode in (' + @result + ')'                  end                  else                  begin                  if(@EarmoldCode is not null)                  set @query = 'Select * from '+@Schema+'.EarMoldTypes where (EarmoldTypeCode in (' + @query + ') or EarmoldTypeCode in (select * from [Catalog].splitstring('''+@EarmoldCode+''')))'                       else                       set @query = 'Select * from '+@Schema+'.EarMoldTypes where EarmoldTypeCode in (' + @query + ')'                       end                --set @query = 'Select * from '+@Schema+'.EarMoldTypes where EarmoldTypeCode in (' + @query + ')'                                                       if (@InsuranceCarrierID > 0 and @HealthPlanID > 0)                      begin                                                                                  set @query =  @query + ' and EarmoldTypeCode in ( select distinct EarmoldTypeCode from [Catalog].ProductModels prod                                                                                                                                                   inner join [Catalog].ProductModelRules prodr                                                                                                                                                   on prod.ProductModelCode = prodr.ProductModelCode                                                                                                                                                   left 
 CREATE PROCEDURE [catalog].[proc_ProductModels_b]     @BrandCode varchar(50),    @EarmoldCode varchar(50),    @BrandFamilyCode varchar(50),    @FamilyProductCode varchar(50),    @ProductTypeCode varchar(50),    @TechnologyLevelCode varchar(50),    @ShellCode varchar(50),    @ReturnTable varchar(50)        as     begin               declare @query varchar(max)     declare @Schema varchar(50)     set @Schema='[Catalog]'        declare @ProductTypeResult varchar(max)    declare @EarmoldTypeResult varchar(max)    declare @TechnologyLevelResult varchar(max)    declare @FamilyProductResult varchar(max)    declare @ShellResult varchar(max)      declare @result varchar(max)       -- Brands (Start)   --  begin   --select 'brand' as Brand,'CatalogType' as CatalogType,'Connectivity' as Connectivity,'EarmoldTypes' as EarmoldTypes,'Families' as Families,'ProductLines' as ProductLines,'ProductTypes' as ProductTypes,'Shells' as Shells      --select * from Brands   -- end    -- Brands (End)        -- EarmoldTypes (Start)    if(@ReturnTable ='EarmoldType')   BEGIN         set @query = ''      set @query  = 'select EarmoldTypeCode from '+@Schema+'.EarMoldTypeRules where '          if (@BrandCode is not null)       set @query  = @query + ' BrandCode = '''+@BrandCode +''''        else       set @query  = @query + '1 = 1'      if (@EarmoldCode is not null)    begin     SELECT @result = COALESCE(@result + ',', '') +  CAST('''' + EarmoldTypeCode + ''''  AS VARCHAR(200)) + ''  FROM [Catalog].BrandFamilyRules  WHERE EarmoldTypeCode in (select * from  [Catalog].splitstring(@EarmoldCode)) group by EarmoldTypeCode    end       if (@result is not null)     set @query = 'Select * from '+@Schema+'.EarMoldTypes where EarmoldTypeCode in (' + @query + ') and EarmoldTypeCode in (' + @result + ')'       else        set @query = 'Select * from '+@Schema+'.EarMoldTypes where EarmoldTypeCode in (' + @query + ')'      --set @query = 'Select * from '+@Schema+'.EarMoldTypes where EarmoldTypeCode in (' + @query + ')'       --print @query    exec (@query)   END    -- EarmoldTypes (End)      else if(@ReturnTable ='BrandFamily')    -- BrandFamilies (Start)     BEGIN       set @query = ''      set @query  = 'select BrandFamilyCode from '+@Schema+'.BrandFamilyRules where '          if (@BrandCode is not null)       set @query  = @query + ' BrandCode = '''+@BrandCode+''''        else       set @query  = @query + '1 = 1'      set @query = @query + ' And '       if (@EarmoldCode is not null)       set @query  = @query + ' EarmoldTypeCode in (select * from [Catalog].splitstring('''+@EarmoldCode+'''))'         else       set @query  = @query + '1 = 1'      if (@ProductTypeCode is not null)    begin     SELECT @ProductTypeResult = COALESCE(@ProductTypeResult + ',', '') +  CAST('''' + BrandFamilyCode + ''''  AS VARCHAR(200)) + ''  FROM [Catalog].ProductTypeRules  WHERE ProductTypeCode in (select * from  [Catalog].splitstring(@ProductTypeCode)) group by BrandFamilyCode     set @result = @ProductTypeResult;    end         if (@TechnologyLevelCode is not null)    begin         SELECT @TechnologyLevelResult = COALESCE(@TechnologyLevelResult + ',', '') +  CAST('''' + BrandFamilyCode + ''''  AS VARCHAR(200)) + ''  from [Catalog].TechnologyLevelRules where TechnologyLevelCode in (select * from  [Catalog].splitstring(@TechnologyLevelCode)) group by BrandFamilyCode     if(@result is not null)      set @result = @result + @TechnologyLevelResult;     else      set @result = @TechnologyLevelResult;    end      if (@FamilyProductCode is not null)    begin         SELECT @FamilyProductResult = COALESCE(@FamilyProductResult + ',', '') +  CAST('''' + BrandFamilyCode + ''''  AS VARCHAR(200)) + ''  from [Catalog].FamilyProductRules where FamilyProductCode in (select * from  [Catalog].splitstring(@FamilyProductCode)) group by BrandFamilyCode     if(@result is not null)      set @result = @result + @FamilyProductResult;     else      set @result = @FamilyProductResult;    end      if (@ShellCode is 
create PROCEDURE [catalog].[sp_GetAllBrands](@BrandName Nvarchar(100))  AS  BEGIN      -- SET NOCOUNT ON added to prevent extra result sets from      -- interfering with SELECT statements.      SET NOCOUNT ON      -- Insert statements for procedure here      If( @BrandName is null or @BrandName='')    Begin     SELECT distinct BrandName from [catalog].[Brands]    End   Else    Begin     SELECT distinct BrandName from [catalog].[Brands]  where BrandName like @BrandName + '%'    End  END  
  ----------------------------------------------------------------    CREATE PROCEDURE [catalog].[proc_ProductModelsByFeatures]    @BrandCode varchar(max),    @EarmoldCode varchar(max),    @BrandFamilyCode varchar(max),    @FamilyProductCode varchar(max),    @ProductTypeCode varchar(max),    @TechnologyLevelCode varchar(max),    @ShellCode varchar(max),    @InsuranceCarrierID int = 0 ,    @HealthPlanID int = 0,    @featureName varchar(max),    @featureValueCode varchar(max),    @catalogType varchar(50) = null         as    BEGIN             declare @query varchar(max)           declare @Schema varchar(50)                       declare @result varchar(max)           set @Schema='[Catalog]'                set @query = ''            --set @query  = 'select ProductModelCode from '+@Schema+'.ProductModelRules where '            if (@InsuranceCarrierID = 0 and @HealthPlanID = 0)            set @query  = ' where '        if (@BrandCode is not null)             set @query  =  @query + ' (BrandCode = '''+@BrandCode+'''or BrandCode is null)'           else             set @query  = @query + '1 = 1'                  set @query = @query + ' And '                  if (@EarmoldCode is not null)             set @query  = @query + ' (prodr.EarmoldTypeCode in (select * from [Catalog].splitstring('''+@EarmoldCode+''')) or prodr.EarmoldTypeCode is null)'            else             set @query  = @query + '1 = 1'                                set @query = @query + ' And '                 if (@BrandFamilyCode is not null)             set @query  = @query + ' (prodr.BrandFamilyCode in (select * from [Catalog].splitstring('''+@BrandFamilyCode+''')) or prodr.BrandFamilyCode is null)'         else             set @query  = @query + '1 = 1'                  set @query = @query + ' And '                  if (@ProductTypeCode is not null)             set @query  = @query + ' (prodr.ProductTypeCode in (select * from [Catalog].splitstring('''+@ProductTypeCode+''')) or prodr.ProductTypeCode is null)'         else             set @query  = @query + '1 = 1'                  set @query = @query + ' And '                  if (@TechnologyLevelCode is not null)             set @query  = @query + ' (prodr.TechnologyLevelCode  in (select * from [Catalog].splitstring('''+@TechnologyLevelCode+''')) or prodr.TechnologyLevelCode is null)'        else             set @query  = @query + '1 = 1'                  set @query = @query + ' And '                  if (@FamilyProductCode is not null)             set @query  = @query + ' (prodr.FamilyProductCode  in (select * from [Catalog].splitstring('''+@FamilyProductCode+''')) or prodr.FamilyProductCode is null)'        else             set @query  = @query + '1 = 1'                  set @query = @query + ' And '                  if (@ShellCode is not null)             set @query  = @query + ' (prodr.ShellCode  in (select * from [Catalog].splitstring('''+@ShellCode+''')) or prodr.ShellCode is null)'        else             set @query  = @query + '1 = 1'                  if (@featureName is not null and @featureValueCode is not null)                begin                       select @result = COALESCE(@result + ',', '') +  CAST('''' + ProductModelCode + ''''  AS VARCHAR(200)) + '' from [Catalog].FeatureValueRules                           where FeatureValueID in                           (select fv.FeatureValueID from [Catalog].FeatureValues fv                           left join [Catalog].Features f on fv.FeatureID=f.FeatureID                          where fv.FeatureName in (select * from  [Catalog].splitstring(@featureName))                          and FeatureValueCode in (select * from  [Catalog].splitstring(@featureValueCode))                          and ((@catalogType = 'Custom' And f.StyleID = 1) OR (@catalogType = 'Standard' And f.StyleID > 1) OR (@catalogType is null And 1=1)))                           and ProductModelCode is not null group by ProductModelCode                 end                if(@result is not n
CREATE PROCEDURE [catalog].[Get_HearingService_HA_Item]    (          -- Add the parameters for the stored procedure here         @ProductItemCode nvarchar(100),            @DeviceCount int       )      AS      BEGIN                 SET NOCOUNT ON       IF (@DeviceCount = 1)        BEGIN              SELECT ItemID,       ItemType,       BrandCode,            FamilyCode,            TechnologyCode,            ModelCode,        ITEMCODE,           StyleCode,         MonauralHCPCSCode,           MonauralHCPCSCode as 'HCPCSAidCode',           BinauralHCPCSCode       FROM  [catalog].[ItemMasterList]         WHERE ITEMCODE = @ProductItemCode                  END       IF (@DeviceCount = 2)        BEGIN          SELECT ItemID,       ItemType,       BrandCode,            FamilyCode,            TechnologyCode,            ModelCode,         ItemCode,          StyleCode,       MonauralHCPCSCode,       BinauralHCPCSCode as 'HCPCSAidCode',              BinauralHCPCSCode        FROM  [catalog].[ItemMasterList]        WHERE ITEMCODE = @ProductItemCode                    END      END  
  CREATE PROCEDURE [catalog].[getModelInputOptions]   (     @modelName NVARCHAR(550) = ''     ,@itemCode NVARCHAR(100) = ''     ,@modifier NVARCHAR(2) = 'LT'   )   AS   BEGIN    SET NOCOUNT ON    DECLARE @ColorList AS varchar(MAX)    DECLARE @ReceiverSizesList AS varchar(MAX)     DECLARE @ReceiverPowersList AS varchar(MAX)     DECLARE @BatterySizesList AS varchar(MAX)    DECLARE @AttrCodeDesc AS nvarchar(MAX)    DECLARE @AttrTable AS TABLE(Name varchar(20), ModelAttributeValue varchar(1000), ItemCode varchar(1000), IsActive bit)        BEGIN       INSERT INTO @AttrTable     SELECT      *     FROM (      select 'COLOR' as [Name],  REPLACE(ModelAttributeValue, ',', '') as  ModelAttributeValue, ItemCode, IsActive from [catalog].[ItemMasterAttributeValues] where AttributeCode = 'COLOR' and modifier in ('NA', @modifier)      union      select 'RECV_SIZE' as [Name],  REPLACE(ModelAttributeValue, ',', '') as ModelAttributeValue, ItemCode, IsActive from [catalog].[ItemMasterAttributeValues] where AttributeCode = 'RECIEVER_SIZES' and modifier in ('NA', @modifier)      union      select 'RECV_POW' as [Name],  REPLACE(ModelAttributeValue, ',', '') as ModelAttributeValue, ItemCode, IsActive from [catalog].[ItemMasterAttributeValues] where AttributeCode = 'RECIEVER_POWER' and modifier in ('NA', @modifier)      union      select 'BATT_SIZE' as [Name],  REPLACE(ModelAttributeValue, ',', '') as ModelAttributeValue, ItemCode, IsActive from [catalog].[ItemMasterAttributeValues] where AttributeCode = 'BATTERY_SIZES' and modifier in ('NA', @modifier)     ) tbl     WHERE 1=1      AND ItemCode = @itemCode      AND IsActive = 1       SET @ColorList = (select STRING_AGG (TRIM( REPLACE(ModelAttributeValue, ',', '') ), ',') from @AttrTable a where a.Name = 'COLOR')     SET @ReceiverSizesList = (select STRING_AGG (TRIM( REPLACE(ModelAttributeValue, ',', '') ), ',') from @AttrTable a where a.Name = 'RECV_SIZE')     SET @ReceiverPowersList = (select STRING_AGG (TRIM( REPLACE(ModelAttributeValue, ',', '') ), ',') from @AttrTable a where a.Name = 'RECV_POW')     SET @BatterySizesList = (select STRING_AGG (TRIM( REPLACE(ModelAttributeValue, ',', '') ), ',') from @AttrTable a where a.Name = 'BATT_SIZE')     IF NOT EXISTS (SELECT * FROM @AttrTable WHERE Name = 'COLOR') SET @ColorList = (SELECT 'NA')     IF NOT EXISTS (SELECT * FROM @AttrTable WHERE Name = 'RECV_SIZE')  SET @ReceiverSizesList = (SELECT 'NA')     IF NOT EXISTS (SELECT * FROM @AttrTable WHERE Name = 'RECV_POW')  SET @ReceiverPowersList = (SELECT 'NA')     IF NOT EXISTS (SELECT * FROM @AttrTable WHERE Name = 'BATT_SIZE')  SET @BatterySizesList = (SELECT 'NA')     IF       1=1       AND (SELECT StyleCode from catalog.ItemMasterList where ItemCode = @itemCode) not in ('BTE', 'RIC', 'RIE')       BEGIN        IF @ColorList <> 'NA' SET @ColorList = CONCAT(@ColorList, ',NA')        IF @ReceiverSizesList <> 'NA' SET @ReceiverSizesList = CONCAT(@ReceiverSizesList, ',NA')        IF @ReceiverPowersList <> 'NA' SET @ReceiverPowersList = CONCAT(@ReceiverPowersList, ',NA')        IF @BatterySizesList <> 'NA' SET @BatterySizesList = CONCAT(@BatterySizesList, ',NA')       END       SET @AttrCodeDesc = (      select        AttributeCode, '{' + STRING_AGG( '"' +TRIM(REPLACE(ModelAttributeValue, ',', '')) + '":"' + STRING_ESCAPE(ModelAttributeValueDescription,'json') + '"' ,',') + '}' as attributes      from [catalog].[ItemMasterAttributeValues]       where ItemCode = @itemCode      group by AttributeCode      for json auto     )          SELECT DISTINCT      [BrandCode], [FamilyCode], [TechnologyCode]      , [ModelCode], iml.[ItemCode], [StyleCode]      , @ColorList AS [Colors], @ReceiverSizesList AS [ReceiverSizes], @ReceiverPowersList AS [ReceiverPowers], @BatterySizesList AS [BatterySizes]      , @AttrCodeDesc AS [AttributeCodeDescriptions]       , iml.[CreateDate], iml.[CreateUser]       , iml.[ModifyDate], iml.[ModifyUser], iml.[IsActive]       , [ItemID], [ItemType]       , '' as BinauralHCPCSCode,'' as Mona
--exec [catalog].[GetStylesByBrand] 'BELTONE'  CREATE PROCEDURE [catalog].[GetStylesByBrand]    -- Add the parameters for the stored procedure here   @BrandCode varchar(20) = '',   @BrandFamilyCodes varchar(MAX) = null,   @TechnologyCodes varchar(MAX)=null   AS   BEGIN    SET NOCOUNT ON;    IF (@BrandCode = '')     BEGIN           SELECT         row_number() OVER (ORDER BY vm.[StyleCode]) AS 'RowId',        vm.[StyleCode] AS 'StyleName',        vm.[StyleCode] AS'StyleCode'      FROM [catalog].[ItemMasterList] vm             WHERE vm.[StyleCode] IS NOT NULL AND vm.[IsActive]=1        GROUP BY vm.[StyleCode];      END    ELSE    BEGIN    DECLARE @query VARCHAR(MAX);      SET @query='SELECT          ROW_NUMBER() OVER (ORDER BY vm.[StyleCode]) AS ''RowId'',         vm.[StyleCode] AS ''StyleName'',         vm.[StyleCode] AS''StyleCode''       FROM [catalog].[ItemMasterList] vm       WHERE vm.[BrandCode] = '''+@BrandCode+''' AND vm.[StyleCode] IS NOT NULL and vm.[StyleCode] <> '''' AND vm.[IsActive]=1'       IF(@BrandFamilyCodes IS NOT NULL)      SET @query=@query + ' AND vm.FamilyCode IN (SELECT * FROM [Catalog].splitstring('''+@BrandFamilyCodes+'''))'       IF(@TechnologyCodes IS NOT NULL)      SET @query=@query + ' AND vm.TechnologyCode IN (SELECT * FROM [Catalog].splitstring('''+@TechnologyCodes+'''))'     SET @query = @query+' GROUP BY vm.[StyleCode]'    exec(@query);    END   END    
-- 11/09/2020 - Damian Montero - Ran on stage.  -- 11/21/2020 - Mohan Deployed to PROD  /*  Author: Harika Date: 11-05-2020  Comments: Added Copay unit and pair prices.  */  CREATE PROCEDURE [catalog].[V_ProductModelsList]    @BrandCode VARCHAR(50),   @BrandFamilyCode VARCHAR(MAX)=NULL,   @TechnologyLevelCode VARCHAR(MAX)=NULL,   @Styles VARCHAR(MAX)=NULL,   @InsuranceCarrierID INT = 0 ,   @InsuranceHealthPlanID INT = 0,   @ReturnTable VARCHAR(50),   @ProductCategory VARCHAR(50)    AS    BEGIN    SET @ProductCategory = REPLACE(@ProductCategory,'null','');    DECLARE @healthPlanContractId BIGINT = (           SELECT            TOP 1 HealthPlanContractID           FROM insurance.healthplancontracts           WHERE InsuranceCarrierId=@InsuranceCarrierID            AND insuranceHealthPlanId=@InsuranceHealthPlanID            AND isactive=1           );    IF(@ReturnTable ='BrandFamily')     BEGIN      SELECT        ROW_NUMBER() OVER (ORDER BY p.BrandFamilyCode) AS RowID       ,p.*      FROM       (        SELECT DISTINCT c.*        FROM (         SELECT          (CASE WHEN fm.[BrandFamilyName] IS NULL THEN vm.[FamilyCode] ELSE fm.[BrandFamilyName] END) AS BrandFamilyName          ,vm.[FamilyCode] AS BrandFamilyCode          ,(CASE WHEN fm.[Description] IS NULL THEN vm.[FamilyCode] ELSE fm.[Description] END) AS Description         FROM [catalog].[ItemMasterList] vm         LEFT JOIN [catalog].[BrandFamilies] fm         ON vm.[FamilyCode] = fm.[BrandFamilyCode] and fm.IsActive=1         INNER JOIN Insurance.ContractProducts cp         on cp.HealthPlanContractId=@healthPlanContractId          and cp.ItemCode=vm.ItemCode          and cp.IsActive=1          AND ( @ProductCategory IS NULL OR @ProductCategory = '' OR cp.FamilyProductCatCode LIKE CONCAT('%',@ProductCategory,'%'))         WHERE vm.BrandCode=@BrandCode          AND vm.IsActive=1          AND vm.[ItemType]='HA'          AND (@BrandFamilyCode IS NULL OR vm.[FamilyCode] IN (SELECT * FROM [Catalog].splitstring(@BrandFamilyCode)))          AND (@TechnologyLevelCode IS NULL OR vm.[TechnologyCode] IN (SELECT * FROM [Catalog].splitstring(@TechnologyLevelCode)))          AND (@Styles IS NULL OR vm.[StyleCode] IN (SELECT * FROM [Catalog].splitstring(@Styles)))        ) c        WHERE c.BrandFamilyName IS NOT NULL       ) p     END        IF(@ReturnTable ='FamilyProduct') --Technology     BEGIN      SELECT        ROW_NUMBER() OVER (ORDER BY p.FamilyProductCode) AS RowID       ,p.*      FROM      (       SELECT DISTINCT c.*       FROM (        SELECT DISTINCT         (CASE WHEN fp.[FamilyProductName] IS NULL THEN vm.[TechnologyCode] ELSE fp.[FamilyProductName] END) AS FamilyProductName         ,vm.[TechnologyCode] AS FamilyProductCode         ,(CASE WHEN fp.[Description] IS NULL THEN vm.[TechnologyCode] ELSE fp.[Description] END) AS Description        FROM [catalog].[ItemMasterList] vm        LEFT JOIN [catalog].[FamilyProducts] fp        ON vm.[TechnologyCode] = fp.[FamilyProductCode] and fp.IsActive=1        INNER JOIN insurance.contractproducts cp        ON cp.HealthPlanContractID=@healthPlanContractId and cp.ItemCode=vm.ItemCode and cp.IsActive=1        AND (         @ProductCategory IS NULL OR @ProductCategory = '' OR          FamilyProductCatCode LIKE CONCAT('%',@ProductCategory,'%')         )        WHERE vm.BrandCode=@BrandCode         AND vm.IsActive=1         AND vm.[ItemType]='HA'         AND (@BrandFamilyCode IS NULL OR vm.[FamilyCode] IN (SELECT * FROM [Catalog].splitstring(@BrandFamilyCode)))         AND (@TechnologyLevelCode IS NULL OR vm.[TechnologyCode] IN (SELECT * FROM [Catalog].splitstring(@TechnologyLevelCode)))         AND (@Styles IS NULL OR vm.[StyleCode] IN (SELECT * FROM [Catalog].splitstring(@Styles)))       ) c      ) p     END      IF(@ReturnTable ='ProductModel') --Model     BEGIN      SELECT       ROW_NUMBER() OVER (ORDER BY p.ProductModelCode) AS RowID       ,p.*      FROM      (       SELECT DISTINCT c.*       FROM       (        SELECT          vm.Model
  CREATE PROCEDURE [catalog].[GetVendorCode] @OrderItemId bigint  AS  BEGIN      SET NOCOUNT ON           SELECT TOP 1 case when BrandCode in ('STARKEY','PHONAK', 'UNITRON') and ItemType = 'HA' then dbo.getproductmodelcode(OrderId,ItemCode,JSON_VALUE(ItemData,'$.color')) else ItemCode end as [VendorCode]    FROM [Orders].[OrderItems] OI where OI.OrderItemId = @OrderItemId;  END  
--******************************************************************  -- Crated by: Chandra Annapragada  -- Created Date: 24th June 2019  -- Description: This stored procedure is used to decide whether to bring the OrderItem information from the old catalog (especially for beltone and resound) Or from the new catalog.  -- Note: there were changes to the tables and their structures used in storing the item information for each brand.  -- Mohan: Creating backu to read APP status from transaction instead of Order.OrderStatusCode  --******************************************************************      CREATE PROCEDURE [catalog].[GetOrderItemDetails_BK_14MAY2020](   @ToIncludeOldCataLogItems varchar(10),   @OrderID bigint   )   AS   BEGIN     if(ltrim(rtrim(@ToIncludeOldCataLogItems)) ='YES')      BEGIN        select distinct A.OrderID,A.ShippingData, A.MemberData, A.ProviderData,A.SpecialInstructions, C.Stylecode, C.TechnologyLevelCode,(select top 1 VendorCode from [catalog].[ItemMasterAttributeValues] where IsActive = 1 and ItemCode = C.ItemCode  and AttributeCode = 'COLOR'  and ltrim(rtrim(ModelAttributeValue)) = JSON_VALUE(C.ItemData,'$.color') and IsActive = 1) as ProductModelCode, (select top 1 VendorCode from [catalog].[ItemMasterAttributeValues] where ItemCode = C.ItemCode  and (attributeCode = 'RECIEVER_POWER')  and ltrim(rtrim(REPLACE(ModelAttributeValue,',',''))) = JSON_VALUE(C.ItemData,'$.receiverPower')  and Modifier = C.Modifier and IsActive = 1) as RiceiverCode,(select top 1 VendorCode from [catalog].[ItemMasterAttributeValues] where ItemCode = C.ItemCode  and (attributeCode = 'RECIEVER_SIZES')  and ltrim(rtrim(REPLACE(ModelAttributeValue,',',''))) = JSON_VALUE(C.ItemData,'$.receiverSize')  and Modifier = C.Modifier and IsActive = 1) as RiceiverSize, C.ItemCode, C.Modifier, C.Quantity, C.FamilyCode, C.BrandCode,(SELECT top 1[ProductTypeCode]  FROM[catalog].[ProductModelRules] where ProductModelCode in (C.ProductModelCode) and IsActive = 1) ProductType,(select top 1 technologyLevelcode from catalog.TechnologyLevelRules where isActive = 1 and ProducttypeCode = (SELECT top 1[ProductTypeCode]  FROM[catalog].[ProductModelRules] where isActive = 1 and ProductModelCode in (C.ProductModelCode)))  Connectivity,A.OrderStatusCode,C.[OrderItemId],C.[Amount],C.[ItemData],C.[itemType],C.[UnitPrice],C.[ProductModelCode] as ModelCode from Orders.Orders A left join [Orders].[OrderPOs] B on A.OrderID = B.OrderID left join[Orders].[OrderItems] C on A.OrderID = C.OrderID where  A.OrderStatusCode = 'APP' and C.IsActive = 1 and A.OrderID = ltrim(rtrim(@OrderID));     END   if(ltrim(rtrim(@ToIncludeOldCataLogItems)) ='NO')      BEGIN    select distinct A.OrderID,A.ShippingData, A.MemberData, A.ProviderData,A.SpecialInstructions, C.Stylecode, C.TechnologyLevelCode,(select top 1 VendorCode from [catalog].[ItemMasterAttributeValues] where IsActive = 1 and ItemCode = C.ItemCode  and AttributeCode = 'COLOR'  and ltrim(rtrim(ModelAttributeValue)) = JSON_VALUE(C.ItemData,'$.color') and IsActive = 1) as ProductModelCode,(select top 1 VendorCode from [catalog].[ItemMasterAttributeValues] where ItemCode = C.ItemCode  and (attributeCode = 'RECIEVER_POWER')  and ltrim(rtrim(REPLACE(ModelAttributeValue,',',''))) = JSON_VALUE(C.ItemData,'$.receiverPower')  and Modifier = C.Modifier and IsActive = 1) as RiceiverCode,(select top 1 VendorCode from [catalog].[ItemMasterAttributeValues] where ItemCode = C.ItemCode  and (attributeCode = 'RECIEVER_SIZES')  and ltrim(rtrim(REPLACE(ModelAttributeValue,',',''))) = JSON_VALUE(C.ItemData,'$.receiverSize')  and Modifier = C.Modifier and IsActive = 1) as RiceiverSize,C.ItemCode, C.Modifier, C.Quantity, C.FamilyCode, C.BrandCode,(select TOP 1 ModelAttributeValue from Catalog.ItemMasterAttributevalues where ItemCode = C.ItemCode and AttributeCode = 'CONNECTIVITY' and IsActive = 1) Connectivity,(select TOP 1 ModelAttributeValue from Catalog.ItemMasterAttributevalues where ItemCode = C.ItemCode and AttributeCode = 'PRO
    -- EXEC [centralhealth].[CH_elig_file_load_ssis_sp_merge_stg_to_ch]    CREATE PROCEDURE [centralhealth].[CH_elig_file_load_ssis_sp_merge_stg_to_ch]  AS      BEGIN     --BEGIN TRY   --BEGIN TRANSACTION CH_ELIG_MERGE_stg_to_ch            DECLARE @sys_usr CHAR(30)           ,@sys_date DATETIME;        SET @sys_usr = SYSTEM_USER    SET @sys_date = CAST(GETDATE() AT TIME ZONE 'UTC' AT TIME ZONE 'Eastern Standard Time' AS DATETIME);  -- Time in EST      drop table if exists centralhealth.DataViewCHMembers    drop table if exists centralhealth.DataVCHMemNotRcvd     drop table if exists centralhealth.DataVCHIns    drop table if exists centralhealth.DataVCHInsNotRcvd                select * into centralhealth.DataViewCHMembers from centralhealth.ViewCHMembers --New or cHanged Members    create index dataview_idx1 on centralhealth.DataViewCHMembers (NHLinkID)       select * into centralhealth.DataVCHMemNotRcvd from centralhealth.ViewCHMemNotRcvd n  --Memebers who are completely dropped off the new file    where not exists (select 1 from centralhealth.DataViewCHMembers d where d.NHLinkID = n.NHLinkID)     create index dataview_idx2 on centralhealth.DataVCHMemNotRcvd (NHLinkID)      select * into centralhealth.DataVCHIns from centralhealth.ViewCHInsurance    create index dataview_idx2 on centralhealth.DataVCHIns (NHLinkID)         select * into centralhealth.DataVCHInsNotRcvd from centralhealth.ViewCHInsNotRcvd n     where not exists (select 1 from centralhealth.DataVCHIns d where d.NHLinkID = n.NHLinkID and d.EligibilityEffectiveDate = n.EligibilityEffectiveDate)    create index dataview_idx2 on centralhealth.DataVCHInsNotRcvd (NHLinkID)       update centralhealth.CHInsurance    set tobeprocessed = 'N'    where ToBeProcessed = 'Y'      update centralhealth.CHMEMBERS    set tobeprocessed = 'N'    where ToBeProcessed = 'Y'      update centralhealth.DataViewCHMembers     set MemberPhoneNumber = ''    where MemberIdentificationNumber in ( select MemberIdentificationNumber from centralhealth.DataViewCHMembers    where len(Memberphonenumber) >10)        MERGE centralhealth.CHmembers m USING centralhealth.DataViewCHMembers d    ON (m.NHLinkID = d.NHLinkID)    WHEN MATCHED THEN    UPDATE SET    MemberIdentificationNumber = d.MemberIdentificationNumber,    MembersDateOfBirth = d.MembersDateOfBirth,    MemberLastName = d.MemberLastName,    MemberFirstName = d.MemberFirstName,    MemberMiddleName = d.MemberMiddleName,    SocialSecurityNumber = d.SocialSecurityNumber,    MemberPhoneNumber = case isnull(d.MemberPhoneNumber,'') when '' then 0 else cast(d.MemberPhoneNumber as bigint) end,    MemberAddressLine1 = d.MemberAddressLine1,    MemberAddressLine2 = d.MemberAddressLine2,    MemberCityName = d.MemberCityName,    MemberStateName = d.MemberStateName,    MemberZipCode = d.MemberZipCode,    MemberDateOfDeath = d.MemberDateOfDeath,    MemberSex = d.MemberSex,    MemberRace = d.MemberRace,    MemberLanguage = d.MemberLanguage,    MemberMailingAddressLine1 = d.MemberMailingAddressLine1,    MemberMailingAddressLine2 = d.MemberMailingAddressLine2,    MemberMailingCityName = d.MemberMailingCityName,    MemberMailingStateName = d.MemberMailingStateName,    MemberMailingZipCode = d.MemberMailingZipCode,    statusflag = 'U',    tobeprocessed = 'Y',    ModifyDate = @sys_date,    ModifyUser = @sys_usr    WHEN NOT MATCHED THEN    INSERT (    NHLinkID,    MemberIdentificationNumber,    MembersDateOfBirth,    MemberLastName,    MemberFirstName,    MemberMiddleName,    SocialSecurityNumber,    MemberPhoneNumber,    MemberAddressLine1,    MemberAddressLine2,    MemberCityName,    MemberStateName,    MemberZipCode,    MemberDateOfDeath,    MemberSex,    MemberRace,    MemberLanguage,    MemberMailingAddressLine1,    MemberMailingAddressLine2,    MemberMailingCityName,    MemberMailingStateName,    MemberMailingZipCode,    statusflag,    tobeprocessed,    createDate,    CreateUser,    ModifyDate,    ModifyUser)    VALUES (    d.NHLinkID,    d.MemberIdentification
    -- EXEC [centralhealth].[CH_elig_file_load_ssis_sp_merge_ch_to_masters]    CREATE PROCEDURE [centralhealth].[CH_elig_file_load_ssis_sp_merge_ch_to_masters]  AS      BEGIN     --BEGIN TRY   --BEGIN TRANSACTION CH_ELIG_MERGE_ch_to_masters            DECLARE @sys_usr CHAR(30)           ,@sys_date DATETIME;        SET @sys_usr = SYSTEM_USER    SET @sys_date = CAST(GETDATE() AT TIME ZONE 'UTC' AT TIME ZONE 'Eastern Standard Time' AS DATETIME);  -- Time in EST      ---- drop not null record insert constraint (unique index) on NHMemberID in master.members before inserting new members or updating NHMemberID for new records inserted    --ALTER TABLE [otc].[Cards] DROP CONSTRAINT [FK_Cards_NHMemberId]        --ALTER TABLE [Master].[Members] DROP CONSTRAINT [IX_Members_NHMemberID_U]        DROP TABLE IF EXISTS #temp_elig_CH_TMembers      select *,'ELIG' + convert(VARCHAR, NEXT VALUE FOR [elig].[NHMemberIDSeq]) Temp_NHMemberID    into #temp_elig_CH_TMembers     from centralhealth.CHmembers     where 1=1    and tobeprocessed = 'Y'     and statusflag in ('N','U')      merge into master.members d    using (select * from #temp_elig_CH_TMembers) s    on (d.memberid = s.mastermemberid )    when matched then     update set    d.datasource = 'ELIG_CH',    d.DateOfBirth = s.MembersDateOfBirth,    d.FirstName = s.MemberFirstName,    d.Gender = s.MemberSex,    d.IsActive = 1,    d.LastName = s.MemberLastName,    d.MiddleInitial = s.MemberMiddleName,    d.ModifyDate = @sys_date,    d.ModifyUser = @sys_usr,    d.eligFile = 'ELIG_CH',    d.eligFileID = s.ID    when not matched then     insert (     CreateDate,     CreateUser,     DataSource,     DateOfBirth,     FirstName,     Gender,     IsActive,     NHMemberID,     LastName,     MiddleInitial,     ModifyDate,     ModifyUser,     eligFile,     eligFileID)      values      (     @sys_date    ,@sys_usr    ,'ELIG_CH'    ,MembersDateOfBirth    ,MemberFirstName    ,MemberSex    ,1    ,Temp_NHMemberID --  temp value later will be updated to what ever it should be    ,MemberLastName    ,MemberMiddleName    ,@sys_date    ,@sys_usr    ,'ELIG_CH'    ,s.ID     );      update master.members    SET nhmemberid = 'NH'+RIGHT(YEAR(GETDATE()),4)+ FORMAT(memberid,'00000000')        --    'NH2018'+ FORMAT(memberid,'00000000')    WHERE EligFile = 'ELIG_CH'    --AND nhmemberid IS NULL    AND nhmemberid Like 'ELIG%'      --ALTER TABLE [Master].[Members] ADD  CONSTRAINT [IX_Members_NHMemberID_U] UNIQUE NONCLUSTERED     --  (    --   [NHMemberID] ASC    --  )      --ALTER TABLE [otc].[Cards]  ADD  CONSTRAINT [FK_Cards_NHMemberId] FOREIGN KEY    --(    -- [NHMemberId]    --)    --REFERENCES [Master].[Members] ([NHMemberID])              update a     set mastermemberid = (select memberid from master.members m where m.eligfile= 'ELIG_CH' and m.eligFileID = a.id)    from centralhealth.CHmembers a    where tobeprocessed = 'Y'    and mastermemberid is null          update i    set mastermemberid = (select mastermemberid from centralhealth.CHMembers m where m.NHLinkID = i.NHLinkID )    from centralhealth.CHInsurance i    where exists (select 1 from centralhealth.CHmembers m1 where m1.NHLinkID = i.NHLinkID)    and i.ToBeProcessed = 'Y'    and mastermemberid is null         merge master.addresses d    using (select * from centralhealth.CHmembers where tobeprocessed = 'Y' and MemberAddressLine1 <> '') s    on (d.memberid = s.mastermemberid and d.AddressTypeCode = 'PERM')    when matched then    update set    Address1 = s.MemberAddressLine1    ,Address2 = s.MemberAddressLine2    ,City = s.MemberCityName    ,State = s.MemberStateName    ,ZipCode = s.MemberZipCode    ,IsActive = 1    ,IsPreferredAddress = 1    ,MemberID = s.mastermemberid    ,ModifyDate = @sys_date    , ModifyUser = @sys_usr    when not matched then     insert (     Address1    ,Address2    ,AddressTypeCode    ,City    ,State    ,ZipCode    ,EffectiveFromDate    ,EffectiveToDate    ,IsActive    ,IsPreferredAddress    ,MemberID    ,CreateDate    ,CreateUser    ,Modify
CREATE PROCEDURE [centralhealth].[CH_elig_file_load_ssis_sp_merge]   @Client_Name varchar(20)  AS  -- exec [centralhealth].[CH_elig_file_load_ssis_sp_merge] 'ELIG_CH'    IF @Client_Name = 'ELIG_CH'    BEGIN        BEGIN TRY       BEGIN TRANSACTION CH_elig_file_load_ssis         EXEC [centralhealth].[CH_elig_file_load_ssis_sp_merge_stg_to_ch]       EXEC [centralhealth].[CH_elig_file_load_ssis_sp_merge_ch_to_masters]        COMMIT TRANSACTION CH_elig_file_load_ssis      PRINT 'SUCCESS'    END TRY      BEGIN CATCH    DECLARE @ErrorMessage NVARCHAR(4000);      DECLARE @ErrorSeverity INT;      DECLARE @ErrorState INT;        SELECT        @ErrorMessage = ERROR_MESSAGE(),       @ErrorSeverity = ERROR_SEVERITY(),       @ErrorState = ERROR_STATE();        IF (@@TRANCOUNT > 0)    BEGIN     ROLLBACK TRANSACTION CH_elig_file_load_ssis     RAISERROR(@ErrorMessage,@ErrorSeverity,@ErrorState);     PRINT 'FAILED'    END      END CATCH          END
CREATE PROCEDURE [Claims].[GetClaimRecordMain_TEST] --308549  (     @MemberChartDataID numeric,     @ClaimNbr numeric = 0,     @ClaimDtlSeqNbr numeric = 0  )  AS  BEGIN    --- Declare Constants       declare @CONST_NHBillingNPI varchar(20) = '1871042317' -- TBD   declare @CONST_NHBillingTax varchar(20) = '474660944' -- TBD   declare @CONST_AddressTypeCode  varchar(20) = 'PERM'   declare @CONST_PhoneTypeCode    varchar(20) = 'HOME'   declare @CONST_InsuranceType    varchar(20) = 'PRIMARY'   --declare @CONST_AppointmentStatus      varchar(20) = 'Complete'   declare @CONST_Status_Complete varchar(20) = 'COMPLETE'   declare @CONST_Status_Show varchar(20) = 'SHOW'   declare @CONST_Status_Checkin varchar(20) = 'CHECKIN' --Added Raj   declare @CONST_TESTING_MINORSTEP numeric = 16   declare @CONST_FITTING_MINORSTEP numeric = 25   declare @CONST_HA_MINORSTEP      numeric = 23   declare @CONST_CLAIM_SPLIT varchar(10) = 'SPLIT'   declare @CONST_CLAIM_SINGLE varchar(10) = 'SINGLE'   declare @MemberChartDataIdTesting numeric = 0   declare @MemberChartDataIdFitting numeric = 0   declare @MemberChartDataIdHearing numeric = 0   declare @ClaimDueDays numeric = 0   declare @memberId numeric = 0    --- Input Validation - Check if given MemberChart Data Id is exists       declare @MinorProcessId numeric       select @MinorProcessId = mcd.MinorProcessId    from provider.MemberChartData mcd         --inner join provider.MemberAppointments mapt on mapt.MemberChartDataId =  mcd.MemberChartDataId and UPPER(mapt.AppointmentStatus)= @CONST_AppointmentStatus   where mcd.MemberChartDataId=@MemberChartDataID  -- and mcd.IsComplete=1      -- Check if the chartId belongs either testing/ha or fitting   IF @MinorProcessId <> @CONST_TESTING_MINORSTEP AND @MinorProcessId <> @CONST_FITTING_MINORSTEP and @MinorProcessId <> @CONST_HA_MINORSTEP   BEGIN      select 'Invalid MemberChartDataID ['+ @MemberChartDataID +'] Or MemberChartDataID step is NOT Complete Or Appoinment is NOT marked a Complete' AS 'ERROR'      return   END    IF @MinorProcessId <> @CONST_HA_MINORSTEP   BEGIN       -- Check if Test OR Fitting Appointments marked a close       declare @IsAppointmentClosed bit       select @IsAppointmentClosed = 1 from provider.MemberAppointments mapt where mapt.MemberChartDataId =  @MemberChartDataID      and (UPPER(mapt.AppointmentStatus)= @CONST_Status_Show       OR UPPER(mapt.AppointmentStatus)= @CONST_Status_Complete       OR UPPER(mapt.AppointmentStatus)= @CONST_Status_Checkin )     --and UPPER(mapt.AppointmentStatus)= @CONST_AppointmentStatus       IF @IsAppointmentClosed <> 1       BEGIN      select 'MemberChartDataID ['+@MemberChartDataID +']Appoinment is NOT marked a Complete' AS 'ERROR'     return      END     END     -- 1. Get Insurance Carrier ID and NHMemberID active as of that Service Date       declare @InsuranceCarrierName varchar(100)   declare @InsuranceCarrierID numeric   declare @InsuranceHealthPlanID numeric    declare @NHMemberID varchar(25)   declare @MemberProfileId numeric    declare @HCPProfileId numeric    declare @ProviderId numeric    declare @HCPCSCode varchar(50)   declare @ICD10Code varchar(50)   --PRINT @MinorProcessId     IF @MinorProcessId = @CONST_FITTING_MINORSTEP    begin        SET @MemberChartDataIdFitting = @MemberChartDataID     select        @InsuranceCarrierName = case    when CAST(JSON_VALUE(mcd.ProcessData, '$.InsuranceCarrierName') as NVARCHAR(50)) IS NULL               then ic.InsuranceCarrierName              else JSON_VALUE(mcd.ProcessData, '$.InsuranceCarrierName') end,         @InsuranceCarrierID =   case    when CAST(JSON_VALUE(mcd.ProcessData, '$.InsuranceCarrierId') as NVARCHAR(50)) IS NULL               then ic.InsuranceCarrierID              else JSON_VALUE(mcd.ProcessData, '$.InsuranceCarrierId') end,          @InsuranceHealthPlanID =   case when CAST(JSON_VALUE(mcd.ProcessData, '$.PlanId') as NVARCHAR(50)) IS NULL               then mi.InsuranceHealthPlanID              else JSON_VALUE(mcd.ProcessData, '$.P
-- =============================================  -- Author:      Mohan Nanduri  -- Create Date: 7 Dec 2019  -- Description: Generates Testing Claim based on MemberChartDataID   -- =============================================  CREATE PROCEDURE [Claims].[GetTestingClaimRecord_TEST]   (      -- Add the parameters for the stored procedure here          @MinorProcessId numeric,        @MemberChartDataID numeric,    @NHMemberID varchar(50),     @ProviderId numeric,    @HCPProfileId numeric,     @NBInsuranceId varchar(100),     @InsuranceCarrierID numeric,    @InsurancePlanID numeric,    @InsuranceCarrierName varchar(100),     @CONST_NHBillingNPI varchar(50),     @CONST_NHBillingTax varchar(50),     @HCPCSCode varchar(50),     @ICD10Code varchar(50),     @PlaceofService varchar(50),    @CONST_PhoneTypeCode varchar(50),     @CONST_InsuranceType varchar(50),     @CONST_Status_Complete varchar(50),    @CONST_AddressTypeCode varchar(50),     @GroupAllServicesBy varchar(50),     @UseNationsAsBillingProvider varchar(50),     @UseNationsAsRenderingProvider varchar(50),     @DefaultClaimAmount float,     @ClaimNbr numeric,    @ClaimDtlSeqNbr numeric,    @ClaimDueDays numeric    --@IsZeroClaim bit  )  AS  BEGIN    --- Declare Constants    declare @CONST_TESTING varchar(20) = '92591'   declare @CONST_Status_Show varchar(20) = 'SHOW'   declare @CONST_Status_Checkin varchar(20) = 'CHECKIN'    -- 1. Get Insurance Carrier ID and NHMemberID active as of that Service Date     --- RETURN TESTING CLAIM RECORD       INSERT INTO [Claims].[ClaimFiles1]   select top 200 m.NHMemberID as 'NHMemberId'   --, ROW_NUMBER() over (order by m.NHMemberID)  as 'ClaimNbr'   ,@ClaimNbr as 'ClaimNbr'   , @ClaimDtlSeqNbr  as  'ClaimDtlSeqNbr'   , @NBInsuranceId as 'InsuranceID'   , UPPER(m.FirstName) as 'member_first_name'   , UPPER(m.LastName) as 'member_last_name'   , UPPER(m.MiddleInitial) as 'member_middle_initial'   , UPPER(ma.Address1)   as 'member_address1'    , UPPER(ma.Address2) as 'member_address2'   , UPPER(ma.City) as 'member_city'   , UPPER(ma.State) as 'member_state'   , UPPER(ma.ZipCode) as 'member_zipcode'   , isnull(mp.PhoneNbr, '9999999999') as 'member_phone_nbr'   , case when m.DateOfBirth is null then null else case when CONVERT(date,  m.DateOfBirth, 102)='0001-01-01' then null else CONVERT(date,  m.DateOfBirth, 102) END END as 'member_DOB'   , m.Gender as 'member_gender'   , 'SELF'as 'relationship_txt'   , mia.[InsuranceNbr]as 'policy_number'   , mia.[GroupNbr]as 'group_number'   , isnull(mia.[MedicareNbr],'')as 'MedicareNbr'   , isnull(mia.[MedicaidNbr],'')as 'MedicaidNbr'   , CONVERT(date,  mi.InsuranceEffectiveDate, 102)  as 'effective_from_date'   , CONVERT(date,  mi.InsuranceEndDate, 102)  as'effective_to_date'   , @InsuranceCarrierName as 'InsuranceCarrierName'   , '' as 'prior_auth' -- Need clarification from Alan on what to pass here (May be PriorAuth Confirmation Code    -- Getting TEST Service Records          , CONVERT(date,  mapt.EndTime, 102) as 'Date_of_Service'   , '' as 'ReturnDate'   , @CONST_TESTING   as 'ItemID'   , hcp.NPINumber      as 'HCPNPINumber'     , hcp.FirstName  as 'HCPFirstName'      , hcp.LastName  as 'HCPLastName'      , pro.NPINumber  as 'OrganizationNPI'      , pro.TaxId  as 'OrganizationTaxID'   , case when @UseNationsAsBillingProvider = 1 then @CONST_NHBillingNPI  else  pro.NPINumber end as 'BillingNPI'      , case when @UseNationsAsBillingProvider = 1 then @CONST_NHBillingTax  else   pro.TaxId end as  'BillingTaxID'   , case when @ICD10Code is null then 'H90.3' else @ICD10Code end as 'ICD_10_Code'    , case when @HCPCSCode is null  then '92591'else @HCPCSCode end as 'HCPSCode'   , 'NEW' as 'Status'   ,@DefaultClaimAmount as 'ChargeAmount'   ,@DefaultClaimAmount as 'CopayAmount'   ,@DefaultClaimAmount as 'BenefitAmount'   ,'' as 'CoInsuranceAmt'   ,'' as 'CoInsurancePercent'   ,'' as 'NonConveredAmt'   ,@DefaultClaimAmount as 'MemberPaid'   ,'' as 'Modifier1'   ,'' as 'Modifier2'   ,'' as 'Modifier3'   ,'' as '
CREATE PROCEDURE [Claims].[GetHearingaidClaimRecord_TEST]   (      -- Add the parameters for the stored procedure here          @MinorProcessId numeric,        @MemberChartDataID numeric,    @NHMemberID varchar(50),     @ProviderId numeric,    @HCPProfileId numeric,     @NBInsuranceId varchar(50),     @InsuranceCarrierID numeric,    @InsurancePlanID numeric,    @InsuranceCarrierName varchar(100),     @CONST_NHBillingNPI varchar(50),     @CONST_NHBillingTax varchar(50),     @HCPCSCode varchar(50),     @ICD10Code varchar(50),     @PlaceofService varchar(50),    @CONST_PhoneTypeCode varchar(50),     @CONST_InsuranceType varchar(50),     @CONST_Status_Complete varchar(50),    @CONST_AddressTypeCode varchar(50),     @GroupAllServicesBy varchar(50),     @UseNationsAsBillingProvider varchar(50),     @UseNationsAsRenderingProvider varchar(50),     @DefaultClaimAmount float,     @ClaimNbr numeric,    @ClaimDtlSeqNbr numeric,    @ClaimDueDays numeric  )  AS  BEGIN    --- Declare Constants    declare @CONST_HA varchar(20) = 'HA'          INSERT INTO [Claims].[ClaimFiles1]   select top 1 m.NHMemberID as 'NHMemberId'   , @ClaimNbr as 'ClaimNbr'   , @ClaimDtlSeqNbr  as  'ClaimDtlSeqNbr'   , @NBInsuranceId as 'InsuranceID'   , UPPER(m.FirstName) as 'member_first_name'   , UPPER(m.LastName) as 'member_last_name'   , UPPER(m.MiddleInitial) as 'member_middle_initial'   , UPPER(ma.Address1)   as 'member_address1'    , UPPER(ma.Address2) as 'member_address2'   , UPPER(ma.City) as 'member_city'   , UPPER(ma.State) as 'member_state'   , UPPER(ma.ZipCode) as 'member_zipcode'   , isnull(mp.PhoneNbr, '9999999999') as 'member_phone_nbr'   , case when m.DateOfBirth is null then null else case when CONVERT(date,  m.DateOfBirth, 102)='0001-01-01' then null else CONVERT(date,  m.DateOfBirth, 102) END END as 'member_DOB'   , m.Gender as 'member_gender'   , 'SELF' as 'relationship_txt'   , mia.[InsuranceNbr]as 'policy_number'   , mia.[GroupNbr]as 'group_number'   , isnull(mia.[MedicareNbr],'')as 'MedicareNbr'   , isnull(mia.[MedicaidNbr],'')as 'MedicaidNbr'   , CONVERT(date,  mi.InsuranceEffectiveDate, 102)  as 'effective_from_date'   , CONVERT(date,  mi.InsuranceEndDate, 102)  as'effective_to_date'   ,(case when  @InsuranceCarrierName is null then (select [InsuranceCarrierName] from [Insurance].[InsuranceCarriers] where [InsuranceCarrierID]=@InsuranceCarrierID) else @InsuranceCarrierName end)  as 'InsuranceCarrierName'   , '' as 'prior_auth' -- Need clarification from Alan on what to pass here (May be PriorAuth Confirmation Code    -- Getting TEST Service Records          --, cast(substring(JSON_VALUE(mcd.ProcessData, '$.orderDate'),1,10) as datetime) as 'Date_of_Service'   ,CONVERT(date,  pos.[PODate], 102) as 'Date_of_Service'   , '' as 'ReturnDate'   , concat(ordItems.ItemCode,'_',(select count(*) from orders.orderitems where itemtype=@CONST_HA and status='active' and orderid=ord.OrderID))  as 'ItemID'   , hcp.NPINumber      as 'HCPNPINumbe'   , hcp.FirstName  as 'HCPFirstName'      , hcp.LastName  as 'HCPLastName'      , pro.NPINumber  as 'OrganizationNPI'      , pro.TaxId  as 'OrganizationTaxID'   , case when @UseNationsAsBillingProvider = 1 then @CONST_NHBillingNPI  else  pro.NPINumber end as 'BillingNPI'      , case when @UseNationsAsBillingProvider = 1 then @CONST_NHBillingTax  else   pro.TaxId end as  'BillingTaxID'   , @ICD10Code as 'ICD_10_Code'   ,(select hcpcsAidCode from [catalog].[Get_HearingService_HA_Items](ordItems.ItemCode,(select count(*) from orders.orderitems where itemtype=@CONST_HA and status='active' and orderid=ord.OrderID))) as 'HCPSCode'   , 'NEW' as 'Status'   ,Claims.GetOrderAmountDataByValue(ord.OrderAmountData,'productprice',ord.BenefitsData) as 'ChargeAmount'    ,@DefaultClaimAmount as 'CopayAmount'   ,Claims.GetOrderAmountDataByValue(ord.OrderAmountData,'benefitAmount',ord.BenefitsData) as 'BenefitAmount'   ,'' as 'CoInsuranceAmt'   ,'' as 'CoInsurancePercent'   ,'' as 'NonConveredAmt'   ,Claims.GetOrderAmountDataByValue(or
-- =============================================  -- Author:      Mohan Nanduri  -- Create Date: 7 Dec 2019  -- Description: Generates Fitting Claim based on MemberChartDataID   -- =============================================  CREATE PROCEDURE [Claims].[GetFittingClaimRecord_TEST]   (      -- Add the parameters for the stored procedure here          @MinorProcessId numeric,        @MemberChartDataID numeric,    @NHMemberID varchar(50),     @ProviderId numeric,    @HCPProfileId numeric,     @NBInsuranceId varchar(50),     @InsuranceCarrierID numeric,    @InsurancePlanID numeric,    @InsuranceCarrierName varchar(100),     @CONST_NHBillingNPI varchar(50),     @CONST_NHBillingTax varchar(50),     @HCPCSCode varchar(50),     @ICD10Code varchar(50),     @PlaceofService varchar(50),    @CONST_PhoneTypeCode varchar(50),     @CONST_InsuranceType varchar(50),     @CONST_Status_Complete varchar(50),     @CONST_AddressTypeCode varchar(50),     @GroupAllServicesBy varchar(50),     @UseNationsAsBillingProvider varchar(50),     @UseNationsAsRenderingProvider varchar(50),     @DefaultClaimAmount float,     @ClaimNbr numeric,    @ClaimDtlSeqNbr numeric,    @ClaimDueDays numeric  )  AS  BEGIN    --- Declare Constants    declare @CONST_FITTINF varchar(20) = 'V5011'   declare @CONST_Status_Show varchar(20) = 'SHOW'    --- RETURN TESTING CLAIM RECORD       INSERT INTO [Claims].[ClaimFiles1]   select top 200 m.NHMemberID as 'NHMemberId'   , @ClaimNbr as 'ClaimNbr'   , @ClaimDtlSeqNbr  as  'ClaimDtlSeqNbr'   , @NBInsuranceId as 'InsuranceID'   , UPPER(m.FirstName) as 'member_first_name'   , UPPER(m.LastName) as 'member_last_name'   , UPPER(m.MiddleInitial) as 'member_middle_initial'   , UPPER(ma.Address1)   as 'member_address1'    , UPPER(ma.Address2)  as 'member_address2'   , UPPER(ma.City) as 'member_city'   , UPPER(ma.State) as 'member_state'   , UPPER(ma.ZipCode) as 'member_zipcode'   , isnull(mp.PhoneNbr, '9999999999') as 'member_phone_nbr'   , case when m.DateOfBirth is null then null else case when CONVERT(date,  m.DateOfBirth, 102)='0001-01-01' then null else CONVERT(date,  m.DateOfBirth, 102) END END as 'member_DOB'   , m.Gender as 'member_gender'   , 'SELF'as 'relationship_txt'   , mia.[InsuranceNbr]as 'policy_number'   , mia.[GroupNbr]as 'group_number'   , isnull(mia.[MedicareNbr],'')as 'MedicareNbr'   , isnull(mia.[MedicaidNbr],'')as 'MedicaidNbr'   , CONVERT(date,  mi.InsuranceEffectiveDate, 102)  as 'effective_from_date'   , CONVERT(date,  mi.InsuranceEndDate, 102)  as'effective_to_date'   , @InsuranceCarrierName as 'InsuranceCarrierName'   , '' as 'prior_auth' -- Need clarification from Alan on what to pass here (May be PriorAuth Confirmation Code    -- Getting TEST Service Records          , CONVERT(date,  mapt.EndTime, 102) as 'Date_of_Service'   , '' as 'ReturnDate'   , @CONST_FITTINF   as 'ItemID'   , hcp.NPINumber      as 'HCPNPINumber'     , hcp.FirstName  as 'HCPFirstName'      , hcp.LastName  as 'HCPLastName'      , pro.NPINumber  as 'OrganizationNPI'      , pro.TaxId  as 'OrganizationTaxID'   , case when @UseNationsAsBillingProvider = 1 then @CONST_NHBillingNPI  else  pro.NPINumber end as 'BillingNPI'      , case when @UseNationsAsBillingProvider = 1 then @CONST_NHBillingTax  else   pro.TaxId end as  'BillingTaxID'   , case when @ICD10Code is null then 'H90.3' else @ICD10Code end as 'ICD_10_Code'    , case when @HCPCSCode is null  then 'V5011'else @HCPCSCode end as 'HCPSCode'   , 'NEW' as 'Status'   ,@DefaultClaimAmount as 'ChargeAmount'   ,@DefaultClaimAmount as 'CopayAmount'   ,@DefaultClaimAmount as 'BenefitAmount'   ,'' as 'CoInsuranceAmt'   ,'' as 'CoInsurancePercent'   ,'' as 'NonConveredAmt'   ,@DefaultClaimAmount as 'MemberPaid'   ,'' as 'Modifier1'   ,'' as 'Modifier2'   ,'' as 'Modifier3'   ,'' as 'Modifier4'   ,'1' as 'Units'   ,'' as 'SecondaryInsuranceID'   ,'' as 'SecondaryPolicyNbr'   ,'' as 'SecondaryGroupNbr'   ,@PlaceofService as 'PlaceofService'   ,'TRUE' as 'InsertMode'   , loc.Address1 as 'LocationAddres
  /*   [Mohan Update 14 Feb 2020 : Fixed CROS issues   [Mohan 2/20/2020, Per Dianne set HCPNPI if OrgNPI is null   [Mohan 3/9/2020   Added a logic to retuen only credentialed HCP data by chekcing [provider].[HCPProviderProfile] where isActive=1  [Mohan 3/27/2020  HF277 Fix : Split Binorial HealthFirst Claims into two Monorial Claims   */     CREATE PROCEDURE [Claims].[GetHearingaidClaimRecord]   (      -- Add the parameters for the stored procedure here          @MinorProcessId numeric,        @MemberChartDataID numeric,    @NHMemberID varchar(50),     @ProviderId numeric,    @HCPProfileId numeric,     @NBInsuranceId varchar(50),     @InsuranceCarrierID numeric,    @InsurancePlanID numeric,    @InsuranceCarrierName varchar(100),     @CONST_NHBillingNPI varchar(50),     @CONST_NHBillingTax varchar(50),     @HCPCSCode varchar(50),     @ICD10Code varchar(50),     @PlaceofService varchar(50),    @CONST_PhoneTypeCode varchar(50),     @CONST_InsuranceType varchar(50),     @CONST_Status_Complete varchar(50),    @CONST_AddressTypeCode varchar(50),     @GroupAllServicesBy varchar(50),     @UseNationsAsBillingProvider varchar(50),     @UseNationsAsRenderingProvider varchar(50),     @DefaultClaimAmount float,     @ClaimNbr numeric,    @ClaimDtlSeqNbr numeric,    @ClaimDueDays numeric,       @ApplyCopay bit,    @CopyPrimaryAsSecondaryInsu bit  )  AS  BEGIN    --- Declare Constants    declare @CONST_HA varchar(20) = 'HA'    declare @CONST_CROS varchar(20) = 'CROS'    --- Get HearingAid Co_Payment required       declare @HACoPay numeric   select top 1  @HACoPay = cb.HearingAidCoPay FROM [Insurance].[ContractBenefits] cb   INNER JOIN [Insurance].[HealthPlanContracts] hp          on  hp.HealthPlanContractID = cb.HealthPlanContractID       and hp.InsuranceCarrierID=@InsuranceCarrierID       and hp.InsuranceHealthPlanID = @InsurancePlanID   SET @HACoPay = ISNULL(@HACoPay,@DefaultClaimAmount)    --- HEALTH FIRST : Split Binorial Claims into two Monorial Claims --      declare @IsSplitRequired bit = 0   declare @ItemCnt numeric    select top 1 @ItemCnt = count(*) from orders.orderitems oi     inner join provider.MemberChartData mcd      on mcd.IsActive=1 and mcd.MemberChartDataId = @MemberChartDataID   inner join orders.Orders ord                  on ord.OrderID = JSON_VALUE(mcd.ProcessData, '$.orderId') and ord.OrderID=oi.OrderId   where oi.itemtype in (@CONST_HA,@CONST_CROS) and oi.status='active'   IF (@InsuranceCarrierID = 277 and @ItemCnt = 2)    BEGIN     set @IsSplitRequired=1    END         IF @IsSplitRequired=0   BEGIN    INSERT INTO [Claims].[ClaimFiles]   select top 1 m.NHMemberID as 'NHMemberId'   , @ClaimNbr as 'ClaimNbr'   , @ClaimDtlSeqNbr  as  'ClaimDtlSeqNbr'   , @NBInsuranceId as 'InsuranceID'   , UPPER(m.FirstName) as 'member_first_name'   , UPPER(m.LastName) as 'member_last_name'   , UPPER(m.MiddleInitial) as 'member_middle_initial'   , UPPER(ma.Address1)   as 'member_address1'    , UPPER(ma.Address2) as 'member_address2'   , UPPER(ma.City) as 'member_city'   , UPPER(ma.State) as 'member_state'   --, UPPER(ma.ZipCode) as 'member_zipcode' --by DPSR on 6232020   ,UPPER(ltrim(rtrim(substring(ma.ZipCode,1,5)))) as 'member_zipcode' --added by DPSR   --, isnull(mp.PhoneNbr, '9999999999') as 'member_phone_nbr' --by DPSR on 6232020   ,isnull((case when mp.PhoneNbr = 0 then null else mp.PhoneNbr end) , '9999999999') as 'member_phone_nbr' --added by DPSR   , case when m.DateOfBirth is null then null else case when CONVERT(date,  m.DateOfBirth, 102)='0001-01-01' then null else CONVERT(date,  m.DateOfBirth, 102) END END as 'member_DOB'   , m.Gender as 'member_gender'   , 'SELF' as 'relationship_txt'   , mia.[InsuranceNbr]as 'policy_number'   , mia.[GroupNbr]as 'group_number'   , isnull(mia.[MedicareNbr],'')as 'MedicareNbr'   , isnull(mia.[MedicaidNbr],'')as 'MedicaidNbr'   , CONVERT(date,  mi.InsuranceEffectiveDate, 102)  as 'effective_from_date'   , CASE WHEN CONVERT(date,  mi.InsuranceEndDate, 102) = '12/31/9999'            THEN '12/31/
-- =============================================  -- Author:      Mohan Nanduri  -- Create Date: 7 Dec 2019  -- Description: Generates Fitting Claim based on MemberChartDataID   --              [Mohan 2/20/2020, Per Dianne set HCPNPI if OrgNPI is null   --              [Mohan 3/9/2020   Added a logic to retuen only credentialed HCP data by chekcing [provider].[HCPProviderProfile] where isActive=1  -- =============================================  CREATE PROCEDURE [Claims].[GetFittingClaimRecord]   (      -- Add the parameters for the stored procedure here          @MinorProcessId numeric,        @MemberChartDataID numeric,    @NHMemberID varchar(50),     @ProviderId numeric,    @HCPProfileId numeric,     @NBInsuranceId varchar(50),     @InsuranceCarrierID numeric,    @InsurancePlanID numeric,    @InsuranceCarrierName varchar(100),     @CONST_NHBillingNPI varchar(50),     @CONST_NHBillingTax varchar(50),     @HCPCSCode varchar(50),     @ICD10Code varchar(50),     @PlaceofService varchar(50),    @CONST_PhoneTypeCode varchar(50),     @CONST_InsuranceType varchar(50),     @CONST_Status_Complete varchar(50),     @CONST_AddressTypeCode varchar(50),     @GroupAllServicesBy varchar(50),     @UseNationsAsBillingProvider varchar(50),     @UseNationsAsRenderingProvider varchar(50),     @DefaultClaimAmount float,     @ClaimNbr numeric,    @ClaimDtlSeqNbr numeric,    @ClaimDueDays numeric,    @ApplyCopay bit,     @CopyPrimaryAsSecondaryInsu bit  )  AS  BEGIN    --- Declare Constants    declare @CONST_FITTINF varchar(20) = 'V5011'   declare @CONST_Status_Show varchar(20) = 'SHOW'     --- Get Fitting Co_Payment required       declare @FittingCoPay numeric   select top 1  @FittingCoPay = cb.FittingCoPay FROM [Insurance].[ContractBenefits] cb   INNER JOIN [Insurance].[HealthPlanContracts] hp          on  hp.HealthPlanContractID = cb.HealthPlanContractID       and hp.InsuranceCarrierID=@InsuranceCarrierID       and hp.InsuranceHealthPlanID = @InsurancePlanID   SET @FittingCoPay = ISNULL(@FittingCoPay,@DefaultClaimAmount)        --- RETURN TESTING CLAIM RECORD       INSERT INTO [Claims].[ClaimFiles]   select top 1 m.NHMemberID as 'NHMemberId'   , @ClaimNbr as 'ClaimNbr'   , @ClaimDtlSeqNbr  as  'ClaimDtlSeqNbr'   , @NBInsuranceId as 'InsuranceID'   , UPPER(m.FirstName) as 'member_first_name'   , UPPER(m.LastName) as 'member_last_name'   , UPPER(m.MiddleInitial) as 'member_middle_initial'   , UPPER(ma.Address1)   as 'member_address1'    , UPPER(ma.Address2)  as 'member_address2'   , UPPER(ma.City) as 'member_city'   , UPPER(ma.State) as 'member_state'   --, UPPER(ma.ZipCode) as 'member_zipcode' --by DPSR on 6232020   ,UPPER(ltrim(rtrim(substring(ma.ZipCode,1,5)))) as 'member_zipcode' --added by DPSR   --, isnull(mp.PhoneNbr, '9999999999') as 'member_phone_nbr' --by DPSR on 6232020   ,isnull((case when mp.PhoneNbr = 0 then null else mp.PhoneNbr end) , '9999999999') as 'member_phone_nbr' --added by DPSR   , case when m.DateOfBirth is null then null else case when CONVERT(date,  m.DateOfBirth, 102)='0001-01-01' then null else CONVERT(date,  m.DateOfBirth, 102) END END as 'member_DOB'   , m.Gender as 'member_gender'   , 'SELF'as 'relationship_txt'   , mia.[InsuranceNbr]as 'policy_number'   , mia.[GroupNbr]as 'group_number'   , isnull(mia.[MedicareNbr],'')as 'MedicareNbr'   , isnull(mia.[MedicaidNbr],'')as 'MedicaidNbr'   , CONVERT(date,  mi.InsuranceEffectiveDate, 102)  as 'effective_from_date'   , CASE WHEN CONVERT(date,  mi.InsuranceEndDate, 102) = '12/31/9999'            THEN '12/31/2099'      ELSE CONVERT(date,  mi.InsuranceEndDate, 102)      END  as'effective_to_date'   , @InsuranceCarrierName as 'InsuranceCarrierName'   , '' as 'prior_auth' -- Need clarification from Alan on what to pass here (May be PriorAuth Confirmation Code    -- Getting TEST Service Records          , CONVERT(date,  mapt.EndTime, 102) as 'Date_of_Service'   , '' as 'ReturnDate'   , @CONST_FITTINF   as 'ItemID'   , hcp.NPINumber      as 'HCPNPINumber'     , hcp.FirstName  a
-- =============================================  -- Author:      Mohan Nanduri  -- Create Date: 7 Dec 2019  -- Description: Generates Testing Claim based on MemberChartDataID   --              [Mohan 2/20/2020, Per Dianne set HCPNPI if OrgNPI is null    -- =============================================  CREATE PROCEDURE [Claims].[GetTestingClaimRecord]   (      -- Add the parameters for the stored procedure here          @MinorProcessId numeric,        @MemberChartDataID numeric,    @NHMemberID varchar(50),     @ProviderId numeric,    @HCPProfileId numeric,     @NBInsuranceId varchar(100),     @InsuranceCarrierID numeric,    @InsurancePlanID numeric,    @InsuranceCarrierName varchar(100),     @CONST_NHBillingNPI varchar(50),     @CONST_NHBillingTax varchar(50),     @HCPCSCode varchar(50),     @ICD10Code varchar(50),     @PlaceofService varchar(50),    @CONST_PhoneTypeCode varchar(50),     @CONST_InsuranceType varchar(50),     @CONST_Status_Complete varchar(50),    @CONST_AddressTypeCode varchar(50),     @GroupAllServicesBy varchar(50),     @UseNationsAsBillingProvider varchar(50),     @UseNationsAsRenderingProvider varchar(50),     @DefaultClaimAmount float,     @ClaimNbr numeric,    @ClaimDtlSeqNbr numeric,    @ClaimDueDays numeric,    --@IsZeroClaim bit    @ApplyCopay bit, --- Add applyCopay    @CopyPrimaryAsSecondaryInsu bit  )  AS  BEGIN    --- Declare Constants    declare @CONST_TESTING varchar(20) = '92591'   declare @CONST_Status_Show varchar(20) = 'SHOW'   declare @CONST_Status_Checkin varchar(20) = 'CHECKIN'   declare @CONST_Status_CheckedIn varchar(20) = 'CHECKEDIN'    --- Get Testing Co_Payment required       declare @TestingCoPay numeric   select top 1  @TestingCoPay = cb.[HearingExamCoPay] FROM [Insurance].[ContractBenefits] cb   INNER JOIN [Insurance].[HealthPlanContracts] hp          on  hp.HealthPlanContractID = cb.HealthPlanContractID       and hp.InsuranceCarrierID=@InsuranceCarrierID       and hp.InsuranceHealthPlanID = @InsurancePlanID   SET @TestingCoPay = ISNULL(@TestingCoPay,@DefaultClaimAmount)    -- 1. Get Insurance Carrier ID and NHMemberID active as of that Service Date     --- RETURN TESTING CLAIM RECORD       INSERT INTO [Claims].[ClaimFiles]   select top 1 m.NHMemberID as 'NHMemberId'   --, ROW_NUMBER() over (order by m.NHMemberID)  as 'ClaimNbr'   ,@ClaimNbr as 'ClaimNbr'   , @ClaimDtlSeqNbr  as  'ClaimDtlSeqNbr'   , @NBInsuranceId as 'InsuranceID'   , UPPER(m.FirstName) as 'member_first_name'   , UPPER(m.LastName) as 'member_last_name'   , UPPER(m.MiddleInitial) as 'member_middle_initial'   , UPPER(ma.Address1)   as 'member_address1'    , UPPER(ma.Address2) as 'member_address2'   , UPPER(ma.City) as 'member_city'   , UPPER(ma.State) as 'member_state'   --, UPPER(ma.ZipCode) as 'member_zipcode' --by DPSR on 6232020   ,UPPER(ltrim(rtrim(substring(ma.ZipCode,1,5)))) as 'member_zipcode' --added by DPSR   --, isnull(mp.PhoneNbr, '9999999999') as 'member_phone_nbr' --by DPSR on 6232020   ,isnull((case when mp.PhoneNbr = 0 then null else mp.PhoneNbr end) , '9999999999') as 'member_phone_nbr' --added by DPSR   , case when m.DateOfBirth is null then null else case when CONVERT(date,  m.DateOfBirth, 102)='0001-01-01' then null else CONVERT(date,  m.DateOfBirth, 102) END END as 'member_DOB'   , m.Gender as 'member_gender'   , 'SELF'as 'relationship_txt'   , mia.[InsuranceNbr]as 'policy_number'   , mia.[GroupNbr]as 'group_number'   , isnull(mia.[MedicareNbr],'')as 'MedicareNbr'   , isnull(mia.[MedicaidNbr],'')as 'MedicaidNbr'   , CONVERT(date,  mi.InsuranceEffectiveDate, 102)  as 'effective_from_date'   , CASE WHEN CONVERT(date,  mi.InsuranceEndDate, 102) = '12/31/9999'            THEN '12/31/2099'      ELSE CONVERT(date,  mi.InsuranceEndDate, 102)      END  as'effective_to_date'   , @InsuranceCarrierName as 'InsuranceCarrierName'   , '' as 'prior_auth' -- Need clarification from Alan on what to pass here (May be PriorAuth Confirmation Code    -- Getting TEST Service Records          , CONVERT(date,  mapt.E
  CREATE PROCEDURE [Claims].[UpdateClaimfiles]  (      -- Add the parameters for the stored procedure here     @memberChartDataId  numeric,     @userName varchar(50)  )  /*  Description: This procedure will be called before calling [Claims].[GetClaimRecordMain] to de-activate previously creted records  */  AS  BEGIN      -- SET NOCOUNT ON added to prevent extra result sets from      -- interfering with SELECT statements.      SET NOCOUNT ON     UPDATE [Claims].[ClaimFiles]      set IsActive=0,ModifyUser=@userName,ModifyDate=getdate()     WHERE MemberChartDataId=@memberChartDataId  END  
create PROCEDURE [Claims].[GetHearingaidClaimRecord_BK_29JAN2020]   (      -- Add the parameters for the stored procedure here          @MinorProcessId numeric,        @MemberChartDataID numeric,    @NHMemberID varchar(50),     @ProviderId numeric,    @HCPProfileId numeric,     @NBInsuranceId varchar(50),     @InsuranceCarrierID numeric,    @InsurancePlanID numeric,    @InsuranceCarrierName varchar(100),     @CONST_NHBillingNPI varchar(50),     @CONST_NHBillingTax varchar(50),     @HCPCSCode varchar(50),     @ICD10Code varchar(50),     @PlaceofService varchar(50),    @CONST_PhoneTypeCode varchar(50),     @CONST_InsuranceType varchar(50),     @CONST_Status_Complete varchar(50),    @CONST_AddressTypeCode varchar(50),     @GroupAllServicesBy varchar(50),     @UseNationsAsBillingProvider varchar(50),     @UseNationsAsRenderingProvider varchar(50),     @DefaultClaimAmount float,     @ClaimNbr numeric,    @ClaimDtlSeqNbr numeric,    @ClaimDueDays numeric  )  AS  BEGIN    --- Declare Constants    declare @CONST_HA varchar(20) = 'HA'          INSERT INTO [Claims].[ClaimFiles]   select top 1 m.NHMemberID as 'NHMemberId'   , @ClaimNbr as 'ClaimNbr'   , @ClaimDtlSeqNbr  as  'ClaimDtlSeqNbr'   , @NBInsuranceId as 'InsuranceID'   , UPPER(m.FirstName) as 'member_first_name'   , UPPER(m.LastName) as 'member_last_name'   , UPPER(m.MiddleInitial) as 'member_middle_initial'   , UPPER(ma.Address1)   as 'member_address1'    , UPPER(ma.Address2) as 'member_address2'   , UPPER(ma.City) as 'member_city'   , UPPER(ma.State) as 'member_state'   , UPPER(ma.ZipCode) as 'member_zipcode'   , isnull(mp.PhoneNbr, '9999999999') as 'member_phone_nbr'   , case when m.DateOfBirth is null then null else case when CONVERT(date,  m.DateOfBirth, 102)='0001-01-01' then null else CONVERT(date,  m.DateOfBirth, 102) END END as 'member_DOB'   , m.Gender as 'member_gender'   , 'SELF' as 'relationship_txt'   , mia.[InsuranceNbr]as 'policy_number'   , mia.[GroupNbr]as 'group_number'   , isnull(mia.[MedicareNbr],'')as 'MedicareNbr'   , isnull(mia.[MedicaidNbr],'')as 'MedicaidNbr'   , CONVERT(date,  mi.InsuranceEffectiveDate, 102)  as 'effective_from_date'   , CONVERT(date,  mi.InsuranceEndDate, 102)  as'effective_to_date'   ,(case when  @InsuranceCarrierName is null then (select [InsuranceCarrierName] from [Insurance].[InsuranceCarriers] where [InsuranceCarrierID]=@InsuranceCarrierID) else @InsuranceCarrierName end)  as 'InsuranceCarrierName'   , '' as 'prior_auth' -- Need clarification from Alan on what to pass here (May be PriorAuth Confirmation Code    -- Getting TEST Service Records          --, cast(substring(JSON_VALUE(mcd.ProcessData, '$.orderDate'),1,10) as datetime) as 'Date_of_Service'   ,CONVERT(date,  pos.[PODate], 102) as 'Date_of_Service'   , '' as 'ReturnDate'   , concat(ordItems.ItemCode,'_',(select count(*) from orders.orderitems where itemtype=@CONST_HA and status='active' and orderid=ord.OrderID))  as 'ItemID'   , hcp.NPINumber      as 'HCPNPINumbe'   , hcp.FirstName  as 'HCPFirstName'      , hcp.LastName  as 'HCPLastName'      , pro.NPINumber  as 'OrganizationNPI'      , pro.TaxId  as 'OrganizationTaxID'   , case when @UseNationsAsBillingProvider = 1 then @CONST_NHBillingNPI  else  pro.NPINumber end as 'BillingNPI'      , case when @UseNationsAsBillingProvider = 1 then @CONST_NHBillingTax  else   pro.TaxId end as  'BillingTaxID'   , @ICD10Code as 'ICD_10_Code'   ,(select hcpcsAidCode from [catalog].[Get_HearingService_HA_Items](ordItems.ItemCode,(select count(*) from orders.orderitems where itemtype=@CONST_HA and status='active' and orderid=ord.OrderID))) as 'HCPSCode'   , 'NEW' as 'Status'   ,Claims.GetOrderAmountDataByValue(ord.OrderAmountData,'productprice',ord.BenefitsData) as 'ChargeAmount'    ,isnull(@DefaultClaimAmount,0) as 'CopayAmount'   ,Claims.GetOrderAmountDataByValue(ord.OrderAmountData,'benefitAmount',ord.BenefitsData) as 'BenefitAmount'   ,'' as 'CoInsuranceAmt'   ,'' as 'CoInsurancePercent'   ,'' as 'NonConveredAmt'   ,Claims.GetOrderAmo
    CREATE PROCEDURE [Claims].[GENERATE_PR036_4_INS14]  AS  /*  Author: Mohan Nanduri   Date  : 23 Jan 2020  Update Date: 28 Jan 2020  Description: This procedure will generates PR036 events by marking all eligible testing, hearing-id and fitting transactions   */      DECLARE @spUser varchar(20) = 'mnanduri'  DECLARE @ApplyFromDate Date = '01/01/2020'  CREATE TABLE #ClaimsData (orderId nvarchar(10),memberChartDataId bigint, dateOfService datetime, userName nvarchar(50));  TRUNCATE TABLE #ClaimsData    -- PREP: Mark all Testing Appoinments that has Order and in Schedule State         --SELECT *   UPDATE MA   SET MA.APPOINTMENTSTATUS = 'Show', MODIFYUSER = @spUser,MODIFYDATE = GETDATE()   FROM PROVIDER.MEMBERAPPOINTMENTS MA   WHERE MEMBERCHARTDATAID IN(   SELECT MEMBERCHARTDATAID FROM PROVIDER.MEMBERCHARTDATA WHERE    MinorProcessId=16 AND    MEMBERCHARTID IN (   SELECT DISTINCT MEMBERCHARTID FROM PROVIDER.MEMBERCHARTDATA WHERE MEMBERCHARTDATAID IN   (SELECT DISTINCT MEMBERCHARTDATAID FROM ORDERS.ORDERS WHERE CREATEDATE >= @ApplyFromDate AND ORDERTYPE NOT LIKE '%OTC%'))   ) AND MA.APPOINTMENTSTATUS IN ('Scheduled','ReScheduled') and MA.AppointmentTypeId in (1,7) -- (Testing)/(Consultation)     AND MA.CREATEDATE >= @ApplyFromDate      -- STEP1: Grab all 2020 testing appointments that has Show, CheckIn and Complete but doesn't has claim in the past    insert into #ClaimsData   SELECT   NULL as 'orderId',   MC.MemberChartDataId as 'memberChartDataId',   MA.StartDate as 'dateOfService',   MA.ModifyUser as 'userName'   FROM PROVIDER.MemberChartData MC   INNER JOIN PROVIDER.MemberAppointments MA ON MA.MemberChartDataId=MC.MemberChartDataId        AND  UPPER(MA.AppointmentStatus) IN ('COMPLETE','SHOW','CHECKIN','CHECKEDIN',' CHECKEDOUT')   WHERE MC.MinorProcessId IN (16) AND MC.CreateDate >= @ApplyFromDate    AND  MC.MemberChartDataId NOT IN      (SELECT DISTINCT MCD1.MemberChartDataId  FROM ACCOUNTS.InvoiceItems MCD1      INNER JOIN ACCOUNTS.Invoices MC1 ON MC1.InvoiceId=MCD1.InvoiceId AND MC1.VendorType='CLM')    -- STEP3: Grab all 2020 Hearing-Aid Orders that are not cancelled and oesn't has claim in the past   insert into #ClaimsData   SELECT distinct o.orderid as 'orderId',   o.MemberChartDataId as 'memberChartDataId',   o.[DateOrderReceived] as 'dateOfService',   ot.ModifyUser as 'userName'   FROM PROVIDER.MemberChartData MC   Inner Join orders.orders o on o.MemberChartDataId=MC.MemberChartDataId       and  o.CREATEDATE >= @ApplyFromDate       AND o.ORDERTYPE NOT LIKE '%OTC%'      and o.Status NOT IN ('CANCELLED')   inner join [Orders].[OrderTransactionDetails] ot on o.orderid=ot.orderid AND UPPER(ot.[OrderStatusCode]) = 'APP'   WHERE MC.MinorProcessId IN (23) AND MC.CreateDate >= @ApplyFromDate   AND  MC.MemberChartDataId NOT IN      (SELECT DISTINCT MCD1.MemberChartDataId  FROM ACCOUNTS.InvoiceItems MCD1      INNER JOIN ACCOUNTS.Invoices MC1 ON MC1.InvoiceId=MCD1.InvoiceId AND MC1.VendorType='CLM')    -- STEP4: Grab all 2020 Fitting appointments that are marked as and Complete but doesn't has claim in the past    insert into #ClaimsData   SELECT   NULL as 'orderId',   MC.MemberChartDataId as 'memberChartDataId',   MA.StartDate as 'dateOfService',   MA.ModifyUser as 'userName'   FROM PROVIDER.MemberChartData MC   INNER JOIN PROVIDER.MemberAppointments MA ON MA.MemberChartDataId=MC.MemberChartDataId        AND  UPPER(MA.AppointmentStatus) IN ('COMPLETE')   WHERE MC.MinorProcessId IN (25) AND MC.CreateDate >= @ApplyFromDate   AND  MC.MemberChartDataId NOT IN      (SELECT DISTINCT MCD1.MemberChartDataId  FROM ACCOUNTS.InvoiceItems MCD1      INNER JOIN ACCOUNTS.Invoices MC1 ON MC1.InvoiceId=MCD1.InvoiceId AND MC1.VendorType='CLM')        --  STEP - TEMP Keep only HealthFirst Records - Need to remove this after PROD test     delete from #ClaimsData where memberChartDataId NOT in    (   select distinct memberChartDataId from provider.MemberChartData where MemberChartId in    (      select distinct MemberChartId  from provider.MemberC
CREATE PROCEDURE [Claims].[GetClaimRecordMain] --308549  (     @MemberChartDataID numeric,     @ClaimNbr numeric = 0,     @ClaimDtlSeqNbr numeric = 0  )  AS  BEGIN    --- Declare Constants       declare @CONST_NHBillingNPI varchar(20) = '1871042317' -- TBD   declare @CONST_NHBillingTax varchar(20) = '474660944' -- TBD   declare @CONST_AddressTypeCode  varchar(20) = 'PERM'   declare @CONST_PhoneTypeCode    varchar(20) = 'HOME'   declare @CONST_InsuranceType    varchar(20) = 'PRIMARY'   --declare @CONST_AppointmentStatus      varchar(20) = 'Complete'   declare @CONST_Status_Complete varchar(20) = 'COMPLETE'   declare @CONST_Status_Show varchar(20) = 'SHOW'   declare @CONST_Status_Checkin varchar(20) = 'CHECKIN' --Added Raj      declare @CONST_Status_CheckedIn varchar(20) = 'CHECKEDIN'   declare @CONST_TESTING_MINORSTEP numeric = 16   declare @CONST_FITTING_MINORSTEP numeric = 25   declare @CONST_HA_MINORSTEP      numeric = 23   declare @CONST_CLAIM_SPLIT varchar(10) = 'SPLIT'   declare @CONST_CLAIM_SINGLE varchar(10) = 'SINGLE'   declare @MemberChartDataIdTesting numeric = 0   declare @MemberChartDataIdFitting numeric = 0   declare @MemberChartDataIdHearing numeric = 0   declare @ClaimDueDays numeric = 0   declare @memberId numeric = 0   declare @ServiceDate date    --- Input Validation - Check if given MemberChart Data Id is exists       declare @MinorProcessId numeric       select @MinorProcessId = mcd.MinorProcessId    from provider.MemberChartData mcd         --inner join provider.MemberAppointments mapt on mapt.MemberChartDataId =  mcd.MemberChartDataId and UPPER(mapt.AppointmentStatus)= @CONST_AppointmentStatus   where mcd.MemberChartDataId=@MemberChartDataID  -- and mcd.IsComplete=1      -- Check if the chartId belongs either testing/ha or fitting   IF @MinorProcessId <> @CONST_TESTING_MINORSTEP AND @MinorProcessId <> @CONST_FITTING_MINORSTEP and @MinorProcessId <> @CONST_HA_MINORSTEP   BEGIN      select 'Invalid MemberChartDataID ['+ @MemberChartDataID +'] Or MemberChartDataID step is NOT Complete Or Appoinment is NOT marked a Complete' AS 'ERROR'      return   END    IF @MinorProcessId <> @CONST_HA_MINORSTEP   BEGIN       -- Check if Test OR Fitting Appointments marked a close       declare @IsAppointmentClosed bit       select @IsAppointmentClosed = 1 from provider.MemberAppointments mapt where mapt.MemberChartDataId =  @MemberChartDataID      and (UPPER(mapt.AppointmentStatus)= @CONST_Status_Show       OR UPPER(mapt.AppointmentStatus)= @CONST_Status_Complete       OR UPPER(mapt.AppointmentStatus)= @CONST_Status_Checkin )     --and UPPER(mapt.AppointmentStatus)= @CONST_AppointmentStatus       IF @IsAppointmentClosed <> 1       BEGIN      select 'MemberChartDataID ['+@MemberChartDataID +']Appoinment is NOT marked a Complete' AS 'ERROR'     return      END     END     -- 1. Get Insurance Carrier ID and NHMemberID active as of that Service Date       declare @InsuranceCarrierName varchar(100)   declare @InsuranceCarrierID numeric   declare @InsuranceHealthPlanID numeric    declare @NHMemberID varchar(25)   declare @MemberProfileId numeric    declare @HCPProfileId numeric    declare @ProviderId numeric    declare @HCPCSCode varchar(50)   declare @ICD10Code varchar(50)   --PRINT @MinorProcessId     IF @MinorProcessId = @CONST_FITTING_MINORSTEP    begin        SET @MemberChartDataIdFitting = @MemberChartDataID     select  top 1       @InsuranceCarrierName = case    when CAST(JSON_VALUE(mcd.ProcessData, '$.InsuranceCarrierName') as NVARCHAR(50)) IS NULL               then ic.InsuranceCarrierName              else JSON_VALUE(mcd.ProcessData, '$.InsuranceCarrierName') end,         @InsuranceCarrierID =   case    when CAST(JSON_VALUE(mcd.ProcessData, '$.InsuranceCarrierId') as NVARCHAR(50)) IS NULL               then ic.InsuranceCarrierID              else JSON_VALUE(mcd.ProcessData, '$.InsuranceCarrierId') end,          @InsuranceHealthPlanID =   case when CAST(JSON_VALUE(mcd.ProcessData, '$.PlanId') as NVARCHAR(50)) IS NULL   
    CREATE PROCEDURE [Claims].[GENERATE_PR036]  AS  /*  Author: Mohan Nanduri   Date  : 23 Jan 2020  Update Date: 28 Jan 2020  Description: This procedure will generates PR036 events by marking all eligible testing, hearing-id and fitting transactions                Mohan Feb 20 : Updated with IsActive and ServiceDates <= GetDate()    */      DECLARE @spUser varchar(20) = 'mnanduri'  DECLARE @ApplyFromDate Date = '01/01/2020'  CREATE TABLE #ClaimsData (orderId nvarchar(10),memberChartDataId bigint, dateOfService datetime, userName nvarchar(50));  TRUNCATE TABLE #ClaimsData    -- PREP: Mark all Testing Appoinments that has Order and in Schedule State   -- [Mohan 3/17/2020] Decided to not to auto set appointments as show     /*   UPDATE MA   SET MA.APPOINTMENTSTATUS = 'Show', MODIFYUSER = @spUser,MODIFYDATE = GETDATE()   FROM PROVIDER.MEMBERAPPOINTMENTS MA   WHERE IsActive=1 AND MEMBERCHARTDATAID IN(    SELECT MEMBERCHARTDATAID FROM PROVIDER.MEMBERCHARTDATA WHERE IsActive=1 AND     MinorProcessId=16 AND     MEMBERCHARTID IN (     SELECT DISTINCT MEMBERCHARTID FROM PROVIDER.MEMBERCHARTDATA WHERE IsActive=1 AND MEMBERCHARTDATAID IN     (        SELECT DISTINCT MEMBERCHARTDATAID FROM ORDERS.ORDERS WHERE IsActive=1 AND CREATEDATE >= @ApplyFromDate AND ORDERTYPE NOT IN ('OTC','EXCHANGE')     )    )   )   AND MA.APPOINTMENTSTATUS IN ('Scheduled','ReScheduled') and MA.AppointmentTypeId in (1,7) -- (Testing)/(Consultation)   AND MA.EndDate >= @ApplyFromDate and MA.EndDate <= GETDATE()    */    -- STEP1: Grab all 2020 testing appointments that has Show, CheckIn and Complete but doesn't has claim in the past    insert into #ClaimsData   SELECT   NULL as 'orderId',   MC.MemberChartDataId as 'memberChartDataId',   MA.StartDate as 'dateOfService',   MA.ModifyUser as 'userName'   FROM PROVIDER.MemberChartData MC   INNER JOIN PROVIDER.MemberAppointments MA ON MA.IsActive=1 AND MA.MemberChartDataId=MC.MemberChartDataId        AND  UPPER(MA.AppointmentStatus) IN ('COMPLETE','SHOW','CHECKIN','CHECKEDIN',' CHECKEDOUT')        AND MA.EndDate >= @ApplyFromDate and MA.EndDate <= GETDATE()     WHERE MC.IsActive=1 AND  MC.MinorProcessId IN (16) AND MC.CreateDate >= @ApplyFromDate     AND  MC.MemberChartDataId NOT IN      (SELECT DISTINCT MCD1.MemberChartDataId  FROM ACCOUNTS.InvoiceItems MCD1      INNER JOIN ACCOUNTS.Invoices MC1 ON MC1.IsActive=1 AND MC1.InvoiceId=MCD1.InvoiceId AND MC1.VendorType='CLM')    -- STEP3: Grab all 2020 Hearing-Aid Orders that are not cancelled and oesn't has claim in the past   insert into #ClaimsData   SELECT distinct o.orderid as 'orderId',   o.MemberChartDataId as 'memberChartDataId',   o.[DateOrderReceived] as 'dateOfService',   ot.ModifyUser as 'userName'   FROM PROVIDER.MemberChartData MC   Inner Join orders.orders o on o.IsActive=1 and o.MemberChartDataId=MC.MemberChartDataId       and  o.CREATEDATE >= @ApplyFromDate       AND o.ORDERTYPE NOT IN ('OTC','EXCHANGE') -- Phase 2 to process EXCHANGES      and o.Status IN ('ACTIVE') -- Phase to Process RETURNED and CANCELLED   inner join [Orders].[OrderTransactionDetails] ot on o.IsActive=1 and o.orderid=ot.orderid AND UPPER(ot.[OrderStatusCode]) = 'APP'   WHERE MC.IsActive=1 and MC.MinorProcessId IN (23) AND MC.CreateDate >= @ApplyFromDate   AND  MC.MemberChartDataId NOT IN      (SELECT DISTINCT MCD1.MemberChartDataId  FROM ACCOUNTS.InvoiceItems MCD1      INNER JOIN ACCOUNTS.Invoices MC1 ON MC1.InvoiceId=MCD1.InvoiceId AND MC1.VendorType='CLM' and MC1.IsActive=1)    -- STEP4: Grab all 2020 Fitting appointments that are marked as and Complete but doesn't has claim in the past    insert into #ClaimsData   SELECT   NULL as 'orderId',   MC.MemberChartDataId as 'memberChartDataId',   MA.StartDate as 'dateOfService',   MA.ModifyUser as 'userName'   FROM PROVIDER.MemberChartData MC   INNER JOIN PROVIDER.MemberAppointments MA ON MA.IsActive=1 and MA.MemberChartDataId=MC.MemberChartDataId        AND  UPPER(MA.AppointmentStatus) IN ('COMPLETE')        AND  MA.EndDate >= @ApplyFrom
CREATE FUNCTION  [Claims].[GetOrderAmountDataByValue]   (      -- Add the parameters for the function here   @OrderAmountData nvarchar(4000),   @returnAmountType nvarchar(200),   @BenefitsData nvarchar(4000)  )  RETURNS numeric  AS  BEGIN      declare @BenefitDetails nvarchar(20)     set @BenefitDetails = case when @BenefitsData is null then null else ( convert(numeric(18,0),ISNULL(JSON_VALUE(@BenefitsData, '$.benefitAppliedAmount') ,0)) ) end     declare @Price numeric     set @Price = case when JSON_VALUE(@OrderAmountData, '$.productPriceDetails.originalPrice') is null then convert(numeric(18,0),ISNULL(JSON_VALUE(@OrderAmountData, '$.productPrice'),0)) else convert(numeric(18,0),ISNULL(JSON_VALUE(@OrderAmountData, '$.productPriceDetails.originalPrice'),0)) end;    declare @medicaidBenefit numeric     set @medicaidBenefit = case when JSON_VALUE(@OrderAmountData, '$.productPriceDetails.originalPrice') is null then convert(numeric(18,0),ISNULL(JSON_VALUE(@OrderAmountData, '$.medicaidBenefit'),0)) else convert(numeric(18,0),ISNULL(JSON_VALUE(@OrderAmountData, '$.medicaidBenefit'),0)) end;    declare @benefitAvl numeric     set @benefitAvl = case when JSON_VALUE(@OrderAmountData, '$.productPriceDetails.originalPrice') is null then convert(numeric(18,0),ISNULL(JSON_VALUE(@OrderAmountData, '$.benefitAvailable'),0)) else convert(numeric(18,0),ISNULL(JSON_VALUE(@OrderAmountData, '$.benefitAvailable'),0)) end;    declare @memRes numeric     set @memRes = case when JSON_VALUE(@OrderAmountData, '$.productPriceDetails.originalPrice') is null then convert(numeric(18,0),ISNULL(JSON_VALUE(@OrderAmountData, '$.memberResponsibility'),0)) else convert(numeric(18,0),ISNULL(JSON_VALUE(@OrderAmountData, '$.memberResponsibility'),0)) end;    declare @benefitsused numeric     set @benefitsused = case when JSON_VALUE(@OrderAmountData, '$.productPriceDetails.originalPrice') is null then convert(numeric(18,0),ISNULL(JSON_VALUE(@OrderAmountData, '$.benefitUsed'),0)) else convert(numeric(18,0),ISNULL(JSON_VALUE(@OrderAmountData, '$.benefitUsed'),0)) end;    declare @returnAmount numeric = 0        IF(LOWER(@returnAmountType) ='productprice')    BEGIN     set @returnAmount =  @Price;    END    ELSE IF(LOWER(@returnAmountType) ='benefitAmount')    BEGIN         set @returnAmount = (case when @BenefitDetails is null then case when @medicaidBenefit is not null and @medicaidBenefit > 0   then @medicaidBenefit      else case when  @Price >= @benefitAvl then @benefitAvl      else @Price end  end  else @BenefitDetails end)         END    ELSE IF(LOWER(@returnAmountType) ='benefitused')    BEGIN     set @returnAmount = @benefitsused;    END    ELSE IF(LOWER(@returnAmountType) ='benefitavailable')    BEGIN     set @returnAmount = @benefitAvl;    END    ELSE IF(LOWER(@returnAmountType) ='medicaidbenefit')    BEGIN     set @returnAmount = @medicaidBenefit;    END    ELSE IF(LOWER(@returnAmountType) ='memberresponsibility')    begin     set @returnAmount = @memRes;    end    ELSE IF(LOWER(@returnAmountType) ='unitprice')    begin     set @returnAmount = convert(numeric(18,0),ISNULL( JSON_VALUE(@OrderAmountData, '$.unitPrice') ,0));    end    ELSE IF(LOWER(@returnAmountType) ='pairprice')    begin     set @returnAmount = convert(numeric(18,0),ISNULL(JSON_VALUE(@OrderAmountData, '$.pairPrice'),0));    end    ELSE IF(LOWER(@returnAmountType) ='forwardcredits')    begin     set @returnAmount = convert(numeric(18,0),ISNULL(JSON_VALUE(@OrderAmountData, '$.forwardCredits'),0));     end      return @returnAmount;  END  
  -- exec [Claims].[GENERATE_PR036_TEST]    CREATE PROCEDURE [Claims].[GENERATE_PR036_TEST]  AS  /*  Author: Mohan Nanduri   Date  : 23 Jan 2020  Description: This procedure will generates PR036 events by marking all eligible testing, hearing-id and fitting transactions   */      DECLARE @spUser varchar(20) = 'sdaggubati'  DECLARE @ApplyFromDate Date = '01/01/2020'  CREATE TABLE #ClaimsData (orderId nvarchar(10),memberChartDataId bigint, dateOfService datetime, userName nvarchar(50));  TRUNCATE TABLE #ClaimsData    -- PREP: Mark all Testing Appoinments that has Order and in Schedule State         --SELECT *   UPDATE MA   SET MA.APPOINTMENTSTATUS = 'Show', MODIFYUSER = @spUser,MODIFYDATE = GETDATE()   FROM PROVIDER.MEMBERAPPOINTMENTS MA   WHERE MEMBERCHARTDATAID IN(   SELECT MEMBERCHARTDATAID FROM PROVIDER.MEMBERCHARTDATA WHERE    MinorProcessId=16 AND    MEMBERCHARTID IN (   SELECT DISTINCT MEMBERCHARTID FROM PROVIDER.MEMBERCHARTDATA WHERE MEMBERCHARTDATAID IN   (SELECT DISTINCT MEMBERCHARTDATAID FROM ORDERS.ORDERS WHERE CREATEDATE >= @ApplyFromDate AND ORDERTYPE NOT LIKE '%OTC%'))   ) AND MA.APPOINTMENTSTATUS IN ('Scheduled') and MA.AppointmentTypeId=1 -- (Testing)      AND MA.CREATEDATE >= @ApplyFromDate      -- STEP1: Grab all 2020 testing appointments that has Show, CheckIn and Complete but doesn't has claim in the past    insert into #ClaimsData   SELECT   NULL as 'orderId',   MC.MemberChartDataId as 'memberChartDataId',   MA.StartDate as 'dateOfService',   MA.ModifyUser as 'userName'   FROM PROVIDER.MemberChartData MC   INNER JOIN PROVIDER.MemberAppointments MA ON MA.MemberChartDataId=MC.MemberChartDataId        AND  UPPER(MA.AppointmentStatus) IN ('COMPLETE','SHOW','CHECKIN')   WHERE MC.MinorProcessId IN (16) AND MC.CreateDate >= @ApplyFromDate    --AND  MC.MemberChartDataId NOT IN    --  (SELECT DISTINCT MCD1.MemberChartDataId  FROM ACCOUNTS.InvoiceItems MCD1   --   INNER JOIN ACCOUNTS.Invoices MC1 ON MC1.InvoiceId=MCD1.InvoiceId AND MC1.VendorType='CLM')        -- STEP3: Grab all 2020 Hearing-Aid Orders that are not cancelled and doesn't has claim in the past   insert into #ClaimsData   SELECT distinct o.orderid as 'orderId',   o.MemberChartDataId as 'memberChartDataId',   o.[DateOrderReceived] as 'dateOfService',   ot.ModifyUser as 'userName'   FROM PROVIDER.MemberChartData MC   Inner Join orders.orders o on o.MemberChartDataId=MC.MemberChartDataId       and  o.CREATEDATE >= @ApplyFromDate       AND o.ORDERTYPE NOT LIKE '%OTC%'      and o.Status NOT IN ('CANCELLED')   inner join [Orders].[OrderTransactionDetails] ot on o.orderid=ot.orderid AND UPPER(ot.[OrderStatusCode]) = 'APP'   WHERE MC.MinorProcessId IN (23) AND MC.CreateDate >= @ApplyFromDate   --AND  MC.MemberChartDataId NOT IN    --  (SELECT DISTINCT MCD1.MemberChartDataId  FROM ACCOUNTS.InvoiceItems MCD1   --   INNER JOIN ACCOUNTS.Invoices MC1 ON MC1.InvoiceId=MCD1.InvoiceId AND MC1.VendorType='CLM')    -- STEP4: Grab all 2020 Fitting appointments that are marked as and Complete but doesn't has claim in the past    insert into #ClaimsData   SELECT   NULL as 'orderId',   MC.MemberChartDataId as 'memberChartDataId',   MA.StartDate as 'dateOfService',   MA.ModifyUser as 'userName'   FROM PROVIDER.MemberChartData MC   INNER JOIN PROVIDER.MemberAppointments MA ON MA.MemberChartDataId=MC.MemberChartDataId        AND  UPPER(MA.AppointmentStatus) IN ('COMPLETE')   WHERE MC.MinorProcessId IN (25) AND MC.CreateDate >= @ApplyFromDate   --AND  MC.MemberChartDataId NOT IN    --  (SELECT DISTINCT MCD1.MemberChartDataId  FROM ACCOUNTS.InvoiceItems MCD1   --   INNER JOIN ACCOUNTS.Invoices MC1 ON MC1.InvoiceId=MCD1.InvoiceId AND MC1.VendorType='CLM')        ----  STEP - TEMP Keep only HealthFirst Records - Need to remove this after PROD test    -- delete from #ClaimsData where memberChartDataId NOT in   -- (  -- select distinct memberChartDataId from provider.MemberChartData where MemberChartId in   -- (  --    select distinct MemberChartId  from provider.MemberCharts where M
    create PROCEDURE [Claims].[GENERATE_PR036_bkp_20200330_before_HF]  AS  /*  Author: Mohan Nanduri   Date  : 23 Jan 2020  Update Date: 28 Jan 2020  Description: This procedure will generates PR036 events by marking all eligible testing, hearing-id and fitting transactions                Mohan Feb 20 : Updated with IsActive and ServiceDates <= GetDate()    */      DECLARE @spUser varchar(20) = 'mnanduri'  DECLARE @ApplyFromDate Date = '01/01/2020'  CREATE TABLE #ClaimsData (orderId nvarchar(10),memberChartDataId bigint, dateOfService datetime, userName nvarchar(50));  TRUNCATE TABLE #ClaimsData    -- PREP: Mark all Testing Appoinments that has Order and in Schedule State   -- [Mohan 3/17/2020] Decided to not to auto set appointments as show     /*   UPDATE MA   SET MA.APPOINTMENTSTATUS = 'Show', MODIFYUSER = @spUser,MODIFYDATE = GETDATE()   FROM PROVIDER.MEMBERAPPOINTMENTS MA   WHERE IsActive=1 AND MEMBERCHARTDATAID IN(    SELECT MEMBERCHARTDATAID FROM PROVIDER.MEMBERCHARTDATA WHERE IsActive=1 AND     MinorProcessId=16 AND     MEMBERCHARTID IN (     SELECT DISTINCT MEMBERCHARTID FROM PROVIDER.MEMBERCHARTDATA WHERE IsActive=1 AND MEMBERCHARTDATAID IN     (        SELECT DISTINCT MEMBERCHARTDATAID FROM ORDERS.ORDERS WHERE IsActive=1 AND CREATEDATE >= @ApplyFromDate AND ORDERTYPE NOT IN ('OTC','EXCHANGE')     )    )   )   AND MA.APPOINTMENTSTATUS IN ('Scheduled','ReScheduled') and MA.AppointmentTypeId in (1,7) -- (Testing)/(Consultation)   AND MA.EndDate >= @ApplyFromDate and MA.EndDate <= GETDATE()    */    -- STEP1: Grab all 2020 testing appointments that has Show, CheckIn and Complete but doesn't has claim in the past    insert into #ClaimsData   SELECT   NULL as 'orderId',   MC.MemberChartDataId as 'memberChartDataId',   MA.StartDate as 'dateOfService',   MA.ModifyUser as 'userName'   FROM PROVIDER.MemberChartData MC   INNER JOIN PROVIDER.MemberAppointments MA ON MA.IsActive=1 AND MA.MemberChartDataId=MC.MemberChartDataId        AND  UPPER(MA.AppointmentStatus) IN ('COMPLETE','SHOW','CHECKIN','CHECKEDIN',' CHECKEDOUT')        AND MA.EndDate >= @ApplyFromDate and MA.EndDate <= GETDATE()     WHERE MC.IsActive=1 AND  MC.MinorProcessId IN (16) AND MC.CreateDate >= @ApplyFromDate     AND  MC.MemberChartDataId NOT IN      (SELECT DISTINCT MCD1.MemberChartDataId  FROM ACCOUNTS.InvoiceItems MCD1      INNER JOIN ACCOUNTS.Invoices MC1 ON MC1.IsActive=1 AND MC1.InvoiceId=MCD1.InvoiceId AND MC1.VendorType='CLM')    -- STEP3: Grab all 2020 Hearing-Aid Orders that are not cancelled and oesn't has claim in the past   insert into #ClaimsData   SELECT distinct o.orderid as 'orderId',   o.MemberChartDataId as 'memberChartDataId',   o.[DateOrderReceived] as 'dateOfService',   ot.ModifyUser as 'userName'   FROM PROVIDER.MemberChartData MC   Inner Join orders.orders o on o.IsActive=1 and o.MemberChartDataId=MC.MemberChartDataId       and  o.CREATEDATE >= @ApplyFromDate       AND o.ORDERTYPE NOT IN ('OTC','EXCHANGE') -- Phase 2 to process EXCHANGES      and o.Status IN ('ACTIVE') -- Phase to Process RETURNED and CANCELLED   inner join [Orders].[OrderTransactionDetails] ot on o.IsActive=1 and o.orderid=ot.orderid AND UPPER(ot.[OrderStatusCode]) = 'APP'   WHERE MC.IsActive=1 and MC.MinorProcessId IN (23) AND MC.CreateDate >= @ApplyFromDate   AND  MC.MemberChartDataId NOT IN      (SELECT DISTINCT MCD1.MemberChartDataId  FROM ACCOUNTS.InvoiceItems MCD1      INNER JOIN ACCOUNTS.Invoices MC1 ON MC1.InvoiceId=MCD1.InvoiceId AND MC1.VendorType='CLM' and MC1.IsActive=1)    -- STEP4: Grab all 2020 Fitting appointments that are marked as and Complete but doesn't has claim in the past    insert into #ClaimsData   SELECT   NULL as 'orderId',   MC.MemberChartDataId as 'memberChartDataId',   MA.StartDate as 'dateOfService',   MA.ModifyUser as 'userName'   FROM PROVIDER.MemberChartData MC   INNER JOIN PROVIDER.MemberAppointments MA ON MA.IsActive=1 and MA.MemberChartDataId=MC.MemberChartDataId        AND  UPPER(MA.AppointmentStatus) IN ('COMPLETE')        AND  M
  /*   [Mohan Update 14 Feb 2020 : Fixed CROS issues   [Mohan 2/20/2020, Per Dianne set HCPNPI if OrgNPI is null   [Mohan 3/9/2020   Added a logic to retuen only credentialed HCP data by chekcing [provider].[HCPProviderProfile] where isActive=1  */     CREATE PROCEDURE [Claims].[GetHearingaidClaimRecord_bkp_20200330_before_HF]   (      -- Add the parameters for the stored procedure here          @MinorProcessId numeric,        @MemberChartDataID numeric,    @NHMemberID varchar(50),     @ProviderId numeric,    @HCPProfileId numeric,     @NBInsuranceId varchar(50),     @InsuranceCarrierID numeric,    @InsurancePlanID numeric,    @InsuranceCarrierName varchar(100),     @CONST_NHBillingNPI varchar(50),     @CONST_NHBillingTax varchar(50),     @HCPCSCode varchar(50),     @ICD10Code varchar(50),     @PlaceofService varchar(50),    @CONST_PhoneTypeCode varchar(50),     @CONST_InsuranceType varchar(50),     @CONST_Status_Complete varchar(50),    @CONST_AddressTypeCode varchar(50),     @GroupAllServicesBy varchar(50),     @UseNationsAsBillingProvider varchar(50),     @UseNationsAsRenderingProvider varchar(50),     @DefaultClaimAmount float,     @ClaimNbr numeric,    @ClaimDtlSeqNbr numeric,    @ClaimDueDays numeric,       @ApplyCopay bit,    @CopyPrimaryAsSecondaryInsu bit  )  AS  BEGIN    --- Declare Constants    declare @CONST_HA varchar(20) = 'HA'    declare @CONST_CROS varchar(20) = 'CROS'    --- Get HearingAid Co_Payment required       declare @HACoPay numeric   select top 1  @HACoPay = cb.HearingAidCoPay FROM [Insurance].[ContractBenefits] cb   INNER JOIN [Insurance].[HealthPlanContracts] hp          on  hp.HealthPlanContractID = cb.HealthPlanContractID       and hp.InsuranceCarrierID=@InsuranceCarrierID       and hp.InsuranceHealthPlanID = @InsurancePlanID   SET @HACoPay = ISNULL(@HACoPay,@DefaultClaimAmount)           INSERT INTO [Claims].[ClaimFiles]   select top 1 m.NHMemberID as 'NHMemberId'   , @ClaimNbr as 'ClaimNbr'   , @ClaimDtlSeqNbr  as  'ClaimDtlSeqNbr'   , @NBInsuranceId as 'InsuranceID'   , UPPER(m.FirstName) as 'member_first_name'   , UPPER(m.LastName) as 'member_last_name'   , UPPER(m.MiddleInitial) as 'member_middle_initial'   , UPPER(ma.Address1)   as 'member_address1'    , UPPER(ma.Address2) as 'member_address2'   , UPPER(ma.City) as 'member_city'   , UPPER(ma.State) as 'member_state'   , UPPER(ma.ZipCode) as 'member_zipcode'   , isnull(mp.PhoneNbr, '9999999999') as 'member_phone_nbr'   , case when m.DateOfBirth is null then null else case when CONVERT(date,  m.DateOfBirth, 102)='0001-01-01' then null else CONVERT(date,  m.DateOfBirth, 102) END END as 'member_DOB'   , m.Gender as 'member_gender'   , 'SELF' as 'relationship_txt'   , mia.[InsuranceNbr]as 'policy_number'   , mia.[GroupNbr]as 'group_number'   , isnull(mia.[MedicareNbr],'')as 'MedicareNbr'   , isnull(mia.[MedicaidNbr],'')as 'MedicaidNbr'   , CONVERT(date,  mi.InsuranceEffectiveDate, 102)  as 'effective_from_date'   , CASE WHEN CONVERT(date,  mi.InsuranceEndDate, 102) = '12/31/9999'            THEN '12/31/2099'      ELSE CONVERT(date,  mi.InsuranceEndDate, 102)      END  as'effective_to_date'   ,(case when  @InsuranceCarrierName is null then (select [InsuranceCarrierName] from [Insurance].[InsuranceCarriers] where [InsuranceCarrierID]=@InsuranceCarrierID) else @InsuranceCarrierName end)  as 'InsuranceCarrierName'   , '' as 'prior_auth' -- Need clarification from Alan on what to pass here (May be PriorAuth Confirmation Code    -- Getting TEST Service Records          --, cast(substring(JSON_VALUE(mcd.ProcessData, '$.orderDate'),1,10) as datetime) as 'Date_of_Service'   ,CONVERT(date,  pos.[PODate], 102) as 'Date_of_Service'   , '' as 'ReturnDate'   , concat(ordItems.ItemCode,'_',(select count(*) from orders.orderitems where itemtype in (@CONST_HA,@CONST_CROS) and status='active' and orderid=ord.OrderID))  as 'ItemID'      -- NPI Fixes by Mohan on 1/29/2020    -- 3/9/2020 - MOdified to return HCP data directly from HCPProviderProfiles    --,JSON_VALUE(
  /*  Mohan deployed to Production on 12 May 2020  */  CREATE proc [Claims].[GetNewClaimsReport]  as   begin    select Vendorrefid as InsuranceCarrierId,format(i.createdate,'MM-dd-yyyy') as CreateDate,json_value(vendordata,'$.insuranceCarrierName')InsuranceCarrierName,count(*) TotalClaims  ,(select count(*) from accounts.invoices cross apply openjson(vendordata,'$.itemData') with (serviceType nvarchar(100))j where InvoiceId in (select value from openjson(concat('[',string_agg(cast(i.InvoiceId as nvarchar(max)),','), ']')) with (value bigint '$')) and j.serviceType='testing') [TestingClaims]  ,(select count(*) from accounts.invoices cross apply openjson(vendordata,'$.itemData') with (serviceType nvarchar(100))j where InvoiceId in (select value from openjson(concat('[',string_agg(cast(i.InvoiceId as nvarchar(max)),','), ']')) with (value bigint '$')) and j.serviceType='fitting') [FittingClaims]  ,(select count(*) from accounts.invoices cross apply openjson(vendordata,'$.itemData') with (serviceType nvarchar(100))j where InvoiceId in (select value from openjson(concat('[',string_agg(cast(i.InvoiceId as nvarchar(max)),','), ']')) with (value bigint '$')) and j.serviceType='ha') [HAClaims]  ,(select isnull(count(*),0) from accounts.invoices b where InvoiceId in (select value from openjson(concat('[',string_agg(cast(i.InvoiceId as nvarchar(max)),','), ']')) with (value bigint '$')) and (b.remarks='' or b.remarks is null))GoodClaims  ,(select isnull(count(*),0)  from accounts.invoices b where InvoiceId in (select value from openjson(concat('[',string_agg(cast(i.InvoiceId as nvarchar(max)),','), ']')) with (value bigint '$')) and b.remarks !='' and b.remarks is not null)BadClaims   from accounts.invoices i  where vendortype='clm' and isactive=1 and i.[status] in ('initiated')   and convert(date,createdate)=convert(date,getdate())  group by vendorrefid,json_value(vendordata,'$.insuranceCarrierName'),format(i.createdate,'MM-dd-yyyy')  order by json_value(vendordata,'$.insuranceCarrierName')    end  
   /*  Mohan deployed to Production on 12 May 2020  */     CREATE PROCEDURE [Claims].[GetClaimFilesGeneratedReport]   AS    BEGIN    SELECT [InsuranceCarrierId],[InsuranceCarrierName],[EligibleClaimsCount],[IsCSVGenerated],p.[FileID]    ,format([CSVGeneratedDate],'dd-MM-yyyy')CSVGeneratedDate,f.FileName     from Claims.PayerCSVFileGenerationHistory p    join sftp.files f on f.fileid=p.fileid and p.isactive=1     where convert(date,p.CSVGeneratedDate) = convert(date,getdate())   END
CREATE function [dbo].[getunitPriceofItem]  (      @PODate date,   @itemcode nvarchar(50),   @IsMedicaid int,   @InsuranceCarrierName nvarchar(50)        ) returns nvarchar(50)  as  BEGIN       Declare @UnitPrice as nvarchar(50);     Declare @AnthemUnitPrice as nvarchar(50);     Declare @MedicaidUnitPrice as nvarchar(50);     Declare @StandardUnitPrice as nvarchar(50);     Declare @MedicaidPerson as varchar(10);     Declare @StandardPerson as varchar(10);     Declare @AnthemPerson as varchar(10);     Declare @AnthemandMedicaidPerson as varchar(10);        Declare @AnthemUnitPricefinal as DECIMAL(18,2);     Declare @MedicaidUnitPricefinal as DECIMAL(18,2);     Declare @StandardUnitPricefinal as DECIMAL(18,2);       set @MedicaidPerson = 'NO';     set @StandardPerson = 'NO';     set @AnthemPerson = 'NO';     set @AnthemandMedicaidPerson = 'NO';                Declare @BrandCode as nvarchar(50);       set @BrandCode = (select top 1 BrandCode from catalog.ItemMasterList where ItemCode = @itemcode);       if (lTRIM(RTRIM(@BrandCode)) = 'STARKEY')       BEGIN     set @UnitPrice = (select top 1 [UnitCOGS] from [catalog].[ItemMasterPriceList] where [EffectiveFrom]<= @PODate and [EffectiveTo] > @PODate and IsActive=1 and ItemCode=@itemcode and PriceType = 'Standard')     return @UnitPrice;     END     ELSE   if ((lTRIM(RTRIM(@BrandCode)) = 'SONOVA') OR (lTRIM(RTRIM(@BrandCode)) = 'PHONAK') OR (lTRIM(RTRIM(@BrandCode)) = 'UNITRON') )       BEGIN     set @UnitPrice = (select top 1 [UnitCOGS] from [catalog].[ItemMasterPriceList] where [EffectiveFrom]<= @PODate and [EffectiveTo] > @PODate and IsActive=1 and ItemCode=@itemcode and PriceType = 'Standard')     return @UnitPrice;     END     ELSE       BEGIN              set @AnthemUnitPrice = (select top 1 [UnitCOGS] from [catalog].[ItemMasterPriceList] where [EffectiveFrom]<= @PODate and [EffectiveTo] > @PODate and IsActive=1 and ItemCode=@itemcode and PriceType = 'Anthem')     set @StandardUnitPrice = (select top 1 [UnitCOGS] from [catalog].[ItemMasterPriceList] where [EffectiveFrom]<= @PODate and [EffectiveTo] > @PODate and IsActive=1 and ItemCode=@itemcode and PriceType = 'Standard')     set @MedicaidUnitPrice = (select top 1 [UnitCOGS] from [catalog].[ItemMasterPriceList] where [EffectiveFrom]<= @PODate and [EffectiveTo] > @PODate and IsActive=1 and ItemCode=@itemcode and PriceType = 'Medicaid')            if(@IsMedicaid=1)    BEGIN    set @MedicaidPerson = 'YES';    END           set @AnthemPerson = (case when (@InsuranceCarrierName like 'Anthem%' and @InsuranceCarrierName like '%Funded%') then 'YES'  else 'NO' end) ;          if((@MedicaidPerson = 'YES') AND (@AnthemPerson = 'YES'))       BEGIN     set @AnthemandMedicaidPerson = 'NO';     set @AnthemPerson = 'NO';         END        if ((@MedicaidUnitPrice is not null) AND (@MedicaidUnitPrice <> ''))      BEGIN             set @MedicaidUnitPricefinal = (Select CONVERT(DECIMAL(18,2),replace(@MedicaidUnitPrice, ',', '')) );           END           if ((@AnthemUnitPrice is not null) AND (@AnthemUnitPrice <> ''))      BEGIN             set @AnthemUnitPricefinal = (Select CONVERT(DECIMAL(18,2),replace(@AnthemUnitPrice, ',', '')) );           END        if ((@StandardUnitPrice is not null) AND (@StandardUnitPrice <> ''))      BEGIN             set @StandardUnitPricefinal = (Select CONVERT(DECIMAL(18,2),replace(@StandardUnitPrice, ',', '')) );           END              if(@AnthemandMedicaidPerson = 'YES')     BEGIN     DECLARE @temporartytable TABLE     (       ID int            );        if ((@AnthemUnitPrice is not null) AND (@AnthemUnitPrice <> '') AND (@MedicaidUnitPrice is not null) AND (@MedicaidUnitPrice <> '') AND (@StandardUnitPrice is not null) AND (@StandardUnitPrice <> ''))            BEGIN             Declare @MinofAnthemandMedicaid as DECIMAL(18,2);        Declare @MinimumofAnthemMedicaidandStandard as DECIMAL(18,2);                  set @MinofAnthemandMedicaid =  (select case when @AnthemUnitPricefinal > @MedicaidUnitPricefina
  CREATE FUNCTION [dbo].[fn_extract_numbers_Only](@string VARCHAR(2000))  RETURNS VARCHAR(2000)      AS        BEGIN          DECLARE @count int          DECLARE @intNumbers VARCHAR(1000)          SET @count = 0          SET @intNumbers = ''            WHILE @count <= LEN(@string)          BEGIN               IF SUBSTRING(@string, @count, 1)>='0' and SUBSTRING (@string, @count, 1) <='9'                  BEGIN                      SET @intNumbers = @intNumbers + SUBSTRING (@string, @count, 1)                  END              SET @count = @count + 1          END          RETURN @intNumbers      END  
-- =====================================================================================================  --SELECT * FROM [Insurance].[InsuranceCarriers]     --EXEC InsertorUpdateInsCarriers 7, 'Scripts', 'GEHA_FEHBP', 1, 0, 'Scripts', 0  -- =====================================================================================================  CREATE Procedure [dbo].[InsertorUpdateInsCarriers_BM]     -- Add the parameters for the stored procedure here         @action NVARCHAR(5),    @insuranceCarrierID BIGINT = 0,             @createSource NVARCHAR(150),              @insuranceCarrierName NVARCHAR(50),          @isActive BIT,          @memberDataFileProvided BIT,             @modifySource NVARCHAR(150),         @isDiscountProgram bit,    @custServiceAddress1 nvarchar(200),    @custServiceAddress2  nvarchar(200),    @custServiceCity  nvarchar(100),    @custServiceState  nvarchar(100),    @custServiceZipCode  nvarchar(10),    @custServicePhoneNbr bigint,    @custServiceEmailAddress  nvarchar(100),    @claimsAddress1  nvarchar(200),    @claimsAddress2  nvarchar(200),    @claimsCity  nvarchar(100),    @claimsState  nvarchar(100),    @claimsZipCode  nvarchar(10),    @claimsPhoneNbr bigint,    @claimsEmailAddress  nvarchar(100),    @isContracted bit      AS    BEGIN     -- SET NOCOUNT ON added to prevent extra result sets from     -- interfering with SELECT statements.     SET NOCOUNT ON;     --reseeded the identity column in the table     --end      -- Insert statements for procedure here     IF @action = 'N'    BEGIN   if not exists (SELECT 1 FROM [Insurance].[InsuranceCarriers])   BEGIN    DBCC CHECKIDENT ('[Insurance].[InsuranceCarriers]', RESEED, 1)    END     INSERT INTO [Insurance].[InsuranceCarriers]       (Createdate,        CreateUser,        InsuranceCarrierName,        IsActive,        MemberDataFileProvided,        ModifyDate,        ModifyUser,     IsDiscountProgram,     CustServiceAddress1,     CustServiceAddress2,     CustServiceCity,     CustServiceState,     CustServiceZipCode,     CustServicePhoneNbr,     CustServiceEmailAddress,     ClaimsAddress1,     ClaimsAddress2,     ClaimsCity,     ClaimsState,     ClaimsZipCode,     ClaimsPhoneNbr,     ClaimsEmailAddress,     IsContracted     )        VALUES  (getdate(),       @createSource,        @insuranceCarrierName,        @isActive,        @memberDataFileProvided,        getdate(),        @modifySource,     @isDiscountProgram,     @custServiceAddress1,     @custServiceAddress2,     @custServiceCity,     @custServiceState,     @custServiceZipCode,     @custServicePhoneNbr,     @custServiceEmailAddress,     @claimsAddress1,     @claimsAddress2,     @claimsCity,     @claimsState,     @claimsZipCode,     @claimsPhoneNbr,     @claimsEmailAddress,     @isContracted     )     END    ELSE if  @action = 'R'--exists (SELECT 1 FROM [Insurance].[InsuranceCarriers] WHERE INSURANCECARRIERNAME = @insuranceCarrierName)     BEGIN     UPDATE  [Insurance].[InsuranceCarriers]         SET  InsuranceCarrierName = @insuranceCarrierName,          IsActive = @isActive,           MemberDataFileProvided= @memberDataFileProvided,           ModifyDate = getdate(),           ModifyUser = @modifySource,        IsDiscountProgram = @isDiscountProgram,      CustServiceAddress1 = @custServiceAddress1,      CustServiceAddress2 = @custServiceAddress2,      CustServiceCity = @custServiceCity,      CustServiceState = @custServiceState,      CustServiceZipCode = @custServiceZipCode,      CustServicePhoneNbr = @custServicePhoneNbr,      CustServiceEmailAddress = @custServiceEmailAddress,      ClaimsAddress1 = @claimsAddress1,      ClaimsAddress2 = @claimsAddress2,      ClaimsCity = @claimsCity,      ClaimsState = @claimsState,      ClaimsZipCode = @claimsZipCode,      ClaimsPhoneNbr = @claimsPhoneNbr,      ClaimsEmailAddress =  @claimsEmailAddress,      IsContracted =  @isContracted     WHERE   InsuranceCarrierID = @insuranceCarrierID       END    ELSE if  @action = 'D'    BEGIN     UPDATE  [Insurance].[Insu
CREATE Procedure [dbo].[InsertorUpdateInsHealthPlanBenefits_BM]   -- Add the parameters for the stored procedure here      @action Nvarchar(5),      @ContractBenefitID bigint = 0,      @BenefitAmt float = 0.0,      @BenefitAmtPer nvarchar(50) = null,      @BenefitFrequencyYears nvarchar(20) = null,      @BenefitFrequencyYearsBy nvarchar(50) = null,          @CreateUser nvarchar(150) = null,      @FittingCoPay float = 0.0,      @HealthPlanContractID int,      @HealthPlanContractInsuranceHealthPlanID bigint = null,      @HearingAidCoPay float,      @HearingAidCoPayPer nvarchar(50)= null,      @HearingExamCoPay float,      @InsurancePayerID nvarchar(100) = null,      @IsAbilityToBalanceBillMember bit,      @IsActive bit,      @IsClaimEqualToProductListPricePerDevice bit,      @IsClaimPayToPatient bit,      @IsDefaultBenefit bit,      @IsFileClaim bit,      @IsHearingAidBenefitVerificationRequired bit,      @IsMedicaidIsSecondaryCoverage bit,      @IsPMNPM bit,      @IsPriorAuth bit,      @IsRebate bit,          @ModifyUser nvarchar(150) = NULL,      @PMPMAmount float,      @RebatePercentage int                   AS  BEGIN   -- SET NOCOUNT ON added to prevent extra result sets from   -- interfering with SELECT statements.   SET NOCOUNT ON;      -- Insert statements for procedure here  IF @action = 'N'    BEGIN   if not exists (SELECT 1 FROM [Insurance].[ContractBenefits])   BEGIN    DBCC CHECKIDENT ('[Insurance].[ContractBenefits]', RESEED, 1)    END   INSERT INTO  [Insurance].[ContractBenefits]         (       BenefitAmt,       BenefitAmtPer,       BenefitFrequencyYears,       BenefitFrequencyYearsBy,       CreateDate,       CreateUser,       FittingCoPay,       HealthPlanContractID,       HealthPlanContractInsuranceHealthPlanID,       HearingAidCoPay,       HearingAidCoPayPer,       HearingExamCoPay,       InsurancePayerID,       IsAbilityToBalanceBillMember,       IsActive,       IsClaimEqualToProductListPricePerDevice,       IsClaimPayToPatient,       IsDefaultBenefit,       IsFileClaim,       IsHearingAidBenefitVerificationRequired,       IsMedicaidIsSecondaryCoverage,       IsPMNPM,       IsPriorAuth,       IsRebate,       ModifyDate,       ModifyUser,       PMPMAmount,       RebatePercentage      )   Values  (      @BenefitAmt,      @BenefitAmtPer,      @BenefitFrequencyYears,      @BenefitFrequencyYearsBy,      getdate(),      @CreateUser,      @FittingCoPay,      @HealthPlanContractID,      @HealthPlanContractInsuranceHealthPlanID,      @HearingAidCoPay,      @HearingAidCoPayPer,      @HearingExamCoPay,      @InsurancePayerID,      @IsAbilityToBalanceBillMember,      @IsActive,      @IsClaimEqualToProductListPricePerDevice,      @IsClaimPayToPatient,      @IsDefaultBenefit,      @IsFileClaim,      @IsHearingAidBenefitVerificationRequired,      @IsMedicaidIsSecondaryCoverage,      @IsPMNPM,      @IsPriorAuth,      @IsRebate,      getdate(),      @ModifyUser,      @PMPMAmount,      @RebatePercentage      )    END   ELSE if @action = 'R'--exists (SELECT 1 FROM [Insurance].[ContractBenefits]  WHERE ContractBenefitID = @ContractBenefitID and HealthPlanContractID = @HealthPlanContractID)   BEGIN     UPDATE  [Insurance].[ContractBenefits]     SET      BenefitAmt = @BenefitAmt,       BenefitAmtPer = @BenefitAmtPer,       BenefitFrequencyYears = @BenefitFrequencyYears,       BenefitFrequencyYearsBy = @BenefitFrequencyYearsBy,            FittingCoPay = @FittingCoPay,       HealthPlanContractID = @HealthPlanContractID ,       HealthPlanContractInsuranceHealthPlanID = @HealthPlanContractInsuranceHealthPlanID,       HearingAidCoPay = @HearingAidCoPay,       HearingAidCoPayPer = @HearingAidCoPayPer,       HearingExamCoPay = @HearingExamCoPay,       InsurancePayerID = @InsurancePayerID,       IsAbilityToBalanceBillMember = @IsAbilityToBalanceBillMember,       IsActive = @IsActive,       IsClaimEqualToProductListPricePerDevice = @IsClaimEqualToProductListPricePerDevice,       IsClaimPayToPatient = @IsClaimPayToPatient,       IsDefaultBen
-- =====================================================================================================  -- SELECT * FROM [Insurance].[InsuranceHealthPlans]  -- EXEC InsertorUpdateInsHealthPlans 20, 'Scripts', 'Anthem MediBlue Access (PPO', 'NULL', 6, 1, 'Scripts', 0  -- =====================================================================================================  CREATE Procedure [dbo].[InsertorUpdateInsHealthPlans_BM]   -- Add the parameters for the stored procedure here         @action NVARCHAR(5),       @insuranceHealthPlanID bigint = 0,           @createSource NVARCHAR(150),             @healthPlanName NVARCHAR(50),        @healthPlanNumber NVARCHAR(100) = null,        @insuranceCarrierID BIGINT,       @isActive BIT,       @modifySource NVARCHAR(150) = null,       @isDiscountProgram BIT             AS  BEGIN   -- SET NOCOUNT ON added to prevent extra result sets from   -- interfering with SELECT statements.   SET NOCOUNT ON;      -- Insert statements for procedure here   IF @action = 'N'     BEGIN    if not exists (SELECT 1 FROM [Insurance].[InsuranceHealthPlans])     BEGIN      DBCC CHECKIDENT ('[Insurance].[InsuranceHealthPlans]', RESEED, 1)      END     INSERT INTO [Insurance].[InsuranceHealthPlans]         (CreateDate,          CreateUser,          HealthPlanName,          HealthPlanNumber,          InsuranceCarrierID,          IsActive,          ModifyDate,          ModifyUser,         IsDiscountProgram)      VALUES   (getdate(),         @createSource,          @healthPlanName,          @healthPlanNumber,          @insuranceCarrierID,          @isActive,          getdate(),            @modifySource,         @isDiscountProgram)       END   ELSE if  @action = 'R'--exists (SELECT 1 FROM [Insurance].[InsuranceHealthPlans]  WHERE HealthPlanName = @healthPlanName and InsuranceCarrierID = @insuranceCarrierID)    BEGIN     UPDATE  [Insurance].[InsuranceHealthPlans]       SET  HealthPlanName = @healthPlanName,        HealthPlanNumber = @healthPlanNumber,             InsuranceCarrierID= @insuranceCarrierID,        IsActive = @isActive,        ModifyDate = getdate(),         ModifyUser = @modifySource,        IsDiscountProgram = @isDiscountProgram      WHERE   InsuranceHealthPlanID = @insuranceHealthPlanID      END   ELSE if  @action = 'D'    BEGIN     UPDATE  [Insurance].[InsuranceHealthPlans]          SET IsActive=0  WHERE   InsuranceHealthPlanID = @insuranceHealthPlanID      END   END  
-- =====================================================================================================  --SELECT * FROM [Insurance].[ContractProducts]   --EXEC InsertorUpdateInsHealthPlanContractProducts 1, 'GNR',  'Scripts', 'Prem', null, 'RS Trust 17', 53, null, 1,  'Scripts', 1008, 600, 2250  -- =====================================================================================================  CREATE Procedure [dbo].[InsertorUpdateInsHealthPlanContractProducts_BM]   -- Add the parameters for the stored procedure here      @action NVARCHAR(5),      @contractProductID BIGINT =0,      @brandCode NVARCHAR(30) = NULL,          @CreateUser NVARCHAR(150) = NULL,      @familyProductCatCode NVARCHAR(50)= NULL,      @familyProductCategoryFamilyProductID BIGINT = NULL,      @familyProductCode NVARCHAR(50) = NULL,      @healthPlanContractID INT,      @healthPlanContractID1 BIGINT,      @isActive BIT,          @modifyUser NVARCHAR(150) = NULL,      @perDeviceCOGSPrice FLOAT,      @perDeviceDispensingFee FLOAT,      @perDeviceMemberPrice FLOAT              AS  BEGIN   -- SET NOCOUNT ON added to prevent extra result sets from   -- interfering with SELECT statements.   SET NOCOUNT ON;      -- Insert statements for procedure here  IF @action = 'N'    BEGIN   if not exists (SELECT 1 FROM [Insurance].[ContractProducts])   BEGIN    DBCC CHECKIDENT ('[Insurance].[ContractProducts]', RESEED, 1)    END     INSERT INTO  [Insurance].[ContractProducts]         (            BrandCode,       CreateDate,       CreateUser,       FamilyProductCatCode,       FamilyProductCategoryFamilyProductID,       FamilyProductCode,       HealthPlanContractID,       HealthPlanContractID1,       IsActive,       ModifyDate,       ModifyUser,       PerDeviceCOGSPrice,       PerDeviceDispensingFee,       PerDeviceMemberPrice      )   Values  (      @brandCode,      getdate(),      @CreateUser,      @familyProductCatCode,      @familyProductCategoryFamilyProductID,      UPPER(@familyProductCode),      @healthPlanContractID,      @healthPlanContractID1,      @isActive,      getdate(),      @modifyUser,      @perDeviceCOGSPrice,      @perDeviceDispensingFee,      @perDeviceMemberPrice      )    END    ELSE if  @action = 'R' --if exists (SELECT 1 FROM [Insurance].[ContractProducts]  WHERE ContractProductID = @contractProductID and FamilyProductCatCode = @familyProductCatCode and FamilyProductCode = @familyProductCode and HealthPlanContractID = @healthPlanContractID)   BEGIN    UPDATE  [Insurance].[ContractProducts]     SET      BrandCode = @brandCode,         FamilyProductCatCode = @familyProductCatCode,       FamilyProductCategoryFamilyProductID = @familyProductCategoryFamilyProductID,       FamilyProductCode = UPPER(@familyProductCode),       HealthPlanContractID = @healthPlanContractID,       HealthPlanContractID1 = @healthPlanContractID1,       IsActive = @isActive,       ModifyDate = getdate(),       ModifyUser = @modifyUser,       PerDeviceCOGSPrice =@perDeviceCOGSPrice ,       PerDeviceDispensingFee = @perDeviceDispensingFee,       PerDeviceMemberPrice = @perDeviceMemberPrice       WHERE   ContractProductID = @contractProductID   END   ELSE if  @action = 'D'    BEGIN     UPDATE  [Insurance].[ContractProducts]           SET IsActive=0  WHERE  ContractProductID = @contractProductID     END  END  
  -- =============================================  -- Author:  RAMU KUNJA  -- Create date: 11-dEC-2017  -- Description: PROCEDURE for Member Search Results  -- =============================================  CREATE Procedure [dbo].[sp_Admin_SearchMember](   -- Add the parameters for the stored procedure here   @MemberID           BIGINT = NULL,       @NHMemberID         NVARCHAR(50) = NULL,    @FirstName          NVARCHAR(250) = NULL,      @LastName           NVARCHAR(50) = NULL,   @DateOfBirth        DATETIME = NULL,   @Gender             NVARCHAR(10) = NULL,   @MaritalStatus      NVARCHAR(25) = NULL,   @Address1           NVARCHAR(500) = NULL,   @Address2           NVARCHAR(500) = NULL,   @City               NVARCHAR(50) = NULL,   @State              NVARCHAR(10) = NULL,   @Country            NVARCHAR(50) = NULL,   @ZipCode            NVARCHAR(10) = NULL,       @EmailAddress       NVARCHAR(50) = NULL,       @Phone               NVARCHAR(50) = NULL,   @InsuranceHealthPlanNumber NVARCHAR(250) = NULL,   @InsuranceHealthPlanName NVARCHAR(250) = NULL,   @InsuranceCarrierName NVARCHAR(250) = NULL)  AS  BEGIN   -- SET NOCOUNT ON added to prevent extra result sets from   -- interfering with SELECT statements.   SET NOCOUNT ON;   DECLARE @SQLQuery AS NVARCHAR(4000)       SET @SQLQuery = 'SELECT DISTINCT M.MemberID,M.NHMemberID,M.FirstName,M.LastName,M.DateOfBirth,M.Gender,M.MiddleInitial,M.IsActive,          A.Address1,A.Address2,A.City,A.State,A.Country,A.ZipCode,A.AddressTypeCode,          P.PhoneNbr,P.CountryCode,P.IsPreferredPhoneNumber,P.PhoneExtension,       EM.EmailAddress,       MA.AttributeTypeCode,MA.AttributeValue,       MI.InsuranceCarrierID,MI.InsuranceEffectiveDate,MI.InsuranceHealthPlanID,MI.InsuranceType,       MD.InsuranceNbr,       IC.InsuranceCarrierName,IC.MemberDataFileProvided,       IH.HealthPlanName,IH.HealthPlanNumber   FROM [Master].Members M   LEFT JOIN [Master].Addresses A on M.MemberID=A.MemberID   LEFT JOIN [Master].PhoneNumbers P on M.MemberID=P.MemberID   LEFT JOIN [Master].Emails EM on M.MemberID = EM.MemberID   LEFT JOIN [Master].MemberAttributes MA on M.MemberID=MA.MemberID   LEFT JOIN [Master].MemberInsurances MI on M.MemberID=MI.MemberID   LEFT JOIN [Master].MemberInsuranceDetails MD on MI.ID=MD.MemberInsuranceID   LEFT JOIN Insurance.InsuranceCarriers IC on MI.InsuranceCarrierID=IC.InsuranceCarrierID   LEFT JOIN Insurance.InsuranceHealthPlans IH on MI.InsuranceHealthPlanID=IH.InsuranceHealthPlanID    '   --If any Single Value ---   if(@FirstName IS NOT NULL)   SET @SQLQuery = @SQLQuery + 'WHERE M.FirstName LIKE ''%' + @FirstName+'%'''   if (@FirstName IS NOT NULL AND @LastName IS NOT NULL)   SET @SQLQuery = @SQLQuery + ' AND M.LastName LIKE ''%' + @LastName+'%'''   else if (@LastName IS NOT NULL)   SET @SQLQuery = @SQLQuery + ' WHERE M.LastName LIKE ''%' + @LastName+'%'''     if (@FirstName IS NOT NULL AND @LastName IS NOT NULL AND @DateOfBirth IS NOT NULL)   SET @SQLQuery = @SQLQuery + ' AND M.DateOfBirth =''' + @DateOfBirth +''   else IF (@DateOfBirth IS NOT NULL)   SET @SQLQuery = @SQLQuery + ' WHERE M.DateOfBirth =''' + @DateOfBirth +''       if (@FirstName IS NOT NULL AND @LastName IS NOT NULL AND @DateOfBirth IS NOT NULL AND @Gender IS NOT NULL)   SET @SQLQuery = @SQLQuery + ' AND M.Gender =''' + @Gender +''   else if (@Gender IS NOT NULL)   SET @SQLQuery = @SQLQuery + ' WHERE M.Gender =''' + @Gender + ''''      if (@FirstName IS NOT NULL AND @LastName IS NOT NULL AND @DateOfBirth IS NOT NULL AND @Gender IS NOT NULL AND @MaritalStatus IS NOT NULL)   SET @SQLQuery = @SQLQuery + ' AND M.MaritalStatus =''' + @MaritalStatus +''''   else if (@MaritalStatus IS NOT NULL)   SET @SQLQuery = @SQLQuery + ' WHERE M.MaritalStatus =''' + @MaritalStatus +''''      if (@FirstName IS NOT NULL AND @LastName IS NOT NULL AND @DateOfBirth IS NOT NULL AND @Gender IS NOT NULL AND @MaritalStatus IS NOT NULL AND @Address1 IS NOT NULL)   SET @SQLQuery = @SQLQuery + ' AND A.Address1 LIKE ''%'+@Address1+'%'''   else i
  CREATE PROCEDURE [dbo].[sp_GetInsurancehistoryUpdates]      (       @MemberProfileID     BIGINT = 0      )      AS      BEGIN       SET NOCOUNT ON;        SELECT ROW_NUMBER() OVER (ORDER BY InsuranceCarrierName) RowID,      [Status],InsuranceCarrierName,HealthPlanName,NHMemberId,InsuranceEffectiveDate,InsuranceEndDate,ModifyDate,ModifyUser,CreateDate FROM       (SELECT CASE WHEN mi.InsuranceEndDate >= GETDATE()     THEN 'Active' ELSE 'Inactive' END AS [Status],    ic.InsuranceCarrierName,hp.HealthPlanName,mp.NHMemberId,         mi.InsuranceEffectiveDate,mi.InsuranceEndDate,mi.ModifyDate,mi.ModifyUser,mi.CreateDate       FROM [provider].[MemberInsurances_History] mi INNER JOIN [provider].[MemberProfiles] mp ON mp.MemberProfileID = mi.MemberProfileId AND mi.IsActive = 1             INNER JOIN [Insurance].[InsuranceCarriers] ic ON mi.InsuranceCarrierID = ic.InsuranceCarrierID AND ic.IsActive =1         INNER JOIN [Insurance].[InsuranceHealthPlans] hp ON mi.InsuranceHealthPlanID = hp.InsuranceHealthPlanID  AND hp.IsActive = 1 WHERE mp.MemberProfileID = @MemberProfileID)tmp    WHERE tmp.InsuranceCarrierName <> 'None' ORDER BY RowID      END    
        CREATE PROCEDURE [dbo].[DataSync_Get_Locations_4PVN]  AS  BEGIN  SELECT  '' as 'Action',  pl.providerId as 'ProviderId',  pp.[TaxId] as 'TaxId',  pp.[ProviderName] as 'ProviderName',  l.[IsActive] as 'IsActive',  pl.[LocationId] as 'LocationId',  l.[BusinessName] as 'BusinessName',  l.[NPINumber] as 'NPINumber',  l.[Address1] as 'Address1',  l.[Address2] as 'Address2',  l.[City] as 'City',  l.[State] as 'State',  l.[Zip] as 'Zip',  isnull(l.[LocationEmailAddress], '') as 'LocationEmailAddress',  isnull((select top 1 PhoneNumber from [provider].[LocationPhoneNumbers] where [LocationId]=pl.[LocationId] and [PhoneTypeId]=1), '') as 'LocationPhoneNumber',  isnull((select top 1 PhoneNumber from [provider].[LocationPhoneNumbers] where [LocationId]=pl.[LocationId] and [PhoneTypeId]=3), '') as 'LocationFaxNumber',  isnull(JSON_VALUE([LocationServicesData], '$.mobileServices'), '') as 'MobileServices',  isnull((select top 1 [Dispenser] from [provider].[LocationsAccountNbrs] where [LocationId]=pl.[LocationId] and [BrandCode]='GNR'), '') as 'ResoundAccountNumber',  isnull((select top 1 [Dispenser] from [provider].[LocationsAccountNbrs] where [LocationId]=pl.[LocationId] and [BrandCode]='BELTONE'), '') as 'BeltoneAccountNumber',  isnull((select top 1 [Dispenser] from [provider].[LocationsAccountNbrs] where [LocationId]=pl.[LocationId] and [BrandCode]='STARKEY'), '') as 'StarkeyAccountNumber',  isnull((select top 1 [Dispenser] from [provider].[LocationsAccountNbrs] where [LocationId]=pl.[LocationId] and [BrandCode]='PHONAK'), '') as 'PhonakAccountNumber',  isnull((select top 1 [Dispenser] from [provider].[LocationsAccountNbrs] where [LocationId]=pl.[LocationId] and [BrandCode]='WIDEX'), '') as 'WidexAccountNumber',  isnull((select top 1 [Dispenser] from [provider].[LocationsAccountNbrs] where [LocationId]=pl.[LocationId] and [BrandCode]='SIGNIA'), '') as 'SigniaAccountNumber',  isnull((select top 1 [Dispenser] from [provider].[LocationsAccountNbrs] where [LocationId]=pl.[LocationId] and [BrandCode]='UNITRON'), '') as 'UnitronAccountNumber',  isnull((select top 1 [Dispenser] from [provider].[LocationsAccountNbrs] where [LocationId]=pl.[LocationId] and [BrandCode]='OTICON'), '') as 'OticonAccountNumber',  isnull(JSON_VALUE([LocationServicesData], '$.wheelChair'), '') as 'WheelChair',  isnull(JSON_VALUE([LocationServicesData], '$.pediatricServices'), '') as 'PeditatricServices',  l.[Langauges] as 'Languages',  '' as 'CentralHealth',  '' as 'Ultimate',  '' as 'EON',  '' as 'HealthAlliance',  '' as 'UniversityofMaryland',  '' as 'Anthem',  (select Count(*) from [provider].[ProviderUserLocations] where ProviderId = pp.ProviderId and LocationId = l.LocationId) as 'TotalHCPs',  '' as 'HCPsCredentialed',  '' as 'PercentageHCPsCredentialed'  FROM [provider].[ProviderLocations] pl  INNER JOIN [provider].[ProviderProfiles] pp  on pl.providerId = pp.providerId  INNER JOIN [provider].[Locations] l  on pl.locationId = l.locationId  END  
CREATE FUNCTION [dbo].[fn_StripCharacters]  (      @String NVARCHAR(MAX),       @MatchExpression VARCHAR(255)  )  RETURNS NVARCHAR(MAX)  AS  BEGIN      SET @MatchExpression =  '%['+@MatchExpression+']%'        WHILE PatIndex(@MatchExpression, @String) > 0          SET @String = Stuff(@String, PatIndex(@MatchExpression, @String), 1, '')        RETURN @String    END
  CREATE PROCEDURE [dbo].[sp_SearchMemberCall_BK_2020JAN06]  (               @MemberID           BIGINT = NULL,                @NHMemberID         NVARCHAR(50) = NULL,                @FirstName          NVARCHAR(250) = NULL,               @LastName           NVARCHAR(50) = NULL,               @DateOfBirth        DATETIME = NULL,           @Gender             NVARCHAR(10) = NULL,               @MaritalStatus      NVARCHAR(25) = NULL,               @Address1           NVARCHAR(500) = NULL,               @Address2           NVARCHAR(500) = NULL,               @City               NVARCHAR(50) = NULL,               @State              NVARCHAR(10) = NULL,               @Country            NVARCHAR(50) = NULL,               @ZipCode            NVARCHAR(10) = NULL,                @EmailAddress       NVARCHAR(50) = NULL,                @Phone               NVARCHAR(50) = NULL,               @InsuranceHealthPlanNumber NVARCHAR(250) = NULL,        @OTCCardNumber    NVARCHAR(100) = NULL,            @InsuranceHealthPlanName NVARCHAR(250) = NULL,               @InsuranceCarrierName NVARCHAR(250) = NULL,           @SearchFilterCarrierId  NVARCHAR(250) = NULL,         @OrderID BIGINT = 0)        AS        BEGIN            SET NOCOUNT ON;     IF OBJECT_ID('tempdb..#results') IS NOT NULL   BEGIN    DROP TABLE #results   END        DECLARE @DateOfBirth1  AS VARCHAR(20) = NULL        SET @LastName = REPLACE(@LastName,'''','''''')        SET @FirstName = REPLACE(@FirstName,'''','''''')         SET @DateOfBirth1 = cast(@DateOfBirth as datetime)     DECLARE @Top BIGINT = CASE WHEN @NHMemberId IS NULL THEN 50 ELSE 1 END     CREATE TABLE #results (    MemberID BIGINT,    NHMemberNbr VARCHAR(100),    FirstName VARCHAR(100),    LastName VARCHAR(100),    DOB   VARCHAR(50),    Address  VARCHAR(200),    Address2 VARCHAR(200),    City  VARCHAR(100),    State  VARCHAR(50),    Country  VARCHAR(100),    Zip   VARCHAR(20),    AddressTypeCode VARCHAR(10),    OrderNumber BIGINT   )     IF (@OrderID IS NOT NULL AND @OrderID > 0)            BEGIN    INSERT INTO #results    SELECT TOP 1      M.MemberID,     M.NHMemberID NhMemberNbr,     M.FirstName,     M.LastName,     convert(varchar,(M.DateOfBirth),101) DOB,                           A.Address1 Address,A.Address2,A.City,A.State,A.Country,A.ZipCode zip,A.AddressTypeCode,                            ISNULL(O.OrderID,0) AS OrderNumber        FROM [Master].Members M                   INNER JOIN Orders.Orders O ON O.NHMemberId = M.NHMemberID and O.IsActive = 1    LEFT OUTER JOIN Orders.Orders O2 ON      O2.NhmemberId = M.NHMemberId     AND (      O.OrderId < O2.OrderId     )                   LEFT LOOP JOIN [Master].Addresses A WITH (NOLOCK) on (M.MemberID=A.MemberID and a.IsPreferredAddress=1) and A.IsActive = 1    LEFT OUTER JOIN Master.MemberInsurances MI WITH (NOLOCK) on (MI.MemberId = M.MemberID) and MI.IsActive =1    LEFT OUTER JOIN Master.MemberInsuranceDetails MID WITH (NOLOCK) on (MID.MemberInsuranceId = MI.ID) and MID.IsActive = 1    WHERE O.OrderId = @OrderId   END   ELSE IF (@NHMemberId IS NOT NULL)   BEGIN    INSERT INTO #results    SELECT TOP 1      M.MemberID,     M.NHMemberID NhMemberNbr,     M.FirstName,     M.LastName,     convert(varchar,(M.DateOfBirth),101) DOB,                           A.Address1 Address,A.Address2,A.City,A.State,A.Country,A.ZipCode zip,A.AddressTypeCode,                            ISNULL(O.OrderID,0) AS OrderNumber        FROM [Master].Members M                   LEFT JOIN Orders.Orders O ON O.NHMemberId = M.NHMemberID and O.IsActive = 1    LEFT OUTER JOIN Orders.Orders O2 ON      O2.NhmemberId = M.NHMemberId     AND (      O.OrderId < O2.OrderId     )                   LEFT LOOP JOIN [Master].Addresses A WITH (NOLOCK) on (M.MemberID=A.MemberID and a.IsPreferredAddress=1) and A.IsActive = 1    LEFT OUTER JOIN Master.MemberInsurances MI WITH (NOLOCK) on (MI.MemberId = M.MemberID) and MI.IsActive =1    LEFT OUTER JOIN Master.MemberInsuranceDetails MID WITH (NOLOCK) on (MID.MemberIn
/*   Mohan deployed to Stage on 7 May 2020   Mohan deployed to Production on 9 May 2020  */  CREATE PROCEDURE [dbo].[GetDetailMajorMinorInsuranceProviderLocation]  (     @Type NVARCHAR(20)  )  AS  BEGIN   SET @Type = 'OTC Benefits';      DECLARE @InsuranceCarrierID BIGINT,@InsuranceHealthPlanID BIGINT,@ProviderCode NVARCHAR(100),@ProviderId BIGINT,@MinorProcessId BIGINT,@MajorProcessId BIGINT,@UserProfileId BIGINT,@LocationId BIGINT,@MemberId BIGINT      -- SET NOCOUNT ON added to prevent extra result sets from      -- interfering with SELECT statements.      SET NOCOUNT ON             -- Insert statements for procedure here      SELECT @InsuranceCarrierID=InsuranceCarrierID,@InsuranceHealthPlanID=InsuranceHealthPlanID FROM [Insurance].[InsuranceHealthPlans] WHERE HealthPlanName LIKE  @Type + '%'      SELECT @ProviderCode=ProviderCode,@ProviderId=ProviderId FROM [Provider].[ProviderProfiles] WHERE ProviderName  LIKE 'OTC Provider%'      SELECT @LocationId=LocationId from [provider].[ProviderLocations] where providerid=@ProviderId      SELECT @MinorProcessId=MinorProcessId FROM [Provider].[MinorProcess] WHERE MinorProcessName  LIKE 'OTC Order Created%'      SELECT @MajorProcessId=MajorProcessId FROM [Provider].[MajorProcess] WHERE MajorProcessName  LIKE  'OTC Member%'      SELECT @UserProfileId=UserProfileId  FROM  [auth].[UserProfiles] WHERE USERNAME like 'OTCUSER%'      SELECT @MemberId=MemberID  FROM  [Master].[MemberInsurances] WHERE [InsuranceHealthPlanID]=@InsuranceHealthPlanID and [InsuranceCarrierID]=@InsuranceCarrierID       IF (ISNULL(@InsuranceCarrierID,0)!=0)      BEGIN      SELECT 1 as RowID, @InsuranceCarrierID AS InsuranceCarrierID,@InsuranceHealthPlanID AS InsuranceHealthPlanID,@ProviderCode as ProviderCode,@ProviderId as ProviderId,@LocationId AS ProviderLocationId,@MinorProcessId as MinorProcessId,@MajorProcessId as MajorProcessId,@UserProfileId AS UserProfileId,isnull(@MemberId,0) as MemberId      END      ELSE      SELECT 0        END
  CREATE PROCEDURE [dbo].[DataSync_Get_Providers_4PVN]  AS  BEGIN  SELECT  '' as 'Action',  cast([ProviderId] as varchar) AS 'ProviderId', [TaxId] AS 'TaxId', isnull([ProviderName], '') AS 'ProviderName',  cast([IsActive] as varchar) AS 'IsActive',  isnull([AgeRestrictions], '') as 'AgeRestrictions',  isnull([Languages], '') as 'Languages',  isnull([Brands], '') AS 'Brands',  isnull(JSON_VALUE([AdditionalData], '$.contractInfo.initialContractDate'), '') AS 'InitialContract',  isnull(JSON_VALUE([AdditionalData], '$.contractInfo.recentContractDate'), '') AS 'RecentContract',  isnull(JSON_VALUE([AdditionalData], '$.contractInfo.contractType'), '') AS 'ContractType',  isnull(JSON_VALUE([AdditionalData], '$.contractInfo.contractTerminationDate'), '') AS 'ContractTermination',  isnull(JSON_VALUE([AdditionalData], '$.contractInfo.AnthemAmendmentDate'), '') AS 'AnthemAmendment',  cast(isnull([PracticeTypeId], '') as varchar) AS 'PracticeTypeId', isnull([PracticeTypeId1], '') AS 'PracticeTypeId1',  cast(isnull([PrimaryEmailAddress], '') as varchar) AS 'PrimaryEmailAddress',  isnull(JSON_VALUE([AdditionalData], '$.billingAddress.address1'), '') AS 'BillingAddress',  isnull(JSON_VALUE([AdditionalData], '$.billingAddress.city'), '') AS 'BillingCity',  isnull(JSON_VALUE([AdditionalData], '$.billingAddress.state'), '') AS 'BillingState',  isnull(JSON_VALUE([AdditionalData], '$.billingAddress.zip'), '') AS 'BillingZip',  isnull(JSON_VALUE([AdditionalData], '$.billingAddress.county'), '') AS 'BillingCounty',  isnull(JSON_VALUE([AdditionalData], '$.billingAddress.phoneNumber'), '') AS 'BillingPhoneNumber',  isnull(JSON_VALUE([AdditionalData], '$.owner.lastName'), '') AS 'OwnerLastName',  isnull(JSON_VALUE([AdditionalData], '$.owner.firstName'), '') AS 'OwnerFirstName',  isnull(JSON_VALUE([AdditionalData], '$.shippingAddress.address1'), '') AS 'ShippingAddress',  isnull(JSON_VALUE([AdditionalData], '$.shippingAddress.address2'), '') AS 'ShippingAddress2',  isnull(JSON_VALUE([AdditionalData], '$.shippingAddress.city'), '') AS 'ShippingCity',  isnull(JSON_VALUE([AdditionalData], '$.shippingAddress.state'), '') AS 'ShippingState',  isnull(JSON_VALUE([AdditionalData], '$.shippingAddress.zip'), '') AS 'ShippingZip',  isnull(JSON_VALUE([AdditionalData], '$.adaAttestationReceivedDate'), '') AS 'ADAAttestationReceivedDate',  isnull(JSON_VALUE([AdditionalData], '$.medicareAttestationReceivedDate'), '') AS 'MedicareAttestationReceivedDate'  FROM [provider].[ProviderProfiles]  END  
    CREATE PROCEDURE [dbo].[DataSync_Get_LocationHCPsMapping_4PVN]  AS  BEGIN  SELECT distinct      '' AS ACTION,       [HCP].[IsActive] AS 'IsActive',      [PPP].[PROVIDERID] AS 'ProviderId',       [PPP].[TAXID] AS 'TaxId',      [PPP].[PROVIDERNAME] AS 'ProviderName',      [PL].[LocationId] AS 'LocationId',       [PL].[BusinessName] AS 'BusinessName',   [HCP].[HCPId] AS 'HCPId',   [HCP].[FirstName] AS 'FirstName',   [HCP].[LastName] AS 'LastName',   [HCP].[NHNPI] AS 'NHNPI',   [HCP].[NPINumber] AS 'NPINumber'       FROM [provider].[ProviderUserLocations] PUL  INNER JOIN [provider].[HCPProviderProfile] HCP ON PUL.UserProfileId =  HCP.UserProfileId  INNER JOIN [provider].[Locations] PL ON PL.LocationId =  PUL.LocationId  INNER JOIN [provider].[ProviderProfiles] PPP ON  PPP.PROVIDERID = PUL.PROVIDERID  where pul.ISactive=1  ORDER BY  PPP.[PROVIDERID] ASC  END  
CREATE PROCEDURE [dbo].[GetAllOrderItems] @OrderId bigint  AS  BEGIN      SET NOCOUNT ON     SELECT [OrderItemId]        ,[OrderId]        ,[BrandCode]        ,[FamilyCode]        ,[StyleCode]        ,[TechnologyLevelCode]        ,[ProductModelCode]        ,[ItemCode]        ,[Modifier]        ,[Quantity]        ,[Amount]        ,[Status]        ,[UnitPrice]        ,[PairPrice]        ,[ItemData]        ,[ItemType]        ,[PONumber]        ,[InvoiceNumber]        ,[CreateUser]        ,[CreateDate]        ,[ModifyUser]        ,[ModifyDate]        ,[IsActive]        ,[PreviousAmount]    FROM [Orders].[OrderItems] OI where OI.OrderId = @OrderId;      END
CREATE Procedure [dbo].[sp_GetOrderDetailsForCreateOrder]     @nhMemberId [nvarchar](50)        AS    BEGIN        SET NOCOUNT ON      -- declare  @nhMemberId varchar(50)='QA201700004486'    SELECT  distinct         o.[OrderID]        ,o.[MemberChartDataId]   ,o.NhMemberID            ,o.CreateDate as OrderDate        ,os.OrderStatusName           ,items.DeviceCount        ,ma.StartDate         ,ma.AppointmentTypeId          from [Orders].[Orders] o      join Orders.OrderStatusTypes os on o.OrderStatusCode = os.OrderStatusCode       join provider.MemberChartData mcd on mcd.MemberChartDataId=o.MemberChartDataId     join provider.MemberAppointments ma on ma.MemberChartDataId = mcd.MemberChartDataId      inner join  (SELECT  count(*) as DeviceCount,OrderId as OrderId               FROM orders.orderitems orderitem                       where  orderitem.IsActive=1 and  orderitem.ItemCode!='EARMOLD'           group by OrderId                  ) items    on Items.OrderId=o.OrderId     where (ISJSON(MemberData) > 0) and (ISJSON(OrderAmountData) > 0) and NHMemberId= @nhMemberId and ma.AppointmentTypeId=1    order by o.CreateDate desc                END      
CREATE PROCEDURE [dbo].[DataSync_Get_HCPS_4PVN]  AS  BEGIN  SELECT       '' AS Action,          [HCP].[HCPId] AS 'HCPId',   isnull([HCP].[FirstName], '') AS 'FirstName',   isnull([HCP].[LastName], '') AS 'LastName',   isnull([HCP].[NPINumber], '') AS 'NPINumber',   isnull([HCP].[NHNPI], '') AS 'NHNPI',   [HCP].[ISActive] AS 'IsActive',         isnull(JSON_VALUE([HCP].[LicenseData],'$.licenseNumber1'), '') AS 'LicenseNumber1',      isnull(JSON_VALUE([HCP].[LicenseData],'$.licenseStates1'),'') AS 'LicenseState1',    isnull(JSON_VALUE([HCP].[LicenseData],'$.licenseNumber2'), '') AS 'LicenseNumber2',      isnull(JSON_VALUE([HCP].[LicenseData],'$.licenseStates2'),'') AS 'LicenseState2',    isnull(JSON_VALUE([HCP].[LicenseData],'$.licenseNumber3'), '') AS 'LicenseNumber3',      isnull(JSON_VALUE([HCP].[LicenseData],'$.licenseStates3'),'') AS 'LicenseState3',   isnull(JSON_VALUE([HCP].[LicenseData],'$.boardCertified'), '') AS 'BoardCertified',      isnull(JSON_VALUE([HCP].[LicenseData],'$.credentialDate'),'') AS 'CredentialDate'  FROM [provider].[HCPProviderProfile] HCP  END
  CREATE Procedure [dbo].[sp_SearchMemberCall1](   -- Add the parameters for the stored procedure here   @MemberID           BIGINT = NULL,       @NHMemberID         NVARCHAR(50) = NULL,    @FirstName          NVARCHAR(250) = NULL,      @LastName           NVARCHAR(50) = NULL,   @DateOfBirth        DATETIME = NULL,   @Gender             NVARCHAR(10) = NULL,   @MaritalStatus      NVARCHAR(25) = NULL,   @Address1           NVARCHAR(500) = NULL,   @Address2           NVARCHAR(500) = NULL,   @City               NVARCHAR(50) = NULL,   @State              NVARCHAR(10) = NULL,   @Country            NVARCHAR(50) = NULL,   @ZipCode            NVARCHAR(10) = NULL,       @EmailAddress       NVARCHAR(50) = NULL,       @Phone               NVARCHAR(50) = NULL,   @InsuranceHealthPlanNumber NVARCHAR(250) = NULL,   @InsuranceHealthPlanName NVARCHAR(250) = NULL,   @InsuranceCarrierName NVARCHAR(250) = NULL)  AS  BEGIN   SET NOCOUNT ON;   DECLARE @SQLQueryRes AS NVARCHAR(4000)   DECLARE @SQLQuery AS NVARCHAR(4000)   DECLARE @SQLQueryM AS NVARCHAR(2000)   DECLARE @SQLQueryA AS NVARCHAR(2000)   DECLARE @SQLQueryP AS NVARCHAR(2000)   DECLARE @SQLQueryI AS NVARCHAR(2000)   DECLARE @tables AS VARCHAR(50)   DECLARE @Where AS VARCHAR(500)   DECLARE @DateOfBirth1  AS VARCHAR(20) = NULL     set @LastName = REPLACE(@LastName,'''','''''')     set @FirstName = REPLACE(@FirstName,'''','''''')     SET @DateOfBirth1 = cast(@DateOfBirth as datetime)       SET @SQLQuery = 'SELECT DISTINCT TOP 100 M.MemberID, m.NHMEMBERID from '     SET @SQLQueryM = 'Master.Members m where  1 = 1 '     SET @SQLQueryP = 'Master.Members m , Master.PhoneNumbers p where 1 = 1 and m.memberid = p.memberid '     SET @SQLQueryA = 'Master.Members m , Master.Addresses a where 1 = 1 and m.memberid = a.memberid '     SET @SQLQueryI = 'master.members m where exists (select 1 from (   select mi.memberid from master.MemberInsurances mi    where exists (select 1 from Master.MemberInsuranceDetails mid where           mid.memberinsuranceid = mi.id and mid.InsuranceNbr  = '     if (@FirstName is not null )    Begin    set @tables = 'MEMBER'    set @Where = ' and m.firstname like '''+@FirstName+'%'''     if @ZipCode is not null       Begin       set @tables = 'MEMBERADDRESS'       set @Where = @Where + ' and a.ZipCode like '''+@ZipCode+'%'''         End     else      Begin       if @LastName is not null        set @Where = @Where + ' and m.lastname like '''+@LastName+'%'''       if @DateOfBirth1 is not null        set @Where = @Where + ' and m.DateOfBirth = cast('''+@DateOfBirth1+''''+' as datetime)'      End       End   else     if (@LastName is not null )    Begin    set @tables = 'MEMBER'    set @Where = ' and m.lastname like '''+@LastName+'%'''     if @ZipCode is not null       Begin       set @tables = 'MEMBERADDRESS'       set @Where = @Where + ' and a.ZipCode like '''+@ZipCode+'%'''         End     else      Begin       if @FirstName is not null        set @Where = @Where + ' and m.firstname like '''+@FirstName+'%'''       if @DateOfBirth1 is not null        set @Where = @Where + ' and m.DateOfBirth = cast('''+@DateOfBirth1+''''+' as datetime)'      End       End   else if (@DateOfBirth1 is not null)    Begin     set @tables = 'MEMBER'     set @Where = ' and m.DateOfBirth = cast('''+@DateOfBirth1+''''+' as datetime)'    End   else if (@Phone is not null)    Begin     set @tables = 'PHONE'     set @Where = ' and p.PhoneNbr = '+@Phone    End   else if (@Address1 is not null)    Begin     set @tables = 'ADDRESS'     set @Where = ' and a.Address1 like '''+@Address1+'%'''     if @ZipCode is not null      set @Where = @Where + ' and a.ZipCode like '''+@ZipCode+'%'''    End   else if @InsuranceHealthPlanNumber is not null    Begin     set @tables = 'INSURANCE'     set  @Where = @Where + ' and mid.InsuranceNbr like ''%'+@InsuranceHealthPlanNumber+'%'''    End     IF @tables = 'MEMBER'    set @SQLQUERY = @SQLQUERY + @SQLQUERYM + @Where   else if @tables = 'ADDRESS'    set @SQLQUERY = @SQLQUERY + @SQL
    CREATE PROCEDURE [dbo].[sp_SearchMemberCall_12JAN2020]  (               @MemberID           BIGINT = NULL,                @NHMemberID         NVARCHAR(50) = NULL,                @FirstName          NVARCHAR(250) = NULL,               @LastName           NVARCHAR(50) = NULL,               @DateOfBirth        DATETIME = NULL,           @Gender             NVARCHAR(10) = NULL,               @MaritalStatus      NVARCHAR(25) = NULL,               @Address1           NVARCHAR(500) = NULL,               @Address2           NVARCHAR(500) = NULL,               @City               NVARCHAR(50) = NULL,               @State              NVARCHAR(10) = NULL,               @Country            NVARCHAR(50) = NULL,               @ZipCode            NVARCHAR(10) = NULL,                @EmailAddress       NVARCHAR(50) = NULL,                @Phone               NVARCHAR(50) = NULL,               @InsuranceHealthPlanNumber NVARCHAR(250) = NULL,        @OTCCardNumber    NVARCHAR(100) = NULL,            @InsuranceHealthPlanName NVARCHAR(250) = NULL,               @InsuranceCarrierName NVARCHAR(250) = NULL,           @SearchFilterCarrierId  NVARCHAR(250) = NULL,         @OrderID BIGINT = 0)        AS        BEGIN            SET NOCOUNT ON;     IF OBJECT_ID('tempdb..#results') IS NOT NULL   BEGIN    DROP TABLE #results   END        DECLARE @DateOfBirth1  AS VARCHAR(20) = NULL        SET @LastName = REPLACE(@LastName,'''','''''')        SET @FirstName = REPLACE(@FirstName,'''','''''')         SET @DateOfBirth1 = cast(@DateOfBirth as datetime)     DECLARE @Top BIGINT = CASE WHEN @NHMemberId IS NULL THEN 50 ELSE 1 END     CREATE TABLE #results (    MemberID BIGINT,    NHMemberNbr VARCHAR(100),    FirstName VARCHAR(100),    LFN   INT,    LastName VARCHAR(100),    LLN   INT,    DOB   VARCHAR(50),    Address  VARCHAR(200),    Address2 VARCHAR(200),    City  VARCHAR(100),    State  VARCHAR(50),    Country  VARCHAR(100),    Zip   VARCHAR(20),    AddressTypeCode VARCHAR(10),    OrderNumber BIGINT   )     IF (@OrderID IS NOT NULL AND @OrderID > 0)            BEGIN    INSERT INTO #results    SELECT TOP 1      M.MemberID,     M.NHMemberID NhMemberNbr,     M.FirstName,     CASE WHEN @FirstName IS NOT NULL THEN LEN(M.FirstName) END LFN,     M.LastName,     CASE WHEN @LastName IS NOT NULL THEN LEN(M.LastName) END LLN,     convert(varchar,(M.DateOfBirth),101) DOB,                           A.Address1 Address,A.Address2,A.City,A.State,A.Country,A.ZipCode zip,A.AddressTypeCode,                            ISNULL(O.OrderID,0) AS OrderNumber        FROM [Master].Members M                   INNER JOIN Orders.Orders O ON O.NHMemberId = M.NHMemberID and O.IsActive = 1    LEFT OUTER JOIN Orders.Orders O2 ON      O2.NhmemberId = M.NHMemberId     AND (      O.OrderId < O2.OrderId     )                   LEFT LOOP JOIN [Master].Addresses A WITH (NOLOCK) on (M.MemberID=A.MemberID and a.IsPreferredAddress=1) and A.IsActive = 1    LEFT OUTER JOIN Master.MemberInsurances MI WITH (NOLOCK) on (MI.MemberId = M.MemberID) and MI.IsActive =1    LEFT OUTER JOIN Master.MemberInsuranceDetails MID WITH (NOLOCK) on (MID.MemberInsuranceId = MI.ID) and MID.IsActive = 1    WHERE O.OrderId = @OrderId   END   ELSE IF (@NHMemberId IS NOT NULL)   BEGIN    INSERT INTO #results    SELECT TOP 1      M.MemberID,     M.NHMemberID NhMemberNbr,     M.FirstName,     CASE WHEN @FirstName IS NOT NULL THEN LEN(M.FirstName) END LFN,     M.LastName,     CASE WHEN @LastName IS NOT NULL THEN LEN(M.LastName) END LLN,     convert(varchar,(M.DateOfBirth),101) DOB,                           A.Address1 Address,A.Address2,A.City,A.State,A.Country,A.ZipCode zip,A.AddressTypeCode,                            ISNULL(O.OrderID,0) AS OrderNumber        FROM [Master].Members M                   LEFT JOIN Orders.Orders O ON O.NHMemberId = M.NHMemberID and O.IsActive = 1    LEFT OUTER JOIN Orders.Orders O2 ON      O2.NhmemberId = M.NHMemberId     AND (      O.OrderId < O2.OrderId     )                   LEFT LOOP JOIN [Mast
   CREATE Procedure [dbo].[sp_upgraddiagrams]   AS   BEGIN    IF OBJECT_ID(N'dbo.sysdiagrams') IS NOT NULL     return 0;       CREATE TABLE dbo.sysdiagrams    (     name sysname NOT NULL,     principal_id int NOT NULL, -- we may change it to varbinary(85)     diagram_id int PRIMARY KEY IDENTITY,     version int,        definition varbinary(max)     CONSTRAINT UK_principal_name UNIQUE     (      principal_id,      name     )    );        /* Add this if we need to have some form of extended properties for diagrams */    /*    IF OBJECT_ID(N'dbo.sysdiagram_properties') IS NULL    BEGIN     CREATE TABLE dbo.sysdiagram_properties     (      diagram_id int,      name sysname,      value varbinary(max) NOT NULL     )    END    */      IF OBJECT_ID(N'dbo.dtproperties') IS NOT NULL    begin     insert into dbo.sysdiagrams     (      [name],      [principal_id],      [version],      [definition]     )     select        convert(sysname, dgnm.[uvalue]),      DATABASE_PRINCIPAL_ID(N'dbo'),   -- will change to the sid of sa      0,       -- zero for old format, dgdef.[version],      dgdef.[lvalue]     from dbo.[dtproperties] dgnm      inner join dbo.[dtproperties] dggd on dggd.[property] = 'DtgSchemaGUID' and dggd.[objectid] = dgnm.[objectid]       inner join dbo.[dtproperties] dgdef on dgdef.[property] = 'DtgSchemaDATA' and dgdef.[objectid] = dgnm.[objectid]           where dgnm.[property] = 'DtgSchemaNAME' and dggd.[uvalue] like N'_EA3E6268-D998-11CE-9454-00AA00A3F36E_'      return 2;    end    return 1;   END     
CREATE PROCEDURE [dbo].[sp_SearchMemberCall_testdelete](               @MemberID           BIGINT = NULL,                @NHMemberID         NVARCHAR(50) = NULL,                @FirstName          NVARCHAR(250) = NULL,               @LastName           NVARCHAR(50) = NULL,               @DateOfBirth        DATETIME = NULL,               @Gender             NVARCHAR(10) = NULL,               @MaritalStatus      NVARCHAR(25) = NULL,               @Address1           NVARCHAR(500) = NULL,               @Address2           NVARCHAR(500) = NULL,               @City               NVARCHAR(50) = NULL,               @State              NVARCHAR(10) = NULL,               @Country            NVARCHAR(50) = NULL,               @ZipCode            NVARCHAR(10) = NULL,                @EmailAddress       NVARCHAR(50) = NULL,                @Phone               NVARCHAR(50) = NULL,               @InsuranceHealthPlanNumber NVARCHAR(250) = NULL,               @InsuranceHealthPlanName NVARCHAR(250) = NULL,               @InsuranceCarrierName NVARCHAR(250) = NULL,               @OrderID BIGINT = 0)        AS        BEGIN               SET NOCOUNT ON;              SET ANSI_WARNINGS OFF;             DECLARE @SQLQueryRes AS NVARCHAR(4000)               DECLARE @SQLQuery AS NVARCHAR(4000)               DECLARE @SQLQueryM AS NVARCHAR(2000)               DECLARE @SQLQueryA AS NVARCHAR(2000)               DECLARE @SQLQueryP AS NVARCHAR(2000)               DECLARE @SQLQueryI AS NVARCHAR(2000)               DECLARE @tables AS VARCHAR(50)               DECLARE @Where AS VARCHAR(500)               DECLARE @DateOfBirth1  AS VARCHAR(20) = NULL                       set @LastName = REPLACE(@LastName,'''','''''')                       set @FirstName = REPLACE(@FirstName,'''','''''')                       SET @DateOfBirth1 = cast(@DateOfBirth as datetime)                               SET @SQLQuery = 'SELECT DISTINCT TOP 100 M.MemberID, m.NHMEMBERID from '                       SET @SQLQueryM = 'Master.Members m where  1 = 1 '                       SET @SQLQueryP = 'Master.Members m , Master.PhoneNumbers p where 1 = 1 and m.memberid = p.memberid '                       SET @SQLQueryA = 'Master.Members m , Master.Addresses a where 1 = 1 and m.memberid = a.memberid '                       SET @SQLQueryI = 'master.members m where exists (select 1 from (               select mi.memberid from master.MemberInsurances mi               where exists (select 1 from Master.MemberInsuranceDetails mid where                                                                mid.memberinsuranceid = mi.id and mid.InsuranceNbr  = '                       if (@FirstName is not null )                      Begin                      set @tables = 'MEMBER'                      set @Where = ' and m.firstname like '''+@FirstName+'%'''                             if @ZipCode is not null                                    Begin                                          set @tables = 'MEMBERADDRESS'                                          set @Where = @Where + ' and a.ZipCode like '''+@ZipCode+'%'''                                 End                             else                                   Begin                                          if @LastName is not null                                                 set @Where = @Where + ' and m.lastname like '''+@LastName+'%'''                                          if @DateOfBirth1 is not null                                                 set @Where = @Where + ' and m.DateOfBirth = cast('''+@DateOfBirth1+''''+' as datetime)'                                   End                   End               else                if (@LastName is not null )                      Begin                      set @tables = 'MEMBER'                      set @Where = ' and m.lastname like '''+@LastName+'%'''                             if @ZipCode is not null                                    Begin                                          set @tables =
   CREATE Procedure [dbo].[sp_renamediagram]   (    @diagramname   sysname,    @owner_id  int = null,    @new_diagramname sysname      )   WITH EXECUTE AS 'dbo'   AS   BEGIN    set nocount on    declare @theId    int    declare @IsDbo    int        declare @UIDFound   int    declare @DiagId   int    declare @DiagIdTarg  int    declare @u_name   sysname    if((@diagramname is null) or (@new_diagramname is null))    begin     RAISERROR ('Invalid value', 16, 1);     return -1    end       EXECUTE AS CALLER;    select @theId = DATABASE_PRINCIPAL_ID();    select @IsDbo = IS_MEMBER(N'db_owner');     if(@owner_id is null)     select @owner_id = @theId;    REVERT;       select @u_name = USER_NAME(@owner_id)       select @DiagId = diagram_id, @UIDFound = principal_id from dbo.sysdiagrams where principal_id = @owner_id and name = @diagramname     if(@DiagId IS NULL or (@IsDbo = 0 and @UIDFound <> @theId))    begin     RAISERROR ('Diagram does not exist or you do not have permission.', 16, 1)     return -3    end       -- if((@u_name is not null) and (@new_diagramname = @diagramname)) -- nothing will change    -- return 0;       if(@u_name is null)     select @DiagIdTarg = diagram_id from dbo.sysdiagrams where principal_id = @theId and name = @new_diagramname    else     select @DiagIdTarg = diagram_id from dbo.sysdiagrams where principal_id = @owner_id and name = @new_diagramname       if((@DiagIdTarg is not null) and  @DiagId <> @DiagIdTarg)    begin     RAISERROR ('The name is already used.', 16, 1);     return -2    end         if(@u_name is null)     update dbo.sysdiagrams set [name] = @new_diagramname, principal_id = @theId where diagram_id = @DiagId    else     update dbo.sysdiagrams set [name] = @new_diagramname where diagram_id = @DiagId    return 0   END     
    CREATE Procedure [dbo].[sp_SearchMemberCall_Test](   -- Add the parameters for the stored procedure here   @MemberID           BIGINT = NULL,       @NHMemberID         NVARCHAR(50) = NULL,    @FirstName          NVARCHAR(250) = NULL,      @LastName           NVARCHAR(50) = NULL,   @DateOfBirth        DATETIME = NULL,   @Gender             NVARCHAR(10) = NULL,   @MaritalStatus      NVARCHAR(25) = NULL,   @Address1           NVARCHAR(500) = NULL,   @Address2           NVARCHAR(500) = NULL,   @City               NVARCHAR(50) = NULL,   @State              NVARCHAR(10) = NULL,   @Country            NVARCHAR(50) = NULL,   @ZipCode            NVARCHAR(10) = NULL,       @EmailAddress       NVARCHAR(50) = NULL,       @Phone               NVARCHAR(50) = NULL,   @InsuranceHealthPlanNumber NVARCHAR(250) = NULL,   @InsuranceHealthPlanName NVARCHAR(250) = NULL,   @InsuranceCarrierName NVARCHAR(250) = NULL)  AS  BEGIN   SET NOCOUNT ON;   DECLARE @SQLQueryRes AS NVARCHAR(4000)   DECLARE @SQLQuery AS NVARCHAR(4000)   DECLARE @SQLQueryM AS NVARCHAR(2000)   DECLARE @SQLQueryA AS NVARCHAR(2000)   DECLARE @SQLQueryP AS NVARCHAR(2000)   DECLARE @SQLQueryI AS NVARCHAR(2000)   DECLARE @tables AS VARCHAR(50)   DECLARE @Where AS VARCHAR(500)   DECLARE @DateOfBirth1  AS VARCHAR(20) = NULL     set @LastName = REPLACE(@LastName,'''','''''')     set @FirstName = REPLACE(@FirstName,'''','''''')     SET @DateOfBirth1 = cast(@DateOfBirth as datetime)       SET @SQLQuery = 'SELECT DISTINCT TOP 100 M.MemberID, m.NHMEMBERID from '     SET @SQLQueryM = 'Master.Members m where  1 = 1 '     SET @SQLQueryP = 'Master.Members m , Master.PhoneNumbers p where 1 = 1 and m.memberid = p.memberid '     SET @SQLQueryA = 'Master.Members m , Master.Addresses a where 1 = 1 and m.memberid = a.memberid '     SET @SQLQueryI = 'master.members m where exists (select 1 from (   select mi.memberid from master.MemberInsurances mi    where exists (select 1 from Master.MemberInsuranceDetails mid where           mid.memberinsuranceid = mi.id and mid.InsuranceNbr  = '     if (@FirstName is not null )    Begin    set @tables = 'MEMBER'    set @Where = ' and m.firstname like '''+@FirstName+'%'''     if @ZipCode is not null       Begin       set @tables = 'MEMBERADDRESS'       set @Where = @Where + ' and a.ZipCode like '''+@ZipCode+'%'''         End     else      Begin       if @LastName is not null        set @Where = @Where + ' and m.lastname like '''+@LastName+'%'''       if @DateOfBirth1 is not null        set @Where = @Where + ' and m.DateOfBirth = cast('''+@DateOfBirth1+''''+' as datetime)'      End       End   else     if (@LastName is not null )    Begin    set @tables = 'MEMBER'    set @Where = ' and m.lastname like '''+@LastName+'%'''     if @ZipCode is not null       Begin       set @tables = 'MEMBERADDRESS'       set @Where = @Where + ' and a.ZipCode like '''+@ZipCode+'%'''         End     else      Begin       if @FirstName is not null        set @Where = @Where + ' and m.firstname like '''+@FirstName+'%'''       if @DateOfBirth1 is not null        set @Where = @Where + ' and m.DateOfBirth = cast('''+@DateOfBirth1+''''+' as datetime)'      End       End   else if (@DateOfBirth1 is not null)    Begin     set @tables = 'MEMBER'     set @Where = ' and m.DateOfBirth = cast('''+@DateOfBirth1+''''+' as datetime)'    End   else if (@Phone is not null)    Begin     set @tables = 'PHONE'     set @Where = ' and p.PhoneNbr = '+@Phone    End   else if (@Address1 is not null)    Begin     set @tables = 'ADDRESS'     set @Where = ' and a.Address1 like '''+@Address1+'%'''     if @ZipCode is not null      set @Where = @Where + ' and a.ZipCode like '''+@ZipCode+'%'''    End   else if @InsuranceHealthPlanNumber is not null    Begin     set @tables = 'INSURANCE'     set  @Where = @Where + ' and mid.InsuranceNbr like ''%'+@InsuranceHealthPlanNumber+'%'''    End     IF @tables = 'MEMBER'    set @SQLQUERY = @SQLQUERY + @SQLQUERYM + @Where   else if @tables = 'ADDRESS'    set @SQLQUERY = @SQLQUERY 
CREATE PROCEDURE [dbo].[sp_SearchMemberPP](         @NHMemberID         NVARCHAR(50) = NULL,                                  @FirstName          NVARCHAR(250) = NULL,                                 @LastName           NVARCHAR(50) = NULL,                                 @DateOfBirth        VARCHAR(20) = NULL,                                 @Address1           NVARCHAR(500) = NULL,                                 @Address2           NVARCHAR(500) = NULL,                                 @City               NVARCHAR(50) = NULL,                                 @State              NVARCHAR(10) = NULL,                                 @ZipCode            NVARCHAR(10) = NULL,                                  @Phone               NVARCHAR(50) = NULL,                     @ProviderID NVARCHAR(50) = NULL,                           @searchType NVARCHAR(50) = NULL,                     @InsuranceHealthPlanNumber NVARCHAR(250) = NULL,                 @ProviderCode NVARCHAR(20) = NULL            )                          AS                          BEGIN                    DECLARE @SQLSubQuery AS NVARCHAR(4000)                    DECLARE @condition AS NVARCHAR(5)          if(@ProviderCode=NULL)          begin          SET @ProviderCode = (SELECT PROVIDERCODE FROM [provider].[ProviderProfiles] WHERE [ProviderId] = @ProviderID)          end          IF(@ProviderCode = '180000')          BEGIN    SET @SQLSubQuery = 'select distinct m.firstname,m.middlename,m.lastname,m.nhmemberid,convert(varchar(10), m.DateOfBirth, 101) as DateOfBirth,ml.address1,ml.address2,ml.city,ml.state,case when p.phonenumber = ''0'' then ''9999999999'' else p.phonenumber end phonenumber,ml.zipcode,                         convert(varchar(10),json_value(d.ProcessData, ''$.appointmentDate''),101) as appointmentDate,                 row_number() over (partition by nhmemberid order by  convert(varchar(10),json_value(d.ProcessData, ''$.appointmentDate''),101) desc) AS Rownum,                        ISNULL(CONCAT(up.FirstName, '''',up.LastName),'''') AS AppointmentWith,CONCAT(l.Address1,'' '','','',l.address2,'' '','','',l.city,'' '',l.state,'' '','','',l.zip) AS ApptLocationAddress,INS.InsuranceCarrierName ,INS.InsuranceNbr                   from [provider].[MemberProfiles] m                          inner join [provider].[MemberLocations] ml on ml.memberprofileid = m.memberprofileid and ml.isactive = 1   AND ml.IsPreferredAddress=1                     left outer join [provider].[MemberPhoneNumbers] p on p.memberprofileid = m.memberprofileid and p.isactive = 1                        inner join [provider].[MemberChartData] d on  json_value(d.ProcessData, ''$.MemberProfileId'') = m.memberprofileid and d.isactive = 1 and d.minorprocessid = 16                         LEFT JOIN [provider].[HCPProviderProfile] h ON h.HCPID = JSON_VALUE(D.ProcessData, ''$.HCPUserProfileId'') and h.isactive = 1                         LEFT JOIN [provider].[Locations] l ON l.LocationId = d.LocationId and l.isactive = 1               LEFT JOIN [provider].[ProviderUserLocations] pul ON pul.LocationId = d.LocationId and pul.isactive = 1              LEFT JOIN [auth].[UserProfiles] up ON up.UserProfileId = pul.UserProfileId AND up.isactive = 1 and  json_value(d.ProcessData, ''$.HCPUserProfileId'') = up.UserProfileId and CONCAT(up.FirstName, '''',up.LastName) <> ''''                  LEFT JOIN [dbo].[GetActiveInsuranceByMember] INS on INS.MemberProfileId=M.MemberProfileId         where m.isactive = 1 AND  ISNULL(CONCAT(up.FirstName, '''',up. LastName),'''')<> '''''  END          ELSE          BEGIN            SET @SQLSubQuery = 'select distinct m.firstname,m.middlename,m.lastname,m.nhmemberid,convert(varchar(10), m.DateOfBirth, 101) as DateOfBirth,ml.address1,ml.address2,ml.city,ml.state,case when p.phonenumber = ''0'' then ''9999999999'' else p.phonenumber end phonenumber,ml.zipcode,                         convert(varchar(10),json_value(d.ProcessData, ''$.appointmentDate''),101) as appointmentDate,row_
CREATE  procedure [dbo].[sp_GetBrands](@locationId bigint)  as  begin     select ROW_NUMBER() OVER (ORDER BY BrandCode) as RowID,LocationId, BrandCode,Dispenser,IsActive,LocationAccountNumberId    from [provider].[LocationsAccountNbrs] where LocationId = @locationId and IsActive = 1  end  
   CREATE Procedure [dbo].[sp_creatediagram]   (    @diagramname  sysname,    @owner_id  int = null,      @version   int,    @definition  varbinary(max)   )   WITH EXECUTE AS 'dbo'   AS   BEGIN    set nocount on       declare @theId int    declare @retval int    declare @IsDbo int    declare @userName sysname    if(@version is null or @diagramname is null)    begin     RAISERROR (N'E_INVALIDARG', 16, 1);     return -1    end       execute as caller;    select @theId = DATABASE_PRINCIPAL_ID();     select @IsDbo = IS_MEMBER(N'db_owner');    revert;         if @owner_id is null    begin     select @owner_id = @theId;    end    else    begin     if @theId <> @owner_id     begin      if @IsDbo = 0      begin       RAISERROR (N'E_INVALIDARG', 16, 1);       return -1      end      select @theId = @owner_id     end    end    -- next 2 line only for test, will be removed after define name unique    if EXISTS(select diagram_id from dbo.sysdiagrams where principal_id = @theId and name = @diagramname)    begin     RAISERROR ('The name is already used.', 16, 1);     return -2    end       insert into dbo.sysdiagrams(name, principal_id , version, definition)      VALUES(@diagramname, @theId, @version, @definition) ;        select @retval = @@IDENTITY     return @retval   END     
CREATE Procedure [dbo].[sp_generate_insertscripts]  (      @TABLENAME VARCHAR(MAX),      @FILTER_CONDITION VARCHAR(MAX)=''  )  AS  BEGIN    SET NOCOUNT ON    DECLARE @TABLE_NAME VARCHAR(MAX),          @CSV_COLUMN VARCHAR(MAX),          @QUOTED_DATA VARCHAR(MAX),          @TEXT VARCHAR(MAX),          @FILTER VARCHAR(MAX)     SET @TABLE_NAME=@TABLENAME    SELECT @FILTER=@FILTER_CONDITION    SELECT @CSV_COLUMN=STUFF  (      (       SELECT ',['+ NAME +']' FROM sys.all_columns        WHERE OBJECT_ID=OBJECT_ID(@TABLE_NAME) --AND        --is_identity!=1     FOR XML PATH('')      ),1,1,''  )    SELECT @QUOTED_DATA=STUFF  (      (       SELECT ' ISNULL(QUOTENAME('+NAME+','+QUOTENAME('''','''''')+'),'+'''NULL'''+')+'','''+'+' FROM sys.all_columns        WHERE OBJECT_ID=OBJECT_ID(@TABLE_NAME)     --AND is_identity!=1      FOR XML PATH('')      ),1,1,''  )    SELECT @TEXT='SELECT ''INSERT INTO '+@TABLE_NAME+'('+@CSV_COLUMN+')VALUES('''+'+'+SUBSTRING(@QUOTED_DATA,1,LEN(@QUOTED_DATA)-5)+'+'+''')'''+' Insert_Scripts FROM '+@TABLE_NAME + @FILTER    --SELECT @CSV_COLUMN AS CSV_COLUMN,@QUOTED_DATA AS QUOTED_DATA,@TEXT TEXT    EXECUTE (@TEXT)    SET NOCOUNT OFF    END  
   CREATE Procedure [dbo].[sp_dropdiagram]   (    @diagramname  sysname,    @owner_id int = null   )   WITH EXECUTE AS 'dbo'   AS   BEGIN    set nocount on    declare @theId    int    declare @IsDbo    int        declare @UIDFound   int    declare @DiagId   int       if(@diagramname is null)    begin     RAISERROR ('Invalid value', 16, 1);     return -1    end       EXECUTE AS CALLER;    select @theId = DATABASE_PRINCIPAL_ID();    select @IsDbo = IS_MEMBER(N'db_owner');     if(@owner_id is null)     select @owner_id = @theId;    REVERT;         select @DiagId = diagram_id, @UIDFound = principal_id from dbo.sysdiagrams where principal_id = @owner_id and name = @diagramname     if(@DiagId IS NULL or (@IsDbo = 0 and @UIDFound <> @theId))    begin     RAISERROR ('Diagram does not exist or you do not have permission.', 16, 1)     return -3    end       delete from dbo.sysdiagrams where diagram_id = @DiagId;       return 0;   END     
  -- EXEC [dbo].[sp_rpt_qb_ff_payment_checks_remittance]    CREATE procedure [dbo].[sp_rpt_qb_ff_payment_checks_remittance]   @BatchId bigint,  @CheckNumber bigint  as  select IP.*,  cp.PONumber, cp.paymentMethod,cp.paymentDate,cp.checkNum  from (    select   d.InvoiceBatchId  ,p.providerid  ,p.vendorName  ,p.paymentAmount  --,CAST(p.paymentDate AS DATE) paymentDate  ,i.invoiceId  ,CAST(i.date AS DATE) FittingDate  ,i.reference  ,i.originalAmount  ,i.payment  ,NULL as BalanceDue  ,NULL as Discount  ,'Bill' Type  from paymentgateway.invoicedata d  outer apply openjson(d.invoicecheckdata) with (         checks nvarchar(max) as json  ) f  outer apply openjson(f.checks) with(         providerId bigint,         vendorName varchar(200),         paymentAmount decimal(10,2),         paymentDate varchar(50),         invoices nvarchar(max) as json  ) p  outer apply openjson(p.invoices) with(         invoiceId bigint,         date varchar(50),         reference varchar(100),         originalAmount decimal(10,2),         payment decimal(10,2)  ) i  ) IP    left JOIN  (  select   i.InvoiceId,   i.PONumber  --, i.InvoiceAmount  --, JSON_VALUE(i.PaymentData,'$.invoicePayment') invoicePayment  , JSON_VALUE(i.PaymentData,'$.paymentMethod') paymentMethod  , i.BatchId  , JSON_VALUE(i.PaymentData,'$.payData.paymentDate') paymentDate,  cast(JSON_VALUE(i.PaymentData,'$.payData.checkNum') as bigint) checkNum  from accounts.Invoices i  where 1=1  and i.Status='Paid'  and BatchId is not null  ) CP ON (CP.InvoiceId=IP.invoiceId AND CP.BatchId=IP.InvoiceBatchId)  where 1=1  and IP.InvoiceBatchId=@BatchId  and cp.checkNum=@CheckNumber  
   CREATE Procedure [dbo].[sp_helpdiagrams]   (    @diagramname sysname = NULL,    @owner_id int = NULL   )   WITH EXECUTE AS N'dbo'   AS   BEGIN    DECLARE @user sysname    DECLARE @dboLogin bit    EXECUTE AS CALLER;     SET @user = USER_NAME();     SET @dboLogin = CONVERT(bit,IS_MEMBER('db_owner'));    REVERT;    SELECT     [Database] = DB_NAME(),     [Name] = name,     [ID] = diagram_id,     [Owner] = USER_NAME(principal_id),     [OwnerID] = principal_id    FROM     sysdiagrams    WHERE     (@dboLogin = 1 OR USER_NAME(principal_id) = @user) AND     (@diagramname IS NULL OR name = @diagramname) AND     (@owner_id IS NULL OR principal_id = @owner_id)    ORDER BY     4, 5, 1   END     
CREATE FUNCTION [dbo].[InitCap] ( @InputString varchar(4000) )   RETURNS VARCHAR(4000)  AS  BEGIN    DECLARE @Index          INT  DECLARE @Char           CHAR(1)  DECLARE @PrevChar       CHAR(1)  DECLARE @OutputString   VARCHAR(255)    SET @OutputString = LOWER(@InputString)  SET @Index = 1    WHILE @Index <= LEN(@InputString)  BEGIN      SET @Char     = SUBSTRING(@InputString, @Index, 1)      SET @PrevChar = CASE WHEN @Index = 1 THEN ' '                           ELSE SUBSTRING(@InputString, @Index - 1, 1)                      END        IF @PrevChar IN (' ', ';', ':', '!', '?', ',', '.', '_', '-', '/', '&', '''', '(')      BEGIN          IF @PrevChar != '''' OR UPPER(@Char) != 'S'              SET @OutputString = STUFF(@OutputString, @Index, 1, UPPER(@Char))      END        SET @Index = @Index + 1  END    RETURN @OutputString    END  
   CREATE Procedure [dbo].[sp_helpdiagramdefinition]   (    @diagramname  sysname,    @owner_id int = null      )   WITH EXECUTE AS N'dbo'   AS   BEGIN    set nocount on      declare @theId   int    declare @IsDbo   int    declare @DiagId  int    declare @UIDFound int       if(@diagramname is null)    begin     RAISERROR (N'E_INVALIDARG', 16, 1);     return -1    end       execute as caller;    select @theId = DATABASE_PRINCIPAL_ID();    select @IsDbo = IS_MEMBER(N'db_owner');    if(@owner_id is null)     select @owner_id = @theId;    revert;        select @DiagId = diagram_id, @UIDFound = principal_id from dbo.sysdiagrams where principal_id = @owner_id and name = @diagramname;    if(@DiagId IS NULL or (@IsDbo = 0 and @UIDFound <> @theId ))    begin     RAISERROR ('Diagram does not exist or you do not have permission.', 16, 1);     return -3    end      select version, definition FROM dbo.sysdiagrams where diagram_id = @DiagId ;     return 0   END     
CREATE Procedure [dbo].[sp_GetMemDetailsForCreateOrder]   @nhMemberId [nvarchar](50),   @memChartDataId bigint=0    AS  BEGIN      SET NOCOUNT ON   if(@memChartDataId = 0)     begin     SELECT  distinct       mp.NHMemberId,       mp.MemberProfileId,       mcd.[MemberChartDataId],          mcd.ProviderId,       mcd.LocationId as ProviderLocationId,       mi.InsuranceCarrierId,       mi.InsuranceHealthPlanID as HealthPlanId,       pgm.InsuranceCarrierID as ProgramInsuranceCarrierId,       pgm.InsuranceHealthPlanID as ProgramHealthPlanId,       pp.Brands as Brand         from provider.MemberProfiles mp       join provider.MemberCharts mc on mc.MemberProfileId=mp.MemberProfileId          join provider.MemberChartData mcd on mcd.MemberChartId = mc.MemberChartId      join provider.ProviderProfiles pp on pp.ProviderId = mcd.ProviderId      join provider.MemberInsurances mi on mi.MemberProfileId=mp.MemberProfileId      join provider.MemberProgramDetails pgm on pgm.MemberProfileId = mp.MemberProfileId              where mp.NHMemberId = @nhMemberId --and (getdate() > mi.[InsuranceEffectiveDate] and getdate() < mi.[InsuranceEndDate])      --order by mcd.[MemberChartDataId] desc    end    else      begin        SELECT  distinct        mp.NHMemberId,        mp.MemberProfileId,        mcd.[MemberChartDataId],           mcd.ProviderId,           mcd.LocationId as ProviderLocationId,        mi.InsuranceCarrierId,        mi.InsuranceHealthPlanID as HealthPlanId,        pgm.InsuranceCarrierID as ProgramInsuranceCarrierId,        pgm.InsuranceHealthPlanID as ProgramHealthPlanId,        pp.Brands as Brand          from provider.MemberProfiles mp       join provider.MemberCharts mc on mc.MemberProfileId=mp.MemberProfileId          join provider.MemberChartData mcd on mcd.MemberChartId = mc.MemberChartId      join provider.ProviderProfiles pp on pp.ProviderId = mcd.ProviderId      join provider.MemberInsurances mi on mi.MemberProfileId=mp.MemberProfileId      join provider.MemberProgramDetails pgm on pgm.MemberProfileId = mp.MemberProfileId      where mp.NHMemberId = @nhMemberId and mcd.MemberChartDataId = @memChartDataId --and (getdate() > mi.[InsuranceEffectiveDate] and getdate() < mi.[InsuranceEndDate])      --order by mcd.[MemberChartDataId] desc      end  END  
   CREATE Procedure [dbo].[sp_alterdiagram]   (    @diagramname  sysname,    @owner_id int = null,    @version  int,    @definition  varbinary(max)   )   WITH EXECUTE AS 'dbo'   AS   BEGIN    set nocount on       declare @theId    int    declare @retval   int    declare @IsDbo    int        declare @UIDFound   int    declare @DiagId   int    declare @ShouldChangeUID int       if(@diagramname is null)    begin     RAISERROR ('Invalid ARG', 16, 1)     return -1    end       execute as caller;    select @theId = DATABASE_PRINCIPAL_ID();      select @IsDbo = IS_MEMBER(N'db_owner');     if(@owner_id is null)     select @owner_id = @theId;    revert;       select @ShouldChangeUID = 0    select @DiagId = diagram_id, @UIDFound = principal_id from dbo.sysdiagrams where principal_id = @owner_id and name = @diagramname         if(@DiagId IS NULL or (@IsDbo = 0 and @theId <> @UIDFound))    begin     RAISERROR ('Diagram does not exist or you do not have permission.', 16, 1);     return -3    end       if(@IsDbo <> 0)    begin     if(@UIDFound is null or USER_NAME(@UIDFound) is null) -- invalid principal_id     begin      select @ShouldChangeUID = 1 ;     end    end      -- update dds data       update dbo.sysdiagrams set definition = @definition where diagram_id = @DiagId ;      -- change owner    if(@ShouldChangeUID = 1)     update dbo.sysdiagrams set principal_id = @theId where diagram_id = @DiagId ;      -- update dds version    if(@version is not null)     update dbo.sysdiagrams set version = @version where diagram_id = @DiagId ;      return 0   END     
  CREATE PROCEDURE [dbo].[sp_SearchMemberCall_BK_2019DEC30]  (               @MemberID           BIGINT = NULL,                @NHMemberID         NVARCHAR(50) = NULL,                @FirstName          NVARCHAR(250) = NULL,               @LastName           NVARCHAR(50) = NULL,               @DateOfBirth        DATETIME = NULL,           @Gender             NVARCHAR(10) = NULL,               @MaritalStatus      NVARCHAR(25) = NULL,               @Address1           NVARCHAR(500) = NULL,               @Address2           NVARCHAR(500) = NULL,               @City               NVARCHAR(50) = NULL,               @State              NVARCHAR(10) = NULL,               @Country            NVARCHAR(50) = NULL,               @ZipCode            NVARCHAR(10) = NULL,                @EmailAddress       NVARCHAR(50) = NULL,                @Phone               NVARCHAR(50) = NULL,               @InsuranceHealthPlanNumber NVARCHAR(250) = NULL,        @OTCCardNumber    NVARCHAR(100) = NULL,            @InsuranceHealthPlanName NVARCHAR(250) = NULL,               @InsuranceCarrierName NVARCHAR(250) = NULL,           @SearchFilterCarrierId  NVARCHAR(250) = NULL,         @OrderID BIGINT = 0)        AS        BEGIN            SET NOCOUNT ON;     IF OBJECT_ID('tempdb..#results') IS NOT NULL   BEGIN    DROP TABLE #results   END        DECLARE @DateOfBirth1  AS VARCHAR(20) = NULL        SET @LastName = REPLACE(@LastName,'''','''''')        SET @FirstName = REPLACE(@FirstName,'''','''''')         SET @DateOfBirth1 = cast(@DateOfBirth as datetime)     DECLARE @Top BIGINT = CASE WHEN @NHMemberId IS NULL THEN 50 ELSE 1 END     CREATE TABLE #results (    MemberID BIGINT,    NHMemberNbr VARCHAR(100),    FirstName VARCHAR(100),    LastName VARCHAR(100),    DOB   VARCHAR(50),    Address  VARCHAR(200),    Address2 VARCHAR(200),    City  VARCHAR(100),    State  VARCHAR(50),    Country  VARCHAR(100),    Zip   VARCHAR(20),    AddressTypeCode VARCHAR(10),    OrderNumber BIGINT   )     IF (@OrderID IS NOT NULL AND @OrderID > 0)            BEGIN    INSERT INTO #results    SELECT TOP 1      M.MemberID,     M.NHMemberID NhMemberNbr,     M.FirstName,     M.LastName,     convert(varchar,(M.DateOfBirth),101) DOB,                           A.Address1 Address,A.Address2,A.City,A.State,A.Country,A.ZipCode zip,A.AddressTypeCode,                            ISNULL(O.OrderID,0) AS OrderNumber        FROM [Master].Members M                   LEFT JOIN Orders.Orders O ON O.NHMemberId = M.NHMemberID and O.IsActive = 1    LEFT OUTER JOIN Orders.Orders O2 ON      O2.NhmemberId = M.NHMemberId     AND (      O.OrderId < O2.OrderId     )                   LEFT LOOP JOIN [Master].Addresses A WITH (NOLOCK) on (M.MemberID=A.MemberID and a.IsPreferredAddress=1) and A.IsActive = 1    LEFT OUTER JOIN Master.MemberInsurances MI WITH (NOLOCK) on (MI.MemberId = M.MemberID) and MI.IsActive =1    LEFT OUTER JOIN Master.MemberInsuranceDetails MID WITH (NOLOCK) on (MID.MemberInsuranceId = MI.ID) and MID.IsActive = 1    WHERE O.OrderId = @OrderId   END   ELSE IF (@NHMemberId IS NOT NULL)   BEGIN    INSERT INTO #results    SELECT TOP 1      M.MemberID,     M.NHMemberID NhMemberNbr,     M.FirstName,     M.LastName,     convert(varchar,(M.DateOfBirth),101) DOB,                           A.Address1 Address,A.Address2,A.City,A.State,A.Country,A.ZipCode zip,A.AddressTypeCode,                            ISNULL(O.OrderID,0) AS OrderNumber        FROM [Master].Members M                   LEFT JOIN Orders.Orders O ON O.NHMemberId = M.NHMemberID and O.IsActive = 1    LEFT OUTER JOIN Orders.Orders O2 ON      O2.NhmemberId = M.NHMemberId     AND (      O.OrderId < O2.OrderId     )                   LEFT LOOP JOIN [Master].Addresses A WITH (NOLOCK) on (M.MemberID=A.MemberID and a.IsPreferredAddress=1) and A.IsActive = 1    LEFT OUTER JOIN Master.MemberInsurances MI WITH (NOLOCK) on (MI.MemberId = M.MemberID) and MI.IsActive =1    LEFT OUTER JOIN Master.MemberInsuranceDetails MID WITH (NOLOCK) on (MID.MemberIns
-- =====================================================================================================  -- Author:      BHANU PRAKASH INTURI  -- Create Date: 13-NOV-2017  -- Description: SCRIPTS FOR EXECUTE INSURANCE HEALTH PLAN CONTRACT DETAILS IN PRODUCTION  -- SELECT * FROM [Insurance].[HealthPlanContracts]   -- EXEC DeleteInsHealthPlanContracts 55, 'DELETE'  -- =====================================================================================================  CREATE Procedure [dbo].[DeleteInsHealthPlanContracts]   -- Add the parameters for the stored procedure here        @healthPlanContractID BIGINT = 0,         @operationType Nvarchar(10)           AS  BEGIN   -- SET NOCOUNT ON added to prevent extra result sets from   -- interfering with SELECT statements.   SET NOCOUNT ON;      -- Insert statements for procedure here   IF @operationType = 'DELETE'   BEGIN      UPDATE  [Insurance].[HealthPlanContracts]     SET  IsActive = 0           WHERE   HealthPlanContractID = @healthPlanContractID   END     END  
-- =====================================================================================================  -- Author:      BHANU PRAKASH INTURI  -- Create Date: 13-NOV-2017  -- Description: SCRIPTS FOR EXECUTE INSURANCE TOLL FREE NUMBER DETAILS IN PRODUCTION  --SELECT * FROM [Insurance].[HealthPlanTollFreeNumbers]  --  @healthPlanTollID  @operationType   --EXEC DeleteInsHealthPlanTollFreeNumbers 38,  0, 'DELETE'  -- =====================================================================================================  CREATE Procedure [dbo].[DeleteInsHealthPlanTollFreeNumbers]   -- Add the parameters for the stored procedure here       @healthPlanTollID bigint = 0,           @operationType Nvarchar(10)           AS  BEGIN   -- SET NOCOUNT ON added to prevent extra result sets from   -- interfering with SELECT statements.   SET NOCOUNT ON;      -- Insert statements for procedure here   IF @operationType = 'DELETE'   BEGIN      UPDATE  [Insurance].[HealthPlanTollFreeNumbers]     SET  IsActive = 0      WHERE   HealthPlanTollID = @healthPlanTollID   END     END  
-- =====================================================================================================  -- Author:      BHANU PRAKASH INTURI  -- Create Date: 13-NOV-2017  -- Description: SCRIPTS FOR EXECUTE INSURANCE HEALTH PLAN DETAILS IN PRODUCTION  -- SELECT * FROM [INSURANCE].[InsuranceHealthPlans]  -- SERIAL WISE -->  @createDateTime, @createSource, @insuranceHealthPlanID [If Insert it will be 0], @healthPlanName, @healthPlanNumber, @insuranceCarrierID, @operationType  -- EXEC DeleteInsHealthPlans 38,  'DELETE'    -- =====================================================================================================  CREATE Procedure [dbo].[DeleteInsHealthPlans]   -- Add the parameters for the stored procedure here                           @insuranceHealthPlanID bigint = 0,           @isActive BIT,               @operationType Nvarchar(10)             AS  BEGIN   -- SET NOCOUNT ON added to prevent extra result sets from   -- interfering with SELECT statements.   SET NOCOUNT ON;      -- Insert statements for procedure here       IF @operationType = 'DELETE'   BEGIN      UPDATE  [Insurance].[InsuranceHealthPlans]     SET  IsActive = 0      WHERE   InsuranceHealthPlanID = @insuranceHealthPlanID   END     END  
  CREATE FUNCTION [dbo].[fn_GetInvoiceAmount](@BatchID BIGINT,@VendorType NVARCHAR(10)) RETURNS FLOAT  AS  BEGIN  DECLARE @Counter FLOAT;  SET @Counter  = (SELECT SUM(InvoiceAmount) FROM (SELECT distinct pp.ProviderName AS 'ProviderName',inv.InvoiceID,  JSON_VALUE(iit.[ItemData], '$.nhMemberId') AS 'NHMemberID',inv.PONumber,JSON_VALUE(iit.[ItemData], '$.orderStatus') AS 'OrderStatus',  JSON_VALUE(iit.[ItemData], '$.fittingDate') AS 'FittingDate',  JSON_VALUE(iit.[ItemData], '$.memberFirstName')  + ' ' +  JSON_VALUE(iit.[ItemData], '$.memberLastName') AS 'MemberName',  CAST(JSON_VALUE(iit.[ItemData], '$.dispensingFee') AS FLOAT) AS 'DispensingFee',CAST(InvoiceAmount AS FLOAT) AS InvoiceAmount,  cast(isnull(json_value(inv.PaymentData, '$.creditApplied'), 0) as float) AS Credit,  (InvoiceAmount - (case inv.[Status] when 'InProcess' then isnull(cast(json_value(inv.[PaymentData], '$.invoicePayment') as float), 0) when 'Paid' then isnull(cast(json_value(inv.[PaymentData], '$.invoicePayment') as float), 0) when 'Authorize' then isnull(cast(json_value(inv.[PaymentData], '$.invoicePayment') as float), 0) else 0 end) - CAST(0 AS FLOAT)) AS InvoicesSelected,BatchID  FROM [accounts].[invoices] AS inv INNER JOIN [accounts].[InvoiceItems] iit on inv.InvoiceId = iit.InvoiceId  INNER  JOIN (SELECT * FROM accounts.InvoiceTransactions AS it WHERE it.[Status]='Approval' AND it.IsActive=1) AS invt  ON inv.InvoiceId = invt.InvoiceId INNER JOIN provider.providerprofiles AS pp ON inv.ProviderId = pp.ProviderId   WHERE (inv.VendorType=@VendorType) AND inv.[Status]='Approval' AND inv.ProviderId IS NOT NULL AND inv.BatchID = @BatchID) r)  RETURN @Counter  END  
-- =======================================================  -- Create Stored Procedure Template for Azure SQL Database  -- =======================================================  -- =============================================  -- Author:      BHANU PRAKASH INTURI  -- Create Date: 15-NOV-2017  -- Description: INSERT CALL CENTER AGENT SCRIPTS  --select * from [CallCenter].[AgentScripts]  -- =============================================  CREATE Procedure [dbo].[DeleteAgentScripts]  (      -- Add the parameters for the stored procedure here     @scriptID BIGINT,       @operationType NVARCHAR(10)    )  AS  BEGIN      -- SET NOCOUNT ON added to prevent extra result sets from      -- interfering with SELECT statements.      SET NOCOUNT ON       -- Insert statements for procedure here         IF @operationType = 'DELETE'   BEGIN   UPDATE [CallCenter].[AgentScripts]    SET    IsActive = 0    WHERE ScriptID = @scriptID   END  END  
  CREATE FUNCTION [dbo].[fn_GetInvoiceCount](@BatchID BIGINT,@VendorType NVARCHAR(10)) RETURNS INT  AS  BEGIN  DECLARE @Counter INT;  SET @Counter  = (SELECT COUNT(*)  AS InvoiceCount FROM (SELECT distinct pp.ProviderName AS 'ProviderName',inv.InvoiceID,  JSON_VALUE(iit.[ItemData], '$.nhMemberId') AS 'NHMemberID',inv.PONumber,JSON_VALUE(iit.[ItemData], '$.orderStatus') AS 'OrderStatus',  JSON_VALUE(iit.[ItemData], '$.fittingDate') AS 'FittingDate',  JSON_VALUE(iit.[ItemData], '$.memberFirstName')  + ' ' +  JSON_VALUE(iit.[ItemData], '$.memberLastName') AS 'MemberName',  CAST(JSON_VALUE(iit.[ItemData], '$.dispensingFee') AS FLOAT) AS 'DispensingFee',CAST(InvoiceAmount AS FLOAT) AS InvoiceAmount,  cast(isnull(json_value(inv.PaymentData, '$.creditApplied'), 0) as float) AS Credit,  (InvoiceAmount - (case inv.[Status] when 'InProcess' then isnull(cast(json_value(inv.[PaymentData], '$.invoicePayment') as float), 0) when 'Paid' then isnull(cast(json_value(inv.[PaymentData], '$.invoicePayment') as float), 0) when 'Authorize' then isnull(cast(json_value(inv.[PaymentData], '$.invoicePayment') as float), 0) else 0 end) - CAST(0 AS FLOAT)) AS InvoicesSelected,BatchID  FROM [accounts].[invoices] AS inv INNER JOIN [accounts].[InvoiceItems] iit on inv.InvoiceId = iit.InvoiceId  INNER  JOIN (SELECT * FROM accounts.InvoiceTransactions AS it WHERE it.[Status]='Approval' AND it.IsActive=1) AS invt  ON inv.InvoiceId = invt.InvoiceId INNER JOIN provider.providerprofiles AS pp ON inv.ProviderId = pp.ProviderId   WHERE (inv.VendorType=@VendorType) AND inv.[Status]='Approval' AND inv.ProviderId IS NOT NULL AND inv.BatchID = @BatchID) r)  RETURN @Counter  END    
-- ================================================  -- Template generated from Template Explorer using:  -- Alter Procedure (New Menu).SQL  --  -- Use the Specify Values for Template Parameters   -- command (Ctrl-Shift-M) to fill in the parameter   -- values below.  --  -- This block of comments will not be included in  -- the definition of the procedure.  -- ================================================    -- =====================================================================================================  -- Author:      BHANU PRAKASH INTURI  -- Create Date: 13-NOV-2017  -- Description: SCRIPTS FOR EXECUTE INSURANCE HEALTH PLAN BENEFIT DETAILS IN PRODUCTION  --SELECT * FROM Insurance.ContractBenefits  -- @ContractBenefitID , @operationType      --EXEC DeleteInsHealthPlanBenefits 20035,  'DELETE'    -- =====================================================================================================  CREATE Procedure [dbo].[DeleteInsHealthPlanBenefits]   -- Add the parameters for the stored procedure here       @ContractBenefitID bigint = 0,       @operationType nVarchar(10)        AS  BEGIN   -- SET NOCOUNT ON added to prevent extra result sets from   -- interfering with SELECT statements.   SET NOCOUNT ON;      -- Insert statements for procedure here   IF @operationType = 'DELETE'   BEGIN      UPDATE  [Insurance].[ContractBenefits]     SET  IsActive = 0            WHERE   ContractBenefitID = @ContractBenefitID   END   END  
  CREATE FUNCTION [dbo].[GetShippingAmount](@BrandCode NVARCHAR(30)) RETURNS FLOAT  AS  BEGIN  DECLARE @ShippingAmount FLOAT;  SET @ShippingAmount  = (SELECT ShippingAmount FROM [catalog].[BrandShippingFees] WHERE BrandCode = @BrandCode);  RETURN @ShippingAmount;  END  
  -- ================================================  -- Template generated from Template Explorer using:  -- Alter Procedure (New Menu).SQL  --  -- Use the Specify Values for Template Parameters   -- command (Ctrl-Shift-M) to fill in the parameter   -- values below.  --  -- This block of comments will not be included in  -- the definition of the procedure.  -- ================================================  -- =====================================================================================================  -- Author:      BHANU PRAKASH INTURI  -- Create Date: 13-NOV-2017  -- Description: SOFT DELETE FOR INSURANCE CARRIER DETAILS IN PRODUCTION    --SELECT * FROM [INSURANCE].[InsuranceCarriers]      -- @insuranceCarrierID, @isActive, @operationType  --EXEC DeleteInsCarriers 9, 1, 'DELETE'  -- =====================================================================================================  CREATE Procedure [dbo].[DeleteInsCarriers]   -- Add the parameters for the stored procedure here           @insuranceCarrierID BIGINT = 0,       @operationType Nvarchar(10)             AS  BEGIN   -- SET NOCOUNT ON added to prevent extra result sets from   -- interfering with SELECT statements.   SET NOCOUNT ON;      -- Insert statements for procedure here   IF @operationType = 'DELETE'   BEGIN    UPDATE [Insurance].[InsuranceCarriers]     SET IsActive = 0    WHERE InsuranceCarrierID = @insuranceCarrierID    END  END    
CREATE FUNCTION [dbo].[GetCOGSPrice](@InsuranceCarrierID BIGINT, @InsuranceHealthPlanID BIGINT, @FamilyProductCode NVARCHAR(50)) RETURNS FLOAT  AS  BEGIN  DECLARE @COGSPrice FLOAT;  SET @COGSPrice = (SELECT PerDeviceCOGSPrice FROM [insurance].[ContractProducts]   WHERE HealthPlanContractID IN (SELECT TOP 1 HealthPlanContractID FROM [insurance].[HealthPlanContracts] WHERE InsuranceCarrierID = @InsuranceCarrierID AND InsuranceHealthPlanID  = @InsuranceHealthPlanID)   AND FamilyProductCode = @FamilyProductCode)  RETURN @COGSPrice;  END  
-- =====================================================================================================  -- Author:      BHANU PRAKASH INTURI  -- Create Date: 13-NOV-2017  -- Description: SCRIPTS FOR EXECUTE INSURANCE HEALTH PLAN PRODUCT DETAILS IN PRODUCTION  --   --SELECT * FROM Insurance.ContractProducts  --@contractProductID,  @operationType      --EXEC DeleteInsHealthPlanContractProducts 20229,'DELETE'  -- =====================================================================================================  CREATE Procedure [dbo].[DeleteInsHealthPlanContractProducts]   -- Add the parameters for the stored procedure here      @contractProductID BIGINT =0,      @operationType NVARCHAR(10)          AS  BEGIN   -- SET NOCOUNT ON added to prevent extra result sets from   -- interfering with SELECT statements.   SET NOCOUNT ON;      -- Insert statements for procedure here    IF @operationType = 'DELETE'   BEGIN      UPDATE  [Insurance].[ContractProducts]     SET          IsActive = 0           WHERE   ContractProductID = @contractProductID   END   END  
-- =====================================================================================================  --SELECT * FROM [Insurance].[ContractProducts]   --EXEC InsertorUpdateInsHealthPlanContractProducts 1, 'GNR',  'Scripts', 'Prem', null, 'RS Trust 17', 53, null, 1,  'Scripts', 1008, 600, 2250  -- =====================================================================================================  CREATE Procedure [dbo].[InsertorUpdateInsHealthPlanContractProducts]   -- Add the parameters for the stored procedure here      @contractProductID BIGINT =0,      @brandCode NVARCHAR(MAX) = NULL,          @CreateUser NVARCHAR(MAX) = NULL,      @familyProductCatCode NVARCHAR(MAX)= NULL,      @familyProductCategoryFamilyProductID BIGINT = NULL,      @familyProductCode NVARCHAR(MAX) = NULL,      @healthPlanContractID INT,      @healthPlanContractID1 BIGINT,      @isActive BIT,          @modifyUser NVARCHAR(MAX) = NULL,      @perDeviceCOGSPrice FLOAT,      @perDeviceDispensingFee FLOAT,      @perDeviceMemberPrice FLOAT              AS  BEGIN   -- SET NOCOUNT ON added to prevent extra result sets from   -- interfering with SELECT statements.   SET NOCOUNT ON;      -- Insert statements for procedure here   if exists (SELECT 1 FROM [Insurance].[ContractProducts]  WHERE ContractProductID = @contractProductID and FamilyProductCatCode = @familyProductCatCode and FamilyProductCode = @familyProductCode and HealthPlanContractID = @healthPlanContractID)   BEGIN    UPDATE  [Insurance].[ContractProducts]     SET      BrandCode = @brandCode,         FamilyProductCatCode = @familyProductCatCode,       FamilyProductCategoryFamilyProductID = @familyProductCategoryFamilyProductID,       FamilyProductCode = UPPER(@familyProductCode),       HealthPlanContractID = @healthPlanContractID,       HealthPlanContractID1 = @healthPlanContractID1,       IsActive = @isActive,       ModifyDate = getdate(),       ModifyUser = @modifyUser,       PerDeviceCOGSPrice =@perDeviceCOGSPrice ,       PerDeviceDispensingFee = @perDeviceDispensingFee,       PerDeviceMemberPrice = @perDeviceMemberPrice       WHERE   ContractProductID = @contractProductID   END   ELSE    BEGIN    INSERT INTO  [Insurance].[ContractProducts]         (            BrandCode,       CreateDate,       CreateUser,       FamilyProductCatCode,       FamilyProductCategoryFamilyProductID,       FamilyProductCode,       HealthPlanContractID,       HealthPlanContractID1,       IsActive,       ModifyDate,       ModifyUser,       PerDeviceCOGSPrice,       PerDeviceDispensingFee,       PerDeviceMemberPrice      )   Values  (      @brandCode,      getdate(),      @CreateUser,      @familyProductCatCode,      @familyProductCategoryFamilyProductID,      UPPER(@familyProductCode),      @healthPlanContractID,      @healthPlanContractID1,      @isActive,      getdate(),      @modifyUser,      @perDeviceCOGSPrice,      @perDeviceDispensingFee,      @perDeviceMemberPrice      )    END   END  
    -- 2020-08-21 - Mohan commented out 1=1  -- 2020-08-16 - Mohan applied [Search Performance Fix:] by commenting joins to pull OrderIds   -- 2020-07-27 - Damian Montero - Ran on Stage  -- 2020-07-30 - Mohan Nanduri  - Ran on Prod  /*   Add feature - Search with PO Number     select top 10 * from Orders.OrderPOs order by OrderId desc     EXEC [dbo].[sp_SearchMemberCall] 0,NULL,NULL,NULL,NULL,NULL,NULL,NULL,NULL,NULL,NULL,NULL,NULL,NULL,NULL,NULL,NULL,NULL,NULL,NULL,0,20200002122;  */      CREATE   PROCEDURE [dbo].[sp_SearchMemberCall_1SEP2020]  (               @MemberID           BIGINT = NULL,                @NHMemberID         NVARCHAR(50) = NULL,                @FirstName          NVARCHAR(250) = NULL,               @LastName           NVARCHAR(50) = NULL,               @DateOfBirth        DATETIME = NULL,           @Gender             NVARCHAR(10) = NULL,               @MaritalStatus      NVARCHAR(25) = NULL,               @Address1           NVARCHAR(500) = NULL,               @Address2           NVARCHAR(500) = NULL,               @City               NVARCHAR(50) = NULL,               @State              NVARCHAR(10) = NULL,               @Country            NVARCHAR(50) = NULL,               @ZipCode            NVARCHAR(10) = NULL,                @EmailAddress       NVARCHAR(50) = NULL,                @Phone               NVARCHAR(50) = NULL,               @InsuranceHealthPlanNumber NVARCHAR(250) = NULL,        @OTCCardNumber    NVARCHAR(100) = NULL,            @InsuranceHealthPlanName NVARCHAR(250) = NULL,               @InsuranceCarrierName NVARCHAR(250) = NULL,           @SearchFilterCarrierId  NVARCHAR(250) = NULL,         @OrderID BIGINT = 0,      @PONumber BIGINT = 0  )        AS        BEGIN            SET NOCOUNT ON;     IF OBJECT_ID('tempdb..#results') IS NOT NULL   BEGIN    DROP TABLE #results   END        DECLARE @DateOfBirth1  AS VARCHAR(20) = NULL        SET @LastName = REPLACE(@LastName,'''','''''')        SET @FirstName = REPLACE(@FirstName,'''','''''')         SET @DateOfBirth1 = cast(@DateOfBirth as datetime)     DECLARE @Top BIGINT = CASE WHEN @NHMemberId IS NULL THEN 50 ELSE 1 END     CREATE TABLE #results (    MemberID BIGINT,    NHMemberNbr VARCHAR(100),    FirstName VARCHAR(100),    LastName VARCHAR(100),    DOB   VARCHAR(50),    Address  VARCHAR(200),    Address2 VARCHAR(200),    City  VARCHAR(100),    State  VARCHAR(50),    Country  VARCHAR(100),    Zip   VARCHAR(20),    AddressTypeCode VARCHAR(10),    OrderNumber BIGINT   )     IF (@OrderID IS NOT NULL AND @OrderID > 0)            BEGIN    INSERT INTO #results    SELECT TOP 1      M.MemberID,     M.NHMemberID NhMemberNbr,     M.FirstName,     M.LastName,     convert(varchar,(M.DateOfBirth),101) DOB,                           A.Address1 Address,A.Address2,A.City,A.State,A.Country,A.ZipCode zip,A.AddressTypeCode,                            ISNULL(O.OrderID,0) AS OrderNumber        FROM [Master].Members M                   INNER JOIN Orders.Orders O ON O.NHMemberId = M.NHMemberID and O.IsActive = 1    LEFT OUTER JOIN Orders.Orders O2 ON      O2.NhmemberId = M.NHMemberId     AND (      O.OrderId < O2.OrderId     )                   LEFT LOOP JOIN [Master].Addresses A WITH (NOLOCK) on (M.MemberID=A.MemberID and a.IsPreferredAddress=1) and A.IsActive = 1    WHERE O.OrderId = @OrderId   END   ELSE IF (@PONumber IS NOT NULL AND @PONumber > 0)            BEGIN    INSERT INTO #results    SELECT TOP 1      M.MemberID,     M.NHMemberID NhMemberNbr,     M.FirstName,     M.LastName,     convert(varchar,(M.DateOfBirth),101) DOB,                           A.Address1 Address,A.Address2,A.City,A.State,A.Country,A.ZipCode zip,A.AddressTypeCode,                            ISNULL(O.OrderID,0) AS OrderNumber        FROM [Master].Members M                   INNER JOIN Orders.Orders O ON O.NHMemberId = M.NHMemberID and O.IsActive = 1    INNER JOIN Orders.OrderPOs PO ON PO.OrderId= O.OrderID and PO.IsActive = 1    LEFT LOOP JOIN [Master].Addresses A WITH (NOLOCK) on (M
-- =====================================================================================================  --SELECT * FROM [Insurance].[InsuranceCarriers]     --EXEC InsertorUpdateInsCarriers 7, 'Scripts', 'GEHA_FEHBP', 1, 0, 'Scripts', 0  -- =====================================================================================================  CREATE Procedure [dbo].[InsertorUpdateInsCarriers]     -- Add the parameters for the stored procedure here          @insuranceCarrierID BIGINT = 0,             @createSource NVARCHAR(150),              @insuranceCarrierName NVARCHAR(50),          @isActive BIT,          @memberDataFileProvided BIT,             @modifySource NVARCHAR(150),         @isDiscountProgram bit,    @custServiceAddress1 nvarchar(200),    @custServiceAddress2  nvarchar(200),    @custServiceCity  nvarchar(100),    @custServiceState  nvarchar(100),    @custServiceZipCode  nvarchar(10),    @custServicePhoneNbr bigint,    @custServiceEmailAddress  nvarchar(100),    @claimsAddress1  nvarchar(200),    @claimsAddress2  nvarchar(200),    @claimsCity  nvarchar(100),    @claimsState  nvarchar(100),    @claimsZipCode  nvarchar(10),    @claimsPhoneNbr bigint,    @claimsEmailAddress  nvarchar(100),    @isContracted bit      AS    BEGIN     -- SET NOCOUNT ON added to prevent extra result sets from     -- interfering with SELECT statements.     SET NOCOUNT ON;     --reseeded the identity column in the table     --end      -- Insert statements for procedure here    if not exists (SELECT 1 FROM [Insurance].[InsuranceCarriers])  BEGIN   DBCC CHECKIDENT ('[Insurance].[InsuranceCarriers]', RESEED, 1)   END  if exists (SELECT 1 FROM [Insurance].[InsuranceCarriers] WHERE INSURANCECARRIERNAME = @insuranceCarrierName)   BEGIN    UPDATE  [Insurance].[InsuranceCarriers]        SET  InsuranceCarrierName = @insuranceCarrierName,         IsActive = @isActive,          MemberDataFileProvided= @memberDataFileProvided,          ModifyDate = getdate(),          ModifyUser = @modifySource,       IsDiscountProgram = @isDiscountProgram,        CustServiceAddress1 = @custServiceAddress1,     CustServiceAddress2 = @custServiceAddress2,     CustServiceCity = @custServiceCity,     CustServiceState = @custServiceState,     CustServiceZipCode = @custServiceZipCode,     CustServicePhoneNbr = @custServicePhoneNbr,     CustServiceEmailAddress = @custServiceEmailAddress,     ClaimsAddress1 = @claimsAddress1,     ClaimsAddress2 = @claimsAddress2,     ClaimsCity = @claimsCity,     ClaimsState = @claimsState,     ClaimsZipCode = @claimsZipCode,     ClaimsPhoneNbr = @claimsPhoneNbr,     ClaimsEmailAddress =  @claimsEmailAddress,     IsContracted =  @isContracted    WHERE   InsuranceCarrierID = @insuranceCarrierID     END   ELSE    BEGIN   INSERT INTO [Insurance].[InsuranceCarriers]         (Createdate,          CreateUser,          InsuranceCarrierName,          IsActive,          MemberDataFileProvided,          ModifyDate,          ModifyUser,    IsDiscountProgram,    CustServiceAddress1,    CustServiceAddress2,    CustServiceCity,    CustServiceState,    CustServiceZipCode,    CustServicePhoneNbr,    CustServiceEmailAddress,    ClaimsAddress1,    ClaimsAddress2,    ClaimsCity,    ClaimsState,    ClaimsZipCode,    ClaimsPhoneNbr,    ClaimsEmailAddress,    IsContracted    )          VALUES  (getdate(),         @createSource,          @insuranceCarrierName,          @isActive,          @memberDataFileProvided,          getdate(),          @modifySource,    @isDiscountProgram,    @custServiceAddress1,    @custServiceAddress2,    @custServiceCity,    @custServiceState,    @custServiceZipCode,    @custServicePhoneNbr,    @custServiceEmailAddress,    @claimsAddress1,    @claimsAddress2,    @claimsCity,    @claimsState,    @claimsZipCode,    @claimsPhoneNbr,    @claimsEmailAddress,    @isContracted    )     END     END    
-- =============================================    --select * from [CallCenter].[AgentScripts]  --EXEC InsertorUpdateAgentScripts  @scriptID [VALUE BE 0 WHEN INSERTING], @createUser, @isActive, @modifyUser, @scriptDescription, @scriptName,  --EXEC InsertorUpdateAgentScripts 1, 'Scripts', 1, 'Scripts', 'NULL', 'DefaultScriptS', 'static'  --@scriptType, @operationType [INSERT / UPDATE]  -- =============================================  CREATE Procedure [dbo].[InsertorUpdateAgentScripts]  (      -- Add the parameters for the stored procedure here     @scriptID BIGINT = 0,        @createUser NVARCHAR(150),     @isActive BIT,       @modifyUser NVARCHAR(150) = null,     @scriptDescription NVARCHAR(50) = null,     @scriptName NVARCHAR(50) =  null,     @scriptType NVARCHAR(20) = null       )  AS  BEGIN      -- SET NOCOUNT ON added to prevent extra result sets from      -- interfering with SELECT statements.      SET NOCOUNT ON       -- Insert statements for procedure here  if not exists (SELECT 1 FROM [CallCenter].[AgentScripts])  BEGIN   DBCC CHECKIDENT ('[CallCenter].[AgentScripts]', RESEED, 1)   END  if exists (SELECT 1 FROM [CallCenter].[AgentScripts] WHERE ScriptName = @scriptName)   BEGIN   UPDATE [CallCenter].[AgentScripts]    SET    IsActive = @isActive,   ModifyDate = getdate(),   ModifyUser = @modifyUser,   ScriptDescription = @scriptDescription,   ScriptName = @scriptName,   ScriptType = @scriptType   WHERE ScriptID = @scriptID   END   ELSE   BEGIN   INSERT INTO [CallCenter].[AgentScripts]    (     CreateDate,    CreateUser,    IsActive,    ModifyDate,    ModifyUser,    ScriptDescription,    ScriptName,    ScriptType     )    VALUES    (    getdate(),    @createUser,    @isActive,    getdate(),    @modifyUser,    @scriptDescription,    @scriptName,    @scriptType)    END  END  
CREATE Procedure [dbo].[InsertorUpdateAgentLogins]   -- Add the parameters for the stored procedure here          @userProfileId bigint = 0,      @userName nvarchar(50) = null,       @temproryKeyCode nvarchar(30) = null,       @isActive bit,       @isEnabled bit,       @isRegister bit,       @isBlocked bit,       @firstName nvarchar(50) = null,       @lastName nvarchar(50) = null,       @middleName nvarchar(50) = null,        @designation nvarchar(30) = null,           @createUser nvarchar(50) = null,            @modifyUser nvarchar(50) = null,       @passwordHash nvarchar(2000) = null,       @passwordSalt nvarchar(2000) = null              AS  BEGIN   -- SET NOCOUNT ON added to prevent extra result sets from   -- interfering with SELECT statements.   SET NOCOUNT ON;      -- Insert statements for procedure here   if not exists (SELECT 1 FROM [auth].[UserProfiles])   BEGIN    DBCC CHECKIDENT ('[auth].[UserProfiles]', RESEED, 1)    END   if exists (SELECT 1 FROM [auth].[UserProfiles] WHERE UserProfileId = @userProfileId AND USERNAME = @userName)   BEGIN    UPDATE  [auth].[UserProfiles]    SET  [UserName] = @userName ,       [TemproryKeyCode] = @temproryKeyCode,       [IsActive] = @isActive,       [IsEnabled] = @isEnabled,       [IsRegister] = @isRegister,       [IsBlocked] = @isBlocked,       [FirstName] = @firstName,       [LastName] = @lastName,       [MiddleName] = @middleName,           [Designation] = @designation,           [ModifyDate] = getdate(),       [ModifyUser] = @modifyUser,       [PasswordHash] = @passwordHash,       [PasswordSalt] = @passwordSalt    WHERE   UserProfileId = @userProfileId      END   BEGIN    INSERT INTO [auth].[UserProfiles]          ([UserName],       [TemproryKeyCode],       [IsActive],       [IsEnabled],       [IsRegister],       [IsBlocked],       [FirstName],       [LastName],       [MiddleName],           [Designation],       [CreateDate],       [CreateUser],       [ModifyDate],       [ModifyUser],       [PasswordHash],       [PasswordSalt]      )        VALUES  (@userName ,       @temproryKeyCode,       @isActive,       @isEnabled,       @isRegister,       @isBlocked,       @firstName,       @lastName,       @middleName,        @designation,       getdate(),          @createUser,      getdate(),               @modifyUser,       @passwordHash,       @passwordSalt         )   END  END  
-- =============================================  -- Author:      <Author, , Name>  -- Create Date: <Create Date, , >  -- Description: <Description, , >  -- =============================================  CREATE Procedure [dbo].[DeleteScriptSectionTypes]  (      -- Add the parameters for the stored procedure here     @scriptSectionTypeId BIGINT,        @operationType NVARCHAR(10)  )  AS  BEGIN      -- SET NOCOUNT ON added to prevent extra result sets from      -- interfering with SELECT statements.      SET NOCOUNT ON        -- Insert statements for procedure here     IF @operationType = 'UPDATE'   BEGIN    UPDATE [CallCenter].[ScriptSectionTypes]    SET     IsActive = 0     WHERE ScriptSectionTypeId = @scriptSectionTypeId   END  END  
-- =============================================  -- Author:      BHANU PRAKASH INTURI  -- Create Date: 15-NOV-2017  -- Description: INSERT CALL CENTER SECTION SCRIPTS  --select * from [CallCenter].[ScriptSections]  -- =============================================  CREATE Procedure [dbo].[DeleteScriptSections]  (      -- Add the parameters for the stored procedure here    @scriptSectionID BIGINT,       @operationType NVARCHAR(10)  )  AS  BEGIN      -- SET NOCOUNT ON added to prevent extra result sets from      -- interfering with SELECT statements.      SET NOCOUNT ON        -- Insert statements for procedure here    IF @operationType = 'DELETE'   BEGIN   UPDATE [CallCenter].[ScriptSections]    SET      isActive = 0     WHERE ScriptSectionID = @scriptSectionID   END     END  
CREATE Procedure [dbo].[getModelDetailsByModelCode]  @modelCode varchar(30)    AS  BEGIN     SET NOCOUNT ON;     select pRules.BrandCode, pRules.BrandFamilyCode, pRules.EarmoldTypeCode, pRules.FamilyProductCode,   pRules.ProductTypeCode, pRules.ShellCode, pRules.TechnologyLevelCode ,   mContent.ModelOverview, mContent.ModelLongDescription   from [Catalog].ProductModelRules pRules left join [Catalog].FeatureValueRules fRules   on pRules.ProductModelCode = fRules.ProductModelCode   inner join CMS.ModelContents mContent   on mContent.ModelCode = pRules.ProductModelCode   where pRules.ProductModelCode = @modelCode        -- select pRules.BrandCode, pRules.BrandFamilyCode, pRules.EarmoldTypeCode, pRules.FamilyProductCode,   --pRules.ProductTypeCode, pRules.ShellCode, pRules.TechnologyLevelCode ,pRules.ProductModelCode,   --mContent.ModelOverview,   --ISNULL(conProd.UnitPrice,0) as UnitProductPrice, ISNULL(conProd.PairPrice,0) as PairProductPrice, ISNULL(contBen.BenefitAmt,0) as Benefit   --from [Catalog].ProductModelRules pRules left join [Catalog].FeatureValueRules fRules   --on pRules.ProductModelCode = fRules.ProductModelCode   --inner join CMS.ModelContents mContent   --on mContent.ModelCode = pRules.ProductModelCode   --inner join insurance.ContractProducts1 conProd   --on conProd.FamilyProductCode = pRules.FamilyProductCode   --or conProd.ProductTypeCode = pRules.ProductTypeCode   --inner join insurance.ContractBenefits contBen   --on contBen.HealthPlanContractID = conProd.HealthPlanContractID   --inner join insurance.HealthPlanContracts healthPC   --on healthPC.HealthPlanContractID = contBen.HealthPlanContractID   --inner join insurance.InsuranceHealthPlans insHP   --on healthPC.HealthPlanID = insHP.HealthPlanID     --where pRules.ProductModelCode = 'VOT988-DW'    END  
-- Batch submitted through debugger: SQLQuery6.sql|7|0|C:\Users\sdaggubati\AppData\Local\Temp\~vs53FC.sql  CREATE PROCEDURE [dbo].[anthem_elig_file_load_ssis_sp_merge_stg_to_anthemelig]  AS      BEGIN     BEGIN TRY   BEGIN TRANSACTION AM_ELIG_MERGE_stg_to_AnthemElig    -- EXEC [dbo].[anthem_elig_file_load_ssis_sp_merge_stg_to_anthemelig]        DECLARE @sys_usr CHAR(30)           ,@sys_date DATETIME;        SET @sys_usr = SYSTEM_USER    SET @sys_date = CAST(GETDATE() AT TIME ZONE 'UTC' AT TIME ZONE 'Eastern Standard Time' AS DATETIME);  -- Time in EST      DROP TABLE IF EXISTS anthemelig.DataViewAnthemMembers              DROP TABLE IF EXISTS anthemelig.DataVAnthemMemNotRcvd      DROP TABLE IF EXISTS anthemelig.DataVAnthemIns              DROP TABLE IF EXISTS anthemelig.DataVAnthemInsNotRcvd          SELECT *     INTO anthemelig.DataViewAnthemMembers     FROM anthemelig.ViewAnthemMembers      CREATE INDEX DataViewAnthemMembers_idx ON anthemelig.DataViewAnthemMembers (newNHLinkID)      SELECT *     INTO anthemelig.DataVAnthemMemNotRcvd     FROM anthemelig.ViewAnthemMemNotRcvd n           WHERE NOT EXISTS (SELECT 1 FROM anthemelig.DataViewAnthemMembers d WHERE d.newNHLinkID = n.newNHLinkID)      CREATE INDEX DataVAnthemMemNotRcvd_idx ON anthemelig.DataVAnthemMemNotRcvd (newNHLinkID)      SELECT *     INTO anthemelig.DataVAnthemIns     FROM anthemelig.ViewAnthemInsurance      CREATE INDEX DataVAnthemIns_idx ON anthemelig.DataVAnthemIns (newNHLinkID)      SELECT *     INTO anthemelig.DataVAnthemInsNotRcvd     FROM anthemelig.ViewAnthemInsNotRcvd n     WHERE NOT EXISTS (SELECT 1 FROM anthemelig.DataVAnthemIns d WHERE d.newNHLinkID = n.newNHLinkID and d.EligibilityEffectiveDate = n.EligibilityEffectiveDate)      CREATE INDEX DataVAnthemInsNotRcvd_idx ON anthemelig.DataVAnthemInsNotRcvd (newNHLinkID,EligibilityEffectiveDate)      -- Set all records not to be processed    UPDATE     [anthemelig].[AnthemMembers]    SET ToBeProcessed = 'N'      UPDATE     [anthemelig].[AnthemInsurance]    SET ToBeProcessed = 'N'      -- Insert if there are any new members or update any changes to existing members    MERGE [anthemelig].[AnthemMembers] m     USING [anthemelig].DataViewAnthemMembers d  -- [anthemelig].[DataViewAnthemMembers]     ON (m.newNHLinkID = d.newNHLinkID)      WHEN MATCHED THEN      UPDATE SET    MemberIdentificationNumber = d.MemberIdentificationNumber,    MembersDateOfBirth = d.MembersDateOfBirth,    MedicaidNumber = d.MedicaidNumber,    MedicareNumber = d.MedicareNumber,    MemberLastName = d.MemberLastName,    MemberFirstName = d.MemberFirstName,    MemberMiddleName = d.MemberMiddleName,    SocialSecurityNumber = d.SocialSecurityNumber,    MemberPhoneNumber = d.MemberPhoneNumber,    MemberAddressLine1 = d.MemberAddressLine1,    MemberAddressLine2 = d.MemberAddressLine2,    MemberCityName = d.MemberCityName,    MemberStateName = d.MemberStateName,    MemberZipCode = d.MemberZipCode,    MemberDateOfDeath = d.MemberDateOfDeath,    MemberSex = d.MemberSex,    MemberRace = d.MemberRace,    MemberLanguage = d.MemberLanguage,    MemberMailingAddressLine1 = d.MemberMailingAddressLine1,    MemberMailingAddressLine2 = d.MemberMailingAddressLine2,    MemberMailingCityName = d.MemberMailingCityName,    MemberMailingStateName = d.MemberMailingStateName,    MemberMailingZipCode = d.MemberMailingZipCode,    statusflag = 'U',    tobeprocessed = 'Y',    ModifyDate = @sys_date,    ModifyUser = @sys_usr      WHEN NOT MATCHED THEN      INSERT (    newNHLinkID,    MemberIdentificationNumber,    MembersDateOfBirth,    MedicaidNumber,    MedicareNumber,    MemberLastName,    MemberFirstName,    MemberMiddleName,    SocialSecurityNumber,    MemberPhoneNumber,    MemberAddressLine1,    MemberAddressLine2,    MemberCityName,    MemberStateName,    MemberZipCode,    MemberDateOfDeath,    MemberSex,    MemberRace,    MemberLanguage,    MemberMailingAddressLine1,    MemberMailingAddressLine2,    MemberMailingCityName,    MemberMailingStateName,    MemberMa
CREATE Procedure [dbo].[getModelDetailsByModelCodeMediaName]  @modelCode varchar(30),  @mediaName varchar(20)  AS  BEGIN     SET NOCOUNT ON;     if(@mediaName = 'Videos' or @mediaName = 'Downloads')    begin     select ModelCode,null as [Description],Media,MediaURL,null as ModelOverview from CMS.ModelMedias where ModelCode = @modelCode  and MediaType = @mediaName    end   else if(@mediaName = 'Reviews')    begin     select ModelCode,ModelReviewDescription as [Description],null as Media, null as MediaURL,null as ModelOverview from CMS.ModelReviews where ModelCode = @modelCode     end   else if(@mediaName = 'Mobile Apps')    begin     select ModelCode,ModelMobileAppsDescription as [Description],null as Media, null as MediaURL,null as ModelOverview from CMS.ModelContents where ModelCode = @modelCode     end   else if(@mediaName = 'Overview')    begin     select ModelCode,null as [Description],null as Media, null as MediaURL,ModelOverview from CMS.ModelContents where ModelCode = @modelCode     end   else     begin     select ModelCode,[Description],null as Media, null as MediaURL,null as ModelOverview from CMS.ModelAccessories where ModelCode = @modelCode and ModelAccessoryName = @mediaName    end  END  
CREATE procedure [dbo].[anthem_elig_file_load_ssis_sp_merge_anthemelig_to_masters]  as    -- Also includes Address & Phone Numbers    -- EXEC [dbo].[anthem_elig_file_load_ssis_sp_merge_anthemelig_to_masters]    BEGIN     BEGIN TRY   BEGIN TRANSACTION AM_ELIG_MERGE_AnthElig_to_Master      DECLARE @sys_usr CHAR(30)      ,@sys_date DATETIME;        SET @sys_usr = SYSTEM_USER    SET @sys_date = CAST(GETDATE() AT TIME ZONE 'UTC' AT TIME ZONE 'Eastern Standard Time' AS DATETIME);  -- Time in EST        -- drop not null record insert constraint (unique index) on NHMemberID in master.members before inserting new members or updating NHMemberID for new records inserted      ALTER TABLE [Master].[Members] DROP CONSTRAINT [IX_Members_NHMemberID_U]          MERGE Master.Members d    USING ( SELECT * FROM [anthemelig].[AnthemMembers] WHERE ToBeProcessed = 'Y' ) s    ON (d.memberid = s.mastermemberid )      WHEN MATCHED THEN                 UPDATE SET    d.EligFile = 'ELIG_AM',    d.eligFileID = s.ID,    d.DateOfBirth = s.MembersDateOfBirth,    d.FirstName = s.MemberFirstName,    d.Gender = s.MemberSex,    d.IsActive = 1,    d.LastName = s.MemberLastName,    d.MiddleInitial = s.MemberMiddleName,    d.ModifyDate = @sys_date,    d.ModifyUser = @sys_usr      WHEN NOT MATCHED THEN      INSERT (     CreateDate,     CreateUser,     DataSource,     DateOfBirth,     FirstName,     Gender,     IsActive,     LastName,     MiddleInitial,     ModifyDate,     ModifyUser,     EligFile,     EligFileID)       VALUES      (     @sys_date    ,@sys_usr    ,'ELIG_AM'    ,MembersDateOfBirth    ,MemberFirstName    ,MemberSex    ,1    ,MemberLastName    ,MemberMiddleName    ,@sys_date    ,@sys_usr    ,'ELIG_AM'    ,ID    );        -- Assign mastermemberid in AnthemMembers after inserting new records into master.members    UPDATE a     SET mastermemberid = (SELECT memberid FROM [Master].[Members] m where m.EligFileID = a.id and m.EligFile = 'ELIG_AM')    FROM anthemelig.anthemmembers a    WHERE tobeprocessed = 'Y'            AND mastermemberid IS NULL        -- Update NHMemberID for newly inserted members    UPDATE [Master].[Members]    SET nhmemberid = 'NH'+RIGHT(YEAR(GETDATE()),4)+ FORMAT(memberid,'00000000')        --    'NH2018'+ FORMAT(memberid,'00000000')    WHERE EligFile = 'ELIG_AM'    AND nhmemberid IS NULL      -- Re create the unique NHMemberID index    ALTER TABLE [Master].[Members] ADD  CONSTRAINT [IX_Members_NHMemberID_U] UNIQUE NONCLUSTERED     (     [NHMemberID] ASC    )        -- Assign mastermemberid to AnthemInsurance records from AnthemMembers joining on newNHLinkID       UPDATE i    SET mastermemberid = ( SELECT mastermemberid FROM [anthemelig].[AnthemMembers] m WHERE m.newNHLinkID = i.newNHLinkID )    FROM [anthemelig].[AnthemInsurance] i    WHERE EXISTS (SELECT 1 FROM [anthemelig].[AnthemMembers] m1 WHERE m1.newNHLinkID = i.newNHLinkID)    AND i.mastermemberid IS NULL        -- Update address    MERGE Master.addresses d    USING (SELECT * FROM anthemelig.anthemmembers WHERE tobeprocessed = 'Y' AND MemberAddressLine1 <> '') s    ON (d.memberid = s.mastermemberid AND d.AddressTypeCode = 'PERM')    WHEN MATCHED THEN    UPDATE SET    Address1 = s.MemberAddressLine1    ,Address2 = s.MemberAddressLine2    ,City = s.MemberCityName    ,State = s.MemberStateName    ,ZipCode = s.MemberZipCode    ,IsActive = 1    ,IsPreferredAddress = 1    ,MemberID = s.mastermemberid    ,ModifyDate = @sys_date    , ModifyUser = @sys_usr    WHEN NOT MATCHED THEN    INSERT (     Address1    ,Address2    ,AddressTypeCode    ,City    ,State    ,ZipCode    ,EffectiveFromDate    ,EffectiveToDate    ,IsActive    ,IsPreferredAddress    ,MemberID    ,CreateDate    ,CreateUser    ,ModifyDate    , ModifyUser    )    VALUES(     s.[MemberAddressLine1]    ,s.[MemberAddressLine2]    ,'PERM'    ,s.[MemberCityName]    ,s.[MemberStateName]    ,s.[MemberZipCode]    ,CAST(DATEADD(MONTH, DATEDIFF(MONTH, 0, GETDATE()), 0) AS DATE)     ,CAST('20991231' AS DATE)     ,1     ,1     ,s.[masterm
create function [dbo].[getPriceTypeofItem]  (      @PODate date,   @itemcode nvarchar(50),   @IsMedicaid int,   @InsuranceCarrierName nvarchar(50)        ) returns nvarchar(50)  as  BEGIN       Declare @UnitPrice as nvarchar(50);          Declare @PriceType as nvarchar(50);        set @UnitPrice = cast( (select top (1) [UnitCOGS] from [catalog].[ItemMasterPriceList] where [EffectiveFrom]<= @PODate and [EffectiveTo] > @PODate and IsActive=1 and ItemCode=@itemcode     and PriceType = case when @IsMedicaid=1 then 'Medicaid'                       when (@InsuranceCarrierName like 'Anthem%' and @InsuranceCarrierName like '%Funded%') then 'Anthem'              else 'Standard' end) as nvarchar)       set @PriceType = (select top 1 (case when @IsMedicaid=1 then 'Medicaid'  when (@InsuranceCarrierName like 'Anthem%' and @InsuranceCarrierName like '%Funded%') then 'Anthem'              else 'Standard' end) as nvarchar from [catalog].[ItemMasterPriceList] where [EffectiveFrom]<= @PODate and [EffectiveTo] > @PODate and IsActive=1 and ItemCode=@itemcode);          if ((@UnitPrice is null) OR (@UnitPrice = ''))     BEGIN                 set @PriceType = (select top 1 'Anthem' from [catalog].[ItemMasterPriceList] )       if ((@UnitPrice is null) OR (@UnitPrice = ''))      BEGIN               set @PriceType = (select top 1 'Standard' from [catalog].[ItemMasterPriceList])           END      END           return @PriceType;       END    
CREATE function [dbo].[getunitPriceofItem]  (      @PODate date,   @itemcode nvarchar(50),   @IsMedicaid int,   @InsuranceCarrierName nvarchar(50)        ) returns nvarchar(50)  as  BEGIN       Declare @UnitPrice as nvarchar(50);       Declare @BrandCode as nvarchar(50);       set @BrandCode = (select top 1 BrandCode from catalog.ItemMasterList where ItemCode = @itemcode);       if (lTRIM(RTRIM(@BrandCode)) = 'STARKEY')       BEGIN     set @UnitPrice = (select top 1 [UnitCOGS] from [catalog].[ItemMasterPriceList] where [EffectiveFrom]<= @PODate and [EffectiveTo] > @PODate and IsActive=1 and ItemCode=@itemcode and PriceType = 'Standard')       END       ELSE       BEGIN        set @UnitPrice = cast( (select top (1) [UnitCOGS] from [catalog].[ItemMasterPriceList] where [EffectiveFrom]<= @PODate and [EffectiveTo] > @PODate and IsActive=1 and ItemCode=@itemcode          and PriceType = case when @IsMedicaid=1 then 'Medicaid'               when (@InsuranceCarrierName like 'Anthem%' and @InsuranceCarrierName like '%Funded%') then 'Anthem'               else 'Standard' end) as nvarchar)    if ((@UnitPrice is null) OR (@UnitPrice = ''))      BEGIN     set @UnitPrice = (select top 1 [UnitCOGS] from [catalog].[ItemMasterPriceList] where [EffectiveFrom]<= @PODate and [EffectiveTo] > @PODate and IsActive=1 and ItemCode=@itemcode and PriceType = 'Anthem')      if ((@UnitPrice is null) OR (@UnitPrice = ''))       BEGIN         set @UnitPrice = (select top 1 [UnitCOGS] from [catalog].[ItemMasterPriceList] where [EffectiveFrom]<= @PODate and [EffectiveTo] > @PODate and IsActive=1 and ItemCode=@itemcode and PriceType = 'Standard')      END     END        END       return @UnitPrice;       END    
CREATE function [dbo].[getTotalInvoiceAmount]  (      @Quantity int = 0,      @PODate date,   @itemcode nvarchar(50),   @IsMedicaid int,   @InsuranceCarrierName nvarchar(50)        ) returns nvarchar(50)  as  BEGIN       Declare @UnitPrice as decimal(19,4);       set @UnitPrice = cast( (select top (1) [UnitCOGS] from [catalog].[ItemMasterPriceList] where [EffectiveFrom]<= @PODate and [EffectiveTo] > @PODate and IsActive=1 and ItemCode=@itemcode     and PriceType = case when @IsMedicaid=1 then 'Medicaid'                       when (@InsuranceCarrierName like 'Anthem%' and @InsuranceCarrierName like '%Funded%') then 'AnthemPrice'              else 'Standard' end) as decimal(19,4))        if ((@UnitPrice is null))     BEGIN                 set @UnitPrice = (select top 1 [UnitCOGS] from [catalog].[ItemMasterPriceList] where [EffectiveFrom]<= @PODate and [EffectiveTo] > @PODate and IsActive=1 and ItemCode=@itemcode and PriceType = 'AnthemPrice')       if ((@UnitPrice is null))      BEGIN               set @UnitPrice = (select top 1 [UnitCOGS] from [catalog].[ItemMasterPriceList] where [EffectiveFrom]<= @PODate and [EffectiveTo] > @PODate and IsActive=1 and ItemCode=@itemcode and PriceType = 'Standard')           END      END        if((@UnitPrice is null))    BEGIN    set @UnitPrice = 0.00;      END      if(@Quantity is null)    BEGIN     set @Quantity = 0;    END                set @UnitPrice = @UnitPrice * @Quantity;           return cast( @UnitPrice as nvarchar(50));       END    
  -- 2020-08-21 - Mohan commented out 1=1  -- 2020-08-16 - Mohan applied [Search Performance Fix:] by commenting joins to pull OrderIds   -- 2020-07-27 - Damian Montero - Ran on Stage  -- 2020-07-30 - Mohan Nanduri  - Ran on Prod  /*   Add feature - Search with PO Number     select top 10 * from Orders.OrderPOs order by OrderId desc     EXEC [dbo].[sp_SearchMemberCall_SD_20200827] 0,NULL,NULL,NULL,NULL,NULL,NULL,NULL,NULL,NULL,NULL,NULL,NULL,NULL,NULL,NULL,NULL,NULL,NULL,NULL,0,20200002122;  */      CREATE   PROCEDURE [dbo].[sp_SearchMemberCall_SD_20200827]  (               @MemberID           BIGINT = NULL,                @NHMemberID         NVARCHAR(50) = NULL,                @FirstName          NVARCHAR(250) = NULL,               @LastName           NVARCHAR(50) = NULL,               @DateOfBirth        DATETIME = NULL,           @Gender             NVARCHAR(10) = NULL,               @MaritalStatus      NVARCHAR(25) = NULL,               @Address1           NVARCHAR(500) = NULL,               @Address2           NVARCHAR(500) = NULL,               @City               NVARCHAR(50) = NULL,               @State              NVARCHAR(10) = NULL,               @Country            NVARCHAR(50) = NULL,               @ZipCode            NVARCHAR(10) = NULL,                @EmailAddress       NVARCHAR(50) = NULL,                @Phone               NVARCHAR(50) = NULL,               @InsuranceHealthPlanNumber NVARCHAR(250) = NULL,        @OTCCardNumber    NVARCHAR(100) = NULL,            @InsuranceHealthPlanName NVARCHAR(250) = NULL,               @InsuranceCarrierName NVARCHAR(250) = NULL,           @SearchFilterCarrierId  NVARCHAR(250) = NULL,         @OrderID BIGINT = 0,      @PONumber BIGINT = 0  )        AS        BEGIN            SET NOCOUNT ON;     IF OBJECT_ID('tempdb..#results') IS NOT NULL   BEGIN    DROP TABLE #results   END        DECLARE @DateOfBirth1  AS VARCHAR(20) = NULL        SET @LastName = REPLACE(@LastName,'''','''''')        SET @FirstName = REPLACE(@FirstName,'''','''''')         SET @DateOfBirth1 = cast(@DateOfBirth as datetime)     DECLARE @Top BIGINT = CASE WHEN @NHMemberId IS NULL THEN 50 ELSE 1 END     CREATE TABLE #results (    MemberID    BIGINT,    NHMemberNbr VARCHAR(100),    FirstName VARCHAR(100),    LastName VARCHAR(100),    DOB   VARCHAR(50),    Address  VARCHAR(200),    Address2 VARCHAR(200),    City  VARCHAR(100),    State  VARCHAR(50),    Country  VARCHAR(100),    Zip   VARCHAR(20),    AddressTypeCode VARCHAR(10),    OrderNumber BIGINT   )     -- Search by OrderID   IF (@OrderID IS NOT NULL AND @OrderID > 0)            BEGIN    INSERT INTO #results    SELECT TOP 1      M.MemberID,     M.NHMemberID NhMemberNbr,     M.FirstName,     M.LastName,     convert(varchar,(M.DateOfBirth),101) DOB,                           A.Address1 Address,A.Address2,A.City,A.State,A.Country,A.ZipCode zip,A.AddressTypeCode,                            ISNULL(O.OrderID,0) AS OrderNumber        FROM Orders.Orders O WITH (NOLOCK)                  INNER JOIN [Master].Members M WITH (NOLOCK) ON (O.NHMemberId = M.NHMemberID and M.IsActive = 1)              LEFT JOIN [Master].Addresses A WITH (NOLOCK) on (M.MemberID=A.MemberID and a.IsPreferredAddress=1 and A.IsActive = 1)    WHERE O.OrderId = @OrderId    AND O.IsActive = 1   END       -- Search by PONumber   ELSE IF (@PONumber IS NOT NULL AND @PONumber > 0)            BEGIN    INSERT INTO #results    SELECT TOP 1      M.MemberID,     M.NHMemberID NhMemberNbr,     M.FirstName,     M.LastName,     convert(varchar,(M.DateOfBirth),101) DOB,                           A.Address1 Address,A.Address2,A.City,A.State,A.Country,A.ZipCode zip,A.AddressTypeCode,                            ISNULL(O.OrderID,0) AS OrderNumber        FROM Orders.OrderPOs PO WITH (NOLOCK)    INNER JOIN Orders.Orders O WITH (NOLOCK) ON (PO.OrderId= O.OrderID and O.IsActive = 1)    JOIN [Master].Members M WITH (NOLOCK) ON (O.NHMemberId = M.NHMemberID and M.IsActive = 1)          LEFT JOIN [Master].Addresses A WIT
create function [dbo].[getunitPriceofItem]  (      @PODate date,   @itemcode nvarchar(50),   @IsMedicaid int,   @InsuranceCarrierName nvarchar(50)        ) returns nvarchar(50)  as  BEGIN       Declare @UnitPrice as nvarchar(50);     Declare @AnthemUnitPrice as nvarchar(50);     Declare @MedicaidUnitPrice as nvarchar(50);     Declare @StandardUnitPrice as nvarchar(50);     Declare @MedicaidPerson as varchar(10);     Declare @StandardPerson as varchar(10);     Declare @AnthemPerson as varchar(10);     Declare @AnthemandMedicaidPerson as varchar(10);        Declare @AnthemUnitPricefinal as DECIMAL(18,2);     Declare @MedicaidUnitPricefinal as DECIMAL(18,2);     Declare @StandardUnitPricefinal as DECIMAL(18,2);       set @MedicaidPerson = 'NO';     set @StandardPerson = 'NO';     set @AnthemPerson = 'NO';     set @AnthemandMedicaidPerson = 'NO';                Declare @BrandCode as nvarchar(50);       set @BrandCode = (select top 1 BrandCode from catalog.ItemMasterList where ItemCode = @itemcode);       if (lTRIM(RTRIM(@BrandCode)) = 'STARKEY')       BEGIN     set @UnitPrice = (select top 1 [UnitCOGS] from [catalog].[ItemMasterPriceList] where [EffectiveFrom]<= @PODate and [EffectiveTo] > @PODate and IsActive=1 and ItemCode=@itemcode and PriceType = 'Standard')       END       ELSE       BEGIN              set @AnthemUnitPrice = (select top 1 [UnitCOGS] from [catalog].[ItemMasterPriceList] where [EffectiveFrom]<= @PODate and [EffectiveTo] > @PODate and IsActive=1 and ItemCode=@itemcode and PriceType = 'Anthem')     set @StandardUnitPrice = (select top 1 [UnitCOGS] from [catalog].[ItemMasterPriceList] where [EffectiveFrom]<= @PODate and [EffectiveTo] > @PODate and IsActive=1 and ItemCode=@itemcode and PriceType = 'Standard')     set @MedicaidUnitPrice = (select top 1 [UnitCOGS] from [catalog].[ItemMasterPriceList] where [EffectiveFrom]<= @PODate and [EffectiveTo] > @PODate and IsActive=1 and ItemCode=@itemcode and PriceType = 'Medicaid')            if(@IsMedicaid=1)    BEGIN    set @MedicaidPerson = 'YES';    END           set @AnthemPerson = (case when (@InsuranceCarrierName like 'Anthem%' and @InsuranceCarrierName like '%Funded%') then 'YES'  else 'NO' end) ;          if((@MedicaidPerson = 'YES') AND (@AnthemPerson = 'YES'))       BEGIN     set @AnthemandMedicaidPerson = 'NO';     set @AnthemPerson = 'NO';         END        if ((@MedicaidUnitPrice is not null) AND (@MedicaidUnitPrice <> ''))      BEGIN             set @MedicaidUnitPricefinal = (Select CONVERT(DECIMAL(18,2),replace(@MedicaidUnitPrice, ',', '')) );           END           if ((@AnthemUnitPrice is not null) AND (@AnthemUnitPrice <> ''))      BEGIN             set @AnthemUnitPricefinal = (Select CONVERT(DECIMAL(18,2),replace(@AnthemUnitPrice, ',', '')) );           END        if ((@StandardUnitPrice is not null) AND (@StandardUnitPrice <> ''))      BEGIN             set @StandardUnitPricefinal = (Select CONVERT(DECIMAL(18,2),replace(@StandardUnitPrice, ',', '')) );           END              if(@AnthemandMedicaidPerson = 'YES')     BEGIN     DECLARE @temporartytable TABLE     (       ID int            );        if ((@AnthemUnitPrice is not null) AND (@AnthemUnitPrice <> '') AND (@MedicaidUnitPrice is not null) AND (@MedicaidUnitPrice <> '') AND (@StandardUnitPrice is not null) AND (@StandardUnitPrice <> ''))            BEGIN             Declare @MinofAnthemandMedicaid as DECIMAL(18,2);        Declare @MinimumofAnthemMedicaidandStandard as DECIMAL(18,2);                  set @MinofAnthemandMedicaid =  (select case when @AnthemUnitPricefinal > @MedicaidUnitPricefinal then @MedicaidUnitPricefinal else @AnthemUnitPricefinal end );          set @MinimumofAnthemMedicaidandStandard = (select case when @MinofAnthemandMedicaid > @StandardUnitPricefinal then @StandardUnitPricefinal else @MinofAnthemandMedicaid end );         set @UnitPrice = (select case when @MinofAnthemandMedicaid > @MinimumofAnthemMedicaidandStandard then @MinimumofAnthemMedicaidandStandard else @MinofAnt
create function dbo.Great_Circle_Distance   (   @Latitude1  float,   @Longitude1 float,   @Latitude2  float,   @Longitude2 float   )  returns float  as    begin  declare @radius float    declare @lon1  float  declare @lon2  float  declare @lat1  float  declare @lat2  float    declare @a float  declare @distance float    -- Sets average radius of Earth in Kilometers  set @radius = 6371.0E    -- Convert degrees to radians  set @lon1 = radians( @Longitude1 )  set @lon2 = radians( @Longitude2 )  set @lat1 = radians( @Latitude1 )  set @lat2 = radians( @Latitude2 )    set @a = sqrt(square(sin((@lat2-@lat1)/2.0E)) + (cos(@lat1) * cos(@lat2) * square(sin((@lon2-@lon1)/2.0E))) )    set @distance = @radius * ( 2.0E *asin(case when 1.0E < @a then 1.0E else @a end )) * 0.62137119  -- converted to Miles    return @distance -- Return distance in Miles    end  
      CREATE PROCEDURE [dbo].[sp_SearchMemberCall_TestDelete1](               @MemberID           BIGINT = NULL,                @NHMemberID         NVARCHAR(50) = NULL,                @FirstName          NVARCHAR(250) = NULL,               @LastName           NVARCHAR(50) = NULL,               @DateOfBirth        DATETIME = NULL,               @Gender             NVARCHAR(10) = NULL,               @MaritalStatus      NVARCHAR(25) = NULL,               @Address1           NVARCHAR(500) = NULL,               @Address2           NVARCHAR(500) = NULL,               @City               NVARCHAR(50) = NULL,               @State              NVARCHAR(10) = NULL,               @Country            NVARCHAR(50) = NULL,               @ZipCode            NVARCHAR(10) = NULL,                @EmailAddress       NVARCHAR(50) = NULL,                @Phone               NVARCHAR(50) = NULL,               @InsuranceHealthPlanNumber NVARCHAR(250) = NULL,               @InsuranceHealthPlanName NVARCHAR(250) = NULL,               @InsuranceCarrierName NVARCHAR(250) = NULL,               @OrderID BIGINT = 0)        AS        BEGIN               SET NOCOUNT ON;              SET ANSI_WARNINGS OFF;             DECLARE @SQLQueryRes AS NVARCHAR(4000)               DECLARE @SQLQuery AS NVARCHAR(4000)               DECLARE @SQLQueryM AS NVARCHAR(2000)               DECLARE @SQLQueryA AS NVARCHAR(2000)               DECLARE @SQLQueryP AS NVARCHAR(2000)               DECLARE @SQLQueryI AS NVARCHAR(2000)               DECLARE @tables AS VARCHAR(50)               DECLARE @Where AS VARCHAR(500)               DECLARE @DateOfBirth1  AS VARCHAR(20) = NULL                       set @LastName = REPLACE(@LastName,'''','''''')                       set @FirstName = REPLACE(@FirstName,'''','''''')                       SET @DateOfBirth1 = cast(@DateOfBirth as datetime)                               SET @SQLQuery = 'SELECT DISTINCT TOP 100 M.MemberID, m.NHMEMBERID from '                       SET @SQLQueryM = 'Master.Members m where  1 = 1 '                       SET @SQLQueryP = 'Master.Members m , Master.PhoneNumbers p where 1 = 1 and m.memberid = p.memberid '                       SET @SQLQueryA = 'Master.Members m , Master.Addresses a where 1 = 1 and m.memberid = a.memberid '                       SET @SQLQueryI = 'master.members m where exists (select 1 from (               select mi.memberid from master.MemberInsurances mi               where exists (select 1 from Master.MemberInsuranceDetails mid where                                                                mid.memberinsuranceid = mi.id and mid.InsuranceNbr  = '                       if (@FirstName is not null )                      Begin                      set @tables = 'MEMBER'                      set @Where = ' and m.firstname like '''+@FirstName+'%'''                             if @ZipCode is not null                                    Begin                                          set @tables = 'MEMBERADDRESS'                                          set @Where = @Where + ' and a.ZipCode like '''+@ZipCode+'%'''                                 End                             else                                   Begin                                          if @LastName is not null                                                 set @Where = @Where + ' and m.lastname like '''+@LastName+'%'''                                          if @DateOfBirth1 is not null                                                 set @Where = @Where + ' and m.DateOfBirth = cast('''+@DateOfBirth1+''''+' as datetime)'                                   End                   End               else                if (@LastName is not null )                      Begin                      set @tables = 'MEMBER'                      set @Where = ' and m.lastname like '''+@LastName+'%'''                             if @ZipCode is not null                                    Begin                                          set @t
-- =============================================  -- Author:      Ramu K  -- Create Date: 03-01-2018  -- Description: Gets all the brands from view  -- =============================================  CREATE PROCEDURE [dbo].[V_GetBrands]  AS  BEGIN      -- SET NOCOUNT ON added to prevent extra result sets from      -- interfering with SELECT statements.      SET NOCOUNT ON     select distinct brand from [catalog].[viewModelList]    END  
  -- =============================================  -- Author:  KALYANA GOBBURI  -- Create date: 4-Nov-2017  -- Description: PROCEDURE for Member Search Results  -- =============================================  CREATE Procedure [dbo].[sp_SearchMember_OLD](   -- Add the parameters for the stored procedure here   @MemberID           BIGINT = NULL,       @NHMemberID         NVARCHAR(50) = NULL,    @FirstName          NVARCHAR(250) = NULL,      @LastName           NVARCHAR(50) = NULL,   @DateOfBirth        DATETIME = NULL,   @Gender             NVARCHAR(10) = NULL,   @MaritalStatus      NVARCHAR(25) = NULL,   @Address1           NVARCHAR(500) = NULL,   @Address2           NVARCHAR(500) = NULL,   @City               NVARCHAR(50) = NULL,   @State              NVARCHAR(10) = NULL,   @Country            NVARCHAR(50) = NULL,   @ZipCode            NVARCHAR(10) = NULL,       @EmailAddress       NVARCHAR(50) = NULL,       @Phone              BIGINT = NULL,   @InsuranceHealthPlanNumber NVARCHAR(250) = NULL,   @InsuranceHealthPlanName NVARCHAR(250) = NULL,   @InsuranceCarrierName NVARCHAR(250) = NULL)  AS  BEGIN   -- SET NOCOUNT ON added to prevent extra result sets from   -- interfering with SELECT statements.   SET NOCOUNT ON;        SELECT DISTINCT M.MemberID,M.NHMemberID,M.FirstName,M.LastName,M.DateOfBirth,M.Gender,M.MiddleInitial,M.IsActive,          A.Address1,A.Address2,A.City,A.State,A.Country,A.ZipCode,A.AddressTypeCode,          P.PhoneNbr,P.CountryCode,P.IsPreferredPhoneNumber,P.PhoneExtension,       EM.EmailAddress,       MA.AttributeTypeCode,MA.AttributeValue,       MI.InsuranceCarrierID,MI.InsuranceEffectiveDate,MI.InsuranceHealthPlanID,MI.InsuranceType,       MD.InsuranceNbr,       IC.InsuranceCarrierName,IC.MemberDataFileProvided,       IH.HealthPlanName,IH.HealthPlanNumber   FROM Master.Members M   LEFT JOIN Master.Addresses A on M.MemberID=A.MemberID   LEFT JOIN Master.PhoneNumbers P on M.MemberID=P.MemberID   LEFT JOIN Master.Emails EM on M.MemberID = EM.MemberID   LEFT JOIN Master.MemberAttributes MA on M.MemberID=MA.MemberID   LEFT JOIN Master.MemberInsurances MI on M.MemberID=MI.MemberID   LEFT JOIN Master.MemberInsuranceDetails MD on MI.ID=MD.MemberInsuranceID   LEFT JOIN Insurance.InsuranceCarriers IC on MI.InsuranceCarrierID=IC.InsuranceCarrierID   LEFT JOIN Insurance.InsuranceHealthPlans IH on MI.InsuranceHealthPlanID=IH.InsuranceHealthPlanID   WHERE M.MemberID=@MemberID   OR M.NHMemberID=@NHMemberID   OR LOWER(M.FirstName) LIKE LOWER('%'+@FirstName+'%')   OR LOWER(M.LastName) LIKE LOWER('%'+@LastName+'%')   OR M.DateOfBirth=@DateOfBirth   OR LOWER(M.Gender) LIKE LOWER(@Gender)   OR LOWER(M.MaritalStatus) LIKE LOWER(@MaritalStatus)   OR LOWER(A.Address1) LIKE LOWER('%'+@Address1+'%')   OR LOWER(A.Address2) LIKE LOWER('%'+@Address2+'%')   OR LOWER(A.City) LIKE LOWER('%'+@City+'%')   OR LOWER(A.State) LIKE LOWER(@State)   OR LOWER(A.Country) LIKE LOWER(@Country)   OR A.ZipCode LIKE @ZipCode   OR LOWER(EM.EmailAddress) LIKE LOWER(@EmailAddress)   OR P.PhoneNbr=@Phone   OR LOWER(IH.HealthPlanNumber) LIKE LOWER(@InsuranceHealthPlanNumber)   OR LOWER(IH.HealthPlanName) LIKE LOWER(@InsuranceHealthPlanName)   OR LOWER(IC.InsuranceCarrierName) LIKE LOWER(@InsuranceCarrierName)  END        --EXEC [dbo].[sp_SearchMember] @MemberID = NULL ,   --    @NHMemberID  = NULL,   -- @FirstName = 'David',  --    @LastName = NULL,  -- @DateOfBirth= NULL,  -- @Gender = NULL,  -- @MaritalStatus = NULL,  -- @Address1 = NULL,  -- @Address2 = NULL,  -- @City = NULL,  -- @State = NULL,  -- @Country = NULL,  -- @ZipCode = NULL,   --    @EmailAddress = NULL,   --    @Phone  = NULL,  -- @InsuranceHealthPlanNumber = NULL,  -- @InsuranceHealthPlanName = NULL,  -- @InsuranceCarrierName = NULL  
  -- 2020-09-17 - Added Else clause after @Orderd Check  -- 2020-09-01 - Mohan  - Update by removing search with Address1, Address2 and ZipCode  -- 2020-07-27 - Damian Montero - Ran on Stage      -- 2020-07-30 - Mohan Nanduri  - Ran on Prod     -- 2020-08-21 - Damian Montero - Changed by removing 1=1 and loop      CREATE PROCEDURE [dbo].[sp_SearchMemberCall] (   @MemberID BIGINT = 0   ,@NHMemberID NVARCHAR(50) = NULL   ,@FirstName NVARCHAR(250) = NULL   ,@LastName NVARCHAR(50) = NULL   ,@DateOfBirth DATETIME = NULL   ,@Gender NVARCHAR(10) = NULL   ,@MaritalStatus NVARCHAR(25) = NULL   ,@Address1 NVARCHAR(500) = NULL   ,@Address2 NVARCHAR(500) = NULL   ,@City NVARCHAR(50) = NULL   ,@State NVARCHAR(10) = NULL   ,@Country NVARCHAR(50) = NULL   ,@ZipCode NVARCHAR(10) = NULL   ,@EmailAddress NVARCHAR(50) = NULL   ,@Phone NVARCHAR(50) = NULL   ,@InsuranceHealthPlanNumber NVARCHAR(250) = NULL   ,@OTCCardNumber NVARCHAR(100) = NULL   ,@InsuranceHealthPlanName NVARCHAR(250) = NULL   ,@InsuranceCarrierName NVARCHAR(250) = NULL   ,@SearchFilterCarrierId NVARCHAR(250) = NULL   ,@OrderID BIGINT = 0   ,@PONumber BIGINT = 0   )  AS  BEGIN   SET NOCOUNT ON;   -- Temporary fix to the Address search issue     SET @Address1 = NULL;   SET @Address2 = NULL;   --set @City  = NULL;             --set @State = NULL;            --set @Country  = NULL;             SET @ZipCode = NULL;     IF OBJECT_ID('tempdb..#results') IS NOT NULL   BEGIN    DROP TABLE #results   END     CREATE TABLE #results (    MemberID BIGINT    ,NHMemberNbr VARCHAR(100)    ,FirstName VARCHAR(100)    ,LastName VARCHAR(100)    ,DOB VARCHAR(50)    ,Address VARCHAR(200)    ,Address2 VARCHAR(200)    ,City VARCHAR(100)    ,STATE VARCHAR(50)    ,Country VARCHAR(100)    ,Zip VARCHAR(20)    ,AddressTypeCode VARCHAR(10)    ,OrderNumber BIGINT    )         -- Check if it's a blank request.     IF (     @MemberID IS NULL     OR @MemberID = 0     )    AND COALESCE(@NHMemberID, '') = ''    AND COALESCE(@FirstName, '') = ''    AND COALESCE(@LastName, '') = ''    AND COALESCE(@DateOfBirth, '') = ''    AND COALESCE(@Gender, '') = ''    AND COALESCE(@MaritalStatus, '') = ''    AND COALESCE(@Address1, '') = ''    AND COALESCE(@Address2, '') = ''    AND COALESCE(@City, '') = ''    AND COALESCE(@State, '') = ''    AND COALESCE(@Country, '') = ''    AND COALESCE(@ZipCode, '') = ''    AND COALESCE(@EmailAddress, '') = ''    AND COALESCE(@Phone, '') = ''    AND COALESCE(@InsuranceHealthPlanNumber, '') = ''    AND COALESCE(@OTCCardNumber, '') = ''    AND COALESCE(@InsuranceHealthPlanName, '') = ''    AND COALESCE(@InsuranceCarrierName, '') = ''    AND COALESCE(@SearchFilterCarrierId, '') = ''    AND (     @OrderID IS NULL     OR @OrderID = 0     )    AND (     @PONumber IS NULL     OR @PONumber = 0     )   BEGIN    -- Fake blank result.      SELECT MemberID     ,'' AS RowID     ,NHMemberNbr     ,FirstName     ,LastName     ,DOB     ,Address     ,Address2     ,City     ,STATE     ,Country     ,Zip     ,AddressTypeCode     ,'' AS PlanProgramID     ,'' AS InsuranceCarrierName     ,'' AS HealthPlanName     ,OrderNumber    FROM #results;   END   ELSE   BEGIN    -- We have at least one field sent.      DECLARE @DateOfBirth1 AS VARCHAR(20) = NULL      SET @LastName = REPLACE(@LastName, '''', '''''')    SET @FirstName = REPLACE(@FirstName, '''', '''''')    SET @DateOfBirth1 = cast(@DateOfBirth AS DATETIME)      DECLARE @Top BIGINT = CASE       WHEN @NHMemberId IS NULL       THEN 50      ELSE 1      END      IF (      @OrderID IS NOT NULL      AND @OrderID > 0      )    BEGIN     INSERT INTO #results     SELECT TOP 1 M.MemberID      ,M.NHMemberID NhMemberNbr      ,M.FirstName      ,M.LastName      ,convert(VARCHAR, (M.DateOfBirth), 101) DOB      ,A.Address1 Address      ,A.Address2      ,A.City      ,A.STATE      ,A.Country      ,A.ZipCode zip      ,A.AddressTypeCode      ,ISNULL(O.OrderID, 0) AS OrderNumber     FROM [Master].Members M WITH (NOLOCK)     INNER JOIN Orders.Orders O WITH (NOLOCK) ON O.NHMemberId = M
  -- =============================================  -- Author:  RAMU KUNJA  -- Create date: 11-dEC-2017  -- Description: PROCEDURE for Member Search Results  -- =============================================  CREATE Procedure [dbo].[sp_SearchMember2](   -- Add the parameters for the stored procedure here   @MemberID           BIGINT = NULL,       @NHMemberID         NVARCHAR(50) = NULL,    @FirstName          NVARCHAR(250) = NULL,      @LastName           NVARCHAR(50) = NULL,   @DateOfBirth        DATETIME = NULL,   @Gender             NVARCHAR(10) = NULL,   @MaritalStatus      NVARCHAR(25) = NULL,   @Address1           NVARCHAR(500) = NULL,   @Address2           NVARCHAR(500) = NULL,   @City               NVARCHAR(50) = NULL,   @State              NVARCHAR(10) = NULL,   @Country            NVARCHAR(50) = NULL,   @ZipCode            NVARCHAR(10) = NULL,       @EmailAddress       NVARCHAR(50) = NULL,       @Phone               NVARCHAR(50) = NULL,   @InsuranceHealthPlanNumber NVARCHAR(250) = NULL,   @InsuranceHealthPlanName NVARCHAR(250) = NULL,   @InsuranceCarrierName NVARCHAR(250) = NULL)  AS  BEGIN   -- SET NOCOUNT ON added to prevent extra result sets from   -- interfering with SELECT statements.   SET NOCOUNT ON;   DECLARE @SQLQuery AS NVARCHAR(4000)       SET @SQLQuery = 'SELECT DISTINCT M.MemberID,M.NHMemberID,M.FirstName,M.LastName,M.DateOfBirth,M.Gender,M.MiddleInitial,M.IsActive,          A.Address1,A.Address2,A.City,A.State,A.Country,A.ZipCode,A.AddressTypeCode,          P.PhoneNbr,P.CountryCode,P.IsPreferredPhoneNumber,P.PhoneExtension,       EM.EmailAddress,       MA.AttributeTypeCode,MA.AttributeValue,       MI.InsuranceCarrierID,MI.InsuranceEffectiveDate,MI.InsuranceHealthPlanID,MI.InsuranceType,       MD.InsuranceNbr,       IC.InsuranceCarrierName,IC.MemberDataFileProvided,       IH.HealthPlanName,IH.HealthPlanNumber   FROM [Master].Members M   LEFT JOIN [Master].Addresses A on M.MemberID=A.MemberID   LEFT JOIN [Master].PhoneNumbers P on M.MemberID=P.MemberID   LEFT JOIN [Master].Emails EM on M.MemberID = EM.MemberID   LEFT JOIN [Master].MemberAttributes MA on M.MemberID=MA.MemberID   LEFT JOIN [Master].MemberInsurances MI on M.MemberID=MI.MemberID   LEFT JOIN [Master].MemberInsuranceDetails MD on MI.ID=MD.MemberInsuranceID   LEFT JOIN Insurance.InsuranceCarriers IC on MI.InsuranceCarrierID=IC.InsuranceCarrierID   LEFT JOIN Insurance.InsuranceHealthPlans IH on MI.InsuranceHealthPlanID=IH.InsuranceHealthPlanID    '   --If any Single Value ---   if(@FirstName IS NOT NULL)   SET @SQLQuery = @SQLQuery + 'WHERE M.FirstName LIKE ''%' + @FirstName+'%'''   if (@FirstName IS NOT NULL AND @LastName IS NOT NULL)   SET @SQLQuery = @SQLQuery + ' AND M.LastName LIKE ''%' + @LastName+'%'''   else if (@LastName IS NOT NULL)   SET @SQLQuery = @SQLQuery + ' WHERE M.LastName LIKE ''%' + @LastName+'%'''     if (@FirstName IS NOT NULL AND @LastName IS NOT NULL AND @DateOfBirth IS NOT NULL)   SET @SQLQuery = @SQLQuery + ' AND M.DateOfBirth =''' + @DateOfBirth +''   else IF (@DateOfBirth IS NOT NULL)   SET @SQLQuery = @SQLQuery + ' WHERE M.DateOfBirth =''' + @DateOfBirth +''       if (@FirstName IS NOT NULL AND @LastName IS NOT NULL AND @DateOfBirth IS NOT NULL AND @Gender IS NOT NULL)   SET @SQLQuery = @SQLQuery + ' AND M.Gender =''' + @Gender +''   else if (@Gender IS NOT NULL)   SET @SQLQuery = @SQLQuery + ' WHERE M.Gender =''' + @Gender + ''''      if (@FirstName IS NOT NULL AND @LastName IS NOT NULL AND @DateOfBirth IS NOT NULL AND @Gender IS NOT NULL AND @MaritalStatus IS NOT NULL)   SET @SQLQuery = @SQLQuery + ' AND M.MaritalStatus =''' + @MaritalStatus +''''   else if (@MaritalStatus IS NOT NULL)   SET @SQLQuery = @SQLQuery + ' WHERE M.MaritalStatus =''' + @MaritalStatus +''''      if (@FirstName IS NOT NULL AND @LastName IS NOT NULL AND @DateOfBirth IS NOT NULL AND @Gender IS NOT NULL AND @MaritalStatus IS NOT NULL AND @Address1 IS NOT NULL)   SET @SQLQuery = @SQLQuery + ' AND A.Address1 LIKE ''%'+@Address1+'%'''   else if (@A
CREATE PROCEDURE [dbo].[sp_SearchMemberCall](               @MemberID           BIGINT = NULL,                @NHMemberID         NVARCHAR(50) = NULL,                @FirstName          NVARCHAR(250) = NULL,               @LastName           NVARCHAR(50) = NULL,               @DateOfBirth        DATETIME = NULL,               @Gender             NVARCHAR(10) = NULL,               @MaritalStatus      NVARCHAR(25) = NULL,               @Address1           NVARCHAR(500) = NULL,               @Address2           NVARCHAR(500) = NULL,               @City               NVARCHAR(50) = NULL,               @State              NVARCHAR(10) = NULL,               @Country            NVARCHAR(50) = NULL,               @ZipCode            NVARCHAR(10) = NULL,                @EmailAddress       NVARCHAR(50) = NULL,                @Phone               NVARCHAR(50) = NULL,               @InsuranceHealthPlanNumber NVARCHAR(250) = NULL,               @InsuranceHealthPlanName NVARCHAR(250) = NULL,               @InsuranceCarrierName NVARCHAR(250) = NULL,           @SearchFilterCarrierId  NVARCHAR(250) = NULL,         @OrderID BIGINT = 0)        AS        BEGIN               SET NOCOUNT ON;              SET ANSI_WARNINGS OFF;             DECLARE @SQLQueryRes AS NVARCHAR(4000)               DECLARE @SQLQuery AS NVARCHAR(4000)               DECLARE @SQLQueryM AS NVARCHAR(2000)               DECLARE @SQLQueryA AS NVARCHAR(2000)               DECLARE @SQLQueryP AS NVARCHAR(2000)               DECLARE @SQLQueryI AS NVARCHAR(2000)               DECLARE @tables AS VARCHAR(50)               DECLARE @Where AS VARCHAR(500)               DECLARE @DateOfBirth1  AS VARCHAR(20) = NULL                       set @LastName = REPLACE(@LastName,'''','''''')                       set @FirstName = REPLACE(@FirstName,'''','''''')                       SET @DateOfBirth1 = cast(@DateOfBirth as datetime)                               SET @SQLQuery = 'SELECT DISTINCT TOP 100 M.MemberID, m.NHMEMBERID from '                       SET @SQLQueryM = 'Master.Members m where  1 = 1 '                       SET @SQLQueryP = 'Master.Members m , Master.PhoneNumbers p where 1 = 1 and m.memberid = p.memberid '                       SET @SQLQueryA = 'Master.Members m , Master.Addresses a where 1 = 1 and m.memberid = a.memberid '                       SET @SQLQueryI = 'master.members m where exists (select 1 from (               select mi.memberid from master.MemberInsurances mi               where exists (select 1 from Master.MemberInsuranceDetails mid where                                                                mid.memberinsuranceid = mi.id and mid.InsuranceNbr  = '                       if (@FirstName is not null )                      Begin                      set @tables = 'MEMBER'                      set @Where = ' and m.firstname like '''+@FirstName+'%'''                             if @ZipCode is not null                                    Begin                                          set @tables = 'MEMBERADDRESS'                                          set @Where = @Where + ' and a.ZipCode like '''+@ZipCode+'%'''                                 End                             else                                   Begin                                          if @LastName is not null                                                 set @Where = @Where + ' and m.lastname like '''+@LastName+'%'''                                          if @DateOfBirth1 is not null                                                 set @Where = @Where + ' and m.DateOfBirth = cast('''+@DateOfBirth1+''''+' as datetime)'                                   End                   End               else                if (@LastName is not null )                      Begin                      set @tables = 'MEMBER'                      set @Where = ' and m.lastname like '''+@LastName+'%'''                             if @ZipCode is not null                                    Begin                
-- =============================================  -- Author:  <Author,,Name>  -- Create date: <Create Date,,>  -- Description: <Description,,>  -- =============================================  CREATE Procedure [dbo].[SP_Update_TimeZone_ByStates]   @StateColumnName nvarchar(50),    @TimeZoneColumnName nvarchar(50)  AS  BEGIN  update [dbo].[MasterProviderList]  set [Timezone] =   case   when FacilityState in ('WA','OR','NE','CO','CA','NV') then 'Pacific Time'  when FacilityState in ('NY','NJ','VT','ME','NH','MA','RI','CT','PA','DE','MD','DC','VA','WV','MI','IN','OH','KY','NC','GA','FL','SC') then 'Eastern Time'   when FacilityState in ('MT','ID','WY','UT', 'CO','AZ','NM')  then 'Mountain Time'  when FacilityState in ('ND','SD','NE','KS','OK','TX','MN','IA','MO','AR','LA','WI','IL','TN','MS','AL')  then 'Central Time'  when FacilityState in ('AK') then 'Alaska Time'  when FacilityState in ('HA') then 'Hawaii-Aleutian Time' end    END  
  -- =============================================  -- Author:  RAMU KUNJA  -- Create date: 11-dEC-2017  -- Description: PROCEDURE for Member Search Results  -- =============================================  CREATE Procedure [dbo].[sp_SearchMember](   -- Add the parameters for the stored procedure here   @MemberID           BIGINT = NULL,       @NHMemberID         NVARCHAR(50) = NULL,    @FirstName          NVARCHAR(250) = NULL,      @LastName           NVARCHAR(50) = NULL,   @DateOfBirth        DATETIME = NULL,   @Gender             NVARCHAR(10) = NULL,   @MaritalStatus      NVARCHAR(25) = NULL,   @Address1           NVARCHAR(500) = NULL,   @Address2           NVARCHAR(500) = NULL,   @City               NVARCHAR(50) = NULL,   @State              NVARCHAR(10) = NULL,   @Country            NVARCHAR(50) = NULL,   @ZipCode            NVARCHAR(10) = NULL,       @EmailAddress       NVARCHAR(50) = NULL,       @Phone               NVARCHAR(50) = NULL,   @InsuranceHealthPlanNumber NVARCHAR(250) = NULL,   @InsuranceHealthPlanName NVARCHAR(250) = NULL,   @InsuranceCarrierName NVARCHAR(250) = NULL)  AS  BEGIN   -- SET NOCOUNT ON added to prevent extra result sets from   -- interfering with SELECT statements.   SET NOCOUNT ON;   DECLARE @SQLQuery AS NVARCHAR(4000)       SET @SQLQuery = 'SELECT DISTINCT M.MemberID,M.NHMemberID,M.FirstName,M.LastName,M.DateOfBirth,M.Gender,M.MiddleInitial,M.IsActive,          A.Address1,A.Address2,A.City,A.State,A.Country,A.ZipCode,A.AddressTypeCode,          P.PhoneNbr,P.CountryCode,P.IsPreferredPhoneNumber,P.PhoneExtension,       EM.EmailAddress,       MA.AttributeTypeCode,MA.AttributeValue,       MI.InsuranceCarrierID,MI.InsuranceEffectiveDate,MI.InsuranceHealthPlanID,MI.InsuranceType,       MD.InsuranceNbr,       IC.InsuranceCarrierName,IC.MemberDataFileProvided,       IH.HealthPlanName,IH.HealthPlanNumber   FROM [Master].Members M   LEFT JOIN [Master].Addresses A on M.MemberID=A.MemberID   LEFT JOIN [Master].PhoneNumbers P on M.MemberID=P.MemberID   LEFT JOIN [Master].Emails EM on M.MemberID = EM.MemberID   LEFT JOIN [Master].MemberAttributes MA on M.MemberID=MA.MemberID   LEFT JOIN [Master].MemberInsurances MI on M.MemberID=MI.MemberID   LEFT JOIN [Master].MemberInsuranceDetails MD on MI.ID=MD.MemberInsuranceID   LEFT JOIN Insurance.InsuranceCarriers IC on MI.InsuranceCarrierID=IC.InsuranceCarrierID   LEFT JOIN Insurance.InsuranceHealthPlans IH on MI.InsuranceHealthPlanID=IH.InsuranceHealthPlanID    '   --If any Single Value ---   if(@FirstName IS NOT NULL)   SET @SQLQuery = @SQLQuery + 'WHERE M.FirstName LIKE ''%' + @FirstName+'%'''   if (@FirstName IS NOT NULL AND @LastName IS NOT NULL)   SET @SQLQuery = @SQLQuery + ' AND M.LastName LIKE ''%' + @LastName+'%'''   else if (@LastName IS NOT NULL)   SET @SQLQuery = @SQLQuery + ' WHERE M.LastName LIKE ''%' + @LastName+'%'''     if (@FirstName IS NOT NULL AND @LastName IS NOT NULL AND @DateOfBirth IS NOT NULL)   SET @SQLQuery = @SQLQuery + ' AND M.DateOfBirth =''' + @DateOfBirth +''   else IF (@DateOfBirth IS NOT NULL)   SET @SQLQuery = @SQLQuery + ' WHERE M.DateOfBirth =''' + @DateOfBirth +''       if (@FirstName IS NOT NULL AND @LastName IS NOT NULL AND @DateOfBirth IS NOT NULL AND @Gender IS NOT NULL)   SET @SQLQuery = @SQLQuery + ' AND M.Gender =''' + @Gender +''   else if (@Gender IS NOT NULL)   SET @SQLQuery = @SQLQuery + ' WHERE M.Gender =''' + @Gender + ''''      if (@FirstName IS NOT NULL AND @LastName IS NOT NULL AND @DateOfBirth IS NOT NULL AND @Gender IS NOT NULL AND @MaritalStatus IS NOT NULL)   SET @SQLQuery = @SQLQuery + ' AND M.MaritalStatus =''' + @MaritalStatus +''''   else if (@MaritalStatus IS NOT NULL)   SET @SQLQuery = @SQLQuery + ' WHERE M.MaritalStatus =''' + @MaritalStatus +''''      if (@FirstName IS NOT NULL AND @LastName IS NOT NULL AND @DateOfBirth IS NOT NULL AND @Gender IS NOT NULL AND @MaritalStatus IS NOT NULL AND @Address1 IS NOT NULL)   SET @SQLQuery = @SQLQuery + ' AND A.Address1 LIKE ''%'+@Address1+'%'''   else if (@Ad
CREATE Procedure [dbo].[sp_InsertProgramDetails]    AS  BEGIN            SET NOCOUNT ON       Begin try                  Begin transaction         select ic.InsuranceCarrierName,insdtl.InsuranceNbr,hp.HealthPlanName,insdtl.PrimaryInsuredName,ins.InsuranceEffectiveDate,ins.InsuranceEndDate,ins.InsuranceCarrierID,ins.InsuranceHealthPlanID, mp.MemberProfileId         into #tmpPrgDtl from [Master].[MemberInsurances] ins       left join [Master].[MemberInsuranceDetails] insdtl on ins.ID = insdtl.MemberInsuranceID       join [Insurance].[InsuranceCarriers] ic on ins.InsuranceCarrierID = ic.InsuranceCarrierID      join [Insurance].[InsuranceHealthPlans] hp on ins.InsuranceHealthPlanID = hp.InsuranceHealthPlanID      join [Master].[Members] m on m.MemberID= ins.MemberID      join [provider].[MemberProfiles] mp on mp.NHMemberId = m.NHMemberID      where m.DataSource = 'VanilaSoft' and ic.IsDiscountProgram = 1 and hp.IsDiscountProgram=1              --select * from #tmpPrgDtl     INSERT INTO [provider].[MemberProgramDetails]             (              [DiscountProgramCarrier]             ,[DiscountProgramMemberID]             ,[DiscountProgramName]             ,[DiscountProgramPrimaryMemberName]             ,[EffectiveFromDate]             ,[EffectiveToDate]             ,[InsuranceCarrierID]             ,[InsuranceHealthPlanID]             ,[IsActive]             ,[MemberProfileId]                        ,[UseForBenefits]       ,CreateUser       ,CreateDate       ,ModifyUser       ,ModifyDate)      select          InsuranceCarrierName,      InsuranceNbr,      HealthPlanName,      PrimaryInsuredName,      InsuranceEffectiveDate,      InsuranceEndDate,      InsuranceCarrierID,      InsuranceHealthPlanID,      1,      MemberProfileId,      1,      'System',      GETDATE(),       'System',      GETDATE()            from #tmpPrgDtl       Commit transaction                end try     Begin catch    declare @error int, @message varchar(4000), @xstate int;          select @error = ERROR_NUMBER(),                   @message = ERROR_MESSAGE(), @xstate = XACT_STATE();          if @xstate = -1              rollback transaction;          if @xstate = 1               rollback transaction            return;     End catch    END  
  CREATE PROCEDURE [dbo].[GetAllRecommandedOrderItems]  AS  BEGIN      -- SET NOCOUNT ON ADDED TO PREVENT EXTRA RESULT SETS FROM      -- INTERFERING WITH SELECT STATEMENTS.      SET NOCOUNT ON      -- SELECT STATEMENTS FOR PROCEDURE HERE     SELECT DISTINCT ITEMCODE as ROWID into #RowIDTable  from [ORDERS].[ORDERITEMS] where STATUS='ACTIVE' AND ITEMTYPE='OTC' AND ISACTIVE=1 group by ITEMCODE;   WITH OrderItem_uniqueRecord (ITEMCODE,QUANTITY) As(      SELECT  ITEMCODE, CONVERT(BIGINT,COUNT(ITEMCODE)) as QUANTITY   FROM [ORDERS].[ORDERITEMS]    where STATUS='ACTIVE' AND ITEMTYPE='OTC' AND ISACTIVE=1 Group by ITEMCODE)   SELECT ROW_NUMBER() OVER (ORDER BY R.ROWID) as ORDERID,R.ROWID as ITEMCODE,QUANTITY from #RowIDTable R,OrderItem_uniqueRecord T where R.ROWID=T.ITEMCODE order by QUANTITY desc    END  
-- =============================================    -- Author:  KALYANA GOBBURI    -- Create date: 4-Nov-2017    -- Description: PROCEDURE to Fetch the ANI Search Results    -- =============================================    CREATE PROCEDURE [dbo].[sp_ANISearchMember](     -- Add the parameters for the stored procedure here     @Phone              BIGINT = NULL)     AS    BEGIN     -- SET NOCOUNT ON added to prevent extra result sets from     -- interfering with SELECT statements.     SET NOCOUNT ON;         --   SELECT DISTINCT M.MemberID,M.NHMemberID,M.FirstName,M.LastName,M.DateOfBirth,M.Gender,M.MiddleInitial,M.IsActive,     --       A.Address1,A.Address2,A.City,A.State,A.Country,A.ZipCode,A.AddressTypeCode,     --       P.PhoneNbr,P.CountryCode,P.IsPreferredPhoneNumber,P.PhoneExtension,     --    EM.EmailAddress,     --    MA.AttributeTypeCode,MA.AttributeValue,     --    MI.InsuranceCarrierID,MI.InsuranceEffectiveDate,MI.InsuranceHealthPlanID,MI.InsuranceType,     --    MD.InsuranceNbr,     --    IC.InsuranceCarrierName,IC.MemberDataFileProvided,     --    IH.HealthPlanName,IH.HealthPlanNumber     --FROM Master.Members M     --LEFT JOIN Master.Addresses A on M.MemberID=A.MemberID     --LEFT JOIN Master.PhoneNumbers P on M.MemberID=P.MemberID     --LEFT JOIN Master.Emails EM on M.MemberID = EM.MemberID     --LEFT JOIN Master.MemberAttributes MA on M.MemberID=MA.MemberID     --LEFT JOIN Master.MemberInsurances MI on M.MemberID=MI.MemberID     --LEFT JOIN Master.MemberInsuranceDetails MD on MI.ID=MD.MemberInsuranceID     --LEFT JOIN Insurance.InsuranceCarriers IC on MI.InsuranceCarrierID=IC.InsuranceCarrierID     --LEFT JOIN Insurance.InsuranceHealthPlans IH on MI.InsuranceHealthPlanID=IH.InsuranceHealthPlanID     --WHERE P.PhoneNbr=@Phone         /*   SELECT DISTINCT M.MemberID,M.NHMemberID,M.FirstName,M.LastName,M.DateOfBirth,M.IsActive,          A.Address1,ISNULL(A.Address2,'') AS Address2,A.City,A.State,A.Country,A.ZipCode, A.AddressTypeCode, A.Country AS 'CountryCode', EM.EmailAddress,         IH.HealthPlanNumber,MI.InsuranceType,MI.InsuranceEffectiveDate,         MD.InsuranceNbr,         IC.InsuranceCarrierName, IH.HealthPlanName,         P.IsPreferredPhoneNumber, P.PhoneExtension, P.PhoneNbr ,ISNULL(MAX(OrderID),0) AS OrderNumber   FROM Master.Members M     LEFT JOIN Orders.Orders O ON O.NHMemberId = M.NHMemberID  AND O.IsActive = 1    LEFT JOIN Master.Addresses A on M.MemberID=A.MemberID  AND A.IsActive = 1   LEFT JOIN Master.PhoneNumbers P on M.MemberID=P.MemberID  AND P.IsActive = 1   LEFT JOIN Master.Emails EM on M.MemberID = EM.MemberID  AND EM.IsActive = 1   LEFT JOIN Master.MemberAttributes MA on M.MemberID=MA.MemberID AND MA.IsActive = 1    LEFT JOIN Master.MemberInsurances MI on M.MemberID=MI.MemberID  AND MI.IsActive = 1   LEFT JOIN Master.MemberInsuranceDetails MD on MI.ID=MD.MemberInsuranceID  AND MD.IsActive = 1   LEFT JOIN Insurance.InsuranceCarriers IC on MI.InsuranceCarrierID=IC.InsuranceCarrierID  AND IC.IsActive = 1   LEFT JOIN Insurance.InsuranceHealthPlans IH on MI.InsuranceHealthPlanID=IH.InsuranceHealthPlanID  AND IH.IsActive = 1   WHERE P.PhoneNbr=@Phone GROUP BY M.MemberID,M.NHMemberID,M.FirstName,M.LastName,A.Address1,A.Address2,A.City,A.State,A.Country,A.ZipCode,A.AddressTypeCode,     MD.InsuranceNbr, IC.InsuranceCarrierName,IH.HealthPlanName,M.DateOfBirth,M.IsActive, EM.EmailAddress,IH.HealthPlanNumber,MI.InsuranceType,MI.InsuranceEffectiveDate,    P.IsPreferredPhoneNumber,P.PhoneExtension, P.PhoneNbr    */        -- This has to be modified, front end need to be co-ordinated  SELECT DISTINCT    M.MemberID,    M.NHMemberID,    M.FirstName,    M.LastName,    M.DateOfBirth,    M.IsActive,    A.Address1,    ISNULL(A.Address2, '') AS Address2,    A.City,    A.State,    A.Country,    A.ZipCode,    A.AddressTypeCode,    A.Country AS 'CountryCode',    EM.EmailAddress,    IH.HealthPlanNumber,    MI.InsuranceType,    MI.InsuranceEffectiveDate,    MD.InsuranceNbr,    IC.InsuranceCarrierName,    IH.He
 CREATE Procedure [dbo].[proc_ProductModels]    @BrandCode varchar(50),    @EarmoldCode varchar(50),    @BrandFamilyCode varchar(50),    @FamilyProductCode varchar(50),    @ProductTypeCode varchar(50),    @TechnologyLevelCode varchar(50),    @ShellCode varchar(50),    @ReturnTable varchar(50)        as     begin               declare @query varchar(max)     declare @Schema varchar(50)     set @Schema='[Catalog]'        declare @ProductTypeResult varchar(max)    declare @EarmoldTypeResult varchar(max)    declare @TechnologyLevelResult varchar(max)    declare @FamilyProductResult varchar(max)    declare @ShellResult varchar(max)      declare @result varchar(max)       -- Brands (Start)   --  begin   --select 'brand' as Brand,'CatalogType' as CatalogType,'Connectivity' as Connectivity,'EarmoldTypes' as EarmoldTypes,'Families' as Families,'ProductLines' as ProductLines,'ProductTypes' as ProductTypes,'Shells' as Shells      --select * from Brands   -- end    -- Brands (End)        -- EarmoldTypes (Start)    if(@ReturnTable ='EarmoldType')   BEGIN         set @query = ''      set @query  = 'select EarmoldTypeCode from '+@Schema+'.EarMoldTypeRules where '          if (@BrandCode is not null)       set @query  = @query + ' BrandCode = '''+@BrandCode +''''        else       set @query  = @query + '1 = 1'      if (@EarmoldCode is not null)    begin     SELECT @result = COALESCE(@result + ',', '') +  CAST('''' + EarmoldTypeCode + ''''  AS VARCHAR(200)) + ''  FROM [Catalog].BrandFamilyRules  WHERE EarmoldTypeCode in (select * from  [Catalog].splitstring(@EarmoldCode)) group by EarmoldTypeCode    end       if (@result is not null)     set @query = 'Select * from '+@Schema+'.EarMoldTypes where EarmoldTypeCode in (' + @query + ') and EarmoldTypeCode in (' + @result + ')'       else        set @query = 'Select * from '+@Schema+'.EarMoldTypes where EarmoldTypeCode in (' + @query + ')'      --set @query = 'Select * from '+@Schema+'.EarMoldTypes where EarmoldTypeCode in (' + @query + ')'       --print @query    exec (@query)   END    -- EarmoldTypes (End)      else if(@ReturnTable ='BrandFamily')    -- BrandFamilies (Start)     BEGIN       set @query = ''      set @query  = 'select BrandFamilyCode from '+@Schema+'.BrandFamilyRules where '          if (@BrandCode is not null)       set @query  = @query + ' BrandCode = '''+@BrandCode+''''        else       set @query  = @query + '1 = 1'      set @query = @query + ' And '        if (@EarmoldCode is not null)       set @query  = @query + ' EarmoldTypeCode in (select * from [Catalog].splitstring('''+@EarmoldCode+'''))'         else       set @query  = @query + '1 = 1'      if (@ProductTypeCode is not null)    begin     SELECT @ProductTypeResult = COALESCE(@ProductTypeResult + ',', '') +  CAST('''' + BrandFamilyCode + ''''  AS VARCHAR(200)) + ''  FROM [Catalog].ProductTypeRules  WHERE ProductTypeCode in (select * from  [Catalog].splitstring(@ProductTypeCode)) group by BrandFamilyCode     set @result = @ProductTypeResult;    end         if (@TechnologyLevelCode is not null)    begin         SELECT @TechnologyLevelResult = COALESCE(@TechnologyLevelResult + ',', '') +  CAST('''' + BrandFamilyCode + ''''  AS VARCHAR(200)) + ''  from [Catalog].TechnologyLevelRules where TechnologyLevelCode in (select * from  [Catalog].splitstring(@TechnologyLevelCode)) group by BrandFamilyCode     if(@result is not null)      set @result = @result + @TechnologyLevelResult;     else      set @result = @TechnologyLevelResult;    end      if (@FamilyProductCode is not null)    begin         SELECT @FamilyProductResult = COALESCE(@FamilyProductResult + ',', '') +  CAST('''' + BrandFamilyCode + ''''  AS VARCHAR(200)) + ''  from [Catalog].FamilyProductRules where FamilyProductCode in (select * from  [Catalog].splitstring(@FamilyProductCode)) group by BrandFamilyCode     if(@result is not null)      set @result = @result + @FamilyProductResult;     else      set @result = @FamilyProductResult;    end      if (@ShellCode is not nu
-- =============================================  --EXEC InsertOrUpdateScriptSectionTypes 11, 'Scripts', 1, 'Scripts','Introduction100'  --SELECT * FROM [CallCenter].[ScriptSectionTypes]  -- =============================================  CREATE Procedure [dbo].[InsertOrUpdateScriptSectionTypes]  (      -- Add the parameters for the stored procedure here     @scriptSectionTypeId BIGINT = 0,        @createUser NVARCHAR(150)= null,     @isActive BIT,       @modifyUser NVARCHAR(150) = null,     @scriptSectionTypeName NVARCHAR(50) = null      )  AS  BEGIN      -- SET NOCOUNT ON added to prevent extra result sets from      -- interfering with SELECT statements.      SET NOCOUNT ON        -- Insert statements for procedure here    if not exists (SELECT 1 FROM [CallCenter].[ScriptSectionTypes])   BEGIN    DBCC CHECKIDENT ('[CallCenter].[ScriptSectionTypes]', RESEED, 1)    END   if exists (SELECT 1 FROM [CallCenter].[ScriptSectionTypes]  WHERE ScriptSectionTypeName = @scriptSectionTypeName)   BEGIN   UPDATE [CallCenter].[ScriptSectionTypes]    SET     IsActive = @isActive,     ModifyDate = getdate(),     ModifyUser = @modifyUser,     ScriptSectionTypeName = @scriptSectionTypeName    WHERE ScriptSectionTypeId = @scriptSectionTypeId   END   ELSE   BEGIN   INSERT INTO  [CallCenter].[ScriptSectionTypes]   (   CreateDate,    CreateUser,    IsActive,    ModifyDate,    ModifyUser,    ScriptSectionTypeName    )   VALUES   (    getdate(),     @createUser,     @isActive,     getdate(),     @modifyUser,     @scriptSectionTypeName    )   END   END  
CREATE Procedure [dbo].[proc_GetFeatures]      @brand nvarchar(max) = null,      @family nvarchar(max) = null,      @familyProduct nvarchar(max) = null,      @productType nvarchar(max) = null,      @connectivity nvarchar(max) = null,      @shell nvarchar(max) = null,      @productModel nvarchar(max) = null,      @earmold nvarchar(max) = null,      @powerLevel nvarchar(max) = null,      @pushButton nvarchar(max) = null,      @teleCoil nvarchar(max) = null,      @sendReceiver nvarchar(max) = null,      @material nvarchar(max) = null,      @coupling nvarchar(max)= null    as     select * from featurevalues where featurevalueid in     (select FeatureValueID from Rules_FeatureValues where    (Brand =  @brand or Brand is null) and    (Family =  @family or Family is null) and    (FamilyProduct =  @familyProduct or FamilyProduct is null) and    (ProductType =  @productType or ProductType is null) and    (Connectivity =  @connectivity or Connectivity is null) and    (Shell =  @shell or Shell is null) and    (ProductModel =  @productModel or ProductModel is null) and    (Earmold =  @earmold or Earmold is null) and    (PowerLevel =  @powerLevel or PowerLevel is null) and    (PushButton =  @pushButton or PushButton is null) and    (TeleCoil =  @teleCoil or TeleCoil is null) and    (SendReceiver =  @sendReceiver or SendReceiver is null) and    (Material =  @material or Material is null) and    (Coupling =  @coupling or Coupling is null)) or IsDefault = 'Y'        /*      select * from Rules_FeatureValues where    (Brand =  @brand or Brand is null) and    (Family =  @family or Family is null) and    (FamilyProduct =  @familyProduct or FamilyProduct is null) and    (ProductType =  @productType or ProductType is null) and    (Connectivity =  @connectivity or Connectivity is null) and    (Shell =  @shell or Shell is null) and    (ProductModel =  @productModel or ProductModel is null) and    (Earmold =  @earmold or Earmold is null) and    (PowerLevel =  @powerLevel or PowerLevel is null) and    (PushButton =  @pushButton or PushButton is null) and    (TeleCoil =  @teleCoil or TeleCoil is null) and    (SendReceiver =  @sendReceiver or SendReceiver is null) and    (Material =  @material or Material is null) and    (Coupling =  @coupling or Coupling is null)      */  
-- =====================================================================================================  -- select * from [Insurance].[HealthPlanContracts]   -- EXEC InsertorUpdateInsHealthPlanContracts 55, 1, 'NULL', '2017 TESTING INSURANCE CONTRACTS',  'Scripts', 'NULL', '11/12/2017',  --                                        '11/30/2018'   8, 38, 1,  'Scripts'  -- =====================================================================================================  CREATE PROCEDURE [dbo].[InsertorUpdateInsHealthPlanContracts]   -- Add the parameters for the stored procedure here        @healthPlanContractID BIGINT = 0,        @brandID BIGINT,         @brandName NVARCHAR(MAX) = null,         @contractName NVARCHAR(100),              @createUser NVARCHAR(MAX) = NULL,         @description NVARCHAR(200) = NULL,         @effectiveFromDate DATETIME,         @effectiveToDate DATETIME,         @insuranceCarrierID BIGINT,         @insuranceHealthPlanID BIGINT,         @isActive BIT,              @modifyUser NVARCHAR(MAX) = NULL                    AS  BEGIN   -- SET NOCOUNT ON added to prevent extra result sets from   -- interfering with SELECT statements.   SET NOCOUNT ON;      -- Insert statements for procedure here   if not exists (SELECT 1 FROM [Insurance].[HealthPlanContracts])   BEGIN    DBCC CHECKIDENT ('[Insurance].[HealthPlanContracts]', RESEED, 1)    END   if exists (SELECT 1 FROM [Insurance].[HealthPlanContracts]  WHERE HealthPlanContractID = @healthPlanContractID and InsuranceCarrierID = @insuranceCarrierID and InsuranceHealthPlanID = @insuranceHealthPlanID)   BEGIN   UPDATE  [Insurance].[HealthPlanContracts]     SET  BrandID = @brandID,      BrandName = @brandName,           ContractName= @contractName,          [Description] = @description,      EffectiveFromDate = @effectiveFromDate,      EffectiveToDate = @effectiveToDate,      InsuranceCarrierID = @insuranceCarrierID,      InsuranceHealthPlanID = @insuranceHealthPlanID,      IsActive = @isActive,      ModifyDate = getdate(),       ModifyUser = @modifyUser        WHERE   HealthPlanContractID = @healthPlanContractID   END   ELSE   BEGIN   INSERT INTO  [Insurance].[HealthPlanContracts]         (BrandID,         BrandName,         ContractName,         CreateDate,         CreateUser,         [Description],         EffectiveFromDate,         EffectiveToDate,         InsuranceCarrierID,         InsuranceHealthPlanID,         IsActive,        ModifyDate,         ModifyUser)   Values  (@brandID,        @brandName,        @contractName,        getdate(),        @createUser,        @description,        @effectiveFromDate,        @effectiveToDate,        @insuranceCarrierID,        @insuranceHealthPlanID,        @isActive,        getdate(),        @modifyUser)    END  END  
-- =====================================================================================================  -- SELECT * FROM [Insurance].[InsuranceHealthPlans]  -- EXEC InsertorUpdateInsHealthPlans 20, 'Scripts', 'Anthem MediBlue Access (PPO', 'NULL', 6, 1, 'Scripts', 0  -- =====================================================================================================  CREATE PROCEDURE [dbo].[InsertorUpdateInsHealthPlans]   -- Add the parameters for the stored procedure here        @insuranceHealthPlanID bigint = 0,           @createSource NVARCHAR(150),             @healthPlanName NVARCHAR(50),        @healthPlanNumber NVARCHAR(max) = null,        @insuranceCarrierID BIGINT,       @isActive BIT,       @modifySource NVARCHAR(150) = null,       @isDiscountProgram Nvarchar(10)             AS  BEGIN   -- SET NOCOUNT ON added to prevent extra result sets from   -- interfering with SELECT statements.   SET NOCOUNT ON;      -- Insert statements for procedure here   if not exists (SELECT 1 FROM [Insurance].[InsuranceHealthPlans])   BEGIN    DBCC CHECKIDENT ('[Insurance].[InsuranceHealthPlans]', RESEED, 1)    END   if exists (SELECT 1 FROM [Insurance].[InsuranceHealthPlans]  WHERE HealthPlanName = @healthPlanName and InsuranceCarrierID = @insuranceCarrierID)   BEGIN   UPDATE  [Insurance].[InsuranceHealthPlans]     SET  HealthPlanName = @healthPlanName,      HealthPlanNumber = @healthPlanNumber,           InsuranceCarrierID= @insuranceCarrierID,      IsActive = @isActive,      ModifyDate = getdate(),       ModifyUser = @modifySource,      IsDiscountProgram = @isDiscountProgram    WHERE   InsuranceHealthPlanID = @insuranceHealthPlanID   END   ELSE   BEGIN    INSERT INTO [Insurance].[InsuranceHealthPlans]        (CreateDate,         CreateUser,         HealthPlanName,         HealthPlanNumber,         InsuranceCarrierID,         IsActive,         ModifyDate,         ModifyUser,        IsDiscountProgram)     VALUES   (getdate(),        @createSource,         @healthPlanName,         @healthPlanNumber,         @insuranceCarrierID,         @isActive,         getdate(),           @modifySource,        @isDiscountProgram)    END     END  
-- =====================================================================================================  -- select * from [Insurance].[HealthPlanTollFreeNumbers]  --EXEC InsertorUpdateInsHealthPlanTollFreeNumbers 0,  'Scripts', '11/12/2017', '11/30/2018', 8, 38, 1,  'Scripts', 'www.test100.com', 0, 'Training', 1234567890  -- =====================================================================================================  CREATE Procedure [dbo].[InsertorUpdateInsHealthPlanTollFreeNumbers]   -- Add the parameters for the stored procedure here       @healthPlanTollID bigint = 0,           @createSource NVARCHAR(150),        @effectiveFromDate DATETIME,       @effectiveToDate DATETIME,       @insuranceCarrierID BIGINT,       @insuranceHealthPlanID bigint,       @isActive BIT,           @modifySource NVARCHAR(150) = null,       @screenPopUpUrl NVARCHAR(2000) = NULL,       @scriptID bigint,       @tollFreeCategory nvarchar(50) = NULL,       @tollFreeNbr bigint             AS  BEGIN   -- SET NOCOUNT ON added to prevent extra result sets from   -- interfering with SELECT statements.   SET NOCOUNT ON;      -- Insert statements for procedure here   if exists (SELECT 1 FROM [Insurance].[HealthPlanTollFreeNumbers]  WHERE HealthPlanTollID = @healthPlanTollID and InsuranceCarrierID = @insuranceCarrierID and InsuranceHealthPlanID = @insuranceHealthPlanID and ScriptID = @scriptID)   BEGIN   UPDATE  [Insurance].[HealthPlanTollFreeNumbers]     SET  EffectiveFromDate = @effectiveFromDate,      EffectiveToDate = @effectiveToDate,           InsuranceCarrierID= @insuranceCarrierID,      InsuranceHealthPlanID = @insuranceHealthPlanID,      IsActive = @isActive,      ModifyDate = getdate(),       ModifyUser = @modifySource,      ScreenPopUpUrl = @screenPopUpUrl,      ScriptID = @scriptID,      TollFreeCategory = @tollFreeCategory,      TollFreeNbr = @tollFreeNbr    WHERE   HealthPlanTollID = @healthPlanTollID   END   ELSE   BEGIN     INSERT INTO [Insurance].[HealthPlanTollFreeNumbers]       (CreateDate,       CreateUser,       EffectiveFromDate,       EffectiveToDate,       InsuranceCarrierID,       InsuranceHealthPlanID,       IsActive,       ModifyDate,      ModifyUser,       ScreenPopUpUrl,       ScriptID,       TollFreeCategory,       TollFreeNbr)     VALUES (getdate(),        @createSource,        @effectiveFromDate,        @effectiveToDate,        @insuranceCarrierId,        @insuranceHealthPlanID,        @isActive,        getdate(),        @modifySource,        @screenPopupUrl,        @scriptId,        @tollFreeCategory,        @tollFreeNbr)       END     END    
CREATE Procedure [dbo].[InsertorUpdateInsHealthPlanBenefits]   -- Add the parameters for the stored procedure here      @ContractBenefitID bigint = 0,      @BenefitAmt float = 0.0,      @BenefitAmtPer nvarchar(50) = null,      @BenefitFrequencyYears nvarchar(MAX) = null,      @BenefitFrequencyYearsBy nvarchar(50) = null,          @CreateUser nvarchar(MAX) = null,      @FittingCoPay float = 0.0,      @HealthPlanContractID int,      @HealthPlanContractInsuranceHealthPlanID bigint = null,      @HearingAidCoPay float,      @HearingAidCoPayPer nvarchar(50)= null,      @HearingExamCoPay float,      @InsurancePayerID nvarchar(MAX) = null,      @IsAbilityToBalanceBillMember bit,      @IsActive bit,      @IsClaimEqualToProductListPricePerDevice bit,      @IsClaimPayToPatient bit,      @IsDefaultBenefit bit,      @IsFileClaim bit,      @IsHearingAidBenefitVerificationRequired bit,      @IsMedicaidIsSecondaryCoverage bit,      @IsPMNPM bit,      @IsPriorAuth bit,      @IsRebate bit,          @ModifyUser nvarchar(MAX) = NULL,      @PMPMAmount float,      @RebatePercentage int                   AS  BEGIN   -- SET NOCOUNT ON added to prevent extra result sets from   -- interfering with SELECT statements.   SET NOCOUNT ON;      -- Insert statements for procedure here   if exists (SELECT 1 FROM [Insurance].[ContractBenefits]  WHERE ContractBenefitID = @ContractBenefitID and HealthPlanContractID = @HealthPlanContractID)   BEGIN      UPDATE  [Insurance].[ContractBenefits]     SET      BenefitAmt = @BenefitAmt,       BenefitAmtPer = @BenefitAmtPer,       BenefitFrequencyYears = @BenefitFrequencyYears,       BenefitFrequencyYearsBy = @BenefitFrequencyYearsBy,            FittingCoPay = @FittingCoPay,       HealthPlanContractID = @HealthPlanContractID ,       HealthPlanContractInsuranceHealthPlanID = @HealthPlanContractInsuranceHealthPlanID,       HearingAidCoPay = @HearingAidCoPay,       HearingAidCoPayPer = @HearingAidCoPayPer,       HearingExamCoPay = @HearingExamCoPay,       InsurancePayerID = @InsurancePayerID,       IsAbilityToBalanceBillMember = @IsAbilityToBalanceBillMember,       IsActive = @IsActive,       IsClaimEqualToProductListPricePerDevice = @IsClaimEqualToProductListPricePerDevice,       IsClaimPayToPatient = @IsClaimPayToPatient,       IsDefaultBenefit = @IsDefaultBenefit,       IsFileClaim = @IsFileClaim,       IsHearingAidBenefitVerificationRequired = @IsHearingAidBenefitVerificationRequired,       IsMedicaidIsSecondaryCoverage = @IsMedicaidIsSecondaryCoverage,       IsPMNPM = @IsPMNPM,       IsPriorAuth = @IsPriorAuth,       IsRebate = @IsRebate,       ModifyDate = getdate(),       ModifyUser = @ModifyUser,       PMPMAmount = @PMPMAmount,       RebatePercentage = @RebatePercentage        WHERE   ContractBenefitID = @ContractBenefitID   END   ELSE   BEGIN      INSERT INTO  [Insurance].[ContractBenefits]         (       BenefitAmt,       BenefitAmtPer,       BenefitFrequencyYears,       BenefitFrequencyYearsBy,       CreateDate,       CreateUser,       FittingCoPay,       HealthPlanContractID,       HealthPlanContractInsuranceHealthPlanID,       HearingAidCoPay,       HearingAidCoPayPer,       HearingExamCoPay,       InsurancePayerID,       IsAbilityToBalanceBillMember,       IsActive,       IsClaimEqualToProductListPricePerDevice,       IsClaimPayToPatient,       IsDefaultBenefit,       IsFileClaim,       IsHearingAidBenefitVerificationRequired,       IsMedicaidIsSecondaryCoverage,       IsPMNPM,       IsPriorAuth,       IsRebate,       ModifyDate,       ModifyUser,       PMPMAmount,       RebatePercentage      )   Values  (      @BenefitAmt,      @BenefitAmtPer,      @BenefitFrequencyYears,      @BenefitFrequencyYearsBy,      getdate(),      @CreateUser,      @FittingCoPay,      @HealthPlanContractID,      @HealthPlanContractInsuranceHealthPlanID,      @HearingAidCoPay,      @HearingAidCoPayPer,      @HearingExamCoPay,      @InsurancePayerID,      @IsAbilityToBalanceBillMember,      @IsActive,      @IsClaimEqualToProductListPri
-- =============================================  --SELECT * FROM [CallCenter].[ScriptSections]   --EXEC InsertorUpdateScriptSections @scriptSectionID, @createUser, @isActive, @modifyUser, @scriptID, @scriptSectionTypeId, @sectionScriptDescription  --EXEC InsertorUpdateScriptSections 2, 'Scripts', 1,  'Scripts', 1, 2, '<h5>Collecting the Member Information</h5><p>script not available</p>'  -- =============================================  CREATE Procedure [dbo].[InsertorUpdateScriptSections]  (      -- Add the parameters for the stored procedure here    @scriptSectionID BIGINT = 0,       @createUser NVARCHAR(150) = null,    @isActive BIT,      @modifyUser NVARCHAR(150) = null,    @scriptID BIGINT,     @scriptSectionTypeId BIGINT,     @sectionScriptDescription NVARCHAR(MAX) = null      )  AS  BEGIN      -- SET NOCOUNT ON added to prevent extra result sets from      -- interfering with SELECT statements.      SET NOCOUNT ON        -- Insert statements for procedure here   if exists (SELECT 1 FROM [CallCenter].[ScriptSections]  WHERE ScriptSectionID = @scriptSectionID)   BEGIN   UPDATE [CallCenter].[ScriptSections]    SET      isActive = @isActive,    modifyDate =  getdate(),    modifyUser = @modifyUser,    scriptID = @scriptID,     scriptSectionTypeId = scriptSectionTypeId,     sectionScriptDescription =  @sectionScriptDescription   WHERE ScriptSectionID = @scriptSectionID and scriptID = @scriptID    END   ELSE    BEGIN    INSERT INTO [CallCenter].[ScriptSections]    (      createDate,     createUser,    isActive,    modifyDate ,    modifyUser,    scriptID,     scriptSectionTypeId,     sectionScriptDescription     )   VALUES   (       getdate(),     @createUser,    @isActive,    getdate(),    @modifyUser,    @scriptID,     @scriptSectionTypeId,     @sectionScriptDescription   )   END       END  
create PROCEDURE [dbo].[anthem_elig_file_load_ssis_sp_merge]   @Client_Name varchar(20)  AS    -- Anthem  IF @Client_Name = 'ELIG_AM'    BEGIN     --BEGIN TRY   --BEGIN TRANSACTION ELIG_MERGE_MEMBERS_AM      EXEC [dbo].[anthem_elig_file_load_ssis_sp_merge_stg_to_anthemelig]      EXEC [dbo].[anthem_elig_file_load_ssis_sp_merge_anthemelig_to_masters]    -- COMMIT TRANSACTION ELIG_MERGE_MEMBERS_AM  -- PRINT 'SUCCESS'  -- END TRY    -- BEGIN CATCH    -- IF (@@TRANCOUNT > 0)  -- BEGIN  --  ROLLBACK TRANSACTION ELIG_MERGE_MEMBERS_AM  --  PRINT 'FAILED'  -- END    -- END CATCH    END    -- Ultimate    --IF @Client_Name = 'ELIG_UT'    --BEGIN    -- BEGIN TRY  -- BEGIN TRANSACTION ELIG_MERGE_MEMBERS_UT    --  EXEC [dbo].[anthem_elig_file_load_ssis_sp_merge_amembers]       --  EXEC [dbo].[anthem_elig_file_load_ssis_sp_merge_ainsurance]     --  EXEC [dbo].[anthem_elig_file_load_ssis_sp_merge_mmembers]     --  EXEC [dbo].[anthem_elig_file_load_ssis_sp_merge_minsurance]     -- COMMIT TRANSACTION ELIG_MERGE_MEMBERS_UT  -- PRINT 'SUCCESS'  -- END TRY    -- BEGIN CATCH    -- IF (@@TRANCOUNT > 0)  -- BEGIN  --  ROLLBACK TRANSACTION ELIG_MERGE_MEMBERS_UT  --  PRINT 'FAILED'  -- END    -- END CATCH    --END  
    CREATE Procedure [dbo].[proc_FilterModels]     @BrandID int,    @EarmoldID int,    @BrandFamilyID int,    @FamilyProductID int,    @ProductTypeID int,    @TechnologyLevelID int        as     begin               declare @query varchar(max)       -- Brands (Start)   --  begin     select * from Brands   -- end    -- Brands (End)        -- EarmoldTypes (Start)   BEGIN        set @query = ''      set @query  = 'select EarmoldID from Rule_EarmoldTypes where '          if (@BrandID > 0)       set @query  = @query + ' BrandID = '+ CAST (@BrandID as varchar)+''        else       set @query  = @query + '1 = 1'      set @query = 'Select * from EarmoldTypes where EarmoldID in (' + @query + ')'      -- print @query    exec (@query)   END    -- EarmoldTypes (End)        -- BrandFamilies (Start)     BEGIN       set @query = ''      set @query  = 'select BrandFamilyID from Rule_BrandFamilies where '          if (@BrandID > 0)       set @query  = @query + ' BrandID = '+ CAST (@BrandID as varchar)+''        else       set @query  = @query + '1 = 1'      set @query = @query + ' And '       if (@EarmoldID > 0)       set @query  = @query + ' EarmoldID = '+ CAST (@EarmoldID as varchar)+''        else       set @query  = @query + '1 = 1'      set @query = 'Select * from BrandFamilies where BrandFamilyID in (' + @query + ')'      --print @query    exec (@query)      END    -- BrandFamilies (End)      -- Family Products (Start)    BEGIN       set @query = ''      set @query  = 'select FamilyProductID from Rule_FamilyProducts where '          if (@BrandFamilyID > 0)       set @query  = @query + ' BrandFamilyID = '+ CAST (@BrandFamilyID as varchar)+''        else       set @query  = @query + '1 = 1'      set @query = @query + ' And '       if (@TechnologyLevelID > 0)       set @query  = @query + ' TechnologyLevelID = '+ CAST (@TechnologyLevelID as varchar)+''        else       set @query  = @query + '1 = 1'      set @query = 'Select * from FamilyProducts where FamilyProductID in (' + @query + ')'      --print @query    exec (@query)      END    -- Family Products (End)        -- Product Type (Start)    BEGIN       set @query = ''      set @query  = 'select ProductTypeID from Rule_ProductTypes where '          if (@BrandFamilyID > 0)       set @query  = @query + ' BrandFamilyID = '+ CAST (@BrandFamilyID as varchar)+''        else       set @query  = @query + '1 = 1'      set @query = @query + ' And '       if (@FamilyProductID > 0)       set @query  = @query + ' FamilyProductID = '+ CAST (@FamilyProductID as varchar)+''        else       set @query  = @query + '1 = 1'      set @query = 'Select * from ProductTypes where ProductTypeID in (' + @query + ')'      --print @query    exec (@query)      END    -- Product Type (End)      -- Technology Levels (Start)    BEGIN        set @query = ''      set @query  = 'select TechnologyLevelID from Rule_TechnologyLevels where '          if (@BrandFamilyID > 0)       set @query  = @query + ' BrandFamilyID = '+ CAST (@BrandFamilyID as varchar)+''        else       set @query  = @query + '1 = 1'      set @query = @query + ' And '       if (@ProductTypeID > 0)       set @query  = @query + ' ProductTypeID = '+ CAST (@ProductTypeID as varchar)+''        else       set @query  = @query + '1 = 1'      set @query = 'Select * from TechnologyLevels where TechnologyLevelID in (' + @query + ')'      --print @query    exec (@query)      END    -- Technology Levels (End)      -- Product Models (Start)     BEGIN           set @query = ''      set @query  = 'select ProductModelID from Rule_ProductModels where '          if (@BrandID > 0 and @EarmoldID = 0)       set @query  =  @query + ' BrandID = '+ CAST (@BrandID as varchar)+''     else       set @query  = @query + '1 = 1'      set @query = @query + ' And '      if (@EarmoldID > 0)       set @query  = @query + ' EarmoldID = '+ CAST (@EarmoldID as varchar)+''        else       set @query  = @query + '1 = 1'        set @query = @query + ' And '      if (@BrandFamilyID > 0)      
CREATE Procedure [dbo].[Get_HearingService_Testing_Item]  AS  BEGIN   -- SET NOCOUNT ON added to prevent extra result sets from   -- interfering with SELECT statements.   SET NOCOUNT ON;        -- Insert statements for procedure here   SELECT GETDATE()     as 'Nations_Date_Modified',     'NH_TESTING'    as 'Nations_ITM_ID',     'Hearing Test Completed' as 'ITM_DESCRIPTION',     0       as 'ITEM_PRICE',     '992591'     as 'Nations_PRO_CODE'    END  
-- =============================================  -- Author:  KALYANA GOBBURI  -- Create date: 16-Nov-2017  -- Description: <Description,,>  -- =============================================  CREATE Procedure [dbo].[sp_MoveOrderData]   AS  BEGIN   -- SET NOCOUNT ON added to prevent extra result sets from   -- interfering with SELECT statements.   SET NOCOUNT ON;   SET ANSI_WARNINGS OFF;      -- Insert statements for procedure here   INSERT INTO temp_MemberOrders(   NHMemberID        ,[MemberFirstName]        ,[MemberLastName]        ,[DispenserOrGN]        ,[OrderDate]        ,[LegalBusinessName]        ,[DBA]        ,[HCPEmail]        ,[ProviderAddress]        ,[ProviderCity]        ,[ProviderState]        ,[ProviderZipCode]        ,[ShipToName]        ,[ShiptoAddress]        ,[ShiptoCity]        ,[ShiptoState]        ,[ShiptoZipcode]        ,[MemberInsuranceCarrier]        ,[HearingTestCoPay]        ,[HearingAidCoPay]        ,[HAFittingCoPay]        ,[Comments]        ,[PaymentMethod]        ,[Price]        ,[AmountPaid]        ,[Last4CreditCard]        ,[CheckNo]        ,[CheckRoutingNo]        ,[CheckAccountNo]        ,[FinancingOption]        ,[PaymentComments]        ,[PONumber]        ,[PODate]        ,[FittingOrDeliveryDate]    ,[IsOrderCancelled]    ,[CancelledDate]    ,[CancelledReason]    ,[IsProductReturned]    ,[ReturnDate]    ,[ReturnReason]    ,[PaidViaCard]    ,[PaidViaCheck]    ,[FinanceAmount]    ,[Brand]    ,[LeftTechnologyLevel]    ,[LeftQuantity]    ,[LeftProductLine]    ,[LeftModelFamily]    ,[RightTechnologyLevel]    ,[RightQuantity]    ,[RightProductLine]    ,[RightModelFamily]    ,[ReturnReasonCode]    ,[MemberAddress]    ,[MemberCity]    ,[MemberState]    ,[MemberZipcode]    ,[IsProcessed]     )        --,[MemberResponsibility]   SELECT    VSO_M.NHMemberID,    O.[Member First Name],    O.[Member Last Name],    O.[Disp #],    O.[DateOrder Initiated],    O.[Legal Business Name],    O.[DBA],    O.[Email],    O.[Ship to Address],    O.[City],    O.[State],    O.[Zip],    O.[Legal Business Name],    O.[Ship to Address],    O.[City],    O.[State],    O.[Zip],    case      when O.[Program] like '%CVS%' or O.[Program] like '%Silverscript%' then 'Silverscript'      when O.[Program] like '%Central Health%' then 'Central Health Premier Plan'     when O.[Program] like '%BCBS%' then 'BCBSFEP'     else O.[Program]     end as [Program],    S.[TEST            CO-PAY],    S.[HA             CO-PAY],    S.[HA FITTING CO-PAY],    O.[Notes],    O.[ Payment Type],    O.[Purchase Price],    S.[Member Pymt Amt],    O.[Last 4 digits Check #],    O.[Last 4 digits Check #],    O.[ABA/Transit #],    O.[Bank Acct number],    O.[ Payment Type],    S.[Notes],    O.[PO Number],    O.[PO/Order Sent],    VSO.FittingDate    ,T2.[IsOrderCancelled]    ,T2.[CancelledDate]    ,T2.[CancelledReason]    ,T3.[IsProductReturned]    ,T3.[ReturnDate]    ,T3.[ReturnReason]    ,T4.[Paid Via Card]    ,T4.[Paid Via Check]    ,T4.[Finance Amount]    ,VSO.Brand    ,T1.LeftTechnologyLevel    ,T1.LeftQuantity    ,VSO.LeftProductLine    ,VSO.LeftModelFamily    ,T1.RightTechnologyLevel    ,T1.RightQuantity    ,VSO.RightProductLine    ,VSO.RightModelFamily    ,SR.[Reason code]    ,VSO_M.MemberAddress    ,VSO_M.MemberCity    ,VSO_M.MemberState    ,VSO_M.MemberZipCode    ,0   FROM ['2017 HA Order Log$'] O   LEFT JOIN ['2017 HA Sales Receipts$'] S ON O.[PO Number]=S.[PO Number]   LEFT JOIN ['Fitting & Delivery Log$'] F ON O.[PO Number]=F.[PO Number]   LEFT JOIN ['Not Approved Log$'] NA ON O.[DateOrder Initiated]=NA.[Order Date]   LEFT JOIN ['Refund of Deposit$'] RD ON O.[PO Number]=RD.[PO]   LEFT JOIN ['Sales Returns$'] SR ON O.[PO Number]=SR.[PO]   LEFT JOIN    (    select [PO Number], [Product Family/Model], [Qty],     case when [Qty] > 0      then 1      else 0      end as [LeftQuantity],     case when [Qty] > 0 then [Technology Level] else NULL end as [LeftTechnologyLevel],     case when [Qty] = 2 then [Technology Level] else NULL end as [RightTechnology
create function [dbo].[getproductmodelcode]  (      @OrderId bigint,   @itemcode nvarchar(50),   @color nvarchar(30)        ) returns nvarchar(50)  as  begin        declare @productmodelcodeOriginal nvarchar(50) = null;         declare @productmodelcode nvarchar(50) = null;   declare @ReceiverCode nvarchar(50) = null;      set @productmodelcode =(select top 1 VendorCode from [catalog].[ItemMasterAttributeValues] IMA    inner join [Orders].[OrderItems] OI on IMA.ItemCode = @itemcode      and IMA.AttributeCode = 'COLOR'  and ltrim(rtrim(IMA.ModelAttributeValue)) = @color and OI.OrderId = @OrderId);      set @ReceiverCode = (select top 1 VendorCode from [catalog].[ItemMasterAttributeValues] IMA   inner join [Orders].[OrderItems] OI on IMA.Modifier = OI.Modifier and IMA.ItemCode = @itemcode   and IMA.ItemCode = @itemcode  and IMA.attributeCode = 'RECIEVER_POWER' and ltrim(rtrim(REPLACE(ModelAttributeValue,',',''))) =  JSON_VALUE(OI.ItemData,'$.receiverPower'));         if(@ReceiverCode is null)     BEGIN   set @ReceiverCode = (select top 1 VendorCode from [catalog].[ItemMasterAttributeValues] IMA    inner join [Orders].[OrderItems] OI on IMA.Modifier = OI.Modifier and IMA.ItemCode = @itemcode    and IMA.ItemCode = @itemcode  and IMA.attributeCode = 'RECIEVER_SIZES' and ltrim(rtrim(REPLACE(ModelAttributeValue,',',''))) =  JSON_VALUE(OI.ItemData,'$.receiverSize'));   END       set @productmodelcodeOriginal = (select ModelCode from catalog.ItemMasterList where ItemCode = @itemcode);       if (@productmodelcode is null)    BEGIN      if (@ReceiverCode is not null)      BEGIN      set @productmodelcode = @ReceiverCode;     END   else     BEGIN        if(@itemcode = 'EARMOLD')      BEGIN      set @productmodelcode = 'EARMOLD';      END      ELSE        BEGIN      set @productmodelcode = @productmodelcodeOriginal;      END       END     END     return @productmodelcode;    end
  -- EXEC [dbo].[sp_rpt_qb_ff_payment_checks]    CREATE procedure [dbo].[sp_rpt_qb_ff_payment_checks]  as  select IP.*,  cp.PONumber, cp.paymentMethod,cp.paymentDate,cp.checkNum  from (    select   d.InvoiceBatchId  ,p.providerid  ,p.vendorName  ,p.paymentAmount  --,CAST(p.paymentDate AS DATE) paymentDate  ,i.invoiceId  ,CAST(i.date AS DATE) FittingDate  ,i.reference  ,i.originalAmount  ,i.payment  ,NULL as BalanceDue  ,NULL as Discount  ,'Bill' Type  from paymentgateway.invoicedata d  outer apply openjson(d.invoicecheckdata) with (         checks nvarchar(max) as json  ) f  outer apply openjson(f.checks) with(         providerId bigint,         vendorName varchar(200),         paymentAmount decimal(10,2),         paymentDate varchar(50),         invoices nvarchar(max) as json  ) p  outer apply openjson(p.invoices) with(         invoiceId bigint,         date varchar(50),         reference varchar(100),         originalAmount decimal(10,2),         payment decimal(10,2)  ) i  ) IP    left JOIN  (  select   i.InvoiceId,   i.PONumber  --, i.InvoiceAmount  --, JSON_VALUE(i.PaymentData,'$.invoicePayment') invoicePayment  , JSON_VALUE(i.PaymentData,'$.paymentMethod') paymentMethod  , i.BatchId  , JSON_VALUE(i.PaymentData,'$.payData.paymentDate') paymentDate,  cast(JSON_VALUE(i.PaymentData,'$.payData.checkNum') as bigint) checkNum  from accounts.Invoices i  where 1=1  and i.Status='Paid'  and BatchId is not null  ) CP ON (CP.InvoiceId=IP.invoiceId AND CP.BatchId=IP.InvoiceBatchId)  
    CREATE PROCEDURE [dbo].[DataSync_Sync_HCPs_4PVN]  AS  BEGIN  --ADD/UPDATE USERPROFILE FOR HCP  merge [auth].[UserProfiles] up  using [dbo].[ProviderDataHCPs] sp  on (sp.hcpid is not null and up.userprofileid = (select top 1 userprofileid from provider.hcpproviderprofile where hcpid = sp.hcpid))  when matched and sp.Action = 'U' and ((sp.npinumber is not null and sp.npinumber != '') or (sp.nhnpi is not null and sp.nhnpi != '')) then   update set  up.FirstName = (case sp.FirstName when '' then null else sp.FirstName end)  ,up.IsActive = 1  ,up.IsBlocked = 0  ,up.IsEnabled = 1  ,up.IsRegister = 1  ,up.LastName = (case sp.LastName when '' then null else sp.LastName end)  ,up.ModifyDate = getdate()  ,up.ModifyUser = 'SyncProc'   when not matched and sp.Action = 'N' and ((sp.npinumber is not null and sp.npinumber != '') or (sp.nhnpi is not null and sp.nhnpi != ''))   and (select count(*) userprofileid from provider.hcpproviderprofile where hcpid = sp.hcpid) = 0 then   insert (   CreateDate  ,CreateUser  ,FirstName  ,IsActive  ,IsBlocked  ,IsEnabled  ,IsRegister  ,LastName  ,ModifyDate  ,ModifyUser  ,TemproryKeyCode  ,UserName  ) values (getdate(),'SyncProc',(case sp.FirstName when '' then null else sp.FirstName end),1,0,1,1,(case sp.LastName when '' then null else sp.LastName end),getdate(),'SyncProc',  (case when sp.npinumber is null or sp.npinumber = '' then sp.nhnpi else sp.npinumber end),  (case when sp.npinumber is null or sp.npinumber = '' then sp.nhnpi else sp.npinumber end));    --ADD/UPDATE HCP PROFILES  merge [provider].[HcpProviderProfile] HPP  using [dbo].[ProviderDataHCPs] PLH  on (PLH.hcpid = HPP.hcpid)  when matched and PLH.Action = 'U' and plh.hcpid is not null and ((plh.npinumber is not null and plh.npinumber != '') or (plh.nhnpi is not null and plh.nhnpi != '')) then   update set  HPP.FirstName = (case PLH.FirstName when '' then null else PLH.FirstName end)  ,HPP.LastName = (case PLH.LastName when '' then null else PLH.LastName end)  ,HPP.NPINumber = PLH.NPINumber  ,HPP.NHNPI = PLH.NHNPI  ,HPP.IsActive = PLH.IsActive  ,HPP.LicenseData = concat('{"licenseNumber1":"',(case [PLH].[LicenseNumber1] when null then '' else [PLH].[LicenseNumber1] end),'",','"licenseStates1":"',  (case [PLH].[LicenseState1] when null then '' else [PLH].[LicenseState1] end),'",','  "licenseNumber2":"',(case [PLH].[LicenseNumber2] when null then '' else [PLH].[LicenseNumber2] end),'",','"licenseStates2":"',  (case [PLH].[LicenseState1] when null then '' else [PLH].[LicenseState1] end),'",','  "licenseNumber3":"',(case [PLH].[LicenseNumber3] when null then '' else [PLH].[LicenseNumber3] end),'",','"licenseStates3":"',  (case [PLH].[LicenseState3] when null then '' else [PLH].[LicenseState3] end)  ,'",','"boardCertified":"',(case [PLH].[BoardCertified] when null then '' else [PLH].[BoardCertified] end),'",','"credentialDate":"', (case [PLH].[CredentialDate] when null then '' else [PLH].[CredentialDate] end),'"}')  ,HPP.ModifyDate = getdate()  ,HPP.ModifyUser = 'SyncProc'  when not matched and PLH.Action = 'N' and ((plh.npinumber is not null and plh.npinumber != '') or (plh.nhnpi is not null and plh.nhnpi != ''))   and (select count(*) from auth.userprofiles where username in (plh.npinumber, plh.nhnpi, concat(substring(plh.firstname, 0, 1), plh.lastname))) > 0 then   insert (FirstName, LastName, NPINumber, IsActive,LicenseData, NHNPI,CreateDate,CreateUser, ModifyDate, ModifyUser, UserProfileId)   values(  (case PLH.FirstName when '' then null else PLH.FirstName end), (case PLH.LastName when '' then null else PLH.LastName end), PLH.NPINumber, PLH.IsActive,  concat('{"licenseNumber1":"',(case [PLH].[LicenseNumber1] when null then '' else [PLH].[LicenseNumber1] end),'",','"licenseStates1":"',  (case [PLH].[LicenseState1] when null then '' else [PLH].[LicenseState1] end),'",','  "licenseNumber2":"',(case [PLH].[LicenseNumber2] when null then '' else [PLH].[LicenseNumber2] end),'",','"licenseStates2":"',  (case [PLH].[LicenseState1] when null the
CREATE PROCEDURE [dbo].[sp_GetActiveInsurances]      (       @MemberProfileID          BIGINT = 0      )      AS      BEGIN       SET NOCOUNT ON;   SELECT ROW_NUMBER() OVER (ORDER BY InsuranceCarrierName) RowID,   [Status],   InsuranceCarrierName,   HealthPlanName,   NHMemberId,   InsuranceEffectiveDate,   InsuranceEndDate,   InsuranceType     FROM  (SELECT        CASE WHEN mi.InsuranceEndDate  >= GETDATE() THEN 'Active'        ELSE 'Inactive' END AS[Status],   ic.InsuranceCarrierName,   hp.HealthPlanName,   mp.NHMemberId,   mi.InsuranceEffectiveDate,   mi.InsuranceEndDate,   mi.InsuranceType      FROM [provider].[MemberInsurances] mi    INNER JOIN [provider].[MemberProfiles] mp ON mp.MemberProfileID = mi.MemberProfileId  AND mi.IsActive = 1       INNER JOIN [Insurance].[InsuranceCarriers] ic ON mi.InsuranceCarrierID = ic.InsuranceCarrierID AND ic.IsActive =1        INNER JOIN [Insurance].[InsuranceHealthPlans] hp ON mi.InsuranceHealthPlanID = hp.InsuranceHealthPlanID AND hp.IsActive = 1   WHERE mi.MemberProfileID = @MemberProfileID) tmp    END      
    CREATE  PROCEDURE [dbo].[DataSync_Sync_LocationHCPsMapping_4PVN]  AS  BEGIN    --Insert into ProviderUsers    insert into [provider].[ProviderUsers] ( userprofileid,providerid, createdate, createuser, isactive, modifydate, modifyuser)    select userprofileid, providerid, getdate(), 'SyncProc',1 ,getdate(), 'SyncProc' from(  select distinct(select userprofileid from [provider].[HCPProviderProfile]   where hcpid = pp.hcpid) userprofileid,(select providerid from [provider].[ProviderProfiles] where taxid = pp.taxid) providerid from [dbo].[ProviderDataHCPMapping] pp  where exists (select 1 from [auth].[UserProfiles] up where pp.npinumber = up.username or pp.nhnpi = up.username)   and not exists   (select 1 from provider.providerusers p   where p.providerid = pp.providerid   and p.userprofileid in (select userprofileid from [provider].[HCPProviderProfile]   where hcpid = pp.hcpid))  )a where providerid is not null and userprofileid is not null      ----Insert into ProviderUsersLocations  merge [provider].[ProviderUserLocations] pul  using [dbo].[ProviderDataHCPMapping] hm  on (pul.locationId = hm.locationId and pul.userProfileId = (select top 1 userprofileid from provider.hcpproviderprofile where hcpid = hm.hcpid and userprofileid is not null))  when matched and hm.Action = 'U' then  update set pul.ProviderId = hm.ProviderId,pul.locationId = hm.locationId, pul.IsActive = hm.IsActive,   pul.modifyDate = getdate(), pul.modifyUser = 'SyncProc'  when not matched and hm.Action = 'N' then  insert ([ProviderId], [LocationId], [UserProfileId], [CreateDate], [CreateUser], [IsActive], [ModifyDate], [ModifyUser])  values (hm.providerId, hm.locationId, (select top 1 userprofileid from provider.hcpproviderprofile where hcpid = hm.hcpid), getdate(), 'SyncProc', 1, getdate(), 'SyncProc');      /*  insert into [provider].[ProviderUserLocations] (userprofileid,providerid, locationid, createdate, createuser, isactive, modifydate, modifyuser)  select distinct(select userprofileid from [provider].[HCPProviderProfile]   where hcpid = pp.hcpid) userprofileid, providerid, locationid, getdate(),'SyncProc',1 ,getdate(), 'SyncProc'   from [dbo].[ProviderDataHCPMapping] pp  where exists (select 1 from [auth].[UserProfiles] up where pp.npinumber = up.username or pp.nhnpi = up.username)   and locationid <>''   and not exists (select 1 from [provider].[ProviderUserLocations] upl where pp.providerid = upl.providerid and pp.locationid = upl.locationid and   (select userprofileid from [provider].[HCPProviderProfile] where hcpid = pp.hcpid) = upl.userprofileid)     */  --update [dbo].[ProviderDataHCPMapping] set [Action] = ''    END    --------
    CREATE PROCEDURE [dbo].[DataSync_Sync_Locations_4PVN]  AS  BEGIN  update provider.locations set officesecodary = null  delete from [dbo].[ProviderDataLocations] where taxid is null    Alter table [dbo].[ProviderDataLocations] add id INT IDENTITY(1,1) NOT NULL    merge [provider].[Locations] l  using [dbo].[ProviderDataLocations] sl  on (cast(case sl.locationid when '' then 0 when null then 0 when 'NULL' then 0 else sl.locationid end as int) = l.locationid)  when matched and sl.Action = 'U' and sl.address1 <> ''and sl.address1 <> 'NULL' then   update set  l.Address1 = sl.Address1  ,l.Address2 = sl.Address2  ,l.BusinessName = sl.BusinessName  ,l.City = sl.City  ,l.Dispenser = sl.Dispenser  ,l.IsActive = sl.IsActive  ,l.IsVerified = 1  ,l.IsWheelChair = case when sl.WheelChair = 'Yes' then 1 else 0 end  ,l.Langauges = sl.Languages  ,l.LocationTypeId = 1  ,l.ModifyDate = getdate()  ,l.ModifyUser = 'SyncProc'  ,l.NPINumber = sl.NPINumber  ,l.OfficeSecodary = sl.ID  ,l.State = sl.State  ,l.[LocationEmailAddress] = sl.[LocationEmailAddress]  ,l.Zip = format(cast(sl.Zip as int),'00000')  ,l.[LocationServicesData] = (concat('{"mobileServices":',case when sl.WheelChair = 'Yes' then 1 else 0 end,',','"wheelChair":',case when sl.WheelChair = 'Yes' then 1 else 0 end, ',',   '"peditatricServices":',case when sl.WheelChair = 'Yes' then 1 else 0 end, '}'))  when not matched and sl.Action = 'N' and sl.address1 <> '' and sl.address1 <> 'NULL' then   insert   (  Address1,Address2,BusinessName,City,CreateDate  ,CreateUser,Dispenser,IsActive,IsVerified  ,IsWheelChair,Langauges  ,LocationTypeId  ,ModifyDate,ModifyUser,NPINumber,OfficeSecodary  ,State,LocationEmailAddress,Zip  ,[LocationServicesData]  )   values  (  sl.Address1,sl.Address2,sl.BusinessName,sl.City  ,getdate(),'SyncProc',sl.Dispenser  ,sl.IsActive  ,1,case when sl.WheelChair = 'Yes' then 1 else 0 end  ,Languages  ,1,getdate(),'SyncProc',NPINumber  ,sl.ID,State,sl.[LocationEmailAddress],format(cast(Zip as int),'00000'),  (concat('{"mobileServices":',case when sl.WheelChair = 'Yes' then 1 else 0 end,',','"wheelChair":',case when sl.WheelChair = 'Yes' then 1 else 0 end, ',',   '"peditatricServices":',case when sl.WheelChair = 'Yes' then 1 else 0 end, '}'))   );    --Step 4    --Updating LocationID  & Provider ID in .csv created file for future inserts   update sl   set sl.locationid = (select cast(pl.locationid as varchar) from [provider].[Locations] pl where pl.OfficeSecodary = sl.ID)   from [dbo].[ProviderDataLocations] sl   where  sl.locationid =''      --UPDATE/INSERT LOCATION PHONE NUMBERS  merge provider.locationphonenumbers lpn  using [dbo].[ProviderDataLocations] pl  on (cast(case pl.locationid when '' then 0 when null then 0 when 'NULL' then 0 else pl.locationid end as int) = lpn.locationid     and lpn.phoneTypeid=1 and pl.[LocationPhoneNumber] <> '' and pl.[LocationPhoneNumber] <> 'NULL')  when matched and pl.[LocationPhoneNumber] <> '' and pl.[LocationPhoneNumber] <> 'NULL' then update set  lpn.IsVerified=0,  lpn.ModifyUser='SyncProc',  lpn.ModifyDate=getdate(),  lpn.phonenumber=SUBSTRING(pl.locationPhoneNumber,0,12) ,  lpn.phoneserviceareatypeid=1  when not matched and pl.[LocationPhoneNumber] <> '' and pl.[LocationPhoneNumber] <> 'NULL' and pl.locationid != '' and pl.locationid != 'NULL' and pl.locationid is not null then   insert(  [CreateDate],[CreateUser],[IsActive],[IsVerified],  [LocationId]  ,[ModifyDate],[ModifyUser],  [PhoneNumber],  [PhoneServiceAreaTypeId],  [PhoneTypeId])  values(  getdate(),'SyncProc',1,0,  pl.locationid,  getdate(),'SyncProc',  SUBSTRING(pl.locationPhoneNumber,0,12) ,  1,1  );    merge provider.locationphonenumbers lpn  using [dbo].[ProviderDataLocations] pl  on (cast(case pl.locationid when '' then 0 when null then 0 when 'NULL' then 0 else pl.locationid end as int) = lpn.locationid     and lpn.phoneTypeid=3 and pl.[LocationFaxNumber] <> '' and pl.[LocationFaxNumber] <> 'NULL')  when matched then update set  lpn.IsVerified=0,  lpn.ModifyUse
  CREATE PROCEDURE [dbo].[DataSync_Sync_Providers_4PVN]  AS  BEGIN  merge [provider].[ProviderProfiles] pp  using [dbo].[ProviderDataProviders] sp  on (sp.providerid = pp.providerid)  when matched and sp.Action = 'U' and sp.[TaxId] is not null then  update set   pp.[TaxId] = sp.[TaxId],  pp.[ProviderName] = (case sp.[ProviderName] when '' then null else sp.[ProviderName] end),  pp.[IsActive]= cast(case sp.[IsActive] when '1' then 1 when '0' then 0 when '' then 1 else sp.[IsActive] end as bit),  pp.[Brands]= (case sp.[Brands] when '' then null else sp.[Brands] end),  pp.[PracticeTypeId]= sp.[PracticeTypeId],  pp.[PrimaryEmailAddress]= (case sp.[PrimaryEmailAddress] when '' then null else sp.[PrimaryEmailAddress] end),  pp.[AdditionalData] = (concat('{"billingAddress":{"address1":"',isnull(sp.[BillingAddress],''),'","address2":"","city":"',isnull(sp.[BillingCity],''),'","state":"',isnull(sp.[BillingState],''),   '","zip":"',cast(sp.[BillingZip] as nvarchar(10)),'","county":"',isnull(sp.[BillingCounty],''),'","phoneNumber":"',isnull(sp.[BillingPhoneNumber],''),'","email":""},"shippingAddress":{"address1":"',isnull(sp.[ShippingAddress],''),'","address2":"',isnull(sp.[ShippingAddress2],''),'","city":"',isnull(sp.[ShippingCity],''),   '","state":"',isnull(sp.[ShippingState],''),'","zip":"',isnull(sp.[ShippingZip],''),'","county":"","phoneNumber":"","email":""},"owner":{"firstName":"',isnull(sp.[OwnerFirstName],''),'","lastName":"',isnull(sp.[OwnerLastName],''),'"},"contractInfo":{"contractType":"',isnull(sp.[ContractType],''),'","initialContractDate":"',isnull(sp.[InitialContract],''),  '","recentContractDate":"',isnull(sp.[RecentContract],''),'","contractTerminationDate":"',isnull(sp.[ContractTermination],''),'","anthemAmendmentDate":"',isnull(sp.[AnthemAmendment],''),'"},"adaAttestationReceivedDate":"',isnull(sp.[ADAAttestationReceivedDate],''),'","medicareAttestationReceivedDate":"',isnull(sp.[MedicareAttestationReceivedDate],''),'"}')   )    when not matched and sp.Action = 'N' then   insert ([Brands],[IsActive],[PracticeTypeId],[PrimaryEmailAddress],[ProviderName],[TaxId],[CreateDate],[CreateUser],[ModifyDate],[ModifyUser],[Prospect],[AdditionalData])  values (  (case sp.[Brands] when '' then null else sp.[Brands] end),  1,1,(case sp.[PrimaryEmailAddress] when '' then null else sp.[PrimaryEmailAddress] end)  ,(case sp.[ProviderName] when '' then null else sp.[ProviderName] end),  sp.[TaxId],getdate(), 'SyncProc',getdate(),'SyncProc',0,  (concat('{"billingAddress":{"address1":"',isnull(sp.[BillingAddress],''),'","address2":"","city":"',isnull(sp.[BillingCity],''),'","state":"',isnull(sp.[BillingState],''),   '","zip":"',cast(sp.[BillingZip] as nvarchar(10)),'","county":"',isnull(sp.[BillingCounty],''),'","phoneNumber":"',isnull(sp.[BillingPhoneNumber],''),'","email":""},"shippingAddress":{"address1":"',isnull(sp.[ShippingAddress],''),'","address2":"',isnull(sp.[ShippingAddress2],''),'","city":"',isnull(sp.[ShippingCity],''),   '","state":"',isnull(sp.[ShippingState],''),'","zip":"',isnull(sp.[ShippingZip],''),'","county":"","phoneNumber":"","email":""},"owner":{"firstName":"',isnull(sp.[OwnerFirstName],''),'","lastName":"',isnull(sp.[OwnerLastName],''),'"},"contractInfo":{"contractType":"',isnull(sp.[ContractType],''),'","initialContractDate":"',isnull(sp.[InitialContract],''),  '","recentContractDate":"',isnull(sp.[RecentContract],''),'","contractTerminationDate":"',isnull(sp.[ContractTermination],''),'","anthemAmendmentDate":"',isnull(sp.[AnthemAmendment],''),'"},"adaAttestationReceivedDate":"',isnull(sp.[ADAAttestationReceivedDate],''),'","medicareAttestationReceivedDate":"',isnull(sp.[MedicareAttestationReceivedDate],''),'"}')   ));    --Step 2  update provider.providerprofiles   set brands = 'INDEPENDENT' where brands = 'Independent'  update provider.providerprofiles   set brands = 'BELTONE' where brands = 'Beltone Franchise'    --INSERT USER PROFILE FOR PROVIDER OWNER  merge [auth].[UserProfiles] up  using [dbo].[ProviderD
--execute [dbo].[GlobalHealth_OutBound_Roaster]  CREATE PROCEDURE [dbo].[GlobalHealth_OutBound_Roaster]    AS  BEGIN      SET NOCOUNT ON    --SELECT * FROM [auth].[UserProfiles]     --  WHERE userprofileid not in(    --    SELECT userprofileid FROM [provider].[HCPProviderProfile])     --  and userprofileid in     --    (SELECT userprofileid FROM [auth].[UserProfileGroups] WHERE usergroupid = 7600)      --INSERT INTO [provider].[HCPProviderProfile]    --SELECT [FirstName],1,[LastName],null,null,null,userprofileid,null,Designation,null,null,getdate(),'testramu',getdate(),'testramu',null,null,0,null,null,null,null,null    --FROM [auth].[UserProfiles] where userprofileid not in(    --SELECT userprofileid FROM [provider].[HCPProviderProfile]) and userprofileid in (SELECT userprofileid FROM [auth].[UserProfileGroups] WHERE usergroupid = 7600)    --- 1. Create Temporary Table to find HCP Oklahoma License Number    DROP TABLE IF EXISTS hcpTempLicenseStateNumbers;    CREATE TABLE hcpTempLicenseStateNumbers (HCPID BIGINT NOT NULL, [State] NVARCHAR(50)  NOT NULL, Number NVARCHAR(100) NOT NULL);  INSERT INTO hcpTempLicenseStateNumbers  SELECT HCPID,    JSON_VALUE(LicenseData, '$.licenseStates1') AS State   ,JSON_VALUE(LicenseData, '$.licenseNumber1') AS Number  FROM  [provider].[HCPProviderProfile]   WHERE 1=1   AND JSON_VALUE(LicenseData, '$.licenseStates1') IN ('Oklahoma', 'Ok')   AND JSON_VALUE(LicenseData, '$.licenseNumber1') IS NOT NULL   AND JSON_VALUE(LicenseData, '$.licenseNumber1') <> ''   UNION  SELECT HCPID,    JSON_VALUE(LicenseData, '$.licenseStates2') AS [State]   ,JSON_VALUE(LicenseData, '$.licenseNumber2') AS Number  FROM  [provider].[HCPProviderProfile]   WHERE 1=1   AND JSON_VALUE(LicenseData, '$.licenseStates2') IN ('Oklahoma', 'Ok')   AND JSON_VALUE(LicenseData, '$.licenseNumber2') IS NOT NULL   AND JSON_VALUE(LicenseData, '$.licenseNumber2') <> ''   UNION  SELECT HCPID,    JSON_VALUE(LicenseData, '$.licenseStates3') AS [State]   ,JSON_VALUE(LicenseData, '$.licenseNumber3') AS Number  FROM  [provider].[HCPProviderProfile]   WHERE 1=1   AND JSON_VALUE(LicenseData, '$.licenseStates3') IN ('Oklahoma', 'Ok')   AND JSON_VALUE(LicenseData, '$.licenseNumber3') IS NOT NULL   AND JSON_VALUE(LicenseData, '$.licenseNumber3') <> ''     ---SELECT * FROM hcpTempLicenseStateNumbers;    --- 2. Display COMPLETE ROASTER (sheet-4) list of HCP's and their location details    SELECT  '' AS [Original Credentialing Committee Date]    , ISNULL(hcp.[LastName],'') AS [Last Name]    , ISNULL(hcp.[FirstName],'') AS [First Name]    , ISNULL(hcp.[MiddleName],'') AS [Middle]    , '' AS [Degree]    , ISNULL(up.[Gender],'') AS [Gender]    , ISNULL(hcp.[NPINumber],'') AS [Individual NPI#]    , REPLACE(replace(isnull(convert(VARCHAR, up.[DOB],110),''), '1900-01-01', ''),'/','-') AS [Date of Birth]    , '' AS [SSN]    , ISNULL(ls.number,'') AS [OK State License_No] -- Oklahoma--    --, ISNULL(pp.[TaxId], '') AS [Tax ID#]     , SUBSTRING(REPLACE(isnull(pp.taxid,''),'-',''),1,2) + '-' + SUBSTRING(REPLACE(isnull(pp.taxid,''),'-',''),3,9) AS [Tax ID#]     , ISNULL(pp.[NPINumber],'') AS [Group NPI #]    , '' AS [Specialty]    , '' AS [Type of Provider]    , ISNULL(JSON_VALUE(hcp.LicenseData, '$.boardCertified'),'') AS [Board Certified?]    , (CASE     WHEN JSON_VALUE(hcp.LicenseData, '$.credentialDate') NOT LIKE '%[0-9]%' THEN ' '    WHEN JSON_VALUE(hcp.LicenseData, '$.credentialDate')  LIKE '%[0-9]%' AND JSON_VALUE(hcp.LicenseData, '$.credentialDate') LIKE '%,%'     THEN CONVERT(VARCHAR(30),CONVERT(DATE,REPLACE(LEFT(JSON_VALUE(hcp.LicenseData, '$.credentialDate'),CHARINDEX(',',JSON_VALUE(hcp.LicenseData, '$.credentialDate'), 2)-1),',','')),110)    WHEN JSON_VALUE(hcp.LicenseData, '$.credentialDate')  LIKE '%[0-9]%'     THEN CONVERT(VARCHAR(30),CONVERT(DATE,REPLACE(JSON_VALUE(hcp.LicenseData, '$.credentialDate'),',','')),110)    ELSE ISNULL(JSON_VALUE(hcp.LicenseData, '$.credentialDate'),'')    END ) AS [Board Cert Date]   --- HCP mapped Service Location Deta
-- =============================================  -- Author:      <Author, , Name>  -- Create Date: <Create Date, , >  -- Description: <Description, , >  -- =============================================  CREATE PROCEDURE [dhc].[devicesessions]  (      -- Add the parameters for the stored procedure here       @SessionId varchar(50)  )  AS  BEGIN              SELECT TOP  1 ISNULL(ROW_NUMBER() OVER (ORDER BY (select 1)), - 9999) AS RowID,      md.[Name],      md.Email,      md.Address,      md.MobileNumber,     md.[Zip],     md.[SessionId],     'low hearing loss' AS TestSummary,     MIN(ds.CreateDateTime) as TestStartDateTime,     MAX(ds.UpdateDateTime) as TestEndDateTime,     MAX(ds.TestStepStatus) as SessionStatus     FROM [dhc].[MemberDemographics] md      INNER JOIN [dhc].[DeviceStatus] ds ON md.SessionId = ds.SessionId      WHERE md.SessionId = @SessionId group by md.[Name],      md.Email,      md.Address,      md.MobileNumber,     md.[Zip],     md.[SessionId],     ds.TestStepStatus  END  
          -- =============================================  -- Author:      <Author, , Name>  -- Create Date: <Create Date, , >  -- Description: <Description, , >  -- Updated : Added Insurance ExpiryDate, Date : 16-10-2020  -- Updated : Post deployent: Set 0000000 for InsuranceNumber and removed IVStatus column to populate   -- =============================================  --execute DHC.CreateMember 'Avinash','Null','Puppala','9063691234','Avinash.Puppala@softtch.com',332,2754,'SystemUser'  CREATE PROCEDURE [dhc].[CreateMember] (   @FirstName NVARCHAR(200)   ,@MiddleName NVARCHAR(200)   ,@LastName NVARCHAR(200)   ,@PhoneNumber NVARCHAR(20)   ,@EmailId NVARCHAR(100)   ,@CarrierId BIGINT   ,@HealthPlanId BIGINT   ,@Createdby NVARCHAR(20)   ,@InsuranceNbr NVARCHAR(50) = null   ,@NHId NVARCHAR(20)= NULL --NHId means NHMemberId   )  AS  BEGIN   SET NOCOUNT ON      ---Response details   DECLARE @res_memberId BIGINT;   DECLARE @res_nhMemberId NVARCHAR(100);   DECLARE @res_firstName NVARCHAR(100);   DECLARE @res_lastName NVARCHAR(100);   DECLARE @res_email NVARCHAR(100);   DECLARE @res_phoneNumber NVARCHAR(100);     set @InsuranceNbr = '0000000000'     IF (     @carrierId <= 0     OR @healthPlanId <= 0     )    RETURN;     --validate for member       --DECLARE@createdby NVARCHAR(20) =       --@createdby;  --------------Update Logic for Existing member--------------------------------   IF(@NHId IS NOT NULL)   BEGIN   Declare @EMemberId BIGINT     SELECT @EMemberId=MemberId    FROM MASTER.MEMBERS    WHERE NHMEMBERID=@NHId     UPDATE MASTER.MEMBERS SET    FirstName=@FirstName,   LastName=@LastName   WHERE NHMemberId=@NHId     UPDATE [Master].[Emails]    SET EmailAddress = @emailId,   ModifyDate = getDate(),   ModifyUser =@createdby    WHERE @emailId IS NOT NULL AND MemberId = @EMemberId     UPDATE [Master].PhoneNumbers   SET PhoneNbr = @phoneNumber   ,ModifyDate = getdate()   ,ModifyUser =@createdby   WHERE @phoneNumber IS NOT NULL AND MemberId = @EMemberId     Declare @EMemberProfileId bigint      SELECT TOP 1 @EMemberProfileId=MemberProfileId    FROM [provider].[MemberProfiles] WHERE NHMemberId=@NHId     UPDATE [provider].[MemberProfiles]   SET LastName=@LastName,   FirstName=@FirstName   WHERE NHMemberId=@NHId and  MemberProfileId=@EMemberProfileId   UPDATE [provider].[MemberEmails]      SET EmailAddress = @emailId      ,ModifyDate = getDate()      ,ModifyUser = @createdby      WHERE @emailId IS NOT NULL      AND @EMemberProfileId IS NOT NULL      AND MemberProfileId = @EMemberProfileId     UPDATE [provider].[MemberPhoneNumbers]     SET PhoneNumber = @phoneNumber      ,ModifyDate = getdate()      ,ModifyUser =@createdby     WHERE @phoneNumber IS NOT NULL     AND @EMemberProfileId IS NOT NULL     AND MemberProfileId = @EMemberProfileId        SET @res_memberId = @EMemberId;    SET @res_nhMemberId = @NHId;    SET @res_firstName = @firstName;    SET @res_lastName = @lastName;    SET @res_email = @emailId;    SET @res_phoneNumber = @phoneNumber;     END  ------------------------------------------------------  ELSE   BEGIN   DECLARE @memberCount INT;   SELECT @memberCount = Count(*) FROM MASTER.MEMBERS mm INNER JOIN    [Master].MemberInsurances mi on mm.MemberId= mi.MemberId AND mi.InsuranceCarrierId=@CarrierId   WHERE FirstName = @firstName AND LastName = @lastName;     IF (@memberCount = 0)   BEGIN    ---inserting into master.members    INSERT INTO MASTER.MEMBERS (     datasource     ,FirstName     ,LastName     ,isActive     ,CreateDate     ,CreateUser     ,ModifyDate     ,ModifyUser     )    VALUES (     'DHC'     ,@firstName     ,@lastName     ,1     ,getdate()     ,@createdby     ,getdate()     ,@createdby     )      DECLARE @MemberId BIGINT;    DECLARE @NHMemberId NVARCHAR(20);      SELECT @MemberId = SCOPE_IDENTITY();      SET @NHMemberId = 'NH' + convert(NVARCHAR(10), year(getdate())) + FORMAT(@MemberId, '00000000')      UPDATE MASTER.MEMBERS    SET NHMemberId = @NHMemberId    WHERE MemberId = @memberId;      IF @InsuranceNbr IS 
CREATE PROCEDURE [dhc].[getAllDHCDevicesList]    AS    BEGIN       SELECT     isnull(D.Serial_No, '') as Serial_No,              isnull(D.SecureCode,'') as SecureCode,              isnull(D.UserPin,'') as UserPin,              isnull(MF.MfgName,'') as MfgName,              isnull(MO.Model_Name,'')as Model_Name,              isnull(DL.Address1, '') as Address1,              isnull(DL.Address2, '') as Address2,             isnull(DL.City,'') as City,             isnull(DL.State,'') as State,              isnull(DL.Zip,'') as Zip,     isnull(DL.LocationBusinessName,'') as LocationBusinessName,     isnull(DL.LocationBusinessOwner,'') as LocationBusinessOwner,     isnull(DL.LocationContactPerson,'') as LocationContactPerson,     isnull(DL.LocationContactEmail,'')as LocationContactEmail,     isnull(DL.LocationContactPhone,'')as LocationContactPhone,           --Convert(datetime,JSON_VALUE( DL.KeepAliveData,'$.AliveDateTime')) as  AliveDateTime,     --cast(Isnull(JSON_VALUE(DL.KeepAliveData,'$.AliveDateTime'), 0) as datetime)as  AliveDateTime,     --isnull(convert(Datetime2, JSON_VALUE(DL.KeepAliveData,'$.AliveDateTime')),'') as  AliveDateTime,     convert(Datetime2, JSON_VALUE(KeepAliveData,'$.AliveDateTime')) as  AliveDateTime,     --isnull(DL.KeepAliveData,'') as KeepAliveData,     --GETDATE() as  AliveDateTime,             -- CAST(DL.LocationBusinessName as nvarchar) as LocationBusinessName,             CASE WHEN (CAST(DD.IsCamWorking as bit)) IS NULL THEN CAST(0 AS BIT) ELSE CAST(DD.IsCamWorking as bit) END as 'IsCamWorking',              CASE WHEN (CAST(DD.IsMicWorking as bit)) IS NULL THEN CAST (0 AS BIT) ELSE CAST( DD.IsMicWorking as bit) END AS 'IsMicWorking',              CASE WHEN (CAST(DD.IsSpeakerWorking as bit)) IS NULL THEN CAST (0 AS BIT) ELSE CAST (DD.IsSpeakerWorking as bit) END as 'IsSpeakerWorking',              D.[MFG_ID] as 'MfgId',              D.Model_Id as 'ModelId',              D.[DeviceId],              MAX(CAST(DD.[ModifyDate] AS DATETIME)) 'ModifyDate'   FROM        [dhc].[Devices] D   LEFT JOIN    [dhc].[Manufacturers] MF            ON MF.MFGID        = D.MFG_ID   LEFT JOIN    [dhc].[Models] MO                    ON MO.MODELID    = D.MODEL_ID   LEFT JOIN    [dhc].[DeviceDiagnostics] DD        ON DD.DEVICEID    = D.DEVICEID   LEFT JOIN    [dhc].[DeviceLocation] DL            ON DL.DEVICEID    = D.DEVICEID where DL.ISACTIVE = 1     GROUP BY        D.SERIAL_NO,D.USERPIN,D.SecureCode, MF.MFGNAME, MO.MODEL_NAME, DL.ADDRESS1, DL.ADDRESS2, DL.CITY, DL.STATE, DL.ZIP,                  DD.ISCAMWORKING, ISMICWORKING, ISSPEAKERWORKING,DL.LOCATIONBUSINESSNAME,DL.LocationBusinessOwner,DL.LocationContactPerson,      DL.LocationContactEmail,DL.LocationContactPhone,DL.KeepAliveData,                  D.MFG_ID, D.MODEL_ID, D.DEVICEID   ORDER BY        D.DEVICEID   DESC  END      
CREATE PROCEDURE [dhc].[GetDeviceAliveStatus]  AS  BEGIN      -- SET NOCOUNT ON added to prevent extra result sets from      -- interfering with SELECT statements.   --Exec [dhc].[GetDeviceAliveStatus]      SET NOCOUNT ON        -- Insert statements for procedure here       SELECT         D.[DeviceId],          D.Serial_No as Serial_No,      --Convert( bit, JSON_VALUE(DL.KeepAliveData,'$.outPinMatchStatus') ) as AliveStatus ,      CAST(0 as bit)  as AliveStatus ,      --isnull(Convert(datetime2,JSON_VALUE( DL.KeepAliveData,'$.AliveDateTime')),'') as  AliveDateTime,        --GETDATE() as  AliveDateTime,     convert(Datetime2, JSON_VALUE(KeepAliveData,'$.AliveDateTime')) as  AliveDateTime,          isnull(DL.Address1, '') as Address1,                isnull(DL.Address2, '') as Address2,          isnull(DL.City,'') as City,          isnull(DL.State,'') as State,          isnull(DL.Zip,'') as Zip,          DL.[Longitude],DL.[Latitude],DL.[InstallationDate],DL.[DeAccLocationDate],          isnull(DL.LocationBusinessName,'') as LocationBusinessName,    isnull(DL.LocationBusinessOwner,'') as LocationBusinessOwner,    isnull(DL.LocationContactPerson, '')as LocationContactPerson,         isnull(DL.LocationContactEmail,'')as LocationContactEmail,    isnull(DL.LocationContactPhone,'')as LocationContactPhone,          count(case when getdate() <= DS.[StartDateTime] then DS.[StartDateTime] end) as SessionsCount,           max(DS.[StartDateTime])AS CurrentTestStartedAt,          max(DS.[EndDateTime]) AS LastTestCompletedAt,     CASE WHEN (CAST(DD.IsCamWorking as bit)) IS NULL THEN CAST(0 AS BIT) ELSE CAST(DD.IsCamWorking as bit) END as 'IsCamWorking',          CASE WHEN (CAST(DD.IsMicWorking as bit)) IS NULL THEN CAST (0 AS BIT) ELSE CAST( DD.IsMicWorking as bit) END AS 'IsMicWorking',           CASE WHEN (CAST(DD.IsSpeakerWorking as bit)) IS NULL THEN CAST (0 AS BIT) ELSE CAST (DD.IsSpeakerWorking as bit) END as 'IsSpeakerWorking',     MAX(CAST(DD.[ModifyDate] AS DATETIME)) 'ModifyDate'          FROM [dhc].[Devices] D      left join [dhc].[DeviceSession] DS on D.deviceid = DS.deviceid    left join [dhc].[DeviceDiagnostics] DD on DD.deviceid = D.deviceid    left join [dhc].[DeviceLocation] DL on D.deviceid = DL.deviceid where DL.ISACTIVE = 1      -- where DS.[CreateDateTime] = cast(getdate() as Date) and  DS.[UpdateDateTime] = cast(getdate() as Date)  --where ds.[CreateDateTime] BETWEEN  @FromDate+'00:00:00' and @ToDate+'23:59:59'    group by D.Serial_No, DL.KeepAliveData, DL.Address1,D.DeviceId,DL.Address2,DL.City, DL.State, DL.Zip,              DL.Longitude, DL.Latitude, DL.InstallationDate, DL.DeAccLocationDate,DL.LocationBusinessName,              DL.LocationBusinessOwner, DL.LocationContactPerson, DL.LocationContactEmail, DL.LocationContactPhone,     DD.IsCamWorking,DD.IsMicWorking, DD.IsSpeakerWorking,DD.ModifyDate     END  
  CREATE PROCEDURE [dhc].[GetDHADeviceDetails]  (     @DeviceId BigInt  )  AS  BEGIN      -- SET NOCOUNT ON added to prevent extra result sets from      -- interfering with SELECT statements.      SET NOCOUNT ON        -- Insert statements for procedure here      SELECT            isnull(D.Serial_No, '') as Serial_No,    CASE WHEN (CAST(DD.IsCamWorking as bit)) IS NULL THEN CAST(0 AS BIT) ELSE CAST(DD.IsCamWorking as bit) END as 'IsCamWorking',           CASE WHEN (CAST(DD.IsMicWorking as bit)) IS NULL THEN CAST (0 AS BIT) ELSE CAST( DD.IsMicWorking as bit) END AS 'IsMicWorking',           CASE WHEN (CAST(DD.IsSpeakerWorking as bit)) IS NULL THEN CAST (0 AS BIT) ELSE CAST (DD.IsSpeakerWorking as bit) END as 'IsSpeakerWorking',    isnull(DL.Address1, '') as Address1,                isnull(DL.Address2, '') as Address2,          isnull(DL.City,'') as City,          isnull(DL.State,'') as State,          isnull(DL.Zip,'') as Zip,    isnull(DL.LocationBusinessName,'') as LocationBusinessName,    isnull(DL.[LocationBusinessOwner],'') as LocationBusinessOwner,    isnull(DL.[LocationContactPerson],'') as LocationContactPerson,          isnull(DL.[LocationContactEmail],'') as LocationContactEmail ,       isnull(DL.[LocationContactPhone],'')as LocationContactPhone,       isnull(DL.[KeepAliveData], '') as KeepAliveData     FROM [dhc].[Devices] D    left join [dhc].[DeviceDiagnostics] DD on DD.deviceid = D.deviceid  left join [dhc].[DeviceLocation] DL on DL.deviceid = D.deviceid and DL.ISACTIVE = 1   WHERE  D.DeviceId = @DeviceId group by D.Serial_No,     DD.IsCamWorking,     DD.IsMicWorking,      DD.IsSpeakerWorking,     DL.Address1,     DL.Address2,     DL.City,     DL.State,     DL.Zip,     DL.LocationBusinessName,     DL.LocationBusinessOwner,     DL.LocationContactPerson,     DL.LocationContactEmail,     DL.LocationContactPhone,     DL.KeepAliveData  END  
    CREATE PROCEDURE [dhc].[GetDeviceSessionsData]  (    @DeviceId BigInt, @Fromdate datetime,@Todate datetime  )  AS  BEGIN       SELECT  ISNULL(ROW_NUMBER() OVER (ORDER BY ds.DeviceId), - 9999) AS RowID, ds.SessionId,  ds.SessionStatus,ds.Zip, ds.Name, ds.Email, ds.Address, ds.MobileNumber,    ds.[StartDateTime] AS 'TestStartDateTime',ds.[EndDateTime] AS 'TestEndDateTime'   FROM [dhc].devices d    INNER JOIN [dhc].[DeviceSession] ds ON ds.DeviceId = d.DeviceId   WHERE d.[DeviceID] = @DeviceId AND ds.[StartDateTime] BETWEEN  @FromDate+'00:00:00' and @ToDate+'23:59:59'   order by RowID desc      END  
      CREATE Procedure [dhc].[UpdateVcrAgentLogoutStatus]  @agentUserProfileId BIGINT = 0,  @isForcedLogout BIT    AS    BEGIN     -- SET NOCOUNT ON added to prevent extra result sets from     -- interfering with SELECT statements.     SET NOCOUNT ON;      UPDATE callcenter.callconversations SET    --CallEndSummary = CASE WHEN @isForcedLogout= 1 THEN 'FFLogOut' ELSE 'LogOut' END,   EndCallSummaryEnd = GETDATE(),   EndTime = GETDATE()    WHERE AgentUserProfileId = @agentUserProfileId AND CONVERT(VARCHAR, CreateDate, 23) >= CONVERT(VARCHAR, GETDATE(), 23)     UPDATE [auth].[UserProfiles] SET IsForcedLogout = 1,    LastLogoutDate = GETDATE()    WHERE UserProfileId = @agentUserProfileId AND CONVERT(VARCHAR, LastLoginDate, 23) >= CONVERT(VARCHAR, GETDATE(), 23)     --UPDATE [dhc].[AgentCallPerfomanceLogs] SET CallStatus = 480   --WHERE AgentUserProfileId = @agentUserProfileId AND callperfomanceid = (select MAX(callperfomanceid) FROM [dhc].[AgentCallPerfomanceLogs]  WHERE AgentUserProfileId = @agentUserProfileId    --AND CONVERT(VARCHAR, LastLoginDate, 23) >= CONVERT(VARCHAR, GETDATE(), 23))      END    
  -- =============================================  -- Author:      HArika  -- Create Date: 02-12-2019  -- Description: To get the Member session details  -- =============================================  CREATE PROCEDURE [dhc].[GetMemberTestData]  (       @SessionId varchar(50)  )  AS  BEGIN        SET NOCOUNT ON         SELECT TOP  1 ISNULL(ROW_NUMBER() OVER (ORDER BY (select 1)), - 9999) AS RowID,      DS.[Name],      DS.Email,      DS.Address,      DS.MobileNumber,     DS.[Zip],     DS.[SessionId],     'low hearing loss' AS TestSummary,     --MIN(ds.CreateDateTime) as TestStartDateTime,     --MAX(ds.UpdateDateTime) as TestEndDateTime,     Min(DS.StartDateTime) as TestStartDateTime,     Max(DS.EndDateTime) as TestEndDateTime,      LAST_VALUE([SessionStatus]) OVER (ORDER BY [DeviceSessionId] desc) as SessionStatus,       isnull(Max(APL.AgentUserProfileId),'')AS VirutalCareAssistantID,              isnull(Max(CC.AgentUserProfileName),'') AS VirtualCareAssistant,              Max(CC.StartTime) AS StartTime,              Max(CC.EndTime) AS EndTime ,              isnull(Max(CC.CallEndSummary),'') AS Disposition          FROM [dhc].[DeviceSession] DS     Left JOIN [DHC].[AgentCallPerfomanceLogs] APL ON APL.SessionId=DS.SessionId              Left JOIN [CallCenter].[CallConversations] CC ON CC.AgentUserProfileId = APL.AgentUserProfileId     WHERE DS.SessionId = @SessionId group by DS.[Name],      DS.Email,      DS.Address,      DS.MobileNumber,     DS.[Zip],     DS.[SessionId],     DS.StartDateTime,     DS.EndDateTime,     DS.SessionStatus,     DS.[DeviceSessionId],      APL.AgentUserProfileId,        CC.AgentUserProfileName,      CC.StartTime,      CC.EndTime,      CC.CallEndSummary    END  
    CREATE PROCEDURE [dhc].[GetSessionsStatusData]  (    @SessionId varchar(50)  )  AS  BEGIN      SELECT TOP  1 ISNULL(ROW_NUMBER() OVER (ORDER BY (select 1)), - 9999) AS RowID,      md.[Name],      md.Email,      md.Address,      md.MobileNumber,     md.[Zip],     md.[SessionId],     'low hearing loss' AS TestSummary,     MIN(ds.CreateDateTime) as TestStartDateTime,     MAX(ds.CreateDateTime) as TestEndDateTime,     MAX(ds.TestStepStatus) as SessionStatus     FROM [dhc].[MemberDemographics] md      INNER JOIN [dhc].[DeviceStatus] ds ON md.SessionId = ds.SessionId      WHERE md.SessionId = @SessionId group by md.[Name],      md.Email,      md.Address,      md.MobileNumber,     md.[Zip],     md.[SessionId],     ds.TestStepStatus      END  
        CREATE Procedure [dhc].[UpdateVcrAgentCallStatus]  @agentUserProfileId BIGINT = 0,  @CallStatus BIGINT,  @sessionId UNIQUEIDENTIFIER      AS    BEGIN        SET NOCOUNT ON;      UPDATE [dhc].[AgentCallPerfomanceLogs] SET    CallStatus = @CallStatus,   ModifyDate = GETDATE(),   CallConversationID = 0,   SessionID = @sessionId,   IsActive = 1   WHERE AgentUserProfileId = @agentUserProfileId AND CallStatus = 180 AND CONVERT(VARCHAR, CreateDateTime, 23) >= CONVERT(VARCHAR, GETDATE(), 23)     END    
  CREATE Procedure [dhc].[UpdateVcrAgentLogoutStatus]  @agentUserProfileId BIGINT = 0,  @isForcedLogout BIT    AS    BEGIN     -- SET NOCOUNT ON added to prevent extra result sets from     -- interfering with SELECT statements.     SET NOCOUNT ON;      UPDATE callcenter.callconversations SET    --CallEndSummary = CASE WHEN @isForcedLogout= 1 THEN 'FFLogOut' ELSE 'LogOut' END,   ProcessFlag = 1,   EndTime = GETDATE()    WHERE AgentUserProfileId = @agentUserProfileId AND CONVERT(VARCHAR, CreateDate, 23) >= CONVERT(VARCHAR, GETDATE(), 23)     UPDATE [auth].[UserProfiles] SET IsForcedLogout = 1,    LastLogoutDate = GETDATE()    WHERE UserProfileId = @agentUserProfileId AND CONVERT(VARCHAR, LastLoginDate, 23) >= CONVERT(VARCHAR, GETDATE(), 23)     END  
  CREATE PROCEDURE [dhc].[GetNHMemberDetailsByPolicyNumber](  @POLICYNUMBER NVARCHAR(500)  )  AS    BEGIN     SET NOCOUNT ON    select mm.memberid as MemberProfileId, mm.FirstName, mm.LastName, mm.NHMemberId, mid.MemberInsuranceID,  mi.InsuranceType, mid.insurerinsurancenbr, ih.IsMedicare as IsAdvanceMember, ih.IsMedicaid, ih.IsMedicare, ih.IsDiscountProgram, mid.insurancenbr as PolicyNumber   from master.members mm  inner join master.memberinsurances MI on MI.memberid = mm.memberid  inner join master.memberinsurancedetails MID on MID.Memberinsuranceid = Mi.id  inner join insurance.insurancehealthplans ih on ih.insurancehealthplanid = mi.insurancehealthplanid  where mid.insurancenbr = @POLICYNUMBER    END  
/*  Mohan deployed to Stage on  1 May 2020   Mohan deployetd to Production on 12 May 2020  */  Create PROCEDURE [Document].[SP_GetHHQTemplateDetails]      -- Add the parameters for the stored procedure here         @OrderId bigint,      @NHMemberId nvarchar(20)  AS  BEGIN      -- SET NOCOUNT ON added to prevent extra result sets from      -- interfering with SELECT statements.      SET NOCOUNT ON   -- Declare @orderId bigint=200013508;   -- Declare @NHMemberId varchar(50)='NH202002474348';    select cast ( M.QuestionId as bigint ) as QuestionId    ,CAST( Question as varchar) as Question    ,M.AnswerId    ,A.Answer    ,NHMemberId    ,OtherAnswer    ,cast (OrderId as bigint ) as OrderId    ,(select top 1 FirstName from Master.Members where NHMemberID=@NHMemberId) as FirstName    ,(select top 1 LastName from Master.Members where NHMemberID=@NHMemberId) as LastName    from [member].[MemberAnswers] M     inner join [member].[Questions] Q on Q.QuestionId = M.QuestionId and Q.IsActive = 1 and Category='HHQ'    inner join [member].[Answers] A on A.AnswerId = M.AnswerId and A.IsActive = 1    where OrderId = @orderId order by M.QuestionId asc  END  
CREATE PROCEDURE [Document].[GetDocumentsListByOrderMemberChartDataId]  (    @OrderMemberchartDataId bigint,    @DocType varchar(15)  )  AS  BEGIN      -- SET NOCOUNT ON added to prevent extra result sets from      -- interfering with SELECT statements.      SET NOCOUNT ON  BEGIN      select top 1    DT.DocProcessID as DocumentProcessId,   DT.DocumentName as DocumentName,   DT.DocumentTypeCode as DocumentType,   DO.DocumentObject as DocumentData,   DT.DocumentExtension as Extension   from provider.MemberChartData Mc join [Document].[DocumentTransaction]  DT on DT.MemberChartId=MC.MemberChartId       join [Document].[DocumentObject] DO on Do.DocumentObjectID=DT.DocumentObjectID       where Mc.MemberChartDataId=@OrderMemberchartDataId and DT.DocumentTypeCode = @DocType  and DT.IsActive=1    and Do.IsActive=1 and  Mc.IsActive=1 order by DT.CreateDate desc  END  END
-- =============================================  -- Author:      <Author, pulikamsuneetha, Name>  -- Create Date: <Create Date, 10-04-2020, >  -- Description: <Description,to get document object data based on the ordermemberchartdataid , >  -- =============================================  CREATE PROCEDURE [Document].[GetDocumentsListbyOrdermhtId]  (      -- Add the parameters for the stored procedure here    @OrderMemberchartDataId bigint,    @DocType varchar(15)  )  AS  BEGIN      -- SET NOCOUNT ON added to prevent extra result sets from      -- interfering with SELECT statements.      SET NOCOUNT ON       IF (@DocType ='AGM')    BEGIN      select top 1 DO.DocumentObjectID,DocumentObject,DO.IsActive,'' as DocumentMasterModels,'' as DocumentTransactionModels    ,Do.CreateUser ,DO.CreateDate,DO.ModifyUser,DO.ModifyDate ,cast(1 as bit ) as isFileholdSync   from provider.MemberChartData Mc      left join [Document].[DocumentTransaction]  DT on DT.MemberChartDataId=MC.MemberChartDataId      left join [Document].[DocumentObject] DO on Do.DocumentObjectID=DT.DocumentObjectID      where Mc.MemberChartId=      (select top 1 MemberChartId from provider.MemberChartData     where MemberChartDataId=@OrderMemberchartDataId)      and Mc.MinorProcessId =21 and Mc.MajorProcessId =4 and DT.DocumentExtension ='.pdf'      and DT.DocumentSubTypeCode in('DOC_AGM')      and DT.DocumentTypeCode in('DOC_AGM') order by DT.DocumentID desc  END   IF (@DocType ='PA')    BEGIN      select top 1 DO.DocumentObjectID,DocumentObject,DO.IsActive,'' as DocumentMasterModels,'' as DocumentTransactionModels    ,Do.CreateUser ,DO.CreateDate,DO.ModifyUser,DO.ModifyDate,cast(1 as bit ) as isFileholdSync   from provider.MemberChartData Mc      left join [Document].[DocumentTransaction]  DT on DT.MemberChartDataId=MC.MemberChartDataId      left join [Document].[DocumentObject] DO on Do.DocumentObjectID=DT.DocumentObjectID      where Mc.MemberChartId=      (select top 1 MemberChartId from provider.MemberChartData     where MemberChartDataId=@OrderMemberchartDataId)      and Mc.MinorProcessId =19 and Mc.MajorProcessId =3 and DT.DocumentExtension ='.pdf'      and DT.DocumentSubTypeCode in('DOC_PA')      and DT.DocumentTypeCode in('DOC_PA') order by DT.DocumentID desc  END   IF (@DocType ='HIPA')    BEGIN      select top 1 DO.DocumentObjectID,DocumentObject,DO.IsActive,'' as DocumentMasterModels,'' as DocumentTransactionModels    ,Do.CreateUser ,DO.CreateDate,DO.ModifyUser,DO.ModifyDate,cast(1 as bit ) as isFileholdSync   from provider.MemberChartData Mc      left join [Document].[DocumentTransaction]  DT on DT.MemberChartDataId=MC.MemberChartDataId      left join [Document].[DocumentObject] DO on Do.DocumentObjectID=DT.DocumentObjectID      where Mc.MemberChartId=      (select top 1 MemberChartId from provider.MemberChartData     where MemberChartDataId=@OrderMemberchartDataId)      and Mc.MinorProcessId =19 and Mc.MajorProcessId =3 and DT.DocumentExtension ='.pdf'      and DT.DocumentSubTypeCode in('DOC_HIPA')      and DT.DocumentTypeCode in('DOC_HIPA') order by DT.DocumentID desc  END   IF (@DocType ='AOB')    BEGIN      select top 1 DO.DocumentObjectID,DocumentObject,DO.IsActive,'' as DocumentMasterModels,'' as DocumentTransactionModels    ,Do.CreateUser ,DO.CreateDate,DO.ModifyUser,DO.ModifyDate,cast(1 as bit ) as isFileholdSync   from provider.MemberChartData Mc      left join [Document].[DocumentTransaction]  DT on DT.MemberChartDataId=MC.MemberChartDataId      left join [Document].[DocumentObject] DO on Do.DocumentObjectID=DT.DocumentObjectID      where Mc.MemberChartId=      (select top 1 MemberChartId from provider.MemberChartData     where MemberChartDataId=@OrderMemberchartDataId)      and Mc.MinorProcessId =19 and Mc.MajorProcessId =3 and DT.DocumentExtension ='.pdf'      and DT.DocumentSubTypeCode in('DOC_AOB')      and DT.DocumentTypeCode in('DOC_AOB') order by DT.DocumentID desc  END  END  
CREATE PROCEDURE [Document].[SP_GetAOBTemplateDetails]      -- Add the parameters for the stored procedure here         @NHMemberId nvarchar(20)  AS  BEGIN      -- SET NOCOUNT ON added to prevent extra result sets from      -- interfering with SELECT statements.      SET NOCOUNT ON         Declare @DocumentId bigint = 0         -- Insert statements for procedure here       SELECT PMP.FirstName + ' '+ PMP.LastName AS NameOfInsured, MP.PhoneNumber as Phone,       PMP.DateOfBirth  as DOB,    @DocumentId  AS DocumentId, 'dn' as DocumentName,  'code' as DocumentTypeCode, null as SignatureOfInsured, PMP.FirstName + ' '+ PMP.LastName AS PrintNameOfInsured, getdate() as SignatureDate  FROM [provider].[MemberProfiles] PMP         LEFT JOIN [provider].[MemberPhoneNumbers] MP ON MP.MemberProfileId = PMP.MemberProfileId         WHERE PMP.NHMemberid = @NHMemberId  END  
CREATE PROCEDURE [Document].[SP_GetProviderAndLocationDetails]  (      -- Add the parameters for the stored procedure here     @NHMemberId varchar(20)  )  AS  BEGIN      -- SET NOCOUNT ON added to prevent extra result sets from      -- interfering with SELECT statements.      SET NOCOUNT ON      -- Insert statements for procedure here   Declare @OrderId bigint = 0;   select  MP.MemberProfileId,        MCD.ProviderId,        PP.ProviderName,        MCD.LocationId,       MCD.Createdate,       @OrderId as OrderId   from   provider.memberprofiles MP   inner join  provider.membercharts MC on MC.MemberProfileId = MP.MemberProfileId   inner join  provider.memberchartdata MCD on MCD.MemberChartId = MC.MemberChartId   inner join  provider.ProviderProfiles PP on PP.ProviderId = MCD.ProviderId   where   nhmemberid = @NHMemberId  AND PP.IsActive=1 AND MCD.IsActive=1 AND MC.IsActive=1 AND MP.IsActive=1 order by MCD.CreateDate desc    END  
-- 2020-07-27 - Damian Montero - Ran on Stage  --2020-07-29 - Execute again in Stage  -- 2020-07-30 - Mohan Nanduri  - Ran on Prod    /*   New procedure to get information for Return/Exchange document prefill  */      CREATE   PROCEDURE [Document].[SP_GetReturnExchangeDetails]  (      -- Add the parameters for the stored procedure here   @NHMemberId nvarchar(20),   @OrderId bigint   )  AS  BEGIN      SET NOCOUNT ON       declare @BrandName nvarchar(100)=null   IF (@OrderId <= 0)   BEGIN   Set @OrderId = (SELECT TOP 1 ORDERID FROM ORDERS.ORDERS          WHERE ORDERSTATUSCODE NOT IN ('CAN') AND  NHMEMBERID =  @NHMemberId           ORDER BY MODIFYDATE DESC)   END         IF(@OrderId > 0)    set @BrandName=(select BrandName from [Catalog].[Brands] where BrandCode = (select top 1 BrandCode from [Orders].[OrderItems] where orderid=@OrderId))     BEGIN     SELECT       @orderid as Id,      --member details and order details----      isnull(JSON_VALUE(oo.MemberData, '$.firstName'),'') as MemberFirstName,      isnull(JSON_VALUE(oo.MemberData, '$.middleName'), '') as MemberMiddleName,      isnull(JSON_VALUE(oo.MemberData, '$.lastName'),'') as MemberLastName,      JSON_Value(oo.MemberData,'$.dob') as MemberDOB,      JSON_VALUE(OO.ProviderData, '$.hcp.firstName') as ProviderFirstName,      JSON_VALUE(OO.ProviderData, '$.hcp.lastName')   as ProviderLastName,      json_value(oo.providerdata,'$.address.address1') + json_value(oo.providerdata,'$.address.address2') as ProviderAddress,      json_value(oo.providerdata,'$.address.city') as ProviderCity,         json_value(oo.providerdata,'$.address.state') as ProviderState,      json_value(oo.providerdata,'$.address.zip') as ProviderZipCode,        cast(JSON_VALUE(OO.ShippingData, '$.phoneNumber') as bigint) as InsuredPhone,      case When  (JSON_VALUE(OO.ShippingData, '$.address.address')) is null then ( (JSON_VALUE(OO.ShippingData, '$.address.address1')) + ' ' +case when  (JSON_VALUE(OO.ShippingData, '$.address.address2')) is null then  '' else (JSON_VALUE(OO.ShippingData, '$.address.address2')) end   )else  (JSON_VALUE(OO.ShippingData, '$.address.address')) end as StreetAddress,      (JSON_VALUE(OO.ShippingData, '$.address.city')) as City,      (JSON_VALUE(OO.ShippingData, '$.address.state')) as [State],      (JSON_VALUE(OO.ShippingData, '$.address.zip')) as Zip,         case        when  JSON_VALUE(OO.ShippingData, '$.dispenser') is null then (select top 1 Dispenser from provider.LocationsAccountNbrs where BrandCode =@BrandName and LocationId =convert(bigint,isnull(json_value(providerData,'$.address.locationId'),0)) )        else JSON_VALUE(OO.ShippingData, '$.dispenser')       end AS DispenserOrAccountNo,        json_Value(OTD.OrderTransactionData,'$.leftHearingAidSerialNumber') as LeftHearingAidSerialNumber,      json_Value(OTD.OrderTransactionData,'$.rightHearingAidSerialNumber') as RightHearingAidSerialNumber,      json_Value(OTD.OrderTransactionData,'$.receivedBy') as ReceivedBy,      (SELECT TOP 1 PONumber FROM [Orders].[OrderItems] where OrderId=@Orderid and ItemType ='HA') as PONumber,      getdate() as DateOfReturn,      @BrandName as Manufacturer,       (select top 1 ProductModelCode from [Orders].[OrderItems] where orderid=@OrderId and itemtype='HA') as Model,      json_value(OTD.OrderTransactionData,'$.hearingAidInvoiceDate') as DateShippedToManufacturer,      null as MemberSignature,      '' as ReturnAuthorization                      from   [Orders].[Orders] OO      inner join [Orders].[OrderTransactionDetails] OTD on OTD.OrderId = OO.OrderId and OTD.OrderStatusCode='SHI' and OTD.IsActive = 1     --Inner Join [Orders].[OrderItems] OI On OO.OrderId = OI.OrderId and OI.IsActive = 1     -- inner join   [Catalog].[Brands] CB on CB.BrandCode = OI.BrandCode and CB.IsActive = 1     Where  OO.OrderId = @OrderId and OO.IsActive = 1          And   OO.OrderStatusCode not in ('CAN')      And exists (select * from [Orders].[OrderItems] OI where OI.OrderId = OO.OrderId and OI.ItemType = 'HA' 
CREATE PROCEDURE [Document].[SP_GetDocListBasedOnOrder]  (      -- Add the parameters for the stored procedure here      @MemberChartId bigint,   @OrderId bigint  )  AS  BEGIN      -- SET NOCOUNT ON added to prevent extra result sets from      -- interfering with SELECT statements.      SET NOCOUNT ON        -- Insert statements for procedure here    Select cast(a.DocumentId as bigint) as DocumentId, cast(a.OrderId as bigint) as OrderId into #Temp4 from(select json_value(ProcessData,'$[0].documentId') as DocumentId, json_value(ProcessData,'$[0].orderId') as OrderId  from Provider.MemberChartData where MemberChartId = @MemberChartId   and json_value(ProcessData,'$[0].documentId') is not null and json_value(ProcessData,'$[0].orderId') != 0  union  select json_value(ProcessData,'$[1].documentId') as DocId, json_value(ProcessData,'$[1].orderId') as OrderId from Provider.MemberChartData where MemberChartId = @MemberChartId  and json_value(ProcessData,'$[1].documentId') is not null and json_value(ProcessData,'$[1].orderId') != 0  union  select json_value(ProcessData,'$[2].documentId') as DocId, json_value(ProcessData,'$[2].orderId') as OrderId from Provider.MemberChartData where MemberChartId = @MemberChartId  and json_value(ProcessData,'$[2].documentId') is not null and json_value(ProcessData,'$[2].orderId') != 0  union  select json_value(ProcessData,'$[3].documentId') as DocId, json_value(ProcessData,'$[3].orderId') as OrderId from Provider.MemberChartData where MemberChartId = @MemberChartId  and json_value(ProcessData,'$[3].documentId') is not null and json_value(ProcessData,'$[3].orderId') != 0  union  select json_value(ProcessData,'$[4].documentId') as DocId, json_value(ProcessData,'$[4].orderId') as OrderId from Provider.MemberChartData where MemberChartId = @MemberChartId  and json_value(ProcessData,'$[4].documentId') is not null and json_value(ProcessData,'$[4].orderId') != 0  union  select json_value(ProcessData,'$[5].documentId') as DocId, json_value(ProcessData,'$[5].orderId') as OrderId from Provider.MemberChartData where MemberChartId = @MemberChartId  and json_value(ProcessData,'$[5].documentId') is not null and json_value(ProcessData,'$[5].orderId') != 0  union  select json_value(ProcessData,'$[6].documentId') as DocId, json_value(ProcessData,'$[6].orderId') as OrderId from Provider.MemberChartData where MemberChartId = @MemberChartId  and json_value(ProcessData,'$[6].documentId') is not null and json_value(ProcessData,'$[6].orderId') != 0  union  select json_value(ProcessData,'$[7].documentId') as DocId, json_value(ProcessData,'$[7].orderId') as OrderId from Provider.MemberChartData where MemberChartId = @MemberChartId  and json_value(ProcessData,'$[7].documentId') is not null and json_value(ProcessData,'$[7].orderId') != 0  union  select json_value(ProcessData,'$[8].documentId') as DocId, json_value(ProcessData,'$[8].orderId') as OrderId from Provider.MemberChartData where MemberChartId = @MemberChartId  and json_value(ProcessData,'$[8].documentId') is not null and json_value(ProcessData,'$[8].orderId') != 0  union  select json_value(ProcessData,'$[9].documentId') as DocId, json_value(ProcessData,'$[9].orderId') as OrderId from Provider.MemberChartData where MemberChartId = @MemberChartId  and json_value(ProcessData,'$[9].documentId') is not null and json_value(ProcessData,'$[9].orderId') != 0  union  select json_value(ProcessData,'$[10].documentId') as DocId, json_value(ProcessData,'$[10].orderId') as OrderId from Provider.MemberChartData where MemberChartId = @MemberChartId  and json_value(ProcessData,'$[10].documentId') is not null and json_value(ProcessData,'$[10].orderId') != 0  union  select json_value(ProcessData,'$[11].documentId') as DocId, json_value(ProcessData,'$[11].orderId') as OrderId from Provider.MemberChartData where MemberChartId = @MemberChartId  and json_value(ProcessData,'$[11].documentId') is not null and json_value(ProcessData,'$[11].orderId') != 0  union  select json_value(ProcessData,'$[12
-- 2020-07-27 - Damian Montero - Ran on Stage  -- 2020-07-30 - Mohan Nanduri  - Ran on Prod      /*   Modify case when OrderId <= 0  */      CREATE   PROCEDURE [Document].[GetHAPurchaseAgreement]  (      -- Add the parameters for the stored procedure here      @NHMemberId nvarchar(20),   @OrderId bigint   )  AS  BEGIN      -- SET NOCOUNT ON added to prevent extra result sets from      -- interfering with SELECT statements.      SET NOCOUNT ON       Declare @DocumentName nvarchar(100) = null   Declare @DocTypeCode nvarchar(100) = null   Declare @InsuranceOrPlanBenefit int = 0   Declare @LeftHearingAidSerialNumber nvarchar(100)   Declare @RightHearingAidSerialNumber nvarchar(100)        IF (@OrderId <= 0)   BEGIN   Set @OrderId = (SELECT TOP 1 ORDERID FROM ORDERS.ORDERS          WHERE ORDERSTATUSCODE NOT IN ('CAN','RET') AND IsActive=1 AND NHMEMBERID =  @NHMemberId           ORDER BY MODIFYDATE DESC)   END      IF(@OrderId > 0)    BEGIN     SELECT       JSON_VALUE(OO.ProviderData, '$.providerLeagalBusinessName') AS LegalBusinessName,      case when  JSON_VALUE(OO.ShippingData, '$.dispenser') is null then (select top 1 Dispenser from provider.LocationsAccountNbrs where BrandCode = CB.BrandName and LocationId =convert(bigint,isnull(json_value(providerData,'$.address.locationId'),0)) ) else JSON_VALUE(OO.ShippingData, '$.dispenser') end AS DispenserOrAccountNo,      OO.NHMemberId,       OI.OrderItemId as DocumentId,      @DocumentName as DocumentName,      @DocTypeCode as DocumentTypeCode,       @LeftHearingAidSerialNumber as LeftHearingAidSerialNumber,      @RightHearingAidSerialNumber as RightHearingAidSerialNumber,      getdate() as PurchaseDate,      isnull(JSON_VALUE(MemberData, '$.firstName'),'') +' '+ isnull(JSON_VALUE(MemberData, '$.middleName'), '') +' '+ isnull(JSON_VALUE(MemberData, '$.lastName'),'') as ByerName,      cast(JSON_VALUE(OO.ShippingData, '$.phoneNumber') as bigint) as InsuredPhone,      case When  (JSON_VALUE(OO.ShippingData, '$.address.address')) is null then ( (JSON_VALUE(OO.ShippingData, '$.address.address1')) + ' ' +case when  (JSON_VALUE(OO.ShippingData, '$.address.address2')) is null then  '' else (JSON_VALUE(OO.ShippingData, '$.address.address2')) end   )else  (JSON_VALUE(OO.ShippingData, '$.address.address')) end as StreetAddress,      (JSON_VALUE(OO.ShippingData, '$.address.city')) as City,      (JSON_VALUE(OO.ShippingData, '$.address.state')) as [State],      (JSON_VALUE(OO.ShippingData, '$.address.zip')) as Zip,       CB.BrandName as Manufacturer,      OI.ProductModelCode as Model,      null as Circuit,              ISNULL(JSON_VALUE(OI.ItemData, '$.colorName'), JSON_VALUE(OI.ItemData, '$.color')) as Color,          null as SerialNo,       (JSON_VALUE(OI.ItemData, '$.batterySize')) as Battery,      (JSON_VALUE(OI.ItemData, '$.receiverSize')) as Receiver,       cast((JSON_VALUE(OO.OrderAmountData, '$.unitPrice')) as decimal) as Price,      cast((JSON_VALUE(OO.OrderAmountData, '$.pairPrice')) as decimal) as PurchasePrice,       cast(isnull(JSON_VALUE(OO.BenefitsData, '$.benefitAppliedAmount'), 0) as decimal) as InsuranceOrPlanBenefit,             null as PatientSignature,          getdate() as PurchaseSignatureDate,          getdate() as HCPSignatureMedicalWaiverDate,      JSON_VALUE(OO.ProviderData, '$.hcp.firstName') + ' ' + JSON_VALUE(OO.ProviderData, '$.hcp.lastName')   AS MedicalHCPName,         case when JSON_VALUE(OO.ShippingData, '$.dispenser') is null then JSON_VALUE(OO.ProviderData, '$.hcp.npiNumber') else JSON_VALUE(OO.ShippingData, '$.hcp.npiNumber') end as MedicalHCPLicenceNo,          --json_value(Ordertransactiondata, '$.receivedDate') as ExecutedOrDelivered, -- fitting date      json_value(Ordertransactiondata, '$.fittingDate') as ExecutedOrDelivered, -- fitting date      isnull(JSON_VALUE(OO.MemberData, '$.firstName'),'') +' '+ isnull(JSON_VALUE(OO.MemberData, '$.middleName'), '') +' '+ isnull(JSON_VALUE(OO.MemberData, '$.lastName'),'') as BuyersFullName,       isnull(CAST((JSON_VAL
CREATE PROCEDURE [Document].[GetDocumentOrdersList]  (      -- Add the parameters for the stored procedure here      @EngagementID bigint,      @ProviderID bigint,   @MemberProfileID bigint  )  AS  BEGIN      -- SET NOCOUNT ON added to prevent extra result sets from      -- interfering with SELECT statements.      SET NOCOUNT ON        -- Insert statements for procedure here      SELECT cast(json_value(ProcessData, '$.orderId') as bigint) as OrderId, Status as OrderStatus,    (case when OO.OrderStatusCode not in ('INI', 'PAY', 'APQ', 'CAN', 'RET', 'REI') THEN 'APP' else OO.OrderStatusCode END ) as OrderStatusCode,   NHMemberId, MemberChartId   FROM [Provider].[MemberChartData] MCD    inner join Orders.Orders OO on OO.MemberChartDataId = MCD.MemberChartDataid      where MCD.MemberChartId = @EngagementID AND PROCESSDATA != 'NULL'   AND minorprocessid in (23) AND     PROVIDERID = @ProviderID       END
  -- =============================================  -- Author:      bhanu prakash Inturi  -- Create Date: 25-Feb-2019  -- Description: <Description, , >  --exec [Document].[GetProcessDataDocumentList] 18997, 57, 0  -- =============================================  CREATE PROCEDURE [Document].[GetProcessDataDocumentList]  (      -- Add the parameters for the stored procedure here       @EngagementID bigint,       @ProviderID bigint,       @MemberProfileID bigint  )  AS  BEGIN      -- SET NOCOUNT ON added to prevent extra result sets from      -- interfering with SELECT statements.      SET NOCOUNT ON         -- Insert statements for procedure here      SELECT mcd.MemberChartDataId, ProcessData   FROM [Provider].[MemberChartData] MCD    where MCD.MemberChartId = @EngagementID AND PROCESSDATA != 'NULL'   AND minorprocessid in (18,19,21,33) AND     PROVIDERID = @ProviderID   END  
CREATE PROCEDURE  [Document].[SP_GETENGAGEMENTDOCUMENTS]  (     --EngagementId is nothing but MemberChartID        @EngagementID bigint,     @ProviderID bigint,     @MemberProfileID bigint  )  AS  BEGIN      -- SET NOCOUNT ON added to prevent extra result sets from      -- interfering with SELECT statements.   declare @AGM_DOCTYPE nvarchar(50);   declare @PA_DOCTYPE nvarchar(50);   declare @TEST_MINORPROCESS bigint;   declare @FITT_MINORPROCESS bigint;   declare @MEMBERCHARTDATAID bigint;   declare @Virtual_Test varchar(50);   set @AGM_DOCTYPE= 'DOC_AGM';   set @PA_DOCTYPE ='DOC_PA';   --set @Virtual_Test ='Virtual Test';   set @TEST_MINORPROCESS= 16;   set @FITT_MINORPROCESS =25;        SET NOCOUNT ON    set @Virtual_Test = (select top 1 ap.AppointmentStatus from [Provider].[MemberAppointments] ap join provider.memberchartdata mcd on ap.MemberChartDataID=mcd.MemberChartDataID              join provider.membercharts mc on mcd.MemberChartID=mc.MemberChartID where mcd.MemberChartId = @EngagementID and mcd.ProviderId = @ProviderID and ap.AppointmentTypeId=1 order by ap.CreateDate desc)     SET @MEMBERCHARTDATAID= (select top 1 mcd.MemberChartDataId from [Provider].[MemberAppointments] ap join provider.memberchartdata mcd on ap.MemberChartDataID=mcd.MemberChartDataID              join provider.membercharts mc on mcd.MemberChartID=mc.MemberChartID where mcd.MemberChartId = @EngagementID and mcd.ProviderId = @ProviderID and ap.AppointmentTypeId=1 order by ap.CreateDate desc)      if @Virtual_Test = 'Virtual Test'   BEGIN   SELECT distinct --(case when DT.DocumentExtension in ('.pdf','pdf','.docx','docx','doc','doc') then null else DO.DocumentObject end) as DocumentObject,             DO.DocumentObject, -- [Mohan] Commented this due to Performance                 --null 'DocumentObject',             MC.MemberChartId as EngagementId,              MCD.MemberChartDataId,              DT.DocumentID,              isnull(DM.DocumentMasterID, 0) as DocumentMasterID,              DT.DocumentName as    TransactionDocumentName,                        DT.DocumentName as MasterDocumentName,                                               DT.IsActive As DocStatus,                                                MCD.IsDocumentComplete,              MC.MemberProfileID,              MCD.ProviderID,             ISNULL((select top 1 mcd.LocationID from provider.memberchartdata WHERE MemberChartDataID=@MEMBERCHARTDATAID),0) LocationID,             MCD.MajorProcessID,             MCD.MinorProcessID,             (select top 1 MemberAppointmentId from [Provider].[MemberAppointments] WHERE MemberChartDataId=@MEMBERCHARTDATAID) MemberAppointmentID,                                          (select top 1 HCPUserProfileId from [Provider].[MemberAppointments] WHERE MemberChartDataId=@MEMBERCHARTDATAID) HCPUserProfileId,             (select top 1 StartDate from [Provider].[MemberAppointments] WHERE MemberChartDataId=@MEMBERCHARTDATAID) StartDate,              (select top 1 StartTime from [Provider].[MemberAppointments] WHERE MemberChartDataId=@MEMBERCHARTDATAID) StartTime,              (select top 1 EndDate from [Provider].[MemberAppointments] WHERE MemberChartDataId=@MEMBERCHARTDATAID) EndDate,              (select top 1 EndTime from [Provider].[MemberAppointments] WHERE MemberChartDataId=@MEMBERCHARTDATAID) EndTime,             (select top 1 AppointmentStatus from [Provider].[MemberAppointments] WHERE MemberChartDataId=@MEMBERCHARTDATAID) AppointmentStatus,             MAP.MajorProcessName,             MIP.MinorProcessName,             DT.CreateUser as DocumentUploadedby,             DT.CreateUser as CreateUser,             DT.CreateDate as CreateDate,             null as ModifyUser,             getdate() as ModifyDate,             DT.DocumentStatus,             DT.DocumentComments,             DT.DocumentVersion,             DL.DocumentLookUpName,             DT.DocumentTypecode,             MC.MemberChartId,                       DocProcessID   FROM         DOC
CREATE PROCEDURE [Document].[SP_GetHippaTemplateDetails]  (      -- Add the parameters for the stored procedure here    @NHMemberId nvarchar(20)  )  AS  BEGIN      -- SET NOCOUNT ON added to prevent extra result sets from      -- interfering with SELECT statements.      SET NOCOUNT ON   Declare @DocumentId bigint = 0   Declare @IRTS bit = 0   Declare @CBA bit = 0   Declare @Others bit = 0     SELECT        @DocumentId as DocumentId,       'dn' as DocumentName,             'code' as DocumentTypeCode,     getdate() as AckDate,      FirstName + ' '+ LastName as MemberNamePrinted,      null as MemberSignature,        null as MemberRepresentativeSignature,     CaregiverFirstName + '' + CaregiverLastName as MemberRepresentativeName,     CaregiverRelationship as RelationShipToMember,     @IRTS as IndividualRefusedToSign,     @CBA as CommunicationBarriersAcknowledgement,     @Others as Others,     null as OthersReason     FROM PROVIDER.MEMBERPROFILES     WHERE NHMemberId = @NHMemberId        END  
CREATE PROCEDURE [elig].[sp_elig_mark_span_errors_stage_data20200124] (   @ClientCode VARCHAR(20)   ,@FileType VARCHAR(50)   ,@FileTrackID BIGINT   )  AS  BEGIN   DECLARE @procedureName VARCHAR(100) = 'sp_elig_mark_span_errors_stage_data'   DECLARE @temptable VARCHAR(MAX)   DECLARE @sql VARCHAR(MAX)   DECLARE @statusFlag NVARCHAR(10) = 'N'   DECLARE @LogMessage VARCHAR(max)   DECLARE @UserName VARCHAR(100) = SUSER_SNAME()   DECLARE @errDetailsql VARCHAR(max)   DECLARE @spancol VARCHAR(100)   DECLARE @uniqueCols VARCHAR(1000)   DECLARE @stepName VARCHAR(200)      DECLARE span_cursor CURSOR   FOR -- SD - Can we change cursor name to ChangeClause to align with function name and use where_cursor in [dbo].[get834WhereClause]   SELECT SourceColumn   FROM [elig].[EligibilityColumnValidation]   WHERE [SpanFlag] = 1    AND [FileType] = @FileType    AND [ClientCode] = @ClientCode;     SET @stepName = '150 Span Errors - Started'   EXEC elig.auditlog @ClientCode, @FileTrackID,@procedureName,@stepName,'S'     PRINT ('Here')     DECLARE @counter INT = 1     OPEN span_cursor     PRINT ('here2')     FETCH NEXT   FROM span_cursor   INTO @spancol     PRINT ('here3')     WHILE @@FETCH_STATUS = 0   BEGIN    IF @counter = 1     SET @uniqueCols = @spancol    ELSE     SET @uniqueCols = @uniqueCols + '+''=='' +' + @spancol      FETCH NEXT    FROM span_cursor    INTO @spancol      SET @counter = @counter + 1   END     CLOSE span_cursor;     DEALLOCATE span_cursor;     PRINT ('here4')     -- set @temptable = 'select stgeligid,alternateid  + ''=='' + subscriberid  as UnID,benefitstartdate,benefitenddate from elig.stgEligBenefitData  where alternateid  + ''=='' + subscriberid  in (select alternateid + ''=='' + subscriberid from elig.stgEligBenefitData group by  alternateid + ''=='' + subscriberid having count(*) > 1)'   SET @temptable = 'select stgeligid,  ' + @uniqueCols + ' as UnID,benefitstartdate,benefitenddate from elig.stgEligBenefitData  where ' + @uniqueCols + '   in (select ' + @uniqueCols + ' from elig.stgEligBenefitData where recordstatus =''ZZ'' and filetrackid = ' + convert(VARCHAR, @FileTrackId) + '  group by  ' + @uniqueCols + ' having count(*) > 1 ) AND recordstatus = ''ZZ'' and filetrackid = ' + convert(VARCHAR, @FileTrackId) +'  '     PRINT ('here5')     SET @sql = 'update elig.stgEligBenefitData set recordstatus = ''ERR_SPAN'' where  recordstatus = ''ZZ'' and filetrackid = ' + convert(VARCHAR, @FileTrackId) + ' and  '+ @uniqueCols +' in (select tab1.UnID from ( ' + @temptable + ') tab1 where exists (select 1 from ( ' + @temptable + ') tab2 where tab2.UnID = tab1.UnID and tab2.stgeligid <> tab1.stgeligid and tab1.benefitstartdate between tab2.benefitstartdate and tab2.benefitenddate))'     PRINT @sql     EXEC (@sql)     SET @stepName = '151 Span Errors - Write Error Records'   EXEC elig.auditlog @ClientCode, @FileTrackID,@procedureName,@stepName,'S'     --ADD Span Errors to Error Table   INSERT INTO [elig].[errEligBenefitData] (    [FileTrackID]    ,[DataSource]    ,[RecordStatus]    ,[LastName]    ,[MiddleInitial]    ,[FirstName]    ,[DOB]    ,[SSN]    ,[SubscriberID]    ,[MemberSuffix]    ,[GroupNbr]    ,[BenefitStartDate]    ,[BenefitEndDate]    ,[SubGroupNbr]    ,[FamilyLinkID]    ,[AlternateID]    ,[MedicaidID]    ,[MedicareID]    ,[ClientMemberNumber]    ,ContractNbr    ,[PBPID]    ,[ProductID]    ,[BenefitLevel]    ,[Language]    ,[Gender]    ,[HomePhoneNbr]    ,[OtherPhoneNbr]    ,MemberEmail    ,[Address1]    ,[Address2]    ,[City]    ,[State]    ,[ZipCode]    ,[MailingAddress1]    ,[MailingAddress2]    ,[MailingCity]    ,[MailingState]    ,[MailingZipCode]    ,[OtherAddress1]    ,[OtherAddress2]    ,[OtherCity]    ,[OtherState]    ,[OtherZipCode]    ,[OtherAddressType]    ,[SubscriberIndFlag]    ,[RelationShipCode]    ,[MaintenanceType]    ,[MaintenanceReason]    ,[BenefitStatus]    ,[MedicarePlanCode]    ,[EligReasonCode]    ,[COBRAEvent]    ,[EmploymentStatusCode]    ,[StudentStatusCode]    ,[HandicapInd]    ,[DisabilityType
    -- exec [elig].[sp_incomm_out_file] 'H348','H367','FULL' --ELIG_TROY  -- exec [elig].[sp_incomm_out_file] 'H346','H366','FULL' --ELIG_OPTIMA  CREATE PROCEDURE [elig].[sp_incomm_out_file]   @InClientCode varchar(20), --H346 for optima; H348 for troy  @OutClientCode varchar(20), --H366 for incomm_optima; H367 for incomm_troy   @Filetype varchar(10) --FULL/Delta  AS  BEGIN    declare @DataSource varchar(20)    select @DataSource = DataSource  from elig.ClientCodes  where 1=1  and ClientCode = @InClientCode    --select @DataSource  --select 1 as fororder,   --@InClientCode+'|'+@OutClientCode+'|'+@Filetype as Outputtext  --order by 1  select  1 as fororder,  LEFT('102A'+space(4),4)   -- varchar(4) Y -- [102A for full file (Deactivate existing member only if not available in 102A subsequent files)] or [102C changes only file]     +LEFT(case when @InClientCode = 'H346' then 'HH2' when @InClientCode = 'H348' then 'HI6' end +space(3),3)   -- varchar(3) Y -- Will be assigned by InComm  +LEFT(ISNULL(case when  @InClientCode = 'H346' then l.IncommPlanCode when @InClientCode = 'H348' then 'PI6-3853' end,'')+space(15),15)    -- varchar(15) Y -- Will be assigned by InComm    ----+LEFT(ISNULL(SubscriberNumber,'')+space(20),20)  -- varchar(20) Y -- Unique MemberId from carrier eligibility (Subscriber ID in case of Optima)  +LEFT(ISNULL(REPLACE(d.SubscriberID,'-',''),'')+space(20),20) -- Removed hyphen in the subscriber number  +LEFT(''+space(20),20)  -- varchar(20) N -- Additional MemberId  +LEFT(ISNULL(FirstName,'')+space(32),32)  -- varchar(32) N -- Member FirstName  +LEFT(ISNULL(d.MiddleInitial,'')+space(32),32)  -- varchar(32) N -- Member MiddleName  +LEFT(ISNULL(LastName,'')+space(32),32)  -- varchar(32) N -- Member LastName  +LEFT(ISNULL(Address1,'')+space(40),40)  -- varchar(40) N -- Member Street1  +LEFT(ISNULL(Address2,'')+space(40),40)  -- varchar(40) N -- Member Street2  +LEFT(ISNULL(City,'')+space(32),32)  -- varchar(32) N -- Member City  +LEFT(ISNULL([State],'')+space(2),2)  -- varchar(2) N -- Member State  +LEFT(right(CONCAT(replicate('0', 5),ISNULL(d.ZipCode,'')), 5)+space(5),5)  -- varchar(5) N -- Member Zip  +LEFT(ISNULL(d.GroupNbr,'')+space(24),24)  -- varchar(24) N -- Group_Number  +LEFT(ISNULL('','')+space(64),64)  -- varchar(64) N -- Optional Member Identifier 1  +LEFT(ISNULL('','')+space(64),64)  -- varchar(64) N -- Optional Member Identifier 2  +LEFT(ISNULL(convert(varchar(10),d.BenefitStartDate,101),'')+space(10),10)  -- Date MM/DD/YYYY N -- Benefit start date  +LEFT(ISNULL(convert(varchar(10),d.BenefitEndDate,101),'')+space(10),10)  -- Date MM/DD/YYYY N -- Benefit end date  +LEFT(ISNULL('','')+space(8),8)  -- varchar(8) N -- Initial Activation Code 1  +LEFT(convert(varchar(10),convert(decimal(10,2),ISNULL(0,0)))+space(10),10)  -- varchar(10) XXXX.XX -- Initial Card Amount Load  +LEFT(ISNULL('English','')+space(24),24)  -- varchar(24) N -- Member Language  +LEFT(ISNULL('','')+space(14),14)  -- varchar(14) N -- Initial Activation Code 2  +LEFT(ISNULL('Y','')+space(1),1)  -- varchar(1) N -- Is Member Eligible  +LEFT(ISNULL('','')+space(1),1)  -- varchar(1) N -- E-Card to member  +LEFT(ISNULL(convert(varchar(10),case when len(d.HomePhoneNbr) < 10 then '' else d.HomePhoneNbr end),'')+space(10),10)  -- varchar(10) N -- Member Phone Number  +LEFT(ISNULL('','')+space(100),100)  -- varchar(100) N -- Member EmailID  +LEFT(ISNULL('','')+space(383),383)  -- varchar(383) N -- White spaces Filler    as Outputtext  from elig.mstrEligBenefitData d  left join elig.BenefitCrossWalk l on ( d.LineOfBusiness = l.LOB            and d.GroupNbr = l.GroupNbr            and d.insCarrierID = l.InsuranceCarrierId            and d.insHealthPlanID = l.InsuranceHealthPlanId)  --left join elig.OP_LINK l on (l.LOB=d.LineOfBusiness and l.GroupCode=d.GroupNbr)  where  1=1  and d.DataSource =  @DataSource   and d.isActive=1  and (CAST(getdate() AT TIME ZONE 'UTC'   AT TIME ZONE 'Eastern Standard Time' AS DATE) between cast( d.BenefitStartDate as date
    --exec [elig].[sp_BCBSRIEncounter_pop]   CREATE PROCEDURE [elig].[sp_BCBSRIEncounter_pop]   AS  BEGIN      SELECT   vendorRefid   ,OrderID   ,JSON_VALUE([vendordata],'$.insuranceID') as insuranceID   ,JSON_VALUE([vendordata],'$.insuranceCarrierName') as CarrierName   ,JSON_VALUE([vendordata],'$.itemData[0].serviceType') as  serviceType   ,cast(CONVERT(VARCHAR(10),JSON_VALUE([vendordata],'$.effective_from_date'),101) as date) as effective_from_date   ,cast(CONVERT(VARCHAR(10),JSON_VALUE([vendordata],'$.effective_to_date'),101) as date) as effective_to_date   --,'*****' as junk,   , 1 as fororder   ,'Data' as fororderdesc   ,'D' as recordtype   ,ClaimNumber as TransactionId   ,JSON_VALUE([vendordata],'$.itemData[0].claimDtlSeqNbr') as linesequenceNbr   ,'NEW' as ClaimStatus   ,JSON_VALUE([vendordata],'$.nhMemberId') as nhMemberId   ,JSON_VALUE([vendordata],'$.policy_number') as policy_number --,'' as policyNbr -- get it from elig.mstr and crossverify with MN invoice data   ,JSON_VALUE([vendordata],'$.group_number') as GroupNbr   --,'' as GroupNbr -- get it from elig.mstr and crossverify with MN invoice data   ,JSON_VALUE([vendordata],'$.member_first_name') as MemberFirstName   ,JSON_VALUE([vendordata],'$.member_middle_initial') as MemberMiddleInitial   ,JSON_VALUE([vendordata],'$.member_last_name') as memberLastName   --,JSON_VALUE([vendordata],'$.member_DOB') as DateofBirth   ,cast(CONVERT(VARCHAR(10),JSON_VALUE([vendordata],'$.member_DOB'),101) as date) as DateofBirth   ,JSON_VALUE([vendordata],'$.member_phone_nbr') as PhoneNbr   --,JSON_VALUE([vendordata],'$.itemData[0].date_of_Service') as DateofService_org   ,cast(CONVERT(VARCHAR(10),JSON_VALUE([vendordata],'$.itemData[0].date_of_Service'),101) as date) as DateofService   ,cast(NULL as date) as ReturnDate --we need to get return records   ,11 as placeofService   ,'H90.3' as ICD10Code   ,JSON_VALUE([vendordata],'$.itemData[0].hcpsCode') as HCPCSCode   ,JSON_VALUE([vendordata],'$.itemData[0].serviceType') as HCPCSCodeDescription --when 'HA' get the real HCPCSdesc using HCPCSCode   ,JSON_VALUE([vendordata],'$.itemData[0].units') as Units   ,JSON_VALUE([vendordata],'$.itemData[0].modifier1') as Modifier --its null we have modifier1, modifier2, modifier3, modifier4   ,JSON_VALUE([vendordata],'$.itemData[0].hcpnpiNumber') as HCPNPINumber   ,JSON_VALUE([vendordata],'$.itemData[0].hcpFirstName') as RenderingProviderFirstName   ,JSON_VALUE([vendordata],'$.itemData[0].hcpLastName') as RenderingProviderLastName   ,JSON_VALUE([vendordata],'$.itemData[0].locationAddress1') as LocationAddress1   ,JSON_VALUE([vendordata],'$.itemData[0].locationAddress2') as LocationAddress2   ,JSON_VALUE([vendordata],'$.itemData[0].locationCity') as LocationCity   ,JSON_VALUE([vendordata],'$.itemData[0].locationState') as LocationState   ,JSON_VALUE([vendordata],'$.itemData[0].locationZipCode') as LocationZipCode   ,JSON_VALUE([vendordata],'$.itemData[0].organizationNPI') as OrganizationNPI   ,1871042317 as BillingNPI   ,474660944 as BillingTaxID   ,JSON_VALUE([vendordata],'$.itemData[0].chargeAmount') as ChargeAmt   ,JSON_VALUE([vendordata],'$.itemData[0].copayAmount') as CopayAmt   ,JSON_VALUE([vendordata],'$.itemData[0].benefitAmount') as BenefitAmt   ,JSON_VALUE([vendordata],'$.itemData[0].memberPaid') as MemberPaidAmt   ,0 as ClaimPaidAmt --will show when ParticipatingProvider = 'NO'   ,'YES' as ParticipatingProvider   ,JSON_VALUE([vendordata],'$.itemData[0].coInsuranceAmt') as CoinsuranceAmt   ,JSON_VALUE([vendordata],'$.itemData[0].coInsurancePercent') as CoinsurancePercent   ,JSON_VALUE([vendordata],'$.itemData[0].nonCoveredAmt') as NoncoveredAmt   ,cast(NULL as date) as ClaimReceivedDate --will show when ParticipatingProvider = 'NO'   ,cast(NULL as date) as ClaimPaidDate  --will show when ParticipatingProvider = 'NO'     into #temp  FROM accounts.Invoices   where 1=1  AND  ClaimNumber IS NOT NULL  AND  JSON_VALUE([vendordata],'$.insuranceID') = 'BCBSRI'     update a set a.HCPCSCodeDescription
  -- EXEC [elig].[sp_elig_load_stg_to_elig] 21    CREATE PROCEDURE [elig].[sp_elig_load_stg_to_elig20200124] (@FileTrackID BIGINT)  --- Version 1.0  --           - Mohan Bekkary -- New Procedure  --- Version 1.00 -- 01/01/2020 - Raj/ Srikanth -- Error Handling & Audit Log, Changed Phone Nbrs to varchar,   --- Version 1.01 -- 01/06/2020 - Raj Sareddy   -- Changed Error type to be ERR_,   --- Version 1.02 -- 01/07/2020 - Raj/ Srikanth -- Dates check and change to UTC datetime issue  --- Version 1.03 -- 01/07/2020 - Raj Sareddy   -- Added Stats Procedure  AS  DECLARE @procedureName VARCHAR(100) = 'sp_elig_load_stg_to_elig'  DECLARE @strWhereClause VARCHAR(max)   DECLARE @strChangeClause VARCHAR(max)  DECLARE @strCrossWalkWhereClause VARCHAR(max)  DECLARE @strNHLink VARCHAR(500)  DECLARE @sql VARCHAR(max)  DECLARE @statusFlag NVARCHAR(10) = 'N'  DECLARE @dataSource NVARCHAR(50)  DECLARE @NewRecordCount INTEGER  DECLARE @RecordsProcessed INTEGER  DECLARE @ErrorRecordCount INTEGER  DECLARE @ChangeRecordCount INTEGER  DECLARE @DropRecordCount INTEGER  DECLARE @NoChangeRecordCount INTEGER  DECLARE @LogMessage VARCHAR(max)  DECLARE @UserName VARCHAR(100) = SUSER_SNAME()  DECLARE @ClientCode VARCHAR(100)  DECLARE @FileType VARCHAR(100)  DECLARE @SnapShot VARCHAR(100)  DECLARE @FileInfoID BIGINT  DECLARE @FileID BIGINT  DECLARE @fullFile INT  DECLARE @stepName VARCHAR(200);  declare @fileTrackStatusCode varchar(20)  BEGIN   BEGIN TRY   BEGIN TRANSACTION elig_load_stg_to_elig     --- Get File Info from file track table for FileTrackID   SELECT @dataSource = Datasource    ,@snapshot = Snapshotflag    ,@FileInfoID = FileInfoID    ,@ClientCode = ClientCode    ,@FileType = FileType    ,@fileTrackStatusCode = StatusCode   FROM elig.filetrack   WHERE FileTrackID = @FileTrackID   --DONE --- RAJ added status code if status code not found then log saying no data found     if isnull(@fileTrackStatusCode,'999') <> '300'   begin    print('no file')    Return 0   end      PRINT (@ClientCode)   PRINT (@FileType)   PRINT (@FileTrackId)     SET @stepName = '110 Update BenefitEndDate'   EXEC elig.auditlog @ClientCode, @FileTrackID,@procedureName,@stepName,'S'     update elig.stgEligBenefitData    set BenefitEndDate = '2099-12-31'   where FileTrackID = @FileTrackID   and isnull(BenefitEndDate,'') = ''     EXEC elig.auditlog @ClientCode, @FileTrackID,@procedureName,@stepName,'S'        IF @snapshot = 'FULL'    SET @fullFile = 1   ELSE    SET @fullFile = 0      --LATER LOW Priority RAJ MAY be move all clauses to one priority low   --- Get Mandatory Where condition between Stage and Master tales.   SET @strWhereClause = [elig].[getEligWhereClause](@ClientCode, @FileType)     PRINT @strWhereClause     --- Get Change fileds comparison between stage and elig master table   SET @strChangeClause = [elig].[getEligChangeClause](@ClientCode, @FileType)   --- Get CrossWalk Where condition between Stage and Master tales.   SET @strCrossWalkWhereClause = [elig].[getCrossWalkWhereClause](@ClientCode, @FileType)   SET @strNHLink = [elig].[getLinkID](@ClientCode, @FileType)          -- Validate for Span Errors in Stage Table   --BEGIN TRY    DECLARE @RC INT     SET @stepName = '120 Duplicate Check'   EXEC elig.auditlog @ClientCode, @FileTrackID,@procedureName,@stepName,'S'      EXECUTE @RC = [elig].[sp_elig_validate_duplicate_stage_data] @ClientCode     ,@FileType     ,@FileTrackID     SET @stepName = '160 Validate Other Stage Data'   EXEC elig.auditlog @ClientCode, @FileTrackID,@procedureName,@stepName,'S'      -- Validate data in stage for any data errors    EXECUTE @RC = [elig].[sp_elig_validate_stage_data] @ClientCode     ,@FileType     ,@FileTrackID     SET @stepName = '130 OlD SPAN Check'   EXEC elig.auditlog @ClientCode, @FileTrackID,@procedureName,@stepName,'S'      EXECUTE @RC = [elig].[sp_elig_validate_oldspan_stage_data] @ClientCode     ,@FileType     ,@FileTrackID     SET @stepName = '140 Cross Walk Check'   EXEC elig.auditlog @ClientCode, @FileTrackID,@procedu
--exec [elig].[sp_stgEligToStgEligHist_move]   CREATE PROCEDURE [elig].[sp_stgEligToStgEligHist_move]     AS  BEGIN     declare @whenToTruncateSTGElig int   select @whenToTruncateSTGElig = count(*)   from elig.FileTrack    where DirectionCode = 'IN' and StatusCode not in (100, 999)  and FileType='ELIG'     select @whenToTruncateSTGElig     SELECT 'STG' as Fromtbl,COUNT(*) cnt,FileTrackID   into #temp   FROM [elig].[stgEligBenefitData]   where 1=2   GROUP BY FileTrackID   union   SELECT 'Hist' as Fromtbl,COUNT(*) cnt,FileTrackID   FROM elig.stgEligBenefitDataHist   where 1=2   GROUP BY FileTrackID      INSERT INTO elig.stgEligBenefitDataHist      ( [ArchiveDate]      ,[stgEligID]      ,[FileTrackID]      ,[DataSource]      ,[RecordStatus]      ,[toBeProcessed]      ,[LastName]      ,[MiddleInitial]      ,[FirstName]      ,[DOB]      ,[SSN]      ,[SubscriberID]      ,[MemberSuffix]      ,[GroupNbr]      ,[BenefitStartDate]      ,[BenefitEndDate]      ,[SubGroupNbr]      ,[FamilyLinkID]      ,[AlternateID]      ,[MedicaidID]      ,[MedicareID]      ,[ClientMemberNumber]      ,[ContractNbr]      ,[PBPID]      ,[ProductID]      ,[BenefitLevel]      ,[Language]      ,[Gender]      ,[HomePhoneNbr]      ,[OtherPhoneNbr]      ,[MemberEmail]      ,[Address1]      ,[Address2]      ,[City]      ,[State]      ,[ZipCode]      ,[MailingAddress1]      ,[MailingAddress2]      ,[MailingCity]      ,[MailingState]      ,[MailingZipCode]      ,[OtherAddress1]      ,[OtherAddress2]      ,[OtherCity]      ,[OtherState]      ,[OtherZipCode]      ,[OtherAddressType]      ,[SubscriberIndFlag]      ,[RelationShipCode]      ,[MaintenanceType]      ,[MaintenanceReason]      ,[BenefitStatus]      ,[MedicarePlanCode]      ,[EligReasonCode]      ,[COBRAEvent]      ,[EmploymentStatusCode]      ,[StudentStatusCode]      ,[HandicapInd]      ,[DisabilityType]      ,[MedicalCodeQualifier]      ,[MedicalCode]      ,[MaintenanceCode]      ,[InsuranceLineCode]      ,[CoverageLevel]      ,[LateEnrollment]      ,[CoInsurance]      ,[CoPayment]      ,[Deductible]      ,[Premium]      ,[SpendDown]      ,[LineNbr]      ,[PCPName]      ,[PCPNPI]      ,[PCPEffDate]      ,[PCPTermDate]      ,[PCPAddress1]      ,[PCPAddress2]      ,[PCPCity]      ,[PCPState]      ,[PCPZipCode]      ,[PCPBusinessPhone]      ,[COBFlag]      ,[COBCarrierName]      ,[COBPolicyNumber]      ,[COBGroup]      ,[COBBegin]      ,[COBEnd]      ,[COBRespcode]      ,[COBcode]      ,[COBServiceType]      ,[BusinessCategory]      ,[LineOfBusiness]      ,[EligibilityStartDate]      ,[EligibilityEndDate]      ,[stgVCFlex1Label]      ,[stgVCFlex1]      ,[stgVCFlex2Label]      ,[stgVCFlex2]      ,[stgVCFlex3Label]      ,[stgVCFlex3]      ,[stgVCFlex4Label]      ,[stgVCFlex4]      ,[stgVCFlex5Label]      ,[stgVCFlex5]      ,[stgVCFlex6Label]      ,[stgVCFlex6]      ,[stgVCFlex7Label]      ,[stgVCFlex7]      ,[stgVCFlex8Label]      ,[stgVCFlex8]      ,[stgVCFlex9Label]      ,[stgVCFlex9]      ,[stgVCFlex10Label]      ,[stgVCFlex10]      ,[stgVCFlex11Label]      ,[stgVCFlex11]      ,[stgVCFlex12Label]      ,[stgVCFlex12]      ,[stgVCFlex13Label]      ,[stgVCFlex13]      ,[stgVCFlex14Label]      ,[stgVCFlex14]      ,[stgVCFlex15Label]      ,[stgVCFlex15]      ,[stgVCFlex16Label]      ,[stgVCFlex16]      ,[stgVCFlex17Label]      ,[stgVCFlex17]      ,[stgVCFlex18Label]      ,[stgVCFlex18]      ,[stgVCFlex19Label]      ,[stgVCFlex19]      ,[stgVCFlex20Label]      ,[stgVCFlex20]      ,[CreateDate]      ,[CreateUser]      ,[ModifyDate]      ,[ModifyUser]      ,[stgVCFlex21Label]      ,[stgVCFlex21]    ,[stgVCFlex22Label]      ,[stgVCFlex22]      ,[IsMailingAddressForeign], [IsMemberAddressForeign]      )   SELECT GETDATE(),   [stgEligID]      ,[FileTrackID]      ,[DataSource]      ,[RecordStatus]      ,[toBeProcessed]      ,[LastName]      ,[MiddleInitial]      ,[FirstName]      ,[DOB]      ,[SSN]      ,[SubscriberID]      ,[MemberSuffix]      ,[GroupNbr]      ,[BenefitStartDate]      ,[BenefitEndDate]      ,[SubGroupN
--exec [elig].[sp_IncommOTCSerialNbr_Upd] 278,'H366' --278 (INCOMM_OPTIMA)   --exec [elig].[sp_IncommOTCSerialNbr_Upd] 285,'H367' --285 (troy)     CREATE PROCEDURE [elig].[sp_IncommOTCSerialNbr_Upd]   @CarrierId int,  @ClientCode varchar(10)  AS  BEGIN                 -------------------******************-------------------------   --incomm File data   select [health_plan_id] healthplanid,[plan_id],       replace([member_no],'-','') as NHLinkidOtc,       [member_no] InsuranceNbr,[card_number] SerialNbr,       [start_date] startdate, [expiration_date] expdate,       [card_status] cartstatus,[group_no] groupno,[first_name] fname,[last_name] lname     into #temp     from elig.stgIncommCardStatusData   where 1=1   and FileTrackID = (select max(FileTrackID)         from elig.FileTrack         where 1=1          and ClientCode = @ClientCode           and DirectionCode = 'IN' ) --use H367 (INCOMM_TROY); H366 (INCOMM_OPTIMA)   and [card_status] in ('Active' ,  'Pending')   --order by 3               ----------------------*****************--------------------------   --data from elig.mstr   select distinct d.insHealthPlanID,d.NHLinkid,d.MasterMemberID,d.MemberInsuranceID,d.GroupNbr,d.FirstName,d.LastName,   l.IncommPlanCode,l.LOB,l.PlanID,l.PBPID,l.ContractNbr   into #temp2   from elig.mstrEligBenefitData d   left join elig.BenefitCrossWalk l on ( d.LineOfBusiness = l.LOB             and d.GroupNbr = l.GroupNbr             and d.insCarrierID = l.InsuranceCarrierId             and d.insHealthPlanID = l.InsuranceHealthPlanId)   where 1=1   and insCarrierID = @CarrierId --278 --285 (troy)   and d.isActive=1   --order by 2                 ----------------------*******************---------------------   select a.*, '<--OTCSNoData*****-->mstrData' DataFrom, b.*   into #tempfinal   from #temp a   join #temp2 b on a.nhlinkidOtc = b.nhlinkid         --and a.[plan_id] = b.incommplancode --plan id is not matching for troy         and a.groupno = b.groupNbr        and CHARINDEX('-',a.insuranceNbr) = 0       ----------------------*******************----------------------   select c.NHmemberid,b.id,b.GroupNbr as groupNbr_MID,b.MemberInsuranceID as MemberInsuranceID_MID   ,b.OTCCardNumber,b.OTCSerialNumber ,'<--MemberInsDetailData@@@-->OTC&mstrData' as DataFromMInsDetail,   a.*    into #tempMasterData   from #tempfinal a   join master.MemberInsuranceDetails b on a.nhlinkidotc = b.InsuranceNbr           --and a.groupno = b.GroupNbr           and a.MemberInsuranceID = b.MemberInsuranceID   join master.Members c on a.masterMemberID = c.MemberID   --order by a.nhlinkidOtc                 ----------------------*******************----------------------               --'ll give you unmatch and missing from Master data               --using this update masterinsrancedetails table   select *    from #tempMasterData    where isnull(otcSerialNumber,0) <> serialNbr     update mmid set mmid.OTCSerialNumber = otc.SerialNbr   --select mmid.OTCSerialNumber, otc.SerialNbr,otc.id   from master.MemberInsuranceDetails mmid   join #tempMasterData otc on mmid.id = otc.id         and mmid.MemberInsuranceID = otc.MemberInsuranceID_MID   where 1=1   and isnull(mmid.otcSerialNumber,0) <> otc.serialNbr                 ----------------------******************----------------------   select b.*,'<--ProviderData****' as DataFromProvider,a.*    into #tempProviderdata   from #tempMasterData a   join (   select distinct c.id P_Id,a.NHMemberId P_NHMemberId,c.GroupNbr P_GroupNbr,c.InsuranceNbr P_InsuranceNbr,c.MemberInsuranceID P_MemberInsuranceID   ,c.OTCCardNumber P_OTCCardNumber,c.OTCSerialNumber P_OTCSerialNumber   from Provider.MemberProfiles a   join [provider].[MemberInsurances] b on a.MemberProfileId = b.MemberProfileId   join [provider].[MemberInsuranceDetails] c on b.MemberInsuranceID = c.MemberInsuranceID   where 1=1) b on a.NHMemberId = b.p_NHMemberId and b.p_GroupNbr = a.groupno and b.p_InsuranceNbr = a.InsuranceNbr  -- order by 1                 ---------------------****
--exec [elig].[sp_move_stgAccumToAccumIB] 'H339',null,1367  CREATE PROCEDURE [elig].[sp_move_stgAccumToAccumIB]   @ClientCode varchar(20),  @FileInfoId  bigint, --Not used replaced by clientcode  @FileTrackId bigint  AS  BEGIN    declare @sqlstr nvarchar(max),          @sqlstr2 nvarchar(max),    @rawTableColumns nvarchar(max),    @stgtableColumns nvarchar(max),    @stgtablename varchar(50),    @DataSource varchar(30),          @InsuranceCarrierID int,          @recordSno int        select @DataSource = fi.DataSource,        @InsuranceCarrierID = isnull(cc.InsuranceCarrierID,999)    from elig.FileInfo fi    join elig.FileTrack ft on fi.FileInfoID = ft.FileInfoID and ft.ClientCode = fi.ClientCode    join elig.clientcodes cc on fi.ClientCode = cc.ClientCode    where 1=1    and ft.FileTrackID = @FileTrackId        update elig.FileTrack set RecordsReceived = (select count(*) from elig.stgAccumulatorsInbound where FileTrackID = @FileTrackId)         where 1=1      and FileTrackID = @FileTrackId    select ClientCode     ,FileInfoId     ,FileTrackId     ,@DataSource as DataSource     ,@InsuranceCarrierID InsuranceCarrierID     ,1 as isActive     ,CAST(getdate() AT TIME ZONE 'UTC'   AT TIME ZONE 'Eastern Standard Time' AS DATE) as RecordEffDate     ,'12/31/2099' as RecordEndDate     ,Recordtype     ,GroupID     ,[SubscriberID]        ,[MemberRelationship]        ,[MemberFirstName]        ,[MemberSuffix]        ,[ProductAccumulatorSuffix]        ,[MemberAccumulatorType]        ,[AccumulatorNumber]        ,[AccumulatorPlanYear1]        ,[AccumulatorAmount1forYear1]        ,[AccumulatorAmount2forYear1]        ,[AccumulatorAmount3forYear1]        ,[AccumulatorPlanYear2]        ,[AccumulatorAmount1forYear2]        ,[AccumulatorAmount2forYear2]        ,[AccumulatorAmount3forYear2]        ,[AccumulatorPlanYear3]        ,[AccumulatorAmount1forYear3]        ,[AccumulatorAmount2forYear3]        ,[AccumulatorAmount3forYear3]     into #eligstgAccumulatorsInbound  from elig.stgAccumulatorsInbound  where 1=1  and FileTrackID = @FileTrackId;    delete s  from #eligstgAccumulatorsInbound s  join elig.AccumulatorsInbound t on (    s.ClientCode = t.ClientCode and    s.FileInfoId = t.FileInfoId and    s.DataSource = t.DataSource and    s.InsuranceCarrierID = t.insCarrierId and    s.isActive = t.isActive and    s.SubscriberID = t.SubscriberID and    s.AccumulatorNumber = t.AccumulatorNumber AND    s.Recordtype = t.Recordtype and    s.GroupID = t.GroupID and    s.MemberRelationship = t.MemberRelationship and    s.MemberFirstName = t.MemberFirstName and    s.MemberSuffix = t.MemberSuffix and    s.ProductAccumulatorSuffix = t.ProductAccumulatorSuffix and    s.MemberAccumulatorType = t.MemberAccumulatorType and    s.AccumulatorPlanYear1 = t.AccumulatorPlanYear1 and    s.AccumulatorAmount1forYear1 = t.AccumulatorAmount1forYear1 and    s.AccumulatorAmount2forYear1 = t.AccumulatorAmount2forYear1 and    s.AccumulatorAmount3forYear1 = t.AccumulatorAmount3forYear1 and    s.AccumulatorPlanYear2 = t.AccumulatorPlanYear2 and    s.AccumulatorAmount1forYear2 = t.AccumulatorAmount1forYear2 and    s.AccumulatorAmount2forYear2 = t.AccumulatorAmount2forYear2 and    s.AccumulatorAmount3forYear2 = t.AccumulatorAmount3forYear2 and    s.AccumulatorPlanYear3 = t.AccumulatorPlanYear3 and    s.AccumulatorAmount1forYear3 = t.AccumulatorAmount1forYear3 and    s.AccumulatorAmount2forYear3 = t.AccumulatorAmount2forYear3 and    s.AccumulatorAmount3forYear3 = t.AccumulatorAmount3forYear3             )  where 1=1  and t.isActive = 1    alter table #eligstgAccumulatorsInbound add ChangeRecflag bit;    update #eligstgAccumulatorsInbound set ChangeRecflag = 0;    with trg12 as (select * from elig.AccumulatorsInbound where isactive = 1)  MERGE trg12 t  using #eligstgAccumulatorsInbound as s   ON  (s.ClientCode = t.ClientCode and    s.FileInfoId = t.FileInfoId and    s.DataSource = t.DataSource and    s.InsuranceCarrierID = t.insCarrierId and    s.isActive = t.isActive and    s.SubscriberID =
  CREATE  PROCEDURE [elig].[sp_load_elig_to_crm_BCBSRIOTC] (@FileTrackID BIGINT)  AS  --- Version 1.00 -- 12/30/2019 - Raj Sareddy     -- New Procedure  --- Version 1.00 -- 01/01/2020 - Raj/ Srikanth   -- Validations and changes  --- Version 1.01 -- 01/07/2020 - Srikanth D      -- UPdated to be be processed to P  --- Version 1.02 -- 09/25/2020 - Raj/Srikanth/Sujay      -- UPdated not to update TR records enddate if they came back active again  --- Version 1.03 -- 12/04/2020 -- Sujay   -- Changes to introduce multiple files for same client  -- exec [elig].[sp_load_elig_to_crm] 915    BEGIN   DECLARE  @procedureName VARCHAR(100) = 'sp_load_elig_to_crm'     ,@sys_user CHAR(30)     ,@sys_date DATETIME     ,@DataSource NVARCHAR(50)     ,@MasterDataSource NVARCHAR(50)     ,@NewRecordCount INTEGER     ,@RecordsProcessed INTEGER     ,@ErrorRecordCount INTEGER     ,@ChangeRecordCount INTEGER     ,@DropRecordCount INTEGER     ,@NoChangeRecordCount INTEGER     ,@LogMessage VARCHAR(max)     ,@UserName VARCHAR(100) = SUSER_SNAME()     ,@ClientCode VARCHAR(100)     ,@FileInfoID BIGINT     ,@FileID BIGINT     ,@fullFile INT     ,@sql varchar(max)     ,@stepName VARCHAR(200)     ,@Snapshot varchar(20);     --,@IsThresholdCheck varchar(1)     --,@ThresholdValue varchar(20);   --- Version 1.0 -- Raj 1/1/2020     BEGIN TRY   BEGIN TRANSACTION sp_load_elig_to_crm        --- Get File Info from file track table for FileTrackID    /*    SELECT @DataSource = Datasource     ,@FileInfoID = FileInfoID     ,@ClientCode = ClientCode    FROM elig.filetrack    WHERE FileTrackID = @FileTrackID    */    SELECT @MasterDataSource = fi.MasterDataSource          , @DataSource = ft.Datasource     ,  @FileInfoID = ft.FileInfoID     ,  @ClientCode = ft.ClientCode     ,  @Snapshot = ft.SnapshotFlag     --, @IsThresholdCheck = fi.IsThresholdCheck     --, @ThresholdValue = fi.ThresholdValue    FROM elig.filetrack ft    join elig.FileInfo fi on ft.ClientCode = fi.ClientCode          and ft.FileType = fi.FileType         and ft.SnapshotFlag = fi.SnapshotFlag    WHERE ft.FileTrackID = @FileTrackID    /*    if @Snapshot ='FULL' and @IsThresholdCheck = 'Y'    begin     select filetrackid      ,sum(case when RecordStatus = 'ERR_DUP' then 1 else 0 end) as ERR_DUP      ,sum(case when RecordStatus = 'ERR_SPAN' then 1 else 0 end) as ERR_SPAN      ,sum(case when RecordStatus = 'ERR_XWALK' then 1 else 0 end) as ERR_XWALK      ,sum(case when RecordStatus = 'ERR_REC' then 1 else 0 end) as ERR_REC      ,sum(case when RecordStatus = 'ERR_OLDSPAN' then 1 else 0 end) as ERR_OLDSPAN      into #TempRecordCnt     from elig.errEligBenefitData     where 1 = 1     and filetrackid = @FileTrackID     group by filetrackid        select *      ,total = ERR_DUP + ERR_SPAN + ERR_XWALK + ERR_REC + ERR_OLDSPAN     from #TempRecordCnt       drop table #TempRecordCnt    end    */     SET @stepName = '100 Update MasterMemberId in same table'     EXEC elig.auditlog @ClientCode, @FileTrackID,@procedureName,@stepName,'S'      -- getting mastermemberid for the records where the member exists in the elig tables before with same NHLInkID     update t set t.MasterMemberID = x.MasterMemberID     from elig.mstrEligBenefitData t     join ( select NHLinkid, max(MasterMemberID) MasterMemberID       from elig.mstrEligBenefitData       where 1 = 1       and DataSource in (select datasource from elig.clientcodes where masterdatasource = @MasterDataSource)       and masterMemberID is not null       group by NHLinkid        ) x on t.NHLinkid = x.NHLinkid      where 1 = 1     and t.FileTrackId = @FileTrackID     and t.masterMemberID is null     and t.toBeProcessed = 'Y'       SET @stepName = '110 Insert into Master.Members - New Members'     EXEC elig.auditlog @ClientCode, @FileTrackID,@procedureName,@stepName,'S'       -- Inserting into members where the member change in as new for the first time     INSERT INTO master.members (           FirstName           ,MiddleInitial           ,LastName           ,DateOfBirth     
      --exec [elig].[sp_pop_orders_data] '01/01/2020', '02/17/2020'  create PROCEDURE [elig].[sp_pop_orders_data]   @StartDate date,  @EndDate date  AS  BEGIN      truncate table  elig.stg_OrderDetailData   -- Orders with only PO    -- Orders  insert into elig.stg_OrderDetailData   SELECT   o.NHMemberId  ,o.OrderID [OrderNumber]  ,CAST(o.DateOrderReceived AS DATE) [DateOrderReceived]  ,CASE WHEN DATEPART(HOUR,o.DateOrderInitiated)=0 AND DATEPART(MINUTE,o.DateOrderInitiated)=0 AND DATEPART(SECOND,o.DateOrderInitiated) =0 THEN CAST(o.DateOrderInitiated AS DATE)             ELSE CAST(CAST(o.DateOrderInitiated AT TIME ZONE 'UTC' AT TIME ZONE 'Eastern Standard Time' AS DATETIME) AS DATE) END [OrderCreatedDate]  ,CASE WHEN ISNULL(o.OrderType,'')='EXCHANGE' THEN 'NEW' ELSE o.OrderType END AS [OrderType] -- EXCHANGE should be NEW  ,CASE WHEN ISNULL(o.OrderType,'') IN ('EXCHANGE','LSandD') THEN o.RefOrderId ELSE NULL END AS [ReferenceOrder] -- Only for EXCHANGE & LSandD orders if available  ,o.Status  ,c.InsuranceCarrierName  ,hp.HealthPlanName InsuranceHealthPlanName  -- From Orders JSON  --,CASE WHEN JSON_VALUE(o.MemberData, '$.insurance.carrierName') = 'None' OR JSON_VALUE(o.MemberData, '$.insurance.carrierName') = '' THEN JSON_VALUE(o.MemberData, '$.insurance.programeName')  --      ELSE JSON_VALUE(o.MemberData, '$.insurance.carrierName') END AS 'CarrierName_JSON'  --,JSON_VALUE(o.MemberData, '$.insurance.planName') AS 'PlanName_JSON'  --  ,JSON_VALUE(o.MemberData,'$.firstName') AS [MemberFirstName]  ,JSON_VALUE(o.MemberData,'$.lastName') AS [MemberLastName]    ,JSON_VALUE(o.ProviderData,'$.providerId') AS [ProviderID]  --,JSON_VALUE(o.ProviderData,'$.address.locationId') AS [LocationID]    ,pp.ProviderName AS [ProviderLegalName]  ,ISNULL(CASE WHEN pp.DBA='' THEN NULL ELSE pp.DBA END,l.BusinessName) AS [ProviderDBA] -- Take location name if provider DBA is not available  -- From Orders JSON  --,JSON_VALUE(o.ProviderData,'$.providerLeagalBusinessName') AS [ProviderLegalName]  --,JSON_VALUE(o.ProviderData,'$.dba') AS [ProviderDBA]    ,JSON_VALUE(o.ProviderData,'$.dispenser') AS [ProviderDispenser]    -- If provider address (GN Hearing Care Corporation) not available use location address   ,ISNULL(CASE WHEN (JSON_VALUE(pp.AdditionalData,'$.billingAddress.address1'))='' THEN NULL ELSE JSON_VALUE(pp.AdditionalData,'$.billingAddress.address1') END,l.Address1)   +' '+   ISNULL(CASE WHEN (JSON_VALUE(pp.AdditionalData,'$.billingAddress.address2'))='' THEN NULL ELSE JSON_VALUE(pp.AdditionalData,'$.billingAddress.address2') END,l.Address2)  AS [ProviderAddress]  ,ISNULL(CASE WHEN JSON_VALUE(pp.AdditionalData,'$.billingAddress.city')='' THEN NULL ELSE JSON_VALUE(pp.AdditionalData,'$.billingAddress.city') END,l.City) AS [ProviderCity]  ,ISNULL(CASE WHEN JSON_VALUE(pp.AdditionalData,'$.billingAddress.state')='' THEN NULL ELSE JSON_VALUE(pp.AdditionalData,'$.billingAddress.state') END,l.State) AS [ProviderState]  ,ISNULL(CASE WHEN JSON_VALUE(pp.AdditionalData,'$.billingAddress.zip') IN ('','0') THEN NULL ELSE JSON_VALUE(pp.AdditionalData,'$.billingAddress.zip') END,l.Zip) AS [ProviderZip]  -- From Orders JSON  --,JSON_VALUE(o.ProviderData,'$.address.address') AS [ProviderAddress]  --,JSON_VALUE(o.ProviderData,'$.address.city') AS [ProviderCity]  --,JSON_VALUE(o.ProviderData,'$.address.state') AS [ProviderState]  --,JSON_VALUE(o.ProviderData,'$.address.zip') AS [ProviderZip]    ,b.[BrandCode] AS [Manufacturer]  ,lm.FamilyCode Left_Family, lm.ItemCode Left_HA, lm.TechnologyLevelCode Left_Technology  ,rm.FamilyCode Right_Family, rm.ItemCode Right_HA, rm.TechnologyLevelCode Right_Technology  --,ISNULL(lm.ItemCode ,rm.ItemCode ) AS Single_ItemCode  ,oq.DeviceCount AS 'Quantity'    -- COGS  ,pl.UnitCOGS Left_COGS -- Micah will verify if COGS missing for ItemCodes in catalog.ItemMasterPriceList  ,pr.UnitCOGS Right_COGS -- Micah will verify if COGS missing for ItemCodes in catalog.ItemMasterPriceList  ,ISNULL(pl.UnitCOGS,0)+ISNULL(pr.UnitCOGS,0) Total_CO
      --exec [elig].[sp_BCBSRI_Encounter_file] 270  CREATE PROCEDURE [elig].[sp_BCBSRI_Encounter_file_bkupon2172020]   @CarrierID int --270 for bcbsri  AS  BEGIN    --declare @fileid int  --set @fileid = 3  select *   into #temp  from temp.bcbsi_r_20200216_claimfiles a  where 1=1  and sendflag='YES'    select * into #temp_errorRec  from  (  select NHMemberId, testing, HA, Fitting,  case when ( HA = 2 and Fitting = 3 and testing = 0) then 'NO Testing with HA&Fitting Record'    when ( HA = 2 and testing = 0) then 'NO Testing with HA Record'    when ( testing = 1 ) then 'Good Record'  end as junk  from  (  select NHMemberId,max(isnull(testing,0)) testing,max(isnull(HA,0)) HA,max(isnull(Fitting,0)) Fitting   from (  select NHMemberId,    case when HCPCSCodeDescription = 'TESTING' then linesequenceNbr end testing,    case when HCPCSCodeDescription not in ( 'TESTING','FITTING') then linesequenceNbr end HA,    case when HCPCSCodeDescription = 'FITTING' then linesequenceNbr end Fitting  from temp.bcbsi_r_20200216_claimfiles  where 1=1  and sendflag='YES'  ) a  group by NHMemberId  ) x  ) y   where junk <> 'Good Record'    update a  set flexVC1 = 'Bad Record'   from temp.bcbsi_r_20200216_claimfiles a  join (select distinct NHMemberId from #temp_errorRec) b on a.NHMemberId = b.NHMemberId    delete from #temp where NHMemberId in (select distinct NHMemberId from #temp_errorRec)    select NHMemberId, (NEXT VALUE FOR [elig].[BCBSRIEncounter_Sequence]) AS BCBSRIEncounter_Sequence into #temp2  from (  select distinct NHMemberId  from #temp  ) x    --select * from #temp2    update a  set a.TransactionID = BCBSRIEncounter_Sequence  from temp.bcbsi_r_20200216_claimfiles a  join #temp2 b on a.NHMemberId = b.NHMemberId  where 1=1  and sendflag='YES'      select 0 as fororder, 'Header' as fororderdesc,'H' as nhmemberid,getdate() as serviceDate,  'H' +'|'+'TransactionID' +'|'+ 'LineSequenceNbr' +'|'+ 'ClaimStatus' +'|'+ 'NHMemberID' +'|'+   'PolicyNbr' +'|'+ 'GroupNbr' +'|'+ 'MemberFirstName' +'|'+'MemberMiddleInitial' +'|'+   'MemberLastName' +'|'+ 'DateofBirth' +'|'+ 'PhoneNbr' +'|'+ 'DateofService' +'|'+   'ReturnDate' +'|'+'PlaceofService' +'|'+ 'ICD10Code' +'|'+ 'HCPCSCode' +'|'+   'HCPCSCodeDescription' +'|'+'Units' +'|'+ 'Modifier' +'|'+'HCPNPINumber' +'|'+   'RenderingProviderFirstName' +'|'+ 'RenderingProviderLastName' +'|'+   'LocationAddress1' +'|'+ 'LocationAddress2' +'|'+ 'LocationCity' +'|'+   'LocationState' +'|'+ 'LocationZipCode' +'|'+ 'OrganizationNPI' +'|'+  'BillingNPI' +'|'+ 'BillingTaxID' +'|'+ 'ChargeAmt' +'|'+ 'CopayAmt' +'|'+   'BenefitAmt' +'|'+ 'MemberPaidAmt' +'|'+ 'ClaimPaidAmt' +'|'+'ParticipatingProvider' +'|'+   'CoinsuranceAmt' +'|'+ 'CoinsurancePercent' +'|'+'NoncoveredAmt' +'|'+   'ClaimReceivedDate'+'|'+'ClaimPaidDate'+'|'+ 'FileDate'  as Outputtext  union  select 1 as fororder, 'Data' as fororderdesc,a.NHMemberID as nhmemberid,a.DateofService,  LEFT(isnull(a.RecordType,''),1)  +'|'+ cast(a.TransactionID as varchar(10)) -- 'TransactionID'   +'|'+ cast(a.LineSequenceNbr as varchar(10))-- 'LineSequenceNbr'   +'|'+ LEFT(isnull(a.ClaimStatus,''),15) -- ClaimStatus    +'|'+  LEFT(isnull(a.NHMemberId,''),30) --'NHMemberID'   +'|'+ LEFT(isnull(a.PolicyNbr,''),20)  -- 'PolicyNbr'   +'|'+ LEFT(isnull(a.GroupNbr,''),20) --'GroupNbr'   +'|'+ LEFT(isnull(a.MemberFirstName,''),30) --'MemberFirstName'   +'|'+ LEFT(isnull(a.MemberMiddleInitial,''),1) --'MemberMiddleInitial'   +'|'+ LEFT(isnull(a.MemberLastName,''),30) --'MemberLastName'   +'|'+ left(convert(varchar,cast(a.DateOfBirth as date), 112),8) --'DateofBirth'  +'|'+ cast(isnull(a.PhoneNbr,'') as varchar(10)) --'PhoneNbr'  +'|'+ isnull(left(convert(varchar,cast(a.DateofService as date), 112),8),'') --'DateofService'   +'|'+ case when a.ReturnDate = '' then '' else isnull(left(convert(varchar,cast(a.ReturnDate as date), 112),8),'') end-- 'ReturnDate'   +'|'+ LEFT(isnull(a.PlaceofService,'') ,2) --'PlaceofService'   +'|'+  LEFT(isnull(a.ICD10Code,'') ,10) --'ICD10Code'   +'
    -- EXEC [ELIG].[elig_file_load_ssis_sp_merge_elig_HAP_to_master]     CREATE PROCEDURE [elig].[elig_file_load_ssis_sp_merge_elig_HAP_to_master]      AS    BEGIN   BEGIN TRY   BEGIN TRANSACTION member_load_elig_to_master_HAP    DECLARE @sys_user CHAR(30)      ,@sys_date DATETIME;      SET @sys_user = SYSTEM_USER  --SET @sys_date = CAST(GETDATE() AS DATE);    SET @sys_date = CAST(GETDATE() AT TIME ZONE 'UTC' AT TIME ZONE 'Eastern Standard Time' AS DATETIME);  -- Time in EST         -- drop not null record insert constraint (unique index) on NHMemberID in master.members before inserting new members or updating NHMemberID for new records inserted      ALTER TABLE [Master].[Members] DROP CONSTRAINT [IX_Members_NHMemberID_U]          MERGE Master.Members d                USING ( SELECT * FROM [ELIG].[Members] WHERE  DataSource='ELIG_HAP' AND ToBeProcessed = 'Y' AND StatusFlag in ('N','U')) s                ON (d.memberid = s.mastermemberid )                  WHEN MATCHED THEN                                                                                                 UPDATE SET                d.EligFile = 'ELIG_HAP',                d.eligFileID = s.ID,                d.DateOfBirth = s.[DOB],                d.FirstName = s.FirstName,                d.Gender = s.Gender,                d.IsActive = 1,                d.LastName = s.LastName,                d.MiddleInitial = s.MiddleName,                d.ModifyDate = @sys_date,                d.ModifyUser = @sys_user                  WHEN NOT MATCHED THEN                  INSERT (          CreateDate,                        CreateUser,                        DataSource,                        DateOfBirth,                        FirstName,                        Gender,                        IsActive,                        LastName,                        MiddleInitial,                        ModifyDate,                        ModifyUser,                        EligFile,                        EligFileID)                          VALUES                         (                        @sys_date                ,@sys_user                ,'ELIG_HAP'                ,DOB                ,FirstName                ,Gender                ,1                ,LastName                ,MiddleName                ,@sys_date                ,@sys_user                ,'ELIG_HAP'                ,ID                );            -- Assign mastermemberid in AnthemMembers after inserting new records into master.members    UPDATE a           SET a.MasterMemberID = (SELECT memberid FROM [Master].[Members] m where m.EligFileID = a.id and m.EligFile = 'ELIG_HAP')          FROM [ELIG].[Members] a          WHERE 1=1    AND a.tobeprocessed = 'Y'                                                               AND a.mastermemberid IS NULL          -- Update NHMemberID for newly inserted members    UPDATE [Master].[Members]    SET nhmemberid = 'NH'+RIGHT(YEAR(GETDATE()),4)+ FORMAT(memberid,'00000000')        --    'NH2018'+ FORMAT(memberid,'00000000')    WHERE EligFile = 'ELIG_HAP'    AND nhmemberid IS NULL      -- Re create the unique NHMemberID index    ALTER TABLE [Master].[Members] ADD  CONSTRAINT [IX_Members_NHMemberID_U] UNIQUE NONCLUSTERED     (     [NHMemberID] ASC    )         ---- Assign mastermemberid to AnthemInsurance records from AnthemMembers joining on newNHLinkID       --UPDATE i    --SET mastermemberid = ( SELECT mastermemberid FROM [anthemelig].[AnthemMembers] m WHERE m.newNHLinkID = i.newNHLinkID )    --FROM [anthemelig].[AnthemInsurance] i    --WHERE EXISTS (SELECT 1 FROM [anthemelig].[AnthemMembers] m1 WHERE m1.newNHLinkID = i.newNHLinkID)    --AND i.mastermemberid IS NULL      -- Assign mastermemberid to ELIG Insurance from Members    --update a     --set a.mastermemberid  = (select m.mastermemberid from elig.members m where m.nhlinkid = a.nhlinkid)    --from ELIG.insurances a      update a     set a.mastermemberid  =  m.mastermemberid     -- select a.mastermemberid  ,  m.mastermemberid     f
  --exec [elig].[sp_AccumulatorsOutbound_File] '221~7~274' -- 'EON Health Plan~CCAI~Clear Spring'  CREATE PROCEDURE [elig].[sp_AccumulatorsOutbound_File]   @CarrierIds varchar(1000)  AS  BEGIN    create table #temp_CarrierId (CarrierId varchar(100))    insert into #temp_CarrierId  select cs.Value --SplitData  from (select @CarrierIds as CarrierId ) a  cross apply STRING_SPLIT (CarrierId, '~') cs      create table #temp_EBCDIC (Character varchar(2),NumberRepresentation int)    insert into #temp_EBCDIC values ('}',0)  insert into #temp_EBCDIC values ('J',1)  insert into #temp_EBCDIC values ('K',2)  insert into #temp_EBCDIC values ('L',3)  insert into #temp_EBCDIC values ('M',4)  insert into #temp_EBCDIC values ('N',5)  insert into #temp_EBCDIC values ('O',6)  insert into #temp_EBCDIC values ('P',7)  insert into #temp_EBCDIC values ('Q',8)  insert into #temp_EBCDIC values ('R',9)    --select * from #temp_EBCDIC    --truncate table [elig].[AccumulatorsOutbound] --review after testing    select  --left(cast(abs([APPROVED_AMT]) as varchar),len(cast(abs([APPROVED_AMT]) as varchar))-1)+''+ (case when [APPROVED_AMT] < 0 then (select Character from #temp_EBCDIC where NumberRepresentation = right(cast(abs([APPROVED_AMT]) as varchar),1)) end) junk_app,      LEFT('CSH'+space(5),5) --Client_Code   +LEFT(isnull([MEM_FIRST_NAME],'')+space(15),15) --MEM_FIRST_NAME   +LEFT(isnull([MEM_MID_INIT],'')+space(1),1) --MEM_MID_INIT   +LEFT(isnull([MEM_LAST_NAME],'')+space(20),20) --MEM_LAST_NAME   +LEFT(isnull([CARRIER_ID],'')+space(12),12) --CARRIER_ID --groupId   +LEFT(isnull([ACCOUNT_ID],'')+space(12),12) --ACCOUNT_ID --subgroupId   +LEFT(isnull([GROUP_ID],'')+space(12),12) --GROUP_ID    +left(isnull(convert(varchar,cast([DATE_OF_BIRTH] as date), 112),'')+space(10),10) --[DATE_OF_BIRTH]   +LEFT(isnull([MEMBER_ID],'')+space(9),9) --[MEMBER_ID]   --+LEFT(isnull(convert(varchar,FORMAT([CHG_AMT],'000000000000')),'000000000000')+space(12),12) --[CHG_AMT] --oa_productprice   +LEFT(isnull(convert(varchar,   case when [CHG_AMT] < 0 then   RIGHT('000000000000'+cast(left(cast(abs([CHG_AMT]) as varchar),len(cast(abs([CHG_AMT]) as varchar))-1)+''+ (case when [CHG_AMT] < 0 then (select Character from #temp_EBCDIC where NumberRepresentation = right(cast(abs([CHG_AMT]) as varchar),1)) end) as varchar(12)),12)   else   FORMAT([CHG_AMT],'000000000000')   end   ),'000000000000')+space(12),12)     --+LEFT(isnull(convert(varchar,FORMAT([APPROVED_AMT],'000000000000')),'000000000000')+space(12),12) --[APPROVED_AMT] --oa_benefitavailable   +LEFT(isnull(convert(varchar,   case when [APPROVED_AMT] < 0 then   RIGHT('000000000000'+cast(left(cast(abs([APPROVED_AMT]) as varchar),len(cast(abs([APPROVED_AMT]) as varchar))-1)+''+ (case when [APPROVED_AMT] < 0 then (select Character from #temp_EBCDIC where NumberRepresentation = right(cast(abs([APPROVED_AMT]) as varchar),1)) end) as varchar(12)),12)   else   FORMAT([APPROVED_AMT],'000000000000')   end   ),'000000000000')+space(12),12) --[APPROVED_AMT] --oa_benefitavailable     --+LEFT(isnull(convert(varchar,FORMAT([PAID_AMT],'000000000000')),'000000000000')+space(12),12)  --[PAID_AMT] ----b_benefitappliedamount   +LEFT(isnull(convert(varchar,   case when [PAID_AMT] < 0 then   RIGHT('000000000000'+cast(left(cast(abs([PAID_AMT]) as varchar),len(cast(abs([PAID_AMT]) as varchar))-1)+''+ (case when [PAID_AMT] < 0 then (select Character from #temp_EBCDIC where NumberRepresentation = right(cast(abs([PAID_AMT]) as varchar),1)) end) as varchar(12)),12)   else   FORMAT([PAID_AMT],'000000000000')   end   ),'000000000000')+space(12),12)     +LEFT(isnull('','')+space(20),20) --[SVC_CAT] --non   +LEFT(isnull('000000000000','000000000000')+space(12),12) --[INN_DED_AMT] --000000000000      --+LEFT(isnull(FORMAT([INN_MOOP_AMT],'000000000000'),'000000000000')+space(12),12) --[INN_MOOP_AMT] --oa_memberresponsibleamount --000000000000   +LEFT(isnull(convert(varchar,   case when [INN_MOOP_AMT] < 0 then   RIGHT('000000000000'+cast(left(cast(abs([INN_MO
  -- exec [elig].[sp_noble_itemCodes_out_file] 'FULL'  -- exec [elig].[sp_noble_itemCodes_out_file] 'DELTA'  CREATE PROCEDURE [elig].[sp_noble_itemCodes_out_file]   @Filetype varchar(10) --FULL/Delta  AS  BEGIN     declare @FiletypeFlag int = 1;     if @Filetype ='FULL'   begin     set @FiletypeFlag = 2;   end     select *    into #temp   from (     ---------For DELTA     select 'DELTA' as FileType,       CONCAT(ItemCode, '_1') as ITEM_ID,      MonauralHCPCSCode as HCPCS_CODE,      CONCAT('Monaural Device,Brand:', BrandCode,',Family:',FamilyCode,',Shell:', StyleCode) ITEM_DESCRIPTION,      0 as ITEM_PRICE     from catalog.ItemMasterList      where 1 = @FiletypeFlag       and ItemCode not in (select DISTINCT LEFT(ITEM_ID, LEN(ITEM_ID) - 2)            from NobleDirect_ItemCode_HCPCS_Code_MasterList)        and ItemType = 'HA' and IsActive = 1     union     select 'DELTA' as FileType,        CONCAT(ItemCode, '_2') as ITEM_ID,      BinauralHCPCSCode as HCPCS_CODE,      CONCAT('Binaural Device,Brand:', BrandCode,',Family:',FamilyCode,',Shell:', StyleCode) ITEM_DESCRIPTION,      0 as ITEM_PRICE     from catalog.ItemMasterList      where 1 = @FiletypeFlag       and ItemCode not in (select DISTINCT LEFT(ITEM_ID, LEN(ITEM_ID) - 2)                               from NobleDirect_ItemCode_HCPCS_Code_MasterList)       and ItemType = 'HA' and IsActive = 1        union     ---------For FULL     select 'FULL' as FileType,      CONCAT(ItemCode, '_1') as ITEM_ID,      MonauralHCPCSCode as HCPCS_CODE,      CONCAT('Monaural Device,Brand:', BrandCode,',Family:',FamilyCode,',Shell:', StyleCode) ITEM_DESCRIPTION,      0 as ITEM_PRICE     from catalog.ItemMasterList      where 2 = @FiletypeFlag       --and ItemCode not in (select DISTINCT LEFT(ITEM_ID, LEN(ITEM_ID) - 2)        --    from NobleDirect_ItemCode_HCPCS_Code_MasterList)        and ItemType = 'HA' and IsActive = 1     union     select 'FULL' as FileType,       CONCAT(ItemCode, '_2') as ITEM_ID,      BinauralHCPCSCode as HCPCS_CODE,      CONCAT('Binaural Device,Brand:', BrandCode,',Family:',FamilyCode,',Shell:', StyleCode) ITEM_DESCRIPTION,      0 as ITEM_PRICE     from catalog.ItemMasterList      where 2 = @FiletypeFlag       --and ItemCode not in (select DISTINCT LEFT(ITEM_ID, LEN(ITEM_ID) - 2)       --                        from NobleDirect_ItemCode_HCPCS_Code_MasterList)       and ItemType = 'HA' and IsActive = 1         ) tbl     insert into NobleDirect_ItemCode_HCPCS_Code_MasterList (      ITEM_ID     ,HCPCS_CODE     ,ITEM_DESCRIPTION     ,ITEM_PRICE     ,SentDate_To_NobleDirect)   select   ITEM_ID     ,HCPCS_CODE     ,ITEM_DESCRIPTION     ,ITEM_PRICE     ,getdate() SentDate_To_NobleDirect   from #temp   where 1=1     and item_id not in (select ITEM_ID         from NobleDirect_ItemCode_HCPCS_Code_MasterList           where 1=1         )     select 0 as fororder, 'Header' as fororderdesc,     'ITEM_ID,HCPCS_CODE,ITEM_DESCRIPTION,ITEM_PRICE' as Outputtext   union   select 1 as fororder, 'Data' as fororderdesc,          '"'+ ITEM_ID    +'","'+ HCPCS_CODE    +'","'+ ITEM_DESCRIPTION    +'",'+ cast(ITEM_PRICE as varchar) as Outputtext   from #temp   where 1=1   order by 1     drop table #temp    END  
  -- =============================================  -- Author:      Jitender  -- Create Date: Oct 2020  -- Description: InComm Purse Eligibility File  -- EXEC [elig].[sp_2021_Incomm_Purse_Out_File] 'H223_O','H223_O','ELIG' --ELIG_BCBSRIOTC  -- EXEC [elig].[sp_2021_Incomm_Purse_Out_File] 'H344','H344','ELIG' --ELIG_ZING  -- =============================================    CREATE PROCEDURE [elig].[sp_2021_Incomm_Purse_Out_File]   @InClientCode varchar(20), --H223_O for bcbsriOTC; H348 for troy  @OutClientCode varchar(20), --not used   @Filetype varchar(10)     AS  BEGIN    DECLARE @DataSource varchar(20)  DECLARE @strCrossWalkWhereClause VARCHAR(max)  DECLARE @sql VARCHAR(max)    select @DataSource = DataSource  from elig.ClientCodes  where 1=1  and ClientCode = @InClientCode     SET @strCrossWalkWhereClause = [elig].[getCrossWalkWhereClause](@InClientCode, @Filetype)   SET NOCount ON    SET xact_abort ON   SET concat_NULL_Yields_NULL off     DECLARE @Ret_Var Int ,      @Error_Code Int,     @ProgramCode varchar(10),     @HealthPlanCode varchar(20)     SELECT @Ret_Var = 0,        @Error_Code = 0     create table #temp_IncommCodes (ClientCode varchar(10),              ProgramCode  varchar(16),           HealthPlanCode varchar(3))      insert into #temp_IncommCodes (ClientCode,HealthPlanCode,ProgramCode)   select 'H344','HL4','PL4-4168' union   select 'H223_O','HJ7','PJ7-3987'      select @ProgramCode = ProgramCode,     @HealthPlanCode = HealthPlanCode   from #temp_IncommCodes   where ClientCode = @InClientCode     set @sql =  'SELECT 1 as fororder,  ''Health Plan code,Program Code,Purse Name,Member Number,Effective Date,Expiry Date''  as Outputtext  where 1=2  UNION  SELECT  2 as fororder,  ''' + @HealthPlanCode + '''  +'',''+ ''' + @ProgramCode + '''  +'',''+SUBSTRING(REPLACE(ISNULL(p.WalletName,''''),''-'',''''),1,15)         +'',''+SUBSTRING(REPLACE(ISNULL(mstrEligBenefitData.nhlinkid,''''),''-'',''''),1,20)        +'',''+CASE WHEN mstrEligBenefitData.BenefitStartDate > h.effectivefromdate THEN convert(varchar,mstrEligBenefitData.BenefitStartDate,101) ELSE convert(varchar,h.effectivefromdate,101) END   +'',''+case when mstrEligBenefitData.BenefitEndDate < h.effectivetodate THEN convert(varchar,mstrEligBenefitData.BenefitEndDate,101) ELSE convert(varchar,h.effectivetodate,101) END      AS Outputtext  FROM elig.mstrEligBenefitData   join elig.BenefitCrossWalk on (' + @strCrossWalkWhereClause +  ') join elig.HealthPlanWallet h on (mstrEligBenefitData.insHealthPlanID = h.InsuranceHealthPlanId                                        and (CAST(getdate() AT TIME ZONE ''UTC''   AT TIME ZONE ''Eastern Standard Time'' AS DATE) between h.EffectiveFromDate  and  h.EffectiveToDate               or (h.EffectiveFromDate > CAST(getdate() AT TIME ZONE ''UTC''   AT TIME ZONE ''Eastern Standard Time'' AS DATE) AND h.EffectiveToDate > h.EffectiveFromDate))   ) join elig.otc_wallet p on (h.WalletName = p.WalletName)   where 1=1  and mstrEligBenefitData.DataSource = ''' + @dataSource + '''  and mstrEligBenefitData.isActive=1  and (CAST(getdate() AT TIME ZONE ''UTC''   AT TIME ZONE ''Eastern Standard Time'' AS DATE) between  mstrEligBenefitData.BenefitStartDate and  mstrEligBenefitData.BenefitEndDate    or (mstrEligBenefitData.BenefitStartDate > CAST(getdate() AT TIME ZONE ''UTC''   AT TIME ZONE ''Eastern Standard Time'' AS DATE) AND mstrEligBenefitData.BenefitEndDate > mstrEligBenefitData.BenefitStartDate))   ORDER by 1'    --select @sql  --for testing  --and mstrEligBenefitData.SubscriberID in (  --''Z2M200387600'',''Z3M200387615'',''Z3M200417879'',''ZBM200388335'',''ZBM200387638'',''ZBM200387593'',          --''ZBM200387584'',''ZBM200387821'')      EXEC (@sql);      SELECT @Error_Code = @@Error      IF @Error_Code <> 0  OR @Ret_Var <> 0        BEGIN       SET @Ret_Var = Case @Ret_Var WHEN 0 THEN @Error_Code ELSE @Ret_Var END      GOTO __SPRETURN       END      END  __SPRETURN:      
  -- =============================================  -- Author:      Jitender  -- Create Date: Oct 2020  -- Description: InComm Cardholder Demographic File  -- EXEC [elig].[sp_2021_Incomm_Cardholder_Out_File] 'H223_O','H223_O','ELIG' --ELIG_BCBSRIOTC  -- EXEC [elig].[sp_2021_Incomm_Cardholder_Out_File] 'H344','H344','ELIG' --ELIG_ZING  -- =============================================    CREATE PROCEDURE [elig].[sp_2021_Incomm_Cardholder_Out_File]   @InClientCode varchar(20), --H223_O for ELIG_BCBSRIOTC; H348 for troy  @OutClientCode varchar(20), --Not in use  @Filetype varchar(10) --FULL/Delta  AS  BEGIN    DECLARE @DataSource varchar(20)  DECLARE @strCrossWalkWhereClause VARCHAR(max)  DECLARE @sql_bcbsri VARCHAR(max)  DECLARE @sql_zing VARCHAR(max)    SELECT @DataSource = DataSource  FROM elig.ClientCodes  WHERE 1=1  and ClientCode = @InClientCode     SET @strCrossWalkWhereClause = [elig].[getCrossWalkWhereClause](@InClientCode, @Filetype)   SET NOCount ON    SET xact_abort ON   SET concat_NULL_Yields_NULL off     DECLARE @Ret_Var Int ,      @Error_Code Int,     @ProgramCode varchar(10),     @HealthPlanCode varchar(20),     @PackageId varchar(20)        SELECT @Ret_Var = 0,        @Error_Code = 0     CREATE TABLE #temp_IncommCodes (ClientCode  varchar(10),              HealthPlanCode varchar(3),           ProgramCode  varchar(16),           PackageId varchar(3))      INSERT INTO #temp_IncommCodes (ClientCode,HealthPlanCode,ProgramCode,PackageId)   SELECT 'H344','HL4','PL4-4168','978' UNION   SELECT 'H223_O','HJ7','PJ7-3987','943'      SELECT @ProgramCode = ProgramCode,       @HealthPlanCode = HealthPlanCode,       @PackageId = PackageId   FROM #temp_IncommCodes   WHERE ClientCode = @InClientCode    -----  BCBSRI OTC     SET @sql_bcbsri =  'SELECT 1 as fororder,  ''Health Plan code,Program Code,Member ID,Member ID2,First Name,Middle Name,Last Name,Street1,Street2,City,State,Zip,Group Number,User Defined Field1,User defined Field2,Intial Activation Code,Package ID,E-Card,Mobile Phone,Email''  as Outputtext  UNION  SELECT  2 as fororder,  ''' + @HealthPlanCode + '''  +'',''+ ''' + @ProgramCode + '''  +'',''+SUBSTRING(REPLACE(ISNULL(mstrEligBenefitData.AlternateID,''''),'','',''''),1,20)        +'',''+SUBSTRING(REPLACE(ISNULL(mstrEligBenefitData.SubscriberID,''''),'','',''''),1,20)     +'',''+SUBSTRING(REPLACE(ISNULL(FirstName,''''),'','',''''),1,32)     +'',''+SUBSTRING(REPLACE(ISNULL(mstrEligBenefitData.MiddleInitial,''''),'','',''''),1,32)     +'',''+SUBSTRING(REPLACE(ISNULL(LastName,''''),'','',''''),1,32)         +'',''+SUBSTRING(REPLACE(ISNULL(MailingAddress1,''''),'','',''''),1,40)       +'',''+SUBSTRING(REPLACE(ISNULL(MailingAddress2,''''),'','',''''),1,40)        +'',''+SUBSTRING(REPLACE(ISNULL(MailingCity,''''),'','',''''),1,32)          +'',''+SUBSTRING(REPLACE(ISNULL(MailingState,''''),'','',''''),1,2)           +'',''+right(CONCAT(replicate(''0'', 5),ISNULL(mstrEligBenefitData.MailingZipCode,'''')), 5)   +'',''+SUBSTRING(REPLACE(ISNULL(mstrEligBenefitData.GroupNbr,''''),'','',''''),1,24)            +'',''+SUBSTRING('''',1,64)                  +'',''+SUBSTRING('''',1,64)                  +'',''+SUBSTRING(REPLACE(ISNULL(RIGHT(AlternateID,4), ''''),'','',''''), 1, 14)            +'',''+ ''' + @PackageId + '''                +'',''+SUBSTRING('''',1,1)                   +'',''+LEFT(ISNULL(convert(varchar(10),case when len(mstrEligBenefitData.HomePhoneNbr) < 10 then '''' else mstrEligBenefitData.HomePhoneNbr end),'''')+space(10),10)    +'',''+SUBSTRING('''',1,100)                   AS Outputtext  FROM elig.mstrEligBenefitData   join elig.BenefitCrossWalk  on (' + @strCrossWalkWhereClause +  ')  WHERE  1=1  and mstrEligBenefitData.DataSource = ''' + @dataSource + '''  and mstrEligBenefitData.isActive=1  and CAST(getdate() AT TIME ZONE ''UTC''  AT TIME ZONE ''Eastern Standard Time'' AS DATE) between mstrEligBenefitData.RecordEffDate and mstrEligBenefitData.RecordEndDate  and (CAST(getdate() AT TIME ZONE ''UTC''  AT TIME ZONE 
  --exec [elig].[sp_BCBSRIEncounter_feed]   CREATE PROCEDURE [elig].[sp_BCBSRIEncounter_feed]   AS  BEGIN    SELECT 'Testing' AS RecordType   ,1 AS RecordSequenceNbr   ,td.NHMemberID   ,td.MemberProfileID   ,td.AppointmentStatus   ,td.AppointmentDate AS serviceDate   ,td.ProviderID   --,l.NPINumber   --,hc.NPINumber  INTO #tempTestingData  --,td.*  FROM bireports.PTestingDates td  --FROM bireports.QTesting td  JOIN provider.Memberprofiles m ON m.NHMemberID = td.NHMemberId  JOIN provider.MemberInsurances i ON (    i.MemberprofileId = m.MemberprofileId    AND i.IsActive = 1    )  left join provider.Locations l on l.LocationId = td.LocationID  left join provider.HCPProviderProfile hc on td.HCPUserProfileID = hc.UserProfileId  WHERE 1 = 1   --and td.appointmentstatus ='Complete'   AND i.Insurancecarrierid = 270      --Hearing Aid  SELECT 'Hearing Aid' AS RecordType   ,2 AS RecordSequenceNbr   ,o.NHMemberId   ,m.MemberProfileID   ,o.STATUS   ,oi.PODate AS servicedate   ,o.PROVProviderId as ProviderID   ,CASE WHEN o.DeviceCount = 1 THEN x.MonauralHCPCSCode         WHEN o.DeviceCount = 2 THEN x.BinauralHCPCSCode    ELSE 'N/A' END AS hcpcs_code   ,CASE WHEN (lo.Modifier = 'LT' AND ro.Modifier = 'RT' ) THEN '' ELSE isnull(lo.Modifier, ro.Modifier) END AS Modifier   ,o.OrderID   ,o.DeviceCount   ,o.ItemCode   ,o.OADProductPrice   ,o.OADInsuranceBenefit   ,o.OADMemberResponsibility   ,o.HCPNPINumber  INTO #tempHAData  FROM [bireports].[POrderInfo] o  --join bireports.PClaimInfo clm on clm.ORDERID=o.OrderID  JOIN bireports.PPOInfo oi ON o.OrderID = oi.OrderID  JOIN provider.Memberprofiles m ON m.NHMemberID = o.NHMemberId  JOIN provider.MemberInsurances i ON (i.MemberprofileId = m.MemberprofileId AND i.IsActive = 1 )  LEFT JOIN CATALOG.ItemMasterList x ON x.ItemCode = o.ItemCode  --left join NobleDirect_ItemCode_HCPCS_Code_Mapping j on j.ITEM_ID = o.ItemCode +'_'+cast(o.devicecount as varchar)  LEFT JOIN orders.OrderItems lo ON ( lo.OrderId = o.OrderID           AND lo.Modifier = 'LT'           AND lo.itemtype IN ('HA','CROS')           )  LEFT JOIN orders.OrderItems ro ON ( ro.OrderId = o.OrderID           AND ro.Modifier = 'RT'           AND ro.itemtype IN ('HA','CROS' )           )  WHERE 1 = 1   --and td.appointmentstatus ='Complete'   AND i.Insurancecarrierid = 270   and o.status <> 'RETURNED'   --and clm.FittingDate is not null        --Fitting  select   'Fitting' as RecordType,  3 as RecordSequenceNbr,  o.NHMemberId,  m.MemberProfileID,  o.ordertype as Status,  clm.FittingDate as servicedate,  o.PROVProviderId as ProviderID,  case when o.DeviceCount = 1 then x.MonauralHCPCSCode       when o.DeviceCount = 2 then x.BinauralHCPCSCode else 'N/A' end as hcpcs_code,  case when (lo.Modifier='LT' and ro.Modifier='RT') then ''         else isnull(lo.Modifier,ro.Modifier) end  as Modifier,  o.OrderID,o.DeviceCount,o.ItemCode,o.OADProductPrice,o.OADInsuranceBenefit,o.OADMemberResponsibility,o.HCPNPINumber  into #tempFittingData  from [bireports].[POrderInfo] o  join bireports.PClaimInfo clm on clm.ORDERID=o.OrderID  join provider.Memberprofiles m on m.NHMemberID=o.NHMemberId  join provider.MemberInsurances i on (i.MemberprofileId=m.MemberprofileId and i.IsActive=1)  left join catalog.ItemMasterList x on x.ItemCode = o.ItemCode  --left join NobleDirect_ItemCode_HCPCS_Code_Mapping j on j.ITEM_ID = o.ItemCode +'_'+cast(o.devicecount as varchar)  left join orders.OrderItems lo on (lo.OrderId=o.OrderID and lo.Modifier='LT' and lo.itemtype in ('HA', 'CROS'))  left join orders.OrderItems ro on (ro.OrderId=o.OrderID and ro.Modifier='RT' and ro.itemtype in ('HA', 'CROS'))  where 1=1   and clm.FittingDate is not null  and o.status not in ('CANCELLED','RETURNED')  and i.Insurancecarrierid = 270        --Returned  SELECT 'Returned' AS RecordType   ,4 AS RecordSequenceNbr   ,o.NHMemberId   ,m.MemberProfileID   ,o.STATUS   ,oi.PODate AS servicedate   ,o.PROVProviderId as ProviderID   ,CASE WHEN o.DeviceCount = 1 THEN x.MonauralHCPCSCode         WHEN o.Devic
  --exec [elig].[sp_mv_to_OPS_OTCOrderCalls_upd_CRM] '10.22-27.2020 Reships.csv'  CREATE PROCEDURE [elig].[sp_mv_to_OPS_OTCOrderCalls_upd_CRM]   @FileName varchar(50)  AS  BEGIN     update a set a.rawvcflex4 = replace(rawvcflex4,'^',',')     ,a.rawvcflex9 = replace(rawvcflex9,'^',',')     ,a.rawvcflex2 = ltrim(rtrim(rawvcflex2))   from temp.rawSTGFileLoadData a   where FileName =@FileName     delete from temp.rawSTGFileLoadData   where FileName =@FileName   and isnull(rawVCFlex2,'') =''        insert into temp.OPS_OTCOrderCalls_DlyExcel     select  distinct      filename,     ltrim(rtrim(rawvcflex1)) as Membername     ,ltrim(rtrim(rawvcflex2)) as NHMemberId     ,ltrim(rtrim(rawvcflex3)) as ORGOrderId     ,ltrim(rtrim(rawvcflex12)) as QBOrderId     ,ltrim(rtrim(rawvcflex4)) as Address1     ,ltrim(rtrim(rawvcflex5)) as city     ,ltrim(rtrim(rawvcflex6)) as State     ,ltrim(rtrim(rawvcflex7)) as ZIP     ,ltrim(rtrim(rawvcflex8)) as Reason     ,ltrim(rtrim(rawvcflex9)) as Itemdesc     ,ltrim(rtrim(rawvcflex10)) as ItemNumber     ,ltrim(rtrim(rawvcflex11)) as Quantity     ,ltrim(rtrim(rawvcflex13)) as ReportingMEA     ,ltrim(rtrim(rawvcflex14)) as ReportingDate    from temp.rawSTGFileLoadData     where 1=1    and FileName = @FileName    and recordSno not in (select min(recordSno) FROM temp.rawSTGFileLoadData where filename = @FileName)       select distinct     ltrim(rtrim(Membername)) as Membername    ,ltrim(rtrim(NHMemberId)) as NHMemberId    ,ltrim(rtrim(ORGOrderId)) as ORGOrderId    ,ltrim(rtrim(QBOrderId)) as QBOrderId      ,ltrim(rtrim(Address1)) as Address1    ,ltrim(rtrim(city)) as city    ,ltrim(rtrim(State)) as State    ,ltrim(rtrim(ZIP)) as ZIP    into  #tempOpsData   from temp.OPS_OTCOrderCalls_DlyExcel   where 1=1     update a set a.NHMemberId = b.NHMemberId, a.OrgOrderId = b.ORGOrderId   --select distinct a.NHMemberId , b.NHMemberId, a.OrgOrderId , b.ORGOrderId   from [otc].[QBCOGSDetailsByOrder] a   join #tempOpsData b on a.OrderNumber = b.QBOrderId   where 1=1    and a.NHMemberId is null    and a.IsCRMUpdateFlag is null   and cast(a.OrderDate as date) >= cast('08/19/2020' as date)      declare   @nhMemberId nvarchar(150),        @trackingNumber nvarchar(150),        @shipdate nvarchar(30),        @QBOrderId Nvarchar(20)      declare c1 CURSOR FOR    select distinct TrackingNumber,NHMemberId,     convert(varchar, shipdate, 101) shipdate    ,OrderNumber    from [otc].[QBCOGSDetailsByOrder] a    where a.CarrierName='Reship'    and a.IsCRMUpdateFlag is null    and a.TrackingNumber is not null and a.NHMemberId is not null and a.shipdate is not null and OrderNumber is not null and a.IsCRMUpdateFlag is null    and cast(a.OrderDate as date) >= cast('08/19/2020' as date)    and OrderNumber not in ('10073133','10073132','10073129')    order by OrderNumber;      open c1;    FETCH NEXT FROM c1 into @trackingNumber,@nhMemberId,@shipdate,@QBOrderId;    WHILE @@FETCH_STATUS = 0     BEGIN       --select [AgentUserProfileId],[AgentUserProfileName],[CallBound] ,[CallEndSummary],IsActive,MemberNHMemberId,CreateDate,ProcessFlag      --from [CallCenter].[CallConversations] where MemberNHMemberId = @nhMemberId;     insert into [CallCenter].[CallConversations] ([AgentUserProfileId],[AgentUserProfileName],     [CallBound] ,[CallEndSummary],IsActive,MemberNHMemberId,CreateDate,ProcessFlag)     select 1888,'SystemUser','MNT','TRACKING NUMBER:' + @trackingNumber +', SHIP DATE:' + @shipdate +', New OrderId: ' + @QBOrderId     ,1,@nhMemberId,getdate(),1       insert into [CallCenter].[CallPageEvents] (CallConversationId,CreateDate,CreateUser,EventId,IsActive)     select max(CallConversationId),getdate(),'SystemUser',420,1     from [CallCenter].[CallConversations]     where MemberNHMemberId = @nhMemberId     and [CallEndSummary] = 'TRACKING NUMBER:' + @trackingNumber +', SHIP DATE:' + @shipdate +', New OrderId: ' + @QBOrderId        update [otc].[QBCOGSDetailsByOrder] set IsCRMUpdateFlag = 1      where CarrierName='Reship'     and TrackingNumber
CREATE  PROCEDURE [elig].[sp_load_elig_stats_bkp_20201118_before_FULLJOIN] (@FileTrackID BIGINT)  AS  BEGIN   DECLARE @procedureName VARCHAR(100) = 'sp_load_elig_stats'   DECLARE @DataSource NVARCHAR(50)   DECLARE @NewMembers INTEGER   DECLARE @TerminatedMembers INTEGER   DECLARE @TermByAbsence INTEGER   DECLARE @ChangedMembers INTEGER   DECLARE @LogMessage VARCHAR(max)   DECLARE @ClientCode VARCHAR(100)   DECLARE @FileInfoID BIGINT   DECLARE @FileID BIGINT   DECLARE @fullFile INT   Declare @sql nvarchar(max)   DECLARE @stepName VARCHAR(200)   DECLARE @strNHLink VARCHAR(500)   DECLARE @STGCurrentActiveCnt int   DECLARE @STGCurrentandFutureActiveCnt int  --- Version 1.00 -- 01/6/2020 - Raj Sareddy -- New Procedure to insert stats  --- Version 1.01 -- 01/7/2020 - Raj Sareddy -- Added Carrier and Healthplan Stats  --- Version 1.02 -- 06/23/2020 - Raj/Srikanth -- Included Current and future active members in the file received     --BEGIN TRY   --BEGIN TRANSACTION sp_load_elig_stats       SET @stepName = '100 Get FileTrack Data'     EXEC elig.auditlog @ClientCode, @FileTrackID,@procedureName,@stepName,'S'      --- Get File Info from file track table for FileTrackID    SELECT @DataSource = Datasource     ,@FileInfoID = FileInfoID     ,@ClientCode = ClientCode    FROM elig.filetrack    WHERE FileTrackID = @FileTrackID         SET @strNHLink = [elig].[getLinkID](@ClientCode, 'ELIG')     SET @strNHLink = replace(@strNHLink,'mstrEligBenefitData.','')       SET @stepName = '150 NewMember Count'     EXEC elig.auditlog @ClientCode, @FileTrackID,@procedureName,@stepName,'S'      ---NEW MEMBERS    -- how about member changed and new member received in the same file    select @NewMembers = count(distinct NHLinkid) from elig.mstrEligBenefitData p1    where 1 = 1      and FileTrackId = @filetrackid      and DataSource = @datasource      and RecordStatus = 'NR'      and isactive = 1      and tobeprocessed = 'Y'      --and cast(getdate() as date) between RecordEffDate and RecordEndDate      and not exists ( select 1 from elig.mstrEligBenefitData p2          where 1 = 1            and p1.NHLinkid = p2.NHLinkid            and not (p2.FileTrackId >= @filetrackid)            and p2.DataSource = @datasource )       SET @stepName = '200 Terminated Members Count'     EXEC elig.auditlog @ClientCode, @FileTrackID,@procedureName,@stepName,'S'      ---Terminated MEMBERS    SET @SQL =    'select @x = count(distinct '+  @strNHLink + ' ) from elig.stgEligBenefitData p1    where 1 = 1      and FileTrackId = ' + cast(@filetrackid as varchar) +      ' and DataSource = ''' + @datasource +     ''' and RecordStatus not like ''ERR_%''      and RecordStatus in (''NR'',''CH'',''TR'') -- SAFTEY CHECK CONDITION -- Need this condition since we dont want NC records       and case when isdate(BenefitEndDate)=1 then cast(BenefitEndDate as date) else getdate()+1 end <= cast(getdate() as date) '      PRINT @SQL    exec sp_executesql @SQL, N'@x int out', @TerminatedMembers out       SET @stepName = '250 Term By Absence Count'     EXEC elig.auditlog @ClientCode, @FileTrackID,@procedureName,@stepName,'S'      -- Termed By Absence    select @TermByAbsence = count(distinct NHLinkid) from elig.mstrEligBenefitData p1    where 1 = 1       and DataSource = @datasource      and RecordStatus = 'TR'      and toBeProcessed = 'Y'      --and cast(ModifyDate as date) = cast(getdate() as date)      and not exists ( select 1 from elig.mstrEligBenefitData p2 --Should not have any active record for that member          where 1 = 1            and p1.NHLinkid = p2.NHLinkid            and p2.DataSource = @datasource            and p2.isActive = 1            and  cast(getdate() as date)  < BenefitEndDate   )    print @strNHLinK       SET @stepName = '300 Changed Members'     EXEC elig.auditlog @ClientCode, @FileTrackID,@procedureName,@stepName,'S'      -- Changed Members    SET @SQL =     'select @x = count(distinct '+  @strNHLink + ' ) from elig.stgEligBenefitData p1    where 1 = 1      and FileTrac
  --exec [elig].[sp_sync_master_to provider_Upd]      CREATE PROCEDURE [elig].[sp_sync_master_to provider_Upd]   AS  BEGIN       --to get EligInsCarrierIds   select distinct insCarrierID as InsuranceCarrierID,DataSource into #temp_EligInsCarrierIds   from elig.mstrEligBenefitData;     insert into #temp_EligInsCarrierIds   select 4,'ELIG_CH'   UNION   SELECT 15,'ELIG_UOM'    -- select * from #temp_EligInsCarrierIds  /*  --------------------------------------master.MemberInsurances-------------------------------------------------------   --to get active members with same healthplanid multiple effStartdate and effEndDate   with CTE as    (    select id    , InsuranceCarrierID    ,InsuranceHealthPlanID    , MemberID , InsuranceEffectiveDate as s_Date, InsuranceEndDate as e_date    ,IsActive,InsuranceType,    row_number() over(partition by InsuranceCarrierID,MemberID, InsuranceHealthPlanID, IsActive,InsuranceType order by  InsuranceEffectiveDate ) as rn    from master.MemberInsurances    where 1=1 --and memberid  IN (12340,491525)    )   select t1.*,'***' as junk     , t2.id as t2_id     ,t2.InsuranceHealthPlanID as t2_InsuranceHealthPlanID     ,t2.MemberID as t2_MemberID     , t2.s_Date as t2_s_Date     , t2.e_date as t2_e_date     ,t2.IsActive as t2_IsActive   into #temp_Mstr_MemIns_dup   from CTE t1   inner join CTE t2 on 1=1         and  t1.InsuranceCarrierID = t2.InsuranceCarrierID         and t1.InsuranceHealthPlanID = t2.InsuranceHealthPlanID         and t1.MemberID = t2.MemberID         and t1.IsActive = t2.IsActive         and t1.InsuranceType = t2.InsuranceType          and t2.rn = t1.rn +1   where t2.s_date <= t1.e_date ;     --select * from #temp_Mstr_MemIns_dup   --where InsuranceCarrierID in (select InsuranceCarrierID from #temp_EligInsCarrierIds)     --update master.MemberInsurances   update mi set --mi.InsuranceEndDate = cast(mi.InsuranceEffectiveDate as DATETIME) - 1 --Raj     mi.InsuranceEndDate = cast(x.t2_s_date as datetime) - 1    --, mi.IsActive = 0    , mi.ModifyDate = getdate()    ,mi.modifyuser = 'appuser'   from master.MemberInsurances mi   join #temp_EligInsCarrierIds ECids on ECids.InsuranceCarrierID = mi.InsuranceCarrierID --to update only elig file clients   join #temp_Mstr_MemIns_dup x on x.ID = mi.ID            and x.InsuranceCarrierID = mi.InsuranceCarrierID --no need but :)           and x.MemberID = mi.MemberID   where 1=1   --and ecids.InsuranceCarrierID = 278    -----------------------------------------END---master.MemberInsurances------------------------------------------------    ----------------------------------------[provider].[MemberInsurances]-----------------------------------------------------------   --to get active members with same healthplanid multiple effStartdate and effEndDate   with CTE as    (    select MemberInsuranceID      , InsuranceCarrierID      ,InsuranceHealthPlanID      , [MemberProfileId]       , InsuranceEffectiveDate as s_Date      , InsuranceEndDate as e_date,IsActive      ,InsuranceType      ,row_number() over(partition by InsuranceCarrierID,[MemberProfileId],InsuranceHealthPlanID,IsActive,InsuranceType  order by  InsuranceEffectiveDate ) as rn    from provider.MemberInsurances    where 1=1    --and InsuranceCarrierID = 278    )   select t1.*,'***' as junk, t2.MemberInsuranceID as t2_MemberInsuranceID         ,  t2.InsuranceHealthPlanID as t2_InsuranceHealthPlanID         ,  t2.[MemberProfileId] as t2_MemberProfileId         ,  t2.s_Date as t2_s_Date         ,  t2.e_date as t2_e_date         ,  t2.IsActive as t2_IsActive   into #temp_prov_MemIns_dup   from CTE t1   inner join CTE t2 on 1=1         and  t1.InsuranceCarrierID = t2.InsuranceCarrierID         and t1.InsuranceHealthPlanID = t2.InsuranceHealthPlanID         and t1.MemberProfileId = t2.MemberProfileId         and t1.InsuranceType = t2.InsuranceType         and t1.IsActive = t2.IsActive         and t2.rn = t1.rn +1   where t2.s_date <= t1.e_date ;     --select * from #temp_prov_MemIns_dup   --where Insura
      -- EXEC [elig].[sp_elig_load_stg_to_elig] 3892    CREATE PROCEDURE [elig].[sp_elig_load_stg_to_elig] (@FileTrackID BIGINT)  --- Version 1.0  --           - Mohan Bekkary -- New Procedure  --- Version 1.00 -- 01/01/2020 - Raj/ Srikanth -- Error Handling & Audit Log, Changed Phone Nbrs to varchar,   --- Version 1.01 -- 01/06/2020 - Raj Sareddy   -- Changed Error type to be ERR_,   --- Version 1.02 -- 01/07/2020 - Raj/ Srikanth -- Dates check and change to UTC datetime issue  --- Version 1.03 -- 01/07/2020 - Raj Sareddy   -- Added Stats Procedure  --- Version 1.04 -- 06/23/2020 - Raj/Srikanth -- Excluding RecordStatus like ERR  AS  DECLARE @procedureName VARCHAR(100) = 'sp_elig_load_stg_to_elig'  DECLARE @strWhereClause VARCHAR(max)   DECLARE @strChangeClause VARCHAR(max)  DECLARE @strCrossWalkWhereClause VARCHAR(max)  DECLARE @strNHLink VARCHAR(500)  DECLARE @sql VARCHAR(max)  DECLARE @statusFlag NVARCHAR(10) = 'N'  DECLARE @dataSource NVARCHAR(50)  DECLARE @NewRecordCount INTEGER  DECLARE @RecordsProcessed INTEGER  DECLARE @ErrorRecordCount INTEGER  DECLARE @ChangeRecordCount INTEGER  DECLARE @DropRecordCount INTEGER  DECLARE @NoChangeRecordCount INTEGER  DECLARE @LogMessage VARCHAR(max)  DECLARE @UserName VARCHAR(100) = SUSER_SNAME()  DECLARE @ClientCode VARCHAR(100)  DECLARE @FileType VARCHAR(100)  DECLARE @SnapShot VARCHAR(100)  DECLARE @FileInfoID BIGINT  DECLARE @FileID BIGINT  DECLARE @fullFile INT  DECLARE @stepName VARCHAR(200);  declare @fileTrackStatusCode varchar(20)  BEGIN   BEGIN TRY   BEGIN TRANSACTION elig_load_stg_to_elig     --- Get File Info from file track table for FileTrackID   SELECT @dataSource = Datasource    ,@snapshot = Snapshotflag    ,@FileInfoID = FileInfoID    ,@ClientCode = ClientCode    ,@FileType = FileType    ,@fileTrackStatusCode = StatusCode   FROM elig.filetrack   WHERE FileTrackID = @FileTrackID   --DONE --- RAJ added status code if status code not found then log saying no data found     if isnull(@fileTrackStatusCode,'999') <> '300'   begin    print('no file')    Return 0   end      PRINT (@ClientCode)   PRINT (@FileType)   PRINT (@FileTrackId)     SET @stepName = '110 Update BenefitEndDate'   EXEC elig.auditlog @ClientCode, @FileTrackID,@procedureName,@stepName,'S'     update elig.stgEligBenefitData    set BenefitEndDate = '20991231'   where FileTrackID = @FileTrackID   and isnull(BenefitEndDate,'') = ''     EXEC elig.auditlog @ClientCode, @FileTrackID,@procedureName,@stepName,'S'        IF @snapshot = 'FULL'    SET @fullFile = 1   ELSE    SET @fullFile = 0    --LATER LOW Priority RAJ MAY be move all clauses to one priority low   --- Get Mandatory Where condition between Stage and Master tales.   SET @strWhereClause = [elig].[getEligWhereClause](@ClientCode, @FileType)   PRINT @strWhereClause     --- Get Change fileds comparison between stage and elig master table   SET @strChangeClause = [elig].[getEligChangeClause](@ClientCode, @FileType)   --- Get CrossWalk Where condition between Stage and Master tales.   SET @strCrossWalkWhereClause = [elig].[getCrossWalkWhereClause](@ClientCode, @FileType)   SET @strNHLink = [elig].[getLinkID](@ClientCode, @FileType)        -- Validate for Span Errors in Stage Table   --BEGIN TRY    DECLARE @RC INT     SET @stepName = '120 Duplicate Check'   EXEC elig.auditlog @ClientCode, @FileTrackID,@procedureName,@stepName,'S'      EXECUTE @RC = [elig].[sp_elig_validate_duplicate_stage_data] @ClientCode     ,@FileType     ,@FileTrackID     SET @stepName = '130 OlD SPAN Check'   EXEC elig.auditlog @ClientCode, @FileTrackID,@procedureName,@stepName,'S'      EXECUTE @RC = [elig].[sp_elig_validate_oldspan_stage_data] @ClientCode     ,@FileType     ,@FileTrackID     SET @stepName = '160 Validate Other Stage Data'   EXEC elig.auditlog @ClientCode, @FileTrackID,@procedureName,@stepName,'S'      -- Validate data in stage for any data errors    EXECUTE @RC = [elig].[sp_elig_validate_stage_data] @ClientCode     ,@FileType     ,@FileTrackId     SET @stepName = '150 S
  -- EXEC [elig].[elig_file_load_ssis_sp_merge_HAP] 'HAP'    CREATE PROCEDURE [elig].[elig_file_load_ssis_sp_merge_HAP]   @Client_Name varchar(20)  AS    BEGIN     BEGIN TRY   BEGIN TRANSACTION member_load_elig_HAP        EXEC [elig].[elig_file_load_ssis_sp_merge_stg_to_elig_HAP]      EXEC [elig].[elig_file_load_ssis_sp_merge_elig_HAP_to_master]     COMMIT TRANSACTION member_load_elig_HAP   PRINT 'SUCCESS'        END TRY        BEGIN CATCH     DECLARE @ErrorMessage NVARCHAR(4000);        DECLARE @ErrorSeverity INT;        DECLARE @ErrorState INT;          SELECT             @ErrorMessage = ERROR_MESSAGE(),            @ErrorSeverity = ERROR_SEVERITY(),            @ErrorState = ERROR_STATE();        IF (@@TRANCOUNT > 0)    BEGIN     ROLLBACK TRANSACTION member_load_elig_HAP     RAISERROR(@ErrorMessage,@ErrorSeverity,@ErrorState);     PRINT 'FAILED'    END     END CATCH  END
    --exec [elig].[sp_BCBSRI_Encounter_file] 270  CREATE PROCEDURE [elig].[sp_BCBSRI_Encounter_file]   @CarrierID int --270 for bcbsri  AS  BEGIN      select 0 as fororder, 'Header' as fororderdesc,'H' as nhmemberid,getdate() as serviceDate,  'H' +'|'+'TransactionID' +'|'+ 'LineSequenceNbr' +'|'+ 'ClaimStatus' +'|'+ 'NHMemberID' +'|'+   'PolicyNbr' +'|'+ 'GroupNbr' +'|'+ 'MemberFirstName' +'|'+'MemberMiddleInitial' +'|'+   'MemberLastName' +'|'+ 'DateofBirth' +'|'+ 'PhoneNbr' +'|'+ 'DateofService' +'|'+   'ReturnDate' +'|'+'PlaceofService' +'|'+ 'ICD10Code' +'|'+ 'HCPCSCode' +'|'+ 'HCPCSCodeDescription' +'|'+  'Units' +'|'+ 'Modifier' +'|'+'HCPNPINumber' +'|'+   'RenderingProviderFirstName' +'|'+ 'RenderingProviderLastName' +'|'+   'LocationAddress1' +'|'+ 'LocationAddress2' +'|'+ 'LocationCity' +'|'+   'LocationState' +'|'+ 'LocationZipCode' +'|'+ 'OrganizationNPI' +'|'+  'BillingNPI' +'|'+ 'BillingTaxID' +'|'+ 'ChargeAmt' +'|'+ 'CopayAmt' +'|'+   'BenefitAmt' +'|'+ 'MemberPaidAmt' +'|'+ 'ClaimPaidAmt' +'|'+'ParticipatingProvider' +'|'+   'CoinsuranceAmt' +'|'+ 'CoinsurancePercent' +'|'+'NoncoveredAmt' +'|'+   'ClaimReceivedDate'+'|'+'ClaimPaidDate'+'|'+ 'FileDate'    as Outputtext  union  select 1 as fororder, 'Data' as fororderdesc,a.NHMemberID as nhmemberid,a.DateofService,  LEFT(isnull(a.RecordType,''),1)  +'|'+ cast(a.TransactionID as varchar(10)) -- 'TransactionID'   +'|'+ cast(a.LineSequenceNbr as varchar(10))-- 'LineSequenceNbr'   +'|'+ LEFT(isnull(a.ClaimStatus,''),15) -- ClaimStatus    +'|'+  LEFT(isnull(a.NHMemberId,''),30) --'NHMemberID'   +'|'+ LEFT(isnull(a.PolicyNbr,''),20)  -- 'PolicyNbr'   +'|'+ LEFT(isnull(a.GroupNbr,''),20) --'GroupNbr'   +'|'+ LEFT(isnull(a.MemberFirstName,''),30) --'MemberFirstName'   +'|'+ LEFT(isnull(a.MemberMiddleInitial,''),1) --'MemberMiddleInitial'   +'|'+ LEFT(isnull(a.MemberLastName,''),30) --'MemberLastName'   +'|'+ left(convert(varchar,cast(a.DateOfBirth as date), 112),8) --'DateofBirth'  +'|'+ cast(isnull(a.PhoneNbr,'') as varchar(10)) --'PhoneNbr'  +'|'+ isnull(left(convert(varchar,cast(a.DateofService as date), 112),8),'') --'DateofService'   +'|'+ case when a.ReturnDate = '' then '' else isnull(left(convert(varchar,cast(a.ReturnDate as date), 112),8),'') end-- 'ReturnDate'   +'|'+ LEFT(isnull(a.PlaceofService,'') ,2) --'PlaceofService'   +'|'+  LEFT(isnull(a.ICD10Code,'') ,10) --'ICD10Code'   +'|'+ LEFT(isnull(a.HCPCSCode,''),10) --'HCPCSCode'   +'|'+ LEFT(isnull(a.HCPCSCodeDescription,''),50) -- 'HCPCSCodeDescription'   +'|'+ cast(isnull(a.Units,'') as varchar(10)) --'Units'   +'|'+ LEFT(isnull(a.Modifier,''),2) -- 'Modifier' ????  +'|'+ cast(isnull(a.HCPNPINumber,'') as varchar(10)) --'HCPNPINumber'   +'|'+ LEFT(isnull(a.RenderingProviderFirstName,''),30) --'RenderingProviderFirstName'   +'|'+ LEFT(isnull(a.RenderingProviderLastName,''),30) -- 'RenderingProviderLastName'   +'|'+ LEFT(isnull(a.LocationAddress1,''),100) -- 'LocationAddress1'   +'|'+  LEFT(isnull(a.LocationAddress2,''),50) --'LocationAddress2'   +'|'+ LEFT(isnull(a.LocationCity,''),50) -- 'LocationCity'   +'|'+ LEFT(isnull(a.LocationState,''),50) -- 'LocationState'   +'|'+  isnull(a.LocationZipCode,'') --'LocationZipCode'   +'|'+ cast(isnull(a.OrganizationNPI,'') as varchar(10)) --'OrganizationNPI'   +'|'+ cast(isnull(a.BillingNPI,'') as varchar(10)) --'BillingNPI'   +'|'+  LEFT(isnull(a.BillingTaxID,''),20) --'BillingTaxID'   +'|'+ cast(isnull(nullif(a.ChargeAmt,''),0) as varchar(10)) --'ChargeAmt'   +'|'+cast(isnull(nullif(a.CopayAmt,''),0) as varchar(10)) --'CopayAmt' ???  +'|'+ cast(isnull(nullif(a.BenefitAmt,''),0) as varchar(10)) --'BenefitAmt'   +'|'+ cast(isnull(nullif(a.MemberPaidAmt,''),0) as varchar(10)) --'MemberPaidAmt'   +'|'+ cast(isnull(nullif(a.ClaimPaidAmt,''),0) as varchar(10)) --'ClaimPaidAmt'  ???  +'|'+ LEFT(isnull(a.ParticipatingProvider,''),3) --'ParticipatingProvider' ??  +'|'+cast(isnull(nullif(a.CoinsuranceAmt,''),0) as varchar(10)) --'CoinsuranceAmt' ??  +'|'+LEFT(isnull(nullif(a.C
  -- exec [elig].[sp_Elig_TBA_Response_File] 5404  CREATE PROCEDURE [elig].[sp_Elig_TBA_Response_File]   @FileTrackId int  AS  begin  SET FMTONLY OFF    SET NOCOUNT ON    declare @sqlstr nvarchar(max),    @sqlstr2 nvarchar(max),    @ClientColumns nvarchar(max),    @mstrtableColumns nvarchar(max),          @isHeaderflag bit,    @ClientCode VARCHAR(20),    @FileInfoID VARCHAR(20),    @delimiter varchar(1)        -- Temp    --set @FileTrackId = 4231    select   @isHeaderflag = fi.IsHeaderRecord    ,@FileInfoID = ft.FileInfoID    ,@ClientCode = ft.ClientCode    ,@delimiter = case when isnull(fi.FileFormatValue,'') = '' then '|'         when isnumeric(fi.FileFormatValue) = 1  then '|' else  fi.FileFormatValue end   from elig.FileInfo fi  join elig.FileTrack ft on fi.FileInfoID = ft.FileInfoID and ft.ClientCode = fi.ClientCode  where 1=1  and ft.FileTrackID = @FileTrackId    create table #temp2 (fororder int, outputText varchar(max))    SELECT DISTINCT     SUBSTRING(          (              SELECT  @delimiter + ST1.ClientColumn AS [text()]              FROM [elig].[EligibilityColumnValidation] ST1              WHERE st1.TBARptFlag >= 1     and ST1.ClientCode = ST2.ClientCode --and ST1.ID = ST2.ID              ORDER BY ST1.TBARptFlag,ST1.ID              FOR XML PATH ('')          ), 2, 8000)  [ClientColumns],   SUBSTRING(          (              SELECT '+'+char(39)+@delimiter+char(39)+''+      case when substring(ST3.TargetColumn,1,6) = 'DTFlex' then '+ convert(varchar(8),cast(m.' + ST3.TargetColumn +' as date),112)' else +                      '+ isnull(cast(m.'+ ST3.TargetColumn +' as nvarchar(100)),' +char(39)+char(39)+')' end  AS [text()]              FROM [elig].[EligibilityColumnValidation] ST3              WHERE st3.TBARptFlag >= 1     and ST3.ClientCode = ST2.ClientCode --and ST1.ID = ST2.ID              ORDER BY ST3.TBARptFlag,ST3.ID              FOR XML PATH ('')          ), 6, 8000)  [TargetColumns]    into #temp  FROM [elig].[EligibilityColumnValidation] ST2  where 1=1  and ST2.ClientCode = @ClientCode  and ST2.FileType = 'ELIG'  and st2.TBARptFlag >= 1    --SELECT * FROM #TEMP    select @ClientColumns = ClientColumns  ,      @mstrtableColumns = TargetColumns   from #temp  where 1=1    insert into #temp2 select 1, 'Description|'+ @ClientColumns    --select 'sujay',@ClientColumns,@mstrtableColumns          set @sqlstr = 'insert into #temp2     select distinct 2, ''Terminated By Absence'' +' +char(39)+@delimiter+char(39)+'+' + @mstrtableColumns + '       from elig.tbaEligBenefitData e      join elig.mstrEligBenefitData m on e.mstrEligID = m.mstrEligID    where 1=1      and e.FileTrackID = ' + cast(@FileTrackId as varchar)    --  select @sqlstr    EXEC sp_executesql @sqlstr       set @sqlstr2 ='select fororder,cast(LTRIM(RTRIM(outputText)) as varchar(max)) as outputText    from #temp2    where 1=1    order by fororder'        EXEC sp_executesql @sqlstr2    WITH RESULT SETS    (     (     fororder int,     outputText NVARCHAR(max)     )    )    drop table #temp  drop table #temp2  --exec elig.sp_Elig_Error_Response_File 0  --exec elig.sp_Elig_Error_Response_File 10  end    
  CREATE FUNCTION [elig].[UTCToTimeZoneGetdate] (@InDatetime datetime, @timezone varchar(3))  RETURNS datetime  AS  BEGIN  Declare @RDateTime datetime;    if @timezone = 'EST'  begin     SELECT @RDateTime = CAST(@InDatetime AT TIME ZONE 'UTC'   AT TIME ZONE 'Eastern Standard Time' AS DATETIME);  end    if @timezone = 'CST'  begin     SELECT @RDateTime = CAST(@InDatetime AT TIME ZONE 'UTC'   AT TIME ZONE 'Central Standard Time' AS DATETIME);  end    if @timezone = 'PST'  begin     SELECT @RDateTime = CAST(@InDatetime AT TIME ZONE 'UTC'   AT TIME ZONE 'Pacific Standard Time' AS DATETIME);  end    if @timezone = 'MST'  begin     SELECT @RDateTime = CAST(@InDatetime AT TIME ZONE 'UTC'   AT TIME ZONE 'Mountain Standard Time' AS DATETIME);  end      RETURN @RDateTime    END  
  CREATE FUNCTION [elig].[fnSplitString]  (      @string NVARCHAR(MAX),      @delimiter CHAR(1)  )  RETURNS @output TABLE(splitid int, splitdata NVARCHAR(MAX)  )  BEGIN      DECLARE @start INT, @end INT, @counter int   set @counter = 0      SELECT @start = 1, @end = CHARINDEX(@delimiter, @string)      WHILE @start < LEN(@string) + 1    BEGIN          IF @end = 0              SET @end = LEN(@string) + 1    set @counter = @counter + 1              INSERT INTO @output (splitid,splitdata)          VALUES(@counter, SUBSTRING(@string, @start, @end - @start))          SET @start = @end + 1          SET @end = CHARINDEX(@delimiter, @string, @start)               END      RETURN  END  
CREATE FUNCTION [elig].[CountOccurrencesOfString]  (      @searchString nvarchar(max),      @searchTerm nvarchar(max)  )  RETURNS INT  AS  BEGIN      return (LEN(@searchString)-LEN(REPLACE(@searchString,@searchTerm,'')))/LEN(@searchTerm)  END  
  CREATE  PROCEDURE [elig].[sp_load_elig_to_crm] (@FileTrackID BIGINT)  AS  --- Version 1.00 -- 12/30/2019 - Raj Sareddy     -- New Procedure  --- Version 1.00 -- 01/01/2020 - Raj/ Srikanth   -- Validations and changes  --- Version 1.01 -- 01/07/2020 - Srikanth D      -- UPdated to be be processed to P  --- Version 1.02 -- 09/25/2020 - Raj/Srikanth/Sujay      -- UPdated not to update TR records enddate if they came back active again  --- Version 1.03 -- 12/04/2020 -- Sujay   -- Changes to introduce multiple files for same client  -- exec [elig].[sp_load_elig_to_crm] 915    BEGIN   DECLARE  @procedureName VARCHAR(100) = 'sp_load_elig_to_crm'     ,@sys_user CHAR(30)     ,@sys_date DATETIME     ,@DataSource NVARCHAR(50)     ,@MasterDataSource NVARCHAR(50)     ,@NewRecordCount INTEGER     ,@RecordsProcessed INTEGER     ,@ErrorRecordCount INTEGER     ,@ChangeRecordCount INTEGER     ,@DropRecordCount INTEGER     ,@NoChangeRecordCount INTEGER     ,@LogMessage VARCHAR(max)     ,@UserName VARCHAR(100) = SUSER_SNAME()     ,@ClientCode VARCHAR(100)     ,@FileInfoID BIGINT     ,@FileID BIGINT     ,@fullFile INT     ,@sql varchar(max)     ,@stepName VARCHAR(200)     ,@Snapshot varchar(20);     --,@IsThresholdCheck varchar(1)     --,@ThresholdValue varchar(20);   --- Version 1.0 -- Raj 1/1/2020     BEGIN TRY   BEGIN TRANSACTION sp_load_elig_to_crm        --- Get File Info from file track table for FileTrackID    /*    SELECT @DataSource = Datasource     ,@FileInfoID = FileInfoID     ,@ClientCode = ClientCode    FROM elig.filetrack    WHERE FileTrackID = @FileTrackID    */    SELECT @MasterDataSource = fi.MasterDataSource          , @DataSource = ft.Datasource     ,  @FileInfoID = ft.FileInfoID     ,  @ClientCode = ft.ClientCode     ,  @Snapshot = ft.SnapshotFlag     --, @IsThresholdCheck = fi.IsThresholdCheck     --, @ThresholdValue = fi.ThresholdValue    FROM elig.filetrack ft    join elig.FileInfo fi on ft.ClientCode = fi.ClientCode          and ft.FileType = fi.FileType         and ft.SnapshotFlag = fi.SnapshotFlag    WHERE ft.FileTrackID = @FileTrackID    /*    if @Snapshot ='FULL' and @IsThresholdCheck = 'Y'    begin     select filetrackid      ,sum(case when RecordStatus = 'ERR_DUP' then 1 else 0 end) as ERR_DUP      ,sum(case when RecordStatus = 'ERR_SPAN' then 1 else 0 end) as ERR_SPAN      ,sum(case when RecordStatus = 'ERR_XWALK' then 1 else 0 end) as ERR_XWALK      ,sum(case when RecordStatus = 'ERR_REC' then 1 else 0 end) as ERR_REC      ,sum(case when RecordStatus = 'ERR_OLDSPAN' then 1 else 0 end) as ERR_OLDSPAN      into #TempRecordCnt     from elig.errEligBenefitData     where 1 = 1     and filetrackid = @FileTrackID     group by filetrackid        select *      ,total = ERR_DUP + ERR_SPAN + ERR_XWALK + ERR_REC + ERR_OLDSPAN     from #TempRecordCnt       drop table #TempRecordCnt    end    */     SET @stepName = '100 Update MasterMemberId in same table'     EXEC elig.auditlog @ClientCode, @FileTrackID,@procedureName,@stepName,'S'      -- getting mastermemberid for the records where the member exists in the elig tables before with same NHLInkID     update t set t.MasterMemberID = x.MasterMemberID     from elig.mstrEligBenefitData t     join ( select NHLinkid, max(MasterMemberID) MasterMemberID       from elig.mstrEligBenefitData       where 1 = 1       and DataSource in (select datasource from elig.clientcodes where masterdatasource = @MasterDataSource)       and masterMemberID is not null       group by NHLinkid        ) x on t.NHLinkid = x.NHLinkid      where 1 = 1     and t.FileTrackId = @FileTrackID     and t.masterMemberID is null     and t.toBeProcessed = 'Y'       SET @stepName = '110 Insert into Master.Members - New Members'     EXEC elig.auditlog @ClientCode, @FileTrackID,@procedureName,@stepName,'S'       -- Inserting into members where the member change in as new for the first time     INSERT INTO master.members (           FirstName           ,MiddleInitial           ,LastName           ,DateOfBirth           ,Gen
-- exec [elig].[sp_Elig_Audit_Response_File]  17    CREATE PROCEDURE [elig].[sp_Elig_Audit_Response_File]   @FileTrackId int  AS    declare @maxFileNamelength int    --select @maxFileNamelength = max(len(isnull(ack.filename,ft.filename))) + 1   select @maxFileNamelength = max(len(ft.filename)) + 1   from elig.filetrack ft  --join elig.fileinfo fi on ft.FileInfoID = fi.FileInfoId  --left join ( select filename ,clientcode,snapshotflag,fromlocation,tolocation,isAckFileToFTP,FileExtension as STATFileExtension  --            from elig.fileinfo  --            where 1=1  --            and filetype = 'ELIG_ACK'  --            and direction = 'OUT'  --            and isAckFileToFTP = 'Y'  --) ack on fi.clientcode = ack.clientcode and fi.snapshotflag = ack.snapshotflag  where 1=1  and FileTrackID = @FileTrackId    select 1 as fororder, 'File_Date |'+ LEFT('Source File_Name'+space(@maxFileNamelength),@maxFileNamelength)  +'|Records_Received|Records_Processed|Records_NotProcessed' as outputText  union  select 2, LEFT(ISNULL(convert(varchar(10),CAST(DateReceived AT TIME ZONE 'UTC'   AT TIME ZONE 'Eastern Standard Time' AS DATE),126),'')+space(10),10)  + '|' +                LEFT(ISNULL(FileName,'')+space(@maxFileNamelength),@maxFileNamelength) + '|' +               left(isnull(cast(isnull(RecordsReceived,0) as varchar(10)),'')+space(16),16) + '|' +               left(isnull(cast(isnull(recordsprocessed,0) as varchar(10)),'')+space(17),17) + '|' +               left(isnull(cast(isnull(RecordsErrored,0) as varchar(10)),'')+space(20),20)   from elig.FileTrack  where 1=1  and FileTrackID = @FileTrackId  --and StatusCode = 400  order by 1    --exec sp_Elig_Audit_Response_File 'H223','ELIG','FULL'  
CREATE PROCEDURE [elig].[sp_Elig_Audit_Response_File]   @FileTrackId int  AS    declare @maxFileNamelength int    select @maxFileNamelength = max(len(isnull(ack.filename,ft.filename))) + 1   from elig.filetrack ft  join elig.fileinfo fi on ft.FileInfoID = fi.FileInfoId  left join ( select filename ,clientcode,snapshotflag,fromlocation,tolocation,isAckFileToFTP,FileExtension as STATFileExtension              from elig.fileinfo              where 1=1              and filetype = 'ELIG_ACK'              and direction = 'OUT'              and isAckFileToFTP = 'Y'  ) ack on fi.clientcode = ack.clientcode and fi.snapshotflag = ack.snapshotflag  where 1=1  and FileTrackID = @FileTrackId    select 1 as fororder, 'File_Date |'+ LEFT('Source File_Name'+space(@maxFileNamelength),@maxFileNamelength)  +'|Records_Received|Records_Processed|Records_NotProcessed' as outputText  union  select 2, LEFT(ISNULL(convert(varchar(10),CAST(DateReceived AT TIME ZONE 'UTC'   AT TIME ZONE 'Eastern Standard Time' AS DATE),101),'')+space(10),10)  + '|' +                LEFT(ISNULL(FileName,'')+space(@maxFileNamelength),@maxFileNamelength) + '|' +               left(isnull(cast(isnull(RecordsReceived,0) as varchar(10)),'')+space(16),16) + '|' +               left(isnull(cast(isnull(recordsprocessed,0) as varchar(10)),'')+space(17),17) + '|' +               left(isnull(cast(isnull(RecordsErrored,0) as varchar(10)),'')+space(20),20)   from elig.FileTrack  where 1=1  and FileTrackID = @FileTrackId  --and StatusCode = 400  order by 1    --exec sp_Elig_Audit_Response_File 'H223','ELIG','FULL'  
    --exec [elig].[sp_OTC_API_callinfo_pop]   CREATE PROCEDURE [elig].[sp_OTC_API_callinfo_pop]   AS  BEGIN      create table #temp (id varchar(100),refid varchar(100))    insert into #temp  select id, refid  from logs.httpmessages with (NOLOCK)  where 1=1  and CreateDate >= getdate() - 10;    --and id in (  --'DD2CE3EB-5490-4B6F-A0D3-CD4E99A04F5A',  --'7148C661-977D-4E14-B081-DB08421FDACA',  --'1A47B23C-B978-440C-8B16-DD84FFF36D7F',  --'4F05F695-0EE1-4044-8A35-57220A67B93A',  --'EE3DB979-B109-4E0B-BB24-FAC17A6566E3',  --'3885B8D4-D3B4-4156-8EBC-D190ED0DD993',  --'36C8284B-02DA-42D8-A7FC-94D7770D052F',  --'17099FFC-8AB6-4491-B7C8-4186E1254781',  --'D4C144FB-AD61-4E78-9CB1-68920C592CB9',  --'4E8A6362-303C-4815-8458-1BF3882BFA63',  --'E451D6E8-D8A4-43EB-BCFB-030F1B5F078F',  --'C49BA185-AB6E-46ED-B8F3-EE35FCD8CCF8',  --'806BAB56-B483-481E-A70F-A90F3801E416',  --'4B468372-EE73-4F0A-BA51-134C3162D119');    create nonCLUSTERED  index tidx_id_refid_5 on #temp (refid)    --select a.*  --from #temp a  --join temp.IncommApiCallInfo b on a.refid = b.refid    delete a  from #temp a  join temp.IncommApiCallInfo b on a.refid = b.refid;    create table #temp_req_incomm_tran_api (            id    varchar(100)           ,refid   varchar(100)           ,createdatetime datetime           ,createddate date           ,client   varchar(60)           ,type   varchar(20)           ,statuscode  int           ,uri   varchar(200)           ,content  varchar(8000)           )  create nonCLUSTERED  index tidx_id_refid_1 on #temp_req_incomm_tran_api (id, refid)    create table #temp_req_NOTC_Ext_api  (           sqno   bigint           ,id    varchar(100)           ,refid   varchar(100)           ,createdatetime datetime           ,createddate date           ,client   varchar(60)           ,type   varchar(20)           ,cardnumber  varchar(20)           ,statuscode  int           ,uri   varchar(200)           ,content  varchar(8000)           )    create index tidx_cardnumber on #temp_req_NOTC_Ext_api (cardnumber)  create nonCLUSTERED  index tidx_id_refid_2 on #temp_req_NOTC_Ext_api (id, refid)    create table #temp_resp_incomm_tran_api (            id    varchar(100)           ,refid   varchar(100)           ,createdatetime datetime           ,createddate date           ,client   varchar(60)           ,type   varchar(20)           ,statuscode  int           ,uri   varchar(200)           ,content  nvarchar(max)           )  create nonCLUSTERED  index tidx_id_refid_3 on #temp_resp_incomm_tran_api (id, refid)    create table #temp_resp_NOTC_Ext_api (            id    varchar(100)           ,refid   varchar(100)           ,createdatetime datetime           ,createddate date           ,client   varchar(60)           ,type   varchar(20)           ,statuscode  int           ,uri   varchar(200)           ,content  nvarchar(max)           )  create nonCLUSTERED  index tidx_id_refid_4 on #temp_resp_NOTC_Ext_api (id, refid)    declare  @id varchar(100)     ,@type varchar(20)    ,@client varchar(30)    ,@junkcntr  int;      set @junkcntr = 0;    DECLARE cursor_name CURSOR For       select cast(a.id as varchar(100)) id, ltrim(rtrim(a.Type)) Type, ltrim(rtrim(a.Client)) Client       from logs.httpmessages a        join #temp b on a.id = b.id       where 1=1;      OPEN cursor_name;    FETCH NEXT FROM cursor_name INTO @id,@type,@client;    WHILE @@FETCH_STATUS = 0      BEGIN     if @type ='Request' and @client ='NationsOTC External API'     begin      insert into #temp_req_NOTC_Ext_api (id,refid,createdatetime,createddate,client,type,statuscode,uri--,content      ,cardnumber)      select id,RefId,CreateDate      ,CAST(createdate AT TIME ZONE 'UTC'   AT TIME ZONE 'Eastern Standard Time' AS DATE)      ,Client,Type,StatusCode,uri,--substring(ltrim(rtrim(Content)),1,8000) as content,      case when isjson(Content) = 1 then JSON_VALUE(Content, '$.cardNumber') end cardNumber      from logs.HttpMessages where id = @id      end     if @type ='Request' and @client ='InComm Trans
    CREATE  PROCEDURE [elig].[sp_load_elig_to_crm_bkupon12072020] (@FileTrackID BIGINT)  AS  --- Version 1.00 -- 12/30/2019 - Raj Sareddy     -- New Procedure  --- Version 1.00 -- 01/01/2020 - Raj/ Srikanth   -- Validations and changes  --- Version 1.01 -- 01/07/2020 - Srikanth D      -- UPdated to be be processed to P  --- Version 1.02 -- 09/25/2020 - Raj/Srikanth/Sujay      -- UPdated not to update TR records enddate if they came back active again    -- exec [elig].[sp_load_elig_to_crm] 915    BEGIN   DECLARE @procedureName VARCHAR(100) = 'sp_load_elig_to_crm'   DECLARE @sys_user CHAR(30)    ,@sys_date DATETIME;   DECLARE @DataSource NVARCHAR(50)   DECLARE @NewRecordCount INTEGER   DECLARE @RecordsProcessed INTEGER   DECLARE @ErrorRecordCount INTEGER   DECLARE @ChangeRecordCount INTEGER   DECLARE @DropRecordCount INTEGER   DECLARE @NoChangeRecordCount INTEGER   DECLARE @LogMessage VARCHAR(max)   DECLARE @UserName VARCHAR(100) = SUSER_SNAME()   DECLARE @ClientCode VARCHAR(100)   DECLARE @FileInfoID BIGINT   DECLARE @FileID BIGINT   DECLARE @fullFile INT   Declare @sql varchar(max)   DECLARE @stepName VARCHAR(200);   --- Version 1.0 -- Raj 1/1/2020     BEGIN TRY   BEGIN TRANSACTION sp_load_elig_to_crm        --- Get File Info from file track table for FileTrackID    SELECT @DataSource = Datasource     ,@FileInfoID = FileInfoID     ,@ClientCode = ClientCode    FROM elig.filetrack    WHERE FileTrackID = @FileTrackID       SET @stepName = '100 Update MasterMemberId in same table'     EXEC elig.auditlog @ClientCode, @FileTrackID,@procedureName,@stepName,'S'      -- getting mastermemberid for the records where the member exists in the elig tables before with same NHLInkID    update t    set t.masterMemberID = (select max(s.MasterMemberID) MasterMemberID from (            select distinct NHLinkid, MasterMemberID from elig.mstrEligBenefitData            where 1 = 1            and DataSource = @DataSource            and masterMemberID is not null                ) s where s.NHLinkid = t.NHLinkid)     from elig.mstrEligBenefitData t     where 1 = 1     and FileTrackId = @FileTrackID     and masterMemberID is null     and toBeProcessed = 'Y'       SET @stepName = '110 Insert into Master.Members - New Members'     EXEC elig.auditlog @ClientCode, @FileTrackID,@procedureName,@stepName,'S'       -- Inserting into members where the member change in as new for the first time     INSERT INTO master.members (      FirstName      ,MiddleInitial      ,LastName      ,DateOfBirth      ,Gender      ,IsActive      ,NHMemberID      ,NHLinkID      ,DataSource      ,CreateDate      ,Createuser      ,ModifyDate      ,ModifyUser      )       SELECT FirstName      ,MiddleInitial      ,LastName      ,DOB      ,Gender      ,isactive      ,'ELIG' + convert(VARCHAR, NEXT VALUE FOR [elig].[NHMemberIDSeq]) NHMemberID --  temp value later will be updated to what ever it should be      ,NHLinkID      ,DataSource      ,getdate()      ,system_user      ,getdate()      ,system_user      from (        SELECT DISTINCT FirstName         ,MiddleInitial         ,LastName         ,DOB         ,Gender         ,1 isactive         ,NHLinkID         ,DataSource        FROM elig.mstrEligBenefitData eligEBD        WHERE 1 = 1         AND FileTrackId = @FileTrackID         AND tobeprocessed = 'Y'         AND MasterMemberID IS NULL       ) a      -- update NHMember back to what it should be before for unique key it was updated to ELIG ....     SET @stepName = '120 Update NHMemberID in Master Members'     EXEC elig.auditlog @ClientCode, @FileTrackID,@procedureName,@stepName,'S'     UPDATE [Master].[Members]    SET nhmemberid = 'NH' + RIGHT(YEAR(GETDATE()+7), 4) + FORMAT(memberid, '00000000') --    'NH2018'+ FORMAT(memberid,'00000000')    WHERE 1 = 1    AND DataSource = @dataSource    AND nhmemberid Like 'ELIG%'       SET @stepName = '130 Update Mastermember in elig.mstr for new members'     EXEC elig.auditlog @ClientCode, @FileTrackID,@procedureName,@stepName,'S'      -- update mast
    --exec [elig].[sp_move_rawEligTostgElig] 'H376',null,811  CREATE PROCEDURE [elig].[sp_move_rawEligTostgElig_bkupon12072020]   @ClientCode varchar(20),  @FileInfoId  bigint, --Not used replaced by clientcode  @FileTrackId bigint  AS  BEGIN    declare @sqlstr nvarchar(max),          @sqlstr2 nvarchar(max),    @rawTableColumns nvarchar(max),    @stgtableColumns nvarchar(max),    @stgtablename varchar(50),    @FileType varchar(30),          @isHeaderflag bit,          @recordSno int      select @isHeaderflag = fi.IsHeaderRecord  from elig.FileInfo fi  join elig.FileTrack ft on fi.FileInfoID = ft.FileInfoID and ft.ClientCode = fi.ClientCode  where 1=1  and ft.FileTrackID = @FileTrackId      delete from elig.stgEligBenefitData  where 1=1  and FileTrackId = @FileTrackId    delete from elig.stgIncommCardStatusData  where 1=1  and FileTrackId = @FileTrackId    SELECT DISTINCT     SUBSTRING(          (              SELECT ',r.'+ST1.rawtableColumn  AS [text()]              FROM [elig].[EligibilityColumnValidation] ST1              WHERE ST1.ClientCode = ST2.ClientCode --and ST1.ID = ST2.ID              ORDER BY ST1.ID              FOR XML PATH ('')          ), 2, 8000) [rawTableColumns],   SUBSTRING(          (              SELECT ','+ST3.SourceColumn  AS [text()]              FROM [elig].[EligibilityColumnValidation] ST3              WHERE ST3.ClientCode = ST2.ClientCode --and ST1.ID = ST2.ID              ORDER BY ST3.ID              FOR XML PATH ('')          ), 2, 8000) [stgtableColumns]    into #temp  FROM [elig].[EligibilityColumnValidation] ST2  where 1=1  and ST2.ClientCode = @ClientCode  and ST2.FileType in ('INCOMM', 'ELIG')    select @rawTableColumns = rawTableColumns ,      @stgtableColumns = stgtableColumns   from #temp    select distinct @stgtablename = ST2.SourceTable,      @FileType = ST2.FileType  FROM [elig].[EligibilityColumnValidation] ST2  where 1=1  and ST2.ClientCode = @ClientCode   and ST2.FileType in ('INCOMM', 'ELIG')    --select 'sujay',@rawTableColumns,@stgtableColumns,@stgtablename,@FileType    if @FileType ='ELIG'  begin  set @sqlstr = 'Insert into elig.stgEligBenefitData (FileTrackID,DataSource,RecordStatus,toBeProcessed,' + @stgtableColumns + ')       SELECT r.FileTrackID,fi.DataSource,'+char(39)+'ZZ'+char(39)+','+char(39)+'N'+char(39)+',' + @rawTableColumns +      ' from elig.rawEligBenefitData r       left join elig.fileinfo fi on r.FileInfoId = fi.FileInfoID      where 1=1      and r.ClientCode = ' +char(39)+ @ClientCode +char(39) + ' and r.FileTrackID = ' + cast(@FileTrackId as varchar)  end  if @FileType ='INCOMM'  begin  set @sqlstr = 'Insert into elig.stgIncommCardStatusData (FileTrackID,' + @stgtableColumns + ')       SELECT r.FileTrackID,' + @rawTableColumns +      ' from elig.rawEligBenefitData r       left join elig.fileinfo fi on r.FileInfoId = fi.FileInfoID      where 1=1      and r.ClientCode = ' +char(39)+ @ClientCode +char(39) + ' and r.FileTrackID = ' + cast(@FileTrackId as varchar)  end    select @sqlstr    if @isHeaderflag = 1  begin    set @sqlstr = @sqlstr + ' and recordSno not in (select min(recordSno) FROM elig.rawEligBenefitData where filetrackid = '+ cast(@FileTrackId as varchar) + ')'  select @sqlstr    end    EXEC sp_executesql @sqlstr;    if @FileType ='ELIG'  begin  update elig.FileTrack set RecordsReceived = (select count(*) from elig.stgEligBenefitData where FileTrackID = @FileTrackId),                                     StatusCode =  '300'         where 1=1      and FileTrackID = @FileTrackId  END    if @FileType ='INCOMM'  begin  update elig.FileTrack set RecordsReceived = (select count(*) from elig.stgIncommCardStatusData where FileTrackID = @FileTrackId),                                     StatusCode =  '999'         where 1=1      and FileTrackID = @FileTrackId  END  --exec [elig].[sp_move_rawEligTostgElig_dynamic] 'H335',null,6  drop table #temp    END  
  CREATE PROCEDURE [elig].[sp_Elig_Stats_Response_File_bkupon12072020]   @FileTrackId int  AS  begin    declare @maxFileNamelength int    --select @maxFileNamelength = max(len(isnull(stat.ELIG_STAT_FileName,ft.filename))) + 1  select @maxFileNamelength = max(len(ft.filename)) + 1  from elig.filetrack ft  --join elig.fileinfo fi on ft.FileInfoID = fi.FileInfoId  --left join ( select filename as ELIG_STAT_FileName,clientcode,snapshotflag,fromlocation,tolocation,isAckFileToFTP,FileExtension as STATFileExtension  --            from elig.fileinfo  --            where 1=1  --            and filetype = 'ELIG_STAT'  --            and direction = 'OUT'  --            and isAckFileToFTP = 'Y'  --) stat on fi.clientcode = stat.clientcode and fi.snapshotflag = stat.snapshotflag  where 1=1  and FileTrackID = @FileTrackId      select 1 as fororder, 'File_Date |'+ LEFT('Source File_Name'+space(@maxFileNamelength),@maxFileNamelength)  +'|Records_Received|Records_Processed|Records_NotProcessed|NewMembers|ChangedMembers|TerminatedMembers|TermedByAbsence' as outputText  union  select 2, LEFT(ISNULL(convert(varchar(10),ft.DateReceived,101),'')+space(10),10)  + '|' +                LEFT(ISNULL(ft.FileName,'')+space(@maxFileNamelength),@maxFileNamelength) + '|' +               left(isnull(cast(isnull(ft.RecordsReceived,0) as varchar(10)),'')+space(16),16) + '|' +               left(isnull(cast(isnull(ft.recordsprocessed,0) as varchar(10)),'')+space(17),17) + '|' +               left(isnull(cast(isnull(ft.RecordsErrored,0) as varchar(10)),'')+space(20),20)  + '|' +      left(isnull(cast(isnull(es.NewMembers,0) as varchar(10)),'')+space(10),10)  + '|' +      left(isnull(cast(isnull(es.ChangedMembers,0) as varchar(10)),'')+space(14),14)  + '|' +      left(isnull(cast(isnull(es.TerminatedMembers,0) as varchar(10)),'')+space(17),17)  + '|' +      left(isnull(cast(isnull(es.TermedByAbsence,0) as varchar(10)),'')+space(15),15)   from elig.FileTrack ft  left outer join elig.EligibilityStats es on (ft.FileTrackID = es.filetrackid and es.StatsType = 'GENERAL')  where 1=1  and ft.FileTrackID = @FileTrackId  --and ft.StatusCode = 400  order by 1    end  
    -- EXEC [ELIG].[elig_file_load_ssis_sp_merge_elig_HAP_to_master]     CREATE PROCEDURE [elig].[elig_file_load_ssis_sp_merge_elig_HAP_to_master]      AS    BEGIN       --BEGIN TRY   --BEGIN TRANSACTION member_load_elig_to_master_HAP    DECLARE @sys_user CHAR(30)      ,@sys_date DATETIME;      SET @sys_user = SYSTEM_USER  --SET @sys_date = CAST(GETDATE() AS DATE);    SET @sys_date = CAST(GETDATE() AT TIME ZONE 'UTC' AT TIME ZONE 'Eastern Standard Time' AS DATETIME);  -- Time in EST         -- drop not null record insert constraint (unique index) on NHMemberID in master.members before inserting new members or updating NHMemberID for new records inserted      --ALTER TABLE [otc].[Cards] DROP CONSTRAINT [FK_Cards_NHMemberId]      --ALTER TABLE [Master].[Members] DROP CONSTRAINT [IX_Members_NHMemberID_U]      /*    MERGE Master.Members d                USING ( SELECT distinct * FROM [ELIG].[Members] WHERE  DataSource='ELIG_HAP' AND ToBeProcessed = 'Y' and isActive=1 AND StatusFlag in ('N','U')) s                ON (d.memberid = s.mastermemberid and d.datasource='ELIG_HAP')                  WHEN MATCHED THEN                                                                                                 UPDATE SET                d.EligFile = 'ELIG_HAP',                d.eligFileID = s.ID,                d.DateOfBirth = s.[DOB],                d.FirstName = s.FirstName,                d.Gender = s.Gender,                d.IsActive = 1,                d.LastName = s.LastName,                d.MiddleInitial = s.MiddleName,                d.ModifyDate = @sys_date,                d.ModifyUser = @sys_user                  WHEN NOT MATCHED THEN                  INSERT (          CreateDate,                        CreateUser,                        DataSource,                        DateOfBirth,                        FirstName,                        Gender,                        IsActive,                        LastName,                        MiddleInitial,                        ModifyDate,                        ModifyUser,                        EligFile,                        EligFileID)                          VALUES                         (                        @sys_date                ,@sys_user                ,'ELIG_HAP'                ,DOB                ,FirstName                ,Gender                ,1                ,LastName                ,MiddleName                ,@sys_date                ,@sys_user                ,'ELIG_HAP'                ,ID                );    */      -- Update existing members    MERGE Master.Members d                USING ( SELECT distinct * FROM [ELIG].[Members] WHERE  DataSource='ELIG_HAP' AND ToBeProcessed = 'Y' and isActive=1 AND StatusFlag in ('U')) s                ON (d.memberid = s.mastermemberid and d.datasource='ELIG_HAP')                  WHEN MATCHED THEN                                                                                                 UPDATE SET                d.EligFile = 'ELIG_HAP',                d.eligFileID = s.ID,                d.DateOfBirth = s.[DOB],                d.FirstName = s.FirstName,                d.Gender = s.Gender,                d.IsActive = 1,                d.LastName = s.LastName,                d.MiddleInitial = s.MiddleName,                d.ModifyDate = @sys_date,                d.ModifyUser = @sys_user       ;         DROP TABLE IF EXISTS #temp_elig_HAP_TMembers         SELECT * ,'ELIG' + convert(VARCHAR, NEXT VALUE FOR [elig].[NHMemberIDSeq]) Temp_NHMemberID       INTO #temp_elig_HAP_TMembers       FROM [ELIG].[Members]        WHERE  DataSource='ELIG_HAP'        AND ToBeProcessed = 'Y'        and isActive=1        AND StatusFlag in ('N')         -- Insert new members    MERGE Master.Members d                USING ( SELECT * from #temp_elig_HAP_TMembers) s                ON (d.memberid = s.mastermemberid and d.datasource='ELIG_HAP')         WHEN NOT MATCHED THEN                  INSERT (          CreateDate,                        Crea
    -- EXEC [elig].[sp_elig_load_stg_to_elig] 21    CREATE PROCEDURE [elig].[sp_elig_load_stg_to_elig_bkupon12072020] (@FileTrackID BIGINT)  --- Version 1.0  --           - Mohan Bekkary -- New Procedure  --- Version 1.00 -- 01/01/2020 - Raj/ Srikanth -- Error Handling & Audit Log, Changed Phone Nbrs to varchar,   --- Version 1.01 -- 01/06/2020 - Raj Sareddy   -- Changed Error type to be ERR_,   --- Version 1.02 -- 01/07/2020 - Raj/ Srikanth -- Dates check and change to UTC datetime issue  --- Version 1.03 -- 01/07/2020 - Raj Sareddy   -- Added Stats Procedure  --- Version 1.04 -- 06/23/2020 - Raj/Srikanth -- Excluding RecordStatus like ERR  AS  DECLARE @procedureName VARCHAR(100) = 'sp_elig_load_stg_to_elig'  DECLARE @strWhereClause VARCHAR(max)   DECLARE @strChangeClause VARCHAR(max)  DECLARE @strCrossWalkWhereClause VARCHAR(max)  DECLARE @strNHLink VARCHAR(500)  DECLARE @sql VARCHAR(max)  DECLARE @statusFlag NVARCHAR(10) = 'N'  DECLARE @dataSource NVARCHAR(50)  DECLARE @NewRecordCount INTEGER  DECLARE @RecordsProcessed INTEGER  DECLARE @ErrorRecordCount INTEGER  DECLARE @ChangeRecordCount INTEGER  DECLARE @DropRecordCount INTEGER  DECLARE @NoChangeRecordCount INTEGER  DECLARE @LogMessage VARCHAR(max)  DECLARE @UserName VARCHAR(100) = SUSER_SNAME()  DECLARE @ClientCode VARCHAR(100)  DECLARE @FileType VARCHAR(100)  DECLARE @SnapShot VARCHAR(100)  DECLARE @FileInfoID BIGINT  DECLARE @FileID BIGINT  DECLARE @fullFile INT  DECLARE @stepName VARCHAR(200);  declare @fileTrackStatusCode varchar(20)  BEGIN   BEGIN TRY   BEGIN TRANSACTION elig_load_stg_to_elig     --- Get File Info from file track table for FileTrackID   SELECT @dataSource = Datasource    ,@snapshot = Snapshotflag    ,@FileInfoID = FileInfoID    ,@ClientCode = ClientCode    ,@FileType = FileType    ,@fileTrackStatusCode = StatusCode   FROM elig.filetrack   WHERE FileTrackID = @FileTrackID   --DONE --- RAJ added status code if status code not found then log saying no data found     if isnull(@fileTrackStatusCode,'999') <> '300'   begin    print('no file')    Return 0   end      PRINT (@ClientCode)   PRINT (@FileType)   PRINT (@FileTrackId)     SET @stepName = '110 Update BenefitEndDate'   EXEC elig.auditlog @ClientCode, @FileTrackID,@procedureName,@stepName,'S'     update elig.stgEligBenefitData    set BenefitEndDate = '2099-12-31'   where FileTrackID = @FileTrackID   and isnull(BenefitEndDate,'') = ''     EXEC elig.auditlog @ClientCode, @FileTrackID,@procedureName,@stepName,'S'        IF @snapshot = 'FULL'    SET @fullFile = 1   ELSE    SET @fullFile = 0      --LATER LOW Priority RAJ MAY be move all clauses to one priority low   --- Get Mandatory Where condition between Stage and Master tales.   SET @strWhereClause = [elig].[getEligWhereClause](@ClientCode, @FileType)     PRINT @strWhereClause     --- Get Change fileds comparison between stage and elig master table   SET @strChangeClause = [elig].[getEligChangeClause](@ClientCode, @FileType)   --- Get CrossWalk Where condition between Stage and Master tales.   SET @strCrossWalkWhereClause = [elig].[getCrossWalkWhereClause](@ClientCode, @FileType)   SET @strNHLink = [elig].[getLinkID](@ClientCode, @FileType)          -- Validate for Span Errors in Stage Table   --BEGIN TRY    DECLARE @RC INT     SET @stepName = '120 Duplicate Check'   EXEC elig.auditlog @ClientCode, @FileTrackID,@procedureName,@stepName,'S'      EXECUTE @RC = [elig].[sp_elig_validate_duplicate_stage_data] @ClientCode     ,@FileType     ,@FileTrackID      SET @stepName = '130 OlD SPAN Check'   EXEC elig.auditlog @ClientCode, @FileTrackID,@procedureName,@stepName,'S'      EXECUTE @RC = [elig].[sp_elig_validate_oldspan_stage_data] @ClientCode     ,@FileType     ,@FileTrackID     SET @stepName = '160 Validate Other Stage Data'   EXEC elig.auditlog @ClientCode, @FileTrackID,@procedureName,@stepName,'S'      -- Validate data in stage for any data errors    EXECUTE @RC = [elig].[sp_elig_validate_stage_data] @ClientCode     ,@FileType     ,@FileTrackId       
  -- exec [elig].[sp_Elig_Error_Response_File]  4569    CREATE PROCEDURE [elig].[sp_Elig_Error_Response_File_bkupon12072020]   @FileTrackId int  AS  begin  SET FMTONLY OFF    SET NOCOUNT ON    declare @sqlstr nvarchar(max),    @sqlstr2 nvarchar(max),    @ClientColumns nvarchar(max),    @mstrtableColumns nvarchar(max),          @isHeaderflag bit,    @ClientCode VARCHAR(20),    @FileInfoID VARCHAR(20),    @delimiter varchar(1)    select   @isHeaderflag = fi.IsHeaderRecord    ,@FileInfoID = ft.FileInfoID    ,@ClientCode = ft.ClientCode    ,@delimiter = case when isnull(fi.FileFormatValue,'') = '' then '|'         when isnumeric(fi.FileFormatValue) = 1  then '|' else  fi.FileFormatValue end   from elig.FileInfo fi  join elig.FileTrack ft on fi.FileInfoID = ft.FileInfoID and ft.ClientCode = fi.ClientCode  where 1=1  and ft.FileTrackID = @FileTrackId    create table #temp2 (fororder int, outputText varchar(max))    SELECT DISTINCT     SUBSTRING(          (              SELECT  @delimiter + ST1.ClientColumn AS [text()]              FROM [elig].[EligibilityColumnValidation] ST1              WHERE st1.ErrRptFlag >= 1     and ST1.ClientCode = ST2.ClientCode --and ST1.ID = ST2.ID              ORDER BY ST1.ErrRptFlag,ST1.ID              FOR XML PATH ('')          ), 2, 8000) [ClientColumns],   SUBSTRING(          (              SELECT '+'+char(39)+@delimiter+char(39)+'+isnull('+ ST3.TargetColumn +',' +char(39)++char(39)+')'  AS [text()]              FROM [elig].[EligibilityColumnValidation] ST3              WHERE st3.ErrRptFlag >= 1     and ST3.ClientCode = ST2.ClientCode --and ST1.ID = ST2.ID              ORDER BY ST3.ErrRptFlag,ST3.ID              FOR XML PATH ('')          ), 6, 8000) [TargetColumns]    into #temp  FROM [elig].[EligibilityColumnValidation] ST2  where 1=1  and ST2.ClientCode = @ClientCode  and ST2.FileType = 'ELIG'  and st2.ErrRptFlag >= 1    select @ClientColumns = ClientColumns ,      @mstrtableColumns = TargetColumns  from #temp  where 1=1    insert into #temp2 select 1, 'Description|'+ @ClientColumns    --select 'sujay',@ClientColumns,@mstrtableColumns          set @sqlstr = 'insert into #temp2     select 2, substring(ed.[Description],3,len(ed.[Description])) +' +char(39)+@delimiter+char(39)+'+' + @mstrtableColumns + '       from elig.errEligBenefitData e      left join (         SELECT DISTINCT ST2.errEligID,            (         SELECT'+char(39)+'; '+char(39)+'+ST1.Description  AS [text()]        FROM elig.errEligBenefitDataDetails ST1        WHERE ST1.errEligID = ST2.errEligID        ORDER BY ST1.errEligID        FOR XML PATH ('+char(39)+''+char(39)+')       ) [Description]           FROM elig.errEligBenefitDataDetails ST2        where 1=1) ed on e.errEligID = ed.errEligID         where 1=1         and e.FileTrackID = ' + cast(@FileTrackId as varchar)    --  select @sqlstr    EXEC sp_executesql @sqlstr       set @sqlstr2 ='select fororder,cast(LTRIM(RTRIM(outputText)) as varchar(max)) as outputText    from #temp2    where 1=1    order by fororder'        EXEC sp_executesql @sqlstr2    WITH RESULT SETS    (     (     fororder int,     outputText VARCHAR(max)     )    )    drop table #temp  drop table #temp2  --exec elig.sp_Elig_Error_Response_File 0  --exec elig.sp_Elig_Error_Response_File 10  end    
    -- EXEC [ELIG].[elig_file_load_ssis_sp_merge_stg_to_elig_HAP]     CREATE PROCEDURE [elig].[elig_file_load_ssis_sp_merge_stg_to_elig_HAP]      AS    BEGIN     --BEGIN TRY   --BEGIN TRANSACTION member_load_stg_to_elig_HAP     DECLARE @sys_user CHAR(30)       ,@sys_date DATETIME;       SET @sys_user = SYSTEM_USER   --SET @sys_date = CAST(GETDATE() AS DATE);     SET @sys_date = CAST(GETDATE() AT TIME ZONE 'UTC' AT TIME ZONE 'Eastern Standard Time' AS DATETIME);  -- Time in EST         UPDATE ELIG.Members SET ToBeProcessed = 'N' WHERE DataSource='ELIG_HAP' AND ToBeProcessed = 'Y' --and IsActive=1   UPDATE ELIG.Insurances SET ToBeProcessed = 'N' WHERE DataSource='ELIG_HAP' AND ToBeProcessed = 'Y' --and IsActive=1   UPDATE ELIG.AddressInfo SET ToBeProcessed = 'N' WHERE DataSource='ELIG_HAP' AND ToBeProcessed = 'Y' --and IsActive=1   UPDATE ELIG.PCP SET ToBeProcessed = 'N' WHERE DataSource='ELIG_HAP' AND ToBeProcessed = 'Y' --and IsActive=1   UPDATE ELIG.OtherInfo SET ToBeProcessed = 'N' WHERE DataSource='ELIG_HAP' AND ToBeProcessed = 'Y'      TRUNCATE table elig.temp_hap_elig_member            -- Find New, Update and Terminate members            -- New - We don't have these members in CRM but received them in the latest eligibility file     insert into elig.temp_hap_elig_member     SELECT a.NHLinkID,a.DOB     ,'N' AS MemberStatus          FROM     (      SELECT DISTINCT       HAP_NUMBER AS NHLinkID      ,cast(DATE_OF_BIRTH as date) as DOB       FROM [ELIG].[StgELGHAP]        EXCEPT        SELECT       NHLinkID,DOB      FROM ELIG.Members      WHERE DataSource = 'ELIG_HAP'      and IsActive=1     ) a       -- Update - All members who are already available both in CRM and latest eligibility file.     insert into elig.temp_hap_elig_member     SELECT a.NHLinkID,a.DOB     ,'U' AS MemberStatus     FROM     (      SELECT DISTINCT       HAP_NUMBER AS NHLinkID      ,cast(DATE_OF_BIRTH as date) as DOB       FROM [ELIG].[StgELGHAP]        INTERSECT        SELECT       NHLinkID,DOB      FROM ELIG.Members      WHERE DataSource = 'ELIG_HAP'      and IsActive=1     ) a       -- Terminate - Members who are already in CRM but missing in latest eligibility file     insert into elig.temp_hap_elig_member     SELECT a.NHLinkID,a.DOB     ,'T' AS MemberStatus     FROM     (      SELECT       NHLinkID,DOB      FROM ELIG.Members      WHERE DataSource = 'ELIG_HAP'      and IsActive=1      AND StatusFlag != 'T'        EXCEPT        SELECT DISTINCT       HAP_NUMBER AS NHLinkID      ,cast(DATE_OF_BIRTH as date) as DOB       FROM [ELIG].[StgELGHAP]     ) a                -- New Member Updates - Start         --SELECT * FROM elig.temp_hap_elig_member     -- drop table elig.temp_hap_elig_member       -- New Members     INSERT INTO ELIG.Members (     DataSource,      --CarrierMemberID,      FirstName,      LastName,     Title,     [MedicaidNbr],     [MedicareNbr],     [SSN],     [DOB],     [DateOfDeath],     [Gender],     [Race],     [Language],     [NHMemberID],     [MasterMemberID],     [ToBeProcessed],     [StatusFlag],     [ProcessedDate],     [CreateDate],     [CreateUser],     [ModifyDate],     [ModifyUser],     [NHLinkID],     [MiddleName],     [IsActive]     )     SELECT DISTINCT     'ELIG_HAP',     --s.HAP_NUMBER,     s.FIRST_NAME,     s.LAST_NAME,     s.CONTACT_TITLE,     s.MEDICAID_RECIPIENT_ID,     s.MEDICARE_NUMBER,     NULL,     s.DATE_OF_BIRTH,     NULL,     s.GENDER,     NULL,     NULL, --s.LANGUAGE_CODE, -- excluded to eliminate inserting duplicate member with & without language code     NULL,     NULL,     'Y',     'N',     @sys_date,     @sys_date,     @sys_user,     @sys_date,     @sys_user,     s.HAP_NUMBER,     s.MIDDLE_INITIAL,      1     FROM elig.temp_hap_elig_member t     JOIN [ELIG].[StgELGHAP] s ON (s.HAP_NUMBER = t.NHLinkID and cast(s.DATE_OF_BIRTH AS DATE)=cast(t.DOB as date) and t.MemberStatus = 'N')     --order by s.HAP_NUMBER,s.DATE_OF_BIRTH       --New Insurances     INSERT INTO ELIG.Insurances (     --NHInsuranceID,     DataSour
  --exec [elig].[sp_MarketingMaterialMemberLog_file]  'ELIG_ULT',0,'DELTA','SE PRINTING','CATALOG'  --exec [elig].[sp_MarketingMaterialMemberLog_file]  'ELIG_ULT',0,'FULL','Universal Printing','OTC MAILER'  --exec [elig].[sp_MarketingMaterialMemberLog_file]  'ELIG_ULT',0,'FULL','SE PRINTING','NA XYX FULL'    --exec [elig].[sp_MarketingMaterialMemberLog_file]  'ELIG_ULT',35,'DELTA','SE PRINTING','NA ABC 35 DELTA'  --exec [elig].[sp_MarketingMaterialMemberLog_file]  'ELIG_ULT',33,'FULL','SE PRINTING','NA XXX 33 FULL'      CREATE PROCEDURE [elig].[sp_MarketingMaterialMemberLog_File] (    @DataSource    varchar(20),    @InsHealthPlanID  int,    @SnapShotFlag   varchar(10),    @Vendor     varchar(30),    @MarketingMaterialDesc varchar(100))  AS  BEGIN      select 'N' as sentflag,*     into #temp    from elig.mstrEligBenefitData     where 1=1     and DataSource = @DataSource    and isActive = 1    and getdate() between BenefitStartDate and BenefitEndDate    and getdate() between RecordEffDate and RecordEndDate      --select @Vendor,@MarketingMaterialDesc,* from #temp where 1=1        --select @Vendor as Vendor,@MarketingMaterialDesc as MarketingMaterialDesc,*     If @SnapShotFlag = 'DELTA' and @InsHealthPlanID = 0    Begin    delete a    from #temp a    join elig.MarketingMaterialMemberLog b on a.SubscriberID = b.SubscriberID               and a.MasterMemberID = b.MasterMemberID              --and a.insHealthPlanID = b.insHealthPlanID              and a.DataSource = b.DataSource    where 1=1    and b.DataTypeDesc = @MarketingMaterialDesc    End      If @SnapShotFlag = 'DELTA' and @InsHealthPlanID <> 0    Begin     delete from #temp where insHealthPlanID <> @InsHealthPlanID     delete a     from #temp a     join elig.MarketingMaterialMemberLog b on a.SubscriberID = b.SubscriberID                 and a.MasterMemberID = b.MasterMemberID                and a.insHealthPlanID = b.insHealthPlanID                and a.DataSource = b.DataSource                and  b.Vendor = @Vendor     where 1=1     --and a.insHealthPlanID <> @InsHealthPlanID         end      If @SnapShotFlag = 'FULL' and @InsHealthPlanID <> 0    Begin     delete from #temp where insHealthPlanID <> @InsHealthPlanID    end    --BEGIN TRY  -- BEGIN TRANSACTION T1;      Insert into elig.MarketingMaterialMemberLog         ( [DataSource]        , [MasterMemberID]        , [SubscriberID]        , [insCarrierID]        , [insHealthPlanID]        , [Vendor]        , [DataTypeDesc]        , snapshotflag        , [SentDate]        )    select           [DataSource]           , [MasterMemberID]        , [SubscriberID]        , [insCarrierID]        , [insHealthPlanID]        , @Vendor        , @MarketingMaterialDesc        ,@SnapShotFlag        , getdate()    from #temp    where 1=1    and sentflag = 'N'      select 0 as fororder,       'MemberFirstName'       +'|'+ 'MemberMiddleInitial'       +'|'+ 'MemberLastName'       +'|'+ 'Address1'       +'|'+ 'Address2'       +'|'+ 'City'      +'|'+ 'State'      +'|'+ 'ZipCode'      as Outputtext    union    select 1 as fororder,             isnull(ltrim(rtrim(FirstName)),'') --'MemberFirstName'       +'|'+ isnull(ltrim(rtrim(MiddleInitial)),'') --'MemberMiddleInitial'       +'|'+ isnull(ltrim(rtrim(LastName)),'') --'MemberLastName'       +'|'+ isnull(ltrim(rtrim(Address1)),'') -- 'MemberAddress1'       +'|'+ isnull(ltrim(rtrim(Address2)),'') --'MemberAddress2'       +'|'+ isnull(ltrim(rtrim(City)),'') -- 'MemberCity'       +'|'+ isnull(ltrim(rtrim(State)),'') -- 'MemberState'       +'|'+ isnull(ltrim(rtrim(ZipCode)),'') --'MemberZipCode'       as Outputtext    from #temp    where 1=1    and sentflag = 'N'    order by 1     --COMMIT TRANSACTION t1;   --PRINT 'SUCCESS'   --END TRY   --BEGIN CATCH    --drop temp tables  drop table #temp     --DECLARE @ErrorMessage NVARCHAR(4000);     --   DECLARE @ErrorSeverity INT;     --   DECLARE @ErrorState INT;       --   SELECT      --       @ErrorMessage = ERROR_MESSAGE(),     --       @ErrorSeverity = ER
  -- =============================================  -- Author:      <Author, , Name>  -- Create Date: <Create Date, , >  -- Description: <Description, , >  -- =============================================  CREATE PROCEDURE [elig].[auditlog] (    @ClientCode VARCHAR(20)      ,@FileTrackId bigint   ,@ProcedureName VARCHAR(MAX)   ,@stepName VARCHAR(MAX)   ,@status varchar(10)   )  AS      BEGIN   -- SET NOCOUNT ON added to prevent extra result sets from   -- interfering with SELECT statements.   SET NOCOUNT ON     Begin  Tran InnerTran     INSERT INTO elig.jobAuditLog (     ClientCode    ,FileTrackID    ,ProcedureName    ,StepName    ,Statuscode    )   VALUES (     @ClientCode     ,@FileTrackId    ,@ProcedureName    ,@stepName    ,@status    )   Commit  Tran InnerTran   print ('Done Commit')  END
    --exec [elig].[sp_move_rawEligTostgElig] 'H438',null,3892  CREATE PROCEDURE [elig].[sp_move_rawEligTostgElig]   @ClientCode varchar(20),  @FileInfoId  bigint, --Not used replaced by clientcode  @FileTrackId bigint  AS  BEGIN    declare @sqlstr nvarchar(max),          @sqlstr2 nvarchar(max),    @rawTableColumns nvarchar(max),    @stgtableColumns nvarchar(max),    @stgtablename varchar(50),    @FileType varchar(30),          @isHeaderflag bit,          @recordSno int,    @IsFileHeaderRecord bit,    @IsFileTrailerRecord bit,    @stgtableColumnsUPD nvarchar(max)      select @isHeaderflag = fi.IsHeaderRecord,      @IsFileHeaderRecord = isnull(fi.IsFileHeaderRecord,0),      @IsFileTrailerRecord = isnull(fi.IsFileTrailerRecord,0)  from elig.FileInfo fi  join elig.FileTrack ft on fi.FileInfoID = ft.FileInfoID and ft.ClientCode = fi.ClientCode  where 1=1  and ft.FileTrackID = @FileTrackId      delete from elig.stgEligBenefitData  where 1=1  and FileTrackId = @FileTrackId    delete from elig.stgIncommCardStatusData  where 1=1  and FileTrackId = @FileTrackId    SELECT DISTINCT     SUBSTRING(          (              --SELECT ',r.'+ST1.rawtableColumn  AS [text()]     SELECT case when st1.FileType='DFLT' then ','''+ st1.ClientColumn +''' as ' + ST1.rawtableColumn else ',r.'+ ST1.rawtableColumn end  AS [text()]              FROM [elig].[EligibilityColumnValidation] ST1              WHERE 1=1     and ST1.ActiveFlag=1     and ST1.ClientCode = ST2.ClientCode --and ST1.ID = ST2.ID              ORDER BY ST1.ID              FOR XML PATH ('')          ), 2, 8000) [rawTableColumns],   SUBSTRING(          (              SELECT ','+ST3.SourceColumn  AS [text()]              FROM [elig].[EligibilityColumnValidation] ST3              WHERE 1=1     and ST3.ActiveFlag = 1     and ST3.ClientCode = ST2.ClientCode --and ST1.ID = ST2.ID              ORDER BY ST3.ID              FOR XML PATH ('')          ), 2, 8000) [stgtableColumns]    into #temp  FROM [elig].[EligibilityColumnValidation] ST2  where 1=1  and ST2.ClientCode = @ClientCode  and ST2.FileType in ('INCOMM', 'ELIG','DFLT')    select @rawTableColumns = rawTableColumns ,      @stgtableColumns = stgtableColumns   from #temp    select distinct @stgtablename = ST2.SourceTable,      @FileType = ST2.FileType  FROM [elig].[EligibilityColumnValidation] ST2  where 1=1  and ST2.ClientCode = @ClientCode   and ST2.FileType in ('INCOMM', 'ELIG')    --select 'sujay',@rawTableColumns,@stgtableColumns,@stgtablename,@FileType  create table #tempRecSno (recordSno bigint)      if @FileType ='ELIG'  begin  set @sqlstr = 'Insert into elig.stgEligBenefitData (FileTrackID,DataSource,RecordStatus,toBeProcessed,' + @stgtableColumns + ')       SELECT r.FileTrackID,fi.DataSource,'+char(39)+'ZZ'+char(39)+','+char(39)+'N'+char(39)+',' + @rawTableColumns +      ' from elig.rawEligBenefitData r       left join elig.fileinfo fi on r.FileInfoId = fi.FileInfoID      where 1=1      and r.ClientCode = ' +char(39)+ @ClientCode +char(39) + ' and r.FileTrackID = ' + cast(@FileTrackId as varchar)  end  if @FileType ='INCOMM'  begin  set @sqlstr = 'Insert into elig.stgIncommCardStatusData (FileTrackID,' + @stgtableColumns + ')       SELECT r.FileTrackID,' + @rawTableColumns +      ' from elig.rawEligBenefitData r       left join elig.fileinfo fi on r.FileInfoId = fi.FileInfoID      where 1=1      and r.ClientCode = ' +char(39)+ @ClientCode +char(39) + ' and r.FileTrackID = ' + cast(@FileTrackId as varchar)  end    select @sqlstr    set @sqlstr = @sqlstr + ' and recordSno not in (select recordSno from #tempRecSno)'    select @sqlstr    if (@isHeaderflag = 1 and @IsFileHeaderRecord = 0 and @IsFileTrailerRecord = 0)   begin   insert into #tempRecSno select min(recordSno) FROM elig.rawEligBenefitData where filetrackid = @FileTrackId  end    if (@isHeaderflag = 1 and @IsFileHeaderRecord = 1 and @IsFileTrailerRecord = 0)   begin  insert into #tempRecSno  select min(recordSno) FROM elig.rawEligBenefitData where filetrackid = @FileTrackId unio
CREATE PROCEDURE [elig].[sp_elig_mark_span_errors_stage_data] (   @ClientCode VARCHAR(20)   ,@FileType VARCHAR(50)   ,@FileTrackID BIGINT   )  AS  BEGIN   DECLARE @procedureName VARCHAR(100) = 'sp_elig_mark_span_errors_stage_data'   DECLARE @temptable VARCHAR(MAX)   DECLARE @sql VARCHAR(MAX)   DECLARE @statusFlag NVARCHAR(10) = 'N'   DECLARE @LogMessage VARCHAR(max)   DECLARE @UserName VARCHAR(100) = SUSER_SNAME()   DECLARE @errDetailsql VARCHAR(max)   DECLARE @spancol VARCHAR(100)   DECLARE @uniqueCols VARCHAR(1000)   DECLARE @stepName VARCHAR(200)      DECLARE span_cursor CURSOR   FOR -- SD - Can we change cursor name to ChangeClause to align with function name and use where_cursor in [dbo].[get834WhereClause]   SELECT SourceColumn   FROM [elig].[EligibilityColumnValidation]   WHERE [SpanFlag] = 1    AND [FileType] = @FileType    AND [ClientCode] = @ClientCode;     SET @stepName = '150 Span Errors - Started'   EXEC elig.auditlog @ClientCode, @FileTrackID,@procedureName,@stepName,'S'     PRINT ('Here')     DECLARE @counter INT = 1     OPEN span_cursor     PRINT ('here2')     FETCH NEXT   FROM span_cursor   INTO @spancol     PRINT ('here3')     WHILE @@FETCH_STATUS = 0   BEGIN    IF @counter = 1     SET @uniqueCols = @spancol    ELSE     SET @uniqueCols = @uniqueCols + '+''=='' +' + @spancol      FETCH NEXT    FROM span_cursor    INTO @spancol      SET @counter = @counter + 1   END     CLOSE span_cursor;     DEALLOCATE span_cursor;     set @temptable =     'WITH temp_spanrecords (stgeligid, UnID,benefitstartdate,benefitenddate)    AS (    select stgeligid,  ' + @uniqueCols + ' as UnID,benefitstartdate,benefitenddate from elig.stgEligBenefitData  where ' + @uniqueCols + '   in (select ' + @uniqueCols + ' from elig.stgEligBenefitData where 1 = 1 and filetrackid = ' + convert(VARCHAR, @FileTrackId) + ' AND RecordStatus = ''ZZ''  group by  ' + @uniqueCols + ' having count(*) > 1 )  and filetrackid = ' + convert(VARCHAR, @FileTrackId) +'  AND RecordStatus = ''ZZ'' '+    ')   '     -- set @temptable = 'select stgeligid,alternateid  + ''=='' + subscriberid  as UnID,benefitstartdate,benefitenddate from elig.stgEligBenefitData  where alternateid  + ''=='' + subscriberid  in (select alternateid + ''=='' + subscriberid from elig.stgEligBenefitData group by  alternateid + ''=='' + subscriberid having count(*) > 1)'   --SET @temptable = 'select stgeligid,  ' + @uniqueCols + ' as UnID,benefitstartdate,benefitenddate from elig.stgEligBenefitData  where ' + @uniqueCols + '   in (select ' + @uniqueCols + ' from elig.stgEligBenefitData where recordstatus =''ZZ'' and filetrackid = ' + convert(VARCHAR, @FileTrackId) + '  group by  ' + @uniqueCols + ' having count(*) > 1 ) AND recordstatus = ''ZZ'' and filetrackid = ' + convert(VARCHAR, @FileTrackId) +'  '     PRINT (@temptable)     SET @sql = @temptable + ' update elig.stgEligBenefitData set recordstatus = ''ERR_SPAN'' where  recordstatus = ''ZZ'' and filetrackid = ' + convert(VARCHAR, @FileTrackId) + ' and  '+ @uniqueCols +' in (select tab1.UnID from temp_spanrecords tab1 where exists (select 1 from temp_spanrecords tab2 where tab2.UnID = tab1.UnID and tab2.stgeligid <> tab1.stgeligid and cast(tab1.benefitstartdate as date) between cast(tab2.benefitstartdate as date) and cast(tab2.benefitenddate as date) and cast(tab2.benefitstartdate as date) <> cast(tab2.benefitenddate as date)  )  and cast(tab1.benefitstartdate as date) <> cast(tab1.benefitenddate as date)    )'     PRINT @sql     EXEC (@sql)     SET @stepName = '151 Span Errors - Write Error Records'   EXEC elig.auditlog @ClientCode, @FileTrackID,@procedureName,@stepName,'S'     --ADD Span Errors to Error Table   INSERT INTO [elig].[errEligBenefitData] (    [FileTrackID]    ,[DataSource]    ,[RecordStatus]    ,[LastName]    ,[MiddleInitial]    ,[FirstName]    ,[DOB]    ,[SSN]    ,[SubscriberID]    ,[MemberSuffix]    ,[GroupNbr]    ,[BenefitStartDate]    ,[BenefitEndDate]    ,[SubGroupNbr]    ,[FamilyLinkID]    ,[AlternateID]    ,[MedicaidID]
    CREATE PROCEDURE [elig].[sp_elig_validate_duplicate_stage_data] (   @ClientCode VARCHAR(20)   ,@FileType VARCHAR(50)   ,@FileTrackID BIGINT   )  AS  BEGIN   DECLARE @procedureName VARCHAR(100) = 'sp_elig_validate_duplicate_stage_data'       --- Check for Duplicate Records   PRINT ('Duplicate check start')     UPDATE elig.stgEligBenefitData   SET RecordStatus = 'ERR_DUP'   WHERE stgEligID IN (     SELECT stgEligID     FROM (      SELECT stgEligID       ,rank() OVER (        PARTITION BY FileTrackID        ,DataSource        ,RecordStatus        ,toBeProcessed        ,LastName        ,MiddleInitial        ,FirstName        ,DOB        ,SSN        ,SubscriberID        ,MemberSuffix        ,GroupNbr        ,BenefitStartDate        ,BenefitEndDate        ,SubGroupNbr        ,FamilyLinkID        ,AlternateID        ,MedicaidID        ,MedicareID        ,ClientMemberNumber        ,ContractNbr        ,PBPID        ,ProductID        ,BenefitLevel        ,LANGUAGE        ,Gender        ,HomePhoneNbr        ,OtherPhoneNbr        ,MemberEmail        ,Address1        ,Address2        ,City        ,STATE        ,ZipCode        ,MailingAddress1        ,MailingAddress2        ,MailingCity        ,MailingState        ,MailingZipCode        ,OtherAddress1        ,OtherAddress2        ,OtherCity        ,OtherState        ,OtherZipCode        ,OtherAddressType        ,SubscriberIndFlag        ,RelationShipCode        ,MaintenanceType        ,MaintenanceReason        ,BenefitStatus        ,MedicarePlanCode        ,EligReasonCode        ,COBRAEvent        ,EmploymentStatusCode        ,StudentStatusCode        ,HandicapInd        ,DisabilityType        ,MedicalCodeQualifier        ,MedicalCode        ,MaintenanceCode        ,InsuranceLineCode        ,CoverageLevel        ,LateEnrollment        ,CoInsurance        ,CoPayment        ,Deductible        ,Premium        ,SpendDown        ,LineNbr        ,PCPName        ,PCPNPI        ,PCPEffDate        ,PCPTermDate        ,PCPAddress1        ,PCPAddress2        ,PCPCity        ,PCPState        ,PCPZipCode        ,PCPBusinessPhone        ,COBFlag        ,COBCarrierName        ,COBPolicyNumber        ,COBGroup        ,COBBegin        ,COBEnd        ,COBRespcode        ,COBcode        ,COBServiceType        ,BusinessCategory        ,LineOfBusiness        ,EligibilityStartDate           ,EligibilityEndDate        ,VCFlex1Label        ,VCFlex1        ,VCFlex2Label        ,VCFlex2        ,VCFlex3Label        ,VCFlex3        ,VCFlex4Label        ,VCFlex4        ,VCFlex5Label        ,VCFlex5        ,VCFlex6Label        ,VCFlex6        ,VCFlex7Label        ,VCFlex7        ,VCFlex8Label        ,VCFlex8        ,VCFlex9Label        ,VCFlex9        ,VCFlex10Label        ,VCFlex10        ,VCFlex11Label        ,VCFlex11        ,VCFlex12Label        ,VCFlex12        ,VCFlex13Label        ,VCFlex13        ,VCFlex14Label        ,VCFlex14        ,VCFlex15Label        ,VCFlex15        ,VCFlex16Label        ,VCFlex16        ,VCFlex17Label        ,VCFlex17        ,VCFlex18Label        ,VCFlex18        ,VCFlex19Label        ,VCFlex19        ,VCFlex20Label        ,VCFlex20 ORDER BY stgEligID         ,FileTrackID         ,DataSource         ,RecordStatus         ,toBeProcessed         ,LastName         ,MiddleInitial         ,FirstName         ,DOB         ,SSN         ,SubscriberID         ,MemberSuffix         ,GroupNbr         ,BenefitStartDate         ,BenefitEndDate         ,SubGroupNbr         ,FamilyLinkID         ,AlternateID         ,MedicaidID         ,MedicareID         ,ClientMemberNumber         ,ContractNbr         ,PBPID         ,ProductID         ,BenefitLevel         ,LANGUAGE         ,Gender         ,HomePhoneNbr         ,OtherPhoneNbr         ,MemberEmail         ,Address1         ,Address2         ,City         ,STATE         ,ZipCode         ,MailingAddress1         ,MailingAddress2         ,MailingCity         ,MailingState         ,MailingZipCode         ,OtherAddress1         ,OtherAddress2         ,O
  CREATE PROCEDURE [elig].[sp_elig_validate_oldspan_stage_data] (   @ClientCode VARCHAR(20)   ,@FileType VARCHAR(50)   ,@FileTrackID BIGINT   )  AS  BEGIN   DECLARE @procedureName VARCHAR(100) = 'sp_elig_validate_oldspan_stage_data'      Declare @eligStartDate date       select    @eligStartDate = eligStartDate   from elig.ClientCodes    where ClientCode = @ClientCode             --- Check for Duplicate Records   PRINT ('OLD Span check start')     UPDATE elig.stgEligBenefitData   SET RecordStatus = 'ERR_OLDSPAN'   WHERE    --isnull(stgEligBenefitData.BenefitEndDate,'20991231') < = @eligStartDate   CAST(CASE WHEN ISDATE(stgEligBenefitData.BenefitEndDate) = 1 THEN stgEligBenefitData.BenefitEndDate END AS date) < = @eligStartDate   and stgEligBenefitData.FileTrackID = @FileTrackID   and stgEligBenefitData.RecordStatus = 'ZZ'         INSERT INTO [elig].[errEligBenefitData] (    [FileTrackID]    ,[DataSource]    ,[RecordStatus]    ,[LastName]    ,[MiddleInitial]    ,[FirstName]    ,[DOB]    ,[SSN]    ,[SubscriberID]    ,[MemberSuffix]    ,[GroupNbr]    ,[BenefitStartDate]    ,[BenefitEndDate]    ,[SubGroupNbr]    ,[FamilyLinkID]    ,[AlternateID]    ,[MedicaidID]    ,[MedicareID]    ,[ClientMemberNumber]    ,ContractNbr    ,[PBPID]    ,[ProductID]    ,[BenefitLevel]    ,[Language]    ,[Gender]    ,[HomePhoneNbr]    ,[OtherPhoneNbr]    ,MemberEmail    ,[Address1]    ,[Address2]    ,[City]    ,[State]    ,[ZipCode]    ,[MailingAddress1]    ,[MailingAddress2]    ,[MailingCity]    ,[MailingState]    ,[MailingZipCode]    ,[OtherAddress1]    ,[OtherAddress2]    ,[OtherCity]    ,[OtherState]    ,[OtherZipCode]    ,[OtherAddressType]    ,[SubscriberIndFlag]    ,[RelationShipCode]    ,[MaintenanceType]    ,[MaintenanceReason]    ,[BenefitStatus]    ,[MedicarePlanCode]    ,[EligReasonCode]    ,[COBRAEvent]    ,[EmploymentStatusCode]    ,[StudentStatusCode]    ,[HandicapInd]    ,[DisabilityType]    ,[MedicalCodeQualifier]    ,[MedicalCode]    ,[MaintenanceCode]    ,[InsuranceLineCode]    ,[CoverageLevel]    ,[LateEnrollment]    ,[CoInsurance]    ,[CoPayment]    ,[Deductible]    ,[Premium]    ,[SpendDown]    ,[LineNbr]    ,[PCPName]    ,[PCPNPI]    ,[PCPEffDate]    ,[PCPTermDate]    ,[PCPAddress1]    ,[PCPAddress2]    ,[PCPCity]    ,[PCPState]    ,[PCPZipCode]    ,[PCPBusinessPhone]    ,[COBFlag]    ,[COBCarrierName]    ,[COBPolicyNumber]    ,[COBGroup]    ,[COBBegin]    ,[COBEnd]    ,[COBRespcode]    ,[COBcode]    ,[COBServiceType]    ,[BusinessCategory]    ,[LineOfBusiness]    ,EligibilityStartDate    ,EligibilityEndDate    )   SELECT [FileTrackID]    ,[DataSource]    ,[RecordStatus]    ,[LastName]    ,[MiddleInitial]    ,[FirstName]    ,[DOB]    ,[SSN]    ,[SubscriberID]    ,[MemberSuffix]    ,[GroupNbr]    ,[BenefitStartDate]    ,[BenefitEndDate]    ,[SubGroupNbr]    ,[FamilyLinkID]    ,[AlternateID]    ,[MedicaidID]    ,[MedicareID]    ,[ClientMemberNumber]    ,ContractNbr    ,[PBPID]    ,[ProductID]    ,[BenefitLevel]    ,[Language]    ,[Gender]    ,[HomePhoneNbr]    ,[OtherPhoneNbr]    ,MemberEmail    ,[Address1]    ,[Address2]    ,[City]    ,[State]    ,[ZipCode]    ,[MailingAddress1]    ,[MailingAddress2]    ,[MailingCity]    ,[MailingState]    ,[MailingZipCode]    ,[OtherAddress1]    ,[OtherAddress2]    ,[OtherCity]    ,[OtherState]    ,[OtherZipCode]    ,[OtherAddressType]    ,[SubscriberIndFlag]    ,[RelationShipCode]    ,[MaintenanceType]    ,[MaintenanceReason]    ,[BenefitStatus]    ,[MedicarePlanCode]    ,[EligReasonCode]    ,[COBRAEvent]    ,[EmploymentStatusCode]    ,[StudentStatusCode]    ,[HandicapInd]    ,[DisabilityType]    ,[MedicalCodeQualifier]    ,[MedicalCode]    ,[MaintenanceCode]    ,[InsuranceLineCode]    ,[CoverageLevel]    ,[LateEnrollment]    ,[CoInsurance]    ,[CoPayment]    ,[Deductible]    ,[Premium]    ,[SpendDown]    ,[LineNbr]    ,[PCPName]    ,[PCPNPI]    ,[PCPEffDate]    ,[PCPTermDate]    ,[PCPAddress1]    ,[PCPAddress2]    ,[PCPCity]    ,[PCPState]    ,[PCPZipCode]    ,[PCPBusinessPhone]    ,[COBFlag] 
  CREATE PROCEDURE [elig].[sp_elig_validate_stage_data] (   @ClientCode VARCHAR(20)   ,@FileType VARCHAR(50)   ,@FileTrackID BIGINT   )  AS  BEGIN   DECLARE @procedureName VARCHAR(100) = 'sp_elig_validate_stage_data'   DECLARE @strWhereClause VARCHAR(MAX)   DECLARE @sql VARCHAR(MAX)   DECLARE @statusFlag NVARCHAR(10) = 'N'   DECLARE @dataSource NVARCHAR(50)    DECLARE @LogMessage VARCHAR(max)   DECLARE @UserName VARCHAR(100) = SUSER_SNAME()   DECLARE @errSelectsql VARCHAR(max)   DECLARE @errDetailsql VARCHAR(max)   DECLARE @DupRecorodCount BIGINT   DECLARE @sContinue INT = 1     PRINT (@ClientCode)   PRINT (@FileType)   PRINT (@FileTrackId)     SET @strWhereClause = [elig].[GetValidateStageDataCondition](@ClientCode, @FileType)   SET @errSelectsql = [elig].[GetStageErrorsSql](@ClientCode, @FileType, @FileTrackID)   SET @errDetailsql = 'insert into [elig].[errEligBenefitDataDetails] ( errEligID,Description) ' + @errSelectsql   SET @Sql = 'update [elig].stgEligBenefitData  set stgEligBenefitData.recordstatus  = ''ERR_REC'' where stgEligBenefitData.recordstatus  = ''ZZ'' and filetrackid = ' + convert(VARCHAR, @FileTrackId) + ' AND  ' + @strWhereClause     PRINT (@errDetailsql)   PRINT (@sql)     EXEC (@Sql)     INSERT INTO [elig].[errEligBenefitData] (    [FileTrackID]    ,[DataSource]    ,[RecordStatus]    ,[LastName]    ,[MiddleInitial]    ,[FirstName]    ,[DOB]    ,[SSN]    ,[SubscriberID]    ,[MemberSuffix]    ,[GroupNbr]    ,[BenefitStartDate]    ,[BenefitEndDate]    ,[SubGroupNbr]    ,[FamilyLinkID]    ,[AlternateID]    ,[MedicaidID]    ,[MedicareID]    ,[ClientMemberNumber]    ,ContractNbr    ,[PBPID]    ,[ProductID]    ,[BenefitLevel]    ,[Language]    ,[Gender]    ,[HomePhoneNbr]    ,[OtherPhoneNbr]    ,MemberEmail    ,[Address1]    ,[Address2]    ,[City]    ,[State]    ,[ZipCode]    ,[MailingAddress1]    ,[MailingAddress2]    ,[MailingCity]    ,[MailingState]    ,[MailingZipCode]    ,[OtherAddress1]    ,[OtherAddress2]    ,[OtherCity]    ,[OtherState]    ,[OtherZipCode]    ,[OtherAddressType]    ,[SubscriberIndFlag]    ,[RelationShipCode]    ,[MaintenanceType]    ,[MaintenanceReason]    ,[BenefitStatus]    ,[MedicarePlanCode]    ,[EligReasonCode]    ,[COBRAEvent]    ,[EmploymentStatusCode]    ,[StudentStatusCode]    ,[HandicapInd]    ,[DisabilityType]    ,[MedicalCodeQualifier]    ,[MedicalCode]    ,[MaintenanceCode]    ,[InsuranceLineCode]    ,[CoverageLevel]    ,[LateEnrollment]    ,[CoInsurance]    ,[CoPayment]    ,[Deductible]    ,[Premium]    ,[SpendDown]    ,[LineNbr]    ,[PCPName]    ,[PCPNPI]    ,[PCPEffDate]    ,[PCPTermDate]    ,[PCPAddress1]    ,[PCPAddress2]    ,[PCPCity]    ,[PCPState]    ,[PCPZipCode]    ,[PCPBusinessPhone]    ,[COBFlag]    ,[COBCarrierName]    ,[COBPolicyNumber]    ,[COBGroup]    ,[COBBegin]    ,[COBEnd]    ,[COBRespcode]    ,[COBcode]    ,[COBServiceType]    ,[BusinessCategory]    ,[LineOfBusiness]    ,EligibilityStartDate    ,EligibilityEndDate    )   SELECT [FileTrackID]    ,[DataSource]    ,[RecordStatus]    ,[LastName]    ,[MiddleInitial]    ,[FirstName]    ,[DOB]    ,[SSN]    ,[SubscriberID]    ,[MemberSuffix]    ,[GroupNbr]    ,[BenefitStartDate]    ,[BenefitEndDate]    ,[SubGroupNbr]    ,[FamilyLinkID]    ,[AlternateID]    ,[MedicaidID]    ,[MedicareID]    ,[ClientMemberNumber]    ,ContractNbr    ,[PBPID]    ,[ProductID]    ,[BenefitLevel]    ,[Language]    ,[Gender]    ,[HomePhoneNbr]    ,[OtherPhoneNbr]    ,MemberEmail    ,[Address1]    ,[Address2]    ,[City]    ,[State]    ,[ZipCode]    ,[MailingAddress1]    ,[MailingAddress2]    ,[MailingCity]    ,[MailingState]    ,[MailingZipCode]    ,[OtherAddress1]    ,[OtherAddress2]    ,[OtherCity]    ,[OtherState]    ,[OtherZipCode]    ,[OtherAddressType]    ,[SubscriberIndFlag]    ,[RelationShipCode]    ,[MaintenanceType]    ,[MaintenanceReason]    ,[BenefitStatus]    ,[MedicarePlanCode]    ,[EligReasonCode]    ,[COBRAEvent]    ,[EmploymentStatusCode]    ,[StudentStatusCode]    ,[HandicapInd]    ,[DisabilityType]    ,[MedicalCodeQualif
  --exec [elig].[sp_AccumulatorsOutbound_POP] '221~7~274'  CREATE PROCEDURE [elig].[sp_AccumulatorsOutbound_POP]   @CarrierIds varchar(100)  AS  BEGIN    create table #temp_Carrierid (CarrierId int)    insert into #temp_CarrierId  select cs.Value --SplitData  from (select @CarrierIds as CarrierId ) a  cross apply STRING_SPLIT (CarrierId, '~') cs    --select * from #temp_CarrierId    --select * from #temp_EBCDIC    --truncate table [elig].[AccumulatorsOutbound] --review after testing  select * into #temp_rawdata  from [bireports].[HAOrderDetailData]   where insurancecarrierid in (select CarrierId from #temp_CarrierId)     --select * from #temp_rawdata  --select count(*) from  #temp_rawdata  delete a   from #temp_rawdata a  join [elig].[AccumulatorsOutbound] b on a.nhmemberid = b.nhmemberid            and a.status = b.status            and a.ordernumber = b.ordernumber            and b.extractDate is not null  where 1=1    --select count(*) from  #temp_rawdata  delete b   from #temp_rawdata a  join [elig].[AccumulatorsOutbound] b on a.nhmemberid = b.nhmemberid            and a.status = b.status            and a.ordernumber = b.ordernumber            and b.extractDate is null  where 1=1    Insert into [elig].[AccumulatorsOutbound]  (      [DataSource]        ,[NHMemberID]        ,[OrderNumber]        ,[ExtractDate]        ,[Client_code]        ,[MEM_FIRST_NAME]        ,[MEM_MID_INIT]        ,[MEM_LAST_NAME]        ,[CARRIER_ID]        ,[ACCOUNT_ID]        ,[GROUP_ID]        ,[DATE_OF_BIRTH]        ,[MEMBER_ID]        ,[CHG_AMT]        ,[APPROVED_AMT]        ,[PAID_AMT]        --,[SVC_CAT]       -- ,[INN_DED_AMT]        ,[INN_MOOP_AMT]       -- ,[OON_DED_AMT]        --,[OON_MOOP_AMT]       -- ,[MSA_TOTAL]        ,[PLAN_YEAR]    --    ,[FILE_RUN_DATE]        ,[PAID_YEAR]        ,[PAID_QTR]     ,Status  )  select     isnull(md.DataSource,'N/A') as DataSource   ,od.NHMemberID   ,od.ordernumber   ,NULL as extractdate   ,'CSH' Client_Code   ,isnull(isnull(md.FirstName,od.MemberFirstName),'') MEM_FIRST_NAME   ,isnull(md.MiddleInitial,'') MEM_MID_INIT   ,isnull(isnull(md.LastName,od.Memberlastname),'') MEM_LAST_NAME   ,isnull(bcw.GroupNbr,'') CARRIER_ID --groupId   ,isnull(bcw.LOB,'') ACCOUNT_ID --subgroupId   ,isnull(md.GroupNbr,'') GROUP_ID    ,cast(md.DOB as date) [DATE_OF_BIRTH]   ,isnull(md.SubscriberID,'') [MEMBER_ID]   ,isnull(od.OA_ProductPrice,0) [CHG_AMT] --oa_productprice   ,isnull((isnull(od.OA_BenefitAmount,0) + isnull(od.B_EligibleBenefits,0) + isnull(od.B_EligibleBenefits_Left,0) + isnull(od.B_EligibleBenefits_Right,0)),0) [APPROVED_AMT] --B_BenefitAppliedAmount   ,isnull((isnull(od.[B_AppliedBenefits],0)+isnull(od.[B_AppliedBenefits_Left],0)+isnull(od.[B_AppliedBenefits_Right],0)+isnull(od.[Old_BenefitApplied],0)),0)  [PAID_AMT] ----b_benefitappliedamount   --,LEFT(isnull('','')+space(20),20) [SVC_CAT] --non   --,LEFT(isnull('000000000000','000000000000')+space(12),12) [INN_DED_AMT] --000000000000   ,isnull(od.OA_MemberResponsibleAmount,0) [INN_MOOP_AMT] --oa_memberresponsibleamount --000000000000   --,LEFT(isnull(replace(od.OA_MemberResponsibleAmount,0,null),'000000000000')+space(12),12) [INN_MOOP_AMT] --oa_memberresponsibleamount --000000000000   --,LEFT(isnull('000000000000','000000000000')+space(12),12) [OON_DED_AMT] --000000000000   --,LEFT(isnull('000000000000','000000000000')+space(12),12) [OON_MOOP_AMT] --000000000000   --,LEFT(isnull('000000000000','000000000000')+space(12),12) as  [MSA_TOTAL] --000000000000   ,isnull(cast(isnull(datepart(YYYY,isnull(isnull(od.HA_PODate,od.CROS_PODate),od.EM_PODate)),0) as varchar(4)),'0') [PLAN_YEAR] --ha_PODate,cros_podate,em_podate  -- ,LEFT(convert(varchar, getdate(), 112)+space(10),10)  as [FILE_RUN_DATE]    ,isnull(cast(isnull(datepart(YYYY,isnull(isnull(od.HA_PODate,od.CROS_PODate),od.EM_PODate)),0) as varchar(4)),'0') [PAID_YEAR] --ha_PODate,cros_podate,em_podate   ,isnull(cast(isnull(datepart(Q,isnull(isnull(od.HA_PODate,od.CROS_PODate),od.EM_PODate)),0) as varchar(1)),'
CREATE FUNCTION [elig].[GetValidateStageDataCondition] (   @ClientCode VARCHAR(20)   ,@FileType VARCHAR(50)   )  RETURNS VARCHAR(1000)  AS  BEGIN   DECLARE mandatory_cursor CURSOR   FOR   SELECT SourceTable + '.' + SourceColumn    ,TargetTable + '.' + TargetColumn   FROM [elig].[EligibilityColumnValidation]   WHERE [MandatoryFlag] = 1    AND [FileType] = @FileType    AND [ClientCode] = @ClientCode;     DECLARE date_cursor CURSOR   FOR   SELECT SourceTable + '.' + SourceColumn    ,TargetTable + '.' + TargetColumn   FROM [elig].[EligibilityColumnValidation]   WHERE [DateFlag] = 1    AND [FileType] = @FileType    AND [ClientCode] = @ClientCode;     DECLARE @strWhereClause VARCHAR(max)   DECLARE @counter INT   DECLARE @Sql VARCHAR(max)     SET @counter = 1     DECLARE @sourceCol VARCHAR(100)   DECLARE @targetCol VARCHAR(100)     OPEN mandatory_cursor     FETCH NEXT   FROM mandatory_cursor   INTO @sourceCol    ,@targetCol     WHILE @@FETCH_STATUS = 0   BEGIN    IF @counter = 1     SET @strWhereClause = 'isnull(' + @sourceCol + ','''') = '''''    ELSE     SET @strWhereClause = @strWhereClause + '  OR isnull(' + @sourceCol + ','''') = '''''      FETCH NEXT    FROM mandatory_cursor    INTO @sourceCol     ,@targetCol      SET @counter = @counter + 1   END     CLOSE mandatory_cursor;     DEALLOCATE mandatory_cursor;     OPEN date_cursor     FETCH NEXT   FROM date_cursor   INTO @sourceCol    ,@targetCol     WHILE @@FETCH_STATUS = 0   BEGIN    SET @strWhereClause = @strWhereClause + '  OR isdate(isnull(nullif(' + @sourceCol + ',''''),getdate())) = 0 '      FETCH NEXT    FROM date_cursor    INTO @sourceCol     ,@targetCol      SET @counter = @counter + 1   END     CLOSE date_cursor;     DEALLOCATE date_cursor;     SET @strWhereClause = '(' + @strWhereClause + ')'     RETURN @strWhereClause  END  
  CREATE PROCEDURE [elig].[sp_elig_validate_xwalk_stage_data] (   @ClientCode VARCHAR(20)   ,@FileType VARCHAR(50)   ,@FileTrackID BIGINT   )  AS  BEGIN   DECLARE @procedureName VARCHAR(100) = 'sp_elig_validate_xwalk_stage_data'      Declare @eligStartDate date   Declare @sql varchar(max)   Declare @sqlwhere varchar(max)     select    @eligStartDate = eligStartDate   from elig.ClientCodes    where ClientCode = @ClientCode       DECLARE xwalk_cursor CURSOR -- SD -- can we change cursor name to WhereClause cursor to align with function name? and rename where_cursor in [dbo].[get834ChangeClause] to ChangeClause cursor   FOR   SELECT SourceTable + '.' + SourceColumn    ,XWalkTable + '.' + XWalkColumn   FROM [elig].[EligibilityColumnValidation]   WHERE [XWalkFlag] = 1    AND [FileType] = @FileType    AND [ClientCode] = @ClientCode;;     DECLARE @strWhereClause VARCHAR(2000)   DECLARE @counter INT     SET @counter = 1     DECLARE @sourceCol VARCHAR(100)   DECLARE @targetCol VARCHAR(100)     OPEN xwalk_cursor     FETCH NEXT   FROM xwalk_cursor   INTO @sourceCol    ,@targetCol     WHILE @@FETCH_STATUS = 0   BEGIN    IF @counter = 1     SET @strWhereClause = 'isnull(' + @sourceCol + ','''') = isnull(' + @targetCol + ','''')'    ELSE     SET @strWhereClause = @strWhereClause + '  AND isnull(' + @sourceCol + ','''') = isnull(' + @targetCol + ','''')'      FETCH NEXT    FROM xwalk_cursor    INTO @sourceCol     ,@targetCol      SET @counter = @counter + 1   END     CLOSE xwalk_cursor;     DEALLOCATE xwalk_cursor;        set @sql = 'update elig.stgEligBenefitData set recordstatus = ''ERR_XWALK'' where stgEligBenefitData.filetrackid = ' + convert(VARCHAR, @FileTrackId) + ' and  stgEligBenefitData.RecordStatus = ''ZZ'' and   not exists (select 1 from elig.benefitCrossWalk where  BenefitCrossWalk.ClientCode = '''+ @ClientCode + ''' and  ' + @strWhereClause + ' )'      print(@sql)        exec(@sql)          PRINT ('Insert details')     INSERT INTO [elig].[errEligBenefitData] (    [FileTrackID]    ,[DataSource]    ,[RecordStatus]    ,[LastName]    ,[MiddleInitial]    ,[FirstName]    ,[DOB]    ,[SSN]    ,[SubscriberID]    ,[MemberSuffix]    ,[GroupNbr]    ,[BenefitStartDate]    ,[BenefitEndDate]    ,[SubGroupNbr]    ,[FamilyLinkID]    ,[AlternateID]    ,[MedicaidID]    ,[MedicareID]    ,[ClientMemberNumber]    ,ContractNbr    ,[PBPID]    ,[ProductID]    ,[BenefitLevel]    ,[Language]    ,[Gender]    ,[HomePhoneNbr]    ,[OtherPhoneNbr]    ,MemberEmail    ,[Address1]    ,[Address2]    ,[City]    ,[State]    ,[ZipCode]    ,[MailingAddress1]    ,[MailingAddress2]    ,[MailingCity]    ,[MailingState]    ,[MailingZipCode]    ,[OtherAddress1]    ,[OtherAddress2]    ,[OtherCity]    ,[OtherState]    ,[OtherZipCode]    ,[OtherAddressType]    ,[SubscriberIndFlag]    ,[RelationShipCode]    ,[MaintenanceType]    ,[MaintenanceReason]    ,[BenefitStatus]    ,[MedicarePlanCode]    ,[EligReasonCode]    ,[COBRAEvent]    ,[EmploymentStatusCode]    ,[StudentStatusCode]    ,[HandicapInd]    ,[DisabilityType]    ,[MedicalCodeQualifier]    ,[MedicalCode]    ,[MaintenanceCode]    ,[InsuranceLineCode]    ,[CoverageLevel]    ,[LateEnrollment]    ,[CoInsurance]    ,[CoPayment]    ,[Deductible]    ,[Premium]    ,[SpendDown]    ,[LineNbr]    ,[PCPName]    ,[PCPNPI]    ,[PCPEffDate]    ,[PCPTermDate]    ,[PCPAddress1]    ,[PCPAddress2]    ,[PCPCity]    ,[PCPState]    ,[PCPZipCode]    ,[PCPBusinessPhone]    ,[COBFlag]    ,[COBCarrierName]    ,[COBPolicyNumber]    ,[COBGroup]    ,[COBBegin]    ,[COBEnd]    ,[COBRespcode]    ,[COBcode]    ,[COBServiceType]    ,[BusinessCategory]    ,[LineOfBusiness]    ,EligibilityStartDate    ,EligibilityEndDate    )   SELECT [FileTrackID]    ,[DataSource]    ,[RecordStatus]    ,[LastName]    ,[MiddleInitial]    ,[FirstName]    ,[DOB]    ,[SSN]    ,[SubscriberID]    ,[MemberSuffix]    ,[GroupNbr]    ,[BenefitStartDate]    ,[BenefitEndDate]    ,[SubGroupNbr]    ,[FamilyLinkID]    ,[AlternateID]    ,[MedicaidID]    ,[MedicareID]    ,[ClientMember
CREATE PROCEDURE [elig].[sp_Elig_Stats_Response_File]   @FileTrackId int  AS  begin    declare @maxFileNamelength int    --select @maxFileNamelength = max(len(isnull(stat.ELIG_STAT_FileName,ft.filename))) + 1  select @maxFileNamelength = max(len(ft.filename)) + 1  from elig.filetrack ft  --join elig.fileinfo fi on ft.FileInfoID = fi.FileInfoId  --left join ( select filename as ELIG_STAT_FileName,clientcode,snapshotflag,fromlocation,tolocation,isAckFileToFTP,FileExtension as STATFileExtension  --            from elig.fileinfo  --            where 1=1  --            and filetype = 'ELIG_STAT'  --            and direction = 'OUT'  --            and isAckFileToFTP = 'Y'  --) stat on fi.clientcode = stat.clientcode and fi.snapshotflag = stat.snapshotflag  where 1=1  and FileTrackID = @FileTrackId      select 1 as fororder, 'File_Date |'+ LEFT('Source File_Name'+space(@maxFileNamelength),@maxFileNamelength)  +'|Records_Received|Records_Processed|Records_NotProcessed|NewMembers|ChangedMembers|TerminatedMembers|TermedByAbsence' as outputText  union  --select 2, LEFT(ISNULL(convert(varchar(10),ft.DateReceived,101),'')+space(10),10)  + '|' +  select   2, LEFT(ISNULL(convert(varchar(10),CAST(ft.DateReceived AT TIME ZONE 'UTC'   AT TIME ZONE 'Eastern Standard Time' AS DATE),126),'')+space(10),10)  + '|' +                LEFT(ISNULL(ft.FileName,'')+space(@maxFileNamelength),@maxFileNamelength) + '|' +               left(isnull(cast(isnull(ft.RecordsReceived,0) as varchar(10)),'')+space(16),16) + '|' +               left(isnull(cast(isnull(ft.recordsprocessed,0) as varchar(10)),'')+space(17),17) + '|' +               left(isnull(cast(isnull(ft.RecordsErrored,0) as varchar(10)),'')+space(20),20)  + '|' +      left(isnull(cast(isnull(es.NewMembers,0) as varchar(10)),'')+space(10),10)  + '|' +      left(isnull(cast(isnull(es.ChangedMembers,0) as varchar(10)),'')+space(14),14)  + '|' +      left(isnull(cast(isnull(es.TerminatedMembers,0) as varchar(10)),'')+space(17),17)  + '|' +      left(isnull(cast(isnull(es.TermedByAbsence,0) as varchar(10)),'')+space(15),15)   from elig.FileTrack ft  left outer join elig.EligibilityStats es on (ft.FileTrackID = es.filetrackid and es.StatsType = 'GENERAL')  where 1=1  and ft.FileTrackID = @FileTrackId  --and ft.StatusCode = 400  order by 1    end  
  --exec [elig].[sp_Elig_Error_Response_File] 4206  CREATE PROCEDURE [elig].[sp_Elig_Error_Response_File]   @FileTrackId int  AS  begin  SET FMTONLY OFF    SET NOCOUNT ON    declare @sqlstr nvarchar(max),    @sqlstr2 nvarchar(max),    @ClientColumns nvarchar(max),    @mstrtableColumns nvarchar(max),          @isHeaderflag bit,    @ClientCode VARCHAR(20),    @FileInfoID VARCHAR(20),    @delimiter varchar(1)    select   @isHeaderflag = fi.IsHeaderRecord    ,@FileInfoID = ft.FileInfoID    ,@ClientCode = ft.ClientCode    ,@delimiter = case when isnull(fi.FileFormatValue,'') = '' then '|'         when isnumeric(fi.FileFormatValue) = 1  then '|' else  fi.FileFormatValue end   from elig.FileInfo fi  join elig.FileTrack ft on fi.FileInfoID = ft.FileInfoID and ft.ClientCode = fi.ClientCode  where 1=1  and ft.FileTrackID = @FileTrackId    create table #temp2 (fororder int, outputText varchar(max))    SELECT DISTINCT     SUBSTRING(          (              SELECT  @delimiter + ST1.ClientColumn AS [text()]              FROM [elig].[EligibilityColumnValidation] ST1              WHERE st1.ErrRptFlag >= 1     and ST1.ClientCode = ST2.ClientCode --and ST1.ID = ST2.ID              ORDER BY ST1.ErrRptFlag,ST1.ID              FOR XML PATH ('')          ), 2, 8000) [ClientColumns],   SUBSTRING(          (              SELECT '+'+char(39)+@delimiter+char(39)+'+isnull('+      case when substring(ST3.TargetColumn,1,6) = 'DTFlex' then 'convert(varchar(8),cast(' + ST3.TargetColumn +' as date),112)' else ST3.TargetColumn end     +',' +char(39)++char(39)+')'  AS [text()]              FROM [elig].[EligibilityColumnValidation] ST3              WHERE st3.ErrRptFlag >= 1     and ST3.ClientCode = ST2.ClientCode --and ST1.ID = ST2.ID              ORDER BY ST3.ErrRptFlag,ST3.ID              FOR XML PATH ('')          ), 6, 8000) [TargetColumns]    into #temp  FROM [elig].[EligibilityColumnValidation] ST2  where 1=1  and ST2.ClientCode = @ClientCode  and ST2.FileType = 'ELIG'  and st2.ErrRptFlag >= 1    select @ClientColumns = ClientColumns ,      @mstrtableColumns = TargetColumns  from #temp  where 1=1    insert into #temp2 select 1, 'Description|'+ @ClientColumns    --select 'sujay',@ClientColumns,@mstrtableColumns          set @sqlstr = 'insert into #temp2     select 2, substring(ed.[Description],3,len(ed.[Description])) +' +char(39)+@delimiter+char(39)+'+' + @mstrtableColumns + '       from elig.errEligBenefitData e      left join (         SELECT DISTINCT ST2.errEligID,            (         SELECT'+char(39)+'; '+char(39)+'+ST1.Description  AS [text()]        FROM elig.errEligBenefitDataDetails ST1        WHERE ST1.errEligID = ST2.errEligID        ORDER BY ST1.errEligID        FOR XML PATH ('+char(39)+''+char(39)+')       ) [Description]           FROM elig.errEligBenefitDataDetails ST2        where 1=1) ed on e.errEligID = ed.errEligID         where 1=1         and e.FileTrackID = ' + cast(@FileTrackId as varchar)    --  select @sqlstr    EXEC sp_executesql @sqlstr       set @sqlstr2 ='select fororder,cast(LTRIM(RTRIM(outputText)) as varchar(max)) as outputText    from #temp2    where 1=1    order by fororder'        EXEC sp_executesql @sqlstr2    WITH RESULT SETS    (     (     fororder int,     outputText VARCHAR(max)     )    )    drop table #temp  drop table #temp2  --exec elig.sp_Elig_Error_Response_File 0  --exec elig.sp_Elig_Error_Response_File 10  end    
CREATE  PROCEDURE [elig].[sp_load_elig_stats_bkp_20201108_before_CF] (@FileTrackID BIGINT)  AS  BEGIN   DECLARE @procedureName VARCHAR(100) = 'sp_load_elig_stats'   DECLARE @DataSource NVARCHAR(50)   DECLARE @NewMembers INTEGER   DECLARE @TerminatedMembers INTEGER   DECLARE @TermByAbsence INTEGER   DECLARE @ChangedMembers INTEGER   DECLARE @LogMessage VARCHAR(max)   DECLARE @ClientCode VARCHAR(100)   DECLARE @FileInfoID BIGINT   DECLARE @FileID BIGINT   DECLARE @fullFile INT   Declare @sql nvarchar(max)   DECLARE @stepName VARCHAR(200)   DECLARE @strNHLink VARCHAR(500)   DECLARE @STGCurrentActiveCnt int   DECLARE @STGCurrentandFutureActiveCnt int  --- Version 1.00 -- 01/6/2020 - Raj Sareddy -- New Procedure to insert stats  --- Version 1.01 -- 01/7/2020 - Raj Sareddy -- Added Carrier and Healthplan Stats  --- Version 1.02 -- 06/23/2020 - Raj/Srikanth -- Included Current and future active members in the file received     --BEGIN TRY   --BEGIN TRANSACTION sp_load_elig_stats       SET @stepName = '100 Get FileTrack Data'     EXEC elig.auditlog @ClientCode, @FileTrackID,@procedureName,@stepName,'S'      --- Get File Info from file track table for FileTrackID    SELECT @DataSource = Datasource     ,@FileInfoID = FileInfoID     ,@ClientCode = ClientCode    FROM elig.filetrack    WHERE FileTrackID = @FileTrackID         SET @strNHLink = [elig].[getLinkID](@ClientCode, 'ELIG')     SET @strNHLink = replace(@strNHLink,'mstrEligBenefitData.','')       SET @stepName = '150 NewMember Count'     EXEC elig.auditlog @ClientCode, @FileTrackID,@procedureName,@stepName,'S'      ---NEW MEMBERS    -- how about member changed and new member received in the same file    select @NewMembers = count(distinct NHLinkid) from elig.mstrEligBenefitData p1    where 1 = 1      and FileTrackId = @filetrackid      and DataSource = @datasource      and RecordStatus = 'NR'      and isactive = 1      and tobeprocessed = 'Y'      --and cast(getdate() as date) between RecordEffDate and RecordEndDate      and not exists ( select 1 from elig.mstrEligBenefitData p2          where 1 = 1            and p1.NHLinkid = p2.NHLinkid            and not (p2.FileTrackId >= @filetrackid)            and p2.DataSource = @datasource )       SET @stepName = '200 Terminated Members Count'     EXEC elig.auditlog @ClientCode, @FileTrackID,@procedureName,@stepName,'S'      ---Terminated MEMBERS    SET @SQL =    'select @x = count(distinct '+  @strNHLink + ' ) from elig.stgEligBenefitData p1    where 1 = 1      and FileTrackId = ' + cast(@filetrackid as varchar) +      ' and DataSource = ''' + @datasource +     ''' and RecordStatus not like ''ERR_%''      and RecordStatus in (''NR'',''CH'') -- SAFTEY CHECK CONDITION -- Need this condition since we dont want NC records       and case when isdate(BenefitEndDate)=1 then cast(BenefitEndDate as date) else getdate()+1 end <= cast(getdate() as date) '      PRINT @SQL    exec sp_executesql @SQL, N'@x int out', @TerminatedMembers out       SET @stepName = '250 Term By Absence Count'     EXEC elig.auditlog @ClientCode, @FileTrackID,@procedureName,@stepName,'S'      -- Termed By Absence    select @TermByAbsence = count(distinct NHLinkid) from elig.mstrEligBenefitData p1    where 1 = 1       and DataSource = @datasource      and RecordStatus = 'TR'      and toBeProcessed = 'Y'      --and cast(ModifyDate as date) = cast(getdate() as date)      and not exists ( select 1 from elig.mstrEligBenefitData p2 --Should not have any active record for that member          where 1 = 1            and p1.NHLinkid = p2.NHLinkid            and p2.DataSource = @datasource            and p2.isActive = 1            and  cast(getdate() as date)  < BenefitEndDate   )    print @strNHLinK       SET @stepName = '300 Changed Members'     EXEC elig.auditlog @ClientCode, @FileTrackID,@procedureName,@stepName,'S'      -- Changed Members    SET @SQL =     'select @x = count(distinct '+  @strNHLink + ' ) from elig.stgEligBenefitData p1    where 1 = 1      and FileTrackId = ' + cas
      -- EXEC [elig].[sp_elig_load_stg_to_elig_EDI] 3279    CREATE PROCEDURE [elig].[sp_elig_load_stg_to_elig_EDI] (@FileTrackID BIGINT)    /*  --- Version 1.0  --  10/28/2020  -- Srikanth -- New Procedure to load standard EDI 834 data from elig.stgEligBenefitData to elig.mstrEligBenefitData                                                  MaintenanceTypeCode is given in 834 file which defines what action to be done on the member record              (021) Add new member, (001) Change existing member, (024) Terminate existing member coverage           */  AS  DECLARE @procedureName VARCHAR(100) = 'sp_elig_load_stg_to_elig'  DECLARE @strWhereClause VARCHAR(max)   DECLARE @strChangeClause VARCHAR(max)  DECLARE @strCrossWalkWhereClause VARCHAR(max)  DECLARE @strNHLink VARCHAR(500)  DECLARE @sql VARCHAR(max)  DECLARE @statusFlag NVARCHAR(10) = 'N'  DECLARE @dataSource NVARCHAR(50)  DECLARE @NewRecordCount INTEGER  DECLARE @RecordsProcessed INTEGER  DECLARE @ErrorRecordCount INTEGER  DECLARE @ChangeRecordCount INTEGER  DECLARE @DropRecordCount INTEGER  DECLARE @NoChangeRecordCount INTEGER  DECLARE @LogMessage VARCHAR(max)  DECLARE @UserName VARCHAR(100) = SUSER_SNAME()  DECLARE @ClientCode VARCHAR(100)  DECLARE @FileType VARCHAR(100)  DECLARE @SnapShot VARCHAR(100)  DECLARE @FileInfoID BIGINT  DECLARE @FileID BIGINT  DECLARE @fullFile INT  DECLARE @stepName VARCHAR(200);  declare @fileTrackStatusCode varchar(20)  DECLARE @strCrossWalk_STGMSTR_WhereClause VARCHAR(max)  DECLARE @strCrossWalk_STGMSTR_WhereClauseNE VARCHAR(max)      BEGIN   BEGIN TRY   BEGIN TRANSACTION elig_load_stg_to_elig_EDI     --- Get File Info from file track table for FileTrackID   SELECT @dataSource = Datasource    ,@snapshot = Snapshotflag    ,@FileInfoID = FileInfoID    ,@ClientCode = ClientCode    ,@FileType = FileType    ,@fileTrackStatusCode = StatusCode   FROM elig.filetrack   WHERE FileTrackID = @FileTrackID     -- Check if the file is already processed   if isnull(@fileTrackStatusCode,'999') <> '300'   begin    print('no file')    Return 0   end      PRINT (@ClientCode)   PRINT (@FileType)   PRINT (@FileTrackId)     SET @stepName = '110 Update BenefitEndDate'   EXEC elig.auditlog @ClientCode, @FileTrackID,@procedureName,@stepName,'S'     -- Update BenefitEndDate to default future date if missing in eligibility file   update elig.stgEligBenefitData    set BenefitEndDate = '20991231'   where FileTrackID = @FileTrackID   and isnull(BenefitEndDate,'') = ''        -- Check if we are processing FULL or DELTA file (since standard 834 sends us MaintenanceTypeCode, snapshot doesn't effect the way we do updates)   IF @snapshot = 'FULL'    SET @fullFile = 1   ELSE    SET @fullFile = 0       --- Get UniqueFlag where clause condition between elig Stage and Master tables ( UniqueFlag = 1 from elig.EligibilityColumnValidation table)   SET @strWhereClause = [elig].[getEligWhereClause](@ClientCode, @FileType)    PRINT @strWhereClause     /*   --- Get Change fileds comparison between elig Stage and Master tables ( ChangeFlag = 1 from elig.EligibilityColumnValidation table)   SET @strChangeClause = [elig].[getEligChangeClause](@ClientCode, @FileType)   */     --- Get CrossWalk Where condition between elig Stage and Master tables  ( XWalkFlag = 1 from elig.EligibilityColumnValidation table)   SET @strCrossWalkWhereClause = [elig].[getCrossWalkWhereClause](@ClientCode, @FileType)        -- Get NHLinkID - column combination to identify a member ( NHLinkFlag = 1 from elig.EligibilityColumnValidation table)    SET @strNHLink = [elig].[getLinkID](@ClientCode, @FileType)     --- Get XWalk columns between elig.stg and elig.mstr where clause condition between elig Stage and Master tables ( XWalkFlag = 1 from elig.EligibilityColumnValidation table)   SET @strCrossWalk_STGMSTR_WhereClause = [elig].[getCrossWalk_STGMSTR_WhereClause](@ClientCode, @FileType)     SET @strCrossWalk_STGMSTR_WhereClauseNE = REPLACE(@strCrossWalk_STGMSTR_WhereClause,'=','!=')          -- Validate for Errors
    -- exec [elig].[sp_Elig_TBA_Response_File] 4231  create PROCEDURE [elig].[sp_Elig_TBA_Response_File_bkup12152020]   @FileTrackId int  AS  begin  SET FMTONLY OFF    SET NOCOUNT ON    declare @sqlstr nvarchar(max),    @sqlstr2 nvarchar(max),    @ClientColumns nvarchar(max),    @mstrtableColumns nvarchar(max),          @isHeaderflag bit,    @ClientCode VARCHAR(20),    @FileInfoID VARCHAR(20),    @delimiter varchar(1)        -- Temp    --set @FileTrackId = 4231    select   @isHeaderflag = fi.IsHeaderRecord    ,@FileInfoID = ft.FileInfoID    ,@ClientCode = ft.ClientCode    ,@delimiter = case when isnull(fi.FileFormatValue,'') = '' then '|'         when isnumeric(fi.FileFormatValue) = 1  then '|' else  fi.FileFormatValue end   from elig.FileInfo fi  join elig.FileTrack ft on fi.FileInfoID = ft.FileInfoID and ft.ClientCode = fi.ClientCode  where 1=1  and ft.FileTrackID = @FileTrackId    create table #temp2 (fororder int, outputText varchar(max))    SELECT DISTINCT     SUBSTRING(          (              SELECT  @delimiter + ST1.ClientColumn AS [text()]              FROM [elig].[EligibilityColumnValidation] ST1              WHERE st1.TBARptFlag >= 1     and ST1.ClientCode = ST2.ClientCode --and ST1.ID = ST2.ID              ORDER BY ST1.TBARptFlag,ST1.ID              FOR XML PATH ('')          ), 2, 8000)  [ClientColumns],   SUBSTRING(          (              SELECT '+'+char(39)+@delimiter+char(39)+'+isnull(cast('+      case when substring(ST3.TargetColumn,1,6) = 'DTFlex' then 'convert(varchar(8),cast(' + ST3.TargetColumn +' as date),112)' else ST3.TargetColumn end     +' as nvarchar(100)),' +char(39)+char(39)+')'  AS [text()]              FROM [elig].[EligibilityColumnValidation] ST3              WHERE st3.TBARptFlag >= 1     and ST3.ClientCode = ST2.ClientCode --and ST1.ID = ST2.ID              ORDER BY ST3.TBARptFlag,ST3.ID              FOR XML PATH ('')          ), 6, 8000)  [TargetColumns]    into #temp  FROM [elig].[EligibilityColumnValidation] ST2  where 1=1  and ST2.ClientCode = @ClientCode  and ST2.FileType = 'ELIG'  and st2.TBARptFlag >= 1    --SELECT * FROM #TEMP    select @ClientColumns = ClientColumns  ,      @mstrtableColumns = TargetColumns   from #temp  where 1=1    insert into #temp2 select 1, 'Description|'+ @ClientColumns    --select 'sujay',@ClientColumns,@mstrtableColumns          set @sqlstr = 'insert into #temp2     select 2, ''Terminated By Absence'' +' +char(39)+@delimiter+char(39)+'+' + @mstrtableColumns + '       from elig.tbaEligBenefitData e        where 1=1      and e.FileTrackID = ' + cast(@FileTrackId as varchar)    --  select @sqlstr    EXEC sp_executesql @sqlstr       set @sqlstr2 ='select fororder,cast(LTRIM(RTRIM(outputText)) as varchar(max)) as outputText    from #temp2    where 1=1    order by fororder'        EXEC sp_executesql @sqlstr2    WITH RESULT SETS    (     (     fororder int,     outputText NVARCHAR(max)     )    )    drop table #temp  drop table #temp2  --exec elig.sp_Elig_Error_Response_File 0  --exec elig.sp_Elig_Error_Response_File 10  end    
CREATE FUNCTION [elig].[getCrossWalk_STGMSTR_WhereClause] (   @ClientCode VARCHAR(20)   ,@FileType VARCHAR(50)   )  RETURNS VARCHAR(max)  AS  BEGIN   DECLARE vendor_cursor CURSOR -- SD -- can we change cursor name to WhereClause cursor to align with function name? and rename where_cursor in [dbo].[get834ChangeClause] to ChangeClause cursor   FOR   SELECT SourceTable + '.' + SourceColumn    ,TargetTable + '.' + TargetColumn   FROM [elig].[EligibilityColumnValidation]   WHERE [XWalkFlag] = 1    AND [FileType] = @FileType    AND [ClientCode] = @ClientCode;;     DECLARE @strWhereClause VARCHAR(2000)   DECLARE @counter INT     SET @counter = 1     DECLARE @sourceCol VARCHAR(100)   DECLARE @targetCol VARCHAR(100)     OPEN vendor_cursor     FETCH NEXT   FROM vendor_cursor   INTO @sourceCol    ,@targetCol     WHILE @@FETCH_STATUS = 0   BEGIN    IF @counter = 1     SET @strWhereClause = 'isnull(' + @sourceCol + ','''') = isnull(' + @targetCol + ','''')'    ELSE     SET @strWhereClause = @strWhereClause + '  AND isnull(' + @sourceCol + ','''') = isnull(' + @targetCol + ','''')'      FETCH NEXT    FROM vendor_cursor    INTO @sourceCol     ,@targetCol      SET @counter = @counter + 1   END     CLOSE vendor_cursor;     DEALLOCATE vendor_cursor;     RETURN @strWhereClause  END  
      -- EXEC [elig].[sp_elig_load_stg_to_elig] 3892    CREATE PROCEDURE [elig].[sp_elig_load_stg_to_elig_bkupon12152020] (@FileTrackID BIGINT)  --- Version 1.0  --           - Mohan Bekkary -- New Procedure  --- Version 1.00 -- 01/01/2020 - Raj/ Srikanth -- Error Handling & Audit Log, Changed Phone Nbrs to varchar,   --- Version 1.01 -- 01/06/2020 - Raj Sareddy   -- Changed Error type to be ERR_,   --- Version 1.02 -- 01/07/2020 - Raj/ Srikanth -- Dates check and change to UTC datetime issue  --- Version 1.03 -- 01/07/2020 - Raj Sareddy   -- Added Stats Procedure  --- Version 1.04 -- 06/23/2020 - Raj/Srikanth -- Excluding RecordStatus like ERR  AS  DECLARE @procedureName VARCHAR(100) = 'sp_elig_load_stg_to_elig'  DECLARE @strWhereClause VARCHAR(max)   DECLARE @strChangeClause VARCHAR(max)  DECLARE @strCrossWalkWhereClause VARCHAR(max)  DECLARE @strNHLink VARCHAR(500)  DECLARE @sql VARCHAR(max)  DECLARE @statusFlag NVARCHAR(10) = 'N'  DECLARE @dataSource NVARCHAR(50)  DECLARE @NewRecordCount INTEGER  DECLARE @RecordsProcessed INTEGER  DECLARE @ErrorRecordCount INTEGER  DECLARE @ChangeRecordCount INTEGER  DECLARE @DropRecordCount INTEGER  DECLARE @NoChangeRecordCount INTEGER  DECLARE @LogMessage VARCHAR(max)  DECLARE @UserName VARCHAR(100) = SUSER_SNAME()  DECLARE @ClientCode VARCHAR(100)  DECLARE @FileType VARCHAR(100)  DECLARE @SnapShot VARCHAR(100)  DECLARE @FileInfoID BIGINT  DECLARE @FileID BIGINT  DECLARE @fullFile INT  DECLARE @stepName VARCHAR(200);  declare @fileTrackStatusCode varchar(20)  BEGIN   BEGIN TRY   BEGIN TRANSACTION elig_load_stg_to_elig     --- Get File Info from file track table for FileTrackID   SELECT @dataSource = Datasource    ,@snapshot = Snapshotflag    ,@FileInfoID = FileInfoID    ,@ClientCode = ClientCode    ,@FileType = FileType    ,@fileTrackStatusCode = StatusCode   FROM elig.filetrack   WHERE FileTrackID = @FileTrackID   --DONE --- RAJ added status code if status code not found then log saying no data found     if isnull(@fileTrackStatusCode,'999') <> '300'   begin    print('no file')    Return 0   end      PRINT (@ClientCode)   PRINT (@FileType)   PRINT (@FileTrackId)     SET @stepName = '110 Update BenefitEndDate'   EXEC elig.auditlog @ClientCode, @FileTrackID,@procedureName,@stepName,'S'     update elig.stgEligBenefitData    set BenefitEndDate = '20991231'   where FileTrackID = @FileTrackID   and isnull(BenefitEndDate,'') = ''     EXEC elig.auditlog @ClientCode, @FileTrackID,@procedureName,@stepName,'S'        IF @snapshot = 'FULL'    SET @fullFile = 1   ELSE    SET @fullFile = 0    --LATER LOW Priority RAJ MAY be move all clauses to one priority low   --- Get Mandatory Where condition between Stage and Master tales.   SET @strWhereClause = [elig].[getEligWhereClause](@ClientCode, @FileType)   PRINT @strWhereClause     --- Get Change fileds comparison between stage and elig master table   SET @strChangeClause = [elig].[getEligChangeClause](@ClientCode, @FileType)   --- Get CrossWalk Where condition between Stage and Master tales.   SET @strCrossWalkWhereClause = [elig].[getCrossWalkWhereClause](@ClientCode, @FileType)   SET @strNHLink = [elig].[getLinkID](@ClientCode, @FileType)        -- Validate for Span Errors in Stage Table   --BEGIN TRY    DECLARE @RC INT     SET @stepName = '120 Duplicate Check'   EXEC elig.auditlog @ClientCode, @FileTrackID,@procedureName,@stepName,'S'      EXECUTE @RC = [elig].[sp_elig_validate_duplicate_stage_data] @ClientCode     ,@FileType     ,@FileTrackID     SET @stepName = '130 OlD SPAN Check'   EXEC elig.auditlog @ClientCode, @FileTrackID,@procedureName,@stepName,'S'      EXECUTE @RC = [elig].[sp_elig_validate_oldspan_stage_data] @ClientCode     ,@FileType     ,@FileTrackID     SET @stepName = '160 Validate Other Stage Data'   EXEC elig.auditlog @ClientCode, @FileTrackID,@procedureName,@stepName,'S'      -- Validate data in stage for any data errors    EXECUTE @RC = [elig].[sp_elig_validate_stage_data] @ClientCode     ,@FileType     ,@FileTrackId     SET @st
    CREATE PROCEDURE [elig].[sp_Elig_Error_Response_File_bkp_20201108_beforeCF]   @FileTrackId int  AS  begin  SET FMTONLY OFF    SET NOCOUNT ON    declare @sqlstr nvarchar(max),    @sqlstr2 nvarchar(max),    @ClientColumns nvarchar(max),    @mstrtableColumns nvarchar(max),          @isHeaderflag bit,    @ClientCode VARCHAR(20),    @FileInfoID VARCHAR(20),    @delimiter varchar(1)    select   @isHeaderflag = fi.IsHeaderRecord    ,@FileInfoID = ft.FileInfoID    ,@ClientCode = ft.ClientCode    ,@delimiter = fi.FileFormatValue  from elig.FileInfo fi  join elig.FileTrack ft on fi.FileInfoID = ft.FileInfoID and ft.ClientCode = fi.ClientCode  where 1=1  and ft.FileTrackID = @FileTrackId    create table #temp2 (fororder int, outputText varchar(max))    SELECT DISTINCT     SUBSTRING(          (              SELECT  @delimiter + ST1.ClientColumn AS [text()]              FROM [elig].[EligibilityColumnValidation] ST1              WHERE ST1.ClientCode = ST2.ClientCode --and ST1.ID = ST2.ID              ORDER BY ST1.ID              FOR XML PATH ('')          ), 2, 8000) [ClientColumns],   SUBSTRING(          (              SELECT '+'+char(39)+@delimiter+char(39)+'+isnull('+ ST3.TargetColumn +',' +char(39)++char(39)+')'  AS [text()]              FROM [elig].[EligibilityColumnValidation] ST3              WHERE ST3.ClientCode = ST2.ClientCode --and ST1.ID = ST2.ID              ORDER BY ST3.ID              FOR XML PATH ('')          ), 6, 8000) [TargetColumns]    into #temp  FROM [elig].[EligibilityColumnValidation] ST2  where 1=1  and ST2.ClientCode = @ClientCode  and ST2.FileType = 'ELIG'    select @ClientColumns = ClientColumns ,      @mstrtableColumns = TargetColumns  from #temp  where 1=1    insert into #temp2 select 1, 'Description|'+ @ClientColumns    --select 'sujay',@ClientColumns,@mstrtableColumns          set @sqlstr = 'insert into #temp2     select 2, substring(ed.[Description],3,len(ed.[Description])) +' +char(39)+@delimiter+char(39)+'+' + @mstrtableColumns + '       from elig.errEligBenefitData e      left join (         SELECT DISTINCT ST2.errEligID,            (         SELECT'+char(39)+'; '+char(39)+'+ST1.Description  AS [text()]        FROM elig.errEligBenefitDataDetails ST1        WHERE ST1.errEligID = ST2.errEligID        ORDER BY ST1.errEligID        FOR XML PATH ('+char(39)+''+char(39)+')       ) [Description]           FROM elig.errEligBenefitDataDetails ST2        where 1=1) ed on e.errEligID = ed.errEligID         where 1=1         and e.FileTrackID = ' + cast(@FileTrackId as varchar)    --  select @sqlstr    EXEC sp_executesql @sqlstr       set @sqlstr2 ='select fororder,cast(LTRIM(RTRIM(outputText)) as varchar(max)) as outputText    from #temp2    where 1=1    order by fororder'        EXEC sp_executesql @sqlstr2    WITH RESULT SETS    (     (     fororder int,     outputText VARCHAR(max)     )    )    drop table #temp  drop table #temp2  --exec elig.sp_Elig_Error_Response_File 0  --exec elig.sp_Elig_Error_Response_File 10  end    
CREATE  PROCEDURE [elig].[sp_load_elig_stats_bkp_20201123_before_CF_TR_Update] (@FileTrackID BIGINT)  AS  BEGIN   DECLARE @procedureName VARCHAR(100) = 'sp_load_elig_stats'   DECLARE @DataSource NVARCHAR(50)   DECLARE @NewMembers INTEGER   DECLARE @TerminatedMembers INTEGER   DECLARE @TermByAbsence INTEGER   DECLARE @ChangedMembers INTEGER   DECLARE @LogMessage VARCHAR(max)   DECLARE @ClientCode VARCHAR(100)   DECLARE @FileInfoID BIGINT   DECLARE @FileID BIGINT   DECLARE @fullFile INT   Declare @sql nvarchar(max)   DECLARE @stepName VARCHAR(200)   DECLARE @strNHLink VARCHAR(500)   DECLARE @STGCurrentActiveCnt int   DECLARE @STGCurrentandFutureActiveCnt int  --- Version 1.00 -- 01/6/2020 - Raj Sareddy -- New Procedure to insert stats  --- Version 1.01 -- 01/7/2020 - Raj Sareddy -- Added Carrier and Healthplan Stats  --- Version 1.02 -- 06/23/2020 - Raj/Srikanth -- Included Current and future active members in the file received  --- Version 1.03 -- 11/08/2020 - Srikanth -- TR is included in terminated members query since Carefirst is giving us which records to terminate  --- Version 1.04 -- 11/18/2020 - Srikanth -- INNER JOIN for Carrier & Healthplan level stats is changed to FULL JOIN to insert records if either 'CurrentActiveMembers' or 'CurrentandFutureActiveMembers' exits     --BEGIN TRY   --BEGIN TRANSACTION sp_load_elig_stats       SET @stepName = '100 Get FileTrack Data'     EXEC elig.auditlog @ClientCode, @FileTrackID,@procedureName,@stepName,'S'      --- Get File Info from file track table for FileTrackID    SELECT @DataSource = Datasource     ,@FileInfoID = FileInfoID     ,@ClientCode = ClientCode    FROM elig.filetrack    WHERE FileTrackID = @FileTrackID         SET @strNHLink = [elig].[getLinkID](@ClientCode, 'ELIG')     SET @strNHLink = replace(@strNHLink,'mstrEligBenefitData.','')       SET @stepName = '150 NewMember Count'     EXEC elig.auditlog @ClientCode, @FileTrackID,@procedureName,@stepName,'S'      ---NEW MEMBERS    -- how about member changed and new member received in the same file    select @NewMembers = count(distinct NHLinkid) from elig.mstrEligBenefitData p1    where 1 = 1      and FileTrackId = @filetrackid      and DataSource = @datasource      and RecordStatus = 'NR'      and isactive = 1      and tobeprocessed = 'Y'      --and cast(getdate() as date) between RecordEffDate and RecordEndDate      and not exists ( select 1 from elig.mstrEligBenefitData p2          where 1 = 1            and p1.NHLinkid = p2.NHLinkid            and not (p2.FileTrackId >= @filetrackid)            and p2.DataSource = @datasource )       SET @stepName = '200 Terminated Members Count'     EXEC elig.auditlog @ClientCode, @FileTrackID,@procedureName,@stepName,'S'      ---Terminated MEMBERS    SET @SQL =    'select @x = count(distinct '+  @strNHLink + ' ) from elig.stgEligBenefitData p1    where 1 = 1      and FileTrackId = ' + cast(@filetrackid as varchar) +      ' and DataSource = ''' + @datasource +     ''' and RecordStatus not like ''ERR_%''      and RecordStatus in (''NR'',''CH'',''TR'') -- SAFTEY CHECK CONDITION -- Need this condition since we dont want NC records       and case when isdate(BenefitEndDate)=1 then cast(BenefitEndDate as date) else getdate()+1 end <= cast(getdate() as date) '      PRINT @SQL    exec sp_executesql @SQL, N'@x int out', @TerminatedMembers out       SET @stepName = '250 Term By Absence Count'     EXEC elig.auditlog @ClientCode, @FileTrackID,@procedureName,@stepName,'S'      -- Termed By Absence    select @TermByAbsence = count(distinct NHLinkid) from elig.mstrEligBenefitData p1    where 1 = 1       and DataSource = @datasource      and RecordStatus = 'TR'      and toBeProcessed = 'Y'      --and cast(ModifyDate as date) = cast(getdate() as date)      and not exists ( select 1 from elig.mstrEligBenefitData p2 --Should not have any active record for that member          where 1 = 1            and p1.NHLinkid = p2.NHLinkid            and p2.DataSource = @datasource            and p2.isActive = 1 
create  PROCEDURE [elig].[sp_load_elig_to_crm_bkp_beforeHAP_20200326] (@FileTrackID BIGINT)  AS  --- Version 1.00 -- 12/30/2019 - Raj Sareddy     -- New Procedure  --- Version 1.00 -- 01/01/2020 - Raj/ Srikanth   -- Validations and changes  --- Version 1.01 -- 01/07/2020 - Srikanth D      -- UPdated to be be processed to P  BEGIN   DECLARE @procedureName VARCHAR(100) = 'sp_load_elig_to_crm'   DECLARE @sys_user CHAR(30)    ,@sys_date DATETIME;   DECLARE @DataSource NVARCHAR(50)   DECLARE @NewRecordCount INTEGER   DECLARE @RecordsProcessed INTEGER   DECLARE @ErrorRecordCount INTEGER   DECLARE @ChangeRecordCount INTEGER   DECLARE @DropRecordCount INTEGER   DECLARE @NoChangeRecordCount INTEGER   DECLARE @LogMessage VARCHAR(max)   DECLARE @UserName VARCHAR(100) = SUSER_SNAME()   DECLARE @ClientCode VARCHAR(100)   DECLARE @FileInfoID BIGINT   DECLARE @FileID BIGINT   DECLARE @fullFile INT   Declare @sql varchar(max)   DECLARE @stepName VARCHAR(200);   --- Version 1.0 -- Raj 1/1/2020     BEGIN TRY   BEGIN TRANSACTION sp_load_elig_to_crm        --- Get File Info from file track table for FileTrackID    SELECT @DataSource = Datasource     ,@FileInfoID = FileInfoID     ,@ClientCode = ClientCode    FROM elig.filetrack    WHERE FileTrackID = @FileTrackID       SET @stepName = '100 Update MasterMemberId in same table'     EXEC elig.auditlog @ClientCode, @FileTrackID,@procedureName,@stepName,'S'      -- getting mastermemberid for the records where the member exists in the elig tables before with same NHLInkID    update t    set t.masterMemberID = (select s.MasterMemberID from (            select distinct NHLinkid, MasterMemberID from elig.mstrEligBenefitData            where 1 = 1            and DataSource = @DataSource            and masterMemberID is not null                ) s where s.NHLinkid = t.NHLinkid)     from elig.mstrEligBenefitData t     where 1 = 1     and FileTrackId = @FileTrackID     and masterMemberID is null     and toBeProcessed = 'Y'       SET @stepName = '110 Insert into Master.Members - New Members'     EXEC elig.auditlog @ClientCode, @FileTrackID,@procedureName,@stepName,'S'       -- Inserting into members where the member change in as new for the first time     INSERT INTO master.members (      FirstName      ,MiddleInitial      ,LastName      ,DateOfBirth      ,Gender      ,IsActive      ,NHMemberID      ,NHLinkID      ,DataSource      ,CreateDate      ,Createuser      ,ModifyDate      ,ModifyUser      )       SELECT FirstName      ,MiddleInitial      ,LastName      ,DOB      ,Gender      ,isactive      ,'ELIG' + convert(VARCHAR, NEXT VALUE FOR [elig].[NHMemberIDSeq]) NHMemberID --  temp value later will be updated to what ever it should be      ,NHLinkID      ,DataSource      ,getdate()      ,system_user      ,getdate()      ,system_user      from (        SELECT DISTINCT FirstName         ,MiddleInitial         ,LastName         ,DOB         ,Gender         ,1 isactive         ,NHLinkID         ,DataSource        FROM elig.mstrEligBenefitData eligEBD        WHERE 1 = 1         AND FileTrackId = @FileTrackID         AND tobeprocessed = 'Y'         AND MasterMemberID IS NULL       ) a      -- update NHMember back to what it should be before for unique key it was updated to ELIG ....     SET @stepName = '120 Update NHMemberID in Master Members'     EXEC elig.auditlog @ClientCode, @FileTrackID,@procedureName,@stepName,'S'     UPDATE [Master].[Members]    SET nhmemberid = 'NH' + RIGHT(YEAR(GETDATE()+7), 4) + FORMAT(memberid, '00000000') --    'NH2018'+ FORMAT(memberid,'00000000')    WHERE 1 = 1    AND DataSource = @dataSource    AND nhmemberid Like 'ELIG%'       SET @stepName = '130 Update Mastermember in elig.mstr for new members'     EXEC elig.auditlog @ClientCode, @FileTrackID,@procedureName,@stepName,'S'      -- update mastermemberid back into elig master for all records inserted above    /* Commented by DPSR    update t    set t.mastermemberid = (select distinct s.memberid from master.members s where s.NHLinkID = 
CREATE FUNCTION [elig].[GetStageErrorsSql] (   @ClientCode VARCHAR(20)   ,@FileType VARCHAR(50)   ,@FileTrackId BIGINT   )  RETURNS VARCHAR(max)  AS  BEGIN   --declare @FileInfoId BIGINT = 1   DECLARE mandatory_cursor CURSOR   FOR   SELECT SourceColumn   FROM [elig].[EligibilityColumnValidation]   WHERE [MandatoryFlag] = 1    AND [FileType] = @FileType    AND [ClientCode] = @ClientCode;     DECLARE date_cursor CURSOR   FOR   SELECT SourceColumn   FROM [elig].[EligibilityColumnValidation]   WHERE [DateFlag] = 1    AND [FileType] = @FileType    AND [ClientCode] = @ClientCode;     DECLARE @strWhereClause VARCHAR(max)   DECLARE @counter INT   DECLARE @Sql VARCHAR(max)   DECLARE @pivotsql VARCHAR(max)   DECLARE @pivotselectsql VARCHAR(max) = ''   DECLARE @pivotcolsql VARCHAR(max) = ''     SET @counter = 1     DECLARE @sourceCol VARCHAR(100)   DECLARE @targetCol VARCHAR(100)     OPEN mandatory_cursor     FETCH NEXT   FROM mandatory_cursor   INTO @sourceCol     WHILE @@FETCH_STATUS = 0   BEGIN    SET @pivotselectsql = @pivotselectsql + ', case isnull(' + @sourceCol + ' ,'''')  when '''' then ''' + right(space(60) + @sourceCol, 60) + ''' else ''NA'' end as ' + @sourceCol      IF @counter = 1    BEGIN     --   SET @strWhereClause = 'isnull(' + @sourceCol + ','''') = '''''     SET @pivotcolsql = @sourceCol    END    ELSE    BEGIN     --   SET @strWhereClause = @strWhereClause + '  OR isnull(' + @sourceCol + ','''') = '''''     SET @pivotcolsql = @pivotcolsql + ',' + @sourceCol    END      FETCH NEXT    FROM mandatory_cursor    INTO @sourceCol      SET @counter = @counter + 1   END     CLOSE mandatory_cursor;     DEALLOCATE mandatory_cursor;     OPEN date_cursor     FETCH NEXT   FROM date_cursor   INTO @sourceCol     WHILE @@FETCH_STATUS = 0   BEGIN    SET @pivotselectsql = @pivotselectsql + ', case isdate(isnull(nullif(' + @sourceCol + ',''''),getdate()))  when 0 then ''' + right(space(60) + @sourceCol + '_DATE', 60) + ''' else ''NA'' end as ' + @sourceCol + '_DATE'    SET @pivotcolsql = @pivotcolsql + ',' + @sourceCol + '_DATE'      --   SET @strWhereClause = @strWhereClause + '  OR isdate(' + @sourceCol + ')'     FETCH NEXT    FROM date_cursor    INTO @sourceCol   END     CLOSE date_cursor;     DEALLOCATE date_cursor;     SET @Sql = 'select errEligID,trim(iResult) from ( select errEligID ' + @pivotselectsql + ' from [elig].[errEligBenefitData] where fileTrackid =' + convert(VARCHAR, @FileTrackId) + '  ) d  unpivot( iresult for col in ( ' + @pivotcolsql + ')) unpiv where iResult <> ''NA'''     RETURN @Sql    --RETURN 'WGHWEWEFEWF' -- @Sql  END  
  CREATE FUNCTION [elig].[getCrossWalkWhereClause] (   @ClientCode VARCHAR(20)   ,@FileType VARCHAR(50)   )  RETURNS VARCHAR(max)  AS  BEGIN   DECLARE vendor_cursor CURSOR -- SD -- can we change cursor name to WhereClause cursor to align with function name? and rename where_cursor in [dbo].[get834ChangeClause] to ChangeClause cursor   FOR   SELECT TargetTable + '.' + TargetColumn    ,XWalkTable + '.' + XWalkColumn   FROM [elig].[EligibilityColumnValidation]   WHERE [XWalkFlag] = 1    AND [FileType] = @FileType    AND [ClientCode] = @ClientCode;;     DECLARE @strWhereClause VARCHAR(2000)   DECLARE @counter INT     SET @counter = 1     DECLARE @sourceCol VARCHAR(100)   DECLARE @targetCol VARCHAR(100)     OPEN vendor_cursor     FETCH NEXT   FROM vendor_cursor   INTO @sourceCol    ,@targetCol     WHILE @@FETCH_STATUS = 0   BEGIN    IF @counter = 1     SET @strWhereClause = 'isnull(' + @sourceCol + ','''') = isnull(' + @targetCol + ','''')'    ELSE     SET @strWhereClause = @strWhereClause + '  AND isnull(' + @sourceCol + ','''') = isnull(' + @targetCol + ','''')'      FETCH NEXT    FROM vendor_cursor    INTO @sourceCol     ,@targetCol      SET @counter = @counter + 1   END     CLOSE vendor_cursor;     DEALLOCATE vendor_cursor;     RETURN @strWhereClause  END  
CREATE FUNCTION [elig].[getEligWhereClause] (   @ClientCode VARCHAR(20)   ,@FileType VARCHAR(50)   )  RETURNS VARCHAR(max)  AS  BEGIN   DECLARE vendor_cursor CURSOR -- SD -- can we change cursor name to WhereClause cursor to align with function name? and rename where_cursor in [dbo].[get834ChangeClause] to ChangeClause cursor   FOR   SELECT SourceTable + '.' + SourceColumn    ,TargetTable + '.' + TargetColumn   FROM [elig].[EligibilityColumnValidation]   WHERE [UniqueFlag] = 1    AND [FileType] = @FileType    AND [ClientCode] = @ClientCode;;     DECLARE @strWhereClause VARCHAR(2000)   DECLARE @counter INT     SET @counter = 1     DECLARE @sourceCol VARCHAR(100)   DECLARE @targetCol VARCHAR(100)     OPEN vendor_cursor     FETCH NEXT   FROM vendor_cursor   INTO @sourceCol    ,@targetCol     WHILE @@FETCH_STATUS = 0   BEGIN    IF @counter = 1     SET @strWhereClause = 'isnull(' + @sourceCol + ','''') = isnull(' + @targetCol + ','''')'    ELSE     SET @strWhereClause = @strWhereClause + '  AND isnull(' + @sourceCol + ','''') = isnull(' + @targetCol + ','''')'      FETCH NEXT    FROM vendor_cursor    INTO @sourceCol     ,@targetCol      SET @counter = @counter + 1   END     CLOSE vendor_cursor;     DEALLOCATE vendor_cursor;     RETURN @strWhereClause  END  
CREATE FUNCTION [elig].[getEligChangeClause] (   @ClientCode VARCHAR(20)   ,@FileType VARCHAR(50)   )  RETURNS VARCHAR(max)  AS  BEGIN   DECLARE where_cursor CURSOR   FOR -- SD - Can we change cursor name to ChangeClause to align with function name and use where_cursor in [dbo].[get834WhereClause]   SELECT SourceTable + '.' + SourceColumn    ,TargetTable + '.' + TargetColumn   FROM [elig].[EligibilityColumnValidation]   WHERE [ChangeFlag] = 1    AND [FileType] = @FileType    AND [ClientCode] = @ClientCode;;     DECLARE @strWhereClause VARCHAR(max)   DECLARE @counter INT     SET @counter = 1     DECLARE @sourceCol VARCHAR(100)   DECLARE @targetCol VARCHAR(100)     OPEN where_cursor     FETCH NEXT   FROM where_cursor   INTO @sourceCol    ,@targetCol     WHILE @@FETCH_STATUS = 0   BEGIN    IF @counter = 1     SET @strWhereClause = 'isnull(' + @sourceCol + ','''') <> isnull(' + @targetCol + ','''')'    ELSE     SET @strWhereClause = @strWhereClause + '  OR isnull(' + @sourceCol + ','''') <> isnull(' + @targetCol + ','''')'      FETCH NEXT    FROM where_cursor    INTO @sourceCol     ,@targetCol      SET @counter = @counter + 1   END     CLOSE where_cursor;     DEALLOCATE where_cursor;     RETURN @strWhereClause  END  
CREATE  PROCEDURE [elig].[sp_load_elig_stats] (@FileTrackID BIGINT)  AS  BEGIN   DECLARE @procedureName VARCHAR(100) = 'sp_load_elig_stats'   DECLARE @DataSource NVARCHAR(50)   DECLARE @NewMembers INTEGER   DECLARE @TerminatedMembers INTEGER   DECLARE @TermByAbsence INTEGER   DECLARE @ChangedMembers INTEGER   DECLARE @LogMessage VARCHAR(max)   DECLARE @ClientCode VARCHAR(100)   DECLARE @FileInfoID BIGINT   DECLARE @FileID BIGINT   DECLARE @fullFile INT   Declare @sql nvarchar(max)   DECLARE @stepName VARCHAR(200)   DECLARE @strNHLink VARCHAR(500)   DECLARE @STGCurrentActiveCnt int   DECLARE @STGCurrentandFutureActiveCnt int     DECLARE @TerminatedMembers834 INTEGER    --- Version 1.00 -- 01/6/2020 - Raj Sareddy -- New Procedure to insert stats  --- Version 1.01 -- 01/7/2020 - Raj Sareddy -- Added Carrier and Healthplan Stats  --- Version 1.02 -- 06/23/2020 - Raj/Srikanth -- Included Current and future active members in the file received  --- Version 1.03 -- 11/08/2020 - Srikanth -- TR is included in terminated members query since Carefirst is giving us which records to terminate  --- Version 1.04 -- 11/18/2020 - Srikanth -- INNER JOIN for Carrier & Healthplan level stats is changed to FULL JOIN to insert records if either 'CurrentActiveMembers' or 'CurrentandFutureActiveMembers' exits  --- Version 1.03 -- 11/23/2020 - Srikanth -- 834 TR (024) is separated from terminated members query since Carefirst is giving us which records to terminate, new variable @TerminatedMembers834 counts terminations given by carrier in STG table  --- Version 1.04 -- 12/08/2020 - Srikanth -- Capture 'Terminated By Absence' records to send TBA response file     --BEGIN TRY   --BEGIN TRANSACTION sp_load_elig_stats       SET @stepName = '100 Get FileTrack Data'     EXEC elig.auditlog @ClientCode, @FileTrackID,@procedureName,@stepName,'S'      --- Get File Info from file track table for FileTrackID    SELECT @DataSource = Datasource     ,@FileInfoID = FileInfoID     ,@ClientCode = ClientCode    FROM elig.filetrack    WHERE FileTrackID = @FileTrackID         SET @strNHLink = [elig].[getLinkID](@ClientCode, 'ELIG')     SET @strNHLink = replace(@strNHLink,'mstrEligBenefitData.','')       SET @stepName = '150 NewMember Count'     EXEC elig.auditlog @ClientCode, @FileTrackID,@procedureName,@stepName,'S'      ---NEW MEMBERS    -- how about member changed and new member received in the same file    select @NewMembers = count(distinct NHLinkid) from elig.mstrEligBenefitData p1    where 1 = 1      and FileTrackId = @filetrackid      and DataSource = @datasource      and RecordStatus = 'NR'      and isactive = 1      and tobeprocessed = 'Y'      --and cast(getdate() as date) between RecordEffDate and RecordEndDate      and not exists ( select 1 from elig.mstrEligBenefitData p2          where 1 = 1            and p1.NHLinkid = p2.NHLinkid            and not (p2.FileTrackId >= @filetrackid)            and p2.DataSource = @datasource )       SET @stepName = '200 Terminated Members Count'     EXEC elig.auditlog @ClientCode, @FileTrackID,@procedureName,@stepName,'S'      ---Terminated MEMBERS    SET @SQL =    'select @x = count(distinct '+  @strNHLink + ' ) from elig.stgEligBenefitData p1    where 1 = 1      and FileTrackId = ' + cast(@filetrackid as varchar) +      ' and DataSource = ''' + @datasource +     ''' and RecordStatus not like ''ERR_%''      and RecordStatus in (''NR'',''CH'') -- SAFTEY CHECK CONDITION -- Need this condition since we dont want NC records       and case when isdate(BenefitEndDate)=1 then cast(BenefitEndDate as date) else getdate()+1 end <= cast(getdate() as date) '      PRINT @SQL    exec sp_executesql @SQL, N'@x int out', @TerminatedMembers out        ---Terminated MEMBERS - given by Carrier in 834 with MaintenanceType code 024 (Ex: Carefirst) -- Added by Srikanth on 20201123 to include terminated records given by carrier in 834 file    SET @SQL =    'select @x = count(distinct '+  @strNHLink + ' ) from elig.stgEligBenefitData p1    where 1
  -- EXEC [ELIG].[elig_file_load_ssis_sp_merge_stg_to_elig_HAP]     CREATE PROCEDURE [elig].[elig_file_load_ssis_sp_merge_stg_to_elig_HAP]      AS    BEGIN     BEGIN TRY   BEGIN TRANSACTION member_load_stg_to_elig_HAP    DECLARE @sys_user CHAR(30)      ,@sys_date DATETIME;      SET @sys_user = SYSTEM_USER  --SET @sys_date = CAST(GETDATE() AS DATE);    SET @sys_date = CAST(GETDATE() AT TIME ZONE 'UTC' AT TIME ZONE 'Eastern Standard Time' AS DATETIME);  -- Time in EST           UPDATE ELIG.Members SET ToBeProcessed = 'N' WHERE DataSource='ELIG_HAP' AND ToBeProcessed = 'Y'   UPDATE ELIG.Insurances SET ToBeProcessed = 'N' WHERE DataSource='ELIG_HAP' AND ToBeProcessed = 'Y'   UPDATE ELIG.AddressInfo SET ToBeProcessed = 'N' WHERE DataSource='ELIG_HAP' AND ToBeProcessed = 'Y'   UPDATE ELIG.PCP SET ToBeProcessed = 'N' WHERE DataSource='ELIG_HAP' AND ToBeProcessed = 'Y'   UPDATE ELIG.OtherInfo SET ToBeProcessed = 'N' WHERE DataSource='ELIG_HAP' AND ToBeProcessed = 'Y'            -- New Member - Start      -- Find New, Updates and Terminate records        SELECT a.NHLinkID     ,'N' AS MemberStatus     INTO #HAP_Elig_Member_Status     FROM     (      SELECT DISTINCT       HAP_NUMBER AS NHLinkID         FROM [ELIG].[StgELGHAP]      EXCEPT      SELECT       NHLinkID      FROM ELIG.Members      WHERE DataSource = 'ELIG_HAP'     ) a         INSERT INTO #HAP_Elig_Member_Status     SELECT a.NHLinkID     ,'U' AS MemberStatus     FROM     (      SELECT DISTINCT       HAP_NUMBER AS NHLinkID      FROM [ELIG].[StgELGHAP]      INTERSECT         SELECT       NHLinkID      FROM ELIG.Members      WHERE DataSource = 'ELIG_HAP'     ) a       INSERT INTO #HAP_Elig_Member_Status     SELECT a.NHLinkID     ,'T' AS MemberStatus     FROM      (      SELECT       NHLinkID      FROM ELIG.Members      WHERE DataSource = 'ELIG_HAP'      AND StatusFlag != 'T'         EXCEPT         SELECT DISTINCT       HAP_NUMBER AS NHLinkID         FROM [ELIG].[StgELGHAP]          ) a       --SELECT * FROM #HAP_Elig_Member_Status     -- drop table #HAP_Elig_Member_Status       -- Members     INSERT INTO ELIG.Members (     DataSource,      --CarrierMemberID,      FirstName,      LastName,     Title,     [MedicaidNbr],     [MedicareNbr],     [SSN],     [DOB],     [DateOfDeath],     [Gender],     [Race],     [Language],     [NHMemberID],     [MasterMemberID],     [ToBeProcessed],     [StatusFlag],     [ProcessedDate],     [CreateDate],     [CreateUser],     [ModifyDate],     [ModifyUser],     [NHLinkID],     [MiddleName]     )     SELECT      'ELIG_HAP',     --s.HAP_NUMBER,     s.FIRST_NAME,     s.LAST_NAME,     s.CONTACT_TITLE,     s.MEDICAID_RECIPIENT_ID,     s.MEDICARE_NUMBER,     NULL,     s.DATE_OF_BIRTH,     NULL,     s.GENDER,     NULL,     s.LANGUAGE_CODE,     NULL,     NULL,     'Y',     'N',     @sys_date,     @sys_date,     @sys_user,     @sys_date,     @sys_user,     s.HAP_NUMBER,     s.MIDDLE_INITIAL     FROM #HAP_Elig_Member_Status t     JOIN [ELIG].[StgELGHAP] s ON (s.HAP_NUMBER = t.NHLinkID and t.MemberStatus = 'N')       --Insurances     INSERT INTO ELIG.Insurances (     --NHInsuranceID,     DataSource,      InsMemberNbr,      GroupNbr,     SubGroupNbr,     Relationship,     PlanID,     PlanCode,     EligEffectiveDate,     EligTerminationDate,     SubscriberID,     --MemberSuffix,     [HealthPlanNumber],              [CarrierID],     [ToBeProcessed],     [StatusFlag],     [ProcessedDate],     [CreateDate],     [CreateUser],     [ModifyDate],     [ModifyUser],     [HealthPlanID],     mastermemberid,     memberinsuranceid,     [NHLinkID],     IsActive     )     SELECT      --NULL,     'ELIG_HAP',     s.HAP_NUMBER,     s.GROUP_ID,     s.SUBGROUP_ID,     s.RELATIONSHIP_CODE,     s.PLAN_ID,     s.PLAN_CODE,     CAST(s.EFFECTIVE_DATE AS DATE),     CAST(s.TERMINATION_DATE AS DATE),     s.SUBSCRIBER_ID+s.MEMBER_SUFFIX,     --s.MEMBER_SUFFIX,     NULL,     NULL,     'Y',     'N',     @sys_date,     @sys_date,     @sys_user,     @sys_date,     @sys_user,     NULL,     NULL,  
  CREATE FUNCTION [elig].[GetFileName] (@FileName varchar(200))  RETURNS VARCHAR(200)  AS  BEGIN  DECLARE @foo TABLE(TAGS VARCHAR(MAX));  Declare @RFileName VARCHAR(200);    INSERT @foo VALUES(@FileName);    WHILE @@ROWCOUNT > 0 BEGIN        UPDATE @foo    SET TAGS = STUFF(TAGS,CHARINDEX('<',TAGS),CHARINDEX('>',TAGS) - CHARINDEX('<',TAGS) + 1,'*')    WHERE TAGS LIKE '%<%>%'     END    SELECT @RFileName = TAGS FROM @foo;    RETURN @RFileName    END  
CREATE PROCEDURE [elig].[sp_elig_mark_span_errors_stage_data_bkp_20201216_before_VOID_Update] (   @ClientCode VARCHAR(20)   ,@FileType VARCHAR(50)   ,@FileTrackID BIGINT   )  AS  BEGIN   DECLARE @procedureName VARCHAR(100) = 'sp_elig_mark_span_errors_stage_data'   DECLARE @temptable VARCHAR(MAX)   DECLARE @sql VARCHAR(MAX)   DECLARE @statusFlag NVARCHAR(10) = 'N'   DECLARE @LogMessage VARCHAR(max)   DECLARE @UserName VARCHAR(100) = SUSER_SNAME()   DECLARE @errDetailsql VARCHAR(max)   DECLARE @spancol VARCHAR(100)   DECLARE @uniqueCols VARCHAR(1000)   DECLARE @stepName VARCHAR(200)      DECLARE span_cursor CURSOR   FOR -- SD - Can we change cursor name to ChangeClause to align with function name and use where_cursor in [dbo].[get834WhereClause]   SELECT SourceColumn   FROM [elig].[EligibilityColumnValidation]   WHERE [SpanFlag] = 1    AND [FileType] = @FileType    AND [ClientCode] = @ClientCode;     SET @stepName = '150 Span Errors - Started'   EXEC elig.auditlog @ClientCode, @FileTrackID,@procedureName,@stepName,'S'     PRINT ('Here')     DECLARE @counter INT = 1     OPEN span_cursor     PRINT ('here2')     FETCH NEXT   FROM span_cursor   INTO @spancol     PRINT ('here3')     WHILE @@FETCH_STATUS = 0   BEGIN    IF @counter = 1     SET @uniqueCols = @spancol    ELSE     SET @uniqueCols = @uniqueCols + '+''=='' +' + @spancol      FETCH NEXT    FROM span_cursor    INTO @spancol      SET @counter = @counter + 1   END     CLOSE span_cursor;     DEALLOCATE span_cursor;     set @temptable =     'WITH temp_spanrecords (stgeligid, UnID,benefitstartdate,benefitenddate)    AS (    select stgeligid,  ' + @uniqueCols + ' as UnID,benefitstartdate,benefitenddate from elig.stgEligBenefitData  where ' + @uniqueCols + '   in (select ' + @uniqueCols + ' from elig.stgEligBenefitData where 1 = 1 and filetrackid = ' + convert(VARCHAR, @FileTrackId) + ' AND RecordStatus = ''ZZ''  group by  ' + @uniqueCols + ' having count(*) > 1 )  and filetrackid = ' + convert(VARCHAR, @FileTrackId) +'  AND RecordStatus = ''ZZ'' '+    ')   '     -- set @temptable = 'select stgeligid,alternateid  + ''=='' + subscriberid  as UnID,benefitstartdate,benefitenddate from elig.stgEligBenefitData  where alternateid  + ''=='' + subscriberid  in (select alternateid + ''=='' + subscriberid from elig.stgEligBenefitData group by  alternateid + ''=='' + subscriberid having count(*) > 1)'   --SET @temptable = 'select stgeligid,  ' + @uniqueCols + ' as UnID,benefitstartdate,benefitenddate from elig.stgEligBenefitData  where ' + @uniqueCols + '   in (select ' + @uniqueCols + ' from elig.stgEligBenefitData where recordstatus =''ZZ'' and filetrackid = ' + convert(VARCHAR, @FileTrackId) + '  group by  ' + @uniqueCols + ' having count(*) > 1 ) AND recordstatus = ''ZZ'' and filetrackid = ' + convert(VARCHAR, @FileTrackId) +'  '     PRINT (@temptable)     SET @sql = @temptable + ' update elig.stgEligBenefitData set recordstatus = ''ERR_SPAN'' where  recordstatus = ''ZZ'' and filetrackid = ' + convert(VARCHAR, @FileTrackId) + ' and  '+ @uniqueCols +' in (select tab1.UnID from temp_spanrecords tab1 where exists (select 1 from temp_spanrecords tab2 where tab2.UnID = tab1.UnID and tab2.stgeligid <> tab1.stgeligid and cast(tab1.benefitstartdate as date) between cast(tab2.benefitstartdate as date) and cast(tab2.benefitenddate as date)))'     PRINT @sql     EXEC (@sql)     SET @stepName = '151 Span Errors - Write Error Records'   EXEC elig.auditlog @ClientCode, @FileTrackID,@procedureName,@stepName,'S'     --ADD Span Errors to Error Table   INSERT INTO [elig].[errEligBenefitData] (    [FileTrackID]    ,[DataSource]    ,[RecordStatus]    ,[LastName]    ,[MiddleInitial]    ,[FirstName]    ,[DOB]    ,[SSN]    ,[SubscriberID]    ,[MemberSuffix]    ,[GroupNbr]    ,[BenefitStartDate]    ,[BenefitEndDate]    ,[SubGroupNbr]    ,[FamilyLinkID]    ,[AlternateID]    ,[MedicaidID]    ,[MedicareID]    ,[ClientMemberNumber]    ,ContractNbr    ,[PBPID]    ,[ProductID]    ,[BenefitLevel]    ,[Language]    ,[Gen
CREATE FUNCTION [elig].[getLinkID] (   @ClientCode VARCHAR(20)   ,@FileType VARCHAR(50)   ) -- SD - please change parameter name to @fileInfoID to align with SP [elig].[sp_elig_load_stg_to_master] where we are passing it.  RETURNS VARCHAR(max)  AS  BEGIN   DECLARE vendor_cursor CURSOR -- SD -- can we change cursor name to WhereClause cursor to align with function name? and rename where_cursor in [dbo].[get834ChangeClause] to ChangeClause cursor   FOR   SELECT TargetTable + '.' + TargetColumn   FROM [elig].[EligibilityColumnValidation]   WHERE [NHLinkFlag] = 1    AND [FileType] = @FileType    AND [ClientCode] = @ClientCode   ORDER BY NHLinkOrder;     DECLARE @strWhereClause VARCHAR(2000)   DECLARE @counter INT     SET @counter = 1     DECLARE @sourceCol VARCHAR(100)   DECLARE @targetCol VARCHAR(100)     OPEN vendor_cursor     FETCH NEXT   FROM vendor_cursor   INTO @sourceCol     WHILE @@FETCH_STATUS = 0   BEGIN    IF @counter = 1     SET @strWhereClause = 'isnull(' + @sourceCol + ','''')'    ELSE     SET @strWhereClause = @strWhereClause + '+'+'''_'''+'+' + 'isnull(' + @sourceCol + ','''')'      FETCH NEXT    FROM vendor_cursor    INTO @sourceCol      SET @counter = @counter + 1   END     CLOSE vendor_cursor;     DEALLOCATE vendor_cursor;     RETURN @strWhereClause  END  
  CREATE FUNCTION [elig].[GetOutFileName] (             @FileName varchar(200)            ,@AFNameWithSubStrPosition varchar(200))  RETURNS VARCHAR(200)  AS  BEGIN  declare @AFileName varchar(200),    @SubStrPosition varchar(10),    @sqlstr varchar(200),    @StPosition int,    @EnPosition int,    @RFileName VARCHAR(200)      select @AFileName = substring(@AFNameWithSubStrPosition,1,CHARINDEX('~',@AFNameWithSubStrPosition)-1);    select @SubStrPosition = substring(@AFNameWithSubStrPosition,CHARINDEX('~',@AFNameWithSubStrPosition)+1,len(@AFNameWithSubStrPosition));      select  @StPosition = cast(substring(@SubStrPosition,1,CHARINDEX(',',@SubStrPosition)-1) as int),      @EnPosition = cast(substring(@SubStrPosition,CHARINDEX(',',@SubStrPosition)+1,len(@SubStrPosition)) as int);        select  @RFileName = @AFileName + substring(@FileName,@StPosition,@EnPosition);      RETURN @RFileName    END  
  CREATE PROCEDURE [elig].[sp_Process_detail]     @AppName varchar(50),  @MachName varchar(20),  @Type char(1),  @CurrStatus char(1) = '',  @StatusDesc varchar(1000) = '',  @InstanceID char(1) = '0',  @InputFile varchar(64) = '',  @OutputFile varchar(64) = '',  @NbrofRecs integer = 0,  @RecsAdded integer = 0,   @RecsEdited integer = 0,  @RecsDup integer =0    AS    select getdate()    /*    IF @CurrStatus = 'I'   SET @StatusDesc= '<font color=blue>' + @StatusDesc + '</font>'      IF @Type = 'I'   INSERT INTO elig.ProcessDetail (AppName,MachName,InstanceID,CurrStatus, StatusDesc,CurrDate,CurrTime,TranslationDate,       InputFile, OutputFile, NbrofRecs, RecsAdded, RecsEdited, RecsDup)    SELECT @AppName,@MachName,@InstanceID,@CurrStatus, @StatusDesc ,CONVERT(CHAR(10), GETDATE(), 111),getdate(),getdate(),       @InputFile, @OutputFile, @NbrofRecs, @RecsAdded, @RecsEdited, @RecsDup   WHERE 1=2   --VALUES (@AppName,@MachName,@InstanceID,@CurrStatus, @StatusDesc ,CONVERT(CHAR(10), GETDATE(), 111),getdate(),getdate(),   --    @InputFile, @OutputFile, @NbrofRecs, @RecsAdded, @RecsEdited, @RecsDup)    IF @Type ='D'   DELETE FROM elig.ProcessDetail    WHERE AppName=@AppName and MachName=@MachName and CurrDate=CONVERT(CHAR(10), GETDATE(), 111)   AND 1=2 -- Not using this functionality for now -- 20200317  */
  CREATE PROCEDURE [elig].[sp_Process_summary]     @AppName varchar(50),  @MachName varchar(20),  @Type char(1),  @CurrStatus char(1) = '',  @StatusDesc varchar(1000) = '',  @InstanceID char(1) = '0'    AS    select getdate()  /*  IF @Type = 'I'   INSERT INTO elig.ProcessSummary (AppName,MachName,InstanceID,CurrStatus, StatusDesc,CurrDate,CurrTime,TranslationDate)    SELECT @AppName,@MachName,@InstanceID,@CurrStatus,@StatusDesc,CONVERT(CHAR(10), GETDATE(), 111),getdate(),getdate()   WHERE 1=2   --VALUES (@AppName,@MachName,@InstanceID,@CurrStatus,@StatusDesc,CONVERT(CHAR(10), GETDATE(), 111),getdate(),getdate())    IF @Type = 'U'   UPDATE elig.ProcessSummary    SET CurrStatus = @CurrStatus,  StatusDesc=@StatusDesc,  CurrTime=getdate() , ProcessDuration = datediff(n,TranslationDate,getdate())    WHERE AppName = @AppName and MachName=@MachName and CurrDate=CONVERT(CHAR(10), GETDATE(), 111)   AND 1=2 -- Not using this functionality for now -- 20200317    IF @Type = 'D'   DELETE FROM elig.ProcessSummary    WHERE AppName=@AppName and MachName=@MachName and CurrDate=CONVERT(CHAR(10), GETDATE(), 111)   AND 1=2 -- Not using this functionality for now -- 20200317   */
--SELECT *FROM [execreports].[ClientReports_GetAppointmentDates](200013141,340906,25)    CREATE FUNCTION [execreports].[ClientReports_GetAppointmentDates]    ( @OrderId bigint = 0,     @MemberChartDataId bigint = 0,     @minorprocessId bigint = 0    )        RETURNS @T table(AppointmentDate nvarchar(50))    AS      BEGIN           DECLARE @MEMBERCHARTID BIGINT = 0     DECLARE @fittingdate varchar(10) = null         set @MEMBERCHARTID = (SELECT MEMBERCHARTID FROM PROVIDER.MemberChartData WHERE MemberChartDataId = @MemberChartDataId)                   IF @minorprocessId = 25     BEGIN      set @fittingdate = (SELECT TOP 1 JSON_VALUE(OrderTransactionData,'$.fittingDate') FROM ORDERS.OrderTransactionDetails WHERE OrderStatusCode = 'CLM' and isactive = 1 and OrderID = @OrderId ORDER BY 1 DESC)      IF @fittingdate IS NULL OR @fittingdate = ''      BEGIN              INSERT INTO @T(AppointmentDate)       SELECT JSON_VALUE(ProcessData,'$.appointmentDate') as appointmentDate       FROM PROVIDER.MemberChartData        WHERE MemberChartId = @MEMBERCHARTID and MinorProcessId = @minorprocessId      END      ELSE      BEGIN        INSERT INTO @T(AppointmentDate)       SELECT TOP 1 JSON_VALUE(OrderTransactionData,'$.fittingDate') FROM ORDERS.OrderTransactionDetails        WHERE OrderStatusCode = 'CLM' and isactive = 1 and OrderID = @OrderId ORDER BY 1 DESC      END     END     ELSE     BEGIN      INSERT INTO @T(AppointmentDate)      SELECT JSON_VALUE(ProcessData,'$.appointmentDate') as appointmentDate      FROM PROVIDER.MemberChartData       WHERE MemberChartId = @MEMBERCHARTID and MinorProcessId = @minorprocessId     END        RETURN    END  
  --exec [execreports].[sp_HAGeneral_rpt]   CREATE PROCEDURE [execreports].[sp_HAGeneral_rpt]   AS  BEGIN      truncate table [bireports].[HA_General_report_slowingData]      insert into [bireports].[HA_General_report_slowingData]    SELECT DISTINCT    IP.[ItemCode],IP.[UnitCOGS],IP.[PairCOGS],    DS.[HealthPlanContractId],DS.[EffectiveFrom],DS.[EffectiveTo], DS.[UnitPrice],DS.[PairPrice]    FROM  [catalog].[ItemMasterPriceList] IP    INNER JOIN [benefits].[FittingFeeHistory_SD] DS on DS.ItemCode=IP.ItemCode and DS.[EffectiveTo] >= '01/01/2020'    WHERE IP.PriceType='STANDARD' and IP.UnitCOGS > 0.01       SELECT [InsuranceCarrierName]        ,[CallCntToday]        ,[CallCntMTD]        ,[CallCntYTD]        ,[AppCntToday]        ,[AppCntMTD]        ,[AppCntYTD]        ,[OrderCntToday]        ,[OrderCntMTD]        ,[OrderCntYTD]        ,[UnitsCntToday]        ,[UnitsCntMTD]        ,[UnitsCntYTD]        ,[DollarToday]        ,[DollarMTD]        ,[DollarYTD]        ,[cogsToday]        ,[cogsMTD]        ,[cogsYTD]        ,[dispToday]        ,[dispMTD]        ,[disapYTD]        ,[memRespToday]        ,[memRespMTD]        ,[memRespYTD]    FROM [execreports].[FinalHAGeneralVer1]     where 1=1    order by 1    END  
  CREATE PROCEDURE [execreports].[SP_FinalOTCGeneralVer1_BY_EOD]  @EOD varchar(40)  AS   Declare @EODDate DateTime = CAST(CAST(@EOD + ' 23:54:59.760' as Datetime) AT TIME ZONE 'UTC'  AT TIME ZONE 'Eastern Standard Time' AS DATE)    --Declare @EOD varchar(40) =  '2020-03-31 23:54:59.760'  --Declare @EODDate DateTime = CAST(CAST(@EOD + ' 23:54:59.760' as Datetime) AT TIME ZONE 'UTC'  AT TIME ZONE 'Eastern Standard Time' AS DATE)    SELECT   CallYTD.CarrierName,   ISNULL(CallToday.[CallCnt],0) CallCntToday,  ISNULL(CallMTD.CallCntMTD, 0) CallCntMTD,  ISNULL(CallYTD.CallCntYTD, 0) CallCntYTD,    ISNULL(orderToday.[OrderCnt],0) OrderCntToday,  ISNULL(orderMTD.OrderCntMTD, 0) OrderCntMTD,  ISNULL(orderYTD.OrderCntYTD, 0) OrderCntYTD,    ISNULL(unitsToday.[OrderUnits],0) UnitsCntToday,  ISNULL(unitsMTD.UnitsCntMTD, 0) UnitsCntMTD,  ISNULL(unitsYTD.UnitsCntYTD, 0) UnitsCntYTD,    ISNULL(dollarToday.DollarToday,0) CatalogPriceToday,  ISNULL(dollarMTD.DollarMTD, 0) CatalogPriceMTD,  ISNULL(dollarYTD.DollarYTD, 0) CatalogPriceYTD,    (SELECT CASE WHEN CallYTD.CarrierName = 'NationsOTC Program' THEN ISNULL(dollarToday.DollarToday,0)*0.9 ELSE           CASE WHEN CallYTD.CarrierName = 'Ultimate Health Plan' THEN 3592     ELSE ISNULL(dollarToday.DollarToday,0) END END) ProductRevenueToday,    (SELECT CASE WHEN CallYTD.CarrierName = 'NationsOTC Program' THEN ISNULL(dollarMTD.DollarMTD,0)*0.9 ELSE           CASE WHEN CallYTD.CarrierName = 'Ultimate Health Plan' THEN ((FORMAT(CAST(GETDATE() AT TIME ZONE 'UTC'   AT TIME ZONE 'Eastern Standard Time' AS DATE),'dd'))-0)*3592     ELSE ISNULL(dollarMTD.DollarMTD,0) END END) ProductRevenueMTD,    (SELECT CASE WHEN CallYTD.CarrierName = 'NationsOTC Program' THEN ISNULL(dollarYTD.DollarYTD,0)*0.9 ELSE           CASE WHEN CallYTD.CarrierName = 'Ultimate Health Plan' THEN (DATEDIFF(day, CAST('01/01/2020' AS DATE), CAST(GETDATE() AT TIME ZONE 'UTC'   AT TIME ZONE 'Eastern Standard Time' AS DATE))+1)*3592     ELSE ISNULL(dollarYTD.DollarYTD,0) END END) ProductRevenueYTD,    ISNULL(ProductCostToday.ProductCostToday,0) ProductCostToday,   ISNULL(ProductCostMTD.ProductCostMTD,0) ProductCostMTD,   ISNULL(ProductCostYTD.ProductCostYTD,0) ProductCostYTD,     ISNULL(ShippingCostToday.ShippingCostToday,0) ShippingCostToday,   ISNULL(ShippingCostMTD.ShippingCostMTD,0) ShippingCostMTD,   ISNULL(ShippingCostYTD.ShippingCostYTD,0) ShippingCostYTD,       'TBD' TotalCostToday,  'TBD' TotalCostMTD,  'TBD' TotalCostYTD,    (SELECT CASE WHEN CallYTD.CarrierName IN ('Clear Spring','EON Health Plan') THEN ISNULL(orderToday.[OrderCnt],0)*3 ELSE           CASE WHEN CallYTD.CarrierName IN ('OptimaHealth','Troy') THEN ISNULL(orderToday.[OrderCnt],0)*4     ELSE 0 END END ) ShippingRevenueToday,  (SELECT CASE WHEN CallYTD.CarrierName IN ('Clear Spring','EON Health Plan') THEN ISNULL(orderMTD.OrderCntMTD,0)*3 ELSE           CASE WHEN CallYTD.CarrierName IN ('OptimaHealth','Troy') THEN ISNULL(orderMTD.OrderCntMTD,0)*4     ELSE 0 END END ) ShippingRevenueMTD,  (SELECT CASE WHEN CallYTD.CarrierName IN ('Clear Spring','EON Health Plan') THEN ISNULL(orderYTD.OrderCntYTD,0)*3 ELSE           CASE WHEN CallYTD.CarrierName IN ('OptimaHealth','Troy') THEN ISNULL(orderYTD.OrderCntYTD,0)*4     ELSE 0 END END ) ShippingRevenueYTD,    'TBD' MarginToday,  'TBD' MarginMTD,  'TBD' MarginYTD,    ISNULL(callOrdersMTD.CallOrderMTD,0) as CallOrdersMTD,  ISNULL(callOrdersYTD.CallOrderYTD,0) as CallOrdersYTD,  ISNULL(onlineOrdersMTD.OnlineOrderMTD,0) as OnlineOrdersMTD,  ISNULL(onlineOrdersYTD.OnlineOrderYTD,0) as OnlineOrdersYTD,  --FullFillment   ISNULL(fullfillToday.FullFilledToday,0) as FullFilledToday,  ISNULL(fullfillMTD.FullFilledMTD,0) as FullFilledMTD    ------------------------------------------------END    FROM  ---------------------------------->>>CALLS  --CallYTD   (   SELECT    [CarrierName] AS 'CarrierName', SUM([CallCnt]) AS 'CallCntYTD'   FROM [execreports].[CallSummaryDetailsByDateOTC] WHERE CALLDATE <= @EODDate AND   FORMAT(CAST(CALLDAT
    CREATE PROCEDURE [Gaming].[GetNHMemberDetails](  @POLICYNUMBER NVARCHAR(500),  @DOB DATETIME  )  AS  /*  TESTING  DECLARE @return_value int  EXEC @return_value = [Gaming].[GetNHMemberDetails]    @POLICYNUMBER = N'H45335533',    @DOB = N'1946-12-02'  SELECT 'Return Value' = @return_value  */  BEGIN   Select member.MemberProfileId,       member.FirstName,       member.LastName,       member.NHMemberId,       insurance.MemberInsuranceID,       insDetails.InsuranceNbr,       insDetails.InsurerInsuranceNbr   from provider.MemberProfiles member Join provider.MemberInsurances insurance on member.MemberProfileId = insurance.MemberProfileId    Join provider.MemberInsuranceDetails insDetails on insurance.MemberInsuranceID = insDetails.MemberInsuranceID   where insurance.IsActive = 1 AND insDetails.IsActive = 1 AND member.DateOfBirth = @DOB    AND (insDetails.InsuranceNbr = @POLICYNUMBER OR insDetails.InsurerInsuranceNbr = @POLICYNUMBER)  END  
-- 11/24/2020 - Damian Montero - New Report created on Production for DHC Hearing test on InAppBi    -- DHC McKesson - Hearing Test report    --exec [inappbi].[DHC_Hearing_test_report]    CREATE   PROCEDURE inappbi.DHC_Hearing_test_report  AS   BEGIN    -- All  Tests   DECLARE @StartDate DATE;  DECLARE @EndDate DATE;      drop table if EXISTS #MP_HearingTests    SET @StartDate='01/01/2020'; -- DATEADD(yy, DATEDIFF(yy, 0, GETDATE()), 0); -- Begining of the year  SET @EndDate = '11/30/2020';  -- DATEADD(yy, DATEDIFF(yy, 0, GETDATE()) + 1, -1); -- end of the year.    SET @StartDate= DATEADD(yy, DATEDIFF(yy, 0, GETDATE()), 0); -- Begining of the year  SET @EndDate =  DATEADD (dd, -1, DATEADD(mm, DATEDIFF(mm, 0, GETDATE()) + 1, 0)); -- DATEADD(yy, DATEDIFF(yy, 0, GETDATE()) + 1, -1); -- end of the year.          DECLARE @TodaysDate DATE;  SET @TodaysDate = @EndDate  SELECT DISTINCT  ds.DeviceId,  JSON_VALUE(dev.DeviceSettings,'$.NameOfClinic') ClinicName,  ds.DeviceSessionId, ds.SessionId  ,CASE WHEN ds.SessionStatus = 'S' THEN 'Initiated'        WHEN ds.SessionStatus = 'E' THEN 'Completed'           WHEN ds.SessionStatus = 'T' THEN 'Terminated' END TestStatus  ,CASE WHEN ds.SessionStatus = 'E' THEN 1           ELSE 0 END TestStatus_Completed  ,CAST(ds.StartDateTime AT TIME ZONE 'UTC' AT TIME ZONE 'Eastern Standard Time' AS DATETIME) Test_StartTime  ,CAST(ds.EndDateTime AT TIME ZONE 'UTC' AT TIME ZONE 'Eastern Standard Time' AS DATETIME) Test_EndTime  ,ds.IsActive , ds.[Name]  ,JSON_VALUE(ds.MemberInfo,'$.MemberId') NHMemberId_JSON  ,JSON_VALUE(ds.MemberInfo,'$.Name') MemberName_JSON  ,JSON_VALUE(ds.MemberInfo,'$.MemberInsurance') MemberInsurance_JSON  ,JSON_VALUE(ds.MemberInfo,'$.Languageselecteded') LanguageSelected_JSON  ,ds.NHMemberID  --,dsr.SessionId  ,JSON_VALUE(dsr.TestResultsData,'$.LeftEarSummary') LeftEarSummary  ,JSON_VALUE(dsr.TestResultsData,'$.RightEarSummary') RightEarSummary  ,CASE WHEN (JSON_VALUE(dsr.TestResultsData,'$.LeftEarSummary') <> 'Healthy Hearing' OR JSON_VALUE(dsr.TestResultsData,'$.RightEarSummary') <> 'Healthy Hearing') AND ds.SessionStatus = 'E' THEN 1        WHEN ds.SessionStatus != 'E' THEN NULL        ELSE 0 END Has_HearingLoss  ,CASE WHEN (JSON_VALUE(dsr.TestResultsData,'$.LeftEarSummary') <> 'Healthy Hearing' AND JSON_VALUE(dsr.TestResultsData,'$.RightEarSummary') = 'Healthy Hearing') AND ds.SessionStatus = 'E' THEN 1        WHEN (JSON_VALUE(dsr.TestResultsData,'$.LeftEarSummary') = 'Healthy Hearing' AND JSON_VALUE(dsr.TestResultsData,'$.RightEarSummary') <> 'Healthy Hearing') AND ds.SessionStatus = 'E' THEN 1           WHEN ds.SessionStatus != 'E' THEN NULL        ELSE 0 END Has_Unilateral_HearingLoss  ,CASE WHEN (JSON_VALUE(dsr.TestResultsData,'$.LeftEarSummary') <> 'Healthy Hearing' AND JSON_VALUE(dsr.TestResultsData,'$.RightEarSummary') <> 'Healthy Hearing') AND ds.SessionStatus = 'E' THEN 1         WHEN ds.SessionStatus != 'E' THEN NULL             ELSE 0 END Has_Bilateral_HearingLoss  ,dsr.IterationId--, dsr.AudiogramUrl  , dsr.DocumentObjectID  ,dt.MemberChartId, dt.MemberChartDataId--, dt.MemberProfileId  , dt.DocumentTypeCode  ,mp.MemberProfileId, mp.FirstName, mp.LastName  ,mi.InsuranceCarrierID, mi.InsuranceHealthPlanID--,mi.MemberInsuranceID,mi.InsuranceEffectiveDATE,mi.InsuranceEndDATE  ,ic.InsuranceCarrierName  ,hp.HealthPlanName  ,da.SessionID vccsessionID  ,da.CallPerfomanceID  ,ds.Email  INTO #MP_HearingTests  FROM dhc.DeviceSession ds  left join dhc.Devices dev on (dev.DeviceId = ds.DeviceId)  LEFT JOIN dhc.DeviceSessionResultLog dsr ON (dsr.SessionId = ds.SessionId)  --LEFT JOIN [dhc].[AudiogramReports] aud on (aud.AudiogramUrl = dsr.AudiogramUrl)  LEFT JOIN document.DocumentTransaction dt ON (dt.DocumentObjectID = dsr.DocumentObjectID)  LEFT JOIN provider.MemberProfiles mp ON (mp.NHMemberId = ds.NHMemberID)  LEFT JOIN provider.MemberInsurances mi ON (mi.MemberProfileId = mp.MemberProfileId AND ds.StartDATETime BETWEEN mi.InsuranceEffectiveDATE AND mi.InsuranceEndDATE)  --LEFT
  CREATE PROCEDURE [Insurance].[BMGetContractId]  (      -- Add the parameters for the stored procedure here      @InsuranceCarrierID BIGINT,      @InsuranceHealthPlanID BIGINT  )  AS  BEGIN  BEGIN TRY      -- SET NOCOUNT ON added to prevent extra result sets from      -- interfering with SELECT statements.      SET NOCOUNT ON     DECLARE @ValidateCheck BIGINT;   DECLARE @HealthPlanContractID BIGINT;   DECLARE @CONTRACTNAME NVARCHAR(100);   DECLARE @CONTRACTDESC NVARCHAR(100);        IF @InsuranceCarrierID IS NOT NULL and       @InsuranceHealthPlanID IS NOT NULL   BEGIN    IF @InsuranceHealthPlanID <> 99999    BEGIN     --1. Check validiti of Input Params        SELECT @ValidateCheck = (SELECT TOP 1 InsuranceCarrierID FROM [Insurance].[InsuranceHealthPlans]                             WHERE                               InsuranceCarrierID = @InsuranceCarrierID                               and InsuranceHealthPlanID = @InsuranceHealthPlanID              )          IF @ValidateCheck is NULL           RAISERROR ('Invalid CarriedID or HealthPlanID  ', -- Message text.                                  16, -- Severity.                                  1 -- State.                                 );               --2. Check if system has ContractID      SELECT  @HealthPlanContractID = (SELECT TOP 1       HealthPlanContractID      FROM       [Insurance].[HealthPlanContracts]      WHERE       InsuranceCarrierID = @InsuranceCarrierID       and InsuranceHealthPlanID = @InsuranceHealthPlanID)          IF (@HealthPlanContractID IS NULL)        -- Create New one if doesnt exist            BEGIN                               SELECT @CONTRACTNAME = ( CAST(year(getdate()) AS NVARCHAR)  + '-C' + CAST(@InsuranceCarrierID as NVARCHAR) + '-P' + CAST(@InsuranceHealthPlanID AS NVARCHAR) + '- ' +                                    (SELECT TOP 1 [HealthPlanName] from [Insurance].[InsuranceHealthPlans] where InsuranceHealthPlanID = @InsuranceHealthPlanID)                 );         SELECT @CONTRACTDESC = ( (SELECT TOP 1 [InsuranceCarrierName] from [Insurance].[InsuranceCarriers] where [InsuranceCarrierID] = @InsuranceCarrierID) + '- ' +                                     (SELECT TOP 1 [HealthPlanName] from [Insurance].[InsuranceHealthPlans] where InsuranceHealthPlanID = @InsuranceHealthPlanID)               )             INSERT INTO [Insurance].[HealthPlanContracts]         ([ContractName], [CreateDate], [CreateUser],          [Description], [EffectiveFromDate], [EffectiveToDate], [InsuranceCarrierID],          [InsuranceHealthPlanID], [IsActive], [ModifyDate], [ModifyUser])           VALUES                ( @CONTRACTNAME, getdate(), 'matrixUser',           @CONTRACTDESC, getdate(), getdate() + 2 * 365, @InsuranceCarrierID, @InsuranceHealthPlanID, 1, getdate(), 'matrixUser')           SET @HealthPlanContractID = SCOPE_IDENTITY();           END            select @HealthPlanContractID;    END    ELSE    BEGIN     DECLARE @InsuranceHealthPlanID_CRSR as BIGINT       DECLARE @HealthPlanCursor as CURSOR       SET @HealthPlanCursor = CURSOR FOR      SELECT        InsuranceHealthPlanId as InsuranceHealthPlanID_CRSR      FROM       Insurance.InsuranceHealthPlans      WHERE InsuranceCarrierID = @InsuranceCarrierID       OPEN @HealthPlanCursor       FETCH NEXT FROM @HealthPlanCursor INTO @InsuranceHealthPlanID_CRSR     WHILE @@FETCH_STATUS = 0     BEGIN      EXECUTE [Insurance].[BMGetContractId] @InsuranceCarrierID, @InsuranceHealthPlanID_CRSR      FETCH NEXT FROM @HealthPlanCursor INTO @InsuranceHealthPlanID_CRSR     END       CLOSE @HealthPlanCursor     DEALLOCATE @HealthPlanCursor    END               END    ELSE    BEGIN              RAISERROR ('CarriedID or HealthPlanID are missing ', -- Message text.                                  16, -- Severity.                                  1 -- State.                                 );      END    --IF ENDs  END TRY  BEGIN CATCH        DECLARE @ErrorMessage NVARCHAR(4000);        DECLARE @ErrorSeverity INT;        
Create PROCEDURE [Insurance].[GetInsuranceList]   AS              BEGIN              select *   from [Insurance].[InsuranceCarriers]   Where IsActive=1   and AllowAdditionalServices=1    END  
CREATE PROCEDURE [Insurance].[GetInsuranceMasterList]   AS              BEGIN              select  InsuranceCarrierId,InsuranceCarrierName,IsNhDiscount   from [Insurance].[InsuranceCarriers]   Where IsActive=1       END    
create Procedure [Insurance].[GetHealthPlanContracts]   @InsID int,   @PlanId int    AS  BEGIN      -- SET NOCOUNT ON added to prevent extra result sets from      -- interfering with SELECT statements.      SET NOCOUNT ON     select * from [Insurance].[HealthPlanContracts]    where insurancehealthplanid in     (select insurancehealthplanid from insurance.insurancehealthplans    where insurancecarrierid =@Insid and InsuranceHealthPlanID=@PlanId)    and Isactive=1  END  
Create Procedure [Insurance].[GetInsuranceContactData]   @InsID int,   @PlanId int    AS  BEGIN      -- SET NOCOUNT ON added to prevent extra result sets from      -- interfering with SELECT statements.      SET NOCOUNT ON    --declare @InsID int=4;   --declare @PlanId int =10;    select * from [Insurance].[ContractBenefits]    where HealthPlanContractid in     (select HealthPlanContractid from [Insurance].[HealthPlanContracts]    where InsuranceHealthPlanID=@PlanId and  insurancehealthplanid in     (select insurancehealthplanid from insurance.insurancehealthplans    where insurancecarrierid =@InsID))    and isactive=1  END  
CREATE PROCEDURE [Insurance].[GetInsuranceTollFreeNumbers]  AS  BEGIN    SELECT ROW_NUMBER() OVER(ORDER BY a.CarrierName ASC) AS RowNo, a.*from   (     SELECT  DISTINCT C.[InsuranceCarrierID] as CarrierId,C.[InsuranceCarrierName] CarrierName,T.[TollFreeNbr] as TollFreeNumber  FROM     [Insurance].[HealthPlanTollFreeNumbers] T      INNER JOIN [Insurance].[InsuranceCarriers] C ON T.[InsuranceCarrierID] = C.[InsuranceCarrierID]   ) a  ORDER BY a.CarrierName ASC    END    
  CREATE PROCEDURE [Insurance].[BMInsertUpdateBenefits]  (      -- Add the parameters for the stored procedure here      @HealthPlanContractID bigint,   @ContractBenefitID bigint,   @CSVData nvarchar(1000)  )  AS  BEGIN      SET NOCOUNT ON   DECLARE @INSERTQUERY AS NVARCHAR(4000);   DECLARE @UPDATEQRY AS NVARCHAR(4000);   DECLARE @sqlData NVARCHAR(1000);   DECLARE @sql NVARCHAR(2000);     set @sqlData = @CSVData +         ',getdate(),''matrixUser''' +         ',getdate(),''matrixUser''' +          ',1';     IF (@ContractBenefitID IS NOT NULL)   BEGIN      SET @UPDATEQRY = 'UPDATE  [Insurance].[ContractBenefits]    SET    WHERE ContractBenefitID = @ContractBenefitID'     END     ELSE   BEGIN      IF(@CSVDATA IS NOT NULL)    BEGIN      SET @INSERTQUERY = 'INSERT INTO [Insurance].[ContractBenefits]         (        [HealthPlanContractID]        ,[HealthPlanContractInsuranceHealthPlanID], [BenefitAmt],[BenefitAmtPer]        ,[IsMedicaidIsSecondaryCoverage],[IsPMNPM],[PMPMAmount], [InsurancePayerID]        ,[IsFileClaim],[IsClaimPayToPatient],[IsClaimEqualToProductListPricePerDevice]        ,[IsRebate],[RebatePercentage]        ,[HearingExamCoPay]        ,[IsPriorAuth]        ,[HearingAidCoPay],[HearingAidCoPayPer] ,[FittingCoPay]        ,[BenefitFrequencyYears] ,[BenefitFrequencyYearsBy]        ,[IsHearingAidBenefitVerificationRequired]        ,[IsAbilityToBalanceBillMember]        ,[IsDefaultBenefit]         ,CreateDate      ,CreateUser      ,ModifyDate      ,ModifyUser      ,IsActive) VALUES(' + @sqlData+')'                PRINT @INSERTQUERY           EXECUTE SP_EXECUTESQL @INSERTQUERY      END     END           END  
  CREATE PROCEDURE [Insurance].[BMInsertContractProductsAllPlans]               @InsuranceCarrierID BIGINT,          @CSVData nvarchar(1000)  AS  BEGIN    SET NOCOUNT ON;  -- 'Phonak','Audeo B90-Direct','Superior','Override',2075,650,800  DECLARE @sqlData NVARCHAR(1000);  DECLARE @sql NVARCHAR(2000);                     set  @sql = 'INSERT INTO  [Insurance].[ContractProducts]         (            BrandCode,       FamilyProductCode,       FamilyProductCatCode,       ProductAvailType,       PerDeviceMemberPrice,       PerDeviceDispensingFee,       PerDeviceCOGSPrice,       PerPairMemberPrice,       HealthPlanContractID,       CreateDate,       CreateUser,       ModifyDate,       ModifyUser,       IsActive,       FamilyProductCategoryFamilyProductID,       HealthPlanContractID1      ) '+ 'SELECT ' + @CSVData + ', CAST(HealthPlanContractID as NVARCHAR(10)), getdate(),''matrixUser'', getdate(),''matrixUser'', 1,NULL,NULL ' +        'FROM         Insurance.HealthPlanContracts         WHERE Insurance.HealthPlanContracts.InsuranceCarrierID =' + cast(@InsuranceCarrierID as nvarchar(10));       PRINT @sql    EXEC sp_executesql @sql    SELECT @sql  END  
  CREATE PROCEDURE [Insurance].[BMInsertContractProducts]               @HealthPlanContractID BIGINT,          @CSVData nvarchar(1000)  AS  BEGIN    SET NOCOUNT ON;  -- 'Phonak','Audeo B90-Direct','Superior','Override',2075,650,800  DECLARE @sqlData NVARCHAR(1000);  DECLARE @sql NVARCHAR(2000);    set @sqlData = @CSVData + ',' +                 CAST(@HealthPlanContractID as NVARCHAR(10)) + ',' +        'getdate(),''matrixUser''' + ',' +        'getdate(),''matrixUser''' + ',' +        '1' + ',NULL,NULL';                     set  @sql = 'INSERT INTO  [Insurance].[ContractProducts]         (            BrandCode,       FamilyProductCode,       FamilyProductCatCode,       ProductAvailType,       PerDeviceMemberPrice,       PerDeviceDispensingFee,       PerDeviceCOGSPrice,       PerPairMemberPrice,       HealthPlanContractID,       CreateDate,       CreateUser,       ModifyDate,       ModifyUser,       IsActive,       FamilyProductCategoryFamilyProductID,       HealthPlanContractID1      )  Values  ( ' + @sqlData + ')';    EXEC sp_executesql @sql    SELECT @sql  END  
  CREATE PROCEDURE [Insurance].[BMInsertUpdateProducts]      @HealthPlanContractID BIGINT,   @InsuranceCarrierID BIGINT,      @InsuranceHealthPlanID BIGINT,   @FamilyProductCode NVARCHAR(50),   @CSVData nvarchar(1000)   -- @Action nvarchar(1) -- I, Insert, U - Update  AS  BEGIN  BEGIN TRY      -- SET NOCOUNT ON added to prevent extra result sets from      SET NOCOUNT ON;       --1. Verify given @HealthPlanContractID belongs to same @InsuranceCarrierID and @InsuranceHealthPlanID       DECLARE @ValidateCheck BIGINT;    IF @InsuranceHealthPlanID <> 99999     SELECT @ValidateCheck = (SELECT TOP 1 InsuranceCarrierID FROM [Insurance].[HealthPlanContracts]            WHERE  [HealthPlanContractID]  = @HealthPlanContractID and              [InsuranceCarrierID]    = @InsuranceCarrierID and             [InsuranceHealthPlanID] = @InsuranceHealthPlanID )        ELSE    SET @ValidateCheck = 1       IF @ValidateCheck is NULL        RAISERROR ('Invalid CarriedID or HealthPlanID or  HealthPlanContractID  ', -- Message text.                                  16, -- Severity.                                  1 -- State.                                 );         --2. If InsuranceHealthPlanID = 99999 then delete all [FamilyProductCode] of that @HealthPlanContractID        IF @InsuranceHealthPlanID = 99999         BEGIN      -- 2a. Delete all existing records       DELETE FROM [Insurance].[ContractProducts]             WHERE [FamilyProductCode]     = @FamilyProductCode and              [HealthPlanContractID]  IN       ( SELECT [HealthPlanContractID] from  [Insurance].[HealthPlanContracts]          WHERE [InsuranceCarrierID] = @InsuranceCarrierID )           -- 2b. Insert the same for all Plans          EXECUTE [Insurance].[BMInsertContractProductsAllPlans]  @InsuranceCarrierID, @CSVData      END     --3. Else Delete only that product @HealthPlanContractID ,  [FamilyProductCatCode]     ELSE          BEGIN      -- 2a. Delete One existing product       DELETE FROM [Insurance].[ContractProducts]             WHERE [FamilyProductCode]     = @FamilyProductCode and              [HealthPlanContractID]  = @HealthPlanContractID                             EXECUTE [Insurance].[BMInsertContractProducts]  @HealthPlanContractID, @CSVData      END                  -- and Insert New Product       END TRY  BEGIN CATCH      DECLARE @ErrorMessage NVARCHAR(4000);        DECLARE @ErrorSeverity INT;        DECLARE @ErrorState INT;          SELECT             @ErrorMessage =  ERROR_MESSAGE(),            @ErrorSeverity = ERROR_SEVERITY(),            @ErrorState = ERROR_STATE();          -- Use RAISERROR inside the CATCH block to return error        -- information about the original error that caused        -- execution to jump to the CATCH block.        RAISERROR (@ErrorMessage, -- Message text.                   @ErrorSeverity, -- Severity.                   @ErrorState -- State.                   );    END CATCH  END        
CREATE PROCEDURE [Insurance].[SendPaymentReceiptFlag]  (    @orderid bigint  )  AS  BEGIN      -- SET NOCOUNT ON added to prevent extra result sets from      -- interfering with SELECT statements.      SET NOCOUNT ON   DECLARE @INSURANCECARRIERID BIGINT     SET @INSURANCECARRIERID = (SELECT JSON_VALUE(Memberdata, '$."insCarrierId"') AS InsuranceCarrierId FROM [Orders].[Orders] WHERE orderid = @orderid)       SELECT [IsAutoSendPaymentReceipt] FROM  [Insurance].[InsuranceCarriers] WHERE [InsuranceCarrierID] = @INSURANCECARRIERID    END    
-- =============================================  -- Author:      <Author, , Name>  -- Create Date: <Create Date, , >  -- Description: <Description, , >  -- =============================================  CREATE Procedure [Insurance].[GetInsuranceData]   @InsID int    AS  BEGIN      -- SET NOCOUNT ON added to prevent extra result sets from      -- interfering with SELECT statements.      SET NOCOUNT ON        -- Insert statements for procedure here           select * from insurance.insurancecarriers     where insurancecarrierid =@Insid      select * from insurance.insurancehealthplans    where insurancecarrierid =@Insid      select * from [Insurance].[HealthPlanContracts]    where insurancehealthplanid in     (select insurancehealthplanid from insurance.insurancehealthplans    where insurancecarrierid =@Insid)        select * from [Insurance].[ContractProducts]    where HealthPlanContractid in     (select HealthPlanContractid from [Insurance].[HealthPlanContracts]    where insurancehealthplanid in     (select insurancehealthplanid from insurance.insurancehealthplans    where insurancecarrierid =@Insid))        select * from [Insurance].[ContractBenefits]    where HealthPlanContractid in     (select HealthPlanContractid from [Insurance].[HealthPlanContracts]    where insurancehealthplanid in     (select insurancehealthplanid from insurance.insurancehealthplans    where insurancecarrierid =@Insid))  END  
-- =============================================  -- Author:      Mohan Nanduri  -- Create Date: 10 Oct 2020  -- Description: This Procedure will return all InComm API Logs associated to the Order  -- =============================================  CREATE PROCEDURE logs.OTCLogs   (      -- Add the parameters for the stored procedure here       @OrderId bigint  )  AS  BEGIN      -- SET NOCOUNT ON added to prevent extra result sets from      -- interfering with SELECT statements.      SET NOCOUNT ON  select '1. OrderData  -> ', * from Orders.Orders where OrderID  =  @orderId order by OrderID  select '2. OrderItem  -> ', * from Orders.OrderItems where OrderID = @orderId order by OrderID  select '3. OrderTran  -> ', * from Orders.OrderTransactionDetails where OrderID = @orderId order by OrderID  -- Get Limited Spend Requuest and Response   declare @data nvarchar(max) = (select  JSON_QUERY(OrderAmountData,'$.benefitTransactions') from Orders.Orders where OrderID=@orderId);  select '4. LimitedSpend Log -> ', * from logs.HttpMessages where RefId in (select JSON_VALUE(value, '$.transactionId') from OPENJSON(@data)) order by CreateDate desc  declare @CDate datetime    set @CDate = (select top 1 CreateDate from logs.HttpMessages where RefId in (select JSON_VALUE(value, '$.transactionId') from OPENJSON(@data)) order by CreateDate desc)    -- Get Benefit Enquiry Reqeuist and Respopnse   declare @CardNumber varchar(20)   set @CardNumber = (select JSON_VALUE(Content,'$.cardNumber') from logs.HttpMessages where    RefId in (select JSON_VALUE(value, '$.transactionId') from OPENJSON(@data))   and Uri like '%/api/OTC/Transact/LimitedSpend'   and Type='Request'   and Client='NationsOTC External API')  select '4a. BenefitEnquiry Log -> ', *  from logs.HttpMessages where RefId in (  select RefId from logs.HttpMessages where ISJSON(Content)=CAST(1 AS BIT) and JSON_VALUE(Content,'$.cardNumber')=@CardNumber and Uri like '%BenefitInq%'   and CreateDate between DATEADD(ms,-2500,@CDate) and @CDate  ) order by CreateDate desc    select '5. BenefitEnquiry Log -> ', *  from logs.HttpMessages where RefId in (  select RefId from logs.HttpMessages where ISJSON(Content)=CAST(1 AS BIT) and JSON_VALUE(Content,'$.cardNumber')=@CardNumber and Uri like '%BenefitInq%'   and cast(CreateDate as date) = (select cast(CreateDate as date) from Orders.Orders where OrderId=@OrderId)  ) order by CreateDate desc    END  
  CREATE Procedure [NDSync].[MemberProc] (  @NHMemberID AS varchar(50) ,  @Jdata nvarchar(max) OUTPUT)  AS  BEGIN          -- Insert statements for procedure here                 DECLARE @Ret_Var       INT,                 @Error_Code    INT,                 @Tran_Count_In INT         DECLARE @Warning VARCHAR(8000)           SELECT @Ret_Var = 0,                @Error_Code = 0,                @Tran_Count_In = @@TranCount,                @Warning = ''        BEGIN TRANSACTION         SELECT      @Jdata = (SELECT        m.NHMemberID 'Member.NHMemberID',        m.FirstName 'Member.FirstName',        m.LastName 'Member.LastName',     m.DateOfBirth 'Member.DateOfBirth',        m.MiddleInitial 'Member.MiddleInitial',        a.Address1 'Member.Address1',        a.Address2 'Member.Address2',        a.City 'Member.City',        a.State 'Member.State',        a.zipcode 'Member.zipcode',     p.phonenbr 'Member.PhoneNbr'      FROM [Master].[Members] m      LEFT OUTER JOIN [Master].[Addresses] a        ON (m.memberid = a.memberid        AND a.addresstypecode = 'PERM')      LEFT OUTER JOIN [Master].[PhoneNumbers] p        ON (m.memberid = p.memberid        AND p.phonetypecode = 'HOME')      WHERE 1 = 1      AND NHMemberID = @NHMemberID --'NH201700000003'      FOR JSON PATH       )   COMMIT TRANSACTION         -- check for errors                                       SELECT @Error_Code = @@Error           IF @Error_Code <> 0           BEGIN               SET @Ret_Var = CASE @Ret_Var                                WHEN 0 THEN @Error_Code                                ELSE @Ret_Var                              END               SET @Warning = @Warning + Error_message()                 GOTO __spreturn           END         __SPRETURN:           RETURN @Ret_Var       END;  
  CREATE Procedure [NDSync].[NHNDSyncDate]    @TableName AS varchar(250),  @NHID AS nvarchar(50),  @NDRefID AS bigint,  @SyncedDate AS DATETIME,  @Notes AS nvarchar(250) = NULL      AS  BEGIN    INSERT INTO NDSync.NHNDSync  (TableName, NHID, NDRefID, SyncedDate, Notes)  values  (@TableName, @NHID, @NDRefID, @SyncedDate, @Notes)    END  
-- =============================================  -- Author:  Mohan  -- Create date: 5th Feb 2018  -- Description: Gets HCP Details by HCPUserProfileId  -- =============================================  CREATE Procedure [Noble].[Get_physician]       @HCPUserProfileID bigint,   @ServiceLocationID bigint  AS  BEGIN   -- SET NOCOUNT ON added to prevent extra result sets from   -- interfering with SELECT statements.   SET NOCOUNT ON;        -- Insert statements for procedure here   SELECT TOP 1   a.[ModifyDate]    as Nations_Date_Modified,   a.[UserProfileId]   as Nations_PHY_ID,   d.[FirstName]    as PHY_FIRST,   d.[LastName]    as PHY_LAST,   LEFT(a.[Designation],10) as PHY_CREDENTIALS,   LEFT(f.[Address1],55)       as PHY_ADDRESS1,   LEFT(f.[Address2],55)       as PHY_ADDRESS2,   LEFT(f.[City],30)   as PHY_CITY,   LEFT(f.[State],2)           as PHY_STATE,   LEFT(f.[Zip],10)            as PHY_ZIPCODE,   LEFT(g.[PhoneNumber],10)    as PHY_PHONE1,   LEFT(d.[NPINumber],10)      as PHY_NPI     FROM [auth].[UserProfiles] a WITH (NOLOCK)   INNER JOIN [provider].[ProviderUsers] b   WITH (NOLOCK) ON b.[UserProfileId]=a.[UserProfileId]    INNER JOIN [provider].[ProviderProfiles] c  WITH (NOLOCK) ON c.[ProviderId] = b.[ProviderId]   INNER JOIN [provider].[HCPProviderProfile] d WITH (NOLOCK) ON d.[UserProfileId] = a.[UserProfileId]   INNER JOIN [provider].[ProviderLocations] e  WITH (NOLOCK) ON e.[ProviderId] = b.[ProviderId]   INNER JOIN [provider].[Locations] f    WITH (NOLOCK) ON f.[LocationId] = e.[LocationId]   INNER JOIN [provider].[LocationPhoneNumbers] g WITH (NOLOCK) ON g.[LocationId] =f.[LocationId]     WHERE    a.[UserProfileId] = @HCPUserProfileID and    f.[LocationId] =    @ServiceLocationID    END  
CREATE Procedure [Noble].[Get_HearingService_HA_Item]    @ProductModelCode nvarchar(30),     @DeviceCount int    AS    BEGIN     -- SET NOCOUNT ON added to prevent extra result sets from     -- interfering with SELECT statements.     SET NOCOUNT ON;        If @DeviceCount = 1      Begin     SELECT      GETDATE()             as 'Nations_Date_Modified',     (c.[FamilyProductCode] + '_' + c.[ProductModelCode] + '_1') as 'Nations_ITM_ID',     ('Monaural Device,Brand:' + [BrandCode] + ', Family:'+[BrandFamilyCode] + ',Shell:' +      case when c.[ShellCode]  in ('CIC','IIC','ITC','HS','MIH','ITE','LP') then c.[ShellCode]      else 'BTE'      end)              as 'Item_Description',      '0'              as 'ITEM_PRICE',     case when c.[ShellCode]  in ('CIC','IIC')                then 'V5254'        when c.[ShellCode]  in ('ITC','HS','MIH')           then 'V5255'        when c.[ShellCode]  in ('ITE','LP')                 then 'V5256'        when c.[ShellCode]  is null and e.[StyleCode] like '%BTE%' then 'V5257'       else '--'     end               as  'Nations_PRO_CODE'     FROM [catalog].[ProductModelRules]  c WITH (NOLOCK)     INNER JOIN [catalog].[Styles] e    WITH (NOLOCK) on c.[StyleID] = e.[StyleID]        WHERE c.[FamilyProductCode] is not null and     c.[ProductModelCode] = @ProductModelCode    End        If @DeviceCount = 2      Begin     SELECT      GETDATE()             as 'Nations_Date_Modified',     (c.[FamilyProductCode] + '_' + c.[ProductModelCode] + '_2') as 'Nations_ITM_ID',     ('Binaural Device,Brand:' + [BrandCode] + ', Family:'+[BrandFamilyCode] + ',Shell:' +      case when c.[ShellCode]  in ('CIC','IIC','ITC','HS','MIH','ITE','LP') then c.[ShellCode]      else 'BTE'      end)              as 'Item_Description',      '0'              as 'ITEM_PRICE',     case when c.[ShellCode]  in ('CIC','IIC')                then 'V5258'        when c.[ShellCode]  in ('ITC','HS','MIH')           then 'V5259'        when c.[ShellCode]  in ('ITE','LP')                 then 'V5260'        when c.[ShellCode]  is null and e.[StyleCode] like '%BTE%' then 'V5261'       else '--'     end               as  'Nations_PRO_CODE'     FROM [catalog].[ProductModelRules]  c WITH (NOLOCK)     INNER JOIN [catalog].[Styles] e    WITH (NOLOCK) on c.[StyleID] = e.[StyleID]        WHERE c.[FamilyProductCode] is not null and     c.[ProductModelCode] = @ProductModelCode    End    END  
-- =============================================  -- Author:  Mohan  -- Create date: 5th Feb 2018  -- Description: Gets Patient Details by MemberProfileID  -- =============================================  CREATE Procedure [Noble].[Get_patient]       @MemberProfileID bigint  AS  BEGIN   -- SET NOCOUNT ON added to prevent extra result sets from   -- interfering with SELECT statements.   SET NOCOUNT ON;        -- Insert statements for procedure here   SELECT TOP 1   a.[ModifyDate]    as Nations_Date_Modified,   a.[MemberProfileId]   as Nations_PAT_ID,   a.[FirstName]    as PAT_FIRST,   a.[LastName]    as PAT_LAST,   LEFT(b.[Address1],55)       as PAT_ADDRESS1,   LEFT(b.[Address2],55)       as PAT_ADDRESS2,   LEFT(b.[City],30)   as PAT_CITY,   LEFT(b.[State],2)           as PAT_STATE,   LEFT(b.[ZipCode],10)        as PAT_ZIPCODE,   LEFT(c.[PhoneNumber],10)    as PAT_PHONE1     FROM [provider].[MemberProfiles] a WITH (NOLOCK)   INNER JOIN [provider].[MemberLocations] b  WITH (NOLOCK) ON b.[MemberProfileId]=a.[MemberProfileId]    INNER JOIN [provider].[MemberPhoneNumbers] c WITH (NOLOCK) ON c.[MemberProfileId]=a.[MemberProfileId]      WHERE    a.[MemberProfileId] = @MemberProfileID   END  
-- =============================================  -- Author:  Mohan  -- Create date: 5th Feb 2018  -- Description: Gets Insurance Details by @InsuranceCarrierID  -- =============================================  CREATE Procedure [Noble].[Get_Insurance]       @InsuranceCarrierID bigint  AS  BEGIN   -- SET NOCOUNT ON added to prevent extra result sets from   -- interfering with SELECT statements.   SET NOCOUNT ON;        -- Insert statements for procedure here   SELECT TOP 1   a.[ModifyDate]      as Nations_Date_Modified,   a.[InsuranceCarrierID]    as Nations_INS_ID,   LEFT(a.[InsuranceCarrierName],55) as INS_COMPANY,   LEFT(a.[ClaimsAddress1],55)   as INS_ADDRESS1,   LEFT(a.[ClaimsAddress2],55)   as INS_ADDRESS2,   LEFT(a.[ClaimsCity],30)    as INS_CITY,   LEFT(a.[ClaimsState],2)    as INS_STATE,   LEFT(a.[ClaimsZipCode],10)   as INS_ZIPCODE,   LEFT(a.[ClaimsPhoneNbr],10)   as INS_PHONE1,   a.[ClaimsEmailAddress]    as INS_EMAIL     FROM [Insurance].[InsuranceCarriers] a WITH (NOLOCK)     WHERE    a.[InsuranceCarrierID] = @InsuranceCarrierID   END  
-- =============================================  -- Author:  Mohan  -- Create date: 5th Feb 2018  -- Description: Return Tesing Item  -- =============================================  CREATE Procedure [Noble].[Get_HearingService_Fitting_Item]  AS  BEGIN   -- SET NOCOUNT ON added to prevent extra result sets from   -- interfering with SELECT statements.   SET NOCOUNT ON;        -- Insert statements for procedure here   SELECT GETDATE()     as 'Nations_Date_Modified',     'FITTING'    as 'Nations_ITM_ID',     'Hearing Aid Fitting Completed' as 'ITM_DESCRIPTION',     0       as 'ITEM_PRICE',     'V5011'     as 'Nations_PRO_CODE'    END  
  CREATE Procedure [Noble].[Get_HearingService_Testing_Item]  AS  BEGIN   -- SET NOCOUNT ON added to prevent extra result sets from   -- interfering with SELECT statements.   SET NOCOUNT ON;        -- Insert statements for procedure here   SELECT GETDATE()     as 'Nations_Date_Modified',     'TESTING'    as 'Nations_ITM_ID',     'Hearing Test Completed' as 'ITM_DESCRIPTION',     0       as 'ITEM_PRICE',     '92591'     as 'Nations_PRO_CODE'    END  
-- =============================================  -- Author:  Mohan  -- Create date: Feb 6th 2018  -- Description: This method will get Existing Claim Number based on MemberChartDataID  -- =============================================  CREATE Procedure [Noble].[Get_ClaimNumbers]    @MemberChartDataId bigint   AS  BEGIN   -- SET NOCOUNT ON added to prevent extra result sets from   -- interfering with SELECT statements.   SET NOCOUNT ON;     SELECT [NobleClaimNumber], [NobleClaimDetailNumber]    FROM [provider].[MemberChartData] WITH (NOLOCK)   WHERE [MemberChartDataId] = @MemberChartDataId    END  
  -- =============================================  -- Author:  Mohan  -- Create date: 5th Feb 2018  -- Description: Gets Insurance Details by @InsuranceCarrierID  -- =============================================  CREATE Procedure [Noble].[Get_MemberInsurance]       @MemberProfileID bigint  AS  BEGIN   -- SET NOCOUNT ON added to prevent extra result sets from   -- interfering with SELECT statements.   SET NOCOUNT ON;        -- Insert statements for procedure here   SELECT    a.[ModifyDate]       as Nations_Date_Modified,   a.[MemberProfileId]      as Nations_PAT_ID,   a.[InsuranceCarrierID]     as Nations_INS_ID,   a.[MemberInsuranceID]     as Nations_INH_ID,   case a.[InsuranceType]    when 'PRI' then 'P'   when 'SEC' then 'S'   when 'TRI' then 'T' else 'P' END  as INH_TYPE,   c.[InsuranceNbr]      as INH_POLICY,   c.[GroupNbr]       as INH_GROUP,   a.[InsuranceEffectiveDate]    as INH_DATE_EFFECTIVE,   a.[InsuranceEndDate]     as INH_DATE_THRU,   case c.[PrimaryInsuredRelationShip]    when  'SELF' then 'S'         when 'SPOUSE' then 'P' when 'CHILD' then 'C'   when 'OTHER' then 'O' else 'S' END   as INH_RELATIONSHIP           FROM [provider].[MemberInsurances] a     WITH (NOLOCK)   INNER JOIN [provider].[MemberInsuranceDetails] c  WITH (NOLOCK) ON c.[MemberInsuranceID]=a.[MemberInsuranceID]     WHERE    a.[MemberProfileId] = @MemberProfileID     END  
-- =============================================  -- Author:  Mohan  -- Create date: Feb 6th 2018  -- Description: This method will Update Claim Number based on MemberChartDataID  -- =============================================  CREATE Procedure [Noble].[Update_ClaimNumbers]       @MemberChartDataId bigint,   @NobleClaimNumber bigint,    @NobleClaimDetailNumber bigint = 0  AS  BEGIN   -- SET NOCOUNT ON added to prevent extra result sets from   -- interfering with SELECT statements.   SET NOCOUNT ON;   IF @NobleClaimNumber > 0    Begin    UPDATE  [provider].[MemberChartData]    SET [NobleClaimNumber] = @NobleClaimNumber    WHERE [MemberChartDataId] = @MemberChartDataId   End       IF @NobleClaimDetailNumber > 0    Begin    UPDATE  [provider].[MemberChartData]    SET @NobleClaimDetailNumber = @NobleClaimDetailNumber    WHERE [MemberChartDataId] = @MemberChartDataId   End   END  
-- =============================================  -- Author:  Mohan  -- Create date: Feb 6th 2018  -- Description: This method will gets ClaimHeader Details to create new header  based on MemberChartDataID  -- TO BE WORKED ON  -- =============================================  CREATE Procedure [Noble].[Get_ClaimHeader]   @MemberChartDataId bigint   AS  BEGIN   -- SET NOCOUNT ON added to prevent extra result sets from   -- interfering with SELECT statements.   SET NOCOUNT ON;     --1. Validate if the MemberchartDataId is belogs to Testing, HA Order or Fitting transacctions     SELECT [MinorProcessId]     FROM [provider].[MemberChartData] WITH (NOLOCK)    WHERE [MemberChartDataId] = @MemberChartDataId          --[MinorProcessId] IN (     SELECT [NobleClaimNumber], [NobleClaimDetailNumber]    FROM [provider].[MemberChartData] WITH (NOLOCK)   WHERE [MemberChartDataId] = @MemberChartDataId    END  
      -- =============================================  -- Author:      <Author, , Hussamuddin, Bhanu, Venkat>  -- Create Date: <07/04/2019, , >  -- Description: <To get list of all document details, , >  -- exec [npn].[GetAllProvidersPre_Registration_List_Data] '','',''  -- exec [npn].[GetAllProvidersPre_Registration_List_Data] '09/06/2019','09/10/2019','C'  -- =============================================  CREATE PROCEDURE [npn].[GetAllProvidersPre_Registration_List_Data](      @fromDate NVARCHAR(50) = null,         @toDate NVARCHAR(50) = null,         @selectOption NVARCHAR(50)=null  ) AS     BEGIN  WITH Tran_uniqueRecord (ModifyDate,transactionkey)  As(SELECT MAX(td.ModifyDate) as ModifyDate,    td.transactionkey as transactionkey  FROM npn.transactiondetails TD  INNER JOIN [npn].[ProviderPreRegistration] PR on td.transactionkey = pr.transactionkey   GROUP BY td.transactionkey)    SELECT (CASE WHEN (Status='NEWLEAD') THEN 'New Lead'      WHEN (Status='AGREEMENTSENT') THEN 'Contract Sent'      WHEN (Status='AGREEMENTSENT_VIEWED') THEN 'Agreement Viewed'      WHEN (Status='SUBMITTED') THEN 'Agreement Submitted'      WHEN (Status='AUTHORIZED') THEN 'Agreement Authorized'      WHEN (Status='DECLINED') THEN 'Provider Declined'      WHEN (Status='REJECTED') THEN 'Agreement Rejected'      WHEN (Status='REGISTRATION_SUBMITTED') THEN 'Registration Submitted'      WHEN (Status='REGISTRATION_AUTHORIZED') THEN 'Registration Authorized'      WHEN (Status='REGISTRATION_REJECTED') THEN 'Registration Rejected'      WHEN (Status='DRAFT') THEN 'Agreement In Progress'      WHEN (Status='APPROVED') THEN 'Approved'      end) AS prospectingStatus,      format(tu.ModifyDate,'MM/dd/yyyy HH:mm:ss') as ModifyDate,      (CASE WHEN ISNULL(CAST(tu.ModifyDate AS VARCHAR),'') != '' THEN CONVERT(VARCHAR,tu.ModifyDate,101)  ELSE '' END) as PModifyDate,      tu.Transactionkey INTO #TEMPTRANSACTIONS       FROM npn.transactiondetails td inner join Tran_uniqueRecord tu on tu.Transactionkey=td.Transactionkey      WHERE td.modifyDate=tu.modifyDate      SELECT ROW_NUMBER() OVER (ORDER BY ppreg.AgreementTransactionId) AS rowId,      ISNULL(CAST(ppreg.LegalBusinessName AS VARCHAR),'') AS providerlegalBusinessName,      ISNULL(CAST(JSON_VALUE(ppreg.[ProviderRegistrationData], '$.ownerInfo.owner.firstName') AS VARCHAR),'') + ' ' + ISNULL(CAST(JSON_VALUE(ppreg.[ProviderRegistrationData], '$.ownerInfo.owner.middleName') AS VARCHAR),'') + ' ' + ISNULL(CAST(json_value(ppreg.[ProviderRegistrationData], '$.ownerInfo.owner.lastName') AS VARCHAR),'') AS ownerName,      ISNULL(CAST(ppreg.Email AS VARCHAR),'') AS ownerEmail,      ISNULL(ppreg.NPINumber ,'') AS NPINumber,     CONVERT(VARCHAR,ppreg.ModifyDate,101) AS registrationSubmittedDate,     (CASE WHEN (ppreg.[NPIData] IS NOT NULL AND ISNULL(CAST(JSON_VALUE(ppreg.[NPIData], '$.result_count') AS INT),0)=1) THEN 'Valid' WHEN ppreg.[NPIData] IS NULL and ISNULL(ppreg.NPINumber ,'')='' THEN '' WHEN ppreg.[NPIData] IS NULL and ISNULL(ppreg.NPINumber ,'')!='' THEN 'Invalid'  ELSE '' END) AS NPIStatus,      (CASE WHEN CAST(JSON_VALUE(ppreg.[DocumentVersions], '$.docStatus') AS VARCHAR) = 'Agreement Submitted' THEN CAST(JSON_VALUE(ppreg.[DocumentVersions], '$.updatedOn') AS VARCHAR) ELSE '' END) AS agreementSubmittedDate,      ISNULL(CAST(JSON_VALUE(ppreg.[AgreementData], '$.npiStatus') AS VARCHAR),'') AS agreementStatus,      ISNULL(CAST(JSON_VALUE(ppreg.[AgreementData], '$.npiStatus') AS VARCHAR),'') AS registrationStatus,      CAST((CASE WHEN (CAST(JSON_VALUE(ppreg.[DocumentVersions], '$.docStatus') AS VARCHAR)='Agreement Submitted' AND ppreg.DocumentData IS NOT NULL) THEN 1 ELSE 0 END) AS BIT) AS viewDocument,      ISNULL(ppreg.TransactionKey ,'') AS transactionKey,      LegalBusinessName as prospectingAction, ppreg.IsSync     INTO #PREREGISTRATION FROM npn.providerpreregistration ppreg    SELECT pr.registrationSubmittedDate,      tt.prospectingStatus,      tt.transactionkey,     pr.rowId,      pr.providerlegalBusinessName,   
CREATE PROCEDURE [npn].[GetAuthorizedRegisteredProviders]  (      -- Add the parameters for the stored procedure here      @TRANSACTIONKEY UNIQUEIDENTIFIER  )  AS  BEGIN      -- SET NOCOUNT ON added to prevent extra result sets from      -- interfering with SELECT statements.      SET NOCOUNT ON SELECT TD.TRANSACTIONID,                           PPR.AGREEMENTDATA,          PPR.EMAIL,         PPR.ISAGREEMENTCOMPLETED,         PPR.ISREGISTRATIONCOMPLETED,         PPR.LEGALBUSINESSNAME,         PPR.NPINUMBER,         PPR.PHONENUMBER,                      PPR.PROVIDERREGISTRATIONDATA,                PPR.TRANSACTIONKEY,         PPR.NPIDATA,         PPR.CREATEDATE NPIVALIDATIONDATE,         TD.TYPECODE,         TD.STATUS,         SUBMITTEDDATE,         SUBMITTEDBY,         AUTHORIZEDDATE,         AUTHORIZEDBY,         JSON_VALUE(PPR.AGREEMENTDATA, '$.federalTaxId') as TAXID   FROM  NPN.PROVIDERPREREGISTRATION PPR    INNER JOIN NPN.TRANSACTIONDETAILS TD   ON   TD.TRANSACTIONKEY = PPR.TRANSACTIONKEY   WHERE  TD.STATUS = 'AUTHORIZED'   AND   PPR.ISAGREEMENTCOMPLETED = 1   AND   PPR.ISACTIVE = 1   AND   PPR.TRANSACTIONKEY = @TRANSACTIONKEY  END  
CREATE PROCEDURE [npn].[SendAgreementTransactionDetails]  @LegalBusinessName NVARCHAR(250),  @Email NVARCHAR(250)  AS  BEGIN   SELECT TOP 1        pr.Email,pr.[IsActive],      pr.LegalBusinessName,      td.TransactionKey,      td.ModifyDate,      td.Status   FROM  [npn].[ProviderPreRegistration] pr   INNER JOIN  [npn].[TransactionDetails] td   ON   pr.TransactionKey= td.TransactionKey    WHERE  @LegalBusinessName=pr.LegalBusinessName OR @Email=pr.Email   ORDER BY modifydate DESC  END
-- ============================================= -- Author:       -- Create Date:  -- Description:  -- exec [npn].[GetDashBoardStatistics_Data] -- ============================================= CREATE PROCEDURE [npn].[GetDashBoardStatistics_Data] AS BEGIN  DECLARE @AGREEMENTSENT INT  DECLARE @NEWLEADS INT  DECLARE @AGREEMENTSENT_VIEWED INT  DECLARE @AGREEMENT_AUTHORIZED INT  DECLARE @SUBMITTED INT  DECLARE @REGISTRATION_AUTHORIZED INT  DECLARE @REGISTRATION_SUBMITTED INT  DECLARE @APPROVED_PROVIDERS INT  DECLARE @PROVIDERS_REJECTED INT  DECLARE @DECLINED INT   SET @AGREEMENTSENT = (SELECT COUNT([status]) FROM NPN.TRANSACTIONDETAILS WHERE [status]='AGREEMENTSENT' AND IsActive=1 GROUP BY [status])  SET @NEWLEADS =  (SELECT COUNT([status]) FROM NPN.TRANSACTIONDETAILS WHERE [status]='DRAFT' AND IsActive=1 GROUP BY [status])  SET @AGREEMENTSENT_VIEWED = (SELECT COUNT([status]) FROM NPN.TRANSACTIONDETAILS WHERE [status]='AGREEMENTSENT_VIEWED' AND IsActive=1 GROUP BY [status])  SET @AGREEMENT_AUTHORIZED = (SELECT COUNT([status]) FROM NPN.TRANSACTIONDETAILS WHERE [status]='REGISTRATION_AUTHORIZED' AND IsActive=1 GROUP BY [status])  SET @SUBMITTED = (SELECT COUNT([status]) FROM NPN.TRANSACTIONDETAILS WHERE [status]='SUBMITTED' AND IsActive=1 GROUP BY [status])  SET @REGISTRATION_AUTHORIZED = (SELECT COUNT([status]) FROM NPN.TRANSACTIONDETAILS WHERE [status]='REGISTRATION_AUTHORIZED' AND IsActive=1 GROUP BY [status])  SET @REGISTRATION_SUBMITTED = (SELECT COUNT([status]) FROM NPN.TRANSACTIONDETAILS WHERE [status]='SUBMITTED' AND IsActive=1 GROUP BY [status])  SET @APPROVED_PROVIDERS = (SELECT COUNT([status]) FROM NPN.TRANSACTIONDETAILS WHERE [status]='SUBMITTED' AND IsActive=1 GROUP BY [status])  SET @PROVIDERS_REJECTED = (SELECT COUNT([status]) FROM NPN.TRANSACTIONDETAILS WHERE [status]='REJECTED' AND IsActive=1 GROUP BY [status])  SET @DECLINED = (SELECT COUNT([status]) FROM NPN.TRANSACTIONDETAILS WHERE [status]='DECLINED' AND IsActive=1 GROUP BY [status])   SELECT  ROW_NUMBER() over (order by @AGREEMENTSENT) as rowId,     @AGREEMENTSENT AS 'AgreementsSent',     @NEWLEADS AS 'NewLeads',     @AGREEMENTSENT_VIEWED AS 'AgreementsViewed',     @AGREEMENT_AUTHORIZED AS 'AgreemenmtsAuthorized',     @SUBMITTED AS 'AgreementsSubmitted',     @REGISTRATION_AUTHORIZED AS 'RegistrationsAuthorized',     @REGISTRATION_SUBMITTED AS 'RegistrationsSubmitted',     @APPROVED_PROVIDERS AS 'ApprovedProviders',     @PROVIDERS_REJECTED AS 'ProvidersRejected',     @DECLINED AS 'AdminDeclined',     GETDATE() AS 'analyticsFromDate',     GETDATE() AS 'analyticsToDate' END
    create PROCEDURE [Orders].[GetPOChannelsByponumber]            @poNumber bigint  AS  BEGIN                  SET NOCOUNT ON;                   SELECT DISTINCT                a.[IsSinglePO],                a.[ItemTypeCode],                (                CASE WHEN a.[CommunicationMode] IS null OR b.[StyleCode] is null THEN 'EMAIL'                       ELSE JSON_VALUE(a.[CommunicationMode],'$.'+b.[StyleCode])                        END                ) AS [POChannel]                FROM Orders.ItemTypeConfig a                INNER JOIN  Orders.OrderItems b on                       b.[ItemType] = a.[ItemTypeCode] and                       b.BrandCode is not null and                       b.BrandCode = a.BrandCode and                       b.poNumber=@poNumber --and b.OrderId=@OrderID  END
  CREATE PROCEDURE [Orders].[CancelOrder2020]  (  @OrderID INT,  @ItemIds VARCHAR(100),  @cancelReason nvarchar(300),  @cancelRequestedBy nvarchar(50)  )    AS  BEGIN    --SELECT ORDERID from ORDERS.ORDERTRANSACTIONDETAILS   --WHERE [OrderStatusCode]= 'CAN' AND ORDERID = @OrdeID    Insert into orders.ordertransactiondetails  (   [OrderID] ,[OrderStatusCode] ,[OrderTransactionData]             ,[IsComplete] ,[CreateDate] ,[CreateUser] ,[ModifyDate] ,[ModifyUser] ,[IsActive]  )  values  (         @OrderID, 'CAN', CONCAT('[{"itemIds":[', @itemIds, '],"initBy":"', @cancelRequestedBy, '","reason":["', @cancelReason ,'"],"cancelDate":"', FORMAT(getdate(), 'yyyy-MM-dd'),'T00:00:00","canOrderId":0}]')     ,1 ,getDate(), @cancelRequestedBy, getdate(), @cancelRequestedBy, 1  )      declare @itemCount bigint = (select count(*)   from orders.orderitems  where orderid = @orderid)    declare @cancelCount bigint = (select count(*)   from orders.orderitems   inner join catalog.splitstring(@Itemids) id on id.[Name] = orders.orderitems.orderitemid   where orderid = @orderid)     if(SCOPE_IDENTITY() is not null)   BEGIN       IF(@itemCount = @CancelCount)     BEGIN      update ORDERS.ORDERS      set status='CANCELLED',      OrderStatusCode='CAN',      [ModifyDate]=getdate() ,      [ModifyUser]=@cancelRequestedBy      where orderid = @OrderID     END       update ORDERS.ORDERITEMS     set status='CANCELLED',     [ModifyDate]=getdate() ,     [ModifyUser]=@cancelRequestedBy     where orderitemid in (      select [Name] from catalog.splitstring(@Itemids)     )   END      END  
  CREATE PROCEDURE [Orders].[GetOTCOrderDetailsByOrderId]  (     @orderid bigInt  )  AS  BEGIN      -- SET NOCOUNT ON added to prevent extra result sets from      -- interfering with SELECT statements.      SET NOCOUNT ON  select     O.OrderID    ,o.Nhmemberid as NhmemberId   ,JSON_VALUE(MemberData,'$.firstName')+' '+ JSON_VALUE(MemberData,'$.lastName') AS MemberName   ,JSON_VALUE(MemberData,'$.address.address')  as  MemberAddress    ,JSON_VALUE(MemberData,'$.address.city') as MemberCity   ,JSON_VALUE(MemberData,'$.address.state') as MemberState   ,JSON_VALUE(MemberData,'$.address.zip') as  MemberZipcode   ,JSON_VALUE(MemberData,'$.address.country') as  MemberCountry   ,JSON_VALUE(MemberData,'$.phoneNumber') as MemberPhoneNumber   ,JSON_VALUE(MemberData,'$.email') as MemberEmailId   ,O.CreateDate as OrderDate   ,convert(datetime,JSON_VALUE(OrderTransactionData,'$.transactions[0].paymentDate')) as ReceiptDate   ,OI.ItemCode as  Itemcode   ,convert(decimal,Quantity) as  Quantity   ,ModelLongDescription as  Description   ,convert(decimal,UNITPRICE) as UnitPrice   ,convert(decimal,0) as Discounts   ,convert(decimal,OI.Amount) as Total   ,convert(decimal,(select sum(Amount) from orders.orderitems where orderid=@orderid and status='Active' and isactive=1)) as GrandTotal   from ORDERS.ORDERS O    left join ORDERS.ORDERITEMS OI on OI.OrderId=O.ORDERID   LEFT JOIN ORDERS.ORDERTRANSACTIONDETAILS OT ON OT.ORDERID=O.ORDERID and OT.OrderStatusCode='PAY'   LEFT JOIN [catalog].[ItemMasterList] IM ON IM.ITEMCODE=OI.ITEMCODE AND im.ITEMTYPE='OTC'    LEFT JOIN [cms].[ItemmasterContent] IC ON IC.ITEMCODE=OI.ITEMCODE    where orderType='OTC' and O.isactive=1  AND OI.ISACTIVE=1 and o.orderid= @orderid and OI.status='Active'  and OI.isactive=1     END  ----------------------------------------------------------    
  --STEP 1 Orders.GetHearingAidOrderItemDetails    CREATE PROCEDURE Orders.GetHearingAidOrderItemDetails  @OrderId bigint    AS  SELECT [Modifier]    ,OrderItemId    ,JSON_VALUE(ItemData,'$."color"') AS Color    ,JSON_VALUE(ItemData,'$."batterySize"') AS BatterySize    ,JSON_VALUE(ItemData,'$."receiverSize"') AS ReceiverSize    ,JSON_VALUE(ItemData,'$."receiverPower"') AS ReceiverPower    ,JSON_VALUE(ItemData,'$."sendingImpression"') AS  SendingImpression,OrderId,[CreateDate] AS ServiceDate    ,[ItemCode]  FROM  [Orders].[OrderItems]   WHERE orderid=@OrderId  AND itemtype='HA' AND isactive=1 --180024683  
    CREATE PROCEDURE [Orders].[ReturnOrder]  (   @OrderID INT,   @ReturnDt  nvarchar(50),   @returnRequestedBy nvarchar(50),   @returnReason nvarchar(300),   @NumberOfUnitsReturned int,   @ReturnSide varchar(10),   @CreditInvoiceDt  nvarchar(50),   @CreditInvoiceNbr varchar(20),   @CreditInvoiceAmount decimal  )    AS  BEGIN   SET NOCOUNT ON;   DECLARE @TotalUnits int;     SET @TotalUnits = (SELECT sum(Quantity) from orders.orderItems where ItemType in ('HA','CROS') and OrderID = @OrderID and IsActive=1)     if(@TotalUnits = @NumberOfUnitsReturned)    BEGIN        Insert into orders.ordertransactiondetails      (   [OrderID] ,[OrderStatusCode] ,[OrderTransactionData]           ,[IsComplete] ,[CreateDate] ,[CreateUser] ,[ModifyDate] ,[ModifyUser] ,[IsActive]      )      values      (         @OrderID, 'RET',  '{"returnDt":"'+cast(@ReturnDt as varchar)+'","returnReason":"'+@returnReason+'","returnRequestedBy":"'+@returnRequestedBy         +'","ReturnSide":"'+@ReturnSide +'","NumberOfUnitsReturned":"'+cast(@NumberOfUnitsReturned as varchar)+'"}'         ,1 ,getDate(), @returnRequestedBy, getdate(), @returnRequestedBy, 1      )        if(@CreditInvoiceAmount is not NULL)      BEGIN       Insert into orders.ordertransactiondetails       (   [OrderID] ,[OrderStatusCode] ,[OrderTransactionData]            ,[IsComplete] ,[CreateDate] ,[CreateUser] ,[ModifyDate] ,[ModifyUser] ,[IsActive]       )       values       (          @OrderID, 'REF',  '{"transactionGroupId":"","transactions":[{"transactionId":"","accountNumber":"","cardOrBank":"","paymentType":"","paymentDate":"'+cast(@CreditInvoiceDt as varchar)+          '","amountPaid":'+cast(@CreditInvoiceAmount as varchar)+',"responseDescription":"","transactionOrderRef":"'+@CreditInvoiceNbr+          '","transactionStatus":true,"last4digits":""}],"totalAmount":'+cast(@CreditInvoiceAmount as varchar)+'}'          ,1 ,getDate(), @returnRequestedBy, getdate(), @returnRequestedBy, 1       )      END          if(SCOPE_IDENTITY() is not null)       BEGIN           update ORDERS.ORDERS         set status='RETURNED',         OrderStatusCode = 'RET',         [ModifyDate]=getdate() ,         [ModifyUser]=@returnRequestedBy         where orderid = @OrderID           --update OrderItems          update ORDERS.ORDERITEMS         set status='RETURNED',         [ModifyDate]=getdate() ,         [ModifyUser]=@returnRequestedBy         where orderid = @OrderID        END              END     ELSE if(@TotalUnits > @NumberOfUnitsReturned)    BEGIN          Insert into orders.ordertransactiondetails      (   [OrderID] ,[OrderStatusCode] ,[OrderTransactionData]           ,[IsComplete] ,[CreateDate] ,[CreateUser] ,[ModifyDate] ,[ModifyUser] ,[IsActive]      )      values      (         @OrderID, 'RET',  '{"returnDt":"'+cast(@ReturnDt as varchar)+'","returnReason":"'+@returnReason+'","returnRequestedBy":"'+@returnRequestedBy         +'","ReturnSide":"'+@ReturnSide +'","NumberOfUnitsReturned":"'+cast(@NumberOfUnitsReturned as varchar)+'"}'         ,1 ,getDate(), @returnRequestedBy, getdate(), @returnRequestedBy, 1      )        if(@CreditInvoiceAmount is not NULL)      BEGIN       Insert into orders.ordertransactiondetails       (   [OrderID] ,[OrderStatusCode] ,[OrderTransactionData]            ,[IsComplete] ,[CreateDate] ,[CreateUser] ,[ModifyDate] ,[ModifyUser] ,[IsActive]       )       values       (          @OrderID, 'REF',  '{"transactionGroupId":"","transactions":[{"transactionId":"","accountNumber":"","cardOrBank":"","paymentType":"","paymentDate":"'+cast(@CreditInvoiceDt as varchar)+          '","amountPaid":'+cast(@CreditInvoiceAmount as varchar)+',"responseDescription":"","transactionOrderRef":"'+@CreditInvoiceNbr+          '","transactionStatus":true,"last4digits":""}],"totalAmount":'+cast(@CreditInvoiceAmount as varchar)+'}'          ,1 ,getDate(), @returnRequestedBy, getdate(), @returnRequestedBy, 1       )      END          if(SCOPE_IDENTITY() is not null)       BEGIN           --update ORDERS.ORD
CREATE PROCEDURE [Orders].[GetHearingOrderPaymentDetails]  @OrderId BIGINT  AS   SELECT * FROM OPENJSON((SELECT OrderTransactionData          FROM [Orders].[OrderTransactionDetails]          WHERE orderstatuscode='pay' AND orderid=@OrderId )) --180024683    WITH(     TotalAmount  VARCHAR(20) '$.totalAmount',     TransactionGroupId VARCHAR(100) '$.transactionGroupId',     Transactions NVARCHAR(MAX) '$.transactions' as json     )    OUTER APPLY OPENJSON (transactions)    WITH (     TransactionId VARCHAR(100) '$.transactionId',     PaymentType VARCHAR(10) '$.paymentType',     CardOrBank VARCHAR(10) '$.cardOrBank',     PaymentDate VARCHAR(20) '$.paymentDate',     AmountPaid VARCHAR(10) '$.amountPaid',     FinanceCompany VARCHAR(30) '$.financeCompany',     RoutingNumber VARCHAR(30) '$.routingNumber',     CheckNumber VARCHAR(30) '$.checkNbr',     AccountNumber VARCHAR(30) '$.accountNumber',     ReceiptNumber VARCHAR(20) '$.receiptNo'     )    
  ----STEP 3 Orders.GetMemberCopayDetails    CREATE PROCEDURE Orders.GetMemberCopayDetails  @mcdId BIGINT  AS  DECLARE @grpId varchar(50);  SET @grpId = (SELECT TOP 1 JSON_VALUE(ProcessData, '$.transactionGroupID') FROM [provider].[MemberChartData] WHERE MemberChartDataId=@mcdId)    SELECT    MemberChartDataId   ,MinorProcessId   ,CONVERT(BIGINT,ISNULL(JSON_VALUE(ProcessData, '$.orderID'),0)) AS OrderId   ,CONVERT(DECIMAL(10,2),ISNULL(JSON_VALUE(ProcessData, '$.copayAmount'),0)) AS CopayAmount   ,CONVERT(DECIMAL(10,2),ISNULL(JSON_VALUE(ProcessData, '$.amountPaid'),0)) AS AmountPaid   ,d.CreateDate AS ServiceDate  FROM provider.MemberChartData d WHERE MinorProcessId IN (20, 29, 34, 38) AND JSON_VALUE(ProcessData, '$.transactionGroupID')=@grpId    
  ----STEP 4 Orders.GetMemberCopayTransactionDetails    CREATE PROCEDURE Orders.GetMemberCopayTransactionDetails  @mcdId BIGINT  AS  SELECT * FROM OPENJSON((SELECT TOP 1 ProcessData FROM provider.MemberChartData WHERE MemberChartDataId=@mcdId))    WITH (     TotalAmount  VARCHAR(20) '$.totalAmount',     TransactionGroupId VARCHAR(100) '$.transactionGroupID',     Transactions NVARCHAR(MAX) '$.transaction' AS JSON     )   OUTER APPLY OPENJSON (transactions)  WITH (   TransactionId VARCHAR(100) '$.transactionId',   PaymentType VARCHAR(10) '$.paymentType',   CardOrBank VARCHAR(10) '$.cardOrBank',   PaymentDate varchar(20) '$.paymentDate',   AmountPaid VARCHAR(10) '$.amountPaid',   FinanceCompany VARCHAR(30) '$.financeCompany',   RoutingNumber VARCHAR(30) '$.routingNumber',   CheckNumber VARCHAR(30) '$.checkNbr',     AccountNumber VARCHAR(30) '$.accountNumber',     ReceiptNumber VARCHAR(20) '$.receiptNo'    )  
CREATE FUNCTION [orders].[fnSplitString]  (      @string NVARCHAR(MAX),      @delimiter CHAR(1)  )  RETURNS @output TABLE(splitdata NVARCHAR(MAX)  )  BEGIN      DECLARE @start INT, @end INT      SELECT @start = 1, @end = CHARINDEX(@delimiter, @string)      WHILE @start < LEN(@string) + 1 BEGIN          IF @end = 0              SET @end = LEN(@string) + 1                  INSERT INTO @output (splitdata)          VALUES(SUBSTRING(@string, @start, @end - @start))          SET @start = @end + 1          SET @end = CHARINDEX(@delimiter, @string, @start)               END      RETURN  END  
CREATE PROCEDURE [Orders].[sp_GetPoDateByplanid]     @orderid bigint   AS  BEGIN      -- SET NOCOUNT ON added to prevent extra result sets from      -- interfering with SELECT statements.      SET NOCOUNT ON         -- declare @orderid int =180025074     select top  1 1 AS ID, case when P.ProviderId is null then convert(datetime,po.PODate)+60 else  convert(datetime,po.PODate)+60 end as PODate  from orders.orders o    left join   (select ProviderId,LocationId from [provider].[ProviderUserLocations] where    UserProfileId in(select userProfileid from [provider].[HCPProviderProfile] where IsMedicaid=1 and IsActive=1)    ) P on P.ProviderId=JSON_VALUE(MemberData, '$.insCarrierId') and p.LocationId = JSON_VALUE(MemberData, '$.insPlanId')   left join    (   select it.[OrderId],(select res.PODate from (select *  from openjson(tr.ordertransactiondata)    with (PODate date '$.poDate', PONumber nvarchar(50) '$.poNumber')) res    where res.PONumber=cast(it.PONumber as nvarchar)) as PODate   from [Orders].[OrderItems] it    inner join [catalog].[Brands] br   on br.[BrandCode]=it.[BrandCode]   inner join [Orders].[OrderTransactionDetails] tr     on tr.[OrderId] = it.[OrderId] and tr.[OrderStatusCode]='PO'    )po on po.OrderId =o.orderid   where o.orderId=@orderid  END  
CREATE PROCEDURE [Orders].[sp_GetFittingDateByplanid]     @orderid bigint   AS  BEGIN      SET NOCOUNT ON  --Fitting Date from CLM transaction  declare @fitDate date = (select top 1 cast(JSON_VALUE(OrderTransactionData, '$.fittingDate') as date) from [Orders].[OrderTransactionDetails]    where orderstatuscode='CLM' and orderid=@orderid and isactive=1);  if (@fitDate is null or @fitDate='')  begin  --Fitting Date = Order Date + 21 (Same logic in GetBenefitsUsed)   set @fitDate = (select top 1 dateadd(day, 21, cast(JSON_VALUE(OrderTransactionData, '$.orderDate') as date)) from [Orders].[OrderTransactionDetails]    where orderstatuscode='INI' and orderid=@orderid and isactive=1);  end  select top  1  1 as ID,  case when hpl.IsMedicaid=1   then dateadd(day, 90, @fitDate)   else dateadd(day, 60, @fitDate)  end as WarrantyEndDate   from orders.orders o  inner join Insurance.InsuranceHealthPlans hpl  on hpl.[InsuranceHealthPlanID] = json_value(o.MemberData, '$.insPlanId') and hpl.IsActive=1   where o.orderId=@orderid  END  
/***  STEP 2: Process data and Insert into [Orders].[MemberOrdersExternalUsage]     Compare Member_Number column in Excel Sheet with InsuranceNbr in Master.MemberInsuranceDetails table.     If there it matches, then NHMemberId will be updated in Temp table [temp].[HealthFirst_Utilization_Data].    Then the matched record will insert in [Orders].[MemberOrdersExternalUsage] ***/ CREATE PROCEDURE [orders].[Load_HealthFirst_ExternalOrderUsage] (@InsCarrierId nvarchar(20))  AS   BEGIN     SET NOCOUNT ON     DECLARE @UPDATEPRIMARYCOLUMNS NVARCHAR(MAX)     SET @UPDATEPRIMARYCOLUMNS = 'UPDATE [temp].[HealthFirst_Utilization_Data] SET ' +            'NHMEMBERID = M.NHMEMBERID, '+            'InsuranceCarrierId = MI.insurancecarrierid, '+            'insurancehealthplanid = MI.insurancehealthplanid ' +            'FROM [temp].[HealthFirst_Utilization_Data] CT ' +            'INNER JOIN MASTER.MEMBERINSURANCEDETAILS MID ON MID.INSURANCENBR = CT.MEMBER_NUMBER ' +            'INNER JOIN MASTER.MEMBERINSURANCES MI ON MI.ID = MID.MEMBERINSURANCEID '+            'INNER JOIN MASTER.MEMBERS M ON  M.MEMBERID = MI.MEMBERID ' +            'WHERE MID.INSURANCENBR = CT.MEMBER_NUMBER ' +            'AND MI.InsuranceCarrierID = ' + @InsCarrierId + ' '          EXEC sp_executesql @UPDATEPRIMARYCOLUMNS       DECLARE @applied NVARCHAR(500)    SET @applied = '{"applied": {"benefits":null,"benefitsRight":null,"benefitsLeft":null,"purchases":null,"devicesCount":null} }'       INSERT INTO [Orders].[MemberOrdersExternalUsage] (       [NHMemberId],       [InsuranceCarrierId],       [InsuranceHealthPlanId],       [BenefitType],       [Source],       [MemberFirstName],       [MemberLastName],       [MemberNumber],       [MemberDateOfBirth],       [GroupNumber],       [ProviderName],       [ProviderTaxId],       [ProviderNetworkIndicator],       [ClaimNumber],       [ClaimLineNumber],       [ClaimReceivedDate],       [ClaimPaidDate],       [DateOfService],       [CoverageUnits],       [CoverageAmount],       [ServiceCode],       [ModifierCode],       [ModifierCode2],       [BilledAmount],       [AllowedAmonut],       [NonCoveredAmount],       [ToPayAmount],       [BenefitsData],       [CreateDate],       [CreateUser],       [IsActive],       [ModifyDate],       [ModifyUser]    )    SELECT [NHMemberId],      [InsuranceCarrierId],      [InsuranceHealthPlanId],      'HA',      'FILE',      [MEMBER_FIRST_NAME],      [MEMBER_LAST_NAME],      [MEMBER_NUMBER],      CONVERT(date, substring([MEMBER_DATE_OF_BIRTH],5,4) + '-' + substring([MEMBER_DATE_OF_BIRTH],1,2) + '-' + substring([MEMBER_DATE_OF_BIRTH],3,2)),      [GROUP_NUMBER],      [PROVIDER_NAME],      [PROVIDER_TAX_ID],      [PROVIDER_NETWORK_INDICATOR],      [CLAIM_NUMBER],      [CLAIM_LINE_NUMBER],      CONVERT(date, substring([CLAIM_RECEIVED_DATE],5,4) + '-' + substring([CLAIM_RECEIVED_DATE],1,2) + '-' + substring([CLAIM_RECEIVED_DATE],3,2)),      CONVERT(date, substring([CLAIM_PAID_DATE],5,4) + '-' + substring([CLAIM_PAID_DATE],1,2) + '-' + substring([CLAIM_PAID_DATE],3,2)),      CONVERT(date, substring([DATE_OF_SERVICE],5,4) + '-' + substring([DATE_OF_SERVICE],1,2) + '-' + substring([DATE_OF_SERVICE],3,2)),       [COVERAGE_UNITS],      [COVERAGE_AMOUNT],      [SERVICE_CODE],      [MODIFIER_CODE],      [MODIFIER_CODE_2],      [BILLED_AMOUNT],      [ALLOWED_AMOUNT],      [NON_COVERED_AMOUNT],      [TO_PAY_AMOUNT],      JSON_MODIFY(@applied, '$.applied.benefits', COVERAGE_AMOUNT),      GETDATE(),      SYSTEM_USER,      1,      GETDATE(),      SYSTEM_USER    FROM [temp].[HealthFirst_Utilization_Data]    WHERE NHMemberId is not null   END 
/*  Mohan deployed to Stage on  1 May 2020   Mohan deployed to PROD on  12 May 2020   */  CREATE PROCEDURE [Orders].[GetDocumentcheckDetails]  (     @orderId bigint  )  AS  BEGIN      -- declare @orderId bigint =190001722   select distinct DL.[DocumentLookUpName],DL.[DocumentLookUpCode],DT.[DocumentTypeCode]    from orders.orders O     inner join [provider].[MemberChartData] MCD on MCD.[MemberChartDataId]=O.[MemberChartDataId]    inner join [provider].[MemberCharts] MC on MC.[MemberChartId]=MCD.[MemberChartId]    inner join [Document].[DocumentTransaction] DT on DT.[MemberChartId]=MCD.[MemberChartId] and DT.[MemberChartDataId]=O.[MemberChartDataId]    right join [Document].[DocumentLookup] DL on DL.[DocumentLookUpCode]=DT.[DocumentTypeCode]    and MC.Isactive=1 and MCD.isactive=1 and o.isactive=1 and Dt.isactive=1 and DL.isactive=1    and [DocumentTypeCode] In ('DOC_AOB','DOC_HIPA','DOC_AGM','DOC_HHQ','DOC_PA')    and  o.orderid=@orderId     where DL.[DocumentLookUpCode] In ('DOC_AOB','DOC_HIPA','DOC_AGM','DOC_HHQ','DOC_PA')     END
  CREATE PROCEDURE [Orders].[GetOrderDetailsFromItemCode]    (      -- Add the parameters for the stored procedure here   @ItemCode NVARCHAR(100)  )  AS  BEGIN  BEGIN TRY      -- SET NOCOUNT ON added to prevent extra result sets from      -- interfering with SELECT statements.      SET NOCOUNT ON     DECLARE @ItemCodeCheck NVARCHAR(100);     IF @ItemCode IS NOT NULL    BEGIN     --1. Check validity of Input Params      SELECT @ItemCodeCheck = (      SELECT TOP 1 ItemCode FROM [catalog].[viewModelList]      WHERE REPLACE(ItemCode, ' ', '') = @ItemCode     )       IF @ItemCodeCheck is NULL       RAISERROR (       'ItemCode not found in DB ', -- Message text.         16, -- Severity.         1 -- State.        );       SELECT TOP 1 Brand, Family, Technology, Model, Style       FROM catalog.viewModelList      WHERE REPLACE(ItemCode, ' ', '') = @ItemCode          END    ELSE    BEGIN              RAISERROR ('ItemCode missing', -- Message text.                                  16, -- Severity.                                  1 -- State.                                 );      END    --IF ENDs  END TRY  BEGIN CATCH        DECLARE @ErrorMessage NVARCHAR(4000);        DECLARE @ErrorSeverity INT;        DECLARE @ErrorState INT;          SELECT             @ErrorMessage =  ERROR_MESSAGE(),            @ErrorSeverity = ERROR_SEVERITY(),            @ErrorState = ERROR_STATE();          -- Use RAISERROR inside the CATCH block to return error        -- information about the original error that caused        -- execution to jump to the CATCH block.        RAISERROR (@ErrorMessage, -- Message text.                   @ErrorSeverity, -- Severity.                   @ErrorState -- State.                   );    END CATCH;    END  
  CREATE PROCEDURE [Orders].[GetProviderJSONFromProviderId]  (      -- Add the parameters for the stored procedure here   @ProviderId BIGINT,   @PONumber NVARCHAR(50)   --{"providerLeagalBusinessName":"","dba":"","dispenser":"","emailId":"","address":{"address":"4155 S Suncoast Blvd","city":"Homosassa","state":"FL","zip":"34446","locationId":353},"hcp":{"firstName":"Roger","lastName":"Throneburg","npiNumber":"","phoneNumber":"","faxNumber":""},"providerId":133}  )  AS  BEGIN  BEGIN TRY      -- SET NOCOUNT ON added to prevent extra result sets from      -- interfering with SELECT statements.      SET NOCOUNT ON     DECLARE @ProviderIdCheck BIGINT;     IF @ProviderId IS NOT NULL   AND @PONumber IS NOT NULL    BEGIN     --1. Check validity of Input Params      SELECT @ProviderIdCheck = (      SELECT TOP 1        ProviderId       from [Orders].[MemberOrdersVStoCRM]      WHERE ProviderId = @ProviderId     )       IF @ProviderIdCheck is NULL       RAISERROR (       'Provider Id not found in DB ', -- Message text.         16, -- Severity.         1 -- State.        );             SELECT '{'+      '"providerLeagalBusinessName":"'+ISNULL(ProviderName, '')+'",'+      '"dba":"'+ISNULL(DBA,'')+'",'+      '"dispenser":"'+ISNULL(SiteId,'')+'",'+      '"emailId":"'+ISNULL(PrimaryEmailAddress,'')+'",'+      '"address":{'+      '"address":"'+ISNULL([ProviderShipToAddress],'')+'",'+      '"address1":"'+ISNULL([ProviderShipToAddress],'')+'",'+      '"city":"'+ISNULL([ProviderCity],'')+'",'+      '"state":"'+ISNULL([ProviderState],'')+'",'+      '"zip":"'+ISNULL([ProviderZipCode],'')+'",'+      '"locationId":'+cast([LocationId] as nvarchar)+'},'+      '"hcp":{'+      '"firstName":"'+ISNULL(HCPName,'')+'",'+      '"lastName":"'+''+'",'+      '"npiNumber":"'+ISNULL(HCPNPINbr,'')+'",'+      '"phoneNumber":"'+ISNULL(ProviderPhoneNbr,'')+'",' +      '"hcpId":"'+''+'",'+      '"faxNumber":"'+ISNULL(ProviderFaxNbr,'')+'"},'+      '"providerId":'+cast(b.ProviderId as nvarchar)+'}'      From Orders.MemberOrdersVStoCRM a      LEFT OUTER JOIN provider.ProviderProfiles b on b.ProviderId = a.ProviderId      WHERE a.ProviderId = @ProviderId      AND PONumber = @PONumber          END    ELSE    BEGIN              RAISERROR ('ProviderId/PONumber missing', -- Message text.                                  16, -- Severity.                                  1 -- State.                                 );      END    --IF ENDs  END TRY  BEGIN CATCH        DECLARE @ErrorMessage NVARCHAR(4000);        DECLARE @ErrorSeverity INT;        DECLARE @ErrorState INT;          SELECT             @ErrorMessage =  ERROR_MESSAGE(),            @ErrorSeverity = ERROR_SEVERITY(),            @ErrorState = ERROR_STATE();          -- Use RAISERROR inside the CATCH block to return error        -- information about the original error that caused        -- execution to jump to the CATCH block.        RAISERROR (@ErrorMessage, -- Message text.                   @ErrorSeverity, -- Severity.                   @ErrorState -- State.                   );    END CATCH;    END  
  CREATE PROCEDURE [Orders].[GetShippingJSONFromLocationId]  (      -- Add the parameters for the stored procedure here   @LocationId BIGINT,   @PONumber NVARCHAR(100)   --'{"providerBusinessName":"","fullName":"","address":{"address":"","city":"","state":"","zip":"","country":"USA"},"email":"","phoneNumber":"","shippingInstructions":""}'  )  AS  BEGIN  BEGIN TRY      -- SET NOCOUNT ON added to prevent extra result sets from      -- interfering with SELECT statements.      SET NOCOUNT ON     DECLARE @LocationIdCheck BIGINT;     IF @LocationId IS NOT NULL   AND @PONumber IS NOT NULL    BEGIN     --1. Check validity of Input Params      SELECT @LocationIdCheck = (      SELECT TOP 1        LocationId       from [Orders].[MemberOrdersVStoCRM]      WHERE LocationId = @LocationId     )       IF @LocationIdCheck is NULL       RAISERROR (       'Location Id not found in DB ', -- Message text.         16, -- Severity.         1 -- State.        );             SELECT '{'+      '"providerBusinessName":"'+ISNULL(ProviderLegalName, '')+'",'+      '"fullName":"'+ISNULL(ProviderLegalName, '')+'",'+      '"address":{'+      '"address":"'+ISNULL([ProviderShipToAddress], '')+'",'+      '"address1":"'+ISNULL([ProviderShipToAddress], '')+'",'+      '"city":"'+ISNULL([ProviderCity], '')+'",'+      '"state":"'+ISNULL([ProviderState], '')+'",'+      '"zip":"'+ISNULL([ProviderZipCode], '')+'",'+      '"country":"USA"},'+      '"email":"'+ISNULL(REPLACE(ProviderEmail, CHAR(13), ''), '')+'",'+      '"phoneNumber":"'+ISNULL(ProviderPhoneNbr, '')+'",'+      '"shippingInstructions":""}' [json]      FROM Orders.MemberOrdersVStoCRM      WHERE LocationId = @LocationId      AND PONumber = @PONumber          END    ELSE    BEGIN              RAISERROR ('Shipping data missing', -- Message text.                                  16, -- Severity.                                  1 -- State.                                 );      END    --IF ENDs  END TRY  BEGIN CATCH        DECLARE @ErrorMessage NVARCHAR(4000);        DECLARE @ErrorSeverity INT;        DECLARE @ErrorState INT;          SELECT             @ErrorMessage =  ERROR_MESSAGE(),            @ErrorSeverity = ERROR_SEVERITY(),            @ErrorState = ERROR_STATE();          -- Use RAISERROR inside the CATCH block to return error        -- information about the original error that caused        -- execution to jump to the CATCH block.        RAISERROR (@ErrorMessage, -- Message text.                   @ErrorSeverity, -- Severity.                   @ErrorState -- State.                   );    END CATCH;    END  
  CREATE PROCEDURE [Orders].[CancelOrder]  (  @OrderID INT,  @cancelReason nvarchar(300),  @cancelRequestedBy nvarchar(50)  )    AS  BEGIN    --SELECT ORDERID from ORDERS.ORDERTRANSACTIONDETAILS   --WHERE [OrderStatusCode]= 'CAN' AND ORDERID = @OrdeID    Insert into orders.ordertransactiondetails  (   [OrderID] ,[OrderStatusCode] ,[OrderTransactionData]             ,[IsComplete] ,[CreateDate] ,[CreateUser] ,[ModifyDate] ,[ModifyUser] ,[IsActive]  )  values  (     @OrderID, 'CAN', '{"cancelDate":"'+cast(getDate() as nvarchar)+'","cancelReason":"'+@cancelReason+'","cancelledBy":"'+@cancelRequestedBy+'"}'     ,1 ,getDate(), @cancelRequestedBy, getdate(), @cancelRequestedBy, 1  )        if(SCOPE_IDENTITY() is not null)   BEGIN       update ORDERS.ORDERS     set status='CANCELLED',     OrderStatusCode='CAN',     [ModifyDate]=getdate() ,     [ModifyUser]=@cancelRequestedBy     where orderid = @OrderID            update ORDERS.ORDERITEMS     set status='CANCELLED',     [ModifyDate]=getdate() ,     [ModifyUser]=@cancelRequestedBy     where orderid = @OrderID   END      END
  CREATE PROCEDURE [Orders].[UpdateMemberChartDataOrderId]   (      -- Add the parameters for the stored procedure here   @MemberChartDataId BIGINT,      @OrderId BIGINT  )  AS  BEGIN  BEGIN TRY      -- SET NOCOUNT ON added to prevent extra result sets from      -- interfering with SELECT statements.      SET NOCOUNT ON     DECLARE @OrderIdCheck BIGINT;   DECLARE @MemberChartDataIdCheck BIGINT;     IF @OrderId IS NOT NULL AND   @MemberChartDataId IS NOT NULL    BEGIN     --1. Check validity of Input Params      SELECT @OrderIdCheck = (      SELECT TOP 1 OrderId FROM Orders.Orders      WHERE OrderId = @OrderId     )       IF @OrderIdCheck is NULL       RAISERROR (       'Order not found in DB', -- Message text.         16, -- Severity.         1 -- State.        );       SELECT @MemberChartDataIdCheck = (      SELECT TOP 1 MemberChartDataId FROM provider.MemberChartData      WHERE MemberChartDataId = @MemberChartDataId     )       IF @MemberChartDataIdCheck is NULL       RAISERROR (       'Member Chart data not found in DB', -- Message text.         16, -- Severity.         1 -- State.        );       UPDATE provider.MemberChartData     SET ProcessData = REPLACE(ProcessData, 'XXXXX', @OrderId)     WHERE MemberChartDataId = @MemberChartDataIdCheck            END    ELSE    BEGIN              RAISERROR ('OrderId or MemberChartDataId missing', -- Message text.                                  16, -- Severity.                                  1 -- State.                                 );      END    --IF ENDs  END TRY  BEGIN CATCH        DECLARE @ErrorMessage NVARCHAR(4000);        DECLARE @ErrorSeverity INT;        DECLARE @ErrorState INT;          SELECT             @ErrorMessage =  ERROR_MESSAGE(),            @ErrorSeverity = ERROR_SEVERITY(),            @ErrorState = ERROR_STATE();          -- Use RAISERROR inside the CATCH block to return error        -- information about the original error that caused        -- execution to jump to the CATCH block.        RAISERROR (@ErrorMessage, -- Message text.                   @ErrorSeverity, -- Severity.                   @ErrorState -- State.                   );    END CATCH;    END  
        CREATE PROCEDURE [Orders].[PartialReturnOrder]  (  @OrderID INT,  @ReturnDt  nvarchar(50),  @returnRequestedBy nvarchar(50),  @returnReason nvarchar(300),  @NumberOfUnitsReturned int,  @ReturnSide varchar(10),  @CreditInvoiceDt  nvarchar(50),  @CreditInvoiceNbr varchar(20),  @CreditInvoiceAmount decimal  )    AS  BEGIN      Insert into orders.ordertransactiondetails  (   [OrderID] ,[OrderStatusCode] ,[OrderTransactionData]             ,[IsComplete] ,[CreateDate] ,[CreateUser] ,[ModifyDate] ,[ModifyUser] ,[IsActive]  )  values  (     @OrderID, 'RET',  '{"returnDt":"'+cast(@ReturnDt as varchar)+'","returnReason":"'+@returnReason+'","returnRequestedBy":"'+@returnRequestedBy     +'","ReturnSide":"'+@ReturnSide +'","NumberOfUnitsReturned":"'+cast(@NumberOfUnitsReturned as varchar)+'"}'     ,1 ,getDate(), @returnRequestedBy, getdate(), @returnRequestedBy, 1  )    if(@CreditInvoiceAmount is not NULL)  BEGIN   Insert into orders.ordertransactiondetails   (   [OrderID] ,[OrderStatusCode] ,[OrderTransactionData]        ,[IsComplete] ,[CreateDate] ,[CreateUser] ,[ModifyDate] ,[ModifyUser] ,[IsActive]   )   values   (      @OrderID, 'REF',  '{"transactionGroupId":"","transactions":[{"transactionId":"","accountNumber":"","cardOrBank":"","paymentType":"","paymentDate":"'+cast(@CreditInvoiceDt as varchar)+      '","amountPaid":'+cast(@CreditInvoiceAmount as varchar)+',"responseDescription":"","transactionOrderRef":"'+@CreditInvoiceNbr+      '","transactionStatus":true,"last4digits":""}],"totalAmount":'+cast(@CreditInvoiceAmount as varchar)+'}'      ,1 ,getDate(), @returnRequestedBy, getdate(), @returnRequestedBy, 1   )  END      if(SCOPE_IDENTITY() is not null)   BEGIN       update ORDERS.ORDERS     set status='PARTIALRET',     [ModifyDate]=getdate() ,     [ModifyUser]=@returnRequestedBy     where orderid = @OrderID  END      END  ---{"CreditInvoiceDt":"'+cast(@CreditInvoiceDt as varchar)+'","CreditInvoiceNbr":"'+@CreditInvoiceNbr+'","CreditInvoiceAmount":"'+cast(@CreditInvoiceAmount as varchar)+'"}  
  Create PROCEDURE [Orders].[LSDOrder]  (   @OrderID INT,   @RequestedBy nvarchar(50)  )         AS  BEGIN   -- SET NOCOUNT ON added to prevent extra result sets from   -- interfering with SELECT statements.   SET NOCOUNT ON;         update ORDERS.ORDERS      set ordertype='LSandD',     [ModifyDate]=getdate() ,     [ModifyUser]=@RequestedBy     where orderid = @OrderID              END
CREATE PROCEDURE [Orders].[GetOrderDetailsByOrderId] --190002012  (     @orderid bigInt  )  AS  BEGIN      -- SET NOCOUNT ON added to prevent extra result sets from      -- interfering with SELECT statements.      SET NOCOUNT ON     select     o.orderid,   JSON_VALUE(ProviderData, '$.providerLeagalBusinessName')  ProviderBusinessName,   JSON_VALUE(ProviderData, '$.dba')  ProviderdbaName,   JSON_VALUE(ProviderData, '$.hcp.firstName')+JSON_VALUE(ProviderData, '$.hcp.lastName')  ProviderName,   JSON_VALUE(ProviderData, '$.address.address')  ProviderAddress,   JSON_VALUE(ProviderData, '$.address.city')  ProviderCity,   JSON_VALUE(ProviderData, '$.address.state')  ProviderState,   JSON_VALUE(ProviderData, '$.address.zip')  ProviderZipcode,   JSON_VALUE(ProviderData, '$.address.country')  ProviderCountry,   JSON_VALUE(ProviderData, '$.hcp.phoneNumber')  ProviderPhoneNumber,   JSON_VALUE(ProviderData, '$.address.providerId') ProviderCode,   JSON_VALUE(MemberData, '$.firstName')+ ' '+ JSON_VALUE(MemberData, '$.lastName') MemberName,   JSON_VALUE(MemberData, '$.address.address') MemberAddress,   JSON_VALUE(MemberData, '$.address.city') MemberCity,   JSON_VALUE(MemberData, '$.address.state') MemberState,   JSON_VALUE(MemberData, '$.address.zip')  MemberZipcode,   JSON_VALUE(MemberData, '$.address') MemberCountry,   JSON_VALUE(MemberData, '$.phoneNumber') MemberPhoneNumber,   o.NhmemberId,   ot.ordertransactiondata,   o.OrderAmountData,   o.ShippingData   from orders.orders o   join Orders.ordertransactionDetails ot on o.orderid=ot.orderid   where o.orderid=@orderid and ot.orderstatuscode='PAY'  END  
CREATE PROCEDURE [Orders].[GetMemberJSONFromNHMemberId]  (      -- Add the parameters for the stored procedure here   @NHMemberId NVARCHAR(50),   @FirstName NVARCHAR(100),   @LastName NVARCHAR(100),   @PONumber NVARCHAR(100)   --{"firstName":"","lastName":"","phoneNumber":null,"dob":"1950-07-14","address":{},"insurance":{"carrierName":"","planName":"","programeName":"","insuranceMemberId":"","nhMemberId":"","insuranceBenefit":0,"benefitUsed":"","lastBenefitUsedDate":""},"insuranceBenefit":0,"insCarrierId":14,"insPlanId":33}  )  AS  BEGIN  BEGIN TRY      -- SET NOCOUNT ON added to prevent extra result sets from      -- interfering with SELECT statements.      SET NOCOUNT ON     DECLARE @NHMemberIdCheck BIGINT;   DECLARE @FirstLastCheck BIGINT;     IF @NHMemberId IS NOT NULL AND   @FirstName IS NOT NULL AND   @LastName IS NOT NULL AND   @PONumber IS NOT NULL    BEGIN     --1. Check validity of Input Params      SELECT @NHMemberIdCheck = (      SELECT TOP 1        MemberProfileId      FROM provider.MemberProfiles      WHERE NHMemberId = @NHMemberId     )       IF @NHMemberIdCheck is NULL       RAISERROR (       'NH MemberID not found in DB ', -- Message text.         16, -- Severity.         1 -- State.        );       SELECT @FirstLastCheck = (      SELECT TOP 1       MemberProfileId      FROM provider.MemberProfiles      WHERE LOWER(FirstName) = @FirstName AND LOWER(LastName) = @LastName AND NHMemberID = @NhMemberId     )       IF @FirstLastCheck is NULL       RAISERROR (       'Member First Name + Last Name is mis-matched with NHMemberID in DB ', -- Message text.         16, -- Severity.         1 -- State.        );         SELECT TOP (1)      '{'+      '"firstName":"'+ISNULL(a.FirstName,'')+'",'+      '"lastName":"'+ISNULL(a.LastName,'')+'",'+      '"phoneNumber":null,' +      '"dob":"'+ISNULL(FORMAT(memberprofiles.DateOfBirth, 'd', 'en-US' ), '01-01-0001')+'",'+      '"address":{'+      '"address":"'+ISNULL(provider.MemberLocations.Address1, '') + ' ' + ISNULL(provider.MemberLocations.Address2, '')+'",'+      '"city":"'+ISNULL(provider.MemberLocations.City, '')+'",'+      '"state":"'+ISNULL(provider.MemberLocations.State, '')+'",'+      '"zip":"'+ISNULL(provider.memberLocations.ZipCode, '')+'"},'+      '"insurance":{'+      '"carrierName":"'+ISNULL(carr.InsuranceCarrierName, '')+'",'+      '"planName":"'+ISNULL(plans.HealthPlanName, '')+'",'+      '"programeName":"'+case when insurances.InsuranceCarrierID = 207 then ISNULL(prog.DiscountProgramName,'') else '' end+'",'+      '"insuranceMemberId":"'+case when insurances.InsuranceCarrierID = 207 then ISNULL(prog.DiscountProgramMemberID,'') else ISNULL(provider.MemberInsuranceDetails.InsuranceNbr,'') end +'",'+      '"nhMemberId":"'+ISNULL(a.NHMemberId, '')+'",'+      '"insuranceBenefit":'+ case when insurances.InsuranceCarrierID = 207 then cast(0 as nvarchar) else cast(ISNULL(benefit.BenefitAmt,'') as nvarchar) end +','+      '"benefitUsed":"'+''+'",'+      '"lastBenefitUsedDate":"'+''+'"},'+      '"insCarrierId":'+case when insurances.InsuranceCarrierID = 207 then ISNULL(cast(prog.InsuranceCarrierID as nvarchar), '') else ISNULL(cast(insurances.InsuranceCarrierID as nvarchar), '') end +','+      '"insPlanId":'+case when insurances.InsuranceCarrierID = 207 then ISNULL(cast(prog.InsuranceHealthPlanID as nvarchar), '') else ISNULL(cast(insurances.InsuranceHealthPlanID as nvarchar), '') end +'}'      FROM [Orders].[MemberOrdersVStoCRM] a      LEFT OUTER JOIN [vsdatamig].[vsCRMClaimsNew] e ON e.ContactID = a.ContactID      LEFT OUTER JOIN (select memberprofileId, nhmemberid, DateOfBirth from provider.memberprofiles) memberprofiles ON memberprofiles.nhmemberid = SUBSTRING(a.Nhmemberid, 0, 15)       LEFT OUTER JOIN provider.MemberLocations ON memberprofiles.memberprofileid = provider.MemberLocations.MemberProfileID      LEFT OUTER JOIN (select * from provider.MemberInsurances where IsActive = 1) insurances ON insurances.MemberProfileId = memberprofiles.MemberProfileId      LEFT OUTE
  CREATE PROCEDURE [Orders].[GetMemberChartId]   (      -- Add the parameters for the stored procedure here      @NHMemberId NVARCHAR(50)  )  AS  BEGIN  BEGIN TRY      -- SET NOCOUNT ON added to prevent extra result sets from      -- interfering with SELECT statements.      SET NOCOUNT ON     DECLARE @NHMemberIdCheck BIGINT;   DECLARE @MemberChartIdCheck BIGINT;   DECLARE @NewMemberChartId table (MemberChartId bigint);     IF @NHMemberId IS NOT NULL    BEGIN     --1. Check validity of Input Params      SELECT @NHMemberIdCheck = (      SELECT TOP 1 MemberProfileId FROM provider.MemberProfiles      WHERE NHMemberId = @NHMemberId     )       IF @NHMemberIdCheck is NULL       RAISERROR (       'NHMemberId not found in DB', -- Message text.         16, -- Severity.         1 -- State.        );           SELECT @MemberChartIdCheck = (      SELECT TOP 1 MemberChartId FROM provider.MemberCharts      WHERE MemberProfileId = @NHMemberIdCheck      Order by memberchartid desc     )       IF @MemberChartIdCheck is NULL      BEGIN      INSERT INTO provider.MemberCharts      (       MemberProfileId       ,VisitNumber       ,IsChartClosed       ,CreateDate       ,CreateUser       ,ModifyDate       ,ModifyUser       ,IsActive      ) OUTPUT INSERTED.MemberChartId INTO @NewMemberChartId      VALUES (       @NHMemberIdCheck       ,1       ,0       ,GETDATE()       ,'VanillaSoftOrderLoader'       ,GETDATE()       ,'VanillaSoftOrderLoader'       ,1      )      SELECT MemberChartId from @NewMemberChartId;     END     ELSE     BEGIN      SELECT @MemberChartIdCheck;     END          END    ELSE    BEGIN              RAISERROR ('NHMemberId missing', -- Message text.                                  16, -- Severity.                                  1 -- State.                                 );      END    --IF ENDs  END TRY  BEGIN CATCH        DECLARE @ErrorMessage NVARCHAR(4000);        DECLARE @ErrorSeverity INT;        DECLARE @ErrorState INT;          SELECT             @ErrorMessage =  ERROR_MESSAGE(),            @ErrorSeverity = ERROR_SEVERITY(),            @ErrorState = ERROR_STATE();          -- Use RAISERROR inside the CATCH block to return error        -- information about the original error that caused        -- execution to jump to the CATCH block.        RAISERROR (@ErrorMessage, -- Message text.                   @ErrorSeverity, -- Severity.                   @ErrorState -- State.                   );    END CATCH;    END  
  CREATE PROCEDURE [Orders].[CreateOrderMemberChartData]   (      -- Add the parameters for the stored procedure here   @MemberChartId BIGINT,   @Date NVARCHAR(200),   @ProviderId BIGINT,   @LocationId BIGINT  )  AS  BEGIN  BEGIN TRY      -- SET NOCOUNT ON added to prevent extra result sets from      -- interfering with SELECT statements.      SET NOCOUNT ON     DECLARE @MemberChartIdCheck BIGINT;   DECLARE @MemberChartDataId TABLE (ID BIGINT);     IF @Date IS NOT NULL    BEGIN     SELECT @MemberChartIdCheck = (      SELECT TOP 1 MemberChartId FROM provider.MemberCharts      WHERE MemberChartId = @MemberChartId     )       IF @MemberChartIdCheck is NULL       RAISERROR (       'Member Chart not found in DB', -- Message text.         16, -- Severity.         1 -- State.        );       INSERT INTO provider.MemberChartData (      MemberChartId,      DocumentID,      IsDocumentComplete,      MajorProcessId,      MinorProcessId,      ProviderId,      LocationId,      ProcessData,      CreateUser,      CreateDate,      ModifyUser,      ModifyDate,      IsActive     ) OUTPUT INSERTED.MemberChartDataId INTO @MemberChartDataId     VALUES (      @MemberChartId,      0,      1,      5,      23,      @ProviderId,      @LocationId,      '{ "orderId":"XXXXX","orderDate":"'+@Date+'","status":"Complete" }',      CURRENT_USER,      GETDATE(),      CURRENT_USER,      GETDATE(),      1     )       SELECT TOP 1 ID from @MemberChartDataId          END    ELSE    BEGIN              RAISERROR ('Date missing', -- Message text.                                  16, -- Severity.                                  1 -- State.                                 );      END    --IF ENDs  END TRY  BEGIN CATCH        DECLARE @ErrorMessage NVARCHAR(4000);        DECLARE @ErrorSeverity INT;        DECLARE @ErrorState INT;          SELECT             @ErrorMessage =  ERROR_MESSAGE(),            @ErrorSeverity = ERROR_SEVERITY(),            @ErrorState = ERROR_STATE();          -- Use RAISERROR inside the CATCH block to return error        -- information about the original error that caused        -- execution to jump to the CATCH block.        RAISERROR (@ErrorMessage, -- Message text.                   @ErrorSeverity, -- Severity.                   @ErrorState -- State.                   );    END CATCH;    END  
/****** Object:  StoredProcedure [Orders].[ExchangeOrder]    Script Date: 9/28/2018 5:06:20 PM ******/        CREATE PROCEDURE [Orders].[ExchangeOrder]  (  @OldOrderID INT,  @exchangeRequestedBy nvarchar(50),  @NewOrderID INT  )  AS  BEGIN         update ORDERS.ORDERS   set status='RETURNED',orderstatuscode='RET',   [ModifyDate]=getdate() ,   [ModifyUser]=@exchangeRequestedBy   where orderid = @OldOrderID     update ORDERS.ORDERS   set [RefOrderId]=@OldOrderID,   status='ACTIVE',   Ordertype='EXCHANGE',   [ModifyDate]=getdate() ,   [ModifyUser]=@exchangeRequestedBy   where orderid = @NewOrderID     update orders.orderitems    set modifydate=getdate()   ,modifyuser=@exchangeRequestedBy   ,status='RETURNED'   where orderid =@OldOrderID     --update orders.orderitems    --set modifydate=getdate()   --,modifyuser=@exchangeRequestedBy   --,status='EXCHANGE'   --where orderid =@NewOrderID      END    
CREATE PROCEDURE [Orders].[GetPOChannelsByOrderId]              @OrderID bigint  AS  BEGIN      SET NOCOUNT ON;                SELECT DISTINCT                a.[IsSinglePO],               a.[ItemTypeCode],                (                CASE WHEN a.[CommunicationMode] IS null OR b.[StyleCode] is null THEN 'EMAIL'                        -- ELSE JSON_VALUE(a.[CommunicationMode],'$."'+b.[StyleCode]+'"')      WHEN JSON_VALUE(a.[CommunicationMode],'$."'+b.[StyleCode]+'"') IS NULL THEN 'EMAIL'      ELSE JSON_VALUE(a.[CommunicationMode],'$."'+b.[StyleCode]+'"')                        END                  ) AS [POChannel]                  FROM Orders.ItemTypeConfig a                  INNER JOIN  Orders.OrderItems b on                         b.[ItemType] = a.[ItemTypeCode] and                         b.BrandCode is not null and b.IsActive=1 and                         b.BrandCode = a.BrandCode and                         b.OrderId=@OrderID and                         b.OrderId=@OrderID    END
CREATE PROCEDURE [Orders].[GetExchangeCredit](@NHMemberId NVARCHAR(20))  AS  BEGIN    SELECT  1 AS ID, ISNULL(SUM(CONVERT(FLOAT,JSON_VALUE(OrderAmountData, '$.exchangeCredit'))),0) AS 'ExchangeCredit',ISNULL(SUM(CONVERT(FLOAT,JSON_VALUE(OrderAmountData, '$.cancelCredit'))),0) AS 'CancelCredit' FROM [Orders].[Orders] WHERE NHMemberId = @NHMemberId  END  
  --create schema otccatalog   --GO     --  -- =============================================                                  -- Author:      Veeran Darla                                  -- Create Date: 21/11/2020                                  -- Description: This Procedure used to Get the Item Details For Depasco  -- =============================================                                  --                                   -- EXEC [Orders].[GetOTCOrderItemDetailsForDepasco] 1    --                           --       CREATE PROC [Orders].[GetOTCOrderItemDetailsForDepasco] @Hours INT  AS    BEGIN     SELECT   --TOP 50   i.NationsId     ,o.OrderId     ,oi.ItemCode     ,oi.Quantity     ,oi.Amount     ,oi.STATUS     ,oi.UnitPrice     ,oi.PairPrice     ,oi.ItemType     ,oi.OrderID     ,o.Source     ,oi.Amount     ,o.NHMemberId     ,o.OrderStatusCode     ,imav.ModelAttributeValueID     ,VendorCode     ,ic.insuranceCarrierName tradingPartner   ,o.[CreateUser]   ,JSON_VALUE(o.MemberData, '$.firstName') FirstName     ,JSON_VALUE(o.MemberData, '$.lastName') LastName     ,JSON_VALUE(o.MemberData, '$.phoneNumber') PhoneNumber     ,JSON_VALUE(o.MemberData, '$.email') Email     ,JSON_VALUE(o.MemberData, '$.address.address1') Address1     ,JSON_VALUE(o.MemberData, '$.address.city') City     ,JSON_VALUE(o.MemberData, '$.address.state') STATE     ,JSON_VALUE(o.MemberData, '$.address.zip') Zip     ,JSON_VALUE(o.MemberData, '$.address.country') Country     ,JSON_VALUE(o.ShippingData, '$.address.address1') SdAddress1     ,JSON_VALUE(o.ShippingData, '$.address.address2') SdAddress2     ,JSON_VALUE(o.ShippingData, '$.address.city') SdCity     ,JSON_VALUE(o.ShippingData, '$.address.state') SdSTATE     ,JSON_VALUE(o.ShippingData, '$.address.zip') SdZip     ,JSON_VALUE(o.ShippingData, '$.address.country') SdCountry     ,JSON_VALUE(o.ShippingData, '$.email') SdEmail     ,JSON_VALUE(o.ShippingData, '$.firstName') SdFirstName     ,JSON_VALUE(o.ShippingData, '$.lastName') SdLastName     ,JSON_VALUE(o.ShippingData, '$.phoneNumber') SdPhoneNumber     ,oi.Quantity     ,o.NHMemberId     ,oi.UnitPrice     ,oi.OrderItemId     ,O.CreateDate     ,OrderItemId    FROM Orders.OrderItems  AS oi    LEFT JOIN Orders.Orders AS o ON o.OrderId = oi.OrderId    AND DATEDIFF(minute, o.CreateDate, GetUTCDATE()) >= 1 --@Hours    LEFT JOIN [catalog].[ItemMasterAttributeValues] imav ON CAST( imav.ItemCode  as nvarchar(50)) = CAST(oi.ItemCode as nvarchar(50))   AND oi.IsActive = 1    INNER JOIN master.Members m ON m.NHMemberID = o.NHMemberId    JOIN otccatalog.ItemMaster i ON i.ItemCode = oi.ItemCode    left join insurance.insuranceCarriers ic on ic.insuranceCarrierId = JSON_VALUE(o.MemberData, '$.insCarrierId')     WHERE o.Source = 'OTC_STORE'    --  AND o.OrderStatusCode = 'INI'     AND imav.AttributeCode = 'NATIONS_ID'  and o.IsActive=1  --and o.OrderID='200016336'        and o.OrderId IN (200181223,200181224,200181225,200181226,200181227,200181228,200181229,200181232,200181233,200181234,200181235,200181236,200181237,200181238,200181239,200181240,200181241,200181242,200181243,200181321,200181322,200181323,200181324,200181325,200181326,200181327,200181328,200181329,200181330,200181331,200181332,200181333,200181334,200181334,200181335,200181336,200181337,200181338,200181339,200181340,200181341,200181342,200181343,200181344,200181345,200181346,200181347,200181348,200181349,200181350,200181298,200181299,200181300,200181301,200181302,200181303,200181304,200181305,200181306,200181307,200181308,200181309,200181310,200181311,200181312,200181313,200181314,200181315,200181316,200181317,200181318,200181319,200181320,200181261,200181262,200181263,200181264,200181265,200181266,200181267,200181268,200181269,200181270,200181271,200181272,200181273,200181274,200181275,200181276,200181277,200181278,200181279,200181280,200181281,200181282,200181283,200181284,200181285,200181286,200181287,200181288,200181289,200181290,200181291,200181292,200181293,200181294,200181295,200181296,200181
  /*  Remarks: Fix rounding issue  Mohan Deployed to Stage on 5/13/2020  Mohan Deployed this flag to Stage on 14 May 2020  Mohan Deployed this flag to Prod on 15 May 2020  */    CREATE procedure [otc].[GetStoreFrontProducts_BM_bkp_20200521_null_mprice] @planId INT, @contractType VARCHAR(50)    as    begin                      DECLARE @hpId varchar(max);        if(@contractType is not null and @contractType <> '')        begin         set @hpId =(select string_agg(HealthPlanContractId,',') from Insurance.HealthPlanContracts         where isactive=1 and InsuranceHealthPlanId in         (SELECT InsuranceHealthPlanId FROM [Insurance].[InsuranceHealthPlans] WHERE Json_value(planconfigdata,'$.purseName') in (      SELECT LTRIM(RTRIM(value)) AS Item FROM STRING_SPLIT(@contractType,',') WHERE LEN(Value) > 0)))        end        else        begin        set @hpId=cast((select HealthPlanContractId from Insurance.HealthPlanContracts         where isactive=1 and InsuranceHealthPlanId = @planId) as varchar)        end     IF OBJECT_ID('tempdb..#TempProducts') IS NOT NULL        begin                drop table #TempProducts        end        create table #TempProducts(      ItemCode varchar(50) not null,      PerDeviceMemberPrice decimal(10,2),      RestockDate DateTime null,      StockStatus varchar(30) null,      CatalogName varchar(100) null,      CatalogColorCode varchar(30) null ,    HealthPlanName varchar(200) null    );    ----------Commented by @DPSR  /*      execute('        insert INTO #TempProducts(ItemCode,PerDeviceMemberPrice,RestockDate,StockStatus,CatalogName,CatalogColorCode,HealthPlanName)        SELECT cp.ItemCode, cp.PerDeviceMemberPrice        ,cp.RestockDate as RestockDate        ,ISNULL(StockStatus, ''Stock'') as StockStatus,        Json_value(planconfigdata,''$.purseName'') as CatalogName,        Json_value(planconfigdata,''$.catalogColorCode'') as CatalogColorCode,ihp.HealthPlanName FROM Insurance.ContractProducts cp        join Insurance.HealthPlanContracts hpc on hpc.HealthPlanContractId=cp.HealthPlanContractId        join [Insurance].[InsuranceHealthPlans] ihp on ihp.InsuranceHealthPlanId=hpc.InsuranceHealthPlanId           WHERE cp.HealthPlanContractId in ('+@hpId+') AND cp.IsActive = 1');      --WHERE cp.HealthPlanContractId in (SELECT LTRIM(RTRIM(value)) AS Item FROM STRING_SPLIT(@hpId,',') WHERE LEN(Value) > 0) AND cp.IsActive = 1;    */  ------------New Code added by @DPSR    declare @Xhpid varchar(20);    DECLARE cursor_name CURSOR For    SELECT LTRIM(RTRIM(value)) as Xhpid    FROM STRING_SPLIT(@hpId,',')     WHERE LEN(Value) > 0;      OPEN cursor_name;    FETCH NEXT FROM cursor_name INTO @Xhpid;    WHILE @@FETCH_STATUS = 0      BEGIN    --select  @Xhpid    EXECUTE ('insert INTO #TempProducts(ItemCode,PerDeviceMemberPrice,RestockDate,StockStatus,CatalogName,CatalogColorCode,HealthPlanName)      SELECT cp.ItemCode, cp.PerDeviceMemberPrice      ,cp.RestockDate as RestockDate      ,ISNULL(StockStatus, ''Stock'') as StockStatus,      Json_value(planconfigdata,''$.purseName'') as CatalogName,      Json_value(planconfigdata,''$.catalogColorCode'') as CatalogColorCode,ihp.HealthPlanName FROM Insurance.ContractProducts cp      join Insurance.HealthPlanContracts hpc on hpc.HealthPlanContractId=cp.HealthPlanContractId      join [Insurance].[InsuranceHealthPlans] ihp on ihp.InsuranceHealthPlanId=hpc.InsuranceHealthPlanId       WHERE cp.HealthPlanContractId in ('+@Xhpid+') AND cp.IsActive = 1');          FETCH NEXT FROM cursor_name INTO @Xhpid;      END;    CLOSE cursor_name;    DEALLOCATE cursor_name;  -----------------------END @DPSR---------------------------------------------------              SELECT row_number() OVER (ORDER BY [ItemCode] ASC) RowID, * FROM (                  SELECT                  --row_number() OVER (ORDER BY it.[ItemCode] ASC) RowID                  --,                  modelcontent.[ModelShortDescription] AS Title                  ,modelcontent.[ModelLongDescription] AS Description            
     -- =============================================  -- Author:      Mohan Nanduri  -- Create Date: 11/1/2020  -- Description: This procedure returns LoginConfiguraitons   -- =============================================  CREATE PROCEDURE [otc].[GetCarrierConfig] (   -- Add the parameters for the stored procedure here   @domain VARCHAR(100) = ''   ,@envelopJson VARCHAR(2000) = ''   )  AS  BEGIN   -- SET NOCOUNT ON added to prevent extra result sets from   -- interfering with SELECT statements.   SET NOCOUNT ON     -- Global Error variables declaration    BEGIN    DECLARE @msg51400 BIGINT = 51400    DECLARE @msg51400Text VARCHAR(1000) = 'Invalid Input'    DECLARE @msg51401 BIGINT = 51401    DECLARE @msg51401Text VARCHAR(1000) = 'Un-authorized '    DECLARE @msg51503 BIGINT = 51503    DECLARE @msg51503Text VARCHAR(1000) = 'Sorry, we are unble to serve you. Please contact 1-833-746-7682 for further assistance'    DECLARE @msg51500 BIGINT=51500 --errorStatus code for any exception occure while excuting    DECLARE @errorMsg NVARCHAR(1000)    DECLARE @errorSeverity INT   END     -- Global Variables    BEGIN    DECLARE @InsuranceCarrierID BIGINT    DECLARE @InsuranceHealthPlanID BIGINT    DECLARE @Status VARCHAR(100)    DECLARE @StatusNotEnabled VARCHAR(100) = 'NotEnabled'    DECLARE @StatusLoginEnabled VARCHAR(100) = 'LoginEnabled'    DECLARE @StatusRedirect VARCHAR(100) = 'Redirect'    DECLARE @StatusMessage VARCHAR(1000)    DECLARE @LoginEnvelop VARCHAR(2000)    DECLARE @CarrierConfig VARCHAR(2000)    DECLARE @otcContentConfig VARCHAR(2000)    DECLARE @otcLoginConfig VARCHAR(2000)    DECLARE @otcAppConfig VARCHAR(2000)   END     BEGIN TRY    -- 1. Validate Input     IF (      @domain IS NULL      OR (       @envelopJson IS NOT NULL       AND ISJSON(@envelopJson) <> 1       )      )    BEGIN     PRINT 'Validation failed : Domain passed is null [' + @domain + '] OR envelop is not valid json [ ' + @envelopJson + ']';       THROW @msg51400      ,@msg51400Text      ,1;    END      --NONE SSO FLOW     --IF ( @envelopJson is null )    BEGIN     SELECT TOP 1 @InsuranceCarrierID = InsuranceCarrierID     FROM Insurance.InsuranceCarriers     WHERE IsActive = 1      AND JSON_VALUE(CarrierConfig, '$.subdomain') = @domain     ORDER BY InsuranceCarrierId       IF (@InsuranceCarrierID = 0)     BEGIN      PRINT 'No Insurance Carrier ID found for Subdomain [ ' + @domain + ']';        THROW @msg51503       ,@msg51503Text       ,1;     END       SET @Status = @StatusRedirect       SELECT @CarrierConfig = CarrierConfig     FROM Insurance.InsuranceCarriers     WHERE IsActive = 1      AND InsuranceCarrierID = @InsuranceCarrierID       SELECT @otcLoginConfig = ConfigData     FROM Insurance.InsuranceConfig     WHERE IsActive = 1      AND InsuranceCarrierID = @InsuranceCarrierID      AND InsuranceHealthPlanId IS NULL      AND ConfigType = 'OTCLOGIN'       SELECT @otcContentConfig = ConfigData     FROM Insurance.InsuranceConfig     WHERE IsActive = 1      AND InsuranceCarrierID = @InsuranceCarrierID      AND InsuranceHealthPlanId IS NULL      AND ConfigType = 'OTCCONTENT'       SELECT @otcAppConfig = ConfigData     FROM Insurance.InsuranceConfig     WHERE IsActive = 1      AND InsuranceCarrierID = @InsuranceCarrierID      AND InsuranceHealthPlanId IS NULL      AND ConfigType = 'OTCAPP'       SELECT @Status AS STATUS      ,'' AS statusMessage      ,@LoginEnvelop AS loginEnvelop      ,@CarrierConfig AS carrierConfig      ,@otcContentConfig AS otcContentConfig      ,@otcLoginConfig AS otcLoginConfig      ,@otcAppConfig AS otcAppConfig      ,(       SELECT @InsuranceCarrierID AS InsuranceCarrierID       ,NULL AS InsuranceHealthPlanID       FOR JSON PATH       ,WITHOUT_ARRAY_WRAPPER      ) AS insuranceInfo    END     -- SSO FLOW     --ELSE      -- BEGIN     -- IF(@envelopJson is not null and ISJSON(@envelopJson) =  1)     --  BEGIN      --  --Valdiate Envelope      --  SET @Status = otc.ValidateSSOEnvelop(@domain,@envelopJson)     --  IF ( @Status is not null )
  -- =============================================  -- Author:      Satish Lakkimsetti  -- Create Date: 10-November-2020  -- Description: Verifying card availability in otc.Cards table and insert if it is not in that table  -- =============================================  create PROCEDURE [otc].[VerifyAndInsertBenefitCard] (   -- Add the parameters for the stored procedure here   @nhMemberId NVARCHAR(50)   ,@cardNumber NVARCHAR(50)   ,@serialNumber NVARCHAR(50)   ,@memberID NVARCHAR(50) OUTPUT   )  AS  BEGIN   -- SET NOCOUNT ON added to prevent extra result sets from   SET NOCOUNT ON     ----Variable declaration   DECLARE @nhId NVARCHAR(50);   DECLARE @cardId BIGINT     ------Business logic to veryfying and inserting card details    SELECT @cardId = cardId    ,@nhId = NHMemberId   FROM otc.Cards   WHERE CardNumber = @cardNumber     PRINT @cardId   PRINT @nhId     IF (@nhId IS NULL)    SET @nhId = @nhMemberId;     IF (     @cardId IS NULL     OR @cardId = 0     )    INSERT INTO otc.Cards (     NHMemberId     ,CardNumber     ,SerialNbr     ,CreateDate     ,CreateUser     ,ModifyDate     ,ModifyUser     ,IsActive     )    VALUES (     @nhId     ,@cardNumber     ,@serialNumber     ,GetDate()     ,'script'     ,GetDate()     ,'script'     ,1     )   ELSE    UPDATE otc.Cards    SET NHMemberId = @nhid     ,SerialNbr=@serialNumber     ,ModifyDate = getdate()     ,ModifyUser = 'script'    WHERE CardNumber = @cardNumber     AND NHMemberId IS NULL     SET @memberID = @nhId  END  
    -- =============================================  -- Author:      Mohan Nanduri, Satish Lakkimsetti  -- Create Date: 3rd Nov 2020  -- Description: This method verifies SSO Input againts domain and returns true Or false   -- =============================================  CREATE FUNCTION [otc].[ValidateSSOEnvelop]  (      -- Add the parameters for the function here   @domain varchar(100),   @loginTemplateName varchar(100),    @envelopJson varchar(2000)   )  RETURNS varchar(2000)  AS  BEGIN   -- Global Variables    BEGIN    declare @InsuranceCarrierID bigint    declare @InsuranceHealthPlanID bigint    declare @Status varchar(100)    declare @StatusNotEnabled varchar(100) = 'NotEnabled'    declare @StatusLoginEnabled varchar(100) = 'LoginEnabled'    declare @StatusRedirect varchar(100) = 'Redirect'    declare @StatusMessage varchar(1000)    declare @LoginEnvelop varchar(2000)    declare @CarrierConfig varchar(2000)    declare @otcContentConfig varchar(2000)    declare @otcLoginConfig varchar(2000)    declare @fieldValidationConfig varchar(2000)    declare @fieldname varchar(1000)    END      -- Declare the return variable here   -- Extract LogingTemplateConfig by using domain       SET @StatusMessage = null;   --SELECT @InsuranceCarrierID = InsuranceCarrierID from Insurance.InsuranceCarriers    --   where IsActive=1 and JSON_VALUE(CarrierConfig, '$.subdomain') = @domain       --SELECT @otcLoginConfig = ConfigData from Insurance.InsuranceConfig   --  where IsActive=1 and InsuranceCarrierID=@InsuranceCarrierID and InsuranceHealthPlanId is null and ConfigType='OTCLOGIN'      IF (@loginTemplateName is null)    BEGIN      SET @StatusMessage =  'Insurance.InsuranceConfig table is missing '+@loginTemplateName+' LoginTemplate is mssing for domain [' + @domain + ']';    END   ELSE    BEGIN     SELECT @fieldValidationConfig = FieldValidationConfig from Insurance.LoginTemplateConfig where LoginTemplate = @loginTemplateName and IsActive=1     IF (@fieldValidationConfig is null)     SET @StatusMessage = 'Insurance.LoginTemplateConfig itable is missing LoginTemplate values for template [ ' + @loginTemplateName + '] '                -- Validation of memFirstName     set @fieldname = 'memFirstName'     IF (otc.ValidateJsonField(@fieldValidationConfig,@envelopJson,@fieldname) is not null)       SET @StatusMessage = @StatusMessage +otc.ValidateJsonField(@fieldValidationConfig,@envelopJson,@fieldname)     -- Validation of memLastName     set @fieldname = 'memLastName'     IF (otc.ValidateJsonField(@fieldValidationConfig,@envelopJson,@fieldname) is not null)       SET @StatusMessage = @StatusMessage +otc.ValidateJsonField(@fieldValidationConfig,@envelopJson,@fieldname)     -- Validation of memDOB     set @fieldname = 'memDOB'     IF (otc.ValidateJsonField(@fieldValidationConfig,@envelopJson,@fieldname) is not null)       SET @StatusMessage = @StatusMessage +otc.ValidateJsonField(@fieldValidationConfig,@envelopJson,@fieldname)     -- Validation of NHMemberID     set @fieldname = 'NHMemberID'     IF (otc.ValidateJsonField(@fieldValidationConfig,@envelopJson,@fieldname) is not null)       SET @StatusMessage = @StatusMessage +otc.ValidateJsonField(@fieldValidationConfig,@envelopJson,@fieldname)     -- Validation of CarrierID     set @fieldname = 'CarrierID'     IF (otc.ValidateJsonField(@fieldValidationConfig,@envelopJson,@fieldname) is not null)       SET @StatusMessage = @StatusMessage +otc.ValidateJsonField(@fieldValidationConfig,@envelopJson,@fieldname)     -- Validation of PlanId     set @fieldname = 'PlanId'     IF (otc.ValidateJsonField(@fieldValidationConfig,@envelopJson,@fieldname) is not null)       SET @StatusMessage = @StatusMessage +otc.ValidateJsonField(@fieldValidationConfig,@envelopJson,@fieldname)     -- Validation of otcCardNumber     set @fieldname = 'otcCardNumber'     IF (otc.ValidateJsonField(@fieldValidationConfig,@envelopJson,@fieldname) is not null)       SET @StatusMessage = @StatusMessage +otc.ValidateJsonField(@fieldValida
    -- =============================================  -- Author:      Satish Lakkimsetti  -- Create Date: 4th Nov 2020  -- Description: Return products that in order of no of units sold per product  -- =============================================  CREATE PROCEDURE [otc].[GetTopSellingProducts]  (   @count int = 50,   @nLastDays int=14  )  AS  BEGIN    SELECT TOP (@count) it.[ItemCode], CAST(ISNULL(COUNT(*), 0) AS INT) AS TotalSales  FROM [catalog].[ItemMasterList] it  LEFT JOIN [Orders].[OrderItems] ot ON it.[ItemCode]=ot.[ItemCode]  INNER JOIN [Orders].[Orders] o ON o.[OrderId]=ot.[OrderId]  WHERE 1=1   AND it.[ItemType]='OTC'   AND o.[OrderType]='OTC' AND ot.[ItemType]='OTC'   AND ot.[Status]='Active' AND o.[Status]='Active'   AND it.[IsActive]=1 AND ot.[IsActive]=1 AND o.[IsActive]=1   AND o.CreateDate >= getDate()- @nLastDays  GROUP BY it.[ItemCode]  ORDER BY ISNULL(COUNT(*), 0) DESC  END    
-- =============================================  -- Author:      Mohan Nanduri, Satish Lakkimsetti  -- Create Date: 3rd Nov 2020  -- Description: Validates json fields that are mandate  -- =============================================  CREATE FUNCTION [otc].[ValidateJsonField]  (      -- Add the parameters for the function here      @fieldValidationConfig varchar(2000),   @envelopJson varchar(2000),   @fieldname varchar(100)  )  RETURNS varchar(1000)  AS  BEGIN      -- Declare the return variable here      DECLARE @StatusMessage varchar(1000) = null        -- Add the T-SQL statements to compute the return value here     IF (JSON_VALUE(@fieldValidationConfig,'$.' + @fieldname)='true' and       (JSON_VALUE(@envelopJson, '$.' + @fieldname) is null OR        JSON_VALUE(@envelopJson, '$.' + @fieldname ) = ''))       SET @StatusMessage = @fieldname + 'is missing, ';        -- Return the result of the function      RETURN @StatusMessage  END  
CREATE PROCEDURE [otc].[GetRecommendedProducts]  (   @nhMemberId varchar(50),   @count int = 50  )  AS  BEGIN    SELECT TOP (@count) it.[ItemCode], CAST(ISNULL(COUNT(*), 0) AS INT) AS TotalSales  FROM [catalog].[ItemMasterList] it  LEFT JOIN [Orders].[OrderItems] ot ON it.[ItemCode]=ot.[ItemCode]  INNER JOIN [Orders].[Orders] o ON o.[OrderId]=ot.[OrderId]  INNER JOIN (   SELECT DISTINCT picd.[ItemCode]   FROM [otc].[MemberICD10Codes] mc   INNER JOIN [otc].[ProductICDCategoriesAndICDCodes] picd   ON mc.[ICD10Code]=picd.[ICD10Code]   WHERE 1=1    AND [NHMemberId]=@nhMemberId    AND [IsActive]=1  ) micd ON micd.[ItemCode]=it.[ItemCode]  WHERE 1=1   AND it.[ItemType]='OTC'   AND o.[OrderType]='OTC' AND ot.[ItemType]='OTC'   AND ot.[Status]='Active' AND o.[Status]='Active'   AND it.[IsActive]=1 AND ot.[IsActive]=1 AND o.[IsActive]=1  GROUP BY it.[ItemCode]  ORDER BY ISNULL(COUNT(*), 0) DESC  END
    -- =============================================  -- Author:      Satish Lakkimsetti  -- Create Date: 4th Nov 2020  -- Description: Used with others procedures to return products based on key word  -- =============================================  CREATE procedure [otc].[GetProductsForPlan] @planId INT, @contractType VARCHAR(50)    as    begin                      DECLARE @hpId varchar(max);        if(@contractType is not null and @contractType <> '')        begin         set @hpId =(select string_agg(HealthPlanContractId,',') from Insurance.HealthPlanContracts         where isactive=1 and InsuranceHealthPlanId in         (SELECT InsuranceHealthPlanId FROM [Insurance].[InsuranceHealthPlans] WHERE Json_value(planconfigdata,'$.purseName') in (      SELECT LTRIM(RTRIM(value)) AS Item FROM STRING_SPLIT(@contractType,',') WHERE LEN(Value) > 0)))        end        else        begin        set @hpId=cast((select HealthPlanContractId from Insurance.HealthPlanContracts         where isactive=1 and InsuranceHealthPlanId = @planId) as varchar)        end     IF OBJECT_ID('tempdb..#TempProducts') IS NOT NULL        begin                drop table #TempProducts        end        create table #TempProducts(      ItemCode varchar(50) not null,      PerDeviceMemberPrice decimal(10,2),      RestockDate DateTime null,      StockStatus varchar(30) null,      CatalogName varchar(100) null,      CatalogColorCode varchar(30) null ,    HealthPlanName varchar(200) null    );    ----------Commented by @DPSR  /*      execute('        insert INTO #TempProducts(ItemCode,PerDeviceMemberPrice,RestockDate,StockStatus,CatalogName,CatalogColorCode,HealthPlanName)        SELECT cp.ItemCode, cp.PerDeviceMemberPrice        ,cp.RestockDate as RestockDate        ,ISNULL(StockStatus, ''Stock'') as StockStatus,        Json_value(planconfigdata,''$.purseName'') as CatalogName,        Json_value(planconfigdata,''$.catalogColorCode'') as CatalogColorCode,ihp.HealthPlanName FROM Insurance.ContractProducts cp        join Insurance.HealthPlanContracts hpc on hpc.HealthPlanContractId=cp.HealthPlanContractId        join [Insurance].[InsuranceHealthPlans] ihp on ihp.InsuranceHealthPlanId=hpc.InsuranceHealthPlanId           WHERE cp.HealthPlanContractId in ('+@hpId+') AND cp.IsActive = 1');      --WHERE cp.HealthPlanContractId in (SELECT LTRIM(RTRIM(value)) AS Item FROM STRING_SPLIT(@hpId,',') WHERE LEN(Value) > 0) AND cp.IsActive = 1;    */  ------------New Code added by @DPSR    declare @Xhpid varchar(20);    DECLARE cursor_name CURSOR For    SELECT LTRIM(RTRIM(value)) as Xhpid    FROM STRING_SPLIT(@hpId,',')     WHERE LEN(Value) > 0;      OPEN cursor_name;    FETCH NEXT FROM cursor_name INTO @Xhpid;    WHILE @@FETCH_STATUS = 0      BEGIN    --select  @Xhpid    EXECUTE ('insert INTO #TempProducts(ItemCode,PerDeviceMemberPrice,RestockDate,StockStatus,CatalogName,CatalogColorCode,HealthPlanName)      SELECT cp.ItemCode, cp.PerDeviceMemberPrice      ,cp.RestockDate as RestockDate      ,ISNULL(StockStatus, ''Stock'') as StockStatus,      Json_value(planconfigdata,''$.purseName'') as CatalogName,      Json_value(planconfigdata,''$.catalogColorCode'') as CatalogColorCode,ihp.HealthPlanName FROM Insurance.ContractProducts cp      join Insurance.HealthPlanContracts hpc on hpc.HealthPlanContractId=cp.HealthPlanContractId      join [Insurance].[InsuranceHealthPlans] ihp on ihp.InsuranceHealthPlanId=hpc.InsuranceHealthPlanId       WHERE cp.HealthPlanContractId in ('+@Xhpid+') AND cp.IsActive = 1');          FETCH NEXT FROM cursor_name INTO @Xhpid;      END;    CLOSE cursor_name;    DEALLOCATE cursor_name;  -----------------------END @DPSR---------------------------------------------------              SELECT row_number() OVER (ORDER BY [ItemCode] ASC) RowID, * FROM (                  SELECT                  --row_number() OVER (ORDER BY it.[ItemCode] ASC) RowID                  --,                  modelcontent.[ModelShortDescription] AS Title                  ,modelcontent.[Model
-- =============================================  -- Author:      Mohan Nanduri  -- Create Date: 4th Nov 2020  -- Description: This valdiates user if he is valid and /or registered   -- =============================================  CREATE PROCEDURE [otc].[ValidateNHManagedMemberToRegistration] (   @SubDomain NVARCHAR(100)   ,@Memberid NVARCHAR(100)   ,@DOB NVARCHAR(100) = NULL   ,@LastName NVARCHAR(100) = NULL   )  AS  BEGIN   DECLARE @IsValid BIT   DECLARE @IsRegistered BIT   DECLARE @errorMsg NVARCHAR(1000)   DECLARE @errorSeverity INT   DECLARE @NHMemberId VARCHAR(50)     BEGIN TRY    SELECT @NHMemberId = m.NHMemberId    FROM [Master].members m    INNER JOIN [Master].memberinsurances mi ON m.memberid = mi.memberid    INNER JOIN [Master].memberinsurancedetails mid ON mi.ID = mid.MemberInsuranceID    INNER JOIN [Insurance].InsuranceCarriers ic ON ic.InsuranceCarrierID = mi.InsuranceCarrierID    INNER JOIN [Insurance].[HealthPlanContracts] hpc ON hpc.insurancecarrierid = ic.insurancecarrierid     AND mi.insurancehealthplanid = hpc.insurancehealthplanid     AND hpc.IsActive = 1    INNER JOIN insurance.contractrules cr ON cr.healthplancontractid = hpc.healthplancontractid     AND cr.IsActive = 1    INNER JOIN [rulesengine].[BenefitRulesData] brd ON brd.benefitruledataid = cr.benefitruledataid     AND brd.IsActive = 1    --join insurance carriers for subdomain match with insurance carrierconfig join on Insurance career id with MemberInsurances table    WHERE mid.InsuranceNbr = @memberid     AND JSON_VALUE(ic.CarrierConfig, '$.subdomain') = @SubDomain --validating subdomain     AND json_value(brd.benefitruledata, '$.BENTYPE') = 'OTC' ---validating benefittype     AND GETDATE() BETWEEN mi.InsuranceEffectiveDate      AND mi.InsuranceEndDate -----validating insurance effective date        --AND mi.InsuranceType IN (       -- 'primary'       -- ,'discount'       -- ) ----validating insurance type --(other than secondary and tertiary insurances )     AND mi.IsActive = 1     AND m.IsActive = 1     AND mid.IsActive = 1     AND 1 = CASE       WHEN @DOB IS NOT NULL       AND CAST(m.dateofbirth AS DATE) = CAST(@DOB AS DATE)       THEN 1      WHEN @DOB IS NULL       THEN 1      ELSE 0      END     AND 1 = CASE       WHEN @LastName IS NOT NULL       AND m.lastname = @LastName       THEN 1      WHEN @LastName IS NULL       THEN 1      ELSE 0      END     AND NOT EXISTS (      SELECT *      FROM [provider].[IVQueue] ivq      WHERE ivq.NHMemberID = m.NHMemberID       AND ivq.insurancecarrierId = mi.Insurancecarrierid       AND ivq.insurancehealthplanid = mi.Insurancehealthplanid       AND (ivq.IsApproved = 0  OR ivq.IsApproved IS NULL)       AND ivq.IsActive = 1      )      SET @IsValid = CASE       WHEN @NHMemberId IS NOT NULL       THEN 1      ELSE 0      END    SET @IsRegistered = CASE       WHEN EXISTS (        SELECT *        FROM [otc].userprofiles        WHERE username = @Memberid        --AND subdomain = @SubDomain        )       THEN 1      ELSE 0      END      SELECT @IsValid AS IsValid     ,@IsRegistered AS IsRegistered     ,@NHMemberId AS NHMemberId   END TRY     BEGIN CATCH    SELECT @errorMsg = ERROR_MESSAGE()     ,@errorSeverity = ERROR_SEVERITY();      THROW 51500     ,@errorMsg     ,@errorSeverity   END CATCH  END  
  -- =============================================  -- Author:      Satish Lakkimsetti  -- Create Date: 23-11-2020  -- Description: Returns products which the member had purchased before  -- =============================================  CREATE PROCEDURE [otc].[GetBuyItAgainItemCodes]  (   @nhMemberId NVARCHAR(30)    )  AS  BEGIN      SET NOCOUNT ON   SELECT  it.[ItemCode], CAST(ISNULL(COUNT(*), 0) AS INT) AS TotalSales  FROM [catalog].[ItemMasterList] it  LEFT JOIN [Orders].[OrderItems] ot ON it.[ItemCode]=ot.[ItemCode]  INNER JOIN [Orders].[Orders] o ON o.[OrderId]=ot.[OrderId]  WHERE 1=1   AND it.[ItemType]='OTC'   AND o.[OrderType]='OTC' AND ot.[ItemType]='OTC' AND o.NHMemberId=@nhMemberId   AND ot.[Status]='Active' AND o.[Status]='Active'   AND it.[IsActive]=1 AND ot.[IsActive]=1 AND o.[IsActive]=1  GROUP BY it.[ItemCode]  ORDER BY ISNULL(COUNT(*), 0) DESC       END  
/*   Return First, Last names from provider, if profile exists in provider schema tables  */    -- =============================================  -- Author:      Mohan Nanduri  -- Create Date: 3rd NOv 2020  -- Description: This Method returns the a record with AuthenticationResponse whihc is mandate to launch OTC storefront Page   -- =============================================    CREATE PROCEDURE [otc].[ReturnLoginAuthenticationResponse] (   -- Add the parameters for the stored procedure here    @domain VARCHAR(100)   ,@envelopJson VARCHAR(2000)   ,@nhMemberId VARCHAR(100)   )  AS  BEGIN   -- Global Variables    BEGIN    DECLARE @InsuranceCarrierID BIGINT    DECLARE @InsuranceHealthPlanID BIGINT    DECLARE @Status VARCHAR(100)    DECLARE @StatusNotEnabled VARCHAR(100) = 'NotEnabled'    DECLARE @StatusLoginEnabled VARCHAR(100) = 'LoginEnabled'    DECLARE @StatusRedirect VARCHAR(100) = 'Redirect'    DECLARE @StatusMessage VARCHAR(1000)    DECLARE @CarrierConfig VARCHAR(2000)    DECLARE @otcContentConfig VARCHAR(2000)    DECLARE @otcLoginConfig VARCHAR(2000)    DECLARE @otcAppConfig VARCHAR(2000)    DECLARE @fieldValidationConfig VARCHAR(2000)    DECLARE @fieldname VARCHAR(1000)    DECLARE @LoginTemplate VARCHAR(500)    DECLARE @MemberId BIGINT --refering master schema    DECLARE @cardNumber NVARCHAR(50)    DECLARE @msg51500 BIGINT = 51500 --errorStatus code for any exception occure while excuting    DECLARE @errorMsg NVARCHAR(1000)    DECLARE @errorSeverity INT    DECLARE @insuranceNbr NVARCHAR(100)   END     SET @StatusMessage = NULL;   SET @cardNumber = JSON_VALUE(@envelopJson, '$.CardNumber')   SET @insuranceNbr = JSON_VALUE(@envelopJson, '$.InsuranceNumber')     BEGIN TRY    -- Extract Configs by using domain     BEGIN     SELECT TOP 1 @InsuranceCarrierID = InsuranceCarrierID     FROM Insurance.InsuranceCarriers     WHERE IsActive = 1      AND JSON_VALUE(CarrierConfig, '$.subdomain') = @domain     ORDER BY InsuranceCarrierId               SELECT @CarrierConfig = CarrierConfig     FROM Insurance.InsuranceCarriers     WHERE IsActive = 1      AND InsuranceCarrierID = @InsuranceCarrierID       SELECT @otcLoginConfig = ConfigData     FROM Insurance.InsuranceConfig     WHERE IsActive = 1      AND InsuranceCarrierID = @InsuranceCarrierID      AND InsuranceHealthPlanId IS NULL      AND ConfigType = 'OTCLOGIN'       SELECT @otcAppConfig = ConfigData     FROM Insurance.InsuranceConfig     WHERE IsActive = 1      AND InsuranceCarrierID = @InsuranceCarrierID      AND InsuranceHealthPlanId IS NULL      AND ConfigType = 'OTCAPP'       SELECT @LoginTemplate = JSON_VALUE(@otcLoginConfig, '$.LoginTemplate')    END      -- SSO FLOWS     BEGIN     DECLARE @benefitSource NVARCHAR(40) = json_value(@otcLoginConfig, '$.benefitValueSource');     DECLARE @isManaged BIT = Cast(json_value(@otcLoginConfig, '$.isManaged') AS BIT)     DECLARE @otcCarrierId BIGINT = (       SELECT TOP 1 InsuranceCarrierID       FROM Insurance.InsuranceCarriers       WHERE IsActive = 1        AND JSON_VALUE(CarrierConfig, '$.subdomain') = 'otcnetwork'       )     DECLARE @otcPlanId BIGINT = (       SELECT TOP 1 InsuranceHealthPlanID       FROM Insurance.InsuranceHealthPlans       WHERE IsActive = 1        AND InsuranceCarrierID = @otcCarrierId        AND PlanConfigData IS NULL       )       ----if we know the NHMemberId then return memberprfile and carrier config     IF (@nhMemberId IS NOT NULL)     BEGIN      SELECT @MemberId = MemberId      FROM master.Members      WHERE NHMemberId = @nhMemberId        SELECT @otcLoginConfig AS otcLoginConfig       ,@otcAppConfig AS otcAppConfig       ,(        SELECT @insuranceNbr AS MemberId         ,m.NHMemberId         ,@cardNumber AS CardNumber         ,JSON_VALUE(@envelopJson, '$.SerialNumber') AS SerialNumber         ,(CASE WHEN pm.FirstName IS NULL THEN m.FirstName ELSE pm.FirstName END) AS FirstName         ,(CASE WHEN pm.LastName IS NULL THEN m.LastName ELSE pm.LastName END ) AS LastName         ,cast((CASE WHEN pm.DateOfBirt
CREATE PROCEDURE [otc].[LoginAuthentication]  (   -- Add the parameters for the stored procedure here    @domain VARCHAR(100) = ''   ,@loginData VARCHAR(2000) = ''   ,-- {'NHMemberId': 'NH202012345'}   @isSSO BIT --true for sso request and false for direct login request   )  AS    BEGIN   -- SET NOCOUNT ON added to prevent extra result sets FROM   -- interfering with SELECT statements.   SET NOCOUNT ON     -- Insert statements for procedure here   -- Global Error variables declaratiON    DECLARE @msg51400 BIGINT = 51400   DECLARE @msg51400Text VARCHAR(1000) = 'Invalid Input'   DECLARE @msg51401 BIGINT = 51401   DECLARE @msg51401Text VARCHAR(1000) = 'Un-authorized '   DECLARE @msg51503 BIGINT = 51503   DECLARE @msg51503Text VARCHAR(1000) = 'Sorry, we are unble to serve you. Please contact 1-833-746-7682 for further assistance'   DECLARE @msg51500 BIGINT = 51500 --errorStatus code for any exception occure while excuting   DECLARE @errorMsg NVARCHAR(1000)   DECLARE @errorSeverity INT     -- Global Variables    DECLARE @InsuranceCarrierID BIGINT   DECLARE @InsuranceHealthPlanID BIGINT   DECLARE @Status VARCHAR(100)   DECLARE @StatusNotEnabled VARCHAR(100) = 'NotEnabled'   DECLARE @StatusLoginEnabled VARCHAR(100) = 'LoginEnabled'   DECLARE @StatusRedirect VARCHAR(100) = 'Redirect'   DECLARE @StatusMessage VARCHAR(1000)   DECLARE @LoginEnvelop VARCHAR(2000)   DECLARE @CarrierConfig VARCHAR(2000)   DECLARE @otcContentConfig VARCHAR(2000)   DECLARE @otcLoginConfig VARCHAR(2000)   DECLARE @otcAppConfig VARCHAR(2000)   DECLARE @fieldValidationConfig VARCHAR(2000)   DECLARE @fieldname VARCHAR(1000)   DECLARE @LoginTemplate VARCHAR(500)   DECLARE @MemberProfileId BIGINT   DECLARE @NHmemberId VARCHAR(100)   DECLARE @cardNumber NVARCHAR(30)   DECLARE @serialNumber NVARCHAR(50)   DECLARE @benefitSource VARCHAR(20)   DECLARE @isManaged BIT       -- LoginTempaltes   DECLARE @LoginTemplate_OTCInComm2FA VARCHAR(100) = 'OTCInComm2FA'   --DECLARE @LoginTemplate_OTCInCommSSO   VARCHAR(100) = 'OTCInCommSSO'   DECLARE @LoginTemplate_OTCNationsStandard VARCHAR(100) = 'OTCNationsStandard'   DECLARE @LoginTemplate_OTCNations2FA VARCHAR(100) = 'OTCNations2FA'   --DECLARE @LoginTemplate_OTCNationsSSO  VARCHAR(100) = 'OTCNationsSSO'   DECLARE @LoginTemplate_OTCInCommStandard VARCHAR(100) = 'OTCInCommStandard'      DECLARE @otcCarrierId BIGINT = (       SELECT TOP 1 InsuranceCarrierID       FROM Insurance.InsuranceCarriers       WHERE IsActive = 1        AND JSON_VALUE(CarrierConfig, '$.subdomain') = 'otcnetwork'       )     DECLARE @otcPlanId BIGINT = (       SELECT TOP 1 InsuranceHealthPlanID       FROM Insurance.InsuranceHealthPlans       WHERE IsActive = 1        AND InsuranceCarrierID = @otcCarrierId        AND PlanConfigData IS NULL       )     SET @StatusMessage = NULL;     -- Extract LogingTemplateConfig by using domain    BEGIN TRY    --Start - Validate input format     SELECT TOP 1 @InsuranceCarrierID = InsuranceCarrierID     FROM Insurance.InsuranceCarriers     WHERE IsActive = 1      AND JSON_VALUE(CarrierConfig, '$.subdomain') = @domain     ORDER BY InsuranceCarrierId       --validate subdomain whether it is belong to any insurance carrier or not     IF (@InsuranceCarrierId IS NULL)     BEGIN      PRINT 'Sub domain not belongs to any insurance carriers.';        THROW @msg51400       ,'Invalid sub-domain'       ,1;     END       ---validate logindata     IF (@loginData IS NULL OR ISJSON(@loginData) <= 0)     BEGIN      PRINT 'login information not provided.';        THROW @msg51400       ,'login information not provided.'       ,1;     END       SELECT @CarrierConfig = CarrierConfig     FROM Insurance.InsuranceCarriers     WHERE IsActive = 1      AND InsuranceCarrierID = @InsuranceCarrierID       SELECT @otcLoginConfig = ConfigData     FROM Insurance.InsuranceConfig     WHERE IsActive = 1      AND InsuranceCarrierID = @InsuranceCarrierID      AND InsuranceHealthPlanId IS NULL      AND ConfigType = 'OTCLOGIN'       SELECT @otcAppConfig = ConfigD
-- 2020-07-08 ran on stage  -- 2020-08-08 - Damian Montero - Ran on Production  /*   Getting All default brochers and requested brouchers      execute [otc].[GetBrochures] 14,0,'Medicare';   select * from otc.CatalogBrochures  */    create   PROCEDURE [otc].[GetBrochures]   (   @CarrierId bigint,   @PlanId bigint = 0,   @PurseNames VARCHAR(100)=NULL  )  AS  BEGIN     SELECT [CatalogBrochureId]        ,[CarrierId]        ,[HealthPlanId]        ,Purses.HealthPlanName AS PurseName        ,[Language]        ,[FileName]        ,Results.[CreateUser]        ,Results.[ModifyUser]        ,Results.[CreateDate]        ,Results.[ModifyDate]        ,Results.[IsActive]    FROM  (      SELECT * From [otc].[CatalogBrochures] br     where 1=1      and (case when (@PurseNames is not null and br.CarrierId in (@CarrierId,258) and br.HealthPlanId in (@PlanId,0) and br.IsActive=1) then 1 when (@PurseNames is null and  br.CarrierId = @CarrierId and br.HealthPlanId in (@PlanId,0) and br.IsActive=1) then 1 else 0 end)=1     and (@PurseNames is null or br.PurseName in (SELECT CAST(RTRIM(LTRIM(value)) AS VARCHAR(100)) AS T FROM STRING_SPLIT(@PurseNames,',')))     ) Results     LEFT JOIN Insurance.InsuranceHealthPlans Purses ON JSON_VALUE(PlanConfigData, '$.purseName') = Results.PurseName AND Purses.InsuranceCarrierId=258  END    
CREATE PROCEDURE [otc].[GetOrderItemsbyNHMemberId_BK_31MAR2020]  @NHMemberId VARCHAR(20),  @orderId BIGINT=0  AS  IF(@orderId=0)  SELECT oi.*,   imc.[DefaultImage] AS DefaultImage,  CASE WHEN ic.InsuranceCarrierName = 'Ultimate Health Plan' AND ISJSON(imc.ContentData) = 1 THEN ISNULL(JSON_VALUE(imc.ContentData, '$.ultimateLongAlias'), imc.[ModelLongDescription]) ELSE imc.[ModelLongDescription] END AS Title  FROM Orders.orderitems oi JOIN  [Orders].[Orders] o ON oi.OrderId = o.orderid JOIN  CMS.ItemMasterContent imc ON oi.itemcode = imc.itemcode   INNER JOIN master.members m ON o.nhmemberid = m.nhmemberid  INNER JOIN master.memberinsurances mi ON mi.memberid = m.memberid  and oi.CreateDate BETWEEN mi.InsuranceEffectiveDate and mi.InsuranceEndDate  INNER JOIN insurance.insurancecarriers ic ON ic.insurancecarrierid = mi.insurancecarrierid  WHERE o.nhmemberid=@NHMemberId AND oi.[IsActive]=1 AND oi.ItemType = 'OTC' AND imc.IsActive = 1  ELSE  SELECT oi.*,  imc.[DefaultImage] AS DefaultImage,  CASE WHEN ic.InsuranceCarrierName = 'Ultimate Health Plan' AND ISJSON(imc.ContentData) = 1 THEN ISNULL(JSON_VALUE(imc.ContentData, '$.ultimateLongAlias'), imc.[ModelLongDescription]) ELSE imc.[ModelLongDescription] END AS Title    FROM Orders.orderitems oi JOIN  [Orders].[Orders] o ON oi.OrderId = o.orderid JOIN  CMS.ItemMasterContent imc ON oi.itemcode = imc.itemcode  INNER JOIN master.members m ON o.nhmemberid = m.nhmemberid  INNER JOIN master.memberinsurances mi ON mi.memberid = m.memberid and oi.CreateDate BETWEEN mi.InsuranceEffectiveDate and mi.InsuranceEndDate  INNER JOIN insurance.insurancecarriers ic ON ic.insurancecarrierid = mi.insurancecarrierid  WHERE o.nhmemberid=@NHMemberId AND oi.orderid=@orderId AND oi.[IsActive]=1 AND oi.ItemType = 'OTC' AND imc.IsActive = 1
--exec [otc].[sp_move_rawfileToQBCOGSDetails] 'AugMTDCOGS.TXT'  CREATE PROCEDURE [otc].[sp_move_rawfileToQBCOGSDetails]   @FileName varchar(50)  AS  BEGIN     update a set a.rawvcflex1 = replace(rawvcflex1,'"','')      ,a.rawvcflex2 = replace(rawvcflex2,'"','')      ,a.rawvcflex3 = replace(rawvcflex3,'"','')      ,a.rawvcflex4 = replace(rawvcflex4,'"','')      ,a.rawvcflex5 = replace(rawvcflex5,'"','')      ,a.rawvcflex6 = replace(replace(rawvcflex6,'"',''),'^',',')      ,a.rawvcflex7 = replace(rawvcflex7,'"','')      ,a.rawvcflex8 = replace(rawvcflex8,'"','')      ,a.rawvcflex9 = replace(rawvcflex9,'"','')      ,a.rawvcflex10 = replace(rawvcflex10,'"','')      ,a.rawvcflex11 = replace(rawvcflex11,'"','')      ,a.rawvcflex12 = replace(rawvcflex12,'"','')      ,a.rawvcflex13 = replace(rawvcflex13,'"','')      ,a.rawvcflex14 = replace(replace(rawvcflex14,'"',''),'^',',')      ,a.rawvcflex15 = replace(replace(rawvcflex15,'"',''),'^',',')      ,a.rawvcflex16 = replace(rawvcflex16,'"','')      ,a.rawvcflex17 = replace(rawvcflex17,'"','')      ,a.rawvcflex18 = replace(rawvcflex18,'"','')        --,a.rawvcflex5 = replace(rawvcflex5,'^',',')      --,a.rawvcflex13 = replace(rawvcflex13,'^',',')      --,a.rawvcflex14 = replace(rawvcflex14,'^',',')   from temp.rawSTGFileLoadData a   where FileName = @FileName     delete a    --select *   from [otc].[QBCOGSDetailsByOrder] a   join temp.rawSTGFileLoadData b on a.OrderNumDesc = b.rawvcflex4 and a.Product_Name = b.rawVCFlex6   where 1=1   and b.FileName = @FileName     insert into [otc].[QBCOGSDetailsByOrder] (Invtype,              OrderDate,              OrderNumber,              OrderNumDesc,              CarrierName,              Product_Name,              Nations_ID,              Qty,              --[QtyORG],              BuyCost,              filename,              MemberName,Address1, City,State, Zip              )   select  rawvcflex2 as [type],     cast(rawvcflex3 as date) as OrderDate,     case when isnumeric(rawvcflex4) = 1 then cast(rawvcflex4 as bigint)        when isnumeric(substring(rawvcflex4,3,len(rawvcflex4))) = 1 then cast(substring(rawvcflex4,3,len(rawvcflex4)) as bigint) else 0 end as ordernumber,     --case when isnumeric(rawvcflex3) = 1 then cast(rawvcflex3 as bigint) else 0 end as ordernumber,     rawvcflex4 as orderNumDesc,     rawvcflex5 as CarrierName,     rawvcflex6 as ProductName,     rawvcflex7 as Nations_id,     sum(case when isnumeric(rawvcflex10) = 1 then cast(rawvcflex10 as int) else 0 end) as Qty,     --rawvcflex9 as QtyORG,     sum(cast(rawvcflex11 as float)) as BuyCost,     FileName,     rawvcflex14 as MemberName,     rawvcflex15 as address1,     rawvcflex16 as City,     rawvcflex17 as State,     rawvcflex18 as Zip   from temp.rawSTGFileLoadData    where 1=1   and filename =  @FileName   and rawvcflex2 ='Invoice'   and recordSno not in (select min(recordSno) FROM temp.rawSTGFileLoadData where filename = @FileName)   group by rawvcflex2,cast(rawvcflex3 as date),   case when isnumeric(rawvcflex4) = 1 then cast(rawvcflex4 as bigint)         when isnumeric(substring(rawvcflex4,3,len(rawvcflex4))) = 1 then cast(substring(rawvcflex4,3,len(rawvcflex4)) as bigint) else 0 end ,   rawvcflex4, rawvcflex5 ,rawvcflex6 ,rawvcflex7 ,FileName,rawvcflex14,rawvcflex15,rawvcflex16,rawvcflex17,rawvcflex18    --exec [otc].[sp_move_rawfileToQBCOGSDetails] 'AugMTDCOGS.TXT'  --drop table #temp    --update tracking number  select distinct a.OrderDate,a.OrderNumber,a.OrderNumDesc,  a.MemberName,a.Address1, a.City, a.Zip,a.ShippingVendor,a.state,a.TrackingNumber,a.NHMemberId ,a.OrgOrderId,shipdate,IsCRMUpdateFlag  into #tempQB  from [otc].[QBCOGSDetailsByOrder] a  where a.CarrierName='Reship'  and a.IsCRMUpdateFlag is null  and cast(a.OrderDate as date) >= cast('09/01/2020' as date)    select distinct a.*,'****' as datadivider,b.TrackingNumber f_TrackingNumber,b.ShipDate as f_shipdate  into #tempfinal  from #tempQB a  join FedExShippingDetails b on a.OrderNumDesc = b.OrderId  where 
/*   Mohan deployed to Stage on 8 May 2020   Mohan deployed to Production on 9 May 2020    */    CREATE procedure [otc].[GetStoreFrontProducts_BM_BK12MAY2020] @planId INT, @contractType VARCHAR(50)    as    begin                      DECLARE @hpId varchar(max);        if(@contractType is not null and @contractType <> '')        begin         set @hpId =(select string_agg(HealthPlanContractId,',') from Insurance.HealthPlanContracts         where isactive=1 and InsuranceHealthPlanId in         (SELECT InsuranceHealthPlanId FROM [Insurance].[InsuranceHealthPlans] WHERE Json_value(planconfigdata,'$.purseName') in (      SELECT LTRIM(RTRIM(value)) AS Item FROM STRING_SPLIT(@contractType,',') WHERE LEN(Value) > 0)))        end        else        begin        set @hpId=cast((select HealthPlanContractId from Insurance.HealthPlanContracts         where isactive=1 and InsuranceHealthPlanId = @planId) as varchar)        end     IF OBJECT_ID('tempdb..#TempProducts') IS NOT NULL        begin                drop table #TempProducts        end        create table #TempProducts(      ItemCode varchar(50) not null,      PerDeviceMemberPrice decimal,      RestockDate DateTime null,      StockStatus varchar(30) null,      CatalogName varchar(100) null,      CatalogColorCode varchar(30) null ,    HealthPlanName varchar(200) null    );        execute('        insert INTO #TempProducts(ItemCode,PerDeviceMemberPrice,RestockDate,StockStatus,CatalogName,CatalogColorCode,HealthPlanName)        SELECT cp.ItemCode, cp.PerDeviceMemberPrice        ,cp.RestockDate as RestockDate        ,ISNULL(StockStatus, ''Stock'') as StockStatus,        Json_value(planconfigdata,''$.purseName'') as CatalogName,        Json_value(planconfigdata,''$.catalogColorCode'') as CatalogColorCode,ihp.HealthPlanName FROM Insurance.ContractProducts cp        join Insurance.HealthPlanContracts hpc on hpc.HealthPlanContractId=cp.HealthPlanContractId        join [Insurance].[InsuranceHealthPlans] ihp on ihp.InsuranceHealthPlanId=hpc.InsuranceHealthPlanId           WHERE cp.HealthPlanContractId in ('+@hpId+') AND cp.IsActive = 1');      --WHERE cp.HealthPlanContractId in (SELECT LTRIM(RTRIM(value)) AS Item FROM STRING_SPLIT(@hpId,',') WHERE LEN(Value) > 0) AND cp.IsActive = 1;                   SELECT row_number() OVER (ORDER BY [ItemCode] ASC) RowID, * FROM (                  SELECT                  --row_number() OVER (ORDER BY it.[ItemCode] ASC) RowID                  --,                  modelcontent.[ModelShortDescription] AS Title                  ,modelcontent.[ModelLongDescription] AS Description                  ,modelcontent.[DefaultImage] AS MediaURL                  ,json_value(modelcontent.[ContentData], '$.brand') AS BrandCode                  ,json_value(modelcontent.[ContentData], '$.brand') AS BrandName                  ,it.[ItemCode] AS ItemCode                  ,modelcontent.ModelRatings AS ModelRatings                  ,CAST(0 AS numeric(10,2)) AS Quantity                  ,NULL AS QuantityUnits                  ,CAST(ISNULL(tem.[PerDeviceMemberPrice], 0) AS numeric(10,2)) Price         ,tem.StockStatus         ,tem.RestockDate                  ,'$' AS Currency                  ,CAST(1 AS numeric(10,2)) AS PricePerQuantity                  ,CAST(1 AS DECIMAL(10,2)) AS CartQty                  ,attr.[ModelAttributeValue] AS NationsId         ,tem.CatalogName         ,tem.CatalogColorCode      ,tem.HealthPlanName                FROM #TempProducts tem                  INNER JOIN [catalog].[ItemMasterList] it ON it.ItemCode = tem.ItemCode                  LEFT JOIN [catalog].[ItemMasterAttributeValues] attr ON attr.[Itemcode]=it.[Itemcode] AND attr.[IsActive]=1 AND attr.[AttributeCode]='NATIONS_ID'                  LEFT JOIN CMS.ItemMasterContent modelcontent ON it.[ItemCode] = modelcontent.[ItemCode]                  WHERE 1=1                  AND it.[ItemType]='OTC'                  AND it.isactive=1           ) tb    end             --exec [otc].[GetStoreFrontProducts
/*   Mohan deployed to Stage on 8 May 2020   Mohan deployed to Production on 9 May 2020    */    CREATE PROCEDURE [otc].[GetOrderItemsbyNHMemberId]    @NHMemberId VARCHAR(20),    @orderId BIGINT=0    AS    IF(@orderId=0)    SELECT oi.*,    imc.[DefaultImage] AS DefaultImage    ,imc.[ModelShortDescription] AS Title    ,(select JSON_VALUE(PlanConfigData, '$.purseName') from  [Insurance].[InsuranceHealthPlans] where InsuranceHealthPlanID = JSON_VALUE(oi.ItemData, '$.catalogInsuranceHealthPlanId')) as CatalogName    ,(select JSON_VALUE(PlanConfigData, '$.catalogColorCode') from  [Insurance].[InsuranceHealthPlans] where InsuranceHealthPlanID = JSON_VALUE(oi.ItemData, '$.catalogInsuranceHealthPlanId')) as CatalogColorCode    ,(select HealthPlanName from  [Insurance].[InsuranceHealthPlans] where InsuranceHealthPlanID = JSON_VALUE(oi.ItemData, '$.catalogInsuranceHealthPlanId')) as HealthPlanName   FROM Orders.orderitems oi JOIN    [Orders].[Orders] o ON oi.OrderId = o.orderid JOIN    CMS.ItemMasterContent imc ON oi.itemcode = imc.itemcode WHERE o.nhmemberid=@NHMemberId AND oi.[IsActive]=1 AND oi.ItemType = 'OTC'    ELSE    SELECT oi.*,    imc.[DefaultImage] AS DefaultImage,    imc.[ModelShortDescription] AS Title    ,(select HealthPlanName from  [Insurance].[InsuranceHealthPlans] where InsuranceHealthPlanID = JSON_VALUE(oi.ItemData, '$.catalogInsuranceHealthPlanId')) as CatalogName    ,(select JSON_VALUE(PlanConfigData, '$.catalogColorCode') from  [Insurance].[InsuranceHealthPlans] where InsuranceHealthPlanID = JSON_VALUE(oi.ItemData, '$.catalogInsuranceHealthPlanId')) as CatalogColorCode   ,(select HealthPlanName from  [Insurance].[InsuranceHealthPlans] where InsuranceHealthPlanID = JSON_VALUE(oi.ItemData, '$.catalogInsuranceHealthPlanId')) as HealthPlanName  FROM Orders.orderitems oi JOIN    [Orders].[Orders] o ON oi.OrderId = o.orderid JOIN    CMS.ItemMasterContent imc ON oi.itemcode = imc.itemcode    WHERE o.nhmemberid=@NHMemberId AND oi.orderid=@orderId AND oi.[IsActive]=1 AND oi.ItemType = 'OTC'  
/*  Remarks: Fix rounding issue  Mohan Deployed to Stage on 5/13/2020  Mohan Deployed this flag to Stage on 14 May 2020  */    -- exec [otc].[GetStoreFrontProducts_BM] 34,null    CREATE procedure [otc].[GetStoreFrontProducts_BM] @planId INT, @contractType VARCHAR(50)    as    begin                      DECLARE @hpId varchar(max);        if(@contractType is not null and @contractType <> '')        begin         set @hpId =(select string_agg(HealthPlanContractId,',') from Insurance.HealthPlanContracts         where isactive=1 and InsuranceHealthPlanId in         (SELECT InsuranceHealthPlanId FROM [Insurance].[InsuranceHealthPlans] WHERE Json_value(planconfigdata,'$.purseName') in (      SELECT LTRIM(RTRIM(value)) AS Item FROM STRING_SPLIT(@contractType,',') WHERE LEN(Value) > 0)))        end        else        begin        set @hpId=cast((select HealthPlanContractId from Insurance.HealthPlanContracts         where isactive=1 and InsuranceHealthPlanId = @planId) as varchar)        end     IF OBJECT_ID('tempdb..#TempProducts') IS NOT NULL        begin                drop table #TempProducts        end        create table #TempProducts(      ItemCode varchar(50) not null,      PerDeviceMemberPrice decimal(10,2),      RestockDate DateTime null,      StockStatus varchar(30) null,      CatalogName varchar(100) null,      CatalogColorCode varchar(30) null ,    HealthPlanName varchar(200) null    );    ----------Commented by @DPSR  /*      execute('        insert INTO #TempProducts(ItemCode,PerDeviceMemberPrice,RestockDate,StockStatus,CatalogName,CatalogColorCode,HealthPlanName)        SELECT cp.ItemCode, cp.PerDeviceMemberPrice        ,cp.RestockDate as RestockDate        ,ISNULL(StockStatus, ''Stock'') as StockStatus,        Json_value(planconfigdata,''$.purseName'') as CatalogName,        Json_value(planconfigdata,''$.catalogColorCode'') as CatalogColorCode,ihp.HealthPlanName FROM Insurance.ContractProducts cp        join Insurance.HealthPlanContracts hpc on hpc.HealthPlanContractId=cp.HealthPlanContractId        join [Insurance].[InsuranceHealthPlans] ihp on ihp.InsuranceHealthPlanId=hpc.InsuranceHealthPlanId           WHERE cp.HealthPlanContractId in ('+@hpId+') AND cp.IsActive = 1');      --WHERE cp.HealthPlanContractId in (SELECT LTRIM(RTRIM(value)) AS Item FROM STRING_SPLIT(@hpId,',') WHERE LEN(Value) > 0) AND cp.IsActive = 1;    */  ------------New Code added by @DPSR                declare @Xhpid varchar(20);                DECLARE cursor_name CURSOR For                SELECT LTRIM(RTRIM(value)) as Xhpid                FROM STRING_SPLIT(@hpId,',')                 WHERE LEN(Value) > 0;                  OPEN cursor_name;                FETCH NEXT FROM cursor_name INTO @Xhpid;                WHILE @@FETCH_STATUS = 0                  BEGIN                --select  @Xhpid                EXECUTE ('insert INTO #TempProducts(ItemCode,PerDeviceMemberPrice,RestockDate,StockStatus,CatalogName,CatalogColorCode,HealthPlanName)                  SELECT cp.ItemCode, cp.PerDeviceMemberPrice                  ,cp.RestockDate as RestockDate                  ,ISNULL(StockStatus, ''Stock'') as StockStatus,                  Json_value(planconfigdata,''$.purseName'') as CatalogName,                  Json_value(planconfigdata,''$.catalogColorCode'') as CatalogColorCode,ihp.HealthPlanName FROM Insurance.ContractProducts cp                  join Insurance.HealthPlanContracts hpc on hpc.HealthPlanContractId=cp.HealthPlanContractId                  join [Insurance].[InsuranceHealthPlans] ihp on ihp.InsuranceHealthPlanId=hpc.InsuranceHealthPlanId                   WHERE cp.HealthPlanContractId in ('+@Xhpid+') AND cp.IsActive = 1 AND cp.PerDeviceMemberPrice IS NOT NULL and cp.PerDeviceMemberPrice <> 0');          FETCH NEXT FROM cursor_name INTO @Xhpid;                  END;                CLOSE cursor_name;                DEALLOCATE cursor_name;  -----------------------END @DPSR---------------------------------------------------              SELECT row_num
CREATE procedure [otc].[GetProductDetails]   @insuranceCarrierID int = 0 ,   @healthPlanID int = 0,   @itemCode varchar(100) = ''   AS   BEGIN   SELECT DISTINCT      cast(row_number() over (order by conProd.ItemCode asc) as varchar) AS ProductModelCode,      vm.BrandCode AS BrandCode,      vm.FamilyCode AS BrandFamilyCode,      NULL AS EarmoldTypeCode,      vm.TechnologyCode AS FamilyProductCode,      NULL AS ProductTypeCode,      vm.StyleCode as ShellCode,      vm.TechnologyCode AS TechnologyLevelCode,      mContent.ModelOverview AS ModelOverview,      mContent.ModelLongDescription AS ModelLongDescription,      ISNULL(conProd.[PerDeviceMemberPrice],0) AS UnitProductPrice,      ISNULL([PerPairMemberPrice],0) AS PairProductPrice,      ISNULL(contBen.BenefitAmt,0) AS Benefit,      mContent.ModelShortDescription AS [Description],      mContent.DefaultImage AS MediaURL,      mContent.FamilyLogoImage AS FamilyLogoImage,      mContent.FamilyBannerImage AS FamilyBannerImage,      vm.StyleCode AS StyleName,      0 AS StyleID,      vm.StyleCode AS StyleCode,      vm.ItemCode AS ItemCode        FROM [catalog].[ItemMasterList] vm           LEFT JOIN Insurance.ContractProducts_BM_BAK conProd ON conProd.ItemCode =  vm.ItemCode                 --LEFT JOIN insurance.ContractProducts conProd ON conProd.FamilyProductCode = CASE      -- WHEN vm.BrandCode not in ('BELTONE', 'GNR','PHONAK')      --  THEN TRIM(CONCAT(LEFT(vm.BrandCode, 2), ' ', vm.FamilyCode, ' ', CASE WHEN vm.TechnologyCode = 'NA' THEN '' ELSE vm.TechnologyCode END))      --  ELSE vm.TechnologyCode      -- END          LEFT JOIN CMS.ItemMasterContent mContent ON vm.ItemCode = mContent.ItemCode      LEFT JOIN insurance.ContractBenefits contBen ON contBen.HealthPlanContractID = conProd.HealthPlanContractID      LEFT JOIN insurance.HealthPlanContracts healthPC ON healthPC.HealthPlanContractID = contBen.HealthPlanContractID      LEFT JOIN insurance.InsuranceHealthPlans insHP ON healthPC.[InsuranceHealthPlanID] = insHP.[InsuranceHealthPlanID]      WHERE  vm.ItemCode =  @itemCode and vm.IsActive=1  END  
 /*   Mohan deployed to Stage on 8 May 2020   Mohan deployed to Production on 9 May 2020    */     CREATE procedure [otc].[GetProductDetails_BM]      @catalogType varchar(100),  @planId int = 0,  @itemCode varchar(100) = ''       AS  BEGIN   DECLARE @hpId INT;         SET @hpId = (SELECT HealthPlanContractId FROM Insurance.HealthPlanContracts        WHERE  InsuranceHealthPlanId = CASE WHEN @catalogType is not null       THEN (SELECT InsuranceHealthPlanId FROM [Insurance].[InsuranceHealthPlans]       WHERE Json_value(planconfigdata,'$.purseName') = @catalogType) ELSE @planId END);              SELECT cp.ItemCode, cp.PerDeviceMemberPrice, cp.PerPairMemberPrice, cb.BenefitAmt,       cp.StockStatus, Json_value(planconfigdata,'$.purseName') as CatalogName,       Json_value(planconfigdata,'$.catalogColorCode') as CatalogColorCode,ihp.HealthPlanName,     cp.RestockDate INTO #temp  FROM Insurance.ContractProducts cp        LEFT JOIN insurance.ContractBenefits cb ON cb.HealthPlanContractId = cp.HealthPlanContractId         join Insurance.HealthPlanContracts hpc on hpc.HealthPlanContractId=cp.HealthPlanContractId          join  [Insurance].[InsuranceHealthPlans] ihp on ihp.InsuranceHealthPlanId=hpc.InsuranceHealthPlanId            WHERE cp.HealthPlanContractId = @hpId and cp.IsActive = 1;          SELECT row_number() OVER (ORDER BY [ItemCode] ASC) RowID,  * FROM ( SELECT DISTINCT  vm.BrandCode AS BrandCode,      vm.FamilyCode AS BrandFamilyCode, NULL AS EarmoldTypeCode, vm.TechnologyCode AS FamilyProductCode,     NULL AS ProductTypeCode,Coalesce(vm.ModelCode,'') ProductModelCode, vm.StyleCode as ShellCode,          vm.TechnologyCode AS TechnologyLevelCode, NULL as TechnologyLevel,           mContent.ModelOverview AS ModelOverview,mContent.ModelLongDescription AS ModelLongDescription,        ISNULL(tmp.[PerDeviceMemberPrice],0) AS UnitProductPrice,       ISNULL(tmp.[PerPairMemberPrice],0) AS PairProductPrice,       ISNULL(tmp.BenefitAmt,0) AS Benefit,tmp.StockStatus,tmp.RestockDate,      mContent.ModelShortDescription AS [Description],           mContent.DefaultImage AS MediaURL,mContent.FamilyLogoImage AS FamilyLogoImage,          mContent.FamilyBannerImage AS FamilyBannerImage,vm.StyleCode AS StyleName,0 AS StyleID,         vm.StyleCode AS StyleCode,vm.ItemCode AS ItemCode,attr.[ModelAttributeValue] AS NationsId,tmp.CatalogName,tmp.CatalogColorCode,tmp.HealthPlanName     FROM  #temp tmp     INNER JOIN [catalog].[ItemMasterList] vm ON vm.ItemCode = tmp.ItemCode            LEFT JOIN [catalog].[ItemMasterAttributeValues] attr ON attr.[Itemcode]=vm.[Itemcode] AND       attr.[IsActive]=1 AND attr.[AttributeCode]='NATIONS_ID'           LEFT JOIN CMS.ItemMasterContent mContent ON vm.[ItemCode] = mContent.[ItemCode]          WHERE 1=1 and tmp.ItemCode = @itemCode    AND vm.IsActive = 1  ) tb      END
CREATE procedure [otc].[GetStoreFrontProducts]  as  begin   select * from [otc].[ViewGetMasterList]  end         
CREATE procedure [otc].[InsertOTCProduct](    @userName varchar(200)      ,@umiNo varchar(20)   ,@upc11 varchar(100)   ,@group varchar(100)   ,@categoryID int   ,@upc12 varchar(100)=null   ,@gtin varchar(200)=null   ,@descr12 varchar(2000)   ,@descr29 varchar(4000)     ,@quantity decimal   --,@measurement varchar(5)     ,@basePrice decimal   ,@totalPrice decimal     --,@brand varchar(100)=null   ,@mfg varchar(100)=null   ,@isPvtLabel bit   --,@isPLU bit      ,@catalogs varchar(500)   ,@img varchar(300)=null      ,@category varchar(100)=null   ,@sub_category varchar(100)=null   ,@sub_cat_code varchar(10)=null   ,@fin_category varchar(100)=null   ,@fin_cat_code varchar(10)=null   ,@isActive bit  )  as  begin    declare @hpcId bigint=(select top 1 [HealthPlanContractID] from [Insurance].[HealthPlanContracts]    where [ContractName]='Nations OTC Contract')      --[catalog].[ItemMasterList] #Master table        insert into [catalog].[ItemMasterList]    ([ItemCode],[ItemType],[BrandCode],[FamilyCode],[TechnologyCode],[ModelCode],[StyleCode],[IsActive],[CreateDate],[CreateUser],[ModifyDate],[ModifyUser],[MonauralHCPCSCode],[BinauralHCPCSCode]) values    (@upc11,'OTC','OTC',null,null,null,null,@isActive,getdate(),@userName,getdate(),@userName,null,null);        --[otc].[ProductCatalogs] #List of Catalogs    --Insert into Catalogs if there is new Catalog in Excel?    --If InActive, make active    if(@isActive=1)     begin      update ct      set ct.[IsActive]=1      from [otc].[Catalogs] ct      where ct.[CatalogName] in (select trim(value) from string_split(@catalogs, ';'))     end      insert into [otc].[Catalogs]    select trim(value),@userName,@userName,getdate(),getdate(),@isActive from string_split(@catalogs, ';')    where trim(value) not in (     select CatalogName from [otc].[Catalogs]    );      --If InActive, make active    if(@isActive=1)     begin      update pc      set pc.[IsActive]=1      from [otc].[ProductCatalogs] pc      where pc.[ItemCode]=@upc11      and pc.[CatalogId] in      (select [CatalogId] from [otc].[Catalogs] where [CatalogName] in      (select trim(value) as value from string_split(@catalogs, ';')))     end       update pc    set pc.[IsActive]=0    from [otc].[ProductCatalogs] pc    where pc.[ItemCode]=@upc11    and pc.[CatalogId] not in    (select [CatalogId] from [otc].[Catalogs] where [CatalogName] in    (select trim(value) as value from string_split(@catalogs, ';')))      insert into [otc].[ProductCatalogs]    ([ItemCode],[CatalogId],[CreateDate],[CreateUser],[ModifyDate],[ModifyUser],[IsActive])    select @upc11,ct.[CatalogId],getdate(),@userName,getdate(),@userName,@isActive    from (select trim(value) as value from string_split(@catalogs, ';')) c    inner join [otc].[Catalogs] ct on ct.[CatalogName]=c.value    where [CatalogId] not in    (select distinct [CatalogId] from [otc].[ProductCatalogs] where [ItemCode] = @upc11);        --[cms].[ItemmasterContent] #Product Info    declare @contentData varchar(4000)='{}';    set @contentData = json_modify(@contentData, '$.upc11', @upc11);    set @contentData = json_modify(@contentData, '$.upc12', @upc12);    set @contentData = json_modify(@contentData, '$.gtin', @gtin);    set @contentData = json_modify(@contentData, '$.group', @group);    set @contentData = json_modify(@contentData, '$.categoryID', @categoryID);    set @contentData = json_modify(@contentData, '$.mfg', @mfg);    set @contentData = json_modify(@contentData, '$.isPvtLabel', @isPvtLabel);        set @contentData = json_modify(@contentData, '$.umiNo', @umiNo);    set @contentData = json_modify(@contentData, '$.quantity', @quantity);        insert into [cms].[ItemmasterContent]    ([ItemCode],[BrandFamilyCode],[DefaultImage],[FamilyBannerImage],[FamilyLogoImage],[FamilyProductCode],[IsActive],[ModelCode],[ModelLongDescription],[ModelMobileAppsDescription],[ModelName],[ModelOverview],[ModelRatings],[ModelShortDescription],[ModelTitle],[CreateDate],[CreateUser],[ModifyDate],[ModifyUser],[ContentDa
CREATE procedure [otc].[GetProductCategories] @planId int = 0  as  begin   select distinct    av.[ModelAttributeValueID]   ,av.[Itemcode] as ItemCode   ,av.[IsActive]   ,av.[ModelAttributeValue] as CategoryCode   ,av.[ModelAttributeValue] as CategoryName   from [catalog].[ItemMasterAttributeValues] av   inner join [catalog].[ItemMasterList] it   on it.[ItemCode] = av.[ItemCode]   LEFT JOIN insurance.insurancehealthplans ihp ON ihp.InsuranceHealthPlanId = @planId   LEFT JOIN insurance.insuranceCarriers ic ON ic.InsuranceCarrierId = ihp.InsuranceCarrierId   where av.[AttributeCode]= CASE     WHEN ic.InsuranceCarrierName = 'Ultimate Health Plan' THEN 'ULTIMATE_CATEGORY'     WHEN ic.InsuranceCarrierName = 'Commonwealth Care Alliance, Inc.' THEN 'CCA_CATEGORY'    ELSE 'OTC_CATEGORY' END and it.[ItemType]='OTC'   and av.[IsActive]=1 and it.[IsActive]=1  end  
CREATE procedure [otc].[GetProductCatalogs]  as  begin   select    pc.[ProductCatalogId]   ,pc.[ItemCode]   ,c.[CatalogId] as CatalogId   ,c.[CatalogName] as  CatalogCode   ,c.[CatalogName] as CatalogName   ,pc.[IsActive]   from [otc].[Catalogs] c   inner join  [otc].[ProductCatalogs] pc   on pc.[CatalogId]=c.[CatalogId]   inner join [catalog].[ItemMasterList] it   on it.[ItemCode] = pc.[ItemCode]   where pc.[IsActive]=1 and c.[IsActive]=1 and it.[IsActive]=1 and it.[ItemType]='OTC'  end  
CREATE proc [otc].[GetOrdersbyNHMemberId]   @NHMemberId varchar(20)  as  begin   select o.* from [Orders].[Orders] o join   [provider].[MemberChartData] mcd on  o.[MemberChartDataId] = mcd.[MemberChartDataId]   join [provider].[MemberCharts] mc on mcd.[MemberChartId] = mc.[MemberChartId]   where o.nhmemberid=@NHMemberId AND o.OrderType LIKE  '%OTC%' order by o.orderid desc  end
/*  Mohan Deployed to Stage on 5/13/2020  Mohan Deployed this flag to Stage on 14 May 2020  Mohan Deployed  to PROD on 14 May 2020  */  CREATE procedure [otc].[GetDownloadCatalogData] @planId INT, @contractType VARCHAR(50)  as  begin       --declare @planId INT = 2044;      --declare @contractType VARCHAR(50) = null-- 'Medicare,Medicaid'         DECLARE @hpId varchar(max);      if(@contractType is not null and @contractType <> '' and @contractType <> 'null')      begin        set @hpId =(SELECT string_agg(InsuranceHealthPlanId,',') FROM [Insurance].[InsuranceHealthPlans] WHERE Json_value(planconfigdata,'$.purseName') in (     SELECT RTRIM(LTRIM(value)) AS Item FROM STRING_SPLIT(@contractType,',') WHERE LEN(Value) > 0))       end       else       begin       set @hpId=@planId       --select @hpId      end   select     ihp.InsuranceHealthPlanID as InsuranceHealthPlanId    ,(case when Json_value(planconfigdata,'$.purseName') is not null then ihp.HealthPlanName else null end) as HealthPlanName    ,Json_value(planconfigdata,'$.purseName') as CatalogName    ,ISNULL(JSON_QUERY(ihp.PlanConfigData, '$.catalogs'), JSON_QUERY(ihc.CarrierConfig, '$.catalogs')) as CatalogConfig   from Insurance.InsuranceCarriers ihc   inner join Insurance.InsuranceHealthPlans ihp on ihc.InsuranceCarrierID = ihp.InsuranceCarrierID   where ihp.InsuranceHealthPlanID in (SELECT CAST(RTRIM(LTRIM(value)) AS BIGINT) AS T FROM STRING_SPLIT(@hpId,','))  end 
          --  -- =============================================                                  -- Author:      Veeran Darla                                  -- Create Date: 12/11/2020                                  -- Update Date: 12/1/2020  -- Description: This Procedure used to get Prodcut Complete Details  -- =============================================                    -- 12/01/2020  Bhanu Bomma Added price column modified to display price.  --                            -- Exec [otc].[ProductModelDetailsByNationsId] 5826,2653              CREATE PROCEDURE [otc].[ProductModelDetailsByNationsId] @NationsId VARCHAR(50)   ,@InsuranceCarrierId BIGINT   ,@InsuranceHealthPlanId BIGINT   ,@CatalogName NVARCHAR(200) = NULL  AS  BEGIN   SELECT CAST(av.[NationsId] AS NVARCHAR(50)) [NationsId]    ,av.[ItemCode]    ,av.[Title]    ,av.[Title] [Description]    ,av.[Description] AS [LongDescription]    ,CAST(av.DisplayPrice AS FLOAT) AS ItemPrice    ,av.[StockStatus]    ,CAST(av.[RestockDate] AS DATETIME) AS RestockDate    ,av.[Categories]    ,av.[CatalogName]    ,(     SELECT [Key]      ,[value]     FROM (      SELECT CASE         WHEN ATT.AttributeCode = 'PACK_TYPE'         THEN 'PACK QUANTITY UOM'        WHEN ATT.AttributeCode = 'ICD10CATEGORY'         THEN 'CATEGORY'        ELSE ATT.Attributename        END AS [Key]       ,ModelAttributeValue AS [value]      FROM CATALOG.itemmasterattributevalues ITA      LEFT JOIN [catalog].[ItemAttributes] ATT ON ITA.AttributeCode = ATT.AttributeCode      WHERE ItemCode = av.ItemCode       AND ITA.AttributeCode NOT IN (        'OTC_CATEGORY'        ,'NATIONS_ID'        ,'OTC_CATEGORY'        ,'OTC_SUB_CATEGORY'        ,'OTC_FIN_CATEGORY'        ,'ULTIMATE_CATEGORY'        ,'CCA_CATEGORY'        ,'UPC'        )      ) AA     FOR JSON AUTO     ) ItemAttributes   FROM otccatalog.WebCache av   WHERE CAST(av.[NationsId] AS NVARCHAR(50)) = CAST(@NationsId AS NVARCHAR(50))    AND av.InsuranceCarrierId = @InsuranceCarrierId    AND AV.InsuranceHealthPlanId = @InsuranceHealthPlanId    AND 1 = CASE      WHEN @CatalogName IS NULL      --AND av.catalogName IS NULL        THEN 1     WHEN @CatalogName IS NOT NULL      AND av.catalogName = @CatalogName      THEN 1     END  END  
      --  -- =============================================                                  -- Author:      Veeran Darla                                  -- Create Date: 12/11/2020                                  -- Description: This Procedure used to get itemcodeS  -- =============================================                                  --                            -- Exec [otc].[GetRelatedItemCodesByNationsId] 5826     CREATE PROC otc.GetRelatedItemCodesByNationsId @nationsId VARCHAR(50)  AS  BEGIN   DECLARE @itemcode VARCHAR(50);     SET @itemcode = (     SELECT itemcode     FROM otccatalog.itemmaster     WHERE nationsid = @nationsId      AND isactive = 1     );     SELECT DISTINCT item.itemcode   FROM [catalog].itemmasterattributevalues ima   JOIN [otccatalog].webcache item ON item.ItemCode = ima.ItemCode    AND item.IsActive = 1    AND item.StockStatus <> 'NoStock'   WHERE AttributeCode = 'OTC_CATEGORY'    AND ModelAttributeValue IN (     SELECT att.ModelAttributeValue     FROM [catalog].itemmasterattributevalues AS att     JOIN [otccatalog].[itemmaster] AS im ON im.Itemcode = att.Itemcode      AND im.nationsid = @nationsId      AND im.isactive = 1     WHERE att.AttributeCode = 'OTC_CATEGORY'     )    AND item.itemcode NOT IN (@itemcode)  END  
/*  Mohan deployed to Production on 12 May 2020  */  CREATE PROCEDURE [provider].[GetMemberInsuranceDetails]  (     @MemberProfileId bigint  )  AS  BEGIN       SET NOCOUNT ON   select ROW_NUMBER() OVER(ORDER BY M.memberprofileid ASC) AS RowId      ,cast(M.IsActiveINS as bit) IsActiveINS      ,M.MemberProfileId      ,M.InsuranceCarrierName      ,M.HealthPlanName      ,M.InsuranceEffectiveDate      ,M.InsuranceEndDate       ,M.InsuranceCarrierID      ,M.InsuranceHealthPlanID      ,M.InsuranceNbr      ,M.InsuranceType      ,M.IVQStatus      ,CAST(M.IsInsuranceEligibilityVerified AS bit) IsInsuranceEligibilityVerified      ,CAST(M.IsDiscountProgram AS bit) IsDiscountProgram      ,CAST(M.IsNhDiscount AS bit) IsNhDiscount      ,M.BenfitType      ,M.OTCCardNumber      ,M.AllowAdditionalServices      ,M.GroupNbr      from  (     select          MI.memberprofileid      ,IC.InsuranceCarrierName      ,IH.HealthPlanName      ,InsuranceEffectiveDate      ,InsuranceEndDate       ,IC.InsuranceCarrierID      ,IH.InsuranceHealthPlanID      ,MD.InsuranceNbr      ,InsuranceType      ,IVQStatus      ,isnull(IsInsuranceEligibilityVerified,0) as IsInsuranceEligibilityVerified      ,isnull(IC.IsDiscountProgram,0) as IsDiscountProgram      ,0 as IsNhDiscount          ,case when (format(getdate(),'yyyy-MM-dd')>= format(MI.InsuranceEffectiveDate,'yyyy-MM-dd')  and format(getdate(),'yyyy-MM-dd') <= format(MI.InsuranceEndDate,'yyyy-MM-dd')) then 1 else 0  end as IsActiveINS      ,JSON_Value(d.BenefitRuleData,'$.BENTYPE') as BenfitType      ,MD.OTCCardNumber      ,IC.AllowAdditionalServices      ,MD.GroupNbr      from      [provider].[MemberInsurances] MI      LEFT JOIN [provider].[MemberInsuranceDetails] MD  on MI.MemberInsuranceID=MD.MemberInsuranceID and MD.IsActive = 1       LEFT JOIN Insurance.InsuranceCarriers IC  on MI.InsuranceCarrierID=IC.InsuranceCarrierID and  IC.IsActive=1      LEFT JOIN Insurance.InsuranceHealthPlans IH  on MI.InsuranceHealthPlanID=IH.InsuranceHealthPlanID and IH.IsActive=1      left Join [Insurance].[HealthPlanContracts] HC on  HC.InsuranceHealthPlanID=IH.InsuranceHealthPlanID and MI.InsuranceCarrierID=IC.InsuranceCarrierID and HC.Isactive=1      left Join [Insurance].[ContractRules] CR on CR.HealthPlanContractId=HC.HealthPlanContractId and CR.isactive=1      left join [rulesengine].[BenefitRulesData] d ON cr.[BenefitRuleDataId]=d.[BenefitRuleDataId] and d.isactive=1      where MI.IsActive = 1 and IC.InsuranceCarrierID is not null and  MI.memberprofileid= @MemberProfileId        ) M  END  
CREATE Procedure [provider].[GetMemberAppointmentHistoryUpdates]  @memberProfileId [bigint]    AS  BEGIN  SET NOCOUNT ON     select ROW_NUMBER() OVER (ORDER BY c.MemberAppointmentId) as 'RowID',*from (Select              mc.MemberProfileId,            ma.MemberAppointmentId,            mcd.LocationId,            t.AppointmentTypeName,      ma.[StartDate] StartDate,      ma.[StartTime] StartTime,            l.BusinessName as ProviderName,            up.FirstName ,            up.LastName,            ma.Confirmed,            ma.AppointmentStatus,            a.CancelReason,                                                         l.Address1,            l.Address2,            l.City ,            l.State,            l.Zip,            ma.ModifyDate,            ma.WalkIn,            ma.MissingDate,      mcd.ProviderId,            CASE WHEN l.TimeZone ='Mountain Standard Time' THEN 'MST' WHEN l.TimeZone ='Hawaiian Standard Time' THEN 'HST'             WHEN l.TimeZone = 'Pacific Standard Time' THEN 'PST' WHEN l.TimeZone = 'Central Standard Time'             THEN 'CST' WHEN l.TimeZone = 'Eastern Standard Time' THEN 'EST' END AS TimeZone,      (CASE       WHEN JSON_VALUE(mcd.ProcessData, '$.insuranceCarrierName') is null then [in].[InsuranceCarrierName]      ELSE JSON_VALUE(mcd.ProcessData, '$.insuranceCarrierName')     END) insuranceCarrierName                                                                               FROM [provider].[MemberAppointments_History] ma                   join [provider].[MemberChartData] mcd on mcd.MemberChartDataId = ma.MemberChartDataId                   join [provider].[MemberCharts] mc on mc.MemberChartId= mcd.MemberChartId                       LEFT JOIN [Insurance].[InsuranceCarriers] [in] ON [in].[InsuranceCarrierID] = JSON_VALUE(mcd.ProcessData, '$.InsuranceCarrierId')                   join [auth].[UserProfiles] up on up.UserProfileId = ma.HCPUserProfileId                   join [provider].[MemberAppointments] a on a.MemberAppointmentId = ma.MemberAppointmentId                   join [provider].[AppointmentTypes] t on t.AppointmentTypeId = ma.AppointmentTypeId                   join [provider].[Locations] l on l.LocationId = mcd.LocationId               where mc.MemberProfileId  = @memberProfileId    ) c order by c.ModifyDate desc  END
CREATE PROCEDURE [provider].[Update_AppointmentStatus]           (@memberAppointmentId  NVARCHAR(50) = NULL,@appointmentStatus  NVARCHAR(50) = NULL)    /*         Author: Srinivas G         Date: March 1 2019  Desription 1: This stored procedure updates appointment status         */         AS         BEGIN     update [provider].[MemberAppointments] set appointmentStatus=@appointmentStatus where MemberAppointmentId=@memberAppointmentId  END  
CREATE procedure [provider].[ReceiptDataByMemberChart]  ( @chartId bigint=0)  as  begin  declare @results table (   Type varchar(30),   Description varchar(50),   PaymentDate date,   OrderID bigint,   CopayAmount decimal,   AmountPaid decimal,   TransactionGroupID varchar(40)  );  insert into @results  select 'Co Payment' as Type  ,(case d.minorprocessid when 20 then 'Testing Co Payment' when 38 then 'Device Co Payment' when 29 then 'Fitting Co Payment' end) as Description  ,a.PaymentDate, a.OrderID, a.CopayAmount, a.AmountPaid, a.TransactionGroupID  from provider.memberchartdata d  cross apply openjson(d.processdata) with (PaymentDate date '$.paymentDate', OrderID bigint '$.orderID', CopayAmount decimal '$.copayAmount', AmountPaid decimal '$.amountPaid', TransactionGroupID varchar(40) '$.transactionGroupID') a  where d.minorprocessid in (20, 29, 38)  and d.memberchartid=@chartId;      select * from @results;    select   AccountHolderName  ,PaymentTypeCode  ,CardTypeCode  ,BankName  ,AccountNumber  ,Amount  ,a.TransactionGroupID  from [PaymentGateway].[AuthorizedTransactions] a  inner join @results r on a.TransactionGroupID=r.TransactionGroupID  end  
CREATE procedure [provider].[ReceiptDataByTransactionGroupId]  ( @trId nvarchar(50)='')  as  begin  select 'Co Payment' as Type  ,(case d.minorprocessid when 20 then 'Testing Co Payment' when 38 then 'Device Co Payment' when 29 then 'Fitting Co Payment' end) as Description  ,a.PaymentDate, a.OrderID, a.CopayAmount, a.AmountPaid, a.TransactionGroupID  from provider.memberchartdata d  cross apply openjson(d.processdata) with (PaymentDate date '$.paymentDate', OrderID bigint '$.orderID', CopayAmount decimal '$.copayAmount', AmountPaid decimal '$.amountPaid', TransactionGroupID varchar(40) '$.transactionGroupID') a  where d.minorprocessid in (20, 29, 38)  and a.TransactionGroupID=@trId      select   AccountHolderName  ,PaymentTypeCode  ,CardTypeCode  ,BankName  ,AccountNumber  ,Amount  ,TransactionGroupID  from [PaymentGateway].[AuthorizedTransactions]  where TransactionGroupID = @trId;  end  
-- 10/16/2020 - Damian Montero Ran on stage  -- 11/21/2020 - Mohan Deployed to PROD    /*  Changed By: Harika  Changed on: 11/13/2020  Comments: Added OrderStatus FFC and FFQ for OrderStatus return property.  */    CREATE Procedure [provider].[GetOrderManagementDetails]  @nhMemberId [nvarchar](50),  @providerCode [varchar](10),  @engagementId [bigint]  AS  BEGIN  SET NOCOUNT ON     IF (@providerCode = '180000')  BEGIN                  IF(@engagementId = 0 )  BEGIN      SELECT  distinct Me.MemberChartId as EngagementId   ,cast(o.DateOrderReceived as date) as OrderDate   ,o.[OrderID] as OrderId   ,NhMemberID    ,[OrderType]    ,Convert(varchar(50),(select STRING_AGG(PONUMBER, ', ')    from [Orders].[OrderPOs] where OrderId = o.OrderId Group by OrderId)) as PoNumber   ,(case t.ordertransactiondata when null then null else (select string_agg(convert(varchar, PODate, 110), ',') from (select PODate from openjson(t.ordertransactiondata) with (PODate date '$.poDate')) c) end) as PODATE   ,Convert(varchar(50),(SELECT CASE WHEN OrderStatusCode = 'INI'  THEN 'Initiated' WHEN  OrderStatusCode = 'REV'  THEN 'Reviewed' WHEN OrderStatusCode = 'APP'  THEN 'Approved'    WHEN OrderStatusCode = 'PO' THEN 'PO' WHEN OrderStatusCode = 'ACK' THEN 'Acknowledge' WHEN OrderStatusCode = 'CAN' THEN 'Cancelled'    WHEN OrderStatusCode = 'RET' THEN 'Returned' WHEN OrderStatusCode = 'REI' THEN 'Re-Initiated' WHEN OrderStatusCode = 'SHI' THEN 'Shipped' WHEN OrderStatusCode = 'DEL' THEN 'Delivered'   WHEN OrderStatusCode = 'PAY' THEN 'Payment' WHEN OrderStatusCode = 'CLM' THEN 'Claim Submitted' WHEN OrderStatusCode = 'DOC' THEN 'Documents Verified' WHEN OrderStatusCode = 'APQ' THEN 'Pending Approval'    WHEN OrderStatusCode = 'FFC' THEN 'Pre-programming Completed' WHEN OrderStatusCode = 'FFQ' THEN 'Pre-programming Queue' -- Added by Harika   END FROM Orders.OrderStatusTypes WHERE OrderStatusCode = o.OrderStatusCode)) as OrderStatus   ,(select top 1 B.BrandName from orders.orderITems OT inner join [catalog].[Brands] B on B.BrandCode=OT.BrandCode where orderid = o.orderid  and B.Isactive =1) as BrandCode   ,(select top 1 ProductModelCode from orders.orderITems where orderid = o.orderid and itemtype = 'HA') as ModelCode   ,(select top 1 JSON_VALUE(OrderTransactionData,'$.approvedBy')    from Orders.OrderTransactionDetails where OrderId = o.OrderId and orderstatuscode='APP'  and isactive=1) as ApprovedBy   ,convert(Datetime,(select top 1 JSON_VALUE(OrderTransactionData,'$.approvedDate')    from Orders.OrderTransactionDetails where OrderId = o.OrderId and orderstatuscode='APP' and isactive=1)) as ApprovedDate   ,cast((select count(*) from orders.orderITems where orderid = o.orderid and itemtype = 'HA' and isactive=1 and [Status] = 'ACTIVE')as int) [HAItemsCount]   ,cast((select count(*) from orders.orderITems where orderid = o.orderid and itemtype = 'EM' and isactive=1 and [Status] = 'ACTIVE')as int) [EMItemsCount]   ,convert(decimal(10,2),Isnull(JSON_VALUE(OrderAmountData,'$.productPrice'),0)) as OrderPrice         ,cast(JSON_VALUE(o.OrderAmountData,'$.memberResponsibility') as decimal(10,2))   --isnull((case JSON_VALUE(o.OrderAmountData,'$.memberResponsibility') when null then Convert(decimal(10,2),cast(JSON_VALUE(o.OrderAmountData,'$.memberResponsibility') as decimal(10,2)))    --when (charindex(JSON_VALUE(o.OrderAmountData,'$.adjustments'), '-')) > 0 then (Convert(decimal(10,2),cast(JSON_VALUE(o.OrderAmountData,'$.memberResponsibility') as decimal) + cast(JSON_VALUE(o.OrderAmountData,'$.adjustments') as decimal)))   --else Convert(decimal(10,2),cast(JSON_VALUE(o.OrderAmountData,'$.memberResponsibility') as decimal(10,2)) + cast(JSON_VALUE(o.OrderAmountData,'$.adjustments') as decimal(10,2)))   --end), 0)   as MemberResponsibility            ,Convert(decimal(10,2), isnull((select top 1 JSON_VALUE(OrderTransactionData,'$.totalAmount')   from Orders.OrderTransactionDetails where OrderId = o.OrderId and orderstatuscode='PAY' and isactive=1), 0)) as AmountPaid   ,c
/*  Mohan deployed to Production on 12 May 2020  */    CREATE PROCEDURE [provider].[GetOrderManagementPaymentDetails]       (        @nhMemberId [nvarchar](50),        @providerCode [nvarchar](10),        @engagementId [bigint]      )      AS      BEGIN          -- SET NOCOUNT ON added to prevent extra result sets from          -- interfering with SELECT statements.          SET NOCOUNT ON             declare @activeIns table (                    InsCarrierId bigint,                    InsPlanId bigint,                    MemberProfileId bigint             );                          insert into @activeIns             select top 1 i.InsuranceCarrierId, i.InsuranceHealthPlanId, p.MemberProfileId from [provider].[MemberInsurances] i             inner join [provider].[MemberProfiles] p on p.MemberProfileId = i.MemberProfileId             inner join [Insurance].[InsuranceCarriers] c on c.[InsuranceCarrierID]=i.[InsuranceCarrierID] and c.[IsDiscountProgram]=1             where p.NHMemberId = @nhMemberId and p.IsActive=1 and i.IsActive=1 and             i.UseForBenefits=1;                          if((select count(*) from @activeIns)=0)                    insert into @activeIns                    select top 1 i.InsuranceCarrierId, i.InsuranceHealthPlanId, p.MemberProfileId from [provider].[MemberInsurances] i                    inner join [provider].[MemberProfiles] p on p.MemberProfileId = i.MemberProfileId                    inner join [Insurance].[InsuranceCarriers] c on c.[InsuranceCarrierID]=i.[InsuranceCarrierID] and c.[IsDiscountProgram]=0                    where p.NHMemberId = @nhMemberId and p.IsActive=1 and i.IsActive=1 and                    i.[InsuranceEffectiveDate] <= getdate() and (i.[InsuranceEndDate] is null or i.[InsuranceEndDate] >= getdate())                    order by i.[MemberInsuranceID] desc;                   select convert(int,ROW_NUMBER() OVER(ORDER BY Ordernumber desc)) AS  RowID,*,'' as PaymentDate from              (             SELECT                 null as CoPayType             ,o.[OrderID] as Ordernumber             ,o.OrderType as OrderType            ,NhMemberID             ,Isnull(Convert(decimal(10,2),JSON_VALUE(o.OrderAmountData,'$.memberResponsibility')),0) as MemberResponsibility                      ,Convert(decimal(10,2), isnull((select top 1 JSON_VALUE(OrderTransactionData,'$.totalAmount')            from Orders.OrderTransactionDetails where OrderId = o.OrderId and orderstatuscode='PAY' and isactive=1), 0)) as AmountPaid             ,convert(decimal(10,2),isnull(JSON_VALUE(OrderAmountData, '$.memberResponsibility'),0))-                convert(decimal(10,2),isnull(JSON_VALUE(OrderAmountData, '$.appliedCredit.value'),0))-                Convert(decimal(10,2), isnull((select top 1 JSON_VALUE(OrderTransactionData,'$.totalAmount')            from Orders.OrderTransactionDetails where OrderId = o.OrderId and orderstatuscode='PAY' and isactive=1), 0)) +               convert(decimal(10,2),isnull(JSON_VALUE(OrderAmountData, '$.refundDetails.refundedAmount') ,0))               + convert(decimal(10,2),isnull(JSON_VALUE(OrderAmountData, '$.forwardCredits.creditForwarded'),0)) as Balance             ,0 as HPCId             ,Cast((case when Exists(select * from [Orders].[OrderTransactionDetails] where orderid = o.OrderId              and Iscomplete=1 and  OrderStatusCode='PAY') then 1 else 0 end) as bit) as PayComplete             ,Convert(varchar(50),(select STRING_AGG(PONUMBER, ', ') from [Orders].[OrderPOs] where OrderId = o.OrderId Group by OrderId)) as PoNumber             ,(case t.ordertransactiondata when null then null else (select string_agg(convert(varchar, PODate, 110), ',') from (select PODate from openjson(t.ordertransactiondata) with (PODate date '$.poDate')) c) end) as PODATE             ,(select top 1 B.BrandName from orders.orderITems OT inner join [catalog].[Brands] B on B.BrandCode=OT.BrandCode where orderid = o.orderid  and B.Isactive =1) as BrandCode             ,cast(Isnull(JSON_
CREATE procedure [provider].[GetProviderOwnerUserProfile]  ( @ProviderCode [varchar](10) )  as  begin  select up.* from [auth].[UserProfiles] up  inner join [provider].[ProviderUsers] pu on up.[UserProfileId]=pu.[UserProfileId]  inner join [auth].[UserProfileGroups] upg on upg.[UserProfileId]=up.[UserProfileId]  inner join [provider].[ProviderProfiles] pp on pp.[ProviderId]=pu.[ProviderId]  where pp.[ProviderCode]=@ProviderCode and upg.[UserGroupId]=7790--Owner  end  
-- 10/16/2020 - Damian Montero Ran on stage  -- 11/21/2020 - Mohan Deployed to PROD      /*  Changed By: Harika  Changed on: 11/10/2020  Comments: Getting CRM Orders and excluding DH Orders (memberportal and DHC). Removed Member portal condition for getting DH orders.  */    CREATE PROCEDURE  [provider].[GetPendingApprovalOrders]        @orderStatusCode Varchar(5),        @providercode varchar(10),        @orderSource varchar(20)=null      AS        BEGIN        -- Get Penging approval orders        IF(@providercode='180000')        BEGIN        -- Get Pending Approval orde[provider].[GetPreServiceAuthRequestHistory]rs        if(@orderStatusCode='APQ')        BEGIN         select  distinct TOP 100              PP.ProviderCode          ,JSON_VALUE(o.MemberData, '$.firstName') MemberFirstName          ,JSON_VALUE(o.MemberData, '$.lastName') MemberLastName          ,cast(isnull(JSON_VALUE(o.ProviderData, '$.providerId'),0) as bigint) ProviderId          ,cast(isnull(JSON_VALUE(o.ProviderData, '$.address.locationId'),0) as bigint) LocationId          ,JSON_VALUE(o.ProviderData, '$.providerLeagalBusinessName') LocationName          ,o.MemberChartDataId           ,(select top 1 it.BrandCode from Orders.OrderItems it where it.orderid=o.orderid) BrandCode          ,case WHEN (ISJSON(o.MemberData) > 0) THEN            cast(isnull(JSON_VALUE(o.MemberData, '$.insCarrierId'),0) as bigint)            ELSE 0 END InsuranceCarrierId          ,case WHEN (ISJSON(o.MemberData) > 0) THEN            cast(isnull(JSON_VALUE(o.MemberData, '$.insPlanId'),0) as bigint)            ELSE 0 END HealthPlanId          ,o.NHMemberId          ,o.OrderId          ,o.DateOrderReceived as OrderDate          ,o.OrderType          ,o.OrderStatusCode          ,ty.[OrderStatusName] as OrderStatus          ,MC.MemberChartId          ,JSON_VALUE(o.ProviderData, '$.address.address1') Address1          ,JSON_VALUE(o.ProviderData, '$.address.address2') Address2          ,JSON_VALUE(o.ProviderData, '$.address.city') City          ,JSON_VALUE(o.ProviderData, '$.address.state') State          ,JSON_VALUE(o.ProviderData, '$.address.zip') Zip          ,JSON_VALUE(o.ProviderData, '$.address.country') Country          ,JSON_VALUE(o.ProviderData, '$.hcp.firstName')+' '+JSON_VALUE(o.ProviderData, '$.hcp.lastName') as HCPName          ,cast((case when exists (select * from [Orders].[OrderTransactionDetails] where (OrderStatusCode='APQ' OR OrderStatusCode='APP' OR OrderStatusCode='CAN')  and orderid=o.orderid) then 1 else 0 end)as bit )  AS SubmittedForApproval          ,cast((select top 1 cast((case when [OrderTransactionID] is null then null else (case  when iscomplete=1 then 1 else 0 end) end ) as bit) from [Orders].[OrderTransactionDetails] where OrderStatusCode='DOC' and orderid=o.orderid) as bit ) AS IsDocComplete          ,cast((case when exists (select * from [Orders].[OrderTransactionDetails] where (OrderStatusCode='APP' OR OrderStatusCode='RET' OR OrderStatusCode='CAN' )  and orderid=o.orderid) then 1 else 0 end)as bit )   AS IsApproved            ,Convert(varchar(50),(select STRING_AGG(PONUMBER, ', ') from [Orders].[OrderPOs] where OrderId = o.OrderId Group by OrderId)) as PoNumber            , case when t.OrderStatusCode='PO' then  (case t.ordertransactiondata when null then null else (select string_agg(convert(varchar, PODate, 110), ',')                from (select PODate from openjson(t.ordertransactiondata) with (PODate date '$.poDate')) c) end)end as PODATE          from orders.orders o           inner join [provider].[ProviderProfiles] PP on cast(JSON_VALUE(o.ProviderData, '$.providerId') as bigint)=PP.ProviderId          inner join [Orders].[OrderStatusTypes] ty on ty.[OrderStatusCode]=o.[OrderStatusCode]          left join(select * from [Orders].[OrderTransactionDetails] where IsActive=1  and OrderStatusCode ='PO') t ON o.orderid =t.orderid          left join [provider].[MemberChartData] MD on MD.MemberChartDataId=O.MemberChartDataId and MD.Isactive=1          joi
-- 10/16/2020 - Damian Montero - ran on stage.  -- 11/21/2020 - Mohan Deployed to PROD    /*  Created By: Harika  Created on: 11/10/2020  Comments: Getting all DH Orders based on filters applied in Manage DH Orders.  */  -- exec [provider].[GetPendingApprovalDHOrders] 'APP',180000,'MemberPortal'  CREATE PROCEDURE [provider].[GetPendingApprovalDHOrders]        @orderStatusCode Varchar(5),        @providercode varchar(10),        @orderSource varchar(20)=null      AS        BEGIN        -- Get Penging approval orders        IF(@providercode='180000')        BEGIN        -- Get Pending Approval orde[provider].[GetPreServiceAuthRequestHistory]rs        if(@orderStatusCode='APQ')        BEGIN         -- Get All DH Orders          select  distinct             PP.ProviderCode          ,JSON_VALUE(o.MemberData, '$.firstName') MemberFirstName          ,JSON_VALUE(o.MemberData, '$.lastName') MemberLastName          ,cast(isnull(JSON_VALUE(o.ProviderData, '$.providerId'),0) as bigint) ProviderId          ,cast(isnull(JSON_VALUE(o.ProviderData, '$.address.locationId'),0) as bigint) LocationId          ,JSON_VALUE(o.ProviderData, '$.providerLeagalBusinessName') LocationName          ,o.MemberChartDataId           ,(select top 1 it.BrandCode from Orders.OrderItems it where it.orderid=o.orderid) BrandCode          ,case WHEN (ISJSON(o.MemberData) > 0) THEN            cast(isnull(JSON_VALUE(o.MemberData, '$.insCarrierId'),0) as bigint)            ELSE 0 END InsuranceCarrierId           ,case WHEN (ISJSON(o.MemberData) > 0) THEN            isnull(JSON_VALUE(o.MemberData, '$.insurance.carrierName'),'')      ELSE '' END CarrierName    ,case WHEN (ISJSON(o.MemberData) > 0) THEN            cast(isnull(JSON_VALUE(o.MemberData, '$.insPlanId'),0) as bigint)            ELSE 0 END HealthPlanId          ,o.NHMemberId          ,o.OrderId          ,o.DateOrderReceived as OrderDate          ,o.OrderType          ,o.OrderStatusCode          ,ty.[OrderStatusName] as OrderStatus          ,MC.MemberChartId          ,CASE WHEN O.Source = 'MemberPortal' THEN 'DHE' ELSE O.Source END AS OrderSource    ,JSON_VALUE(o.ProviderData, '$.address.address1') Address1          ,JSON_VALUE(o.ProviderData, '$.address.address2') Address2          ,JSON_VALUE(o.ProviderData, '$.address.city') City          ,JSON_VALUE(o.ProviderData, '$.address.state') State          ,JSON_VALUE(o.ProviderData, '$.address.zip') Zip          ,JSON_VALUE(o.ProviderData, '$.address.country') Country          ,JSON_VALUE(o.ProviderData, '$.hcp.firstName')+' '+JSON_VALUE(o.ProviderData, '$.hcp.lastName') as HCPName          ,cast((case when exists (select * from [Orders].[OrderTransactionDetails] where (OrderStatusCode='APQ' OR OrderStatusCode='APP' OR OrderStatusCode='CAN')  and orderid=o.orderid) then 1 else 0 end)as bit )  AS SubmittedForApproval          ,cast((select top 1 cast((case when [OrderTransactionID] is null then null else (case  when iscomplete=1 then 1 else 0 end) end ) as bit) from [Orders].[OrderTransactionDetails] where OrderStatusCode='DOC' and orderid=o.orderid) as bit ) AS IsDocComplete          ,cast((case when exists (select * from [Orders].[OrderTransactionDetails] where (OrderStatusCode='APP' OR OrderStatusCode='RET' OR OrderStatusCode='CAN' )  and orderid=o.orderid) then 1 else 0 end)as bit )   AS IsApproved            ,Convert(varchar(50),(select STRING_AGG(PONUMBER, ', ') from [Orders].[OrderPOs] where OrderId = o.OrderId Group by OrderId)) as PoNumber            , case when t.OrderStatusCode='PO' then  (case t.ordertransactiondata when null then null else (select string_agg(convert(varchar, PODate, 110), ',')                from (select PODate from openjson(t.ordertransactiondata) with (PODate date '$.poDate')) c) end)end as PODATE          from orders.orders o           inner join [provider].[ProviderProfiles] PP on cast(JSON_VALUE(o.ProviderData, '$.providerId') as bigint)=PP.ProviderId          inner join [Orders].[OrderStatusTypes] ty on ty.[OrderStatusCode]=o.[Ord
CREATE PROCEDURE [provider].[GetPricingSummaryDetails]   (      -- Add the parameters for the stored procedure here      @orderId bigint  )  AS  BEGIN      -- SET NOCOUNT ON added to prevent extra result sets from      -- interfering with SELECT statements.      SET NOCOUNT ON   -- declare @orderId bigint =190002458   SELECT O.OrderID,OrderAmountData,O.BenefitsData,MemberData,convert(decimal(10,2),isnull((select top 1 JSON_VALUE(orderTransactionData, '$.totalAmount') from [Orders].[OrderTransactionDetails] OT where OT.Orderid = O.Orderid and OT.Orderstatuscode='PAY' and OT.IsActive=1),0)) AS MemberPaid FROM  orders.orders O     where O.orderid=@orderId and O.IsActive=1    END    
CREATE PROCEDURE  [provider].[GetApprovalQueueOrders]    AS  BEGIN      -- SET NOCOUNT ON added to prevent extra result sets from      -- interfering with SELECT statements.      SET NOCOUNT ON    -- declare @providerid int =591;    select  ROW_NUMBER() OVER(ORDER BY OrderId ASC) AS RowId    ,PP.ProviderCode    ,JSON_VALUE(ProviderData, '$.dba') LocationName    ,NHMemberId    ,OrderId    ,DateOrderReceived as OrderDate    ,OrderType    ,OrderStatusCode    ,JSON_VALUE(ProviderData, '$.address.address1') Address1    ,JSON_VALUE(ProviderData, '$.address.address2') Address2    ,JSON_VALUE(ProviderData, '$.address.city') City    ,JSON_VALUE(ProviderData, '$.address.state') State    ,JSON_VALUE(ProviderData, '$.address.zip') Zip    ,JSON_VALUE(ProviderData, '$.address.country') Country    --,(select top 1 JSON_VALUE(OrderTransactionData,'$.sumbit.comments')    -- from Orders.OrderTransactionDetails where OrderId = o.OrderId and orderstatuscode='APP'  and isactive=1) as ApprovedComments    ,cast((Case when exists (select * from [Orders].[OrderTransactionDetails]      where  IsActive=1  and OrderStatusCode='APQ' and OrderId = o.OrderId) then 1 else 0 end) as Bit) SubmittedForApproval    from orders.orders o     join [provider].[ProviderProfiles] PP on JSON_VALUE(o.ProviderData, '$.providerId')=PP.ProviderId    where         O.OrderType IN ('NEW','LSND','LSandD', 'EXCHANGE')    and O.Isactive=1    and Not exists (select * from Orders.OrderTransactionDetails where OrderId = o.OrderId and orderstatuscode='APP'  and isactive=1 and iscomplete=1)    and o.Status='Active'    END  
 CREATE PROCEDURE [provider].[Get_LocationAndHCPAvilability]               (@providerid  NVARCHAR(50) = NULL,              @locationid NVARCHAR(50) = NULL,        @userprofileid NVARCHAR(50) = NULL)           /*             Author: Srinivas G             Date: Feb 01 2019       Desription 1: This stored procedure returns Location and HCP Avilability which are IsActive=1             */             AS             BEGIN             DECLARE @SQLSubQuery AS NVARCHAR(4000)         set @SQLSubQuery ='select distinct PUL.locationid,PUL.userprofileid,PS.DayName as LocationDayName,LS.Opentime as LocationOpenTime,LS.CloseTime as LocationCloseTime,       LS.BreakStartTime as LocationBreakStartTime,LS.BreakEndtime as LocationBreakEndTime,LS.IsByappointmentonly as LocationIsByappointmentonly,       PS.Opentime as HCPOpenTime,PS.CloseTime as HCPCloseTime,PS.BreakStartTime as HCPBreakStartTime, PS.BreakEndTime as HCPBreakEndTime,       PS.Isclosed as HCPIsClosed,PS.IsByappointmentonly as HCPIsByappointmentonly       from [provider].[ProviderUserLocations] as PUL       join [provider].[LocationSchedules] as LS on LS.locationid=PUL.locationid       join [provider].[HCPSchedules] as PS on PS.locationid=PUL.locationid and PUL.userprofileid=PS.userprofileid      where LS.isactive=1 and PUL.isactive=1 and PS.IsActive=1 and  PUL.providerid='+@providerid +'and PUL.locationid='+@locationid +'and PUL.userprofileid='+@userprofileid +''        SET @SQLSubQuery = 'select ROW_NUMBER() OVER (ORDER BY C.locationid) as ''RowID'',*from ('+@SQLSubQuery+') C'                print @SQLSubQuery          EXECUTE sp_ExecuteSQL @SQLSubQuery             END  
CREATE PROCEDURE [provider].[Get_LocationAvilability]           (@locationid NVARCHAR(50) = NULL,  @providerid  NVARCHAR(50) = NULL)        /*          Author: Srinivas G          Date: Feb 01 2019    Desription 1: This stored procedure returns Location Avilability which are IsActive=1          */          AS          BEGIN          DECLARE @SQLSubQuery AS NVARCHAR(4000)      set @SQLSubQuery ='select distinct PL.Providerid,PL.Locationid,LS.opentime,LS.closetime,LS.dayname,LS.Breakstarttime,LS.BreakEndtime,  LS.isclosed,ls.isbyappointmentonly from   [provider].[ProviderLocations] as PL  join [provider].[LocationSchedules] as LS on LS.locationid=PL.locationid  where PL.isactive=1 and LS.isactive=1 and PL.locationid='+@locationid +' and PL.providerid='+@providerid +''      SET @SQLSubQuery = 'select ROW_NUMBER() OVER (ORDER BY C.locationid) as ''RowID'',*from ('+@SQLSubQuery+') C'     EXECUTE sp_ExecuteSQL @SQLSubQuery          END     
CREATE PROCEDURE [provider].[Get_ProviderLocations]           (@providerid  NVARCHAR(50) = NULL,@profileId  NVARCHAR(50) = NULL)    /*         Author: Srinivas G         Date: Feb 14 2019  Desription 1: This stored procedure returns Locations  which are IsActive=1         */         AS         BEGIN         DECLARE @SQLSubQuery AS NVARCHAR(4000)     set @SQLSubQuery ='select distinct LO.LocationId,LO.Address1,LO.Address2,LO.City,LO.State,LO.Zip   from [provider].[ProviderProfiles] as PP  join [provider].[ProvideruserLocations] as PL on PL.providerid='+@providerid+' and PL.userprofileid='+@profileId+'  join [provider].[Locations] as LO on PL.locationid=LO.locationid  where PP.isActive=1 and PL.isActive=1 and LO.isActive=1 and PP.providerid='+@providerid+''      SET @SQLSubQuery = 'select ROW_NUMBER() OVER (ORDER BY C.LocationId) as ''RowID'',*from ('+@SQLSubQuery+') C'            print @SQLSubQuery      EXECUTE sp_ExecuteSQL @SQLSubQuery         END  
CREATE PROCEDURE [provider].[Get_HCPAvilability]               (@providerid  NVARCHAR(50) = NULL,              @locationid NVARCHAR(50) = NULL)           /*             Author: Srinivas G             Date: Feb 01 2019       Desription 1: This stored procedure returns HCP Avilability which are IsActive=1             */             AS             BEGIN             DECLARE @SQLSubQuery AS NVARCHAR(4000)         set @SQLSubQuery ='select distinct PUL.locationid,PUL.userprofileid,PS.DayName as LocationDayName,LS.Opentime as LocationOpenTime,LS.CloseTime as LocationCloseTime,       LS.BreakStartTime as LocationBreakStartTime,LS.BreakEndtime as LocationBreakEndTime,LS.IsByappointmentonly as LocationIsByappointmentonly,       PS.Opentime as HCPOpenTime,PS.CloseTime as HCPCloseTime,PS.BreakStartTime as HCPBreakStartTime, PS.BreakEndTime as HCPBreakEndTime,       PS.Isclosed as HCPIsClosed,PS.IsByappointmentonly as HCPIsByappointmentonly       from [provider].[ProviderUserLocations] as PUL       join [provider].[LocationSchedules] as LS on LS.locationid=PUL.locationid       join [provider].[HCPSchedules] as PS on PS.locationid=PUL.locationid and PUL.userprofileid=PS.userprofileid      where LS.isactive=1 and PUL.isactive=1 and PS.IsActive=1 and  PUL.providerid='+@providerid +'and PUL.locationid='+@locationid +''        SET @SQLSubQuery = 'select ROW_NUMBER() OVER (ORDER BY C.locationid) as ''RowID'',*from ('+@SQLSubQuery+') C'                print @SQLSubQuery          EXECUTE sp_ExecuteSQL @SQLSubQuery             END  
CREATE PROCEDURE [provider].[Get_AppointmentsByUserProfileId]           (@userprofileid NVARCHAR(50) = NULL,   @starttime VARCHAR(50) = NULL)  /*         Author: Srinivas G         Date: Feb 01 2019  Desription 1: This stored procedure returns appointments         */         AS         BEGIN         DECLARE @SQLSubQuery AS NVARCHAR(4000)     DECLARE @appointmentstatus as varchar(20)  set @appointmentstatus='Complete'  set @SQLSubQuery ='select appointmentstatus,appointmenttypeid,hcpuserprofileid,startdate,starttime,enddate,endtime   from [provider].[MemberAppointments]  where isactive=1 and appointmentstatus!='''+@appointmentstatus+''' and hcpuserprofileid='+@userprofileid +' and starttime like ''%'+@starttime+'%'''      SET @SQLSubQuery = 'select ROW_NUMBER() OVER (ORDER BY C.appointmentstatus) as ''RowID'',*from ('+@SQLSubQuery+') C'            print @SQLSubQuery      EXECUTE sp_ExecuteSQL @SQLSubQuery         END    
  CREATE PROCEDURE [provider].[GetNewProviderCode]   @providerId BIGINT    AS  BEGIN    SET NOCOUNT ON;      DECLARE @ProviderCode VARCHAR(6),      @StaticNumber VARCHAR(6),      @ProvDiff INT,      @StaticDiff INT;     SET  @StaticNumber  = '180000'     SELECT @ProviderCode = ProviderCode    FROM [provider].[ProviderProfiles]    WHERE providerid = @providerId AND LEN(ProviderCode) <= 6     BEGIN        SET @ProvDiff = Len(@StaticNumber) - Len(@ProviderId);    SET @StaticDiff = Substring(@StaticNumber, 1, @ProvDiff);    SET @ProviderCode = Cast(@StaticDiff as Varchar(6)) + Cast(@ProviderId as Varchar(6))          UPDATE [provider].[ProviderProfiles]      SET  ProviderCode = @ProviderCode      WHERE providerid = @providerId             SELECT *     FROM [provider].[ProviderProfiles]      WHERE providerid= @providerId   END  END  
create proc [provider].GetFittingLocationInfoByMemberChart  @MemberchartId bigint  as  select l.[LocationId],[ActiveDate],[Address1],[Address2],[Brands],[BusinessName],[BusinessType],[City],[Dispenser]  ,[IsVerified],[IsWheelChair],[Langauges],[Latitude],[LocationTypeId],[Longitude],[NPINumber],[OfficeSecodary],[Officeprimary],[PatientTypes]  ,[ProviderType],[State],[StateName],[StoreCategory],[TimeZone],[Zip],[LocationEmailAddress],[LocationServicesData],[IsMedicaid],[County],[InActiveDate],  [InActiveReason],[Country],[TaxId],[IsMedicare],[IsCredentialsMet],[IsMobileLocation],[IsHandicapSpecialNeedsAccess],[IsPediatricServices],[IsPublicTransport]  ,[IsADAComplauints],[IsAcceptNewPatients],[PatientMinAge],[PatientMaxAge],l.[CreateDate],l.[CreateUser],l.[ModifyUser],l.[ModifyDate],l.[IsActive]   from [provider].[Locations] l join [provider].[MemberChartData] mcd   on l.locationid=mcd.[LocationId] where memberchartid=@MemberchartId and minorprocessid=25 and mcd.isactive=1 and l.isactive=1  
  CREATE Procedure [provider].[Get_ActiveMemberChart](  @MemberProfileId bigint,    @ProviderId bigint,  @MemberChartDataId bigint,  @AppointmentId bigint  )  AS  BEGIN    --DECLARE @MemberProfileId bigint --= 9961    -- 1. Get Active MemberChart of the Member    DECLARE @MemberChartId bigint = 0    -- OTC Member   IF (@MemberChartDataId = 0)    BEGIN      SELECT @MemberChartId = (SELECT TOP 1 C.[MemberChartId] FROM [provider].[MemberCharts] C   INNER JOIN [provider].[MemberChartData] D ON C.[MemberChartId]=D.[MemberChartId]   --INNER JOIN [provider].[MemberAppointments] A ON A.[MemberChartDataId]=D.[MemberChartDataId]   WHERE C.[MemberProfileId] = @MemberProfileId    --AND (@ProviderId=0 OR D.[ProviderId]=@ProviderId) AND (@MemberChartDataId=0 OR D.[MemberChartDataId]=@MemberChartDataId) AND (@AppointmentId=0 OR A.[MemberAppointmentId] = @AppointmentId)    ORDER BY C.[MemberChartId] DESC)        SELECT *FROM [provider].[MemberCharts] WHERE [MemberChartId] = @MemberChartId  END  -- HA Member  ELSE  BEGIN    SELECT @MemberChartId = (SELECT TOP 1 C.[MemberChartId] FROM [provider].[MemberCharts] C   INNER JOIN [provider].[MemberChartData] D ON C.[MemberChartId]=D.[MemberChartId]   INNER JOIN [provider].[MemberAppointments] A ON A.[MemberChartDataId]=D.[MemberChartDataId]   WHERE C.[MemberProfileId] = @MemberProfileId AND (@ProviderId=0 OR D.[ProviderId]=@ProviderId) AND (@MemberChartDataId=0 OR D.[MemberChartDataId]=@MemberChartDataId) AND (@AppointmentId=0 OR A.[MemberAppointmentId] = @AppointmentId) ORDER BY C.[MemberChartId] DESC)        SELECT *FROM [provider].[MemberCharts] WHERE [MemberChartId] = @MemberChartId    END   END    
  --Exec [provider].[GetMembershipingItemDetails_b] 180024482,'26254,26252'  CREATE PROCEDURE [provider].[GetMembershipingItemDetails]  (     @orderId [bigint],     @OrderItemId varchar(100)    )  AS  BEGIN      -- SET NOCOUNT ON added to prevent extra result sets from      -- interfering with SELECT statements.      SET NOCOUNT ON    -- declare @orderId [bigint]='180024482'   -- declare @OrderItemId varchar(100) ='26254,26252'  select O.OrderId  ,O.NhMemberId  ,(case when isnull((JSON_VALUE(MemberData, '$.firstName')+' '+JSON_VALUE(MemberData, '$.middleName')+' '+JSON_VALUE(MemberData, '$.lastName')),'')='' then   (select isnull(FirstName,'') + ' ' + isnull(MiddleName,'') + '' + isnull(LastName,'') from provider.Memberprofiles where nhmemberid=O.NhMemberId) end)   as MemberName   ,isnull(JSON_VALUE(ProviderData, '$.dba'),'') + ', ' + isnull(JSON_VALUE(ProviderData, '$.address.address'),'') + ' ' + isnull(JSON_VALUE(ProviderData, '$.address.city'),'') + ' ' + isnull(JSON_VALUE(ProviderData, '$.address.state'),'') + ' ' + isnull(JSON_VALUE(ProviderData, '$.address.country'),'') + ' ' + isnull(JSON_VALUE(ProviderData, '$.address.zip'),'')  as ProviderDbaAddress  ,cast(OrderItemId as bigint) OrderItemId  ,ItemCode  ,(case when ItemType='HA'then 'Hearing Aid'else'Earmold' end) as ItemType  ,Quantity  ,BrandCode  ,StyleCode  ,ProductModelCode  ,JSON_VALUE(ItemData, '$.receiverPower') as ReceiverPower  ,JSON_VALUE(ItemData, '$.receiverSize') as ReceiverSize  ,FamilyCode  ,TechnologyLevelCode   , JSON_VALUE(ItemData, '$.color') as Color  ,JSON_VALUE(ItemData, '$.batterySize') as BatterySize  ,Modifier,PONumber,InvoiceNumber,O.CreateDate as OrderDate  ,JSON_VALUE(ShippingData, '$.email') as ShippingEmail  ,JSON_VALUE(ItemData, '$.sendingImpression') as SendingImpression  ,isnull(JSON_VALUE(ShippingData, '$.dba'),'') + ', ' + isnull(JSON_VALUE(ShippingData, '$.address.address'),'') + ' ' + isnull(JSON_VALUE(ShippingData, '$.address.city'),'') + ' ' + isnull(JSON_VALUE(ShippingData, '$.address.state'),'') + ' ' + isnull(JSON_VALUE(ShippingData, '$.address.country'),'') + ' ' + isnull(JSON_VALUE(ShippingData, '$.address.zip'),'')  as ShippingAddress  from [orders].[orders] O   Inner join [orders].[orderItems] I on O.orderid=I.orderid   where O.orderid=@orderId and O.isactive=1 and I.Isactive=1 and OrderItemId   in (SELECT *  FROM orders.fnSplitString(@OrderItemId,','))  order by OrderItemId desc  END    
--- Changes in Order By Clause  CREATE  PROCEDURE [provider].[GetOrderManagementAppointments]    @nhMemberId [nvarchar](50),   @providerCode [varchar](10),   @engagementId [bigint]  AS  BEGIN      -- SET NOCOUNT ON added to prevent extra result sets from      -- interfering with SELECT statements.      SET NOCOUNT ON   IF(@engagementId = 0 )   BEGIN      SELECT  ma.MemberAppointmentId as 'AppointmentID'           ,mcd.MemberChartId as EngagementId     ,t.[AppointmentTypeName] AppointmentType     ,m.[NHMemberId],     cast(cast(ma.StartDate as date) as datetime)+cast(cast(ma.StartTime as time) as datetime) AppointmentDate          FROM [provider].[MemberAppointments] ma      INNER JOIN [provider].[MemberChartData] mcd ON ma.MemberChartDataId = mcd.MemberChartDataId      INNER JOIN [provider].[ProviderProfiles] pp on pp.[ProviderId]=mcd.[ProviderId] and (@providerCode='180000' or pp.[ProviderCode]=@providerCode)      INNER JOIN [provider].[MemberCharts] mc ON mcd.MemberChartId = mc.MemberChartId      INNER JOIN [provider].[MemberProfiles] m ON mc.MemberProfileId = m.MemberProfileId      INNER JOIN [provider].[AppointmentTypes] t ON ma.[AppointmentTypeId] = t.[AppointmentTypeId]        where ma.[IsActive] = 1 and mcd.[IsActive] = 1 and mc.[IsActive] = 1 and  m.[NHMemberId] = @nhMemberId     and AppointmentStatus not in('Cancel','Cancelled') and t.[AppointmentTypeId] in (1,7)     order by   --OLD     --CONVERT(datetime,dateadd(hour, -4, ma.[StartDate])) desc    --Changes     ma.[StartDate] DESC    END    ELSE    BEGIN     SELECT ma.MemberAppointmentId as 'AppointmentID'           ,mcd.MemberChartId as EngagementId     ,t.[AppointmentTypeName] AppointmentType     ,m.[NHMemberId],     cast(cast(ma.StartDate as date) as datetime)+cast(cast(ma.StartTime as time) as datetime) AppointmentDate          FROM [provider].[MemberAppointments] ma      INNER JOIN [provider].[MemberChartData] mcd ON ma.MemberChartDataId = mcd.MemberChartDataId      INNER JOIN [provider].[ProviderProfiles] pp on pp.[ProviderId]=mcd.[ProviderId] and (@providerCode='180000' or pp.[ProviderCode]=@providerCode)      INNER JOIN [provider].[MemberCharts] mc ON mcd.MemberChartId = mc.MemberChartId      INNER JOIN [provider].[MemberProfiles] m ON mc.MemberProfileId = m.MemberProfileId      INNER JOIN [provider].[AppointmentTypes] t ON ma.[AppointmentTypeId] = t.[AppointmentTypeId]        where ma.[IsActive] = 1 and mcd.[IsActive] = 1 and mc.[IsActive] = 1 and  m.[NHMemberId] = @nhMemberId     and mcd.MemberChartId=@engagementId and AppointmentStatus not in('Cancel','Cancelled') and t.[AppointmentTypeId] in (1,7)     order by     --OLD    --CONVERT(datetime,dateadd(hour, -4, ma.[StartDate])) desc      --Changes     ma.[StartDate] DESC       END    END  
CREATE procedure [provider].[GetProviderUserDefaultPermissions]   (   @providerId [bigint] = 0,   @userGroupId [int] = 0  )  as  begin   select    af.[AppFeatureId]   ,af.[ParentFeatureId]   ,af.[FeatureName]   ,af.[FeatureCode]   ,af.[IsCreate]   ,af.[IsCreate] as 'IsCreateDefault'   ,af.[IsRead]   ,af.[IsRead] as 'IsReadDefault'   ,af.[IsUpdate]   ,af.[IsUpdate] 'IsUpdateDefault'   ,af.[IsDelete] as 'IsCancel'   ,af.[IsDelete] as 'IsCancelDefault'   from [auth].[ApplicationFeatures] af   where af.[IsDefault]=1 and af.[IsActive] = 1  end    
CREATE Procedure [provider].[GetMemberConsultationNotes]  (@nhMemberId NVARCHAR(50)=null,@providerCode NVARCHAR(50)=null)   AS   Begin  if(@providerCode is not null and @providerCode != '180000')  select CN.ConsultationNotesId, CN.Notes,CN.NhMemberId,CN.ProviderId,CN.CreateDate,CN.ModifyDate,CN.CreateUser,PP.ProviderCode,PP.ProviderName  from [provider].[ConsultationNotes] as CN  join [provider].[ProviderProfiles] as PP on PP.providerid=CN.providerid  where CN.nhmemberid=@nhMemberId and PP.ProviderCode=@providerCode and CN.isactive=1  else if(@providerCode is not null and @providerCode = '180000')  select CN.ConsultationNotesId,CN.Notes,CN.NhMemberId,CN.ProviderId,CN.CreateDate,CN.ModifyDate,CN.CreateUser,PP.ProviderCode,PP.ProviderName  from [provider].[ConsultationNotes] as CN  join [provider].[ProviderProfiles] as PP on PP.providerid=CN.providerid  where CN.nhmemberid=@nhMemberId and CN.isactive=1  End  
CREATE PROCEDURE [provider].[GetEngagementDetails]  (      -- Add the parameters for the stored procedure here     @nhMemberId [nvarchar](50),     @providerCode [varchar](10)  )  AS  BEGIN      -- SET NOCOUNT ON added to prevent extra result sets from      -- interfering with SELECT statements.      SET NOCOUNT ON    select      ROW_NUMBER() OVER(ORDER BY temp.startdate desc) AS RowId     ,mc.MemberChartId as EngagementId     ,temp.startdate as EngagementDate     ,temp.ProviderId as ProviderId     ,temp.ProviderCode as ProviderCode    from [provider].[MemberCharts] mc     inner join [provider].[MemberProfiles] m ON mc.MemberProfileId = m.MemberProfileId     inner join (     --select distinct pp.ProviderId, pp.ProviderCode, mcd.MemberChartId from [provider].[MemberChartData] mcd     --inner join [provider].[ProviderProfiles] pp on pp.[ProviderId]=mcd.[ProviderId]     --where (@providerCode = '180000' or pp.ProviderCode=@providerCode)     --and exists (select * from [provider].[MemberAppointments] apt where apt.[MemberChartDataId]=mcd.[MemberChartDataId] and apt.[AppointmentStatus] not in ('Cancel', 'Cancelled') and apt.[IsActive]=1)     select distinct pp.ProviderId, pp.ProviderCode, mcd.MemberChartId,apt.startdate from [provider].[MemberChartData] mcd     inner join [provider].[ProviderProfiles] pp on pp.[ProviderId]=mcd.[ProviderId]     inner join [provider].[MemberAppointments] apt on mcd.[MemberChartDataId]= apt.[MemberChartDataId]     where (@providerCode = '180000' or pp.ProviderCode=@providerCode) and apt.[AppointmentStatus] not in ('Cancel', 'Cancelled') and apt.[IsActive]=1     ) temp    on mc.MemberChartId=temp.MemberChartId    where mc.[IsActive] = 1 and m.[IsActive] = 1 and  m.[NHMemberId] = @nhMemberId     order by  mc.MemberChartId desc   END
CREATE PROCEDURE [provider].[GetPriorAuthorizationQueue]  AS  BEGIN      -- SET NOCOUNT ON added to prevent extra result sets from      -- interfering with SELECT statements.      SET NOCOUNT ON   select convert(int,CaseNumber) as CaseNumber   ,(FirstName+ ''+LastName) as MemberName   ,PR.NHMemberId   ,case when JSON_VALUE(PriorAuthRequestData, '$.requestReceivedDate')  IS NULL then convert(Date ,PR.CreateDate,120) else convert(date ,JSON_VALUE(PriorAuthRequestData, '$.requestReceivedDate')) end as RequestDate   ,JSON_VALUE(PriorAuthRequestData, '$.requestedByFirstName') + ' ' +JSON_VALUE(PriorAuthRequestData, '$.requestedByLastName') as RequestedBy   ,JSON_VALUE(PriorAuthRequestData, '$.priority') as Priority,   Json_value(PriorAuthRequestData,'$.caseDisposition') as CaseDisposition   ,(select top 1 [InsuranceCarrierName] from[Insurance].[InsuranceCarriers] where [InsuranceCarrierID] = JSON_VALUE(InsuranceDetails, '$.insCarrierId'))  as InsuranceCarrier   ,(select top 1 [HealthPlanName] from [Insurance].[InsuranceHealthPlans] where [InsuranceHealthPlanID]=JSON_VALUE(InsuranceDetails, '$.insPlanId')) as InsurancePlan   from [provider].[PriorAuthRequests] PR    left join [provider].[MemberProfiles] MP on MP.NHMemberId=PR.NHMemberId     where PR.Isactive=1   and PR.IsVerified=0    and CaseDisposition !='Pending'   order by casenumber asc  END    
CREATE PROCEDURE [provider].[GetPreServiceAuthorizationQueue]  AS  BEGIN      -- SET NOCOUNT ON added to prevent extra result sets from      -- interfering with SELECT statements.      SET NOCOUNT ON   select convert(int,CaseNumber) as CaseNumber   ,(FirstName+ ''+LastName) as MemberName   ,PR.NHMemberId   ,case when JSON_VALUE(PreServiceAuthRequestDetails, '$.requestReceivedDate')  IS NULL then convert(Date ,PR.CreateDate,120) else convert(date ,JSON_VALUE(PreServiceAuthRequestDetails, '$.requestReceivedDate')) end as RequestDate   ,JSON_VALUE(PreServiceAuthRequestDetails, '$.requestedByFirstName') + ' ' +JSON_VALUE(PreServiceAuthRequestDetails, '$.requestedByLastName') as RequestedBy   ,JSON_VALUE(PreServiceAuthRequestDetails, '$.priority') as Priority,   Json_value(PreServiceAuthRequestDetails,'$.caseDisposition') as CaseDisposition   from [provider].[PreServiceAuthRequests] PR    left join [provider].[MemberProfiles] MP on MP.NHMemberId=PR.NHMemberId     where PR.Isactive=1  and PR.IsVerified=0    and convert(Date,getdate(),120)<dateadd(dd,14,isnull(Convert(Date ,JSON_VALUE(PreServiceAuthRequestDetails, '$.requestReceivedDate'),120),Convert(Date ,PR.CreateDate,120)))   and CaseDisposition !='Pending'   order by casenumber asc  END    
CREATE procedure [provider].[GetAllLocationsForAdmin] as begin select distinct LocationId,Businessname,Address1,City,State,Zip,IsActive from [provider].[Locations] where IsActive=1 end
CREATE procedure [provider].[GetAllUserForAdmin]  as  begin    select a.*,(select UserGroupName from [auth].[UserGroups] where Usergroupid = (select top 1 Usergroupid from [auth].[UserProfileGroups] where UserProfileId=a.UserProfileId)) as UserGroupName   from (select distinct UP.UserProfileId,UP.UserName,UP.ProviderCode,UP.CreateDate,isnull(UP.ModifyDate,UP.CreateDate) ModifyDate,UP.FirstName,UP.LastName,UP.IsActive,UP.IsRegister,UP.TemproryKeyCode,UP.PrimaryPhoneNumber as PhoneNumber   --,UG.UserGroupName   ,case    when (select count(*) from [provider].[HCPProviderProfile] where Userprofileid=UP.Userprofileid and IsActive=1)>0 then 'Yes'    else 'No'   end as IsHCP    from [provider].[ProviderUsers] as PU   join [auth].[UserProfiles] as UP on UP.Userprofileid=PU.Userprofileid   join [auth].[UserProfileGroups] as UPG on UPG.Userprofileid=PU.Userprofileid   join [auth].[UserGroups] as UG on UG.Usergroupid=UPG.Usergroupid   where PU.isActive=1 and UP.isActive=1 and UPG.IsActive=1 and UG.IsActive=1)a    order by a.ModifyDate desc    end
CREATE PROCEDURE [provider].[GetProviderStatisticsData]  (         @ProviderId bigInt    ,@LocationId bigInt    )  AS  BEGIN  DECLARE @providerCode VARCHAR(50);  SET @providerCode = (SELECT PROVIDERCODE FROM [provider].[ProviderProfiles] WHERE PROVIDERID = @ProviderId)  print @providerCode  IF(@providerCode='180000')  BEGIN      -- SET NOCOUNT ON added to prevent extra result sets from      -- interfering with SELECT statements.      SET NOCOUNT ON  SELECT CAST(ROW_NUMBER() OVER(ORDER BY Y.TotalUnitsSold ASC)AS INT) AS RowId,x.*, y.*   FROM (select  COUNT(*) AS FutureAppointments         ,ISNULL((CAST(SUM(CASE WHEN APT.AppointmentTypeName='Testing' THEN 1 ELSE 0 END)AS INT)),0) AS FutureTestAppointments           ,ISNULL((select count(*)         from [provider].[MemberAppointments] app         JOIN [provider].[MemberChartData] Mc on Mc.MemberChartDataId=app.MemberChartDataId         JOIN [provider].[AppointmentTypes] APT  on APT.[AppointmentTypeId]=app.[AppointmentTypeId]         where app.isactive=1 and Mc.isactive=1 and [EndTime] < getdate() and (MONTH(startTime) = MONTH(getdate()) and year(startTime) = year(getdate()))),0) AS MembersTestedByMonth         from [provider].[MemberAppointments] app         JOIN [provider].[MemberChartData] Mc on Mc.MemberChartDataId=app.MemberChartDataId         JOIN [provider].[AppointmentTypes] APT  on APT.[AppointmentTypeId]=app.[AppointmentTypeId]where app.isactive=1 and Mc.isactive=1           and Mc.LocationId =@LocationId         and startTime >= getdate()) as x,   (      SELECT TOP 1 COUNT(*) AS TotalUnitsSold                       ,ISNULL((SUM(CASE WHEN technologyLevel='Entry' THEN 1 ELSE 0 END)), 0) AS  'Entry'                        ,ISNULL((SUM(CASE WHEN technologyLevel='Basic' THEN 1 ELSE 0 END)), 0) AS  'Basic'                       ,ISNULL((SUM(CASE WHEN technologyLevel='Prime' THEN 1 ELSE 0 END)), 0) AS  'Prime'                       ,ISNULL((SUM(CASE WHEN technologyLevel='Advanced' THEN 1 ELSE 0 END)), 0) AS  'Advanced'                       ,ISNULL((SUM(CASE WHEN technologyLevel='Premium' THEN 1 ELSE 0 END)), 0) AS  'Premium'                       ,ISNULL((SUM(CASE WHEN technologyLevel='Superior' THEN 1 ELSE 0 END)), 0) AS  'Superior'                       FROM(                             select                                      ot.OrderItemId                                    ,cp.FamilyProductCatCode technologyLevel                             from [Orders].[OrderItems] ot                             left outer join Orders.Orders o ON ot.OrderId = o.OrderId                             left outer join Insurance.HealthPlanContracts hpc on                                      1=1                                    and hpc.InsuranceHealthPlanId = JSON_VALUE(o.MemberData, '$.insPlanId')                             left outer join [Insurance].[ContractProducts] cp on                                    1=1                                    and cp.ItemCode = ot.ItemCode                                    and cp.HealthPlanContractId = hpc.HealthPlanContractId                             where ot.isactive=1 and ot.status='Active' and ISJSON(o.MemberData) > 0                             and itemType in ('HA','CROS')                       ) S                ) as y  END  ELSE   BEGIN    SELECT CAST(ROW_NUMBER() OVER(ORDER BY Y.TotalUnitsSold ASC)AS INT) AS RowId,x.*, y.*   FROM (select  COUNT(*) AS FutureAppointments         ,ISNULL((CAST(SUM(CASE WHEN APT.AppointmentTypeName='Testing' THEN 1 ELSE 0 END)AS INT)), 0) AS FutureTestAppointments           ,ISNULL((CAST(SUM(CASE WHEN ([EndTime] < getdate() and MONTH(startTime) = MONTH(getdate()) and year(startTime) = year(getdate())) THEN 1 ELSE 0 END)AS INT)), 0) AS MembersTestedByMonth                  from [provider].[MemberAppointments] app         JOIN [provider].[MemberChartData] Mc on Mc.MemberChartDataId=app.MemberChartDataId         JOIN [provider].[AppointmentTypes] APT  on APT.[AppointmentTypeId]=app.[AppointmentTypeId]where a
CREATE procedure [provider].[GetProviderUserPermissions](   @providerId [bigint] = 0,   @userProfileId [bigint] = 0  )  as  begin   select    af.[AppFeatureId]    ,af.IsSystemFeature    ,af.IsDefault        ,af.[ParentFeatureId]        ,af.[FeatureName]        ,af.[FeatureCode]        ,(case     when pf.[ProviderFeatureId] > 0 then null     when af.IsSystemFeature = 1 then null else cast((case when (puf.[IsCreate] is null or puf.[IsCreate] = 1) then af.[IsCreate] else 0 end) as bit)    end) as 'IsCreate'    ,(case when af.IsSystemFeature = 1 then null else af.[IsCreate] end) as 'IsCreateDefault'        ,(case     when pf.[ProviderFeatureId] > 0 then null     when af.IsSystemFeature = 1 then null else cast((case when (puf.[IsRead] is null or puf.[IsRead] = 1) then af.[IsRead] else 0 end) as bit)    end) as 'IsRead'    ,(case when af.IsSystemFeature = 1 then null else af.[IsRead] end) as 'IsReadDefault'        ,(case     when pf.[ProviderFeatureId] > 0 then null     when af.IsSystemFeature = 1 then null else cast((case when (puf.[IsUpdate] is null or puf.[IsUpdate] = 1) then af.[IsUpdate] else 0 end) as bit)    end) as 'IsUpdate'    ,(case when af.IsSystemFeature = 1 then null else af.[IsUpdate] end) as 'IsUpdateDefault'        ,(case     when pf.[ProviderFeatureId] > 0 then null     when af.IsSystemFeature = 1 then null else cast((case when (puf.[IsDelete] is null or puf.[IsDelete] = 1) then af.[IsDelete] else 0 end) as bit)    end) as 'IsCancel'    ,(case when af.IsSystemFeature = 1 then null else af.[IsDelete] end) as 'IsCancelDefault'   from [auth].[ApplicationFeatures] af   left join [auth].[ProviderFeatures] pf   on af.[FeatureCode] = pf.[AppFeatureCode] and pf.[ProviderId] = @providerId and (pf.[IsActive] = 1 or pf.[IsActive] is null)   left join [auth].[ProviderUserFeatures] puf   on af.[FeatureCode]=puf.[AppFeatureCode] and puf.[ProviderId] = @providerId and puf.[UserProfileId] = @userProfileId and (puf.[IsActive] = 1 or puf.[IsActive] is null)   where --af.[IsDefault]=1 and    af.[IsActive] = 1 and (pf.[IsActive] = 1 or pf.[IsActive] is null) and (puf.[IsActive] = 1 or puf.[IsActive] is null) and af.[isDefault] = 1  end  
    CREATE proc [provider].[OTCMemberOrders1] --'OTC201901912885'  @NHMemberId varchar(20)  as   begin    select distinct [OrderID],[OrderType],[DateOrderReceived],o.[CreateDate],[DateOrderInitiated],  (case [OrderStatusCode]   when 'INI' then 'Submitted'   when 'ACK' then 'Confirmed'   when 'SHI' then 'Shipped' end) as OrderStatusCode  ,convert(decimal,[Amount]) as TotalAmount  ,convert(decimal,Json_value([OrderAmountData],'$.amountCovered')) as BenefitApplied  ,convert(decimal,([Amount]-convert(decimal,Json_value([OrderAmountData],'$.amountCovered')))) as MemberResponsibilty,  [OrderAmountData],[ShippingData],o.[NHMemberId],[MemberData],convert(bigint,[MemberChartDataId]) as MemberChartDataId  ,[Status],me.[EmailAddress] as MemberEmailId   from orders.orders o   left join [provider].[MemberProfiles] mp on mp.[NHMemberId]=o.[NHMemberId] and mp.[IsActive]=1   left join [provider].[MemberEmails] me on me.[MemberProfileId]=mp.[MemberProfileId] and me.Isactive=1   where o.[NHMemberId]= @NHMemberId and [OrderType]='OTC'    and o.[IsActive]=1       order by orderid desc  end  
CREATE Procedure [provider].[GetMemberOrderDetails]   @nhMemberId [nvarchar](50)  AS  BEGIN  SET NOCOUNT ON        SELECT  distinct o.[OrderID]          ,isnull([BrandCode],'') as [BrandCode]          ,[MemberChartDataId]          ,NhMemberID      ,o.CreateDate AS OrderDate          ,Convert(varchar(20)          ,(SELECT OrderStatusName FROM Orders.OrderStatusTypes WHERE OrderStatusCode = o.OrderStatusCode)) AS OrderStatusName          ,[FamilyCode]          ,[TechnologyLevelCode]          ,ModelCode          ,[OrderType]    ,BenefitsData          ,CONVERT(date,[DateOrderReceived]) DateOrderReceived          ,case when o.OrderStatusCode in('CAN','RET') then (select count(*) from orders.orderITems where orderid = o.orderid and itemtype <> 'EM' and isActive = 1)else (select count(*) from orders.orderITems where orderid = o.orderid and itemtype <> 'EM' and [Status] = 'ACTIVE' and isActive = 1) end as [DeviceCount]          ,case when o.OrderStatusCode in('CAN','RET') then (select STRING_AGG(Modifier, '& ') from orders.orderITems where orderid = o.orderid and itemtype <> 'EM' and isActive = 1) else (select STRING_AGG(Modifier, '& ') from orders.orderITems where orderid = o.orderid and itemtype <> 'EM' and [Status] = 'ACTIVE' and isActive = 1) end as [Modifiers]    ,Convert(varchar(20),cast(ISNULL(JSON_VALUE(OrderAmountData,'$."productPrice"'),0) as decimal(10,2))) as ProductPrice          ,Convert(varchar(20),cast(ISNULL(JSON_VALUE(OrderAmountData,'$."insuranceBenefit"'),0) as decimal(10,2))) as BenefitPrice          ,Convert(varchar(20),(case when BenefitsData is not null then (cast(ISNULL(JSON_VALUE(BenefitsData,'$."benefitAppliedAmount"'),0)as decimal(18,2))) else (case when (cast(JSON_VALUE(OrderAmountData,'$."productPrice"') as decimal(10,2))) <= ((cast(JSON_VALUE(OrderAmountData,'$."insuranceBenefit"')as decimal(10,2))-(cast(JSON_VALUE(o.OrderAmountData,'$.benefitUsed')as decimal(10,2)))))          then cast(ISNULL(JSON_VALUE(OrderAmountData,'$."productPrice"'),0) as decimal(10,2)) else ((cast(ISNULL(JSON_VALUE(OrderAmountData,'$."insuranceBenefit"'),0)as decimal(18,2))-(cast(ISNULL(JSON_VALUE(o.OrderAmountData,'$.benefitUsed'),0)as decimal(18,2)))))  end) end)) BenefitApplied       ,CASE      WHEN JSON_VALUE(OrderAmountData,'$."medicaidBenefit"') IS NULL THEN NULL      ELSE      Convert(varchar(20),cast(JSON_VALUE(OrderAmountData,'$."medicaidBenefit"') as decimal(10,2)))     END AS MedicaidBenefit          ,Convert(varchar(20),(case when (cast(JSON_VALUE(OrderAmountData,'$."insuranceBenefit"')as decimal(10,2))-(cast(JSON_VALUE(o.OrderAmountData,'$.benefitUsed')as decimal(10,2))))=cast(JSON_VALUE(OrderAmountData,'$."productPrice"') as decimal(10,2))          then ( case when (cast(JSON_VALUE(o.OrderAmountData,'$.benefitUsed')as decimal(10,2)))=0 then cast(JSON_VALUE(o.OrderAmountData,'$.productPrice')as decimal(10,2))-(cast(JSON_VALUE(OrderAmountData,'$."insuranceBenefit"')as decimal(10,2))-cast(JSON_VALUE(OrderAmountData,'$."benefitUsed"')as decimal(10,2))) else 0 end)          else (case when (cast(JSON_VALUE(OrderAmountData,'$."insuranceBenefit"')as decimal(10,2))-cast(JSON_VALUE(OrderAmountData,'$."benefitUsed"')as decimal(10,2)))> cast(JSON_VALUE(OrderAmountData,'$."productPrice"')as decimal(10,2))          then (cast(JSON_VALUE(OrderAmountData,'$."insuranceBenefit"')as decimal(10,2))-cast(JSON_VALUE(OrderAmountData,'$."benefitUsed"')as decimal(10,2)))-cast(JSON_VALUE(OrderAmountData,'$."productPrice"')as decimal(10,2))else 0 end)end)) RemainingBenefit     ,Convert(varchar(20),cast(ISNULL(JSON_VALUE(OrderAmountData,'$."benefitAvailable"'),0) as decimal(10,2))) as AvailableBenefitPrice          ,Convert(varchar(20),isnull(cast(JSON_VALUE(ISNULL(LTRIM(RTRIM(OrderAmountData)), 0),'$."adjustments"') as decimal(10,2)),0)) as AdjustedPrice          ,Convert(varchar(20),cast(JSON_VALUE(o.OrderAmountData,'$.memberResponsibility') as decimal(10,2))) as MemberPrice                   ,Isnull(Convert(varchar(20),(select isnull(sum(
  CREATE PROCEDURE [provider].SyncAccounts  (      -- Add the parameters for the stored procedure here   @primaryNHMemberId varchar(30),   @secondaryNHMemberId varchar(30) = NULL  )  AS  BEGIN  BEGIN TRY      -- SET NOCOUNT ON added to prevent extra result sets from      -- interfering with SELECT statements.      SET NOCOUNT ON     DECLARE @user varchar(100) = 'NHAdmin'     DECLARE @SyncMasterToProvider BIT = CASE WHEN @primaryNHMemberId = @secondaryNHMemberId OR @secondaryNHMemberID is null THEN 1 ELSE 0 END   DECLARE @secondaryMemberProfileId bigint   DECLARE @secondaryMasterMemberId bigint   DECLARE @primaryMemberProfileId bigint   DECLARE @primaryMasterMemberId bigint     IF (@SyncMasterToProvider = 0)   BEGIN    SET @secondaryMasterMemberId = (SELECT MemberID FROM Master.Members where NhMemberId = @secondaryNHMemberId)    SET @secondaryMemberProfileId = (SELECT MemberProfileId FROM Provider.MemberProfiles where NhMemberId = @secondaryNHMemberId)   END      SET @primaryMasterMemberId = (SELECT MemberID FROM Master.Members where NhMemberId = @primaryNHMemberId)   SET @primaryMemberProfileId = (SELECT MemberProfileId FROM Provider.MemberProfiles where NhMemberId = @primaryNHMemberId)     IF (@SyncMasterToProvider = 1)   BEGIN    INSERT INTO Provider.MemberInsurances    SELECT     MI.CreateDate,      MI.CreateUser,      MI.InsuranceCarrierId,      MI.InsuranceEffectiveDate,      MI.InsuranceEndDate,      MI.InsuranceHealthPlanId,      MI.InsuranceType,      MI.IsActive,      @primaryMemberProfileId,      MI.ModifyDate,      MI.ModifyUser,      0, 0, NULL, NULL    FROM Master.MemberInsurances MI    LEFT OUTER JOIN Provider.MemberInsurances MI2 ON 1=1     AND MI2.MemberProfileId = @primaryMemberProfileId     AND       CONCAT(MI.InsuranceCarrierId, CAST(MI.InsuranceEffectiveDate as DATE), MI.InsuranceHealthPlanId, MI.IsActive)       = CONCAT(MI2.InsuranceCarrierId, CAST(MI2.InsuranceEffectiveDate as DATE),MI2.InsuranceHealthPlanId, MI2.IsActive)    WHERE MI.MemberID = @primaryMasterMemberId     AND MI2.IsActive IS NULL   END     ELSE   BEGIN    /**************************************    **  Copy secondary data    ***************************************/      update [Master].[MemberInsurances]    set ModifyDate = GETDATE(), ModifyUser = @user, MemberID = @primaryMasterMemberId    where MemberID = @secondaryMasterMemberId      update [Master].[MemberInsuranceDetails]    set ModifyDate = GETDATE(), ModifyUser = @user    where MemberInsuranceID in (     select MemberInsuranceID      from [Master].[MemberInsurances]     where MemberID = @secondaryMasterMemberId    )      update [Master].[MemberInsurances_History]    set ModifyDate = GETDATE(), ModifyUser = @user, MemberID = @primaryMasterMemberId    where MemberID = @secondaryMasterMemberId      update Orders.Orders    set NHMemberId = @primaryNHMemberId    where NHMemberId = @secondaryNHMemberId      update otc.Cards    set NhMemberId = @primaryNHMemberId    where NHMemberID = @secondaryNHMemberId      update provider.membercharts    set MemberProfileId = @primaryMemberProfileId, ModifyDate = GETDATE(), ModifyUser = @user    where MemberProfileId = @secondaryMemberProfileId      update provider.memberinsurances    set MemberProfileId = @primaryMemberProfileId, ModifyDate = GETDATE(), ModifyUser = @user    where MemberProfileId = @secondaryMemberProfileId      update provider.MemberInsuranceDetails    set ModifyDate = GETDATE(), ModifyUser = @user    where MemberInsuranceId in (     select MemberInsuranceId     from provider.MemberInsurances     where MemberProfileId = @secondaryMemberProfileId    )      --update provider.memberinsurances_history    --set MemberProfileId = @primaryMemberProfileId, ModifyDate = GETDATE(), ModifyUser = @user    --where MemberProfileId = @secondaryMemberProfileId      update callcenter.callconversations    set ModifyDate = GETDATE(), membernhmemberid = @primaryNHMemberId, ModifyUser = @user    where membernhmemberid = @secondaryNHMemberId      update p
CREATE PROCEDURE [provider].[GetPreServiceAuthRequestHistoryUpdtes] --'NH201901912884'   (        -- Add the parameters for the stored procedure here       @nhMemberId Varchar(50)    )    AS    BEGIN        -- SET NOCOUNT ON added to prevent extra result sets from        -- interfering with SELECT statements.        SET NOCOUNT ON            -- Insert statements for procedure here          select         cast((select count(*) from [provider].[PreServiceAuthRequests] where NhMemberid=@nhMemberId)+ROW_NUMBER() OVER(ORDER BY ModifyUser) as int)  AS RowID      ,cast(CaseNumber as bigint) as CaseNumber    ,JSON_VALUE(PreServiceAuthRequestDetails, '$.requestSource') 'RequestSource'      ,JSON_VALUE(PreServiceAuthRequestDetails, '$.requestedBy') 'RequestedBy'      ,cast(JSON_VALUE(PreServiceAuthRequestDetails, '$.requestReceivedDate') as DateTime) 'RequestDate'      ,JSON_VALUE(PreServiceAuthRequestDetails, '$.caseDisposition') 'CaseDisposition'      ,cast(JSON_VALUE(PreServiceAuthRequestDetails, '$.finalDecisionDateTime') as DateTime)'CaseDispositionDateTime'      ,cast(JSON_VALUE(PreServiceAuthRequestTimeliness, '$.hearingTestDate') as DateTime)  as 'HearingTestDate'      ,ModifyUser as 'LastUpdatedBy'      ,ModifyDate as 'LastUpdatedOn',IsApproved    from [provider].[PreServiceAuthRequestHistory] where NhMemberid= @nhMemberId and isactive=1   order by  [PreServiceAuthQueueHistoryId] desc  END     
CREATE PROCEDURE [provider].[GetInsuranceDetails]   (      -- Add the parameters for the stored procedure here   @nhmemberid varchar(50),   @insCarrierId bigint,   @planId bigint  )  AS  BEGIN      -- SET NOCOUNT ON added to prevent extra result sets from      -- interfering with SELECT statements.      SET NOCOUNT ON      select     Convert(int,ROW_NUMBER() OVER(ORDER BY Ins.InsuranceCarrierID ASC)) AS RowId    ,Ins.InsuranceCarrierID    ,C.[InsuranceCarrierName] as InsuranceCarrierName    ,HealthPlanName as PlanName    ,GroupNbr as PlanGroup    ,InsuranceNbr  as InsurancePlan    ,InsurerInsuranceNbr as MemberId    ,ClaimAddress1 as InsuranceClaimAddress1    ,ClaimAddress2 as InsuranceClaimAddress2    ,ClaimCity as  InsuranceClaimCity    ,ClaimState as InsuranceClaimState    ,ClaimZip as InsuranceClaimZip    from [provider].[MemberInsurances] Ins    left Join [provider].[MemberProfiles] Mp on Mp.[MemberProfileId]=Ins.[MemberProfileId]     left join [provider].[MemberInsuranceDetails] Mi on Mi.MemberInsuranceID=Ins. MemberInsuranceID    left join [Insurance].[InsuranceHealthPlans] hp on hp.InsuranceCarrierID=ins.InsuranceCarrierID     left Join [Insurance].[InsuranceCarriers] c On c.InsuranceCarrierID=Ins.InsuranceCarrierID    where   Mp.Nhmemberid=@nhmemberid and  Ins.InsuranceCarrierID=@insCarrierId and hp.InsuranceHealthPlanID=@planId  END  
CREATE Procedure [provider].[GetMemberOrderDetails1]   @nhMemberId [nvarchar](50)    AS  BEGIN      SET NOCOUNT ON                 SELECT  distinct o.[OrderID]      ,o.[BrandCode]              ,[MemberChartDataId]              ,NhMemberID                             ,o.CreateDate as OrderDate              ,os.OrderStatusName     ,ot.OrderStatusCode                ,[FamilyCode]              ,[TechnologyLevelCode]     ,ModelCode              ,[DeviceCount]                  ,JSON_VALUE(OrderAmountData,'$."productPrice"') as ProductPrice                  ,JSON_VALUE(OrderAmountData,'$."insuranceBenefit"') as BenefitPrice                       ,JSON_VALUE(OrderAmountData,'$."benefitAvailable"') as AvailableBenefitPrice                  ,Convert(varchar(20),isnull(cast(JSON_VALUE(ISNULL(LTRIM(RTRIM(OrderAmountData)), 0),'$."adjustments"') as int),0)) as AdjustedPrice                  ,Convert(varchar(20),[OrderAmount]) as MemberPrice                        -- ,sum(cast(JSON_VALUE(ISNULL(ot.OrderTransactionData,0),'$.totalAmount')as int)) as AmountPaid--- $500        ,Convert(varchar(20),(select isnull(sum(cast(JSON_VALUE(ISNULL(OrderTransactionData,0),'$.totalAmount')as int)),0) from Orders.OrderTransactionDetails where OrderId = o.OrderId Group by OrderId)) as AmountPaid                  ,Convert(varchar(20),([OrderAmount]-(select isnull(sum(cast(JSON_VALUE(ISNULL(OrderTransactionData,0),'$.totalAmount')as int)),0) from Orders.OrderTransactionDetails where OrderId = o.OrderId Group by OrderId))) as BalanceDue --$0                  ,isnull(JSON_VALUE(o.OrderAmountData,'$.benefitUsed'),0) as BenefitUsed                  ,JSON_VALUE(ProviderData,'$."providerLeagalBusinessName"') as ProviderName        ,cast(JSON_VALUE(ProviderData,'$."providerId"') as bigint) as ProviderId       ,cast(JSON_VALUE(ProviderData,'$.address."locationId"') as bigint) as locationId        ,cast(JSON_VALUE(o.MemberData,'$."insCarrierId"') as bigint) as InsuranceCarrierId        ,cast(JSON_VALUE(o.MemberData,'$."insPlanId"') as bigint) as HealthPlanId                      from [Orders].[Orders] o                      join Orders.OrderStatusTypes os on o.OrderStatusCode = os.OrderStatusCode                        join Orders.OrderTransactionDetails ot on ot.OrderID=o.OrderID and ot.OrderStatusCode=o.OrderStatusCode                      where (ISJSON(o.MemberData) > 0) and (ISJSON(o.OrderAmountData) > 0) and (ISJSON(o.ProviderData) > 0) and (ISJSON(ot.OrderTransactionData) > 0)            and        NhMemberID = 'NH201700007735'                 group by  o.[OrderID],o.[BrandCode],[MemberChartDataId],NhMemberID,o.CreateDate,os.OrderStatusName,ot.OrderStatusCode,[FamilyCode],[TechnologyLevelCode],ModelCode,       [DeviceCount],OrderAmountData,[OrderAmount],ProviderData,o.MemberData,ot.OrderTransactionData                  order by o.CreateDate desc    END       
CREATE PROCEDURE [provider].[GetAllProviders](@ProviderName Nvarchar(100))  AS  BEGIN      -- SET NOCOUNT ON added to prevent extra result sets from      -- interfering with SELECT statements.      SET NOCOUNT ON      -- Insert statements for procedure here      If( @ProviderName is null or @ProviderName='')    Begin     SELECT distinct ProviderName from [provider].[ProviderProfiles]    End   Else    Begin     SELECT distinct ProviderName from [provider].[ProviderProfiles]  where ProviderName like @ProviderName + '%'    End  END  
CREATE PROCEDURE [provider].[GetPreServiceAuthRequestHistory]    (        -- Add the parameters for the stored procedure here       @nhMemberId Varchar(50)    )    AS    BEGIN        -- SET NOCOUNT ON added to prevent extra result sets from        -- interfering with SELECT statements.        SET NOCOUNT ON            -- Insert statements for procedure here          select     cast(ROW_NUMBER() OVER(ORDER BY CaseNumber) as int)  AS RowID      ,cast(CaseNumber as bigint) as CaseNumber     ,JSON_VALUE(PreServiceAuthRequestDetails, '$.requestSource') 'RequestSource'      ,JSON_VALUE(PreServiceAuthRequestDetails, '$.requestedBy') 'RequestedBy'      ,cast(JSON_VALUE(PreServiceAuthRequestDetails, '$.requestReceivedDate') as DateTime) 'RequestDate'      ,JSON_VALUE(PreServiceAuthRequestDetails, '$.caseDisposition') 'CaseDisposition'      ,cast(JSON_VALUE(PreServiceAuthRequestDetails, '$.finalDecisionDateTime') as DateTime)'CaseDispositionDateTime'      ,cast(JSON_VALUE(PreServiceAuthRequestTimeliness, '$.hearingTestDate') as DateTime)  as 'HearingTestDate'      ,ModifyUser as 'LastUpdatedBy'      ,ModifyDate as 'LastUpdatedOn',IsApproved          from [provider].[PreServiceAuthRequests] where NhMemberid= @nhMemberId  and isactive=1  END     
              -- =============================================  -- Author:      Mohan Nanduri  -- Create Date: 06/28/202019  -- Description: This procedure Used to get Call Center OTC Order Grid Data   -- =============================================  --  -- 12/01/2020 Tarun  This change is for procedure that fetches members order grid data, returning extra properties required to launch OTC portal through SSO.  --  -- EXEC [provider].[OTCMemberOrders] 'NH202002474804'            CREATE PROC [provider].[OTCMemberOrders] @NHMemberId VARCHAR(20)  AS  BEGIN   DECLARE @otcCarrierId BIGINT = (     SELECT TOP 1 InsuranceCarrierID     FROM Insurance.InsuranceCarriers     WHERE IsActive = 1      AND JSON_VALUE(CarrierConfig, '$.subdomain') = 'otcnetwork'     )   DECLARE @otcPlanId BIGINT = (     SELECT TOP 1 InsuranceHealthPlanID     FROM Insurance.InsuranceHealthPlans     WHERE IsActive = 1      AND InsuranceCarrierID = @otcCarrierId      AND PlanConfigData IS NULL     )     SELECT DISTINCT [OrderID]    ,[OrderType]    ,[DateOrderReceived]    ,o.[CreateDate]    ,[DateOrderInitiated]    ,(     CASE [OrderStatusCode]      WHEN 'INI'       THEN 'Submitted'      WHEN 'ACK'       THEN 'Confirmed'      WHEN 'CAN'       THEN 'Cancelled'      WHEN 'SHI'       THEN 'Shipped'      END     ) AS OrderStatusCode    ,convert(DECIMAL(10, 2), [Amount]) AS TotalAmount    ,convert(DECIMAL(10, 2), Json_value([OrderAmountData], '$.amountCovered')) AS BenefitApplied    ,convert(DECIMAL(10, 2), ([Amount] - convert(DECIMAL(10, 2), Json_value([OrderAmountData], '$.amountCovered')))) AS MemberResponsibilty    ,[OrderAmountData]    ,[ShippingData]    ,o.[NHMemberId]    ,[MemberData]    ,convert(BIGINT, [MemberChartDataId]) AS MemberChartDataId    ,[Status]    ,me1.[EmailAddress] AS MemberEmailId    ,(     SELECT insuranceCarrierName     FROM insurance.InsuranceCarriers     WHERE InsuranceCarrierId = json_value(o.MemberData, '$.insCarrierId')     ) AS BenefitType    ,(     SELECT TOP 1 JSON_VALUE(CarrierConfig, '$.subdomain')     FROM Insurance.InsuranceCarriers     WHERE InsuranceCarrierID = json_value(o.MemberData, '$.insCarrierId')     ) AS SubDomain    ,InsD.InsuranceNbr    ,InsD.OTCCardNumber    ,isnull(Ins.InsuranceCarrierID, 0) InsuranceCarrierID    ,isnull(Ins.InsuranceHealthPlanID, 0) InsuranceHealthPlanID   FROM orders.orders o   LEFT JOIN [provider].[MemberProfiles] mp ON mp.[NHMemberId] = o.[NHMemberId]    AND mp.[IsActive] = 1   LEFT JOIN provider.memberemails me1 ON me1.[MemberProfileId] = mp.[MemberProfileId]   LEFT JOIN provider.memberemails me2 ON me2.[MemberProfileId] = mp.[MemberProfileId]    AND me1.MemberEmailId < me2.MemberEmailId   INNER JOIN Master.Members M ON M.NHMemberID = Mp.NHMemberId   LEFT JOIN master.MemberInsurances Ins ON M.MemberID = ins.MemberID    AND Ins.InsuranceCarrierID = cast(Isnull(json_value(o.MemberData, '$.insCarrierId'), @otcCarrierId) AS BIGINT)    AND Ins.InsuranceHealthPlanID = cast(Isnull(Json_Value(o.MemberData, '$.insPlanId'), @otcPlanId) AS BIGINT)    AND (     Cast(o.CreateDate AS DATE) BETWEEN Cast(Ins.InsuranceEffectiveDate AS DATE)      AND Cast(Ins.InsuranceEndDate AS DATE)     )    AND Ins.IsActive = 1   LEFT JOIN master.memberinsuranceDetails InsD ON InsD.MemberInsuranceId = Ins.Id    AND InsD.IsActive = 1   WHERE o.[NHMemberId] = @NHMemberId    AND [OrderType] = 'OTC'    AND me2.IsActive IS NULL    AND o.[IsActive] = 1   ORDER BY orderid DESC  END  
  CREATE PROCEDURE [provider].[GetPriorAuthRequestHistoryUpdtes] --'NH201901912884'     (          -- Add the parameters for the stored procedure here         @nhMemberId Varchar(50)      )      AS      BEGIN          -- SET NOCOUNT ON added to prevent extra result sets from          -- interfering with SELECT statements.          SET NOCOUNT ON                -- Insert statements for procedure here            select           cast((select count(*) from [provider].[PriorAuthRequests] where NhMemberid=@nhMemberId)+ROW_NUMBER() OVER(ORDER BY ModifyUser) as int)  AS RowID        ,cast(CaseNumber as bigint) as CaseNumber      ,JSON_VALUE(PriorAuthRequestData, '$.requestSource') 'RequestSource'        ,JSON_VALUE(PriorAuthRequestData, '$.requestedBy') 'RequestedBy'        ,cast(JSON_VALUE(PriorAuthRequestData, '$.requestReceivedDate') as DateTime) 'RequestDate'        ,JSON_VALUE(PriorAuthRequestData, '$.caseDisposition') 'CaseDisposition'        ,cast(JSON_VALUE(PriorAuthRequestData, '$.finalDecisionDateTime') as DateTime)'CaseDispositionDateTime'        ,cast(JSON_VALUE(PriorAuthRequestTimelinessData, '$.hearingTestDate') as DateTime)  as 'HearingTestDate'        ,ModifyUser as 'LastUpdatedBy'        ,ModifyDate as 'LastUpdatedOn',IsApproved      from [provider].[PriorAuthRequestHistory] where NhMemberid= @nhMemberId and isactive=1     order by  [PriorServiceAuthQueueHistoryId] desc    END       
CREATE PROCEDURE [provider].[GetPriorAuthRequestHistory]      (          -- Add the parameters for the stored procedure here         @nhMemberId Varchar(50)      )      AS      BEGIN          -- SET NOCOUNT ON added to prevent extra result sets from          -- interfering with SELECT statements.          SET NOCOUNT ON                -- Insert statements for procedure here            select       cast(ROW_NUMBER() OVER(ORDER BY CaseNumber) as int)  AS RowID        ,cast(CaseNumber as bigint) as CaseNumber       ,JSON_VALUE(PriorAuthRequestData, '$.requestSource') 'RequestSource'        ,JSON_VALUE(PriorAuthRequestData, '$.requestedBy') 'RequestedBy'        ,cast(JSON_VALUE(PriorAuthRequestData, '$.requestReceivedDate') as DateTime) 'RequestDate'        ,JSON_VALUE(PriorAuthRequestData, '$.caseDisposition') 'CaseDisposition'        ,cast(JSON_VALUE(PriorAuthRequestData, '$.finalDecisionDateTime') as DateTime)'CaseDispositionDateTime'        ,cast(JSON_VALUE(PriorAuthRequestTimelinessData, '$.hearingTestDate') as DateTime)  as 'HearingTestDate'        ,ModifyUser as 'LastUpdatedBy'        ,ModifyDate as 'LastUpdatedOn',IsApproved              from [provider].[PriorAuthRequests] where NhMemberid= @nhMemberId  and isactive=1    END 
CREATE PROCEDURE [provider].[GetIVPendingRecords]  AS  BEGIN      SELECT   q.[IVQueueId] as IVQueueId,   q.[NHMemberId] as NHMemberId,   q.[CreateDate] as RequestDate,   q.[InitiatedBy] as InitiatedBy,   icarr.[InsuranceCarrierName] as InsuranceCarrier,   hplan.[HealthPlanName] as InsurancePlan,   concat(p.[FirstName], ' ', p.[LastName]) as MemberName   from [provider].[IVQueue] q   inner join [provider].[MemberProfiles] p on p.[NHMemberId] = q.[NHMemberId]   inner join [Insurance].[InsuranceCarriers] icarr on icarr.[InsuranceCarrierID] = q.[InsuranceCarrierID]   inner join [Insurance].[InsuranceHealthPlans] hplan on hplan.[InsuranceHealthPlanID] = q.[InsuranceHealthPlanID]   inner join provider.MemberInsuranceDetails d on d.MemberInsuranceId = q.memberinsuranceId and d.IVQStatus not in ('Approved', 'Denied')   where q.Isprocessed = 0 and p.IsActive = 1 and icarr.IsActive = 1 and hplan.IsActive = 1   order by q.[IVQueueId] desc  END    
  --exec Provider.GetProvidersLocationsForMap    CREATE PROCEDURE [provider].[GetProvidersLocationsForMap]    AS    BEGIN          SET NOCOUNT ON       SELECT    --cast(row_number() over (order by PP.ProviderId desc) as bigint)  as ID,                isnull(PP.ProviderId,0) as providerid,          isnull(L.LocationId,0) as locationid,          PP.ProviderName as [name],          isnull(L.Brands, '') as brand,       REPLACE(CASE WHEN L.[Langauges] is null THEN 'English'       WHEN L.[Langauges] = '' THEN 'English'       WHEN L.[Langauges] = 'N/A' THEN 'English'       WHEN L.[Langauges] NOT LIKE '%English%' THEN CONCAT('English,',L.[Langauges])       ELSE L.[Langauges] END,',',', ') as Languages,        '' as designation,          L.Address1,          L.Address2,          L.City,          L.[State],          REPLACE(CONCAT_WS(' ', CONCAT_WS(', ',CONCAT_WS(', ', L.Address1,L.Address2),L.City,L.State),L.Zip),', , ',', ') AS [address],          isnull(L.zip,0) as zipCode,          cast(L.Latitude as nvarchar(100)) as latitude,          cast(L.Longitude as nvarchar(100)) as longitude,          --Hcp Count          (Select Count(*) from Provider.ProviderUserLocations PUL Where UserProfileId in (select UserProfileId from Auth.UserProfileGroups Where  IsActive = 1) and PUL.ProviderId = PP.ProviderId And PUL.LocationId = L.LocationId) as hcpcount,          --Medicaid Hcp Count          (Select Count(*) from Provider.ProviderUserLocations PUL Where UserProfileId in (select UserProfileId from Provider.HcpProviderProfile Where  IsActive = 1 and IsMedicaid = 1) and PUL.ProviderId = PP.ProviderId And PUL.LocationId = L.LocationId) as MedicaidHCPCount,          isnull(L.BusinessName,'') as businessname,          isnull(L.NPINumber,'') as npinumber,          isnull(PNP.PhoneNumber,'') as phonenumber,          isnull(PNF.PhoneNumber,'') as faxnumber,          isnull(L.IsMedicaid,0) as IsMedicaid,          isnull(L.IsMedicare,0) as IsMedicare,          L.IsActive             FROM    Provider.ProviderLocations PL        INNER JOIN  Provider.Locations L ON L.LocationId = PL.LocationId AND L.IsActive = 1       INNER JOIN  Provider.ProviderProfiles PP ON PL.ProviderId = PP.ProviderId AND PP.IsActive = 1       LEFT JOIN  Provider.LocationPhoneNumbers PNP ON PNP.LocationId = L.LocationId AND PNP.PhoneTypeId = 1 AND PNP.IsActive = 1 -- PNP is Phone       LEFT JOIN  Provider.LocationPhoneNumbers PNF ON PNF.LocationId = L.LocationId AND PNF.PhoneTypeId = 3 AND  PNF.IsActive = 1 -- PNF is Fax          WHERE   PL.IsActive = 1         END    
  CREATE Procedure [provider].[Get_ActiveMemberChart_BAKSEP11](  @MemberProfileId bigint,    @ProviderId bigint,  @MemberChartDataId bigint,  @AppointmentId bigint  )  AS  BEGIN    --DECLARE @MemberProfileId bigint --= 9961    -- 1. Get Active MemberChart of the Member    DECLARE @MemberChartId bigint = 0    SELECT @MemberChartId = (SELECT TOP 1 C.[MemberChartId] FROM [provider].[MemberCharts] C   INNER JOIN [provider].[MemberChartData] D ON C.[MemberChartId]=D.[MemberChartId]   INNER JOIN [provider].[MemberAppointments] A ON A.[MemberChartDataId]=D.[MemberChartDataId]   WHERE C.[MemberProfileId] = @MemberProfileId AND (@ProviderId=0 OR D.[ProviderId]=@ProviderId) AND (@MemberChartDataId=0 OR D.[MemberChartDataId]=@MemberChartDataId) AND (@AppointmentId=0 OR A.[MemberAppointmentId] = @AppointmentId) ORDER BY C.[MemberChartId] DESC)        SELECT *FROM [provider].[MemberCharts] WHERE [MemberChartId] = @MemberChartId    -- 2. If there is no record create new     -- SELECT 'STEP 1 RESULT',@MemberChartId   -- IF @MemberChartId IS NULL    -- Begin   --   -- Create new MemberChart    --INSERT INTO [provider].[MemberCharts]   --       ([MemberProfileId],[VisitNumber],[CreateUser],[CreateDate],[ModifyUser],[ModifyDate],IsActive,IsChartClosed)   --   VALUES   --       (@MemberProfileId,1,@UserName,GETDATE(),@UserName,GETDATE(),1,0)   --SET @MemberChartId = SCOPE_IDENTITY();   ----SELECT 'INSERTED NEW  1 RECORD ',@MemberChartId   -- End   -- -- 2a. Check if the existing member chart last transaction date is greter than 90 days   -- ELSE   -- Begin   --  DECLARE @LastTransactionDate DATETIME   --     SELECT @LastTransactionDate =  (SELECT TOP 1 [ModifyDate] FROM [provider].[MemberChartData]   --         WHERE [MemberChartId] = @MemberChartId AND [IsActive] = 1   --         ORDER BY [ModifyDate] DESC)   --  -- SELECT 'STEP 2A LAST TRANSACTION DATE  ',@LastTransactionDate     --     IF (@LastTransactionDate IS NOT NULL AND    --     @LastTransactionDate < GETDATE()- 90 )   --     Begin   --     --3a. Close Existing Chart     --  UPDATE [provider].[MemberCharts]   --         SET [IsChartClosed] = 1   --        WHERE [MemberProfileId] = @MemberProfileId AND    --     [MemberChartId] = @MemberChartId   --        --3b. Create new One   --  INSERT INTO [provider].[MemberCharts]   --      ([MemberProfileId],[VisitNumber],[CreateUser],[CreateDate],[ModifyUser],[ModifyDate],IsActive,IsChartClosed)   --  VALUES   --      (@MemberProfileId,1,@UserName,GETDATE(),@UserName,GETDATE(),1,0)   --  SET @MemberChartId = SCOPE_IDENTITY();      --  -- SELECT 'INSERTED NEW  1 RECORD ',@MemberChartId          --  End      -- End      END  
CREATE PROCEDURE [provider].[GetMemberShippingDetails] -- 'QA201800572294',6,26629  (      -- Add the parameters for the stored procedure here   @nhMemberId nvarchar(50),   @providerId bigint,   @engagementId bigint  )  AS  BEGIN      -- SET NOCOUNT ON added to prevent extra result sets from      -- interfering with SELECT statements.      SET NOCOUNT ON     SELECT  distinct         ROW_NUMBER() OVER(ORDER BY o.OrderID ASC) AS RowId       ,Me.MemberChartId as EngagementId    ,cast(o.DateOrderReceived as date) as OrderDate     ,o.[OrderID] as OrderId    ,NhMemberID              ,[OrderType]     ,isnull((select top 1 ItemTypeDescription from [Orders].[ItemTypes] It where It.itemTypeCode=OI.ItemType),OI.ItemType) as ItemType    ,Convert(varchar(30),(SELECT OrderStatusName FROM Orders.OrderStatusTypes WHERE OrderStatusCode = o.OrderStatusCode)) as OrderStatus    ,cast([PONumber] as varchar(50)) as PONumber    ,OI.OrderItems    ,(case t.ordertransactiondata when null then null else (select top 1 PODate from openjson(t.ordertransactiondata) with (PODate date '$.poDate')) end) as PODATE    ,BrandCode     ,cast(isnull(JSON_VALUE(ProviderData,'$."providerId"'),0) as bigint) as ProviderId          ,cast(isnull(JSON_VALUE(ProviderData,'$.address."locationId"'),0) as bigint) as locationId          ,cast(isnull(JSON_VALUE(o.MemberData,'$."insCarrierId"'),0) as bigint) as InsuranceCarrierId          ,cast(isnull(JSON_VALUE(o.MemberData,'$."insPlanId"'),0) as bigint) as HealthPlanId     ,cast(isnull(JSON_VALUE(ProviderData,'$.address."locationId"'),0) as bigint) as ProviderLocationId    ,o.[MemberChartDataId]    ,CAST (0 AS Bigint) as TrackingId    from [provider].[MemberCharts] Me    inner Join [provider].[MemberChartData] Mc On Mc.MemberChartId =Me.MemberChartId and Mc.[ProviderId]=@providerId    inner join  [Orders].[Orders] o on o.[MemberChartDataId] =Mc.MemberChartDataId     Inner join (select distinct OrderId,ItemType,PONumber,BrandCode,case when ItemType='HA' then STRING_AGG(OrderItemId, ', ') else STRING_AGG(OrderItemId, ', ')  end as OrderItems       from [Orders].[OrderItems] where Status='Active' and Isactive=1 group by OrderId,ItemType,ItemType,PONumber,BrandCode )OI  On o.OrderId=OI.OrderId     left join [Orders].[Ordertransactiondetails] t on t.orderid = o.orderid and t.orderstatuscode='PO' and t.isactive=1 and t.iscomplete=1    where (ISJSON(o.MemberData) > 0)  and (ISJSON(o.ProviderData) > 0)  and Me.MemberChartId =@engagementId    and O.OrderType In ('NEW','LSND','LSandD', 'EXCHANGE') and NhMemberID = @nhMemberId    and (select count(*) from Orders.OrderTransactionDetails t where t.OrderId = o.OrderId and t.orderstatuscode='APP'     and t.isactive=1 and t.iscomplete=1)>0  END
CREATE PROCEDURE [provider].[GetMemberAppointments]       @MemberProfileId [bigint]  AS  BEGIN      SET NOCOUNT ON        select ROW_NUMBER() OVER (ORDER BY ma.MemberAppointmentId) as 'RowID', m.MemberProfileId,ma.[MemberAppointmentId],t.[AppointmentTypeName] AppointmentType,   ma.[StartDate] AppointmentDate,ma.[StartTime] AppointmentTime,   CASE        WHEN l.TimeZone ='Mountain Standard Time' THEN 'MST'        WHEN l.TimeZone ='Hawaiian Standard Time' THEN 'HST'        WHEN l.TimeZone = 'Pacific Standard Time' THEN 'PST'        WHEN l.TimeZone = 'Central Standard Time' THEN 'CST'        WHEN l.TimeZone = 'Eastern Standard Time' THEN 'EST'      END AS TimeZone,     l.BusinessName as ProviderName,     (h.[FirstName] + ' ' + h.[LastName]) HCPName,     ma.[Confirmed],     ma.[AppointmentStatus],     (CASE        WHEN ma.[Confirmed] = 1 THEN 'Confirmed'        ELSE 'UnConfirmed' END     ) ConfirmationStatus,      (l.[Address1]+' '+l.[Address2]+','+l.[City]+','+l.[State]+','+l.[Zip]) ProviderLocation,      m.[NHMemberId],     mcd.ProviderId,     mcd.LocationId,     ma.[WalkIn],     ma.[MissingDate],     (CASE       WHEN JSON_VALUE(mcd.ProcessData, '$.insuranceCarrierName') is null then [in].[InsuranceCarrierName]      ELSE JSON_VALUE(mcd.ProcessData, '$.insuranceCarrierName')     END) insuranceCarrierName  from [provider].[MemberAppointments] ma      inner join [provider].[MemberChartData] mcd ON ma.MemberChartDataId = mcd.MemberChartDataId      inner join [provider].[MemberCharts] mc on mc.memberchartid = mcd.memberchartid       INNER JOIN [provider].[MemberProfiles] m ON mc.MemberProfileId = m.MemberProfileId      INNER JOIN [provider].[AppointmentTypes] t ON ma.[AppointmentTypeId] = t.[AppointmentTypeId]      INNER JOIN [provider].[Locations] l ON mcd.locationId = l.locationId      INNER JOIN [provider].[ProviderProfiles] p ON mcd.providerid = p.providerid      INNER JOIN [auth].[UserProfiles] h ON ma.[HCPUserProfileId] = h.[UserProfileId]      LEFT JOIN [Insurance].[InsuranceCarriers] [in] on [in].[InsuranceCarrierID]= JSON_VALUE(mcd.ProcessData, '$.InsuranceCarrierId')      where  ma.[IsActive] = 1 AND mcd.[IsActive] = 1 AND mc.[IsActive] = 1 and  mc.MemberProfileId = @MemberProfileId      ORDER BY ma.[MemberAppointmentId] desc    END  
  CREATE PROCEDURE [Queues].[CompleteTask] (   @TaskId   BIGINT = NULL  )  AS  BEGIN   UPDATE TOP (1)    tasks   SET    Status = 'Completed',    IsAssigned = 0   FROM    Queues.Tasks tasks WITH (ROWLOCK, READPAST, UPDLOCK)   WHERE 1=1    AND TaskId = @TaskId     SELECT * FROM Queues.Tasks where TaskId = @TaskId  END
create PROCEDURE [Queues].[ClaimTask] (   @UserProfileId BIGINT = NULL,   @FromAssigned BIT = 0,   @TypeId   BIGINT = 0,   @OriginId  BIGINT = 0,   @TaskId   BIGINT = NULL,   @Options  NVARCHAR(MAX) = NULL  )  AS  BEGIN   DECLARE @Username VARCHAR(100) = (select top 1 Username from auth.userprofiles where UserProfileId = @UserProfileId AND IsActive = 1)     IF (@Username IS NULL)   BEGIN    SELECT NULL   END   ELSE   BEGIN    IF (@Options IS NOT NULL AND ISJSON(@Options) = 1)    BEGIN     DECLARE @Filters NVARCHAR(MAX) = (SELECT JSON_QUERY(@Options, '$.filters'))       -- TimeZone filter     DECLARE @HasTimeZoneFilter BIT = (SELECT CASE WHEN JSON_QUERY(@Filters, '$.timeZone') IS NOT NULL THEN 1 ELSE 0 END)     IF(@HasTimeZoneFilter = 1)     BEGIN      DECLARE @BusinessStartHour INT = (SELECT JSON_VALUE(@Filters, '$.timeZone.businessStartHour'))      DECLARE @BusinessEndHour INT = (SELECT JSON_VALUE(@Filters, '$.timeZone.businessEndHour'))      DECLARE @TimeZone INT = (SELECT JSON_VALUE(@Filters, '$.timeZone.timeZone'))     END    END      DECLARE @AlreadyAssignedTasks BIGINT = (SELECT COUNT(*) FROM Queues.Tasks WHERE Status = 'Claimed' AND UserProfileId = @UserProfileId AND TypeId = @TypeId)    DECLARE @ClaimedTask TABLE (ID BIGINT)      IF (@AlreadyAssignedTasks > 0)    BEGIN     SELECT TOP 1 * FROM Queues.Tasks WHERE Status = 'Claimed' AND UserProfileId = @UserProfileId    END    ELSE    BEGIN     UPDATE TOP (1)      tasks     SET      UserProfileId = @UserProfileId,      Status = 'Claimed',      IsAssigned = 1,      ModifyUser = @Username,      ModifyDate = GETUTCDATE()     OUTPUT INSERTED.TaskId INTO @ClaimedTask     FROM      Queues.Tasks tasks WITH (ROWLOCK, READPAST, UPDLOCK)     WHERE       (       TaskId = @TaskId       OR OriginId = @OriginId      )      OR (       1=1       AND 1=CASE WHEN @FromAssigned = 1          THEN CASE WHEN UserProfileId = @UserProfileId THEN 1 ELSE 0 END         ELSE 1 END       AND Status IN (CASE WHEN @FromAssigned = 1 THEN 'Assigned' ELSE '' END, 'Queued')       AND TypeId = @TypeId         -- Timezone filter       AND (        ISNULL(@HasTimeZoneFilter, 0) = 0        OR (         1=1         AND ISJSON(Message) = 1         AND JSON_VALUE(Message, '$.timeZone') IS NOT NULL         AND DATEPART(HOUR, GETUTCDATE() AT TIME ZONE JSON_VALUE(Message, '$.timeZone')) BETWEEN @BusinessStartHour AND @BusinessEndHour        )       )      )        SELECT TOP 1 * FROM Queues.Tasks WHERE TaskId = ( SELECT TOP 1 ID FROM @ClaimedTask)    END   END  END
Create procedure [ReportsData].[POReportByMonth]  AS  select Carrier, DATENAME(month,PODATE) + DATENAME(year,PODATE) as 'MonthYY', sum(qty) as 'DevicesQTY', count(*) as 'Orders'  from [ReportsData].[viewPOReport]  where Carrier is not null and PODATE is not null  group by Carrier, DATENAME(month,PODATE) + DATENAME(year,PODATE)  order by Carrier, DATENAME(month,PODATE) + DATENAME(year,PODATE)
  CREATE PROCEDURE [rulesengine].[getMemberInsurances] @NHMemberID nvarchar(20)    AS  BEGIN      SELECT MemberInsuranceID,    InsuranceCarrierID,    InsuranceEffectiveDate,    InsuranceEndDate,    InsuranceHealthPlanID,    InsuranceType,IsActive,    MemberProfileId,    IsDeleted,    UseForBenefits,    OtherCarrierName,    OtherPlanName  from [provider].[MemberInsurances]  where [MemberProfileId] = (select [MemberProfileId] from [provider].[MemberProfiles] where [NHMemberId] = @NHMemberID )    END  
CREATE PROCEDURE [rulesengine].[getBenefitRuleData] @InsuranceCarrierId bigint, @InsuranceHealthPlanId bigint    AS  BEGIN      select * from rulesengine.BenefitRulesData   where BenefitRuleDataId in  (   select BenefitRuleDataId from Insurance.ContractRules    where HealthPlanContractId in   (    select HealthPlanContractId from Insurance.HealthPlanContracts    where InsuranceCarrierID =@InsuranceCarrierId and InsuranceHealthPlanID = @InsuranceHealthPlanId   ) AND IsActive = 1 --Added by Harika  )  AND  JSON_VALUE(BenefitRuleData, '$.BENTYPE') = 'HA'  END
  CREATE PROCEDURE [rulesengine].[getOrders]  (      -- Add the parameters for the stored procedure here     @TransactionIds nvarchar(max)  )  AS  BEGIN      -- SET NOCOUNT ON added to prevent extra result sets from      -- interfering with SELECT statements.      SET NOCOUNT ON   Declare @Str nvarchar(max)      -- Insert statements for procedure here    set @str =  'select * from Orders.Orders where OrderID in ( select OrderID from [Orders].[OrderTransactionDetails] where OrderTransactionID in (' + @Transactionids + '))'       execute sp_executesql @str    END  
  -- =============================================  -- Author:      Micah Elliott  -- Create Date: 9/13/2019  -- Description: Transfers a payment from one account to another  -- =============================================  CREATE PROCEDURE [support].[TransferPayment]  (   @FromOrderId BIGINT = NULL,   @ToOrderId BIGINT = NULL,   @Requester VARCHAR(50) = NULL  )  AS  BEGIN      -- SET NOCOUNT ON added to prevent extra result sets from      -- interfering with SELECT statements.      SET NOCOUNT ON     IF (SELECT COUNT(*) FROM Orders.Orders WHERE OrderId = @FromOrderId) < 1    BEGIN    SELECT 'There is no order with this Id: ' + CAST(@FromOrderId as varchar(20))   END     ELSE IF (SELECT COUNT(*) FROM Orders.Orders WHERE OrderId = @ToOrderId) < 1   BEGIN    SELECT 'There is no order with this Id: ' + CAST(@ToOrderId as varchar(20))   END     ELSE IF (SELECT COUNT(*) FROM Orders.OrderTransactionDetails WHERE OrderId = @FromOrderId AND OrderStatusCode = 'PAY' AND IsActive = 1) < 1   BEGIN    SELECT 'There is no payment record for this order: ' + CAST(@FromOrderId as varchar(20))   END     ELSE IF (SELECT COUNT(*) FROM Orders.OrderTransactionDetails WHERE OrderId = @ToOrderId AND OrderStatusCode = 'PAY' AND IsActive = 1) >= 1   BEGIN    SELECT 'There is already an existing payment record for this order: ' + CAST(@ToOrderId as varchar(20))   END     ELSE   BEGIN    INSERT INTO orders.ordertransactiondetails    SELECT     @ToOrderId,     'PAY',     OrderTransactionData,     (      CASE       WHEN JSON_VALUE(OrderTransactionData, '$.totalAmount') >= (SELECT TOP 1 Amount FROM Orders.Orders WHERE OrderId = @ToOrderId) THEN 1 ELSE 0      END     ),     GETDATE(),      'NHAdmin',     GETDATE(),     @Requester,     1    FROM orders.ordertransactiondetails     WHERE 1=1     AND orderid = @FromOrderId       AND OrderStatusCode = 'PAY'     AND IsActive = 1      SELECT CONCAT('Payment was successfully transferred from ', @FromOrderId, ' to ', @ToOrderId)   END       END  
-- =============================================  -- Author:      Jitender  -- Create Date: 09/09/2020  -- Description: Reset HCP Credentials  -- EXEC [support].[ResetHCPCredentials] 'HIS','guaranteedhearing@yahoo.com','181245','TerrenceOzog',6542  -- =============================================  CREATE PROCEDURE [support].[ResetHCPCredentials]  (   @Designation varchar(10) = NULL,   @PrimaryEmail varchar(100) = NULL,   @ProviderCode varchar(20) = NULL, -- SD - Make it varchar(20)   @Username varchar(100) = NULL,   @HCPId BIGINT = NULL  )  AS  BEGIN     BEGIN TRY   BEGIN TRANSACTION ResetHCPCredentials        -- SET NOCOUNT ON added to prevent extra result sets from      -- interfering with SELECT statements.    SET NOCOUNT ON      IF (SELECT COUNT(*) FROM auth.userprofiles          WHERE UserProfileId IN (                select UserProfileId from provider.HCPProviderProfile                 where HCPId = @HCPId)                 ) < 1    BEGIN     SELECT 'There is no HCPId with this Id: ' + CAST(@HCPId as varchar(50))    END        ELSE    BEGIN      UPDATE up        set up.Designation=@Designation        ,up.PrimaryEmail=@PrimaryEmail        ,up.ProviderCode=@ProviderCode        ,up.UserName=@Username        ,up.TemproryKeyCode= UPPER(LEFT(REPLACE(NEWID(),'-',''),10))        ,up.IsVerified=0        ,up.IsRegister=0        ,up.IsActive=1        ,up.IsBlocked = 0        ,up.PasswordHash=NULL        ,up.PasswordSalt=NULL        ,up.IsEnabled = 1 -- SD - Included column which should be always 1      FROM auth.UserProfiles  up      WHERE 1=1      and UserProfileId IN (            select UserProfileId            from provider.HCPProviderProfile            where HCPId = @HCPId           )     SELECT CONCAT('Reset Credential Successfully Update For ',  @HCPId)       END     COMMIT TRANSACTION ResetHCPCredentials   PRINT 'SUCCESS'     END TRY   BEGIN CATCH      DECLARE @ErrorMessage NVARCHAR(4000);      DECLARE @ErrorSeverity INT;      DECLARE @ErrorState INT;        SELECT        @ErrorMessage = ERROR_MESSAGE(),       @ErrorSeverity = ERROR_SEVERITY(),       @ErrorState = ERROR_STATE();         IF (@@TRANCOUNT > 0)     BEGIN      ROLLBACK TRANSACTION ResetHCPCredentials      RAISERROR(@ErrorMessage,@ErrorSeverity,@ErrorState);      PRINT 'FAILED'     END     END CATCH  END
-- =============================================  -- Author:      Jitender  -- Create Date: 09/10/2020  -- Description: Create PCC Credentials  -- EXEC [support].[CreatePCCCredentails] 'Jitender','Makwana','','djim','jmak@yahoo.com',1368,6680,'PCC'  -- =============================================  CREATE PROCEDURE [support].[CreatePCCCredentails]  (   @FirstName VARCHAR(100) = NULL,    @LastName VARCHAR(100) = NULL,     @MiddleName VARCHAR(100) = NULL,   @UserName VARCHAR(100) = NULL,   @Email VARCHAR(100) = NULL,    @ProviderID INT = NULL,    @LocationID INT = NULL,   @Designation VARCHAR(50) = NULL  )      AS  BEGIN     BEGIN TRY   BEGIN TRANSACTION CreatePCCCredentails        -- SET NOCOUNT ON added to prevent extra result sets from      -- interfering with SELECT statements.      SET NOCOUNT ON     DECLARE @TempKeyCode VARCHAR(100)   SET @TempKeyCode = UPPER(LEFT(REPLACE(NEWID(),'-',''),10))     IF     (SELECT COUNT(*) FROM auth.userprofiles WHERE username = @UserName) > 0   BEGIN    SELECT 'Username already exists in the system : ' + CAST(@Username as varchar(50))   END       ELSE   BEGIN     INSERT INTO [auth].[UserProfiles]           ( [CreateDate] , [CreateUser] , [Designation]  , [FirstName] , [IsActive]  , [IsBlocked]                , [IsEnabled]  , [IsRegister] , [LastName] , [MiddleName] , [ModifyDate] , [ModifyUser]            , [PasswordHash] , [PasswordSalt] , [TemproryKeyCode] , [UserName] , [UserProfileImage]          , [LastLoginDate] , [Gender]  , [DOB] , [Languages] , [IsVerified]  , [PrimaryEmail]          , [PrimaryPhoneNumber] , [ProviderCode] , [Title])      VALUES         (GETDATE(), CURRENT_USER, @Designation, @FirstName, 1, 0        ,1, 0, @LastName, @MiddleName, GETDATE(), CURRENT_USER        ,NULL, NULL, @TempKeyCode, @UserName        ,NULL, NULL, NULL, NULL, NULL, 0, @Email        ,NULL, cast(180000+@ProviderID AS VARCHAR), NULL)         -- User Group    IF @Designation = 'PCC'    BEGIN       INSERT INTO auth.UserProfileGroups       SELECT 7200 ,( SELECT UserProfileId FROM [auth].[UserProfiles] WHERE 1=1 AND UserName=@UserName)        ,GETDATE(),CURRENT_USER,1,GETDATE(),CURRENT_USER    END    IF @Designation = 'Owner'    BEGIN       INSERT INTO auth.UserProfileGroups       SELECT 7790 ,( SELECT UserProfileId FROM [auth].[UserProfiles] WHERE 1=1 AND UserName=@UserName)        ,GETDATE(),CURRENT_USER,1,GETDATE(),CURRENT_USER    END    IF @Designation = 'HCP'    BEGIN       INSERT INTO auth.UserProfileGroups       SELECT 7600 ,( SELECT UserProfileId FROM [auth].[UserProfiles] WHERE 1=1 AND UserName=@UserName)        ,GETDATE(),CURRENT_USER,1,GETDATE(),CURRENT_USER    END      -- User under Provider     INSERT INTO provider.ProviderUsers     SELECT @ProviderID,(SELECT UserProfileId FROM [auth].[UserProfiles] WHERE 1=1 AND UserName=@UserName)      ,GETDATE(),CURRENT_USER,1,GETDATE(),CURRENT_USER      -- User and Locations mapping        IF @LocationID!=99999 -- Map specific locatins only    BEGIN      INSERT INTO provider.ProviderUserLocations      SELECT @ProviderID,@LocationID -- ProviderId, LocationId      ,(SELECT UserProfileId FROM [auth].[UserProfiles] WHERE 1=1 AND UserName=@UserName)       ,GETDATE(),CURRENT_USER,1,GETDATE(),CURRENT_USER    END    IF @LocationID=99999 -- Map all active locations under that provider   -- SD - In our discussion you said adding all locations under the provider to user is disabled?    BEGIN      INSERT INTO provider.ProviderUserLocations      SELECT pl.ProviderId,pl.LocationId      ,(SELECT UserProfileId FROM [auth].[UserProfiles] WHERE 1=1 AND UserName=@UserName)       ,GETDATE(),CURRENT_USER,1,GETDATE(),CURRENT_USER       FROM provider.ProviderLocations pl      JOIN provider.Locations l on (pl.LocationId=l.LocationId and l.IsActive=1)      WHERE ProviderId=@ProviderID     END      SELECT CONCAT('PCC Credential Successfully Created For ',  @UserName)     END     COMMIT TRANSACTION CreatePCCCredentails   PRINT 'SUCCESS'     END TRY   BEGIN CATCH    DECLARE @ErrorM
-- =============================================  -- Author:      Micah Elliott  -- Create Date: 9/13/2019  -- Description: Creates a new BM User Account with the given details  -- =============================================  CREATE PROCEDURE [support].[CreateBMUserAccount]  (      @FirstName varchar(50) = '',   @LastName varchar(100) = '',   @Username varchar(12) = NULL  )  AS  BEGIN      -- SET NOCOUNT ON added to prevent extra result sets from      -- interfering with SELECT statements.      SET NOCOUNT ON     declare @createuser varchar(100)   declare @appmoduleroleid bigint   declare @appmoduleid bigint   declare @userprofileid bigint   declare @usergroupid bigint   declare @usergroupmoduleid bigint   declare @usergroupmoduleroleid bigint   declare @appmodulerolemenuid bigint     declare @output table (id bigint)     -------------------   set @createuser = 'NHAdmin'   -------------------   -- Get Module   set @appmoduleid = (select AppModuleId from auth.AppModules where ModuleName = 'Admin Portal')     -- Get role   set @appmoduleroleid = (select AppModuleRoleId from auth.AppModuleRoles where AppModuleId = @appmoduleid and AppModuleRoleName = 'Benefit Matrix User')     -- Get Menus for Role   set @appmodulerolemenuid = (select AppModuleRoleMenuId from auth.AppModuleRoleMenus where AppModuleRoleId = @appmoduleroleid and AppModuleRoleMenuName = 'Home')     -- Get User Groups for Role   set @usergroupid = (select UserGroupId from auth.UserGroups where UserGroupName = 'NH-Admin BM User UserGroup')     -- Get usergroup<-->appmodule connection for Role   set @usergroupmoduleid = (select UserGroupModuleId from auth.UserGroupModules where AppModuleId = @appmoduleid and UserGroupId = @usergroupid)     -- Get usergroup<-->appmodulerole connection for Role   set @usergroupmoduleroleid = (select UserGroupModuleRoleId from auth.UserGroupModuleRoles where UserGroupId = @usergroupid and AppModuleRoleId = @appmoduleroleid)     -- Create new user    insert into auth.UserProfiles(ProviderCode, FirstName, MiddleName, LastName, IsBlocked, IsEnabled, IsRegister, IsVerified, TemproryKeyCode, UserName,    CreateUser, CreateDate, ModifyUser, ModifyDate, IsActive)   output inserted.UserProfileId into @output   values (    180000,    @firstname,    '',    @lastname,    0, 1, 0, 1,    @lastname,    ISNULL(@Username, LOWER(CONCAT(LEFT(@firstname, 1), @lastname))),    @createuser, GETDATE(), @createuser, GETDATE(), 1   )   set @userprofileid = (select top 1 id from @output)     -- Add user group   insert into auth.UserProfileGroups(UserGroupId, UserProfileId, CreateUser, CreateDate, ModifyUser, ModifyDate, IsActive)   values (    @usergroupid,    @userprofileid,    @createuser, GETDATE(), @createuser, GETDATE(), 1   )     -- Add user settings   insert into auth.UserProfileSettings(UserProfileId, SettingName, SettingValue, CreateUser, CreateDate, ModifyUser, ModifyDate, IsActive)   values (    @userprofileid,    'Roles',    '["'+ cast(@appmoduleroleid as varchar) +'"]',    @createuser, GETDATE(), @createuser, GETDATE(), 1   )     select @userprofileid, @lastname  END
-- =============================================  -- Author:      Micah Elliott  -- Create Date: 9/13/2019  -- Description: Releases provider portal to the given user using the information provided by Provider Network team  -- =============================================    CREATE PROCEDURE [support].[CreateProviderPortalReleaseAccount]  (      @FirstName varchar(50) = '',   @LastName varchar(100) = '',   @ProviderId bigint = NULL,   @Username varchar(50) = NULL,   @Email varchar(200) = NULL  )  AS  BEGIN      -- SET NOCOUNT ON added to prevent extra result sets from      -- interfering with SELECT statements.      SET NOCOUNT ON     declare @createuser varchar(100)     declare @appmoduleroleid bigint   declare @appmoduleid bigint   declare @userprofileid bigint   declare @usergroupid bigint   declare @usergroupmoduleid bigint   declare @usergroupmoduleroleid bigint   declare @appmodulerolemenuid bigint   declare @keycode VARCHAR(10) = ( SELECT REPLACE(LOWER(SUBSTRING(CONVERT(varchar(40), NEWID()),0,10)), '-', '') )     declare @output table (id bigint)     -------------------   set @createuser = 'NHAdmin'   -------------------     -- Get Module   set @appmoduleid = (select AppModuleId from auth.AppModules where ModuleName = 'Provider Portal')     -- Get role   set @appmoduleroleid = (select AppModuleRoleId from auth.AppModuleRoles where AppModuleId = @appmoduleid and AppModuleRoleName = 'Provider Business Owner')     -- Get Menus for Role   set @appmodulerolemenuid = (select AppModuleRoleMenuId from auth.AppModuleRoleMenus where AppModuleRoleId = @appmoduleroleid and AppModuleRoleMenuName = 'Home')     -- Get User Groups for Role   set @usergroupid = (select UserGroupId from auth.UserGroups where UserGroupName = 'NH-Provider-Owner User Group')     -- Get usergroup<-->appmodule connection for Role   set @usergroupmoduleid = (select UserGroupModuleId from auth.UserGroupModules where AppModuleId = @appmoduleid and UserGroupId = @usergroupid)     -- Get usergroup<-->appmodulerole connection for Role   set @usergroupmoduleroleid = (select UserGroupModuleRoleId from auth.UserGroupModuleRoles where UserGroupId = @usergroupid and AppModuleRoleId = @appmoduleroleid)     if (select count(*) from auth.userprofiles where isactive = 1 and Username = ISNULL(@Username, LOWER(CONCAT(LEFT(@firstname, 1), @lastname)))) = 0    begin     -- Create new user      insert into auth.UserProfiles(FirstName, MiddleName, LastName, IsBlocked, IsEnabled, IsRegister, IsVerified, TemproryKeyCode, UserName, PrimaryEmail,      CreateUser, CreateDate, ModifyUser, ModifyDate, IsActive)     output inserted.UserProfileId into @output     values (      @firstname,      '',      @lastname,      0, 1, 0, 0,      @keycode,      ISNULL(@Username, LOWER(CONCAT(LEFT(@firstname, 1), @lastname))),      @Email,      @createuser, GETDATE(), @createuser, GETDATE(), 1     )     set @userprofileid = (select top 1 id from @output)     delete from @output       -- Add user group     insert into auth.UserProfileGroups(UserGroupId, UserProfileId, CreateUser, CreateDate, ModifyUser, ModifyDate, IsActive)     values (      @usergroupid,      @userprofileid,      @createuser, GETDATE(), @createuser, GETDATE(), 1     )       -- Add user settings     insert into auth.UserProfileSettings(UserProfileId, SettingName, SettingValue, CreateUser, CreateDate, ModifyUser, ModifyDate, IsActive)     values (      @userprofileid,      'Roles',      '["'+ cast(@appmoduleroleid as varchar) +'"]',      @createuser, GETDATE(), @createuser, GETDATE(), 1     )       if (select count(*) from provider.providerprofiles where providerid = @ProviderId and IsActive = 1) > 0     begin      insert into provider.providerusers([ProviderId], [UserProfileId], [CreateDate], [CreateUser], [IsActive], [ModifyDate], [ModifyUser])      values(       @ProviderId,       @userprofileid,       GETDATE(),       @createuser,       1,       GETDATE(),       @createuser       )        insert into provider.provideruserlocations
CREATE PROCEDURE [support].[LoadOTCSerialNbr] (   @InsuranceNbr VARCHAR(100) = NULL,   @SerialNbr VARCHAR(100) = NULL  )  AS  BEGIN   IF (@InsuranceNbr IS NULL)   BEGIN    SELECT 'Insurance # is required'    RETURN   END     DECLARE @MasterMemberInsuranceDetailsId BIGINT = (    SELECT      TOP 1 MID.ID     FROM Master.MemberInsuranceDetails MID    LEFT OUTER JOIN Master.MemberInsurances MI ON MI.ID = MID.MemberInsuranceID     WHERE 1=1     AND InsuranceNbr = @InsuranceNbr     --AND GETDATE() BETWEEN InsuranceEffectiveDate and InsuranceEndDate     --AND MID.OTCSerialNumber IS NULL   )     DECLARE @ProviderMemberInsuranceDetailsId BIGINT = (    SELECT      TOP 1 MID.ID     FROM Provider.MemberInsuranceDetails MID    LEFT OUTER JOIN Provider.MemberInsurances MI ON MI.MemberInsuranceId = MID.MemberInsuranceID     WHERE 1=1     AND InsuranceNbr = @InsuranceNbr      --AND GETDATE() BETWEEN InsuranceEffectiveDate and InsuranceEndDate     --AND MID.OTCSerialNumber IS NULL   )     IF (@SerialNbr IS NULL)   BEGIN    SELECT 'Serial # is required'    RETURN   END     ELSE IF (@MasterMemberInsuranceDetailsId IS NULL AND @ProviderMemberInsuranceDetailsId IS NULL)   BEGIN    SELECT 'No active member insurance found with that Insurance #'    RETURN   END     ELSE IF ((select count(*) from support.OTCSerialNumberLoad where SerialNbr = @SerialNbr and AddedDate IS NOT NULL) > 0)   BEGIN    SELECT TOP 1 CONCAT('Serial number has already been loaded on ', CONVERT(varchar, AddedDate, 101))    FROM support.OTCSerialNumberLoad     WHERE SerialNbr = @SerialNbr and AddedDate IS NOT NULL   END     ELSE    BEGIN    INSERT INTO support.OTCSerialNumberLoad    SELECT     @MasterMemberInsuranceDetailsId,     @ProviderMemberInsuranceDetailsId,     @InsuranceNbr,     @SerialNbr,     NULL,     GETDATE(),     NULL    --IF (    -- (SELECT OTCSerialNumber FROM Master.MemberInsuranceDetails where ID = @MasterMemberInsuranceDetailsId)    -- IS NOT NULL    -- OR    -- (SELECT OTCSerialNumber FROM Provider.MemberInsuranceDetails where ID = @ProviderMemberInsuranceDetailsId)    -- IS NOT NULL    --)    --BEGIN    -- INSERT INTO support.OTCSerialNumberLoad    -- SELECT    --  @MasterMemberInsuranceDetailsId,    --  @ProviderMemberInsuranceDetailsId,    --  @InsuranceNbr,    --  @SerialNbr,    --  'Member already has a serial number tied to this account',    --  NULL    --END      --ELSE BEGIN    -- IF (@MasterMemberInsuranceDetailsId IS NOT NULL)    -- BEGIN    --  UPDATE    --   Master.MemberInsuranceDetails    --  SET    --   OTCSerialNumber = @SerialNbr    --  WHERE    --   ID = @MasterMemberInsuranceDetailsId    -- END      -- IF (@ProviderMemberInsuranceDetailsId IS NOT NULL)    -- BEGIN    --  UPDATE    --   provider.MemberInsuranceDetails    --  SET    --   OTCSerialNumber = @SerialNbr    --  WHERE    --   ID = @ProviderMemberInsuranceDetailsId    -- END      -- INSERT INTO support.OTCSerialNumberLoad    -- SELECT    --  @MasterMemberInsuranceDetailsId,    --  @ProviderMemberInsuranceDetailsId,    --  @InsuranceNbr,    --  @SerialNbr,    --  NULL,    --  GETDATE()      -- UPDATE otc.Cards SET SerialNbr = NULL WHERE SerialNbr = @SerialNbr    --END   END  END
-- =============================================  -- Author:      Micah Elliott  -- Create Date: 9/13/2019  -- Description: Creates a new BM Admin Account with the given details  -- =============================================  CREATE PROCEDURE [support].[CreateBMAdminAccount]  (      @FirstName varchar(50) = '',   @LastName varchar(100) = '',   @Username varchar(12) = NULL  )  AS  BEGIN      -- SET NOCOUNT ON added to prevent extra result sets from      -- interfering with SELECT statements.      SET NOCOUNT ON     declare @createuser varchar(100)   declare @appmoduleroleid bigint   declare @appmoduleid bigint   declare @userprofileid bigint   declare @usergroupid bigint   declare @usergroupmoduleid bigint   declare @usergroupmoduleroleid bigint   declare @appmodulerolemenuid bigint     declare @output table (id bigint)     -------------------   set @createuser = 'NHAdmin'   -------------------   -- Get Module   set @appmoduleid = (select AppModuleId from auth.AppModules where ModuleName = 'Admin Portal')     -- Get role   set @appmoduleroleid = (select AppModuleRoleId from auth.AppModuleRoles where AppModuleId = @appmoduleid and AppModuleRoleName = 'Benefit Matrix Admin')     -- Get Menus for Role   set @appmodulerolemenuid = (select AppModuleRoleMenuId from auth.AppModuleRoleMenus where AppModuleRoleId = @appmoduleroleid and AppModuleRoleMenuName = 'Home')     -- Get User Groups for Role   set @usergroupid = (select UserGroupId from auth.UserGroups where UserGroupName = 'NH-Admin BM Admin UserGroup')     -- Get usergroup<-->appmodule connection for Role   set @usergroupmoduleid = (select UserGroupModuleId from auth.UserGroupModules where AppModuleId = @appmoduleid and UserGroupId = @usergroupid)     -- Get usergroup<-->appmodulerole connection for Role   set @usergroupmoduleroleid = (select UserGroupModuleRoleId from auth.UserGroupModuleRoles where UserGroupId = @usergroupid and AppModuleRoleId = @appmoduleroleid)     -- Create new user    insert into auth.UserProfiles(ProviderCode, FirstName, MiddleName, LastName, IsBlocked, IsEnabled, IsRegister, IsVerified, TemproryKeyCode, UserName,     CreateUser, CreateDate, ModifyUser, ModifyDate, IsActive)   output inserted.UserProfileId into @output   values (    180000,    @firstname,    '',    @lastname,    0, 1, 0, 1,    @lastname,    ISNULL(@Username, LOWER(CONCAT(LEFT(@firstname, 1), @lastname))),    @createuser, GETDATE(), @createuser, GETDATE(), 1   )   set @userprofileid = (select top 1 id from @output)     -- Add user group   insert into auth.UserProfileGroups(UserGroupId, UserProfileId, CreateUser, CreateDate, ModifyUser, ModifyDate, IsActive)   values (    @usergroupid,    @userprofileid,    @createuser, GETDATE(), @createuser, GETDATE(), 1   )     -- Add user settings   insert into auth.UserProfileSettings(UserProfileId, SettingName, SettingValue, CreateUser, CreateDate, ModifyUser, ModifyDate, IsActive)   values (    @userprofileid,    'Roles',    '["'+ cast(@appmoduleroleid as varchar) +'"]',    @createuser, GETDATE(), @createuser, GETDATE(), 1   )     select @userprofileid, @lastname  END
-- =============================================  -- Author:      Micah Elliott  -- Create Date: 9/13/2019  -- Description: Resets a user account  -- =============================================  CREATE PROCEDURE [support].[ResetUserAccount]  (   @Username varchar(100) = NULL  )  AS  BEGIN      -- SET NOCOUNT ON added to prevent extra result sets from      -- interfering with SELECT statements.      SET NOCOUNT ON     DECLARE @keycode VARCHAR(10) = ( SELECT REPLACE(LOWER(SUBSTRING(CONVERT(varchar(40), NEWID()),0,10)), '-', '') )     update auth.userprofiles    set     IsBlocked = 0    , PasswordHash = NULL    , PasswordSalt = NULL    , TemproryKeyCode = @keycode    , IsRegister = 0   where UserName = @Username     SELECT @keycode  END  
CREATE PROCEDURE [support].[Search] (   @search varchar(500) = NULL  )  AS  BEGIN   DECLARE @searchType varchar(10) = 'NA'      IF (@search LIKE '% %' AND @search LIKE '%[.]%' AND @search LIKE 'D %')   BEGIN    SELECT     *    INTO #TEMPCOMPLEXTABLESEARCH    FROM (     SELECT ROW_NUMBER() OVER (ORDER BY (SELECT 1)) RN, *     FROM STRING_SPLIT(@search, ' ')    ) TEMP       SELECT CASE      WHEN RN = 1 THEN 'DISCARDED'     WHEN RN = 2 AND ISNUMERIC(value) = 1 THEN 'ID'     WHEN RN = 3 AND OBJECT_ID(value, N'U') IS NOT NULL THEN 'TABLE'     WHEN RN = 4 AND EXISTS (SELECT * FROM SYS.COLUMNS WHERE OBJECT_ID = OBJECT_ID((SELECT TOP 1 value FROM #TEMPCOMPLEXTABLESEARCH WHERE RN = 2), N'U') AND NAME = value) THEN 'COLUMN'     ELSE 'NA' END [Type], value    INTO #COMPLEXTABLESEARCH    FROM #TEMPCOMPLEXTABLESEARCH      SET @searchType = 'DATA'   END     ELSE IF(@search LIKE '% %' AND @search NOT LIKE '%[.]%' AND @search NOT LIKE '%[0-9]%' AND @search LIKE 'U %')   BEGIN    SELECT     *    INTO #TEMPCOMPLEXUSERSEARCH    FROM (     SELECT ROW_NUMBER() OVER (ORDER BY (SELECT 1)) RN, *     FROM STRING_SPLIT(@search, ' ')    ) TEMP       SELECT CASE      WHEN RN = 1 AND ISNUMERIC(value) = 0 THEN 'DISCARDED'     WHEN RN = 2 AND ISNUMERIC(value) = 0 AND (SELECT COUNT(*) FROM #TEMPCOMPLEXUSERSEARCH) > 2 THEN 'FIRST'     WHEN RN = 2 AND ISNUMERIC(value) = 0 AND (SELECT COUNT(*) FROM #TEMPCOMPLEXUSERSEARCH) <= 2 THEN 'USERNAME'     WHEN RN = 3 AND ISNUMERIC(value) = 0 THEN 'LAST'     ELSE 'NA' END [Type], value    INTO #COMPLEXUSERSEARCH    FROM #TEMPCOMPLEXUSERSEARCH      SET @searchType = 'USER'   END     ELSE IF(@search LIKE '% %' AND @search NOT LIKE '%[.]%'  AND @search LIKE 'M %')   BEGIN    SELECT     *    INTO #TEMPCOMPLEXMEMBERSEARCH    FROM (     SELECT ROW_NUMBER() OVER (ORDER BY (SELECT 1)) RN, *     FROM STRING_SPLIT(@search, ' ')    ) TEMP       SELECT CASE      WHEN RN = 1 THEN 'DISCARDED'     WHEN RN = 2 AND ISNUMERIC(value) = 0 AND (SELECT COUNT(*) FROM #TEMPCOMPLEXMEMBERSEARCH) <= 2 THEN 'NHMEMBERID'     WHEN RN = 2 AND ISNUMERIC(value) = 0 AND (SELECT COUNT(*) FROM #TEMPCOMPLEXMEMBERSEARCH) > 2 THEN 'FIRST'     WHEN RN = 3 AND ISNUMERIC(value) = 0 THEN 'LAST'     ELSE 'NA' END [Type], value    INTO #COMPLEXMEMBERSEARCH    FROM #TEMPCOMPLEXMEMBERSEARCH      SET @searchType = 'MEMBER'   END     IF(@searchType = 'NA')   BEGIN    SELECT 'Search parameters were not entered correctly. Please follow one of the following patterns:'    UNION ALL SELECT 'USER: "U [<Username> | <First-name> <Last-name>]'    UNION ALL SELECT 'MEMBER: "M [<First-name> <Last-name> | ( NH | QA<NH-Member-ID> )]'    UNION ALL SELECT 'DATA: "D [<Search-value> <Schema-name> (dot) <Table-name> <Column-name>]'    RETURN   END     IF(@searchType = 'USER')   BEGIN    DECLARE @user VARCHAR(100) = ''      IF EXISTS (SELECT 1 FROM #COMPLEXUSERSEARCH WHERE [Type] = 'USERNAME')    BEGIN     SET @user = (      SELECT TOP 1 UserProfileId       FROM auth.userprofiles      WHERE Username = (       SELECT TOP 1 value FROM #COMPLEXUSERSEARCH WHERE [Type] = 'USERNAME'      )     )    END    ELSE    BEGIN     SET @user = (      SELECT TOP 1 UserProfileId       FROM auth.userprofiles      WHERE FirstName = (       SELECT TOP 1 value FROM #COMPLEXUSERSEARCH WHERE [Type] = 'FIRST'      ) and LastName = (       SELECT TOP 1 value FROM #COMPLEXUSERSEARCH WHERE [Type] = 'LAST'      )     )    END      SELECT * FROM auth.userprofiles where Userprofileid = @user   END     ELSE IF(@searchType = 'MEMBER')   BEGIN    DECLARE @nhmemberid varchar(100) = ''      IF EXISTS (SELECT 1 FROM #COMPLEXMEMBERSEARCH WHERE [Type] = 'NHMEMBERID')    BEGIN     SET @nhmemberid = (      SELECT TOP 1 NHMemberId       FROM provider.memberprofiles       WHERE NHMemberId = (       SELECT TOP 1 value FROM #COMPLEXMEMBERSEARCH WHERE [Type] = 'NHMEMBERID'      )     )    END    ELSE    BEGIN     SET @nhmemberid = (      SELECT TOP 1 NHMemberId       FROM provider.memberprofiles       WHERE FirstName = (       SELE
  -- =============================================  -- Author:      Micah Elliott  -- Create Date: 9/13/2019  -- Description: Gives a user a given role  -- =============================================  CREATE PROCEDURE [support].[AssignRole]  (   @Username varchar(50) = NULL,   @GroupId  bigint = NULL  )  AS  BEGIN      -- SET NOCOUNT ON added to prevent extra result sets from      -- interfering with SELECT statements.      SET NOCOUNT ON     declare @createuser varchar(100)     -------------------   set @createuser = 'NHAdmin'   -------------------     if (@GroupId is NULL or (select count(*) from auth.usergroups where userGroupId = @GroupId) < 1)    begin     -- Display list of available roles to user     select 'Please provide one of the following roles:'          select UserGroupId, UserGroupName, ModuleName, AppModuleRoleName     from auth.usergroups ug      left outer join auth.appmoduleroles amr on amr.AppModuleRoleId = ug.DefaultAppModuleRoleId     left outer join auth.appmodules am on am.AppModuleId = amr.AppModuleID    end   else if ((select Count(*) from auth.userprofiles where username = @Username) < 1)    begin     select CONCAT(@Username, ' is not a valid user profile')    end   else    begin     insert into auth.userprofilegroups     select      @GroupId      , (select UserprofileId from auth.userprofiles where Username= @Username)      , GETDATE()      , @createuser      , 1      , GETDATE()      , @createuser    end     select CONCAT(@Username, 'was successfully assigned to the '''+ (select UserGroupName from auth.usergroups where usergroupid = @GroupId) +''' group')  END  
-- =============================================  -- Author:      Micah Elliott  -- Create Date: 9/13/2019  -- Description: Deactivates a user account  -- =============================================  CREATE PROCEDURE [support].[DeactivateUserAccount]  (   @Username varchar(100) = NULL  )  AS  BEGIN      -- SET NOCOUNT ON added to prevent extra result sets from      -- interfering with SELECT statements.      SET NOCOUNT ON     update auth.userprofiles    set     IsBlocked = 1    , PasswordHash = NULL    , PasswordSalt = NULL    , IsActive = 1    , ProviderCode = NULL    where UserName = @Username  END
-- =============================================  -- Author:      Micah Elliott  -- Create Date: 9/13/2019  -- Description: Creates a new Provider User Account with the given details  -- =============================================  CREATE PROCEDURE [support].[CreateProviderUserAccount]  (      @FirstName varchar(50) = '',   @LastName varchar(100) = '',   @ProviderId varchar(max) = NULL,   @LocationId varchar(max) = NULL,   @Designation varchar(10) =  '',   @Email varchar(100) = NULL,   @Username varchar(100) = NULL  )  AS  BEGIN      -- SET NOCOUNT ON added to prevent extra result sets from      -- interfering with SELECT statements.      SET NOCOUNT ON     declare @createuser varchar(100)     declare @appmoduleroleid bigint   declare @appmoduleid bigint   declare @userprofileid bigint   declare @usergroupid bigint   declare @usergroupmoduleid bigint   declare @usergroupmoduleroleid bigint   declare @appmodulerolemenuid bigint     declare @output table (id bigint)     -------------------   set @createuser = 'NHAdmin'   -------------------     IF(@LocationID = '')   BEGIN    SET @LocationId = NULL   END     -- Get Module   set @appmoduleid = (select AppModuleId from auth.AppModules where ModuleName = 'Provider Portal')     -- Get role   set @appmoduleroleid = (select AppModuleRoleId from auth.AppModuleRoles where AppModuleId = @appmoduleid and AppModuleRoleName = 'Provider User')     -- Get Menus for Role   set @appmodulerolemenuid = (select AppModuleRoleMenuId from auth.AppModuleRoleMenus where AppModuleRoleId = @appmoduleroleid and AppModuleRoleMenuName = 'Home')     -- Get User Groups for Role   set @usergroupid = (select UserGroupId from auth.UserGroups where UserGroupName = 'NH-Provider-User Group')     -- Get usergroup<-->appmodule connection for Role   set @usergroupmoduleid = (select UserGroupModuleId from auth.UserGroupModules where AppModuleId = @appmoduleid and UserGroupId = @usergroupid)     -- Get usergroup<-->appmodulerole connection for Role   set @usergroupmoduleroleid = (select UserGroupModuleRoleId from auth.UserGroupModuleRoles where UserGroupId = @usergroupid and AppModuleRoleId = @appmoduleroleid)     declare @keycode VARCHAR(10) = LOWER(REPLACE(LEFT(NEWID(), 8), '-', ''))     -- Create new user    insert into auth.UserProfiles(FirstName, MiddleName, LastName, IsBlocked, IsEnabled, IsRegister, TemproryKeyCode, UserName, PrimaryEmail, Designation,    CreateUser, CreateDate, ModifyUser, ModifyDate, IsActive)   output inserted.UserProfileId into @output   values (    @firstname,    '',    @lastname,    0, 1, 0,    @keycode,    ISNULL(@Username, CONCAT(@FirstName, @LastName)), @Email, @Designation,    @createuser, GETDATE(), @createuser, GETDATE(), 1   )   set @userprofileid = (select top 1 id from @output)   delete from @output     -- Add user group   insert into auth.UserProfileGroups(UserGroupId, UserProfileId, CreateUser, CreateDate, ModifyUser, ModifyDate, IsActive)   values (    @usergroupid,    @userprofileid,    @createuser, GETDATE(), @createuser, GETDATE(), 1   )     -- Add user settings   insert into auth.UserProfileSettings(UserProfileId, SettingName, SettingValue, CreateUser, CreateDate, ModifyUser, ModifyDate, IsActive)   values (    @userprofileid,    'Roles',    '["'+ cast(@appmoduleroleid as varchar) +'"]',    @createuser, GETDATE(), @createuser, GETDATE(), 1   )     if     (     @LocationId IS NULL      OR (      select count(*) from provider.providerlocations where locationid in (       select cast(TRIM([Name]) as varchar(10)) from [catalog].[splitstring](@LocationId)       ) and IsActive = 1     ) > 0    )    and (select count(*) from provider.providerprofiles where providerid in (     select cast(TRIM([Name]) as bigint) from [catalog].[splitstring](@ProviderId)     ) and IsActive = 0) = 0    and (     @LocationId IS NULL      OR (      select count(*) from provider.locations where locationid in (       select cast(TRIM([Name]) as varchar(10)) from [catalog].[splitstring](@LocationId)     
--Created by DPSR  --update/insert missing shipping details  --exec [support].[sp_InsertUpdateMissingShippingDetails] 200029436,'6129098943611202477872','04/15/2020'  CREATE PROCEDURE [support].[sp_InsertUpdateMissingShippingDetails] (   @OrderID int = 0,   @TrackingNumber VARCHAR(30) = NULL,   @Shipdate varchar(20)  )  AS  BEGIN   declare @ServiceType varchar(30),     @ShipdateDDMMYYY varchar(10),     @sqlstr nvarchar(max),     @checkOrderIdExist1 int,     @checkOrderIdExist2 int,     @checkOrderIdExist3 int     --ServiceType:   --SmartPost -- has 19-20 digit long tracking number   --Home Delivery -- has 10-12 digit long tracking number   select @ServiceType = (case when len(@TrackingNumber) >=19 then 'SmartPost'                when len(@TrackingNumber) between 10 and 12 then 'Home Delivery' else 'N/A' end),     @ShipdateDDMMYYY = cast(FORMAT (cast(@Shipdate as date), 'dd/MM/yyyy ') as varchar);     --select @OrderID,@TrackingNumber,@Shipdate,@ServiceType,len(@TrackingNumber),@ShipdateDDMMYYY;     select @checkOrderIdExist1 = count(*) from  orders.Orders where OrderID = @OrderID and OrderStatusCode = 'SHI';   select @checkOrderIdExist2 = count(*) from Orders.OrderTransactionDetails where OrderID = @OrderID and OrderStatusCode = 'SHI';   select @checkOrderIdExist3 = count(*) from dbo.FedExShippingDetails where OrderID = cast(@OrderID as varchar(20));   --select @checkOrderIdExist1,@checkOrderIdExist2,isnull(@checkOrderIdExist3,0)     if @checkOrderIdExist1 = 0 and @checkOrderIdExist2 = 0 and isnull(@checkOrderIdExist3,0) = 0   BEGIN    --prep insert script   set @sqlstr = 'INSERT INTO Orders.OrderTransactionDetails SELECT ' + CAST(@OrderID as NVARCHAR(100))+ ', ''SHI'', ''[{"orderDate":"' + cast(FORMAT(getdate(), 'dd-MM-yyyy') as varchar(10)) + '","carrier":"fedex","serviceType":"'+@ServiceType+'","orderId":"' + CAST(@OrderId AS NVARCHAR(100)) + '","trackingNumber":"'+@TrackingNumber+'","shipDate":"'+@ShipdateDDMMYYY+'"}]'', 1, GETDATE(), SYSTEM_USER, GETDATE(), SYSTEM_USER, 1'+ ';'   --select @sqlstr       --begin tran t1;    EXEC sp_executesql @sqlstr;      update orders.Orders set OrderStatusCode='SHI' where OrderID = @OrderID;        insert into dbo.FedExShippingDetails (        [OrderId]   ,[Carrier]    ,[ServiceType]       ,[TrackingNumber]     ,[ReceiverName]   ,[GivenAddress1]       ,[GivenAddress2]      ,[GivenCity]   ,[GivenState]       ,[GivenZip]   ,[ShippedAddress1]      ,[ShippedAddress2]       ,[ShippedCity]  ,[ShippedState]   ,[ShippedZip]       ,[Weight]    ,[BoxHeight]   ,[BoxWidth]       ,[BoxLength]   ,[ShippingCost]   ,[IsProcessed]       ,[ShipDate]   ,[ModifyUser]   ,[CreateDate]       ,[ModifyDate]   ,[IsActive]       )    select cast(@OrderID as varchar(20))    ,null      ,@ServiceType       ,@TrackingNumber  ,null      ,JSON_VALUE(ShippingData, '$.address.address1')       ,JSON_VALUE(ShippingData, '$.address.address2'),JSON_VALUE(ShippingData, '$.address.city'),JSON_VALUE(ShippingData, '$.address.state')       ,JSON_VALUE(ShippingData, '$.address.zip'),JSON_VALUE(ShippingData, '$.address.address1') ,JSON_VALUE(ShippingData, '$.address.address2')       ,JSON_VALUE(ShippingData, '$.address.city'),JSON_VALUE(ShippingData, '$.address.state') ,JSON_VALUE(ShippingData, '$.address.zip')       ,null     ,null      ,null       ,null     ,null      ,1       ,cast(@Shipdate as date),'ManualInsert'  ,getdate()       ,getdate()     ,1    from orders.Orders     where OrderID = @OrderID;      --select * from  orders.Orders where OrderID = @OrderID;    --select * from Orders.OrderTransactionDetails where OrderID = @OrderID;    --select * from dbo.FedExShippingDetails where OrderID = cast(@OrderID as varchar(20));      --ROLLBACK tran t1;   END    END  
-- =============================================  -- Author:      Micah Elliott  -- Create Date: 9/13/2019  -- Description: Creates a new Provider Owner Account with the given details  -- =============================================  CREATE PROCEDURE [support].[CreateProviderOwnerAccount]  (      @FirstName varchar(50) = '',   @LastName varchar(100) = '',   @ProviderId bigint = NULL,   @LocationId varchar(max) = NULL,   @Designation varchar(10) =  '',   @Email varchar(100) = NULL,   @Username varchar(100) = NULL  )  AS  BEGIN      -- SET NOCOUNT ON added to prevent extra result sets from      -- interfering with SELECT statements.      SET NOCOUNT ON     declare @createuser varchar(100)     declare @appmoduleroleid bigint   declare @appmoduleid bigint   declare @userprofileid bigint   declare @usergroupid bigint   declare @usergroupmoduleid bigint   declare @usergroupmoduleroleid bigint   declare @appmodulerolemenuid bigint     declare @output table (id bigint)     -------------------   set @createuser = 'NHAdmin'   -------------------     IF(@LocationID = '')   BEGIN    SET @LocationId = NULL   END     -- Get Module   set @appmoduleid = (select AppModuleId from auth.AppModules where ModuleName = 'Provider Portal')     -- Get role   set @appmoduleroleid = (select AppModuleRoleId from auth.AppModuleRoles where AppModuleId = @appmoduleid and AppModuleRoleName = 'Provider Business Owner')     -- Get Menus for Role   set @appmodulerolemenuid = (select AppModuleRoleMenuId from auth.AppModuleRoleMenus where AppModuleRoleId = @appmoduleroleid and AppModuleRoleMenuName = 'Home')     -- Get User Groups for Role   set @usergroupid = (select UserGroupId from auth.UserGroups where UserGroupName = 'NH-Provider-Owner User Group')     -- Get usergroup<-->appmodule connection for Role   set @usergroupmoduleid = (select UserGroupModuleId from auth.UserGroupModules where AppModuleId = @appmoduleid and UserGroupId = @usergroupid)     -- Get usergroup<-->appmodulerole connection for Role   set @usergroupmoduleroleid = (select UserGroupModuleRoleId from auth.UserGroupModuleRoles where UserGroupId = @usergroupid and AppModuleRoleId = @appmoduleroleid)     declare @keycode VARCHAR(10) = LOWER(REPLACE(LEFT(NEWID(), 8), '-', ''))     -- Create new user    insert into auth.UserProfiles(FirstName, MiddleName, LastName, IsBlocked, IsEnabled, IsRegister, TemproryKeyCode, UserName, PrimaryEmail, Designation,    CreateUser, CreateDate, ModifyUser, ModifyDate, IsActive)   output inserted.UserProfileId into @output   values (    @firstname,    '',    @lastname,    0, 1, 0,    @keycode,    ISNULL(@Username, CONCAT(@FirstName, @LastName)), @Email, @Designation,    @createuser, GETDATE(), @createuser, GETDATE(), 1   )   set @userprofileid = (select top 1 id from @output)   delete from @output     -- Add user group   insert into auth.UserProfileGroups(UserGroupId, UserProfileId, CreateUser, CreateDate, ModifyUser, ModifyDate, IsActive)   values (    @usergroupid,    @userprofileid,    @createuser, GETDATE(), @createuser, GETDATE(), 1   )     -- Add user settings   insert into auth.UserProfileSettings(UserProfileId, SettingName, SettingValue, CreateUser, CreateDate, ModifyUser, ModifyDate, IsActive)   values (    @userprofileid,    'Roles',    '["'+ cast(@appmoduleroleid as varchar) +'"]',    @createuser, GETDATE(), @createuser, GETDATE(), 1   )     if     (     @LocationId IS NULL      OR (      select count(*) from provider.providerlocations where locationid in (       select cast([Name] as varchar(10)) from [catalog].[splitstring](@LocationId)       ) and IsActive = 1     ) > 0    )    and (select count(*) from provider.providerprofiles where providerid = @ProviderId and IsActive = 1) > 0    and (     @LocationId IS NULL      OR (      select count(*) from provider.locations where locationid in (       select cast([Name] as varchar(10)) from [catalog].[splitstring](@LocationId)      ) and IsActive = 1     ) > 0    )   begin    insert into provider.provideruser
  CREATE PROCEDURE [support].[MemberInfo] (   @nhMemberId varchar(100) = NULL  )  AS  BEGIN   select * from master.members where nhmemberid = @nhmemberid   select JSON_VALUE(brd.BenefitRuleData, '$.BENCATVALUE') BENAmount, mi.*    from master.memberinsurances mi   left outer join insurance.healthplancontracts hpc on hpc.insurancehealthplanid = mi.insurancehealthplanid   left outer join insurance.contractrules cr on cr.healthplancontractid = hpc.healthplancontractid   left outer join rulesengine.benefitrulesdata brd on brd.BenefitRuleDataId = cr.BenefitRuleDataId   where memberid =  (select top 1 memberid from master.members where nhmemberid = @Nhmemberid)     select * from provider.memberprofiles where nhmemberid = @Nhmemberid   select JSON_VALUE(brd.BenefitRuleData, '$.BENCATVALUE') BENAmount, mi.*    from provider.memberinsurances mi   left outer join insurance.healthplancontracts hpc on hpc.insurancehealthplanid = mi.insurancehealthplanid   left outer join insurance.contractrules cr on cr.healthplancontractid = hpc.healthplancontractid   left outer join rulesengine.benefitrulesdata brd on brd.BenefitRuleDataId = cr.BenefitRuleDataId   where memberprofileid = (select top 1 memberprofileid from provider.memberprofiles where nhmemberid = @Nhmemberid)   select * from orders.orders where nhmemberid = @nhmemberid  END    
-- =============================================  -- Author:      Micah Elliott  -- Create Date: 9/13/2019  -- Description: Creates a new IT Admin Account with the given details, and all admin roles, access to NH provider and location, and all Callcenter access  -- =============================================  CREATE PROCEDURE [support].[CreateITAdminAccount]  (      @FirstName varchar(50) = '',   @LastName varchar(100) = '',   @Username varchar(50) = NULL,   @Email varchar(150) = NULL  )  AS  BEGIN      -- SET NOCOUNT ON added to prevent extra result sets from      -- interfering with SELECT statements.      SET NOCOUNT ON     declare @createuser varchar(100)     declare @appmoduleroleid bigint   declare @appmoduleid bigint   declare @userprofileid bigint   declare @usergroupid bigint   declare @usergroupmoduleid bigint   declare @usergroupmoduleroleid bigint   declare @appmodulerolemenuid bigint     declare @output table (id bigint)     -------------------   set @createuser = 'NHAdmin'   -------------------     -- Get Module   set @appmoduleid = (select AppModuleId from auth.AppModules where ModuleName = 'Provider Portal')     -- Get role   set @appmoduleroleid = (select AppModuleRoleId from auth.AppModuleRoles where AppModuleId = @appmoduleid and AppModuleRoleName = 'NHAdmin Provider')     -- Get Menus for Role   set @appmodulerolemenuid = (select AppModuleRoleMenuId from auth.AppModuleRoleMenus where AppModuleRoleId = @appmoduleroleid and AppModuleRoleMenuName = 'Home')     -- Get User Groups for Role   set @usergroupid = (select UserGroupId from auth.UserGroups where UserGroupName = 'NH-Provider-Admin User Group')     -- Get usergroup<-->appmodule connection for Role   set @usergroupmoduleid = (select UserGroupModuleId from auth.UserGroupModules where AppModuleId = @appmoduleid and UserGroupId = @usergroupid)     -- Get usergroup<-->appmodulerole connection for Role   set @usergroupmoduleroleid = (select UserGroupModuleRoleId from auth.UserGroupModuleRoles where UserGroupId = @usergroupid and AppModuleRoleId = @appmoduleroleid)     declare @keycode varchar(10) = LOWER(REPLACE(LEFT(NEWID(), 8), '-', ''))   declare @user varchar(100) = ISNULL(@Username, LOWER(CONCAT(LEFT(@firstname, 1), @lastname)))     -- Create new user    insert into auth.UserProfiles(FirstName, MiddleName, LastName, IsBlocked, IsEnabled, IsRegister, TemproryKeyCode, UserName, PrimaryEmail,    CreateUser, CreateDate, ModifyUser, ModifyDate, IsActive)   output inserted.UserProfileId into @output   values (    @firstname,    '',    @lastname,    0, 1, 0,    @keycode,    @user,    @Email,    @createuser, GETDATE(), @createuser, GETDATE(), 1   )   set @userprofileid = (select top 1 id from @output)   delete from @output     -- Add user group   insert into auth.UserProfileGroups(UserGroupId, UserProfileId, CreateUser, CreateDate, ModifyUser, ModifyDate, IsActive)   values (    @usergroupid,    @userprofileid,    @createuser, GETDATE(), @createuser, GETDATE(), 1   )     -- Add user settings   insert into auth.UserProfileSettings(UserProfileId, SettingName, SettingValue, CreateUser, CreateDate, ModifyUser, ModifyDate, IsActive)   values (    @userprofileid,    'Roles',    '["'+ cast(@appmoduleroleid as varchar) +'"]',    @createuser, GETDATE(), @createuser, GETDATE(), 1   )     begin    insert into provider.providerusers([ProviderId], [UserProfileId], [CreateDate], [CreateUser], [IsActive], [ModifyDate], [ModifyUser])    select top 1     ProviderId,     @userprofileid,     GETDATE(),     @createuser,     1,     GETDATE(),     @createuser    from provider.providerprofiles    where ProviderCode = 180000      insert into provider.provideruserlocations([ProviderId], [LocationId], [UserProfileId], [CreateDate], [CreateUser], [IsActive], [ModifyDate], [ModifyUser])    select top 1     ProviderId,     LocationId,     @userprofileid,     GETDATE(),     @createuser,     1,     GETDATE(),     @createuser    from provider.providerlocations    where ProviderId = ( select 
-- =============================================  -- Author:      Micah Elliott  -- Create Date: 9/13/2019  -- Description: Creates a new Provider User Account with the given details  -- =============================================    CREATE PROCEDURE [support].[CreateProviderHCPAccount]  (      @FirstName varchar(50) = '',   @LastName varchar(100) = '',   @ProviderId varchar(max) = NULL,   @LocationId varchar(max) = NULL,   @Designation varchar(10) =  '',   @Email varchar(100) = NULL,   @Username varchar(100) = NULL  )  AS  BEGIN      -- SET NOCOUNT ON added to prevent extra result sets from      -- interfering with SELECT statements.      SET NOCOUNT ON     declare @createuser varchar(100)     declare @appmoduleroleid bigint   declare @appmoduleid bigint   declare @userprofileid bigint   declare @usergroupid bigint   declare @usergroupmoduleid bigint   declare @usergroupmoduleroleid bigint   declare @appmodulerolemenuid bigint     declare @output table (id bigint)     -------------------   set @createuser = 'NHAdmin'   -------------------     IF(@LocationID = '')   BEGIN    SET @LocationId = NULL   END     -- Get Module   set @appmoduleid = (select AppModuleId from auth.AppModules where ModuleName = 'Provider Portal')     -- Get role   set @appmoduleroleid = (select AppModuleRoleId from auth.AppModuleRoles where AppModuleId = @appmoduleid and AppModuleRoleName = 'Provider HCP')     -- Get Menus for Role   set @appmodulerolemenuid = (select AppModuleRoleMenuId from auth.AppModuleRoleMenus where AppModuleRoleId = @appmoduleroleid and AppModuleRoleMenuName = 'Home')     -- Get User Groups for Role   set @usergroupid = (select UserGroupId from auth.UserGroups where UserGroupName = 'NH-Provider-HCP User Group')     -- Get usergroup<-->appmodule connection for Role   set @usergroupmoduleid = (select UserGroupModuleId from auth.UserGroupModules where AppModuleId = @appmoduleid and UserGroupId = @usergroupid)     -- Get usergroup<-->appmodulerole connection for Role   set @usergroupmoduleroleid = (select UserGroupModuleRoleId from auth.UserGroupModuleRoles where UserGroupId = @usergroupid and AppModuleRoleId = @appmoduleroleid)     declare @keycode VARCHAR(10) = LOWER(REPLACE(LEFT(NEWID(), 8), '-', ''))     -- Create new user    insert into auth.UserProfiles(FirstName, MiddleName, LastName, IsBlocked, IsEnabled, IsRegister, TemproryKeyCode, UserName, PrimaryEmail, Designation,    CreateUser, CreateDate, ModifyUser, ModifyDate, IsActive)   output inserted.UserProfileId into @output   values (    @firstname,    '',    @lastname,    0, 1, 0,    @keycode,    ISNULL(@Username, CONCAT(@FirstName, @LastName)), @Email, @Designation,    @createuser, GETDATE(), @createuser, GETDATE(), 1   )   set @userprofileid = (select top 1 id from @output)   delete from @output     -- Add user group   insert into auth.UserProfileGroups(UserGroupId, UserProfileId, CreateUser, CreateDate, ModifyUser, ModifyDate, IsActive)   values (    @usergroupid,    @userprofileid,    @createuser, GETDATE(), @createuser, GETDATE(), 1   )     -- Add user settings   insert into auth.UserProfileSettings(UserProfileId, SettingName, SettingValue, CreateUser, CreateDate, ModifyUser, ModifyDate, IsActive)   values (    @userprofileid,    'Roles',    '["'+ cast(@appmoduleroleid as varchar) +'"]',    @createuser, GETDATE(), @createuser, GETDATE(), 1   )     if     (     @LocationId IS NULL      OR (      select count(*) from provider.providerlocations where locationid in (       select cast([Name] as varchar(10)) from [catalog].[splitstring](@LocationId)       ) and IsActive = 1     ) > 0    )    and (select count(*) from provider.providerprofiles where providerid in (     select cast(TRIM([Name]) as bigint) from [catalog].[splitstring](@ProviderId)     ) and IsActive = 0) = 0    and (     @LocationId IS NULL      OR (      select count(*) from provider.locations where locationid in (       select cast([Name] as varchar(10)) from [catalog].[splitstring](@LocationId)      ) and I
CREATE PROCEDURE [survey].[GetAdditionalQuestionAndAnswers]     AS  BEGIN   SELECT row_number() over(order by QA.AnswerId) ID, QA.QuestionId, Q.Question, QA.AnswerId, A.Answer,Q.CreateDate,Q.CreateUser,Q.ModifyDate,Q.ModifyUser FROM     [survey].[ServeyQuestionsandAnswers] QA     inner join [survey].[SurveyQuestions] Q ON QA.QuestionId = Q.QuestionId     inner join [survey].[SurveyAnswers] A ON QA.AnswerId = A.AnswerId    END  
CREATE PROCEDURE [uofm].[UOM_elig_file_load_ssis_sp_merge]   @Client_Name varchar(20)  AS      IF @Client_Name = 'ELIG_UM'    BEGIN      BEGIN TRY       BEGIN TRANSACTION UOM_elig_file_load_ssis       EXEC [uofm].[UOM_elig_file_load_ssis_sp_merge_stg_to_uofm]       EXEC [uofm].[UOM_elig_file_load_ssis_sp_merge_uofm_to_masters]        COMMIT TRANSACTION UOM_elig_file_load_ssis      PRINT 'SUCCESS'    END TRY      BEGIN CATCH    DECLARE @ErrorMessage NVARCHAR(4000);      DECLARE @ErrorSeverity INT;      DECLARE @ErrorState INT;        SELECT        @ErrorMessage = ERROR_MESSAGE(),       @ErrorSeverity = ERROR_SEVERITY(),       @ErrorState = ERROR_STATE();        IF (@@TRANCOUNT > 0)    BEGIN     ROLLBACK TRANSACTION UOM_elig_file_load_ssis     RAISERROR(@ErrorMessage,@ErrorSeverity,@ErrorState);     PRINT 'FAILED'    END      END CATCH      END  
    -- EXEC [uofm].[UOM_elig_file_load_ssis_sp_merge_uofm_to_masters]    CREATE PROCEDURE [uofm].[UOM_elig_file_load_ssis_sp_merge_uofm_to_masters]  AS      BEGIN     BEGIN TRY   BEGIN TRANSACTION UOM_ELIG_MERGE_uofm_to_masters            DECLARE @sys_usr CHAR(30)           ,@sys_date DATETIME;        SET @sys_usr = SYSTEM_USER    SET @sys_date = CAST(GETDATE() AT TIME ZONE 'UTC' AT TIME ZONE 'Eastern Standard Time' AS DATETIME);  -- Time in EST      -- drop not null record insert constraint (unique index) on NHMemberID in master.members before inserting new members or updating NHMemberID for new records inserted    --ALTER TABLE [otc].[Cards] DROP CONSTRAINT [FK_Cards_NHMemberId]        --ALTER TABLE [Master].[Members] DROP CONSTRAINT [IX_Members_NHMemberID_U]      DROP TABLE IF EXISTS #temp_elig_UOM_TMembers      select *,'ELIG' + convert(VARCHAR, NEXT VALUE FOR [elig].[NHMemberIDSeq]) Temp_NHMemberID    into #temp_elig_UOM_TMembers     from uofm.UMmembers     where 1=1    and tobeprocessed = 'Y'        merge into master.members d    using (select * from #temp_elig_UOM_TMembers) s    on (d.memberid = s.mastermemberid )    when matched then     update set    d.EligFile = 'ELIG_UM',    d.eligFileID = s.ID,    d.datasource = 'ELIG_UM',    d.DateOfBirth = s.MembersDateOfBirth,    d.FirstName = s.MemberFirstName,    d.Gender = s.MemberSex,    d.IsActive = 1,    d.LastName = s.MemberLastName,    d.MiddleInitial = s.MemberMiddleName,    d.ModifyDate = @sys_date,    d.ModifyUser = @sys_usr    when not matched then     insert     ( EligFile, EligFileID, DataSource, CreateDate, CreateUser,     DateOfBirth, FirstName, Gender, IsActive,NHMemberID, LastName,     MiddleInitial, ModifyDate, ModifyUser )      values      ('ELIG_UM',ID,'ELIG_UM',@sys_date,@sys_usr    ,MembersDateOfBirth,MemberFirstName    ,MemberSex,1    ,Temp_NHMemberID --  temp value later will be updated to what ever it should be    ,MemberLastName    ,MemberMiddleName,@sys_date,@sys_usr);      -- Assign mastermemberid in uofm after inserting new records into master.members    update a     set mastermemberid = (select memberid from master.members m where m.EligFileID = a.id and m.EligFile = 'ELIG_UM')    from uofm.UMmembers a    where tobeprocessed = 'Y'    and mastermemberid is null            -- Update NHMemberID for newly inserted members     UPDATE [Master].[Members]    SET nhmemberid = 'NH'+RIGHT(YEAR(GETDATE()),4)+ FORMAT(memberid,'00000000')        --    'NH2018'+ FORMAT(memberid,'00000000')    WHERE EligFile = 'ELIG_UM'    AND nhmemberid Like 'ELIG%'      /*    -- Re create the unique NHMemberID index    ALTER TABLE [Master].[Members] ADD  CONSTRAINT [IX_Members_NHMemberID_U] UNIQUE NONCLUSTERED       (       [NHMemberID] ASC      )      ALTER TABLE [otc].[Cards]  ADD  CONSTRAINT [FK_Cards_NHMemberId] FOREIGN KEY    (     [NHMemberId]    )    REFERENCES [Master].[Members] ([NHMemberID])    */      -- Assign mastermemberid to uofm records from members joining on NHLinkID      update i    set mastermemberid = (select mastermemberid from uofm.UMMembers m where m.NHLinkID = i.NHLinkID )    from uofm.UMInsurance i    where exists (select 1 from uofm.UMmembers m1 where m1.NHLinkID = i.NHLinkID)    and mastermemberid is null       -- Update address    merge master.addresses d    using (select * from uofm.UMmembers where tobeprocessed = 'Y' and MemberAddressLine1 <> '') s    on (d.memberid = s.mastermemberid and d.AddressTypeCode = 'PERM')    when matched then    update set    Address1 = s.MemberAddressLine1    ,Address2 = s.MemberAddressLine2    ,City = s.MemberCityName    ,State = s.MemberStateName    ,ZipCode = s.MemberZipCode    ,IsActive = 1    ,IsPreferredAddress = 1    ,MemberID = s.mastermemberid    ,ModifyDate = @sys_date    , ModifyUser = @sys_usr    when not matched then     insert     ( Address1,Address2,AddressTypeCode,City,State,ZipCode    ,EffectiveFromDate,EffectiveToDate,IsActive,IsPreferredAddress,MemberID    ,CreateDate,CreateUser,ModifyDate, ModifyUser
    -- EXEC [uofm].[UOM_elig_file_load_ssis_sp_merge_stg_to_uofm]    CREATE PROCEDURE [uofm].[UOM_elig_file_load_ssis_sp_merge_stg_to_uofm]  AS      BEGIN     --BEGIN TRY   --BEGIN TRANSACTION UOM_ELIG_MERGE_stg_to_uofm            DECLARE @sys_usr CHAR(30)           ,@sys_date DATETIME;        SET @sys_usr = SYSTEM_USER    SET @sys_date = CAST(GETDATE() AT TIME ZONE 'UTC' AT TIME ZONE 'Eastern Standard Time' AS DATETIME);  -- Time in EST      DROP TABLE IF EXISTS uofm.DataViewUMMembers              DROP TABLE IF EXISTS uofm.DataVUMMemNotRcvd      DROP TABLE IF EXISTS uofm.DataVUMIns              DROP TABLE IF EXISTS uofm.DataVUMInsNotRcvd        --create index UMstgeligdata_idx4 on uofm.UMStgEligData (memberidentificationnumber)      -- Update phonenumbers by removing chars    UPDATE uofm.UMStgEligData    SET memberPhoneNumber = dbo.fn_extract_numbers_Only(MemberPhoneNumber)    WHERE LEN(MemberPhoneNumber) <> 10        SELECT *     INTO uofm.DataViewUMMembers     FROM uofm.ViewUMMembers       CREATE INDEX dataview_idx1 ON uofm.DataViewUMMembers(NHLinkID)       SELECT *     INTO uofm.DataVUMMemNotRcvd     FROM uofm.ViewUMMemNotRcvd n     WHERE not exists (select 1 from uofm.DataViewUMMembers d where d.NHLinkID = n.NHLinkID)       create index dataview_idx2 on uofm.DataVUMMemNotRcvd (NHLinkID)      ----------------------------------------------------------------------------------------------      select *     into uofm.DataVUMIns     from uofm.ViewUMInsurance      create index dataview_idx3 on uofm.DataVUMIns(NHLinkID)       select *     into uofm.DataVUMInsNotRcvd     from uofm.ViewUMInsNotRcvd n     where not exists (select 1 from uofm.DataVUMIns d where d.NHLinkID = n.NHLinkID and d.EligibilityEffectiveDate = n.EligibilityEffectiveDate)      create index dataview_idx4 on uofm.DataVUMInsNotRcvd (NHLinkID,EligibilityEffectiveDate) --@@          -- Set all records not to be processed    UPDATE     uofm.UMmembers    SET ToBeProcessed = 'N'     where ToBeProcessed = 'Y' --@@      UPDATE     uofm.UMinsurance    SET ToBeProcessed = 'N'    where ToBeProcessed = 'Y'      -- Insert if there are any new members or update any changes to existing members    MERGE uofm.UMmembers m USING uofm.DataViewUMMembers d    ON (m.NHLinkID = d.NHLinkID)    WHEN MATCHED THEN    UPDATE SET    MemberIdentificationNumber = d.MemberIdentificationNumber,    MembersDateOfBirth = d.MembersDateOfBirth,    MemberLastName = d.MemberLastName,    MemberFirstName = d.MemberFirstName,    MemberMiddleName = d.MemberMiddleName,    MemberPhoneNumber = d.MemberPhoneNumber,    MemberAddressLine1 = d.MemberAddressLine1,    MemberAddressLine2 = d.MemberAddressLine2,    MemberCityName = d.MemberCityName,    MemberStateName = d.MemberStateName,    MemberZipCode = d.MemberZipCode,    MemberDateOfDeath = d.MemberDateOfDeath,    MemberSex = d.MemberSex,    MemberRace = d.MemberRace,    MemberLanguage = d.MemberLanguage,    MemberMailingAddressLine1 = d.MemberMailingAddressLine1,    MemberMailingAddressLine2 = d.MemberMailingAddressLine2,    MemberMailingCityName = d.MemberMailingCityName,    MemberMailingStateName = d.MemberMailingStateName,    MemberMailingZipCode = d.MemberMailingZipCode,    statusflag = 'U',    tobeprocessed = 'Y',    ModifyDate = @sys_date,    ModifyUser = @sys_usr    WHEN NOT MATCHED THEN    INSERT (    NHLinkID,    MemberIdentificationNumber,    MembersDateOfBirth,    MemberLastName,    MemberFirstName,    MemberMiddleName,    MemberPhoneNumber,    MemberAddressLine1,    MemberAddressLine2,    MemberCityName,    MemberStateName,    MemberZipCode,    MemberDateOfDeath,    MemberSex,    MemberRace,    MemberLanguage,    MemberMailingAddressLine1,    MemberMailingAddressLine2,    MemberMailingCityName,    MemberMailingStateName,    MemberMailingZipCode,    statusflag,    tobeprocessed,    CreateUser,    ModifyDate,    ModifyUser)    VALUES (    d.NHLinkID,    d.MemberIdentificationNumber,    d.MembersDateOfBirth,    d.MemberLastName,    d.MemberFirstName,  
