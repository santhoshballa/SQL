create procedure [accounts].[DeleteExceptionsAndInit](
	@InvoiceNbr nvarchar(1000)
	)
	as
	begin
		delete from [accounts].[InvoiceExceptions] where InvoiceNumber in (select value from openjson(@InvoiceNbr) with (value nvarchar(20) '$'));
		delete from [accounts].[InvoicesInit] where InvoiceNumber in (select value from openjson(@InvoiceNbr) with (value nvarchar(20) '$'));
	end
create PROCEDURE [accounts].[GetVendorAddress](@BrandCode NVARCHAR(30)) 
AS
BEGIN
SELECT BrandName,BrandAddress1,BrandAddress2,BrandCity,BrandState,BrandZipCode  FROM [catalog].[Brands] WHERE BrandCode = @BrandCode
END
CREATE PROCEDURE [accounts].[sp_GetBatchInvoiceIdsAuth]
(
    @BatchIds NVARCHAR(200),
	@VendorType NVARCHAR(10)
)
AS
BEGIN
DECLARE @sqlq NVARCHAR(MAX);
set @sqlq = 'select distinct inv.InvoiceId as InvoiceId from [accounts].[Invoices] as inv 
inner join [orders].[OrderTransactionDetails] ot ON inv.OrderID = ot.OrderID INNER JOIN [orders].[orders] o on o.OrderID = ot.OrderID
inner join [accounts].[InvoiceItems] invitem 
on inv.InvoiceId = invItem.InvoiceId
where inv.BatchID in (select value from openjson('''+@BatchIds+''') with (value nvarchar(20) ''$'')) and (inv.VendorType = '''+@VendorType+''') and inv.[Status] = ''Approval'''
EXEC sp_executesql @sqlq;
END

create PROCEDURE [accounts].[sp_PendingApprovalInvoices]
(
	@ProviderId BIGINT,
	@VendorType nvarchar(10)
)
AS
BEGIN
SELECT ROW_NUMBER() OVER (ORDER BY r.BatchID) AS RowID,r.* from (
	select distinct inv.BatchID,a.CreateUser AS ApprovedBy,CONVERT(VARCHAR, a.CreateDate, 110) As ApprovedDate,
	[dbo].[fn_GetInvoiceCount](inv.BatchID,@VendorType) AS 'InvoiceCount',[dbo].[fn_GetInvoiceAmount](inv.BatchID,@VendorType) AS 'Total'
	FROM [accounts].[invoices] AS inv
	INNER JOIN (SELECT * FROM accounts.InvoiceTransactions AS it WHERE it.[Status]='Approval' AND it.IsActive=1) AS invt
	ON inv.InvoiceId = invt.InvoiceId INNER JOIN provider.providerprofiles AS pp
	ON inv.ProviderId = pp.ProviderId INNER JOIN [accounts].[BatchRequests] a ON a.BatchID = inv.BatchID	
	WHERE (inv.VendorType=@VendorType)  AND inv.[Status]='Approval' AND a.BatchType = 'APPROVAL' AND inv.ProviderId IS NOT NULL 
	GROUP BY inv.BatchID,a.CreateUser,a.CreateDate)r
--IF(@ProviderId > 0)
--	BEGIN
--	SELECT ROW_NUMBER() OVER (ORDER BY inv.ProviderId) AS RowID,inv.ProviderId,pp.ProviderName AS 'ProviderName',
--	COUNT(*) AS 'InvoiceCount',CAST(SUM(inv.InvoiceAmount - ISNULL(JSON_VALUE(invt.TransactionData, '$.fee'), 0)) AS FLOAT) AS 'Total',
--	inv.BatchID,a.CreateUser AS ApprovedBy,CONVERT(VARCHAR, a.CreateDate, 101) AS ApprovedDate
--	FROM [accounts].[invoices] as inv
--	INNER JOIN (SELECT * FROM accounts.InvoiceTransactions AS it WHERE it.[Status]='Approval' AND it.IsActive=1) AS invt
--	ON inv.InvoiceId = invt.InvoiceId
--	INNER JOIN provider.providerprofiles AS pp
--	ON inv.ProviderId = pp.ProviderId
--	INNER JOIN [accounts].[BatchRequests] a ON a.BatchID = inv.BatchID	
--	WHERE inv.VendorType='PRO' AND inv.[Status]='Approval' AND a.BatchType = 'APPROVAL' 
--	AND inv.ProviderId IS NOT NULL AND  inv.ProviderId = @ProviderId 
--	GROUP BY inv.ProviderId,pp.ProviderName,inv.BatchID,a.CreateUser,a.CreateDate
--	END
--ELSE
--	BEGIN
--	SELECT ROW_NUMBER() OVER (ORDER BY inv.ProviderId) AS RowID,inv.ProviderId,pp.ProviderName AS 'ProviderName',
--	COUNT(*) AS 'InvoiceCount',CAST(SUM(inv.InvoiceAmount - ISNULL(JSON_VALUE(invt.TransactionData, '$.fee'), 0)) AS FLOAT) AS 'Total',
--	inv.BatchID,a.CreateUser AS ApprovedBy,CONVERT(VARCHAR, a.CreateDate, 101) As ApprovedDate
--	FROM [accounts].[invoices] AS inv
--	INNER JOIN (SELECT * FROM accounts.InvoiceTransactions AS it WHERE it.[Status]='Approval' AND it.IsActive=1) AS invt
--	ON inv.InvoiceId = invt.InvoiceId INNER JOIN provider.providerprofiles AS pp
--	ON inv.ProviderId = pp.ProviderId INNER JOIN [accounts].[BatchRequests] a ON a.BatchID = inv.BatchID	
--	WHERE inv.VendorType='PRO' AND inv.[Status]='Approval' AND a.BatchType = 'APPROVAL' AND inv.ProviderId IS NOT NULL 
--	GROUP BY inv.ProviderId,pp.ProviderName,inv.BatchID,a.CreateUser,a.CreateDate
--	END
END

CREATE PROCEDURE [accounts].[MoveInvoiceanditsItemsToHistory] (@PONumber nvarchar(20))
AS
BEGIN

Declare @sourceID bigint;
set @sourceID = 0;
Declare @InvoiceID bigint;
set @InvoiceID = 0;
Declare @invoiceIDOriginalTable bigint;
set @invoiceIDOriginalTable = 0;

BEGIN TRAN

BEGIN TRY

 set @sourceID = (select SourceID FROM [accounts].[Invoices] WHERE PONumber IN (LTRIM(RTRIM(@PONumber))));
 
 

 set @invoiceIDOriginalTable = (select InvoiceID FROM [accounts].[Invoices] WHERE PONumber IN (LTRIM(RTRIM(@PONumber))));


 insert into [accounts].[InvoicesHistory] select [Source],[SourceId],[VendorType],[PONumber],[InvoiceNumber],[InvoiceDate],[InvoiceDueDate],[InvoiceAmount],[ProviderData],[PaymentData],[ProviderId],[BrandCode],[OrderID],[ShippingData],[BatchId],[Status],[Remarks],[IsDocsSubmitted],[CreateUser],[CreateDate],[ModifyUser],[ModifyDate],[IsActive],[PaymentMethod],[VendorAccountId] from [accounts].[Invoices] where PONumber IN (LTRIM(RTRIM(@PONumber)));

 set @InvoiceID = (select top 1 InvoiceID from [accounts].[InvoicesHistory] where SourceID = @sourceID and PONumber in (LTRIM(RTRIM(@PONumber))));

 insert into [accounts].[InvoiceItemsHistory] select @InvoiceID,[ItemCode],[ItemDescription],[Modifier],[Quantity],[Cost],[ItemData],[ItemDetailsData],[CreateUser],[CreateDate],[ModifyUser],[ModifyDate],[IsActive] from [accounts].[InvoiceItems] where invoiceID  = @invoiceIDOriginalTable;
 
 delete from [accounts].[InvoiceItems] where invoiceID = @invoiceIDOriginalTable;
 delete from [accounts].[Invoices] where invoiceID = @invoiceIDOriginalTable;
 

 
   COMMIT TRAN
   return 1;

END TRY
BEGIN CATCH
  
  ROLLBACK TRAN
  return 0;
END CATCH


END


CREATE procedure [accounts].[GetMissingInvoices](
 @orderItemIds nvarchar(max) = '[]'
,@itemData nvarchar(max) = '[]'
)
as   
begin
if (@orderItemIds is not null and @orderItemIds <> '')
begin
	declare @UploadInvoices table(
		InvoiceDate date,
		OrderItemId bigint,
		PODate date
	);
	insert into @UploadInvoices
	select * from openjson(@orderItemIds)
	with (
	InvoiceDate date '$.invDate',
	OrderItemId bigint '$.itemId',
	PODate date '$.poDate'
	);
	select
	it.[ItemCode] as ItemCode
	,it.[ItemData] as ItemData
	,it.OrderItemId
	,cast(o.[OrderId] as nvarchar) as OrderId
	,it.[BrandCode] as BrandCode
	,json_value(o.[ProviderData], '$.providerId') as ProviderID
	,json_value(o.[ShippingData], '$.locationId') as LocationId
	,cast(it.[Quantity] as nvarchar) as Quantity
	,json_value(it.[ItemData], '$.color') as Color
	,json_value(it.[ItemData], '$.batterySize') as BatterySize
	,case when it.ItemType = 'EM' 
		then null 
		else [dbo].[getunitPriceofItem](
			po.PODate
			,it.[ItemCode]
			,ihp.[IsMedicaid]
			,ic.[InsuranceCarrierName] 
			) end UnitPrice
	,cast(case sf.[ShippingAmount] when 0 then null else sf.[ShippingAmount] end as nvarchar) as ShippingFee
	,null as SalesTax
	,case when o.Source = 'VS' then po.OrderPORefNbr else  po.PONumber end as [NationsHearingPO]
	,case when st.[SalesTaxPercentage] is not null then cast(st.[SalesTaxPercentage] as nvarchar) else null end as SalesTaxPercent
	,case when it.ItemType = 'EM' 
		then null 
		else [dbo].[getPriceTypeofItem](
			po.PODate
			,it.[ItemCode]
			,ihp.[IsMedicaid]
			,ic.[InsuranceCarrierName] 
			) end PriceType
	from 
	[Orders].[OrderItems] it

	inner join [Orders].[Orders] o
	on it.[OrderId] = o.[OrderId]

	inner join [Orders].[OrderPOs] po
	on o.OrderID = po.OrderId

	inner join [Insurance].[InsuranceCarriers] ic
	on ic.[InsuranceCarrierID]=json_value(o.[MemberData], '$.insCarrierId')

	inner join [Insurance].[InsuranceHealthPlans] ihp
	on ihp.[InsuranceHealthPlanID]=json_value(o.[MemberData], '$.insPlanId')

	inner join @UploadInvoices up
	on up.OrderItemId = it.OrderItemId

	left join [catalog].[BrandShippingFees] sf
	on it.[BrandCode] is not null and sf.[BrandCode] = it.[BrandCode] and sf.[ISACTIVE]=1

	left join [catalog].[BrandSalesTax] st
	on st.[BrandCode] = it.[BrandCode] and st.[IsActive]=1 and st.[StateCode] = json_value(o.[ShippingData], '$.address.state')

	where it.[IsActive]=1
	--and it.OrderItemId in (select * from openjson(@orderItemIds) with (OrderItemId bigint '$'))

end
else if(@itemData is not null and @itemData <> '')
begin
	declare @UploadInvoices1 table(
		PONumber nvarchar(100),
		InvoiceNumber nvarchar(20),
		ItemCode nvarchar(100),
		Modifier nvarchar(5),
		InvoiceDate date,
		PODate date
	);
	insert into @UploadInvoices1
	select * from openjson(@itemData)
	with (
	PONumber nvarchar(100) '$.po',
	InvoiceNumber nvarchar(20) '$.inv',
	ItemCode nvarchar(100) '$.it',
	Modifier nvarchar(5) '$.mod',
	InvoiceDate date '$.invDate',
	PODate date '$.poDate'
	);
	select
	 cast(it.[OrderItemId] as nvarchar) as OrderItemId
	,it.[ItemCode] as ItemCode
	,it.[Modifier] as Modifier
	,cast(it.[PONumber] as nvarchar) as NationsHearingPO
	,it.[InvoiceNumber] as InvoiceNumber
	,convert(nvarchar, up.InvoiceDate, 110) as InvoiceDate
	,case
		when bp.MonthNo is null then 
			convert(nvarchar, dateadd(day, bp.DayNo, up.InvoiceDate), 110)
		else
			concat(substring(concat('0', month(dateadd(month, bp.MonthNo, up.InvoiceDate))), len(concat('0', month(dateadd(month, bp.MonthNo, up.InvoiceDate)))-1), 2), '-', substring(concat('0', bp.DayNo), len(concat('0', bp.DayNo))-1, 2), '-', year(dateadd(month, bp.MonthNo, up.InvoiceDate)))
		end
	as DueDate
	
	,null as PartNo
	,null as SN
	,null as RepairWarrantyEnds
	,null as LnDWarrantyEnds
	,null as Supplies
	,null as RemakeWarrantyEnd
	,null as ReceiverDetails
	,it.[ItemType] as ItemType
	,null as Remarks
	,null as Source
	,null as SourceID
	,it.[ItemData] as ItemData
	,cast(it.[Amount] as nvarchar) as ItemCost
	,cast(o.[OrderId] as nvarchar) as OrderId
	,it.[BrandCode] as BrandCode
	,it.[ProductModelCode] as ModelCode
	,json_value(o.[ProviderData], '$.providerId') as ProviderID
	,json_value(o.[ShippingData], '$.locationId') as LocationId
	
	,convert(varchar, pos.[CreateDate], 110) as OrderDate
	,json_value(o.[ShippingData], '$.dispenser') as GAcctNumber
	,cast(it.[Quantity] as nvarchar) as Quantity
	,it.[ProductModelCode] as ProductDescription
	,concat(json_value(o.[MemberData], '$.firstName'), ' ', json_value(o.[MemberData], '$.lastName')) as PatientName
	,json_value(it.[ItemData], '$.color') as Color
	,json_value(it.[ItemData], '$.batterySize') as BatterySize
	
    ,case when it.ItemType = 'EM' 
		then null 
		else [dbo].[getunitPriceofItem](
			(select JSON_VALUE(OrderTransactionData, '$.poDate') from orders.OrderTransactionDetails where orderid = it.orderid and OrderStatusCode = 'PO' and ISJSON(OrderTransactionData) = 1)
			,it.[ItemCode]
			,ihp.[IsMedicaid]
			,ic.[InsuranceCarrierName] 
			) end UnitPrice
	,case when it.ItemType = 'EM' 
		then null 
		else [dbo].[getTotalInvoiceAmount](
			it.[Quantity]
			,(select JSON_VALUE(OrderTransactionData, '$.poDate') from orders.OrderTransactionDetails where orderid = it.orderid and OrderStatusCode = 'PO' and ISJSON(OrderTransactionData) = 1)
			,it.[ItemCode]
			,ihp.[IsMedicaid]
			,ic.[InsuranceCarrierName] )  end TotalInvoiceAmount
	
	,json_value(o.[ProviderData], '$.providerLeagalBusinessName') as ProviderBusinessName
	,json_value(o.[ProviderData], '$.address.address1') as ProviderAddress
	,json_value(o.[ProviderData], '$.address.city') as City
	,json_value(o.[ProviderData], '$.address.state') as ST
	,json_value(o.[ProviderData], '$.address.zip') as Zip

	,json_value(o.[ShippingData], '$.providerBusinessName') as ShipToName
	,json_value(o.[ShippingData], '$.address.address1') as ShipToAddress
	,json_value(o.[ShippingData], '$.address.city') as ShipToCity
	,json_value(o.[ShippingData], '$.address.state') as ShipToST
	,json_value(o.[ShippingData], '$.address.zip') as ShipToZip
	,null as ShipDate
	,null as ShipMethod
	,null as TrackingNumber
	,cast(case sf.[ShippingAmount] when 0 then null else sf.[ShippingAmount] end as nvarchar) as ShippingFee
	,case st.[SalesTaxPercentage] when null then null when 0 then null else cast(st.[SalesTaxPercentage]*it.[Quantity]*cp.[PerDeviceCOGSPrice]/100 as nvarchar) end as SalesTax
	from 
	[Orders].[OrderItems] it

	inner join [Orders].[Orders] o
	on it.[OrderId] = o.[OrderId]

	inner join [Orders].[OrderTransactionDetails] ot
	on ot.[OrderId] = o.[OrderId] and ot.[OrderStatusCode]='PO' and ot.IsActive=1

	inner join [Insurance].[InsuranceCarriers] ic
	on ic.[InsuranceCarrierID]=json_value(o.[MemberData], '$.insCarrierId')

	inner join [Insurance].[InsuranceHealthPlans] ihp
	on ihp.[InsuranceHealthPlanID]=json_value(o.[MemberData], '$.insPlanId')

	inner join [Orders].[OrderPOs] pos
	on it.PONumber = pos.PONumber

	
	inner join @UploadInvoices1 up
	on up.PONumber = it.PONumber and up.ItemCode like '%'+it.ItemCode +'%' and it.InvoiceNumber is null
	
	left join [Insurance].[HealthPlanContracts] hpc
	on hpc.[InsuranceCarrierID]=json_value(o.[MemberData], '$.insCarrierId') and hpc.[InsuranceHealthPlanID]=json_value(o.[MemberData], '$.insPlanId') and hpc.[EffectiveFromDate] <= getdate() and hpc.[EffectiveToDate] >= getdate()
	--------------Changes (Chandra)
	left join [Insurance].[ContractProducts] cp
	--on cp.[FamilyProductCode] = it.[TechnologyLevelCode] and cp.[HealthPlanContractID] = hpc.[HealthPlanContractID]
	on cp.[ItemCode] = it.[ItemCode] and cp.[HealthPlanContractID] = hpc.[HealthPlanContractID]

	left join [catalog].[BrandPaymentTerms] bp
	on bp.BrandCode = it.BrandCode and bp.ItemType = it.ItemType and bp.IsActive=1

	left join [catalog].[BrandShippingFees] sf
	on it.[BrandCode] is not null and sf.[BrandCode] = it.[BrandCode] and sf.[ISACTIVE]=1

	left join [catalog].[BrandSalesTax] st
	on st.[BrandCode] = it.[BrandCode] and st.[IsActive]=1 and st.[StateCode] = json_value(o.[ShippingData], '$.address.state')

	where it.[IsActive]=1
end
end


CREATE procedure [accounts].[GetPOs](
	@PONumbers nvarchar(max)
)
as
begin
		select pos.*
		,(select PODate from (select *  from openjson(tr.ordertransactiondata)
		with (PODate date '$.poDate', PONumber nvarchar(50) '$.poNumber')) res
		where PONumber=cast(pos.PONumber as nvarchar)) as PODate
		--,(select top (1) cast(json_value(tr.ordertransactiondata, '$.poDate') as date) from orders.ordertransactiondetails tr where tr.orderid=pos.orderid and tr.orderstatuscode='PO' and tr.isactive=1 and tr.iscomplete=1) as PODate
		from Orders.OrderPOs pos
		left join Orders.OrderTransactionDetails tr
		on tr.OrderId = pos.OrderId and tr.orderstatuscode='PO'
		and tr.IsComplete=1 and tr.IsActive=1
		where pos.IsActive=1 and
		cast(pos.PONumber as nvarchar) in (select value from openjson(@PONumbers) with (value nvarchar(15) '$'));
end 



 CREATE PROCEDURE [accounts].[sp_GetPendingApprovalInvoicesByProvider]
(
	@ProviderId BIGINT,
	@VendorType nvarchar(10)
)
AS
BEGIN

select ROW_NUMBER() OVER (ORDER BY r.InvoiceID) AS RowID, r.* from
(SELECT distinct pp.ProviderName AS 'ProviderName',inv.InvoiceID,
JSON_VALUE(iit.[ItemData], '$.nhMemberId') AS 'NHMemberID',inv.PONumber,JSON_VALUE(iit.[ItemData], '$.orderStatus') AS 'OrderStatus',
JSON_VALUE(iit.[ItemData], '$.fittingDate') AS 'FittingDate',
JSON_VALUE(iit.[ItemData], '$.memberFirstName')  + ' ' +  JSON_VALUE(iit.[ItemData], '$.memberLastName') AS 'MemberName',
CAST(JSON_VALUE(iit.[ItemData], '$.dispensingFee') AS FLOAT) AS 'DispensingFee',CAST(InvoiceAmount AS FLOAT) AS InvoiceAmount,
CAST(0 AS FLOAT) AS Credit,
(InvoiceAmount - CAST(ISNULL(JSON_VALUE(invt.[TransactionData], '$.fee'), 0) AS FLOAT) - CAST(0 AS FLOAT)) AS InvoicesSelected,BatchID
FROM [accounts].[invoices] AS inv INNER JOIN [accounts].[InvoiceItems] iit on inv.InvoiceId = iit.InvoiceId
INNER  JOIN (SELECT * FROM accounts.InvoiceTransactions AS it WHERE it.[Status]='Approval' AND it.IsActive=1) AS invt
ON inv.InvoiceId = invt.InvoiceId INNER JOIN provider.providerprofiles AS pp ON inv.ProviderId = pp.ProviderId	
WHERE (inv.VendorType=@VendorType) AND inv.[Status]='Approval' AND inv.ProviderId IS NOT NULL AND inv.BatchID IS NOT NULL)r
--AND inv.ProviderId IS NOT NULL AND inv.ProviderId = @ProviderId) r


--SELECT ROW_NUMBER() OVER (ORDER BY inv.InvoiceID) AS RowID,pp.ProviderName AS 'ProviderName',inv.InvoiceID,
--JSON_VALUE(iit.[ItemData], '$.nhMemberId') AS 'NHMemberID',inv.PONumber,JSON_VALUE(iit.[ItemData], '$.orderStatus') AS 'OrderStatus',
--JSON_VALUE(iit.[ItemData], '$.fittingDate') AS 'FittingDate',
--JSON_VALUE(iit.[ItemData], '$.memberFirstName')  + ' ' +  JSON_VALUE(iit.[ItemData], '$.memberLastName') AS 'MemberName',
--CAST(JSON_VALUE(iit.[ItemData], '$.dispensingFee') AS FLOAT) AS 'DispensingFee',CAST(InvoiceAmount AS FLOAT) AS InvoiceAmount,
--CAST(0 AS FLOAT) AS Credit,
--(InvoiceAmount - CAST(ISNULL(JSON_VALUE(invt.[TransactionData], '$.fee'), 0) AS FLOAT) - CAST(0 AS FLOAT)) AS InvoicesSelected,BatchID
--FROM [accounts].[invoices] AS inv INNER JOIN [accounts].[InvoiceItems] iit on inv.InvoiceId = iit.InvoiceId
--INNER  JOIN (SELECT * FROM accounts.InvoiceTransactions AS it WHERE it.[Status]='Approval' AND it.IsActive=1) AS invt
--ON inv.InvoiceId = invt.InvoiceId INNER JOIN provider.providerprofiles AS pp ON inv.ProviderId = pp.ProviderId	
--WHERE inv.VendorType='PRO' AND inv.[Status]='Approval' AND inv.ProviderId IS NOT NULL AND inv.ProviderId = @ProviderId
END
CREATE PROCEDURE [accounts].[GetLSNDWarrantyDate](@OrderID BIGINT, @Type varchar(10) = 'DEFAULT')
AS
BEGIN
if(@Type = 'INVOICE')
begin
 SELECT  top (1) 1 AS ID, CAST(JSON_VALUE(ItemDetailsData, '$.lnDWarrantyEndDate') AS DATE) AS 'WarrantyEndDate' FROM [accounts].[InvoiceItems] WHERE JSON_VALUE(ItemData, '$.orderId') = @OrderID and IsActive=1
end
else if(@Type ='DEFAULT')
begin
 SELECT top (1)  1 as ID, 
 (select res.PODate from (select *  from openjson(tr.ordertransactiondata)
		with (PODate date '$.poDate', PONumber nvarchar(50) '$.poNumber')) res
		where res.PONumber=cast(it.PONumber as nvarchar)) as PODate
 FROM [Orders].[OrderItems] it
 inner join [catalog].[Brands] br
 on br.[BrandCode]=it.[BrandCode]
 inner join [Orders].[OrderTransactionDetails] tr
 on tr.[OrderId] = it.[OrderId] and tr.[OrderStatusCode]='PO'
 WHERE it.[OrderId] = @OrderID and it.IsActive=1
end
END
CREATE PROCEDURE [accounts].[sp_GetProviderInvoiceIds]
(
    @ProviderIds NVARCHAR(200),
	@ProviderLegalName NVARCHAR(100),
	@EffPOFromDate NVARCHAR(50),
	@EffPOToDate NVARCHAR(50),
	@DocsReceived NVARCHAR(5),
	@InvoiceStatuses_json NVARCHAR(50),
	@OrderStatuses_json NVARCHAR(50)
)
AS
BEGIN
DECLARE @sqlq NVARCHAR(2000);
SET @sqlq = 'select distinct inv.InvoiceId as InvoiceId from [accounts].[Invoices] as inv inner join [orders].[OrderTransactionDetails] ot ON inv.OrderID = ot.OrderID INNER JOIN [orders].[orders] o on o.OrderID = ot.OrderID
             inner join [accounts].[InvoiceItems] invitem 
             on inv.InvoiceId = invItem.InvoiceId
			join provider.ProviderProfiles as pp
			on (pp.IsActive = 1 and cast(json_value(inv.[ProviderData], ''$.providerId'') as bigint) = pp.ProviderId'
			+
			' and pp.ProviderId in (select value from openjson('''+@ProviderIds+''') with (value nvarchar(20) ''$''))'
			+
			' and pp.ProviderName like ''%%'''
			+
			')'
			+
			' where inv.VendorType = ''PRO'''
			+ CASE WHEN @InvoiceStatuses_json is not null and @InvoiceStatuses_json <> '' THEN 
			' and case when (inv.[Status]=''Initiated'' or (inv.[Status] = ''Approval'')) 
			then case when  InvoiceDueDate IS NOT NULL AND CONVERT(NVARCHAR,CAST(InvoiceDueDate AS DATE),111) < CONVERT(NVARCHAR, CAST(GETDATE() AS DATE),111) then ''Due'' else ''Open'' end else inv.Status end in (select value from openjson('''+@InvoiceStatuses_json+''') with (value nvarchar(20) ''$''))' else '' end
			+case when @OrderStatuses_json is not null and @OrderStatuses_json <> '' then  ' and o.Status in (select value from openjson('''+@OrderStatuses_json+''') with (value nvarchar(20) ''$''))' else '' end
			+
			case when @EffPOFromDate is not null and @EffPOFromDate != '' then ' and o.OrderStatusCode = ''PO'' and convert(nvarchar, cast(' + '''' +  @EffPOToDate + '''' + ' as date), 111) <= convert(nvarchar, cast(json_value(ot.[OrderTransactionData], ''$.poDate'') as date), 111)' else  '' end
			+
			case when @EffPOToDate is not null and @EffPOToDate != '' then ' and o.OrderStatusCode = ''PO'' and convert(nvarchar, cast(' + '''' + @EffPOToDate +  '''' + ' as date), 111)>= convert(nvarchar, cast(json_value(ot.[OrderTransactionData], ''$.poDate'') as date), 111)' else '' end
			+
			case when @DocsReceived = 'Yes' then ' and IsDocsSubmitted = 1' when  @DocsReceived = 'No' then ' and IsDocsSubmitted = 0' else '' end;
--print @sqlq
EXEC sp_executesql @sqlq;
END



CREATE PROCEDURE [accounts].[sp_GetProviderInvoiceIdsAuth]
(
    @ProviderIds NVARCHAR(200)
)
AS
BEGIN
DECLARE @sqlq NVARCHAR(MAX);
SET @sqlq = 'select distinct inv.InvoiceId as InvoiceId from [accounts].[Invoices] as inv inner join [orders].[OrderTransactionDetails] ot ON inv.OrderID = ot.OrderID INNER JOIN [orders].[orders] o on o.OrderID = ot.OrderID
             inner join [accounts].[InvoiceItems] invitem 
             on inv.InvoiceId = invItem.InvoiceId
			join provider.ProviderProfiles as pp
			on (pp.IsActive = 1 and cast(json_value(inv.[ProviderData], ''$.providerId'') as bigint) = pp.ProviderId'
			+
			' and pp.ProviderId in (select value from openjson('''+@ProviderIds+''') with (value nvarchar(20) ''$''))'
			+
			' and pp.ProviderName like ''%%'''
			+
			')'
			+
			' where (inv.VendorType = ''PRO'' or inv.VendorType = ''MFG'') and inv.[Status] = ''Approval'''
print @sqlq
EXEC sp_executesql @sqlq;
END
CREATE PROCEDURE [accounts].[UpdateInvoiceDocStatus]
(
  @OrderID bigint
)
AS
BEGIN
    update [accounts].[Invoices] set IsDocsSubmitted = 1 where orderId = @OrderID
END

CREATE PROCEDURE [accounts].[GetCOGSPrice](@InsuranceCarrierID BIGINT, @InsuranceHealthPlanID BIGINT, @FamilyProductCode NVARCHAR(50))
AS
BEGIN
SELECT PerDeviceCOGSPrice AS Amount 
FROM [insurance].[ContractProducts]
WHERE HealthPlanContractID IN 
							(SELECT TOP 1 HealthPlanContractID 
							FROM [insurance].[HealthPlanContracts] 
							WHERE InsuranceCarrierID = @InsuranceCarrierID AND InsuranceHealthPlanID  = @InsuranceHealthPlanID) 
AND FamilyProductCode = @FamilyProductCode
END

CREATE procedure [accounts].[UpdateInvoiceNumbers]
(
    @input nvarchar(max)
)
as
begin
--declare @input nvarchar(2000);
--set @input = '[{"itmId": 15601, "inv": "14-A577095","modifyUser":"testraju"}]';
declare @UpdateInvoices table(
	OrderItemId bigint,
	InvoiceNumber nvarchar(100),
	ModifyUser nvarchar(50)
);
insert into @UpdateInvoices
select * from openjson(@input)
with (
	OrderItemId bigint '$.itmId',
	InvoiceNumber nvarchar(100) '$.inv',
	ModifyUser nvarchar(50) '$.modifyUser'
);
update it
set invoicenumber = up.InvoiceNumber, ModifyUser= up.ModifyUser ,ModifyDate=getdate()
from orders.orderitems it
inner join @UpdateInvoices up
on it.OrderItemId = up.OrderItemId
end

CREATE procedure [accounts].[GetPODetails](
	@po bigint
	)
	as
	begin
	select top 1 att.[MailHistoryAttachmentId] as ID, pos.OrderId as OrderId, att.[MailAttachmentData] as PODocument, att.[MailAttachmentName] as DocumentName
       from [contact].[MailHistoryAttachments] att
       inner join orders.orderpos pos
       on pos.[MailHistoryAttachmentId] = att.[MailHistoryAttachmentId]
       where pos.ponumber=@po and att.IsActive=1 and pos.IsActive=1
	end

CREATE PROCEDURE [accounts].[sp_GetPendingApprovalInvoices]
(
	@ProviderId BIGINT,
	@VendorType nvarchar(10)
)
AS
BEGIN
SELECT ROW_NUMBER() OVER (ORDER BY r.BatchID) AS RowID,r.* from (	
	select distinct inv.BatchID
	,concat('[',string_agg(cast(inv.InvoiceId as nvarchar(max)),','), ']') as InvoiceIds
	,a.CreateUser AS ApprovedBy,CONVERT(VARCHAR, a.CreateDate, 110) As ApprovedDate,
	cast(COUNT(*) AS int) 'InvoiceCount',CAST(SUM(inv.InvoiceAmount - ISNULL(JSON_VALUE(inv.PaymentData, '$.creditApplied'), 0)) AS FLOAT) AS 'Total'
	from 
	[accounts].[invoices] AS inv
	inner join  [accounts].[BatchRequests] a ON a.BatchID = inv.BatchID and a.isactive = 1
	--left join accounts.InvoiceTransactions t on t.invoiceid = inv.invoiceid and t.isactive = 1
	WHERE inv.VendorType=@VendorType AND inv.[Status]='Approval' AND a.BatchType = 'APPROVAL' and inv.isactive = 1 AND inv.ProviderId IS NOT NULL
	GROUP BY inv.BatchID,a.CreateUser,a.CreateDate)r

END

CREATE PROCEDURE [accounts].[DeleteInvoiceExceptions](
	@InvoiceNbr nvarchar(1000)
	)
	AS
	BEGIN
		DELETE FROM [accounts].[InvoiceExceptions] WHERE InvoiceNumber IN (SELECT value FROM openjson(@InvoiceNbr) with (value nvarchar(20) '$'));
		--delete from [accounts].[InvoicesInit] where InvoiceNumber in (select value from openjson(@InvoiceNbr) with (value nvarchar(20) '$'));
	END


CREATE procedure [accounts].[sp_ManufacturerPaymentAggregate]
(
	@ManufacturerIds nvarchar(200),
	@ManufacturerName nvarchar(100),
	@POFromDate nvarchar(50),
	@POToDate nvarchar(50),
	@DocsReceived nvarchar(5),
	@InvoiceStatuses_json nvarchar(100),
	@OrderStatuses_json nvarchar(100),
	@allocationAmount float
)
as
declare @Invoices table(
	BrandId bigint,
	BrandCode nvarchar(30),
	BrandName nvarchar(150),
	InvoiceId bigint,
	InvoiceDueDate date,
	OrderId nvarchar(15),
	DerivedInvoiceStatus nvarchar(15),
	TotalFee float,
	TotalPaid float,
	TotalCredit float
);
declare @MfgInvoices table(
	
	RunningTotal float,
	RowID bigint,
	BrandId bigint,
	--ProviderId bigint,
	BrandCode nvarchar(15),
	BrandName nvarchar(150),
	InvoiceId bigint,
	InvoiceDueDate date,
	OrderId nvarchar(15),
	DerivedInvoiceStatus nvarchar(15),
	TotalFee float,
	TotalPaid float,
	TotalCredit float
);
begin
declare @sqlq nvarchar(max);
	set @sqlq = 'select distinct
	 bb.BrandId as BrandId
	,bb.BrandCode as BrandCode
	,bb.BrandName as BrandName
	,inv.[InvoiceID] as InvoiceId
	,CONVERT(Date, inv.invoiceDueDate,101) invoiceDueDate
	,cast(json_value(invitem.[ItemData], ''$.orderId'') as bigint) as OrderId
	,(case when (inv.[Status]=''Initiated'') then (case when inv.InvoiceDueDate < getdate() then ''Due'' else ''Open'' end) else inv.[Status] end)  as DerivedInvoiceStatus
	,isnull(cast(inv.InvoiceAmount as float),0) as TotalFee
	,case inv.[Status] when ''InProcess'' then isnull(cast(json_value(inv.[PaymentData], ''$.InvoicePayment'') as float), 0) when ''Paid'' then isnull(cast(json_value(inv.[PaymentData], ''$.InvoicePayment'') as float), 0) when ''Authorize'' then isnull(cast(json_value(inv.[PaymentData], ''$.InvoicePayment'') as float), 0) else 0 end as TotalPaid
	,isnull(cast(json_value(inv.[PaymentData], ''$.CreditApplied'') as float), 0) as TotalCredit
	from [accounts].[Invoices] as inv
	join [accounts].[InvoiceItems] as invitem
	on inv.InvoiceId=invitem.InvoiceId 
	join [Orders].[OrderTransactionDetails] as o on o.orderid = inv.orderid and o.orderstatusCode = ''PO''
	join [Orders].[Orders] as ord on inv.OrderId=ord.OrderId
	join [catalog].[Brands] as bb
	on (bb.[BrandCode] = inv.BrandCode)'
	+' where inv.IsActive = 1 and inv.VendorType = ''MFG'' and bb.IsActive = 1'
	+case when @ManufacturerName is not null and @ManufacturerName <> '' then ' and bb.[BrandName] like ''%'+@ManufacturerName+'%'' ' else '' end
	+case when @ManufacturerIds is not null and @ManufacturerIds <> '' then ' and bb.BrandId in (select value from openjson('''+@ManufacturerIds+''')) ' else '' end
	+case when @POFromDate is not null and @POFromDate <> '' then (' and convert(nvarchar, cast(json_Value(o.ordertransactionData, ''$.poDate'') as date), 111) >= convert(nvarchar, cast('''+@POFromDate+''' as date), 111)') else '' end
	+case when @POToDate is not null and @POToDate <> '' then (' and convert(nvarchar, cast(json_Value(o.ordertransactionData, ''$.poDate'') as date), 111) <= convert(nvarchar, cast('''+@POToDate+''' as date), 111)') else '' end
	+case when @InvoiceStatuses_json is not null and @InvoiceStatuses_json <> '' then (' and (case when (inv.[Status]=''Initiated'') then (case when inv.InvoiceDueDate < getdate() then ''Due'' else ''Open'' end) else inv.[Status] end)
 in (select value from openjson('''+@InvoiceStatuses_json+'''))') else '' end
	+case when @OrderStatuses_json is not null and @OrderStatuses_json <> '' then (' and ord.Status in (select value from openjson('''+@OrderStatuses_json+''') with (value nvarchar(20) ''$''))') else '' end;

	--print (@sqlq);
	--,convert(nvarchar, cast(json_value(invitem.[ItemData], ''$.poDate'') as date), 101) as PODate
	--,(select sum([CreditAmount]-[ClearedAmount]) from [accounts].[CreditMemos] where [ProviderID]=cast(json_value(inv.[ProviderData], ''$.providerId'') as bigint)) as Credit
insert into @Invoices exec ('select i.*from ('+@sqlq + ')i order by InvoiceDueDate asc');

--select *from @Invoices

insert into @MfgInvoices
select sum(q.totalFee) over (order by q.RowID) runningTotal,q.* from (
SELECT row_number() over (order by p.InvoiceDueDate) as RowID, p.* from (SELECT *FROM @Invoices)p
)q  
order by q.InvoiceDueDate asc

--select *from @MfgInvoices

if @allocationAmount > 0
		begin
			select 
		 row_number() over (order by pd.BrandId) as RowID
		 ,concat('[',string_agg(cast(pd.InvoiceId as nvarchar(max)),','), ']') as InvoiceIds
		,pd.BrandId as BrandId
		,pd.BrandCode as BrandCode
		--,concat('[',string_agg(cast(pd.InvoiceId as nvarchar),','), ']') as InvoiceIds
		,bb.BrandName as BrandName
		,bb.BrandAddress1 as BrandAddress1
		,bb.BrandEmail as BrandEmail
		,bb.BrandCity as BrandCity
		,bb.BrandState as BrandState
		,bb.BrandZipCode as BrandZipCode
		,sum(isnull(pd.TotalFee,0)) as TotalFee
		,sum(isnull(pd.TotalPaid, 0)) as TotalPaid
		,(isnull(sum(pd.TotalFee - isnull(pd.TotalPaid, 0)),0)) as TotalBalance
		,sum(case when pd.DerivedInvoiceStatus = 'Due' then (pd.TotalFee - isnull(pd.TotalPaid, 0)) else 0 end) as TotalDueAmount
		,'' as PaymentMethod
		,sum(isnull(pd.TotalCredit,0)) as CreditAvailable
		,isnull(va.[VendorPreferredPaymentType], 'CHECK') as PreferredPaymentType
		,va.[VendorAccountID] as VendorAccountId
		 from @MfgInvoices as pd
		left join [catalog].[Brands] as bb
		on (bb.BrandCode = pd.BrandCode)
		left join [accounts].[VendorAccounts] as va
		on (pd.BrandCode = va.BrandCode)
		where pd.runningtotal <= @allocationAmount
		group by pd.BrandId,pd.BrandCode, bb.BrandName, va.[VendorAccountID], bb.BrandAddress1,bb.BrandEmail,
		bb.BrandCity ,bb.BrandState
		,bb.BrandZipCode, va.[VendorPreferredPaymentType] 
			;
		end
		else
		begin
			select 
			 row_number() over (order by pd.BrandCode) as RowID,
			 concat('[',string_agg(cast(pd.InvoiceId as nvarchar(max)),','), ']') as InvoiceIds
			,pd.BrandId as BrandId
			,pd.BrandCode as BrandCode
			--,concat('[',string_agg(cast(pd.InvoiceId as nvarchar),','), ']') as InvoiceIds
			,bb.BrandName as BrandName
			,bb.BrandAddress1 as BrandAddress1
			,bb.BrandEmail as BrandEmail
			,bb.BrandCity as BrandCity
			,bb.BrandState as BrandState
			,bb.BrandZipCode as BrandZipCode
			,sum(isnull(pd.TotalFee,0)) as TotalFee
			,sum(isnull(pd.TotalPaid, 0)) as TotalPaid
			,(isnull(sum(pd.TotalFee - isnull(pd.TotalPaid, 0)),0)) as TotalBalance
			,sum(case when pd.DerivedInvoiceStatus = 'Due' then (pd.TotalFee - isnull(pd.TotalPaid, 0)) else 0 end) as TotalDueAmount
			,'' as PaymentMethod
			,sum(isnull(pd.TotalCredit,0)) as CreditAvailable
			,isnull(va.[VendorPreferredPaymentType], 'CHECK') as PreferredPaymentType
			,va.[VendorAccountID] as VendorAccountId
			 from @MfgInvoices as pd
			left join [catalog].[Brands] as bb
			on (bb.BrandCode = pd.BrandCode)
			left join [accounts].[VendorAccounts] as va
			on (pd.BrandCode = va.BrandCode)
			group by pd.BrandId,pd.BrandCode, bb.BrandName, va.[VendorAccountID], bb.BrandAddress1,bb.BrandEmail,
			bb.BrandCity ,bb.BrandState
			,bb.BrandZipCode, va.[VendorPreferredPaymentType] 
				;
		end

end



CREATE procedure [accounts].[sp_ProviderPaymentAggregate]
(
	@ProviderIds nvarchar(200),
	@IncludeProviderName bit = 1,
	@ProviderLegalName nvarchar(100),
	@POFromDate nvarchar(50),
	@POToDate nvarchar(50),
	@DocsReceived nvarchar(5),
	@InvoiceStatuses_json nvarchar(100),
	@OrderStatuses_json nvarchar(100),
	@IncludeBrands bit,
	@BrandCodes_json nvarchar(100)
)
as
declare @Invoices table(
	ProviderId bigint,
	BrandCode nvarchar(15),
	InvoiceId bigint,
	OrderId nvarchar(15),
	DerivedInvoiceStatus nvarchar(15),
	TotalFee float,
	TotalPaid float,
	TotalCredit float
);
begin
declare @sqlq nvarchar(max);
set @sqlq = 'select distinct
 inv.ProviderId as ProviderId
 ,inv.[BrandCode] as BrandCode
,inv.[InvoiceID] as InvoiceId
,cast(json_value(invitem.[ItemData], ''$.orderId'') as bigint) as OrderId
,(case when json_value(invitem.[ItemData], ''$.orderStatus'') = ''ACTIVE'' then (case when (inv.[Status]=''Initiated'') then (case when inv.isDocsSubmitted = 1 and inv.InvoiceDueDate < getdate() then ''Due'' else ''Open'' end) else inv.[Status] end) else ''VOID'' end) as DerivedInvoiceStatus
,inv.InvoiceAmount as TotalFee
,case inv.[Status] when ''InProcess'' then isnull(cast(json_value(inv.[PaymentData], ''$.invoicePayment'') as float), 0) when ''Paid'' then isnull(cast(json_value(inv.[PaymentData], ''$.invoicePayment'') as float), 0) when ''Authorize'' then isnull(cast(json_value(inv.[PaymentData], ''$.invoicePayment'') as float), 0) else 0 end as TotalPaid
,isnull(cast(json_value(inv.[PaymentData], ''$.creditApplied'') as float), 0) as TotalCredit
from [accounts].[Invoices] as inv
left join [accounts].[InvoiceItems] as invitem
on(inv.InvoiceId=invitem.InvoiceId)
join [provider].[ProviderProfiles] as pp
on (pp.[ProviderId] = inv.ProviderId  )'
+' where inv.IsActive = 1 and inv.VendorType = ''PRO'' and pp.IsActive = 1'
+case when @BrandCodes_json is not null and @BrandCodes_json <> '' then (' and inv.[BrandCode] '+(case @IncludeBrands when 1 then 'in' else 'not in' end)+' (select value from openjson('''+ @BrandCodes_json + ''') with (value nvarchar(15) ''$''))') else '' end
+case when @ProviderLegalName is not null and @ProviderLegalName <> '' then ' and pp.[ProviderName]'+(case @IncludeProviderName when 0 then ' not like ' else ' like ' end)+'''%'+@ProviderLegalName+'%'' ' else '' end
+case when @ProviderIds is not null and @ProviderIds <> '' then ' and pp.ProviderId in (select value from openjson('''+@ProviderIds+''')) ' else '' end
+case when @POFromDate is not null and @POFromDate <> '' then (' and convert(nvarchar, cast(DateAdd(day,-60,inv.invoiceDueDate) as date), 111) >= convert(nvarchar, cast('''+@POFromDate+''' as date), 111)') else '' end
+case when @POToDate is not null and @POToDate <> '' then (' and convert(nvarchar, cast(DateAdd(day,-60,inv.invoiceDueDate) as date), 111) <= convert(nvarchar, cast('''+@POToDate+''' as date), 111)') else '' end
+case when @InvoiceStatuses_json is not null and @InvoiceStatuses_json <> '' then (' and (case when json_value(invitem.[ItemData], ''$.orderStatus'') = ''ACTIVE'' then (case when (inv.[Status]=''Initiated'') then (case when inv.isDocsSubmitted = 1 and inv.InvoiceDueDate < getdate() then ''Due'' else ''Open'' end) else inv.[Status] end) else ''VOID'' end) in (select value from openjson('''+@InvoiceStatuses_json+''') with (value nvarchar(20) ''$''))') else '' end
+case when @OrderStatuses_json is not null and @OrderStatuses_json <> '' then (' and json_value(invitem.[ItemData], ''$.orderStatus'') in (select value from openjson('''+@OrderStatuses_json+''') with (value nvarchar(20) ''$''))') else '' end
+case when @DocsReceived = 'yes' then ' and inv.isDocsSubmitted = 1' when @DocsReceived = 'no' then ' inv.isDocsSubmitted = 0' else '' end;
--print @sqlq
insert into @Invoices exec (@sqlq);

select 
 row_number() over (order by pd.ProviderId) as RowID
,pd.ProviderId as ProviderId
--,concat('[',string_agg(cast(pd.InvoiceId as nvarchar),','), ']') as InvoiceIds
--,concat('[', string_agg(pd.[BrandCode], ', '), ']') as BrandCodes
,pp.ProviderName as ProviderLegalBusinessName
,json_value(pp.AdditionalData, '$.billingAddress.address1') as ProviderAddress1
,json_value(pp.AdditionalData, '$.billingAddress.city') as ProviderCity
,json_value(pp.AdditionalData, '$.billingAddress.state') as ProviderState
,json_value(pp.AdditionalData, '$.billingAddress.zip') as ProviderZip
,count(*) as MembersServed
,sum(isnull(pd.TotalFee,0)) as TotalFee
,sum(isnull(pd.TotalPaid, 0)) as TotalPaid
,(isnull(sum(pd.TotalFee - isnull(pd.TotalPaid, 0)),0)) as TotalBalance
,sum(case when pd.DerivedInvoiceStatus = 'Due' then (pd.TotalFee - isnull(pd.TotalPaid, 0)) else 0 end) as TotalDueAmount
,'' as MarkAsPaidJSON
,'' as PaymentMethod
,sum(isnull(pd.TotalCredit,0)) as CreditAvailable
,isnull(va.[VendorPreferredPaymentType], 'CHECK') as PreferredPaymentType
,va.[VendorAccountID] as VendorAccountId
 from @Invoices as pd
left join provider.ProviderProfiles as pp
on (pp.ProviderId = pd.ProviderId)
left join [accounts].[VendorAccounts] as va
on (pd.ProviderId = va.[ProviderId])
group by pd.ProviderId, pp.ProviderName, va.[VendorAccountID], json_value(pp.AdditionalData, '$.billingAddress.address1'),
json_value(pp.AdditionalData, '$.billingAddress.city') ,json_value(pp.AdditionalData, '$.billingAddress.state')
,json_value(pp.AdditionalData, '$.billingAddress.zip'), va.[VendorPreferredPaymentType] 
 ;
end


CREATE PROCEDURE [accounts].[GetVendorDetails](@OrderID BIGINT) 
	AS
	BEGIN
	SELECT BrandID,BrandName,BrandCode,[Description],BrandEmail,BrandAddress1,BrandAddress2,BrandCity,BrandZipCode,BrandState,MFGContactNumber
	FROM [catalog].[Brands] WHERE BrandCode IN  (SELECT DISTINCT BrandCode FROM [Orders].[OrderItems] WHERE OrderID  = @OrderID)
	END


CREATE procedure [accounts].[sp_ProviderPaymentAggregateDetails]
(
	@ProviderIds nvarchar(200),
	@IncludeProviderName bit = 1,
	@ProviderLegalName nvarchar(100),
	@POFromDate nvarchar(50),
	@POToDate nvarchar(50),
	@DocsReceived nvarchar(5),
	@InvoiceStatuses_json nvarchar(100),
	@OrderStatuses_json nvarchar(100),
	@IncludeBrands bit,
	@BrandCodes_json nvarchar(100),
	@allocationAmount float
)
as
declare @Invoices table(
	ProviderId bigint,
	BrandCode nvarchar(15),
	InvoiceId bigint,
	InvoiceDueDate date,
	OrderId nvarchar(15),
	DerivedInvoiceStatus nvarchar(15),
	TotalFee float,
	TotalPaid float,
	TotalCredit float
);
declare @ProviderInvoices table(
	RunningTotal float,
	RowID bigint,
	ProviderId bigint,
	BrandCode nvarchar(15),
	InvoiceId bigint,
	InvoiceDueDate date,
	OrderId nvarchar(15),
	DerivedInvoiceStatus nvarchar(15),
	TotalFee float,
	TotalPaid float,
	TotalCredit float
);
begin
declare @sqlq nvarchar(max);
declare @sqlq2 nvarchar(max);
set @sqlq = 'select distinct
 inv.ProviderId as ProviderId
 ,inv.[BrandCode] as BrandCode
,inv.[InvoiceID] as InvoiceId
,CONVERT(Date, inv.invoiceDueDate,101) invoiceDueDate
,o.OrderId
,(case when o.Status = ''ACTIVE'' then (case when (inv.[Status]=''Initiated'') then (case when inv.[IsDocsSubmitted] = 1 and inv.InvoiceDueDate < getdate() then ''Due'' when inv.InvoiceDueDate > getdate() then ''Open'' end) else inv.[Status] end) else ''VOID'' end) as DerivedInvoiceStatus
,inv.InvoiceAmount as TotalFee
,case inv.[Status] when ''InProcess'' then isnull(cast(json_value(inv.[PaymentData], ''$.invoicePayment'') as float), 0) when ''Paid'' then isnull(cast(json_value(inv.[PaymentData], ''$.invoicePayment'') as float), 0) when ''Authorize'' then isnull(cast(json_value(inv.[PaymentData], ''$.invoicePayment'') as float), 0) else 0 end as TotalPaid
,isnull(cast(json_value(inv.[PaymentData], ''$.creditApplied'') as float), 0) as TotalCredit
from [accounts].[Invoices] as inv
inner join [Orders].[Orders] o on o.orderid = inv.orderid 
left join [provider].[ProviderProfiles] as pp
on (pp.[ProviderId] = inv.ProviderId)'
+' where inv.IsActive = 1 and inv.VendorType = ''PRO'''
+case when @BrandCodes_json is not null and @BrandCodes_json <> '' then (' and inv.[BrandCode] '+(case @IncludeBrands when 1 then 'in' else 'not in' end)+' (select value from openjson('''+ @BrandCodes_json + ''') with (value nvarchar(15) ''$''))') else '' end
+case when @ProviderLegalName is not null and @ProviderLegalName <> '' then ' and pp.[ProviderName]'+(case @IncludeProviderName when 0 then ' not like ' else ' like ' end)+'''%'+@ProviderLegalName+'%'' ' else '' end
+case when @ProviderIds is not null and @ProviderIds <> '' then ' and pp.ProviderId in (select value from openjson('''+@ProviderIds+''')) ' else '' end
+case when @POFromDate is not null and @POFromDate <> '' then (' and convert(nvarchar, cast(DateAdd(day,-60,inv.invoiceDueDate) as date), 111) >= convert(nvarchar, cast('''+@POFromDate+''' as date), 111)') else '' end
+case when @POToDate is not null and @POToDate <> '' then (' and convert(nvarchar, cast(DateAdd(day,-60,inv.invoiceDueDate) as date), 111) <= convert(nvarchar, cast('''+@POToDate+''' as date), 111)') else '' end
+case when @InvoiceStatuses_json is not null and @InvoiceStatuses_json <> '' then (' and (case when o.Status = ''ACTIVE'' then (case when (inv.[Status]=''Initiated'') then (case when inv.[IsDocsSubmitted] = 1 and inv.InvoiceDueDate < getdate() then ''Due'' when inv.InvoiceDueDate > getdate() then ''Open'' end) else inv.[Status] end) else ''VOID'' end) in (select value from openjson('''+@InvoiceStatuses_json+''') with (value nvarchar(20) ''$''))') else '' end
+case when @OrderStatuses_json is not null and @OrderStatuses_json <> '' then (' and o.Status in (select value from openjson('''+@OrderStatuses_json+''') with (value nvarchar(20) ''$''))') else '' end
+case when @DocsReceived = 'yes' then ' and inv.isDocsSubmitted = 1' when @DocsReceived = 'no' then ' inv.isDocsSubmitted = 0' else '' end;

insert into @Invoices exec ('select i.*from ('+@sqlq + ')i order by InvoiceDueDate asc');

--print @sqlq

--SELECT *FROM @Invoices
--order by OrderId

insert into @ProviderInvoices
select sum(q.totalFee) over (order by q.RowID) runningTotal,q.* from (
SELECT row_number() over (order by p.InvoiceDueDate) as RowID, p.* from (SELECT *FROM @Invoices)p
)q  
order by q.InvoiceDueDate asc


--select *from @ProviderInvoices where runningTotal < = @allocationAmount
if @allocationAmount > 0
		begin
		select 
			row_number() over (order by pd.ProviderId) as RowID
			,pd.ProviderId as ProviderId
			,concat('[',string_agg(cast(pd.InvoiceId as nvarchar(max)),','), ']') as InvoiceIds
			--,concat('[', string_agg(pd.[BrandCode], ', '), ']') as BrandCodes
			,pp.ProviderName as ProviderLegalBusinessName
			,json_value(pp.AdditionalData, '$.billingAddress.address1') as ProviderAddress1
			,json_value(pp.AdditionalData, '$.billingAddress.city') as ProviderCity
			,json_value(pp.AdditionalData, '$.billingAddress.state') as ProviderState
			,json_value(pp.AdditionalData, '$.billingAddress.zip') as ProviderZip
			,count(*) as MembersServed
			,sum(isnull(pd.TotalFee,0)) as TotalFee
			,sum(isnull(pd.TotalPaid, 0)) as TotalPaid
			,isnull(sum(isnull(pd.TotalFee,0) - isnull(pd.TotalPaid, 0)),0) as TotalBalance
			,isnull(sum(case when pd.DerivedInvoiceStatus = 'Due' then (pd.TotalFee - isnull(pd.TotalPaid, 0)) else 0 end),0) as TotalDueAmount
			,'' as MarkAsPaidJSON
			,'' as PaymentMethod
			,CAST(sum(pd.TotalCredit) AS FLOAT) as CreditAvailable
			,isnull(va.[VendorPreferredPaymentType], 'CHECK') as PreferredPaymentType
			,va.[VendorAccountID] as VendorAccountId
			from @ProviderInvoices as pd
			left join provider.ProviderProfiles as pp
			on (pp.ProviderId = pd.ProviderId)
			left join [accounts].[VendorAccounts] as va
			on (pd.ProviderId = va.[ProviderId])
			where pd.runningtotal <= @allocationAmount
			group by pd.ProviderId, 
			pp.ProviderName, va.[VendorAccountID], json_value(pp.AdditionalData, '$.billingAddress.address1'),
			json_value(pp.AdditionalData, '$.billingAddress.city') ,json_value(pp.AdditionalData, '$.billingAddress.state')
			,json_value(pp.AdditionalData, '$.billingAddress.zip'), va.[VendorPreferredPaymentType]
			
		end
else
		begin
			select 
			row_number() over (order by pd.ProviderId) as RowID
			,pd.ProviderId as ProviderId
			,concat('[',string_agg(cast(pd.InvoiceId as nvarchar(max)),','), ']') as InvoiceIds
			--,concat('[', string_agg(pd.[BrandCode], ', '), ']') as BrandCodes
			,pp.ProviderName as ProviderLegalBusinessName
			,json_value(pp.AdditionalData, '$.billingAddress.address1') as ProviderAddress1
			,json_value(pp.AdditionalData, '$.billingAddress.city') as ProviderCity
			,json_value(pp.AdditionalData, '$.billingAddress.state') as ProviderState
			,json_value(pp.AdditionalData, '$.billingAddress.zip') as ProviderZip
			,count(*) as MembersServed
			,sum(isnull(pd.TotalFee,0)) as TotalFee
			,sum(isnull(pd.TotalPaid, 0)) as TotalPaid
			,isnull(sum(isnull(pd.TotalFee,0) - isnull(pd.TotalPaid, 0)),0) as TotalBalance
			,isnull(sum(case when pd.DerivedInvoiceStatus = 'Due' then (pd.TotalFee - isnull(pd.TotalPaid, 0)) else 0 end),0) as TotalDueAmount
			,'' as MarkAsPaidJSON
			,'' as PaymentMethod
			,CAST(sum(pd.TotalCredit) AS FLOAT) as CreditAvailable
			,isnull(va.[VendorPreferredPaymentType], 'CHECK') as PreferredPaymentType
			,va.[VendorAccountID] as VendorAccountId
			from @ProviderInvoices as pd
			left join provider.ProviderProfiles as pp
			on (pp.ProviderId = pd.ProviderId)
			left join [accounts].[VendorAccounts] as va
			on (pd.ProviderId = va.[ProviderId])
			group by pd.ProviderId, 
			pp.ProviderName, va.[VendorAccountID], json_value(pp.AdditionalData, '$.billingAddress.address1'),
			json_value(pp.AdditionalData, '$.billingAddress.city') ,json_value(pp.AdditionalData, '$.billingAddress.state')
			,json_value(pp.AdditionalData, '$.billingAddress.zip'), va.[VendorPreferredPaymentType] 
		end
end



CREATE PROCEDURE [accounts].[GetShippingAmount](@OrderID BIGINT) 
AS
BEGIN
SELECT ShippingAmount AS Amount FROM [catalog].[BrandShippingFees] WHERE BrandCode IN  (SELECT DISTINCT BrandCode FROM [Orders].[OrderItems] WHERE OrderID  = @OrderID)
END

CREATE procedure [accounts].[sp_ManufacturerPaymentSingle]
(
	@ManufacturerIds nvarchar(200),
	@ManufacturerName nvarchar(100),
	@POFromDate nvarchar(50),
	@POToDate nvarchar(50),
	@DocsReceived nvarchar(5),
	@InvoiceStatuses_json nvarchar(100),
	@OrderStatuses_json nvarchar(100)
)
as
begin
declare @sqlq1 nvarchar(max);
declare @sqlq2 nvarchar(max);
set @sqlq1 = 'select distinct 
inv.[InvoiceId] as InvoiceId
,inv.[InvoiceNumber] as InvoiceNumber
,isnull(inv.OrderID,0) as OrderId
,ord.Status as OrderStatus
,ord.OrderType as OrderType
,inv.[Status] as ActualInvoiceStatus
,(case when (inv.[Status]=''Initiated'') then (case when inv.InvoiceDueDate < getdate() then ''Due'' else ''Open'' end) else inv.[Status] end)  as DerivedInvoiceStatus
,inv.invoiceDate InvoiceDate
,cast(json_value(invitm.[ItemData], ''$.docsReceivedDate'') as date) as DocsReceivedDate
,isnull(datediff(day, convert(nvarchar, cast(DateAdd(day,-60,inv.invoiceDueDate) as date), 111), convert(nvarchar, getdate(), 111)), 0) as ServiceDays
,cast(isnull(json_value(inv.[PaymentData], ''$.creditApplied''), 0) as float) as Credit
,concat(json_value(ord.[MemberData], ''$.firstName''), '''', json_value(ord.[MemberData], ''$.lastName'')) as MemberName
,json_value(inv.[ProviderData], ''$.providerBusinessName'') as ProviderName
,inv.[PONumber] as PONumber
,bb.BrandId as BrandId
,bb.BrandName as BrandName
,bb.BrandCode as BrandCode
,bb.BrandAddress1 as BrandAddress1
,cast(json_Value(o.ordertransactionData, ''$.poDate'') as date) as PODate
,inv.[InvoiceDueDate] as InvoiceDueDate
,isnull(cast((invitm.Quantity * invitm.Cost) as float),0) as COGS
,isnull(cast(ship.ShippingAmount as float),0) as ShippingAmount
,isnull(cast(inv.InvoiceAmount as float),0) as TotalFee
,isnull(cast(0 as float),0) as RebateAmount
,isnull(cast(0 as float),0) as SalesTaxAmount
,case inv.[Status] when ''InProcess'' then isnull(cast(json_value(inv.[PaymentData], ''$.invoicePayment'') as float), 0) when ''Paid'' then isnull(cast(json_value(inv.[PaymentData], ''$.invoicePayment'') as float), 0) when ''Authorize'' then isnull(cast(json_value(inv.[PaymentData], ''$.invoicePayment'') as float), 0) else 0 end as TotalPaid
,(inv.InvoiceAmount - (case inv.[Status] when ''InProcess'' then isnull(cast(json_value(inv.[PaymentData], ''$.invoicePayment'') as float), 0) when ''Paid'' then isnull(cast(json_value(inv.[PaymentData], ''$.invoicePayment'') as float), 0) when ''Authorize'' then isnull(cast(json_value(inv.[PaymentData], ''$.invoicePayment'') as float), 0) else 0 end)) as TotalBalance
,inv.isDocsSubmitted as DocsReceived
,inv.[Remarks] as Remarks
,json_value(inv.[PaymentData], ''$.paymentMethod'') as PaymentMethod
,isnull(va.[VendorPreferredPaymentType], ''CHECK'') as PreferredPaymentType
,va.[VendorAccountID] as VendorAccountId
from [accounts].[Invoices] as inv
join [accounts].[InvoiceItems] as invitm on(inv.Invoiceid=invitm.Invoiceid)
join [Orders].[OrderTransactionDetails] as o on o.orderid = inv.orderid and o.orderstatusCode = ''PO''
join [Orders].[Orders] as ord on inv.OrderId=ord.OrderId
join [catalog].[Brands] as bb
on (bb.[BrandCode] = inv.BrandCode )'                                  
+' left join (select * from [accounts].[InvoiceTransactions] where [InvoiceType]=''PAY'' and [Status] = ''Authorized'') as invt
on (invt.InvoiceID = inv.InvoiceId)
left join [accounts].[VendorAccounts] as va
on (inv.BrandCode = va.[BrandCode])
left join [catalog].[BrandShippingFees] as ship
on(inv.BrandCode = ship.[BrandCode])
where inv.IsActive = 1 and inv.VendorType = ''MFG'' and bb.IsActive = 1 '
+case when @ManufacturerName is not null and @ManufacturerName <> '' then ' and bb.[BrandName] like ''%'+@ManufacturerName+'%'' ' else '' end
+case when @ManufacturerIds is not null and @ManufacturerIds <> '' then ' and bb.BrandId in (select value from openjson('''+@ManufacturerIds+''')) ' else '' end
+case when @POFromDate is not null and @POFromDate <> '' then (' and convert(nvarchar, cast(json_Value(o.ordertransactionData, ''$.poDate'') as date), 111) >= convert(nvarchar, cast('''+@POFromDate+''' as date), 111)') else '' end
+case when @POToDate is not null and @POToDate <> '' then (' and convert(nvarchar, cast(json_Value(o.ordertransactionData, ''$.poDate'') as date), 111) <= convert(nvarchar, cast('''+@POToDate+''' as date), 111)') else '' end
+case when @InvoiceStatuses_json is not null and @InvoiceStatuses_json <> '' then (' and (case when (inv.[Status]=''Initiated'') then (case when inv.InvoiceDueDate < getdate() then ''Due'' else ''Open'' end) else inv.[Status] end)  in (select value from openjson('''+@InvoiceStatuses_json+''') with (value nvarchar(20) ''$''))') else '' end
+case when @OrderStatuses_json is not null and @OrderStatuses_json <> '' then (' and ord.Status in (select value from openjson('''+@OrderStatuses_json+''') with (value nvarchar(20) ''$''))') else '' end
--+case when @DocsReceived = 'yes' then ' and inv.isDocsSubmitted = 1' when @DocsReceived = 'no' then ' inv.isDocsSubmitted = 0' else '' end

--print (@sqlq);
--,convert(nvarchar, cast(json_value(invitm.[ItemData], ''$.poDate'') as date), 101) as PODate
--,(select sum([CreditAmount]-[ClearedAmount]) from [accounts].[CreditMemos] where [ProviderID]=cast(json_value(inv.[ProviderData], ''$.providerId'') as bigint)) as Credit
set @sqlq2 = 'Select row_number() over (order by i.InvoiceDueDate) as SNO,row_number() over (order by i.InvoiceDueDate) as RowID, i.* from (' + @sqlq1 + ') i';
exec (@sqlq2);
end

CREATE PROCEDURE [accounts].[GetWarrantyDates](@OrderID BIGINT)
AS
BEGIN

/*
Author: Moin 
Date: NOV 8 2018
Desription:  Fetching lnDWarrantyEndDate from ItemDetailsData Json data
*/
 SELECT  1 AS ID, CAST(JSON_VALUE(ItemDetailsData, '$.lnDWarrantyEndDate') AS DATETIME) AS 'WarrantyEndDate' FROM [accounts].[InvoiceItems] WHERE JSON_VALUE(ItemData, '$.orderId') = @OrderID
END


CREATE procedure [accounts].[sp_ProviderPaymentSingle]
(
	@ProviderIds nvarchar(200),
	@IncludeProviderName bit = 1,
	@ProviderLegalName nvarchar(100),
	@POFromDate nvarchar(50),
	@POToDate nvarchar(50),
	@DocsReceived nvarchar(5),
	@InvoiceStatuses_json nvarchar(100),
	@OrderStatuses_json nvarchar(100),
	@IncludeBrands bit,
	@BrandCodes_json nvarchar(100)
)
as
begin
declare @sqlq1 nvarchar(max);
declare @sqlq2 nvarchar(max);
set @sqlq1 = 'select distinct 
inv.[InvoiceId] as InvoiceId
,inv.BrandCode
,isnull(cast(json_value(invitm.[ItemData], ''$.orderId'') as bigint),0) as OrderId
,json_value(invitm.[ItemData], ''$.orderStatus'') as OrderStatus
,json_value(invitm.[ItemData], ''$.orderType'') as OrderType
,inv.[Status] as ActualInvoiceStatus
,(case when json_value(invitm.[ItemData], ''$.orderStatus'') = ''ACTIVE'' then (case when (inv.[Status]=''Initiated'') then (case when inv.isDocsSubmitted = 1 and inv.InvoiceDueDate < getdate() then ''Due'' else ''Open'' end) else inv.[Status] end) else ''VOID'' end) as DerivedInvoiceStatus
,DateAdd(day,-60,inv.invoiceDueDate) FittingDate
,cast(json_value(invitm.[ItemData], ''$.docsReceivedDate'') as date) as DocsReceivedDate
,isnull(datediff(day, convert(nvarchar, cast(DateAdd(day,-60,inv.invoiceDueDate) as date), 111), convert(nvarchar, getdate(), 111)), 0) as ServiceDays
,concat(json_value(invitm.[ItemData], ''$.memberFirstName''), '' '', json_value(invitm.[ItemData], ''$.memberLastName'')) as MemberName
,json_value(invitm.[ItemData], ''$.nhMemberId'') as NHMemberId
,inv.[PONumber] as PONumber
,pp.Providerid as ProviderId
,cast(json_value(invitm.[ItemData], ''$.poDate'') as date) as PODate
,inv.[InvoiceDueDate] as InvoiceDueDate
,isnull(cast(json_value(invitm.[ItemData], ''$.dispensingFee'') as float),0) as DispensingFee
,isnull(cast(json_value(invitm.[ItemData], ''$.deviceCount'') as int),0) as DeviceCount
,inv.InvoiceAmount as TotalFee
,case inv.[Status] when ''InProcess'' then isnull(cast(json_value(inv.[PaymentData], ''$.invoicePayment'') as float), 0) when ''Paid'' then isnull(cast(json_value(inv.[PaymentData], ''$.invoicePayment'') as float), 0) when ''Authorize'' then isnull(cast(json_value(inv.[PaymentData], ''$.invoicePayment'') as float), 0) else 0 end as TotalPaid
,cast(isnull(json_value(inv.[PaymentData], ''$.creditApplied''), 0) as float) as Credit
,(inv.InvoiceAmount - (case inv.[Status] when ''InProcess'' then isnull(cast(json_value(inv.[PaymentData], ''$.invoicePayment'') as float), 0) when ''Paid'' then isnull(cast(json_value(inv.[PaymentData], ''$.invoicePayment'') as float), 0) when ''Authorize'' then isnull(cast(json_value(inv.[PaymentData], ''$.invoicePayment'') as float), 0) else 0 end)) as TotalBalance
,inv.isDocsSubmitted as DocsReceived
,inv.[Remarks] as Remarks
,'''' as ProviderAddress1
,'''' as ProviderLegalBusinessName
,json_value(inv.[PaymentData], ''$.paymentMethod'') as PaymentMethod
,isnull(va.[VendorPreferredPaymentType], ''CHECK'') as PreferredPaymentType
, va.[VendorAccountID] as VendorAccountId
from [accounts].[Invoices] as inv
join [accounts].[InvoiceItems] as invitm on(inv.Invoiceid=invitm.Invoiceid)
join [provider].[ProviderProfiles] as pp
on (inv.Providerid = pp.[ProviderId] )'                                
+' left join [accounts].[VendorAccounts] as va
on (pp.ProviderId = va.[ProviderId])
where inv.IsActive = 1 and inv.VendorType = ''PRO'' and pp.IsActive = 1 '

set @sqlq2 = 'Select row_number() over (order by i.InvoiceDueDate) as RowID, i.* from (' + @sqlq1 + 
+case when @BrandCodes_json is not null and @BrandCodes_json <> '' then (' and inv.[BrandCode] '+(case @IncludeBrands when 1 then 'in' else 'not in' end)+' (select value from openjson('''+ @BrandCodes_json + ''') with (value nvarchar(15) ''$''))') else '' end
+case when @ProviderLegalName is not null and @ProviderLegalName <> '' then ' and pp.[ProviderName]'+(case @IncludeProviderName when 0 then ' not like ' else ' like ' end)+'''%'+@ProviderLegalName+'%'' ' else '' end
+case when @ProviderIds is not null and @ProviderIds <> '' then ' and pp.ProviderId in (select value from openjson('''+@ProviderIds+''')) ' else '' end
+case when @POFromDate is not null and @POFromDate <> '' then (' and convert(nvarchar, cast(DateAdd(day,-60,inv.invoiceDueDate) as date), 111) >= convert(nvarchar, cast('''+@POFromDate+''' as date), 111)') else '' end
+case when @POToDate is not null and @POToDate <> '' then (' and convert(nvarchar, cast(DateAdd(day,-60,inv.invoiceDueDate) as date), 111) <= convert(nvarchar, cast('''+@POToDate+''' as date), 111)') else '' end
+case when @InvoiceStatuses_json is not null and @InvoiceStatuses_json <> '' then (' and (case when json_value(invitm.[ItemData], ''$.orderStatus'') = ''ACTIVE'' then (case when (inv.[Status]=''Initiated'') then (case when inv.isDocsSubmitted = 1 and inv.InvoiceDueDate < getdate() then ''Due'' else ''Open'' end) else inv.[Status] end) else ''VOID'' end) in (select value from openjson('''+@InvoiceStatuses_json+''') with (value nvarchar(20) ''$''))') else '' end
+case when @OrderStatuses_json is not null and @OrderStatuses_json <> '' then (' and json_value(invitm.[ItemData], ''$.orderStatus'') in (select value from openjson('''+@OrderStatuses_json+''') with (value nvarchar(20) ''$''))') else '' end
+case when @DocsReceived = 'yes' then ' and inv.isDocsSubmitted = 1' when @DocsReceived = 'no' then ' inv.isDocsSubmitted = 0' else '' end
+') i';
exec (@sqlq2);
end



CREATE procedure [accounts].[sp_ProviderPaymentSingleInvoiceIDs]
(
	@InvoiceIds nvarchar(max),
	@VendorType nvarchar(10)
)
as
begin
declare @sqlq1 nvarchar(max);
declare @sqlq2 nvarchar(max);

set @sqlq1 = 'select distinct 
		inv.[InvoiceId] as InvoiceId
		,inv.[InvoiceNumber]
		,bb.BrandId as BrandId
		,bb.BrandName as BrandName
		,inv.BrandCode
		,inv.invoiceDate InvoiceDate
		,ord.OrderId OrderId
		,ord.Status as OrderStatus
		,ord.OrderType as OrderType
		,inv.[Status] as ActualInvoiceStatus
		,(case when (inv.[Status]=''Initiated'') then (case when inv.InvoiceDueDate < getdate() then ''Due'' else ''Open'' end) else inv.[Status] end)  as DerivedInvoiceStatus
		,DateAdd(day,-60,inv.invoiceDueDate) FittingDate
		,cast(json_value(invitm.[ItemData], ''$.docsReceivedDate'') as date) as DocsReceivedDate
		,isnull(datediff(day, convert(nvarchar, cast(DateAdd(day,-60,inv.invoiceDueDate) as date), 111), convert(nvarchar, getdate(), 111)), 0) as ServiceDays
		,concat(json_value(ord.[MemberData], ''$.firstName''), '' '', json_value(ord.[MemberData], ''$.lastName'')) as MemberName
		,ord.NHMemberId as NHMemberId
		,inv.[PONumber] as PONumber
		,ISNULL(inv.Providerid, 0) as ProviderId
		,TransactionDatajsonValues.poDate as PODate
		,inv.[InvoiceDueDate] as InvoiceDueDate
		,isnull(cast(json_value(invitm.[ItemData], ''$.dispensingFee'') as float),0) as DispensingFee
		,isnull(cast(json_value(invitm.[ItemData], ''$.deviceCount'') as int),0) as DeviceCount
		,isnull(cast((invitm.Quantity * invitm.Cost) as float),0) as COGSPrice
		,isnull(cast(ship.ShippingAmount as float),0) as ShippingAmount
		,isnull(cast(inv.InvoiceAmount as float),0) as TotalFee
		,isnull(cast(0 as float),0) as RebateAmount
		,isnull(cast(0 as float),0) as SalesTaxAmount
		,case inv.[Status] when ''InProcess'' then isnull(cast(json_value(inv.[PaymentData], ''$.invoicePayment'') as float), 0) when ''Paid'' then isnull(cast(json_value(inv.[PaymentData], ''$.invoicePayment'') as float), 0) when ''Authorize'' then isnull(cast(json_value(inv.[PaymentData], ''$.invoicePayment'') as float), 0) else 0 end as TotalPaid
		,cast(isnull(json_value(inv.[PaymentData], ''$.creditApplied''), 0) as float) as Credit
		,isnull((inv.InvoiceAmount - (case inv.[Status] when ''InProcess'' then isnull(cast(json_value(inv.[PaymentData], ''$.invoicePayment'') as float), 0) when ''Paid'' then isnull(cast(json_value(inv.[PaymentData], ''$.invoicePayment'') as float), 0) when ''Authorize'' then isnull(cast(json_value(inv.[PaymentData], ''$.invoicePayment'') as float), 0) else 0 end)),0) as TotalBalance
		,inv.isDocsSubmitted as DocsReceived
		,inv.[Remarks] as Remarks
		,'''' as ProviderAddress1'
		+case 
			when @VendorType = 'MFG' then ','''' as ProviderLegalBusinessName'
			else ',(select ProviderName from provider.ProviderProfiles where provider.ProviderProfiles.ProviderId = inv.ProviderId) as ProviderLegalBusinessName'
			end
		+'
		,json_value(inv.[PaymentData], ''$.paymentMethod'') as PaymentMethod
		,isnull(va.[VendorPreferredPaymentType], ''CHECK'') as PreferredPaymentType
		,va.[VendorAccountID] as VendorAccountId
		from [accounts].[Invoices] as inv
		join (select distinct i.invoiceid,(select top 1 itemdata from [accounts].[InvoiceItems] where invoiceid = i.invoiceid) itemdata,i.Quantity,i.Cost from
		(select invitm.invoiceid, invitm.ItemData,invitm.Quantity,invitm.Cost 
		from [accounts].[Invoices] inv
		left join [accounts].[InvoiceItems] invitm
		on inv.Invoiceid=invitm.Invoiceid
		)i) as invitm on(inv.Invoiceid=invitm.Invoiceid)
		
		join [Orders].[OrderTransactionDetails] as otd CROSS APPLY OPENJSON(otd.OrderTransactionData) WITH (poDate date ''$.poDate'') as TransactionDatajsonValues on(otd.[OrderID]=inv.OrderID) and [OrderStatusCode]=''PO''
		join [Orders].[Orders] as ord on inv.OrderId=ord.OrderId
		join [catalog].[Brands] as bb on (bb.[BrandCode] = inv.BrandCode)
		left join [catalog].[BrandShippingFees] as ship on(inv.BrandCode = ship.[BrandCode])'                                                           
		+case when @VendorType = 'PRO' then ' left join [accounts].[VendorAccounts] as va on (pp.ProviderId = va.[ProviderId])'
		when @VendorType = 'MFG' then ' left join [accounts].[VendorAccounts] as va on (inv.brandCode = va.[BrandCode])'
		 else '' end+'
		where inv.IsActive = 1 and inv.VendorType = '''+@VendorType+''' and inv.InvoiceId in (select value from openjson(''' +@InvoiceIds +''') with (value bigint ''$''))'

set @sqlq2 = 'Select row_number() over (order by i.InvoiceDueDate) as RowID, i.* from (' + @sqlq1 + ') i';

exec (@sqlq2);
end


CREATE procedure [accounts].[sp_ProviderPaymentByAllocationAmount]
(
	@ProviderIds nvarchar(200),
	@IncludeProviderName bit = 1,
	@ProviderLegalName nvarchar(100),
	@POFromDate nvarchar(50),
	@POToDate nvarchar(50),
	@DocsReceived nvarchar(5),
	@InvoiceStatuses_json nvarchar(100),
	@OrderStatuses_json nvarchar(100),
	@IncludeBrands bit,
	@BrandCodes_json nvarchar(100)
)
as
begin
declare @sqlq1 nvarchar(max);
declare @sqlq2 nvarchar(max);
set @sqlq1 = 'select distinct 
inv.[InvoiceID] as InvoiceId
,inv.BrandCode
,isnull(cast(json_value(invitem.[ItemData], ''$.orderId'' ) as bigint),0) as OrderId
,json_value(invitem.[ItemData], ''$.orderStatus'') as OrderStatus
,json_value(invitem.[ItemData], ''$.orderType'') as OrderType
,inv.[Status] as ActualInvoiceStatus
,(case when json_value(invitem.[ItemData], ''$.orderStatus'') = ''ACTIVE'' then (case when (inv.[Status]=''Initiated'') then (case when inv.isDocsSubmitted = 1 and inv.InvoiceDueDate < getdate() then ''Due'' else ''Open'' end) else inv.[Status] end) else ''VOID'' end) as DerivedInvoiceStatus
--,cast(json_value(invitem.[ItemData], ''$.fittingDate'') as date) as FittingDate
,DateAdd(day,-60,inv.invoiceDueDate) FittingDate
,cast(json_value(invitem.[ItemData], ''$.docsReceivedDate'') as date) as DocsReceivedDate
,isnull(datediff(day, convert(nvarchar, cast(json_value(invitem.[ItemData], ''$.fittingDate'') as date), 111), convert(nvarchar, getdate(), 111)), 0) as ServiceDays
,concat(json_value(invitem.[ItemData], ''$.memberFirstName''), '''', json_value(invitem.[ItemData], ''$.memberLastName'')) as MemberName
,json_value(invitem.[ItemData], ''$.nhMemberId'') as NHMemberId
,inv.[PONumber] as PONumber
,inv.ProviderId as ProviderId
,cast(json_value(invitem.[ItemData], ''$.poDate'') as date) as PODate
,inv.[InvoiceDueDate] as InvoiceDueDate
,isnull(cast(json_value(invitem.[ItemData], ''$.dispensingFee'') as float),0) as DispensingFee
,isnull(cast(json_value(invitem.[ItemData], ''$.deviceCount'') as int),0) as DeviceCount
,inv.InvoiceAmount as TotalFee
,case inv.[Status] when ''InProcess'' then isnull(cast(json_value(inv.[PaymentData], ''$.InvoicePayment'') as float), 0) when ''Paid'' then isnull(cast(json_value(inv.[PaymentData], ''$.InvoicePayment'') as float), 0) when ''Authorize'' then isnull(cast(json_value(inv.[PaymentData], ''$.InvoicePayment'') as float), 0) else 0 end as TotalPaid
,cast(isnull(json_value(inv.[PaymentData], ''$.CreditApplied''), 0) as float) as Credit
,(inv.InvoiceAmount - (case inv.[Status] when ''InProcess'' then isnull(cast(json_value(inv.[PaymentData], ''$.InvoicePayment'') as float), 0) when ''Paid'' then isnull(cast(json_value(inv.[PaymentData], ''$.InvoicePayment'') as float), 0) when ''Authorize'' then isnull(cast(json_value(inv.[PaymentData], ''$.InvoicePayment'') as float), 0) else 0 end)) as TotalBalance
,case when json_value(invitem.[ItemData], ''$.docsReceivedDate'') is null then cast(0 as bit) else cast(1 as bit) end as DocsReceived
,inv.[Remarks] as Remarks
,json_value(pp.AdditionalData, ''$.billingAddress.address1'') as ProviderAddress1
,pp.ProviderName as ProviderLegalBusinessName,'''' as PaymentMethod,isnull(va.[VendorPreferredPaymentType], ''CHECK'') as PreferredPaymentType
, va.[VendorAccountID] as VendorAccountId
from [accounts].[Invoices] as inv
join [accounts].[InvoiceItems] as invitem on(inv.InvoiceId=invitem.InvoiceId)
left join [provider].[ProviderProfiles] as pp
on (pp.[ProviderId] = inv.ProviderId )'
+' left join (select * from [accounts].[InvoiceTransactions] where [InvoiceType]=''PAY'' and [Status] = ''Authorized'') as invt
on (invt.InvoiceId = inv.InvoiceId)
left join [accounts].[VendorAccounts] as va
on (pp.ProviderId = va.[ProviderId])
where inv.IsActive = 1 and inv.VendorType = ''PRO'' and pp.IsActive = 1';

 set @sqlq2 = 'Select row_number() over (order by i.InvoiceDueDate) as RowID,  i.* from (' + @sqlq1 
+case when @ProviderLegalName is not null and @ProviderLegalName <> '' then ' and pp.[ProviderName]'+(case @IncludeProviderName when 0 then ' not like ' else ' like ' end)+'''%'+@ProviderLegalName+'%'' ' else '' end
+case when @ProviderIds is not null and @ProviderIds <> '' then ' and pp.ProviderId in (select value from openjson('''+@ProviderIds+''')) ' else '' end
+case when @POFromDate is not null and @POFromDate <> '' then (' and convert(nvarchar, cast(DateAdd(day,-60,inv.invoiceDueDate) as date), 111) >= convert(nvarchar, cast('''+@POFromDate+''' as date), 111)') else '' end
+case when @POToDate is not null and @POToDate <> '' then (' and convert(nvarchar, cast(DateAdd(day,-60,inv.invoiceDueDate) as date), 111) <= convert(nvarchar, cast('''+@POToDate+''' as date), 111)') else '' end
+case when @InvoiceStatuses_json is not null and @InvoiceStatuses_json <> '' then (' and (case when json_value(invitem.[ItemData], ''$.orderStatus'') = ''ACTIVE'' then (case when (inv.[Status]=''Initiated'') then (case when inv.isDocsSubmitted = 1 and inv.InvoiceDueDate < getdate() then ''Due'' else ''Open'' end) else inv.[Status] end) else ''VOID'' end)
 in (select value from openjson('''+@InvoiceStatuses_json+'''))') else '' end
+case when @OrderStatuses_json is not null and @OrderStatuses_json <> '' then ' and json_value(invitem.[ItemData], ''$.orderStatus'') in (select value from openjson('''+@OrderStatuses_json+''')) ' else '' end
+case when @BrandCodes_json is not null and @BrandCodes_json <> '' then (' and inv.[BrandCode] '+(case @IncludeBrands when 1 then 'in' else 'not in' end)+' (select value from openjson('''+ @BrandCodes_json + ''') with (value nvarchar(15) ''$''))') else '' end
+case when @DocsReceived = 'yes' then ' and cast(json_value(invitem.[ItemData], ''$.docsReceivedDate'') as date) is not null' when @DocsReceived = 'no' then ' and (convert(nvarchar, cast(json_value(invitem.[ItemData], ''$.docsReceivedDate'') as date),111) is null)' else '' end + ') i';
--print (@sqlq2);
--,convert(nvarchar, cast(json_value(invitem.[ItemData], ''$.poDate'') as date), 101) as PODate
--,(select sum([CreditAmount]-[ClearedAmount]) from [accounts].[CreditMemos] where [ProviderID]=cast(json_value(inv.[ProviderData], ''$.providerId'') as bigint)) as Credit
exec (@sqlq2);
end



CREATE procedure [accounts].[sp_ProviderPaymentByAllocationAmountDetails]
(
	@ProviderIds nvarchar(200),
	@ProviderLegalName nvarchar(100),
	@POFromDate nvarchar(50),
	@POToDate nvarchar(50),
	@DocsReceived nvarchar(5),
	@InvoiceStatuses_json nvarchar(100),
	@OrderStatuses_json nvarchar(100),
	@IncludeBrands bit,
	@BrandCodes_json nvarchar(100)
)
as
begin
declare @sqlq1 nvarchar(max);
declare @sqlq2 nvarchar(max);
set @sqlq1 = 'select distinct 
inv.[InvoiceID] as InvoiceId
,inv.BrandCode
,isnull(cast(json_value(invitem.[ItemData], ''$.orderId'') as bigint),0) as OrderId
,json_value(invitem.[ItemData], ''$.orderStatus'') as OrderStatus
,json_value(invitem.[ItemData], ''$.orderType'') as OrderType
,inv.[Status] as ActualInvoiceStatus
,(case when json_value(invitem.[ItemData], ''$.orderStatus'') = ''ACTIVE'' then (case when (inv.[Status]=''Initiated'') then (case when inv.isDocsSubmitted = 1 and inv.InvoiceDueDate < getdate() then ''Due'' else ''Open'' end) else inv.[Status] end) else ''VOID'' end) as DerivedInvoiceStatus
--,cast(json_value(invitem.[ItemData], ''$.fittingDate'') as date) as FittingDate
,DateAdd(day,-60,inv.invoiceDueDate) FittingDate
,cast(json_value(invitem.[ItemData], ''$.docsReceivedDate'') as date) as DocsReceivedDate
,isnull(datediff(day, convert(nvarchar, cast(json_value(invitem.[ItemData], ''$.fittingDate'') as date), 111), convert(nvarchar, getdate(), 111)), 0) as ServiceDays
,concat(json_value(invitem.[ItemData], ''$.memberFirstName''), '''', json_value(invitem.[ItemData], ''$.memberLastName'')) as MemberName
,json_value(invitem.[ItemData], ''$.nhMemberId'') as NHMemberId
,inv.[PONumber] as PONumber
,inv.ProviderId as ProviderId
,cast(json_value(invitem.[ItemData], ''$.poDate'') as date) as PODate
,inv.[InvoiceDueDate] as InvoiceDueDate
,isnull(cast(json_value(invitem.[ItemData], ''$.dispensingFee'') as float),0) as DispensingFee
,isnull(cast(json_value(invitem.[ItemData], ''$.deviceCount'') as int),0) as DeviceCount
,inv.InvoiceAmount as TotalFee
,case inv.[Status] when ''InProcess'' then isnull(cast(json_value(inv.[PaymentData], ''$.InvoicePayment'') as float), 0) when ''Paid'' then isnull(cast(json_value(inv.[PaymentData], ''$.InvoicePayment'') as float), 0) when ''Authorize'' then isnull(cast(json_value(inv.[PaymentData], ''$.InvoicePayment'') as float), 0) else 0 end as TotalPaid
,cast(isnull(json_value(inv.[PaymentData], ''$.CreditApplied''), 0) as float) as Credit
,(inv.InvoiceAmount - (case inv.[Status] when ''InProcess'' then isnull(cast(json_value(inv.[PaymentData], ''$.InvoicePayment'') as float), 0) when ''Paid'' then isnull(cast(json_value(inv.[PaymentData], ''$.InvoicePayment'') as float), 0) when ''Authorize'' then isnull(cast(json_value(inv.[PaymentData], ''$.InvoicePayment'') as float), 0) else 0 end)) as TotalBalance
,case when json_value(invitem.[ItemData], ''$.docsReceivedDate'') is null then cast(0 as bit) else cast(1 as bit) end as DocsReceived
,inv.[Remarks] as Remarks
,json_value(pp.AdditionalData, ''$.billingAddress.address1'') as ProviderAddress1
,pp.ProviderName as ProviderLegalBusinessName,'''' as PaymentMethod,isnull(va.[VendorPreferredPaymentType], ''CHECK'') as PreferredPaymentType
, va.[VendorAccountID] as VendorAccountId
from [accounts].[Invoices] as inv
join [accounts].[InvoiceItems] as invitem on(inv.InvoiceId=invitem.InvoiceId)
left join [provider].[ProviderProfiles] as pp
on (pp.[ProviderId] = inv.ProviderId )'
+' left join (select * from [accounts].[InvoiceTransactions] where [InvoiceType]=''PAY'' and [Status] = ''Authorized'') as invt
on (invt.InvoiceId = inv.InvoiceId)
left join [accounts].[VendorAccounts] as va
on (pp.ProviderId = va.[ProviderId])
where inv.IsActive = 1 and inv.VendorType = ''PRO'' and pp.IsActive = 1';

 set @sqlq2 = 'Select row_number() over (order by i.InvoiceDueDate) as RowID,  i.* from (' + @sqlq1 
+case when @ProviderLegalName is not null and @ProviderLegalName <> '' then ' and pp.[ProviderName] like ''%'+@ProviderLegalName+'%'' ' else '' end
+case when @ProviderIds is not null and @ProviderIds <> '' then ' and pp.ProviderId in (select value from openjson('''+@ProviderIds+''')) ' else '' end
+case when @POFromDate is not null and @POFromDate <> '' then (' and convert(nvarchar, cast(DateAdd(day,-60,inv.invoiceDueDate) as date), 111) >= convert(nvarchar, cast('''+@POFromDate+''' as date), 111)') else '' end
+case when @POToDate is not null and @POToDate <> '' then (' and convert(nvarchar, cast(DateAdd(day,-60,inv.invoiceDueDate) as date), 111) <= convert(nvarchar, cast('''+@POToDate+''' as date), 111)') else '' end
+case when @InvoiceStatuses_json is not null and @InvoiceStatuses_json <> '' then (' and (case when json_value(invitem.[ItemData], ''$.orderStatus'') = ''ACTIVE'' then (case when (inv.[Status]=''Initiated'') then (case when inv.isDocsSubmitted = 1 and inv.InvoiceDueDate < getdate() then ''Due'' else ''Open'' end) else inv.[Status] end) else ''VOID'' end)
 in (select value from openjson('''+@InvoiceStatuses_json+'''))') else '' end
+case when @OrderStatuses_json is not null and @OrderStatuses_json <> '' then ' and json_value(invitem.[ItemData], ''$.orderStatus'') in (select value from openjson('''+@OrderStatuses_json+''')) ' else '' end
+case when @BrandCodes_json is not null and @BrandCodes_json <> '' then (' and inv.[BrandCode] '+(case @IncludeBrands when 1 then 'in' else 'not in' end)+' (select value from openjson('''+ @BrandCodes_json + ''') with (value nvarchar(15) ''$''))') else '' end
+case when @DocsReceived = 'yes' then ' and cast(json_value(invitem.[ItemData], ''$.docsReceivedDate'') as date) is not null' when @DocsReceived = 'no' then ' and (convert(nvarchar, cast(json_value(invitem.[ItemData], ''$.docsReceivedDate'') as date),111) is null)' else '' end + ') i';
--print (@sqlq2);
--,convert(nvarchar, cast(json_value(invitem.[ItemData], ''$.poDate'') as date), 101) as PODate
--,(select sum([CreditAmount]-[ClearedAmount]) from [accounts].[CreditMemos] where [ProviderID]=cast(json_value(inv.[ProviderData], ''$.providerId'') as bigint)) as Credit
exec (@sqlq2);
end

CREATE PROCEDURE [accounts].[GetProviderInvoiceStatistics]
(
	@FromFittingDate NVARCHAR(50) = null,
	@ToFittingDate NVARCHAR(50) = null,
	@option NVARCHAR(50)
)
AS
BEGIN
	DECLARE @Open float;
	DECLARE @OpenOrders float;
	DECLARE @DueWithDocs float;
	DECLARE @DueWithoutDocs float;
	DECLARE @Paid float;
	DECLARE @InvoiceStatistics TABLE(ID INT,OpenInvoiceAmount float, DueWithDocsInvoiceAmount float, DueWithNoDocsInvoiceAmount float, PaidInvoiceAmount float);	
	
	IF (@option = 'Default')
	Begin

		SET @Open = (SELECT ISNULL(SUM(i.InvoiceAmount),0)
							FROM [accounts].[invoices] i
							inner join orders.orders o on o.orderid = i.orderid 
							left join provider.providerprofiles pp on pp.providerid = i.providerid
							WHERE  i.InvoiceDueDate > getdate() AND i.VendorType = 'PRO' and  i.IsActive=1 and i.[status] = 'Initiated' and o.status = 'ACTIVE')
		SET @DueWithDocs = (SELECT ISNULL(SUM(i.InvoiceAmount),0)
							FROM [accounts].[invoices] i
							inner join orders.orders o on o.orderid = i.orderid
							left join provider.providerprofiles pp on pp.providerid = i.providerid
							WHERE  i.InvoiceDueDate < getdate() AND i.IsDocsSubmitted = 1 AND i.VendorType = 'PRO' and i.IsActive=1 and i.[status] = 'Initiated' and o.status = 'ACTIVE')
		SET @DueWithoutDocs = (SELECT ISNULL(SUM(i.InvoiceAmount),0)
								FROM [accounts].[invoices] i
								inner join orders.orders o
								on o.orderid = i.orderid
								left join provider.providerprofiles pp
								on pp.providerid = i.providerid
								WHERE  i.InvoiceDueDate < getdate() AND i.IsDocsSubmitted = 0 AND i.VendorType = 'PRO' and i.IsActive=1 and i.[status] = 'Initiated' and o.status = 'ACTIVE')
		SET @Paid = (SELECT ISNULL(SUM(i.InvoiceAmount),0)
						FROM [accounts].[invoices] i
						inner join orders.orders o on o.orderid = i.orderid
						left join provider.providerprofiles pp on pp.providerid = i.providerid
						--join accounts.invoicetransactions t on t.invoiceid = i.invoiceid
						where   i.VendorType = 'PRO'  and i.IsActive=1
						and i.[status] = 'Paid' and o.status = 'ACTIVE')
		
		--(SELECT ISNULL(SUM(InvoiceAmount),0) FROM [accounts].[invoices] i INNER JOIN [accounts].[invoiceTransactionDetails] itd ON i.InvoiceID = itd.invoiceID AND 
		--i.IsActive = 1 AND i.[status] = 'PAID' AND i.VendorType = 'PRO')

	End

	if (@option = 'Week')
	Begin

		SET @Open = (SELECT ISNULL(SUM(i.InvoiceAmount),0)
							FROM [accounts].[invoices] i
							inner join orders.orders o
							on o.orderid = i.orderid
							join provider.providerprofiles pp
							on pp.providerid = i.providerid

		WHERE CONVERT(NVARCHAR, i.InvoiceDueDate, 111) > CONVERT(NVARCHAR, CAST(@ToFittingDate AS DATE),111)  AND i.VendorType = 'PRO' and  i.IsActive=1 and i.[status] = 'Initiated' and o.status = 'ACTIVE')

		SET @DueWithDocs = (SELECT ISNULL(SUM(i.InvoiceAmount),0)
							FROM [accounts].[invoices] i
							inner join orders.orders o
							on o.orderid = i.orderid
							join provider.providerprofiles pp
							on pp.providerid = i.providerid
						WHERE   CONVERT(NVARCHAR, i.InvoiceDueDate, 111) < CONVERT(NVARCHAR, CAST(@ToFittingDate AS DATE),111) AND i.IsDocsSubmitted = 1 and  i.IsActive=1 AND i.VendorType = 'PRO' and i.[status] = 'Initiated' and o.status = 'ACTIVE')

		SET @DueWithoutDocs = (SELECT ISNULL(SUM(i.InvoiceAmount),0)
								FROM [accounts].[invoices] i
								inner join orders.orders o
								on o.orderid = i.orderid
								join provider.providerprofiles pp
								on pp.providerid = i.providerid
							WHERE CONVERT(NVARCHAR, i.InvoiceDueDate, 111) < CONVERT(NVARCHAR, CAST(@ToFittingDate AS DATE),111) AND i.IsDocsSubmitted = 0 and  i.IsActive=1 AND i.VendorType = 'PRO' and i.[status] = 'Initiated' and o.status = 'ACTIVE')

		SET @Paid = (SELECT ISNULL(SUM(i.InvoiceAmount),0)
						FROM [accounts].[invoices] i
						inner join orders.orders o on o.orderid = i.orderid
						left join provider.providerprofiles pp on pp.providerid = i.providerid where 
						--invoiceid in (select invoiceid from accounts.invoicetransactions) and 
						 i.VendorType = 'PRO'  and  i.IsActive=1
		and i.status = 'paid' and o.status = 'ACTIVE' and CONVERT(NVARCHAR, i.InvoiceDueDate, 111) < CONVERT(NVARCHAR, CAST(@ToFittingDate AS DATE),111))
		
		--(SELECT ISNULL(SUM(InvoiceAmount),0) FROM [accounts].[invoices] i INNER JOIN [accounts].[invoiceTransactions] it ON i.InvoiceID = it.invoiceID AND i.IsActive = 1 
		--AND i.[status] = 'PAID' AND i.VendorType = 'PRO')

	End

	else if (@option = 'Custom')
	Begin


	  (SELECT i.invoiceId,i.InvoiceAmount,i.invoicedate,i.InvoiceDueDate,i.VendorType,i.isActive,i.status AS istatus,o.status As ostatus,i.IsDocsSubmitted INTO #TEMPCUSTOM FROM [accounts].[invoices] i
				INNER JOIN orders.orders o ON o.orderid = i.orderid
				LEFT JOIN provider.providerprofiles pp ON pp.providerid = i.providerid
		WHERE  CONVERT(NVARCHAR, CAST(dateadd(day,-60,i.InvoiceDueDate)  AS DATE), 111) >=CONVERT(NVARCHAR, CAST(@FromFittingDate AS DATE),111)
		AND CONVERT(NVARCHAR, CAST(dateadd(day,-60,i.InvoiceDueDate)  AS DATE), 111) <= CONVERT(NVARCHAR, CAST(@ToFittingDate AS DATE),111) )

		SET @Open = (SELECT ISNULL(SUM(InvoiceAmount),0) FROM  #TEMPCUSTOM WHERE  InvoiceDueDate > getdate() AND VendorType = 'PRO' and  IsActive=1 and istatus = 'Initiated' and ostatus = 'ACTIVE')		

		SET @DueWithDocs =(SELECT ISNULL(SUM(InvoiceAmount),0) FROM  #TEMPCUSTOM WHERE  InvoiceDueDate < getdate() AND IsDocsSubmitted = 1 AND VendorType = 'PRO' and  IsActive=1 and istatus = 'Initiated' 
		and ostatus = 'ACTIVE')

		SET @DueWithoutDocs = (SELECT ISNULL(SUM(InvoiceAmount),0) FROM  #TEMPCUSTOM WHERE IsDocsSubmitted = 0 AND VendorType = 'PRO' and  IsActive=1 and istatus = 'Initiated' and ostatus = 'ACTIVE')

		SET @Paid = (SELECT ISNULL(SUM(InvoiceAmount),0) FROM  #TEMPCUSTOM WHERE  VendorType = 'PRO'  and IsActive=1
						and istatus= 'Paid' and ostatus = 'ACTIVE')
		
		--(SELECT ISNULL(SUM(i.InvoiceAmount),0) FROM [accounts].[invoices] i INNER JOIN [accounts].[invoiceTransactions] it On i.InvoiceID = it.invoiceID
	    --WHERE CONVERT(NVARCHAR, CAST(dateadd(day,-60,InvoiceDueDate)  AS DATE), 111) >= CONVERT(NVARCHAR, CAST(@FromFittingDate AS DATE),111)
		--AND CONVERT(NVARCHAR, CAST(dateadd(day,-60,InvoiceDueDate)  AS DATE), 111) <= CONVERT(NVARCHAR, CAST(@ToFittingDate AS DATE),111) AND i.IsActive = 1 AND i.[status] = 'PAID' AND i.VendorType = 'PRO')
	
	End
	INSERT INTO @InvoiceStatistics(ID,OpenInvoiceAmount,DueWithDocsInvoiceAmount,DueWithNoDocsInvoiceAmount,PaidInvoiceAmount) VALUES (1, (@Open), @DueWithDocs, @DueWithoutDocs, @Paid);
	SELECT ID,OpenInvoiceAmount, DueWithDocsInvoiceAmount,DueWithNoDocsInvoiceAmount,PaidInvoiceAmount FROM @InvoiceStatistics
End


CREATE procedure [accounts].[sp_ManufacturerPaymentByAllocationAmount]
(
	@ManufacturerIds nvarchar(200),
	@ManufacturerName nvarchar(100),
	@POFromDate nvarchar(50),
	@POToDate nvarchar(50),
	@DocsReceived nvarchar(5),
	@InvoiceStatuses_json nvarchar(100),
	@OrderStatuses_json nvarchar(100)
)
as
begin
declare @sqlq1 nvarchar(max);
declare @sqlq2 nvarchar(max);
set @sqlq1 = 'select distinct 
inv.[InvoiceID] as InvoiceId
,inv.[InvoiceNumber] as InvoiceNumber
,isnull(inv.OrderID,0) as OrderId
,ord.Status as OrderStatus
,ord.OrderType as OrderType
,inv.[Status] as ActualInvoiceStatus
,(case when (inv.[Status]=''Initiated'') then (case when  inv.InvoiceDueDate < getdate() then ''Due'' else ''Open'' end) else inv.[Status] end)  as DerivedInvoiceStatus
,inv.invoiceDate InvoiceDate
,cast(json_value(invitem.[ItemData], ''$.docsReceivedDate'') as date) as DocsReceivedDate
,isnull(datediff(day, convert(nvarchar, cast(json_value(invitem.[ItemData], ''$.fittingDate'') as date), 111), convert(nvarchar, getdate(), 111)), 0) as ServiceDays
,cast(isnull(json_value(inv.[PaymentData], ''$.creditApplied''), 0) as float) as Credit
,concat(json_value(ord.[MemberData], ''$.firstName''), '''', json_value(ord.[MemberData], ''$.lastName'')) as MemberName
,json_value(inv.[ProviderData], ''$.providerBusinessName'') as ProviderName
,inv.[PONumber] as PONumber
,bb.BrandId as BrandId
,bb.BrandName as BrandName
,bb.BrandCode as BrandCode
,bb.BrandAddress1 as BrandAddress1
,cast(json_Value(o.ordertransactionData, ''$.poDate'') as date) as PODate
,inv.[InvoiceDueDate] as InvoiceDueDate
,isnull(cast((invitem.Quantity * invitem.Cost) as float),0) as COGS
,isnull(cast(ship.ShippingAmount as float),0) as ShippingAmount
,isnull(cast(inv.InvoiceAmount as float),0) as TotalFee
,isnull(cast(0 as float),0) as RebateAmount
,isnull(cast(0 as float),0) as SalesTaxAmount
,case inv.[Status] when ''InProcess'' then isnull(cast(json_value(inv.[PaymentData], ''$.invoicePayment'') as float), 0) when ''Paid'' then isnull(cast(json_value(inv.[PaymentData], ''$.invoicePayment'') as float), 0) when ''Authorize'' then isnull(cast(json_value(inv.[PaymentData], ''$.invoicePayment'') as float), 0) else 0 end as TotalPaid
,(inv.InvoiceAmount - (case inv.[Status] when ''InProcess'' then isnull(cast(json_value(inv.[PaymentData], ''$.invoicePayment'') as float), 0) when ''Paid'' then isnull(cast(json_value(inv.[PaymentData], ''$.invoicePayment'') as float), 0) when ''Authorize'' then isnull(cast(json_value(inv.[PaymentData], ''$.invoicePayment'') as float), 0) else 0 end)) as TotalBalance
,inv.isDocsSubmitted as DocsReceived
,inv.[Remarks] as Remarks
,json_value(inv.[PaymentData], ''$.paymentMethod'') as PaymentMethod
,isnull(va.[VendorPreferredPaymentType], ''CHECK'') as PreferredPaymentType, va.[VendorAccountID] as VendorAccountId
from [accounts].[Invoices] as inv
join [accounts].[InvoiceItems] as invitem on(inv.InvoiceId=invitem.InvoiceId) 
join [Orders].[OrderTransactionDetails] as o on o.orderid = inv.orderid and o.orderstatusCode = ''PO''
join [Orders].[Orders] as ord on inv.OrderId=ord.OrderId
left join [catalog].[Brands] as bb
on (bb.[BrandCode] = inv.BrandCode )'
+'left join [accounts].[VendorAccounts] as va
on (inv.BrandCode = va.[BrandCode])
left join [catalog].[BrandShippingFees] as ship
on(inv.BrandCode = ship.[BrandCode])
where inv.IsActive = 1 and inv.VendorType = ''MFG'' and bb.IsActive = 1'
;
set @sqlq2 = 'Select row_number() over (order by i.InvoiceDueDate) as SNO,row_number() over (order by i.InvoiceDueDate) as RowID,  i.* from (' + @sqlq1+case when @ManufacturerName is not null and @ManufacturerName <> '' then ' and bb.[BrandName] like ''%'+@ManufacturerName+'%'' ' else '' end
+case when @ManufacturerIds is not null and @ManufacturerIds <> '' then ' and bb.BrandId in (select value from openjson('''+@ManufacturerIds+''')) ' else '' end
+case when @POFromDate is not null and @POFromDate <> '' then (' and convert(nvarchar, cast(json_Value(o.ordertransactionData, ''$.poDate'') as date), 111) >= convert(nvarchar, cast('''+@POFromDate+''' as date), 111)') else '' end
+case when @POToDate is not null and @POToDate <> '' then (' and convert(nvarchar, cast(json_Value(o.ordertransactionData, ''$.poDate'') as date), 111) <= convert(nvarchar, cast('''+@POToDate+''' as date), 111)') else '' end
+case when @InvoiceStatuses_json is not null and @InvoiceStatuses_json <> '' then (' and (case when (inv.[Status]=''Initiated'') then (case when inv.InvoiceDueDate < getdate() then ''Due'' else ''Open'' end) else inv.[Status] end)
 in (select value from openjson('''+@InvoiceStatuses_json+'''))') else '' end
+case when @OrderStatuses_json is not null and @OrderStatuses_json <> '' then (' and ord.Status in (select value from openjson('''+@OrderStatuses_json+''') with (value nvarchar(20) ''$''))') else '' end
+ ') i';
--case when @DocsReceived = 'yes' then ' and inv.isDocsSubmitted = 1' when @DocsReceived = 'no' then ' inv.isDocsSubmitted = 0' else '' end +
exec (@sqlq2);
end



CREATE PROCEDURE [accounts].[GetManufacturerInvoiceStatistics]
(
       @POFromDate NVARCHAR(50) = null,
       @POToDate NVARCHAR(50) = null,
       @option NVARCHAR(50)
)
AS
BEGIN
       DECLARE @Open float;
       DECLARE @OpenOrders float;
       DECLARE @Due float;
       DECLARE @Paid float;
       DECLARE @InvoiceStatistics TABLE(ID INT,OpenInvoiceAmount float, DueInvoiceAmount float, PaidInvoiceAmount float);     
       IF (@option = 'Default')
       Begin
              SET @Open = (SELECT ISNULL(SUM(i.InvoiceAmount),0)
							FROM [accounts].[invoices] i
							inner join orders.orders o
							on o.orderid = i.orderid
							join catalog.brands b on b.brandcode = i.brandcode 
			  WHERE CONVERT(NVARCHAR, i.InvoiceDueDate, 111) > CONVERT(NVARCHAR, getdate(), 111) AND i.IsActive = 1 AND i.VendorType = 'MFG' AND i.Status = 'Initiated' and o.status = 'ACTIVE')

              SET @Due = (SELECT ISNULL(SUM(i.InvoiceAmount),0)
							FROM [accounts].[invoices] i
							inner join orders.orders o
							on o.orderid = i.orderid
							join catalog.brands b on b.brandcode = i.brandcode 
							  WHERE i.IsActive = 1 AND CONVERT(NVARCHAR, i.InvoiceDueDate, 111) < CONVERT(NVARCHAR, getdate(), 111) AND i.VendorType = 'MFG' AND i.Status = 'Initiated' and o.status = 'ACTIVE')

              SET @Paid = (SELECT ISNULL(SUM(i.InvoiceAmount),0)
							FROM [accounts].[invoices] i
							inner join orders.orders o
							on o.orderid = i.orderid
							join catalog.brands b on b.brandcode = i.brandcode 
							WHERE i.Status = 'Paid' AND i.IsActive = 1 AND i.VendorType = 'MFG' and o.status = 'ACTIVE')

       End

       if (@option = 'Week')

       Begin
              SET @Open = (SELECT ISNULL(SUM(i.InvoiceAmount),0)
							FROM [accounts].[invoices] i
							inner join orders.orders o
							on o.orderid = i.orderid
							join catalog.brands b on b.brandcode = i.brandcode 
						WHERE CONVERT(NVARCHAR, i.InvoiceDueDate, 111) > CONVERT(NVARCHAR, CAST(@POToDate AS DATE),111) AND i.IsActive = 1 AND i.VendorType = 'MFG' and i.status = 'Initiated' and o.status = 'ACTIVE')

              SET @Due = (SELECT ISNULL(SUM(i.InvoiceAmount),0)
							FROM [accounts].[invoices] i
							inner join orders.orders o
							on o.orderid = i.orderid
							join catalog.brands b on b.brandcode = i.brandcode 
							WHERE i.IsActive = 1 AND CONVERT(NVARCHAR, i.InvoiceDueDate, 111) < CONVERT(NVARCHAR, CAST(@POToDate AS DATE),111) AND i.VendorType = 'MFG' and i.status = 'Initiated' and o.status = 'ACTIVE')

              SET @Paid = (SELECT ISNULL(SUM(i.InvoiceAmount),0)
							FROM [accounts].[invoices] i
							inner join orders.orders o
							on o.orderid = i.orderid
							join catalog.brands b on b.brandcode = i.brandcode 
							where i.IsActive = 1 AND i.status = 'Paid' AND i.VendorType = 'MFG' and o.status = 'ACTIVE')
       End
       else if (@option = 'Custom')
       Begin
         SET @Open = (SELECT ISNULL(SUM(inv.InvoiceAmount),0) FROM 
					 (select invoiceid, invoiceAmount, invoiceDueDate from [accounts].[invoices] i
					 INNER JOIN [Orders].[OrderTransactionDetails] t ON i.orderid = t.orderid and t.orderstatuscode = 'PO'
					 WHERE CONVERT(NVARCHAR, CAST(JSON_VALUE(t.[OrderTransactionData], '$.poDate') AS DATE), 111) >= CONVERT(NVARCHAR, CAST(@POFromDate AS DATE),111)
					 AND CONVERT(NVARCHAR, CAST(JSON_VALUE(t.OrderTransactionData, '$.poDate') AS DATE), 111) <= CONVERT(NVARCHAR, CAST(@POToDate AS DATE))
					 AND i.IsActive = 1 AND i.VendorType  = 'MFG' and i.status = 'Initiated') inv
					 where inv.InvoiceDueDate >  getdate())

         SET @Due = (SELECT ISNULL(SUM(inv.InvoiceAmount),0) FROM
					(select invoiceid, invoiceAmount,invoiceDueDate from [accounts].[invoices] i
					INNER JOIN [Orders].[OrderTransactionDetails] t ON i.orderid = t.orderid and t.orderstatuscode = 'PO'
					WHERE CONVERT(NVARCHAR, CAST(JSON_VALUE(t.[OrderTransactionData], '$.poDate') AS DATE), 111) >= CONVERT(NVARCHAR, CAST(@POFromDate AS DATE),111)
					AND CONVERT(NVARCHAR, CAST(JSON_VALUE(t.OrderTransactionData, '$.poDate') AS DATE), 111) <= CONVERT(NVARCHAR, CAST(@POToDate AS DATE))
					AND i.IsActive = 1 AND i.VendorType  = 'MFG'and status = 'Initiated') inv
					where inv.InvoiceDueDate <  getdate())

         SET @Paid = (SELECT ISNULL(SUM(inv.InvoiceAmount),0) FROM
					(select invoiceid, invoiceAmount,invoiceDueDate from [accounts].[invoices] i
					INNER JOIN [Orders].[OrderTransactionDetails] t ON i.orderid = t.orderid and t.orderstatuscode = 'PO'
					WHERE CONVERT(NVARCHAR, CAST(JSON_VALUE(t.[OrderTransactionData], '$.poDate') AS DATE), 111) >= CONVERT(NVARCHAR, CAST(@POFromDate AS DATE),111)
					AND CONVERT(NVARCHAR, CAST(JSON_VALUE(t.OrderTransactionData, '$.poDate') AS DATE), 111) <= CONVERT(NVARCHAR, CAST(@POToDate AS DATE))
					AND i.IsActive = 1 AND i.VendorType  = 'MFG' and i.status = 'PAID') inv)
					 End

				INSERT INTO @InvoiceStatistics(ID,OpenInvoiceAmount,DueInvoiceAmount,PaidInvoiceAmount) VALUES (1, @Open, @Due, @Paid);
				SELECT ID,OpenInvoiceAmount, DueInvoiceAmount,PaidInvoiceAmount FROM @InvoiceStatistics

End

 CREATE PROCEDURE [accounts].[sp_GetPendingApprovalInvoicesByBatch]
(
	@batchId BIGINT,
	@VendorType nvarchar(10)
)
AS
BEGIN

select ROW_NUMBER() OVER (ORDER BY r.InvoiceID) AS RowID
,r.* from
(SELECT distinct
pp.ProviderName AS 'ProviderName'
,pp.ProviderId as ProviderId
,br.[BrandID] as BrandId
,br.[BrandCode] as BrandCode
,br.[BrandName] as BrandName
,inv.InvoiceID
,inv.[InvoiceNumber] as InvoiceNumber
,JSON_VALUE(iit.[ItemData], '$.nhMemberId') AS 'NHMemberID'
,inv.PONumber
,JSON_VALUE(iit.[ItemData], '$.orderStatus') AS 'OrderStatus'
,convert(nvarchar,DateAdd(day,-60,inv.invoiceDueDate),110) FittingDate
,JSON_VALUE(iit.[ItemData], '$.memberFirstName')  + ' ' +  JSON_VALUE(iit.[ItemData], '$.memberLastName') AS 'MemberName'
,CAST(JSON_VALUE(iit.[ItemData], '$.dispensingFee') AS FLOAT) AS 'DispensingFee',CAST(InvoiceAmount AS FLOAT) AS InvoiceAmount
,cast(isnull(json_value(inv.PaymentData, '$.creditApplied'), 0) as float) AS Credit
,(InvoiceAmount - (case inv.[Status] when 'InProcess' then isnull(cast(json_value(inv.[PaymentData], '$.invoicePayment') as float), 0) when 'Paid' then isnull(cast(json_value(inv.[PaymentData], '$.invoicePayment') as float), 0) when 'Authorize' then isnull(cast(json_value(inv.[PaymentData], '$.invoicePayment') as float), 0) else 0 end) - CAST(0 AS FLOAT)) AS InvoicesSelected
,inv.BatchId as BatchID
FROM [accounts].[invoices] AS inv
INNER JOIN [accounts].[InvoiceItems] iit
on inv.InvoiceId = iit.InvoiceId
INNER  JOIN (SELECT * FROM accounts.InvoiceTransactions AS it WHERE it.[Status]='Approval' AND it.IsActive=1) AS invt
ON inv.InvoiceId = invt.InvoiceId
INNER JOIN provider.providerprofiles AS pp
ON inv.ProviderId = pp.ProviderId
left join [catalog].[Brands] br
on br.[BrandCode] = inv.[BrandCode]
WHERE (inv.VendorType=@VendorType) AND inv.[Status]='Approval' AND inv.ProviderId IS NOT NULL AND inv.BatchID = @batchId
)r

END


CREATE PROCEDURE [accounts].[getpoitems](
	@ItemType nvarchar(10),
	@PONumbers nvarchar(max)
	)
	AS
	BEGIN
		SELECT 
		[OrderItemId]
		,[OrderId]
		,[BrandCode]
		,[FamilyCode]
		,[StyleCode]
		,[TechnologyLevelCode]
		,[ProductModelCode]
		,case when [BrandCode] in ('gnr', 'beltone') then [ProductModelCode] else [ItemCode] end as [ItemCode]
		,[Modifier]
		,[Quantity]
		,[Amount]
		,[Status]
		,[UnitPrice]
		,[PairPrice]
		,[ItemData]
		,[ItemType]
		,[PONumber]
		,[InvoiceNumber]
		,[CreateUser]
		,[CreateDate]
		,[ModifyUser]
		,[ModifyDate]
		,[IsActive]
		FROM Orders.OrderItems
		WHERE IsActive=1 and
		ItemType=@ItemType and
		cast(PONumber as nvarchar) IN (SELECT value FROM openjson(@PONumbers) WITH (value nvarchar(15) '$'));
	end


CREATE PROCEDURE [accounts].[GetOpenPOs]
	@POFromDate NVARCHAR(50),
	@POToDate NVARCHAR(50),	
	@ManufacturerID BIGINT   
AS
BEGIN
    -- SET NOCOUNT ON added to prevent extra result sets from
    -- interfering with SELECT statements.

	SET NOCOUNT ON

	SELECT DISTINCT  
					B.Brandid,
					OI.BrandCode  ManufacturerName,
					CAST(OP.PONumber  AS VARCHAR) AS PONumber,	
					CONVERT(NVARCHAR,CAST(JSON_VALUE(OT.[OrderTransactionData],'$.poDate') AS DATE), 110) AS PODate,
					O.OrderId,
					CONVERT(VARCHAR,O.[DateOrderInitiated],110)  DateOrderInitiated,
					''  InvoiceNumber,
					''  InvoiceDueDate,
					''  InvoiceDate,
					B.[BrandEmail]  ManufacturerEmail,JSON_VALUE(FT.ORDERTRANSACTIONDATA, '$.fittingDate') FittingDate,
					B.[MFGContactNumber]  ManufacturerContactNumber,				
					case when AK.orderstatusCode is null then 'Pending' else 'Acknowledgement' end AckFromManufacturer,
				   ''  Remarks,
				    O.OrderId  ExceptionID
					INTO #TEMP1
					FROM  [Orders].[Orders] O
					INNER JOIN  [Orders].[OrderPOs] OP  ON OP.OrderId =  O.orderid
					INNER JOIN  [Orders].[OrderItems] OI ON OI.OrderId=O.OrderId
					INNER JOIN  [catalog].[Brands] B ON B.[BrandCODE] =  OI.[BrandCODE] 
					left JOIN  [Orders].[OrderTransactionDetails] FT ON FT.OrderId=O.OrderId 
								AND FT.orderstatusCode='CLM' 
								AND FT.Iscomplete =1 
								AND FT.isactive=1
					left JOIN  [Orders].[OrderTransactionDetails] AK ON AK.OrderId=O.OrderId 
								AND AK.orderstatusCode='ACK' 
								AND AK.Iscomplete =1 
								AND AK.isactive=1
					INNER JOIN  [Orders].[OrderTransactionDetails] OT ON OT.OrderId=OI.OrderId 
								AND OT.orderstatusCode='PO' 
								AND OT.Iscomplete =1 
								AND OT.isactive=1
								AND JSON_VALUE(OT.ORDERTRANSACTIONDATA, '$.poNumber')=CAST(OP.PONumber AS VARCHAR)
					            WHERE   O.ORDERID NOT IN (SELECT ORDERID FROM [accounts].[Invoices] WHERE VendorType ='MFG')
								order by O.ORDERID,poDate,PONumber

			IF(@ManufacturerID=0 AND @POFromDate='NULL' AND @POToDate ='NULL')
		 BEGIN
		  SELECT * FROM #TEMP1 
		  END

		ELSE IF(@ManufacturerID>0 AND @POFromDate='NULL' AND @POToDate ='NULL')
		 BEGIN
		  SELECT * FROM #TEMP1  
				WHERE Brandid=@ManufacturerID 
		  END

       ELSE IF(@ManufacturerID>0 AND @POFromDate='NULL' AND @POToDate IS NOT NULL)
		   BEGIN

				SELECT * FROM #TEMP1  
				WHERE Brandid=@ManufacturerID AND
				 (CONVERT(NVARCHAR,CAST(poDate AS DATE),101)  <= CONVERT(NVARCHAR, CAST(@POToDate AS DATE),101) ) 			 	
		END
		ELSE IF(@ManufacturerID=0 AND @POFromDate='NULL' AND @POToDate IS NOT NULL)
		BEGIN
			SELECT * FROM #TEMP1  
				WHERE 
				 (CONVERT(NVARCHAR,CAST(poDate AS DATE),101)  <= CONVERT(NVARCHAR, CAST(@POToDate AS DATE),101) ) 
		END	
		ELSE IF(@ManufacturerID>0 AND @POFromDate IS  NOT NULL AND @POToDate ='NULL')
		BEGIN
				SELECT * FROM #TEMP1  
				WHERE Brandid=@ManufacturerID AND
			  CONVERT(NVARCHAR,CAST(poDate AS DATE),101) >= CONVERT(NVARCHAR, CAST(@POFromDate AS DATE),101)	
		 END
		 ELSE IF(@ManufacturerID=0 AND @POFromDate IS  NOT NULL AND @POToDate ='NULL')
		BEGIN

			SELECT * FROM #TEMP1 
				 WHERE  CONVERT(NVARCHAR,CAST(poDate AS DATE),101) >= CONVERT(NVARCHAR, CAST(@POFromDate AS DATE),101)		 	
		END

		ELSE IF(@ManufacturerID>0 AND @POFromDate IS NOT NULL AND @POToDate IS NOT NULL)
		BEGIN

				SELECT * FROM #TEMP1  
				WHERE Brandid=@ManufacturerID 
				AND (CONVERT(NVARCHAR,CAST(poDate AS DATE),101)  >= CONVERT(NVARCHAR, CAST(@POFromDate AS DATE),101))
				AND (CONVERT(NVARCHAR,CAST(poDate AS DATE),101)  <= CONVERT(NVARCHAR, CAST(@POToDate AS DATE),101)) 			 	
		END
		ELSE IF(@ManufacturerID=0 AND @POFromDate IS NOT NULL AND @POToDate IS NOT NULL)
		BEGIN
				SELECT * FROM #TEMP1 
				 WHERE  CONVERT(NVARCHAR,CAST(poDate AS DATE),101) >= CONVERT(NVARCHAR, CAST(@POFromDate AS DATE),101)
			  AND  (CONVERT(NVARCHAR,CAST(poDate AS DATE),101)  <= CONVERT(NVARCHAR, CAST(@POToDate AS DATE),101)) 
		END
	
		DROP TABLE #TEMP1

END

CREATE PROCEDURE [accounts].[GetInvoiceExceptions](
	@POFromDate NVARCHAR(50),
	@POToDate NVARCHAR(50),
	@ExceptionType NVARCHAR(50),
	@InvoiceSource NVARCHAR(50),
	@ManufacturerID BIGINT
	)
	AS
		BEGIN	
			SELECT 
				e.ExceptionID,
				b.BrandName as 'ManufacturerName',
				e.PONumber,
				(CONVERT(NVARCHAR,po.PODate)) AS PODate,
				[InvoiceNumber],
				CONVERT(NVARCHAR(10),InvoiceDate,110) AS InvoiceDate,
				CONVERT(NVARCHAR(10),InvoiceDueDate,110) AS InvoiceDueDate,
				b.Brandemail AS 'ManufacturerEmail',
				b.MFGContactNumber AS 'ManufacturerContactNumber',
				'' as 'FittingDate',
				AckFromManufacturer,
				Remarks,
				PO.OrderId,
				'' as DateOrderInitiated 
		INTO #TEMP
			FROM [accounts].[InvoiceExceptions] e
			INNER JOIN [catalog].[Brands] b ON e.BrandCode = b.BrandCode			
			inner join [Orders].[OrderPOs] po on e.[PONumber] = cast(po.[PONumber] as nvarchar) and po.IsActive=1 
			
			
	IF(@POFromDate='NULL' AND @POToDate ='NULL')
		BEGIN
		SELECT * FROM #TEMP
		END
	 ELSE IF(@POFromDate='NULL' AND @POToDate IS NOT NULL)
		   BEGIN
		SELECT * FROM #TEMP
		WHERE (CONVERT(NVARCHAR,CAST(poDate AS DATE),101)  <= CONVERT(NVARCHAR, CAST(@POToDate AS DATE),101) ) 			 	
		END

	ELSE IF( @POFromDate IS  NOT NULL AND @POToDate ='NULL')
		BEGIN
				SELECT * FROM #TEMP 
				WHERE CONVERT(NVARCHAR,CAST(poDate AS DATE),101) >= CONVERT(NVARCHAR, CAST(@POFromDate AS DATE),101)	
		 END

	ELSE IF(@POFromDate IS NOT NULL AND @POToDate IS NOT NULL)
		BEGIN

				SELECT * FROM #TEMP 
				WHERE (CONVERT(NVARCHAR,CAST(poDate AS DATE),101)  >= CONVERT(NVARCHAR, CAST(@POFromDate AS DATE),101))
				AND (CONVERT(NVARCHAR,CAST(poDate AS DATE),101)  <= CONVERT(NVARCHAR, CAST(@POToDate AS DATE),101)) 			 	
		END
	END

	

-- exec [accounts].[sp_ProviderPaymentAggregateDetails_Test] '',1,'','','','all','["Open"]','["Active"]',0,'',0
CREATE procedure [accounts].[sp_ProviderPaymentAggregateDetails_Test]
(
       @ProviderIds nvarchar(200),
       @IncludeProviderName bit = 1,
       @ProviderLegalName nvarchar(100),
       @POFromDate nvarchar(50),
       @POToDate nvarchar(50),
       @DocsReceived nvarchar(5),
       @InvoiceStatuses_json nvarchar(100),
       @OrderStatuses_json nvarchar(100),
       @IncludeBrands bit,
       @BrandCodes_json nvarchar(100),
       @allocationAmount float
)
as
declare @Invoices table(
       ProviderId bigint,
       BrandCode nvarchar(15),
       InvoiceId bigint,
       InvoiceDueDate date,
       OrderId nvarchar(15),
       DerivedInvoiceStatus nvarchar(15),
       TotalFee float,
       TotalPaid float,
       TotalCredit float
);
declare @ProviderInvoices table(
       RunningTotal float,
       RowID bigint,
       ProviderId bigint,
       BrandCode nvarchar(15),
       InvoiceId bigint,
       InvoiceDueDate date,
       OrderId nvarchar(15),
       DerivedInvoiceStatus nvarchar(15),
       TotalFee float,
       TotalPaid float,
       TotalCredit float
);
begin
declare @sqlq nvarchar(max);
declare @sqlq2 nvarchar(max);
set @sqlq = 'select distinct
inv.ProviderId as ProviderId
,inv.[BrandCode] as BrandCode
,inv.[InvoiceID] as InvoiceId
,CONVERT(Date, inv.invoiceDueDate,101) invoiceDueDate
,o.OrderId
,(case when o.Status = ''ACTIVE'' then (case when (inv.[Status]=''Initiated'') then (case when inv.[IsDocsSubmitted] = 1 and inv.InvoiceDueDate < getdate() then ''Due'' when inv.InvoiceDueDate > getdate() then ''Open'' end) else inv.[Status] end) else ''VOID'' end) as DerivedInvoiceStatus
,inv.InvoiceAmount as TotalFee
,case inv.[Status] when ''InProcess'' then isnull(cast(json_value(inv.[PaymentData], ''$.invoicePayment'') as float), 0) when ''Paid'' then isnull(cast(json_value(inv.[PaymentData], ''$.invoicePayment'') as float), 0) when ''Authorize'' then isnull(cast(json_value(inv.[PaymentData], ''$.invoicePayment'') as float), 0) else 0 end as TotalPaid
,isnull(cast(json_value(inv.[PaymentData], ''$.creditApplied'') as float), 0) as TotalCredit
from [accounts].[Invoices] as inv
inner join [Orders].[Orders] o on o.orderid = inv.orderid 
left join [provider].[ProviderProfiles] as pp
on (pp.[ProviderId] = inv.ProviderId)'
+' where inv.IsActive = 1 and inv.VendorType = ''PRO'''
+case when @BrandCodes_json is not null and @BrandCodes_json <> '' then (' and inv.[BrandCode] '+(case @IncludeBrands when 1 then 'in' else 'not in' end)+' (select value from openjson('''+ @BrandCodes_json + ''') with (value nvarchar(15) ''$''))') else '' end
+case when @ProviderLegalName is not null and @ProviderLegalName <> '' then ' and pp.[ProviderName]'+(case @IncludeProviderName when 0 then ' not like ' else ' like ' end)+'''%'+@ProviderLegalName+'%'' ' else '' end
+case when @ProviderIds is not null and @ProviderIds <> '' then ' and pp.ProviderId in (select value from openjson('''+@ProviderIds+''')) ' else '' end
+case when @POFromDate is not null and @POFromDate <> '' then (' and convert(nvarchar, cast(DateAdd(day,-60,inv.invoiceDueDate) as date), 111) >= convert(nvarchar, cast('''+@POFromDate+''' as date), 111)') else '' end
+case when @POToDate is not null and @POToDate <> '' then (' and convert(nvarchar, cast(DateAdd(day,-60,inv.invoiceDueDate) as date), 111) <= convert(nvarchar, cast('''+@POToDate+''' as date), 111)') else '' end
+case when @InvoiceStatuses_json is not null and @InvoiceStatuses_json <> '' then (' and (case when o.Status = ''ACTIVE'' then (case when (inv.[Status]=''Initiated'') then (case when inv.[IsDocsSubmitted] = 1 and inv.InvoiceDueDate < getdate() then ''Due'' when inv.InvoiceDueDate > getdate() then ''Open'' end) else inv.[Status] end) else ''VOID'' end) in (select value from openjson('''+@InvoiceStatuses_json+''') with (value nvarchar(20) ''$''))') else '' end
+case when @OrderStatuses_json is not null and @OrderStatuses_json <> '' then (' and o.Status in (select value from openjson('''+@OrderStatuses_json+''') with (value nvarchar(20) ''$''))') else '' end
+case when @DocsReceived = 'yes' then ' and inv.isDocsSubmitted = 1' when @DocsReceived = 'no' then ' inv.isDocsSubmitted = 0' else '' end;

insert into @Invoices exec ('select i.*from ('+@sqlq + ')i order by InvoiceDueDate asc');

--print @sqlq

--SELECT *FROM @Invoices
--order by OrderId

insert into @ProviderInvoices
select sum(q.totalFee) over (order by q.RowID) runningTotal,q.* from (
SELECT row_number() over (order by p.InvoiceDueDate) as RowID, p.* from (SELECT *FROM @Invoices)p
)q  
order by q.InvoiceDueDate asc

select * from @ProviderInvoices

--select *from @ProviderInvoices where runningTotal < = @allocationAmount
if @allocationAmount > 0
              begin
              select 
                     row_number() over (order by pd.ProviderId) as RowID
                     ,pd.ProviderId as ProviderId
                     ,concat('[',string_agg(cast(pd.InvoiceId as nvarchar(max)),','), ']') as InvoiceIds
                     --,concat('[', string_agg(pd.[BrandCode], ', '), ']') as BrandCodes
                     ,pp.ProviderName as ProviderLegalBusinessName
                     ,json_value(pp.AdditionalData, '$.billingAddress.address1') as ProviderAddress1
                     ,json_value(pp.AdditionalData, '$.billingAddress.city') as ProviderCity
                     ,json_value(pp.AdditionalData, '$.billingAddress.state') as ProviderState
                     ,json_value(pp.AdditionalData, '$.billingAddress.zip') as ProviderZip
                     ,count(*) as MembersServed
                     ,sum(isnull(pd.TotalFee,0)) as TotalFee
                     ,sum(isnull(pd.TotalPaid, 0)) as TotalPaid
                     ,isnull(sum(isnull(pd.TotalFee,0) - isnull(pd.TotalPaid, 0)),0) as TotalBalance
                     ,isnull(sum(case when pd.DerivedInvoiceStatus = 'Due' then (pd.TotalFee - isnull(pd.TotalPaid, 0)) else 0 end),0) as TotalDueAmount
                     ,'' as MarkAsPaidJSON
                     ,'' as PaymentMethod
                     ,CAST(sum(pd.TotalCredit) AS FLOAT) as CreditAvailable
                     ,isnull(va.[VendorPreferredPaymentType], 'CHECK') as PreferredPaymentType
                     ,va.[VendorAccountID] as VendorAccountId
                     from @ProviderInvoices as pd
                     left join provider.ProviderProfiles as pp
                     on (pp.ProviderId = pd.ProviderId)
                     left join [accounts].[VendorAccounts] as va
                     on (pd.ProviderId = va.[ProviderId])
                     where pd.runningtotal <= @allocationAmount
                     group by pd.ProviderId, 
                     pp.ProviderName, va.[VendorAccountID], json_value(pp.AdditionalData, '$.billingAddress.address1'),
                     json_value(pp.AdditionalData, '$.billingAddress.city') ,json_value(pp.AdditionalData, '$.billingAddress.state')
                     ,json_value(pp.AdditionalData, '$.billingAddress.zip'), va.[VendorPreferredPaymentType]
                     
              end
else
              begin
                     select 
                     row_number() over (order by pd.ProviderId) as RowID
                     ,pd.ProviderId as ProviderId
                     ,concat('[',string_agg(cast(pd.InvoiceId as nvarchar(max)),','), ']') as InvoiceIds
                     --,concat('[', string_agg(pd.[BrandCode], ', '), ']') as BrandCodes
                     ,pp.ProviderName as ProviderLegalBusinessName
                     ,json_value(pp.AdditionalData, '$.billingAddress.address1') as ProviderAddress1
                     ,json_value(pp.AdditionalData, '$.billingAddress.city') as ProviderCity
                     ,json_value(pp.AdditionalData, '$.billingAddress.state') as ProviderState
                     ,json_value(pp.AdditionalData, '$.billingAddress.zip') as ProviderZip
                     ,count(*) as MembersServed
                     ,sum(isnull(pd.TotalFee,0)) as TotalFee
                     ,sum(isnull(pd.TotalPaid, 0)) as TotalPaid
                     ,isnull(sum(isnull(pd.TotalFee,0) - isnull(pd.TotalPaid, 0)),0) as TotalBalance
                     ,isnull(sum(case when pd.DerivedInvoiceStatus = 'Due' then (pd.TotalFee - isnull(pd.TotalPaid, 0)) else 0 end),0) as TotalDueAmount
                     ,'' as MarkAsPaidJSON
                     ,'' as PaymentMethod
                     ,CAST(sum(pd.TotalCredit) AS FLOAT) as CreditAvailable
                     ,isnull(va.[VendorPreferredPaymentType], 'CHECK') as PreferredPaymentType
                     ,va.[VendorAccountID] as VendorAccountId
                     from @ProviderInvoices as pd
                     left join provider.ProviderProfiles as pp
                     on (pp.ProviderId = pd.ProviderId)
                     left join [accounts].[VendorAccounts] as va
                     on (pd.ProviderId = va.[ProviderId])
                     group by pd.ProviderId, 
                     pp.ProviderName, va.[VendorAccountID], json_value(pp.AdditionalData, '$.billingAddress.address1'),
                     json_value(pp.AdditionalData, '$.billingAddress.city') ,json_value(pp.AdditionalData, '$.billingAddress.state')
                     ,json_value(pp.AdditionalData, '$.billingAddress.zip'), va.[VendorPreferredPaymentType] 
              end
end

CREATE view anthemelig.ViewAnthemMembers as
SELECT DISTINCT SUBSTRING(GROUPNUMBER,1,8) +'-'+ MemberIdentificationNumber newNHLinkID,
		MemberIdentificationNumber,
		MembersDateOfBirth,
		MedicaidNumber, 
		MedicareNumber,
		MemberLastName,
		MemberFirstName,
		MemberMiddleName,
		SocialSecurityNumber,
		MemberPhoneNumber,
		MemberAddressLine1,
		MemberAddressLine2,
		MemberCityName,
		MemberStateName,
		MemberZipCode,
		MemberDateOfDeath,
		MemberSex,
		MemberRace,
		MemberLanguage,
		MemberMailingAddressLine1,
		MemberMailingAddressLine2,
		MemberMailingCityName,
		MemberMailingStateName,
		MemberMailingZipCode
		from anthemelig.AnthemStgEligData
EXCEPT
SELECT 
		newNHLinkID,
		MemberIdentificationNumber,
		MembersDateOfBirth,
		MedicaidNumber, 
		MedicareNumber,
		MemberLastName,
		MemberFirstName,
		MemberMiddleName,
		SocialSecurityNumber,
		MemberPhoneNumber,
		MemberAddressLine1,
		MemberAddressLine2,
		MemberCityName,
		MemberStateName,
		MemberZipCode,
		MemberDateOfDeath,
		MemberSex,
		MemberRace,
		MemberLanguage,
		MemberMailingAddressLine1,
		MemberMailingAddressLine2,
		MemberMailingCityName,
		MemberMailingStateName,
		MemberMailingZipCode
from anthemelig.AnthemMembers
CREATE view anthemelig.ViewAnthemMemNotRcvd as
SELECT 
		newNHLinkID,
		MemberIdentificationNumber,
		MembersDateOfBirth,
		MedicaidNumber, 
		MedicareNumber,
		MemberLastName,
		MemberFirstName,
		MemberMiddleName,
		SocialSecurityNumber,
		MemberPhoneNumber,
		MemberAddressLine1,
		MemberAddressLine2,
		MemberCityName,
		MemberStateName,
		MemberZipCode,
		MemberDateOfDeath,
		MemberSex,
		MemberRace,
		MemberLanguage,
		MemberMailingAddressLine1,
		MemberMailingAddressLine2,
		MemberMailingCityName,
		MemberMailingStateName,
		MemberMailingZipCode
from anthemelig.AnthemMembers
EXCEPT
SELECT DISTINCT SUBSTRING(GROUPNUMBER,1,8) +'-'+ MemberIdentificationNumber newNHLinkID,
		MemberIdentificationNumber,
		MembersDateOfBirth,
		MedicaidNumber, 
		MedicareNumber,
		MemberLastName,
		MemberFirstName,
		MemberMiddleName,
		SocialSecurityNumber,
		MemberPhoneNumber,
		MemberAddressLine1,
		MemberAddressLine2,
		MemberCityName,
		MemberStateName,
		MemberZipCode,
		MemberDateOfDeath,
		MemberSex,
		MemberRace,
		MemberLanguage,
		MemberMailingAddressLine1,
		MemberMailingAddressLine2,
		MemberMailingCityName,
		MemberMailingStateName,
		MemberMailingZipCode
from anthemelig.AnthemStgEligData
CREATE view anthemelig.ViewAnthemInsurance as
SELECT	
SUBSTRING(GROUPNUMBER,1,8) +'-'+ MemberIdentificationNumber newNHLinkID,
	MemberIdentificationNumber,
SUBSTRING(ClassPlanProduct,0,5)  ClassID,
SUBSTRING(ClassPlanProduct,5,8)  PlanID,
SUBSTRING(ClassPlanProduct,13,8)  ProductCode,
EligibilityEffectiveDate,
EligibilityTerminationDate,
GroupNumber
FROM anthemelig.AnthemStgEligData 
EXCEPT 
SELECT 
newNHLinkID,
MemberIdentificationNumber,
ClassID,
PlanID,
ProductCode,
EligibilityEffectiveDate,
EligibilityTerminationDate,
GroupNumber
FROM anthemelig.AnthemInsurance
CREATE view anthemelig.ViewAnthemInsNotRcvd as
SELECT 
newNHLinkID,
MemberIdentificationNumber,
ClassID,
PlanID,
ProductCode,
EligibilityEffectiveDate,
EligibilityTerminationDate,
GroupNumber
FROM anthemelig.AnthemInsurance
EXCEPT
SELECT	
SUBSTRING(GROUPNUMBER,1,8) +'-'+ MemberIdentificationNumber newNHLinkID,
	MemberIdentificationNumber,
SUBSTRING(ClassPlanProduct,0,5)  ClassID,
SUBSTRING(ClassPlanProduct,5,8)  PlanID,
SUBSTRING(ClassPlanProduct,13,8)  ProductCode,
EligibilityEffectiveDate,
EligibilityTerminationDate,
GroupNumber
FROM anthemelig.AnthemStgEligData 
--exec [auth].[Get_UserDefaultRoleID] 1689,'NH.Provider'
CREATE PROCEDURE [auth].[Get_UserDefaultRoleID] 
	@UserProfileID bigint,
	@ClientID varchar(50) = 'NH.Provider'
AS
BEGIN
/*
Author: Mohan Nanduri 
Date: August 20 2018
Desription 1: This stored procedure returns Highest Previlised UserGroup and and that Groups RoleID of a given MemberProfileID and give ClientID (AppModuleID)
Description 2 : IsActive conditions Added on Nov 11 2018
*/

DECLARE @AppModuleId BIGINT
DECLARE @HomePage varchar(50)
SET @HomePage = NULL
IF (@ClientID =  'NH.Provider') 
BEGIN
     SET @AppModuleId=1 
	 SET @HomePage= '/' 
END
ELSE IF (@ClientID =  'NH.CallCenter') 
BEGIN 
     SET @AppModuleId=4
	 SET @HomePage= '/Call/Home' 
END
ELSE IF (@ClientID =  'NH.Accounts') 
BEGIN 
     SET @AppModuleId=3
END
ELSE IF (@ClientID =  'NH.Admin') 
BEGIN 
     SET @AppModuleId=2
END
ELSE
     SET @AppModuleId=1 

	-- SET NOCOUNT ON added to prevent extra result sets from
	-- interfering with SELECT statements.
	SET NOCOUNT ON;

  SELECT TOP 1 A.[UserProfileId], A.[UserGroupId], B.[DefaultAppModuleRoleId], case when @HomePage is null then C.[AppModuleRoleMenuPage] else @HomePage end as 'HomePage', cast(S.[SettingValue] as bigint) as 'DefaultLocationId'
  FROM [auth].[UserProfileGroups] A WITH (NOLOCK)
  INNER JOIN [auth].[UserGroups] B WITH (NOLOCK) ON B.[UserGroupId] = A.[UserGroupId]
  INNER JOIN [auth].[AppModuleRoleMenus] C WITH (NOLOCK) ON C.[AppModuleRoleId] = B.[DefaultAppModuleRoleId] and C.[AppModuleRoleMenuName] = 'Home'
  INNER JOIN [auth].[UserGroupModules] D WITH (NOLOCK) ON D.[UserGroupId] = A.[UserGroupId] and D.[AppModuleId] = @AppModuleId
  LEFT JOIN (
	select T.[SettingValue], T.[UserProfileId]
	from [auth].[UserProfileSettings] T
	inner join [provider].[ProviderUserLocations] pul
	on pul.[UserProfileId]=T.[UserProfileId] and cast(T.[SettingValue] as bigint)=pul.[LocationId]
	where T.[UserProfileId]=@UserProfileID and T.[IsActive]=1 and pul.[IsActive]=1 and T.[SettingName]='LocationId'
	) S
	ON S.[UserProfileId]=A.[UserProfileId]
  WHERE 
  A.[UserProfileId] = @UserProfileID AND A.IsActive=1 AND B.IsActive=1 AND C.IsActive=1 AND D.IsActive=1
END
CREATE PROCEDURE [auth].[Get_UserProfileByProviderCode]       
 @ProviderCode Varchar(50),      
 @SecurityCode Varchar(50)    
/*      
Author: Srinivas G      
Date: December 19 2018      
Desription 1: This stored procedure returns profile details by providercode which are IsActive=1      
*/      
AS      
BEGIN      
select UP.UserProfileId,UP.TemproryKeyCode,UP.ProviderCode,PP.ProviderName,UP.UserName from [AUTH].[UserProfiles] as UP     
left join [provider].[ProviderUsers] as PU on PU.USERPROFILEID=UP.UserProfileId
left join [provider].[ProviderProfiles] as PP on PP.PROVIDERID=PU.PROVIDERID
where UP.providercode=@ProviderCode and UP.TemproryKeyCode=@SecurityCode and UP.isactive=1 order by UP.UserProfileId desc      
END
--EXEC [auth].[VerifyUserSecurityCode] '180000','dcooper'
CREATE PROCEDURE [auth].[VerifyUserSecurityCode]    
(    
    @providerCode nvarchar(20),    
    @securityCode nvarchar(30)    
)    
AS    
BEGIN    
	  select UP.UserProfileId,UP.IsRegister,UP.TemproryKeyCode,UP.ProviderCode,PP.ProviderName,UP.UserName from [AUTH].[UserProfiles] as UP     
		left join [provider].[ProviderUsers] as PU on PU.USERPROFILEID=UP.UserProfileId
		left join [provider].[ProviderProfiles] as PP on PP.PROVIDERID=PU.PROVIDERID
	  where UP.providercode=@providerCode  and UP.TemproryKeyCode=@securityCode  and UP.isactive=1 order by UP.UserProfileId desc    
END
CREATE procedure [auth].[GetUserMenusAndFeatures] (
	@UserProfileId bigint, @ProviderId bigint, @AppmoduleId bigint
)
as
begin

select *from (
select
	ROW_NUMBER() OVER(ORDER BY c.MenuId, c.SubMenuId ASC) AS RowId,@UserProfileId as 'UserProfileId', @ProviderId as 'ProviderId',c.RoleId as 'RoleId', c.RoleName as 'RoleName',
	c.MenuId,case when (@AppmoduleId = 4 and c.MenuName = 'Today''s Appointments') then 'Home' else c.MenuName end as MenuName,c.MenuPage,cast(c.MenuIcon as varchar) as MenuIcon,c.SubMenuId,c.SubMenuName,c.SubMenuPage,cast(c.SubMenuIcon as varchar) as SubMenuIcon
	,af.[AppFeatureId], af.[FeatureSectionName], af.[FeatureName], af.[FeatureCode], af.[IsSystemFeature]
	,cast((case puf.[IsCreate] when 0 then 0 else (case when af.[IsCreate]=1 then 1 when af.[FeatureCode] is not null then 0 else null end) end) as bit) as 'IsCreate'
	,cast((case puf.[IsRead] when 0 then 0 else (case when af.[IsRead]=1 then 1 when af.[FeatureCode] is not null then 0 else null end) end) as bit) as 'IsRead'
	,cast((case puf.[IsUpdate] when 0 then 0 else (case when af.[IsUpdate]=1 then 1 when af.[FeatureCode] is not null then 0 else null end) end) as bit) as 'IsUpdate'
	,cast((case puf.[IsDelete] when 0 then 0 else (case when af.[IsDelete]=1 then 1 when af.[FeatureCode] is not null then 0 else null end) end) as bit) as 'IsDelete'
	from (
	select
	min(r.[AppModuleRoleId]) 'RoleId',min(r.[AppModuleRoleName]) as 'RoleName',min(mn.[AppModuleRoleMenuId]) as 'MenuId',mn.[AppModuleRoleMenuName] as 'MenuName'
	,mn.[AppModuleRoleMenuPage] as 'MenuPage',min(mn.[AppModuleRoleMenuIconImage]) as 'MenuIcon'
	,min(smn.[AppModuleRoleMenuSubmenuId]) as 'SubMenuId',smn.[AppModuleRoleMenuSubmenuName] as 'SubMenuName'
	,smn.[AppModuleRoleMenuSubmenuPage] as 'SubMenuPage',min(smn.[AppModuleRoleMenuSubmenuIconImage]) as 'SubMenuIcon'
	from [auth].[AppModuleRoleMenus] mn
	inner join [auth].[AppModuleRoles] r on mn.[AppModuleRoleId] = r.[AppModuleRoleId]
	inner join [auth].[UserGroupModuleRoles] ugmr on ugmr.[AppModuleRoleId]=r.[AppModuleRoleId]
	inner join [auth].[UserProfileGroups] ugrps on ugrps.[UserGroupId] = ugmr.[UserGroupId]

	left join [auth].[AppModuleRoleMenuSubmenus] smn on smn.[AppModuleRoleMenuId] = mn.[AppModuleRoleMenuId]
	where ugrps.[UserProfileId] = @UserProfileId and r.[AppModuleId] = @AppmoduleId and r.[IsActive]=1 and ugmr.[IsActive]=1 and ugrps.[IsActive]=1 and mn.[IsActive]=1 and (smn.[IsActive]=1 or smn.[IsActive] is null)
	group by mn.[AppModuleRoleMenuName], mn.[AppModuleRoleMenuPage], smn.[AppModuleRoleMenuSubmenuName], smn.[AppModuleRoleMenuSubmenuPage]
	) c

	left outer join [auth].[AppModuleRoleMenuSubMenuFeatures] pfmap on pfmap.[AppModuleRoleMenuId]=c.MenuId and (pfmap.[AppModuleRoleMenuSubMenuId]=c.SubMenuId or c.SubMenuId is null)
	left outer join [auth].[ApplicationFeatures] af on af.[FeatureCode] = pfmap.[AppFeatureCode]
	left outer join [auth].[ProviderUserFeatures] puf on puf.[AppFeatureCode]=af.[FeatureCode] and puf.[UserProfileId]=@UserProfileId and puf.[ProviderID]=@ProviderId
where not exists (select * from [auth].[ProviderFeatures] pf where pf.[AppFeatureCode]=af.[FeatureCode] and pf.[ProviderId]=@ProviderId and pf.[IsActive]=1)
)a where (a.IsCreate <> 0 or a.IsRead <> 0 or a.IsUpdate <> 0) or a.MenuName = 'Today''s Appointments' or a.MenuName = 'Home' or a.SubMenuName = 'Engagement' or a.MenuName = 'Download Documents'
ORDER BY
(CASE WHEN a.MenuName = 'Home' THEN 0 ELSE 1 END)
end
CREATE TRIGGER [auth].[ProviderLoginHistoryUpdates] ON [auth].[UserProfiles]
For Insert ,Update 
AS  
BEGIN
	INSERT INTO [provider].[ProviderLoginHistory](
	UserProfileId,
	ProviderCode,
	UserName,
	Designation,
	FirstName,
	LastName,
	MiddleName,
	Title,
	LastLoginDate,
	IsActive,
	IsVerified)	
	SELECT [UserProfileId],
	[ProviderCode],
	[UserName],
	[Designation],
	[FirstName],
	[LastName],
	[MiddleName],
	[Title],
	[LastLoginDate],
	[IsActive],
	[IsVerified]
  FROM INSERTED  where [ProviderCode] <> '180000'
END
-- EXEC bireports.sp_rpt_managed_care_dashboard 'D'
-- EXEC bireports.sp_rpt_managed_care_dashboard 'M'
CREATE proc [bireports].[sp_rpt_managed_care_dashboard] (@DateRange char(1))
as 



Declare @StartDate date;
Declare @EndDate date;

		-- Returns previous day when run on any weekday except Monday, date goes back to last Friday if it runs on Monday
		-- Use this for reports to include previous day data and runs from Monday to Friday only
		if @DateRange='D'
		begin
			set @StartDate = case when DATEPART(WEEKDAY,CONVERT(DATE,CAST(GETDATE() AT TIME ZONE 'UTC' AT TIME ZONE 'Eastern Standard Time' AS DATE))) <> 2 
							  then DATEADD(DAY,-1,CONVERT(DATE,CAST(GETDATE() AT TIME ZONE 'UTC' AT TIME ZONE 'Eastern Standard Time' AS DATE))) 
							  when DATEPART(WEEKDAY,CONVERT(DATE,CAST(GETDATE() AT TIME ZONE 'UTC' AT TIME ZONE 'Eastern Standard Time' AS DATE))) = 2 
			                  then DATEADD(DAY,-3,CONVERT(DATE,CAST(GETDATE() AT TIME ZONE 'UTC' AT TIME ZONE 'Eastern Standard Time' AS DATE)))
							  END
			set @EndDate = case when DATEPART(WEEKDAY,CONVERT(DATE,CAST(GETDATE() AT TIME ZONE 'UTC' AT TIME ZONE 'Eastern Standard Time' AS DATE))) <> 2 
							  then DATEADD(DAY,-1,CONVERT(DATE,CAST(GETDATE() AT TIME ZONE 'UTC' AT TIME ZONE 'Eastern Standard Time' AS DATE))) 
							  when DATEPART(WEEKDAY,CONVERT(DATE,CAST(GETDATE() AT TIME ZONE 'UTC' AT TIME ZONE 'Eastern Standard Time' AS DATE))) = 2 
			                  then DATEADD(DAY,-3,CONVERT(DATE,CAST(GETDATE() AT TIME ZONE 'UTC' AT TIME ZONE 'Eastern Standard Time' AS DATE)))
							  END
		end

		-- Returns first day and yesterday of the current month as start and end dates when run on any day except 1st day of any month, if run on 1st of any month gives first and last date of the previous month
		-- Use this for reports that should include MTD data and runs every day in a month.
		if @DateRange='M'
		begin
			set @StartDate = case when DATEPART(DAY,CONVERT(DATE,CAST(GETDATE() AT TIME ZONE 'UTC' AT TIME ZONE 'Eastern Standard Time' AS DATE))) <> 1
									then DATEADD(MONTH, DATEDIFF(MONTH, 0, CAST(GETDATE() AT TIME ZONE 'UTC' AT TIME ZONE 'Eastern Standard Time' AS DATE)), 0) 
								  when DATEPART(DAY,CONVERT(DATE,CAST(GETDATE() AT TIME ZONE 'UTC' AT TIME ZONE 'Eastern Standard Time' AS DATE))) = 1 
									then  DATEADD(MONTH, DATEDIFF(MONTH, 0, CAST(GETDATE() AT TIME ZONE 'UTC' AT TIME ZONE 'Eastern Standard Time' AS DATE))-1, 0)  
							  END
			--set @StartDate='05/01/2019'
			set @EndDate = case when (DATEPART(DAY,CONVERT(DATE,CAST(GETDATE() AT TIME ZONE 'UTC' AT TIME ZONE 'Eastern Standard Time' AS DATE))) <> 1) and (DATEPART(WEEKDAY,CONVERT(DATE,CAST(GETDATE() AT TIME ZONE 'UTC' AT TIME ZONE 'Eastern Standard Time' AS DATE))) <> 2)
									then DATEADD(DAY, DATEDIFF(DAY, 0, CAST(GETDATE()-1 AT TIME ZONE 'UTC' AT TIME ZONE 'Eastern Standard Time' AS DATE)), 0) 
								when (DATEPART(DAY,CONVERT(DATE,CAST(GETDATE() AT TIME ZONE 'UTC' AT TIME ZONE 'Eastern Standard Time' AS DATE))) <> 1) and (DATEPART(WEEKDAY,CONVERT(DATE,CAST(GETDATE() AT TIME ZONE 'UTC' AT TIME ZONE 'Eastern Standard Time' AS DATE))) = 2)
									then DATEADD(DAY, DATEDIFF(DAY, 0, CAST(GETDATE()-3 AT TIME ZONE 'UTC' AT TIME ZONE 'Eastern Standard Time' AS DATE)), 0) 

								when (DATEPART(DAY,CONVERT(DATE,CAST(GETDATE() AT TIME ZONE 'UTC' AT TIME ZONE 'Eastern Standard Time' AS DATE))) = 1) and (DATEPART(WEEKDAY,CONVERT(DATE,CAST(GETDATE() AT TIME ZONE 'UTC' AT TIME ZONE 'Eastern Standard Time' AS DATE))) <> 2)
									then DATEADD(MONTH, DATEDIFF(MONTH, -1, CAST(GETDATE() AT TIME ZONE 'UTC' AT TIME ZONE 'Eastern Standard Time' AS DATE))-1, -1)
								when (DATEPART(DAY,CONVERT(DATE,CAST(GETDATE() AT TIME ZONE 'UTC' AT TIME ZONE 'Eastern Standard Time' AS DATE))) = 1) and (DATEPART(WEEKDAY,CONVERT(DATE,CAST(GETDATE() AT TIME ZONE 'UTC' AT TIME ZONE 'Eastern Standard Time' AS DATE))) = 2)
									then DATEADD(DAY, DATEDIFF(DAY, 0, CAST(GETDATE()-3 AT TIME ZONE 'UTC' AT TIME ZONE 'Eastern Standard Time' AS DATE)), 0) 
							  END
		end

--SELECT @StartDate
--SELECT @EndDate

--set @StartDate='12/01/2018';
--set @EndDate='12/31/2018'

-- Funded Plans
select 
1 as Seq
,@StartDate AS Start_Date
,@EndDate AS End_Date
,t.MitelQueueID
,CASE WHEN t.MitelQueueName='Member Support Web' THEN 'NationsHearing Discount' ELSE t.MitelQueueName END MitelQueueName
,m.ACD_Calls_Handled
,ISNULL(nl.New_Leads,0) New_Leads
,ISNULL(ht.HT_Scheduled,0) HT_Scheduled
,ISNULL(u.Units_Sold,0) Units_Sold
,ISNULL(u.Units_Price,0) Units_Price
,ISNULL(cc.Cash_Collected,0) Cash_Collected
,m.AHT,m.ASA
,m.[ABN%],m.[SL%]
--,m.[ABN1%],m.[SL1%]
from (select distinct 
		MitelQueueID
		,MitelQueueName
		from bireports.MitelQueue_CRMCarrier_Mapping) t

left join (
			select 
			--1 as seq,
			QueueReporting
			,QueueName
			--,sum(QueueOffered) ACD_Calls_Offered
			,sum(QueueAnswered) ACD_Calls_Handled
			--,sum(QueueAbandoned) ACD_Calls_Abandoned
			--,sum(QueueServiceCount) ACD_Calls_SL

			--,RIGHT('00' + CAST(sum(QueueInternalACDDuration+QueueExternalACDDuration)/3600  AS VARCHAR(2)), 2 ) +':'+ -- HH
			--RIGHT('00' + CAST((sum(QueueInternalACDDuration+QueueExternalACDDuration)%3600 )/60 AS VARCHAR(2)), 2 ) +':'+  --MM
			--RIGHT('00' + CAST(sum(QueueInternalACDDuration+QueueExternalACDDuration)%60  AS VARCHAR(2)), 2 ) AS ACD_HT-- SS

			,CASE WHEN sum(QueueAnswered) = 0 THEN '00:00:00' ELSE
			RIGHT('00' + CAST((sum(QueueInternalACDDuration+QueueExternalACDDuration)/sum(QueueAnswered))/3600  AS VARCHAR(2)), 2 ) +':'+ -- HH
			RIGHT('00' + CAST(((sum(QueueInternalACDDuration+QueueExternalACDDuration)/sum(QueueAnswered))%3600 )/60 AS VARCHAR(2)), 2 ) +':'+  --MM
			RIGHT('00' + CAST((sum(QueueInternalACDDuration+QueueExternalACDDuration)/sum(QueueAnswered))%60  AS VARCHAR(2)), 2 ) END AS AHT-- SS

			,CASE WHEN sum(QueueAnswered) = 0 THEN '00:00:00' ELSE
			RIGHT('00' + CAST((sum(QueueTimeToAnswerTotal)/sum(QueueAnswered))/3600  AS VARCHAR(2)), 2 ) +':'+ -- HH
			RIGHT('00' + CAST(((sum(QueueTimeToAnswerTotal)/sum(QueueAnswered))%3600 )/60 AS VARCHAR(2)), 2 ) +':'+  --MM
			RIGHT('00' + CAST((sum(QueueTimeToAnswerTotal)/sum(QueueAnswered))%60  AS VARCHAR(2)), 2 ) END AS ASA-- SS

			--,CASE WHEN sum(QueueAnswered)=0 THEN cast(0 as decimal(10,2)) ELSE (sum(QueueAbandoned)/CAST(sum(QueueAnswered) AS DECIMAL(10,2)))*100 END AS [ABN%]
			,CASE WHEN sum(QueueAnswered)=0 THEN CAST(cast(0 as decimal(10,2)) AS VARCHAR)+'%' else CAST( cast(sum(QueueAbandoned)/CAST(sum(QueueAnswered) AS DECIMAL(10,2))*100 as decimal(10,2)) AS VARCHAR)+'%' END AS [ABN%]			

			--,CASE WHEN sum(QueueOffered)=0 THEN cast(100 as decimal(10,2)) ELSE (sum(QueueServiceCount)/CAST(sum(QueueOffered) AS DECIMAL(10,2)))*100 END AS [SL%]
			,CASE WHEN sum(QueueOffered)=0 THEN CAST(cast(100 as decimal(10,2)) AS VARCHAR)+'%' ELSE CAST(CAST((sum(QueueServiceCount)/CAST(sum(QueueOffered) AS DECIMAL(10,2)))*100 AS DECIMAL(10,2)) AS VARCHAR)+'%' END AS [SL%]

			--,CASE WHEN sum(QueueAnswered)=0 THEN cast(0 as decimal(10,2)) ELSE (sum(QueueAbandoned)/CAST(sum(QueueAnswered) AS DECIMAL(10,2)))*100 END AS [ABN%]
			--,CASE WHEN sum(QueueOffered)=0 THEN cast(100 as decimal(10,2)) ELSE (sum(QueueServiceCount)/CAST(sum(QueueOffered) AS DECIMAL(10,2)))*100 END AS [SL%]
			--,CASE WHEN sum(QueueOffered)=0 THEN cast(0 as decimal(10,2)) ELSE (sum(QueueAnswered)/CAST(sum(QueueOffered) AS DECIMAL(10,2)))*100 END AS [Answered%]

			from [bireports].[Mitel_QueuePerformanceByPeriodStats] with (nolock)
			where 1=1
			and QueueReporting in ('P102','P104','P129','P130','P139','P159','P160','P161','P162','P171','P172','P177') -- Funded Plans
			and cast([MidnightStartDate] as date) between @StartDate and @EndDate
			group by QueueReporting
			,QueueName
			--order by 1
		  ) m on (m.QueueReporting=t.MitelQueueID)

left join (
			select 
			m.MitelQueueID
			,m.MitelQueueName
			,count(distinct NHMemberId) New_Leads
			from [ReportsData].[viewMemberInfoRpt1]  v
			left join bireports.MitelQueue_CRMCarrier_Mapping m on (CASE WHEN v.HealthPlanName = 'HAP UAW Trust VEBA' THEN 'HAP UAW Trust VEBA' else v.[Program Name] END =m.CRMCarrierName)
			where 1=1
			and CAST([First Time Called] AT TIME ZONE 'UTC' AT TIME ZONE 'Eastern Standard Time' AS DATE) between @StartDate and @EndDate
			and ([Program Name] is not null or [Program Name] <> 'NULL')
			group by m.MitelQueueID
			,m.MitelQueueName
		 ) nl on (nl.MitelQueueID=t.MitelQueueID)

left join (
			select 
			m.MitelQueueID
			,m.MitelQueueName
			,count(distinct NHMemberId) HT_Scheduled
			from [ReportsData].[viewMemberInfoRpt1]   v
			left join bireports.MitelQueue_CRMCarrier_Mapping m on (CASE WHEN v.HealthPlanName = 'HAP UAW Trust VEBA' THEN 'HAP UAW Trust VEBA' else v.[Program Name] END = m.CRMCarrierName)
			where 1=1
			and CAST([Date Appt was Created]  AS DATE) between @StartDate and @EndDate
			and ([Program Name] is not null or [Program Name] <> 'NULL')
			and [Program Name] <> 'Anthem Funded'
			group by m.MitelQueueID
			,m.MitelQueueName
		  ) ht on (ht.MitelQueueID=t.MitelQueueID)

left join (
			select m.MitelQueueID
			,m.MitelQueueName
			,sum(v.[Device Count]) Units_Sold
			,SUM(v.[Product Price]) Units_Price 
			from [ReportsData].[4_CRMOrders] v
			left join bireports.MitelQueue_CRMCarrier_Mapping m on (CASE WHEN v.[Plan or Program Name] = 'HAP UAW Trust VEBA' THEN 'HAP UAW Trust VEBA' else v.[Insurance Carrier Name] END = m.CRMCarrierName)
			where 1=1
			and CAST([Date Approved]  AS DATE) between @StartDate and @EndDate
			and [Status Code] not in ('','CAN')
			and [Order Type] = 'NEW'
			and Status = 'ACTIVE'
			and ([Insurance Carrier Name] is not null or [Insurance Carrier Name] <> 'NULL')
			and [Insurance Carrier Name] <> 'Anthem Funded'
			group by m.MitelQueueID
			,m.MitelQueueName
		 ) u on (u.MitelQueueID=t.MitelQueueID)


left join (
			SELECT m.MitelQueueID,m.MitelQueueName
			,SUM(pp.AmountPaid) Cash_Collected
			FROM [bireports].[PPaymentInfo] pp
			LEFT JOIN orders.orders o ON (o.OrderID=pp.OrderID)
			LEFT JOIN Insurance.InsuranceCarriers c ON (CAST(JSON_VALUE(o.MemberData,'$.insCarrierId') AS INT) = c.InsuranceCarrierID)
			LEFT JOIN Insurance.InsuranceHealthPlans h ON (CAST(JSON_VALUE(o.MemberData,'$.insPlanId') AS INT)=h.InsuranceHealthPlanID)
			LEFT JOIN bireports.MitelQueue_CRMCarrier_Mapping m ON ((CASE WHEN h.HealthPlanName = 'HAP UAW Trust VEBA' THEN 'HAP UAW Trust VEBA' ELSE c.InsuranceCarrierName END=m.CRMCarrierName) AND CAST(JSON_VALUE(o.MemberData,'$.insCarrierId') AS INT)<>0)
			WHERE 1=1
			and CAST(pp.PaymentDate  AS DATE) between @StartDate and @EndDate
			and o.OrderType = 'NEW'
			and o.Status = 'ACTIVE'
			GROUP BY m.MitelQueueID,m.MitelQueueName
		 ) cc on (cc.MitelQueueID=t.MitelQueueID)
WHERE 1=1
AND t.MitelQueueID  in ('P102','P104','P129','P130','P139','P159','P160','P161','P162','P171','P172','P177') -- Funded Plans


UNION

-- Discount Plans
select 
2 as Seq
,@StartDate AS Start_Date
,@EndDate AS End_Date
,t.MitelQueueID
,CASE WHEN t.MitelQueueName='Member Support Web' THEN 'NationsHearing Discount' ELSE t.MitelQueueName END MitelQueueName
,m.ACD_Calls_Handled
,ISNULL(nl.New_Leads,0) New_Leads
,ISNULL(ht.HT_Scheduled,0) HT_Scheduled
,ISNULL(u.Units_Sold,0) Units_Sold
,ISNULL(u.Units_Price,0) Units_Price
,ISNULL(cc.Cash_Collected,0) Cash_Collected
,m.AHT,m.ASA
,m.[ABN%],m.[SL%]
--,m.[ABN1%],m.[SL1%]
from (select distinct 
		MitelQueueID
		,MitelQueueName
		from bireports.MitelQueue_CRMCarrier_Mapping) t

left join (
			select 
			--1 as seq,
			QueueReporting
			,QueueName
			--,sum(QueueOffered) ACD_Calls_Offered
			,sum(QueueAnswered) ACD_Calls_Handled
			--,sum(QueueAbandoned) ACD_Calls_Abandoned
			--,sum(QueueServiceCount) ACD_Calls_SL

			--,RIGHT('00' + CAST(sum(QueueInternalACDDuration+QueueExternalACDDuration)/3600  AS VARCHAR(2)), 2 ) +':'+ -- HH
			--RIGHT('00' + CAST((sum(QueueInternalACDDuration+QueueExternalACDDuration)%3600 )/60 AS VARCHAR(2)), 2 ) +':'+  --MM
			--RIGHT('00' + CAST(sum(QueueInternalACDDuration+QueueExternalACDDuration)%60  AS VARCHAR(2)), 2 ) AS ACD_HT-- SS

			,CASE WHEN sum(QueueAnswered) = 0 THEN '00:00:00' ELSE
			RIGHT('00' + CAST((sum(QueueInternalACDDuration+QueueExternalACDDuration)/sum(QueueAnswered))/3600  AS VARCHAR(2)), 2 ) +':'+ -- HH
			RIGHT('00' + CAST(((sum(QueueInternalACDDuration+QueueExternalACDDuration)/sum(QueueAnswered))%3600 )/60 AS VARCHAR(2)), 2 ) +':'+  --MM
			RIGHT('00' + CAST((sum(QueueInternalACDDuration+QueueExternalACDDuration)/sum(QueueAnswered))%60  AS VARCHAR(2)), 2 ) END AS AHT-- SS

			,CASE WHEN sum(QueueAnswered) = 0 THEN '00:00:00' ELSE
			RIGHT('00' + CAST((sum(QueueTimeToAnswerTotal)/sum(QueueAnswered))/3600  AS VARCHAR(2)), 2 ) +':'+ -- HH
			RIGHT('00' + CAST(((sum(QueueTimeToAnswerTotal)/sum(QueueAnswered))%3600 )/60 AS VARCHAR(2)), 2 ) +':'+  --MM
			RIGHT('00' + CAST((sum(QueueTimeToAnswerTotal)/sum(QueueAnswered))%60  AS VARCHAR(2)), 2 ) END AS ASA-- SS

			--,CASE WHEN sum(QueueAnswered)=0 THEN cast(0 as decimal(10,2)) ELSE (sum(QueueAbandoned)/CAST(sum(QueueAnswered) AS DECIMAL(10,2)))*100 END AS [ABN%]
			,CASE WHEN sum(QueueAnswered)=0 THEN CAST(cast(0 as decimal(10,2)) AS VARCHAR)+'%' else CAST( cast(sum(QueueAbandoned)/CAST(sum(QueueAnswered) AS DECIMAL(10,2))*100 as decimal(10,2)) AS VARCHAR)+'%' END AS [ABN%]			

			--,CASE WHEN sum(QueueOffered)=0 THEN cast(100 as decimal(10,2)) ELSE (sum(QueueServiceCount)/CAST(sum(QueueOffered) AS DECIMAL(10,2)))*100 END AS [SL%]
			,CASE WHEN sum(QueueOffered)=0 THEN CAST(cast(100 as decimal(10,2)) AS VARCHAR)+'%' ELSE CAST(CAST((sum(QueueServiceCount)/CAST(sum(QueueOffered) AS DECIMAL(10,2)))*100 AS DECIMAL(10,2)) AS VARCHAR)+'%' END AS [SL%]

			--,CASE WHEN sum(QueueAnswered)=0 THEN cast(0 as decimal(10,2)) ELSE (sum(QueueAbandoned)/CAST(sum(QueueAnswered) AS DECIMAL(10,2)))*100 END AS [ABN%]
			--,CASE WHEN sum(QueueOffered)=0 THEN cast(100 as decimal(10,2)) ELSE (sum(QueueServiceCount)/CAST(sum(QueueOffered) AS DECIMAL(10,2)))*100 END AS [SL%]
			--,CASE WHEN sum(QueueOffered)=0 THEN cast(0 as decimal(10,2)) ELSE (sum(QueueAnswered)/CAST(sum(QueueOffered) AS DECIMAL(10,2)))*100 END AS [Answered%]

			from [bireports].[Mitel_QueuePerformanceByPeriodStats] with (nolock)
			where 1=1
			and QueueReporting in ('P100','P101','P107','P125','P126','P143','P163','P164') -- Discount Plans
			and cast([MidnightStartDate] as date) between @StartDate and @EndDate
			group by QueueReporting
			,QueueName
			--order by 1
		  ) m on (m.QueueReporting=t.MitelQueueID)

left join (
			select 
			m.MitelQueueID
			,m.MitelQueueName
			,count(distinct NHMemberId) New_Leads
			from [ReportsData].[viewMemberInfoRpt1]  v
			left join bireports.MitelQueue_CRMCarrier_Mapping m on (v.[Program Name]=m.CRMCarrierName)
			where 1=1
			and CAST([First Time Called] AT TIME ZONE 'UTC' AT TIME ZONE 'Eastern Standard Time' AS DATE) between @StartDate and @EndDate
			and ([Program Name] is not null or [Program Name] <> 'NULL')
			group by m.MitelQueueID
			,m.MitelQueueName
		 ) nl on (nl.MitelQueueID=t.MitelQueueID)

left join (
			select 
			m.MitelQueueID
			,m.MitelQueueName
			,count(distinct NHMemberId) HT_Scheduled
			from [ReportsData].[viewMemberInfoRpt1]   v
			left join bireports.MitelQueue_CRMCarrier_Mapping m on (v.[Program Name]=m.CRMCarrierName)
			where 1=1
			and CAST([Date Appt was Created]  AS DATE) between @StartDate and @EndDate
			and ([Program Name] is not null or [Program Name] <> 'NULL')
			and [Program Name] <> 'Anthem Funded'
			group by m.MitelQueueID
			,m.MitelQueueName
		  ) ht on (ht.MitelQueueID=t.MitelQueueID)

left join (
			select m.MitelQueueID
			,m.MitelQueueName
			,sum(v.[Device Count]) Units_Sold
			,SUM(v.[Product Price]) Units_Price 
			from [ReportsData].[4_CRMOrders] v
			left join bireports.MitelQueue_CRMCarrier_Mapping m on (v.[Insurance Carrier Name]=m.CRMCarrierName)
			where 1=1
			and CAST([Date Approved]  AS DATE) between @StartDate and @EndDate
			and [Status Code] not in ('','CAN')
			and [Order Type] = 'NEW'
			and Status = 'ACTIVE'
			and ([Insurance Carrier Name] is not null or [Insurance Carrier Name] <> 'NULL')
			and [Insurance Carrier Name] <> 'Anthem Funded'
			group by m.MitelQueueID
			,m.MitelQueueName
		 ) u on (u.MitelQueueID=t.MitelQueueID)


left join (
			SELECT m.MitelQueueID,m.MitelQueueName
			,SUM(pp.AmountPaid) Cash_Collected
			FROM [bireports].[PPaymentInfo] pp
			LEFT JOIN orders.orders o ON (o.OrderID=pp.OrderID)
			LEFT JOIN bireports.MitelQueue_CRMCarrier_Mapping m ON (CAST(JSON_VALUE(o.MemberData,'$.insCarrierId') AS INT)=m.CRMCarrierID AND CAST(JSON_VALUE(o.MemberData,'$.insCarrierId') AS INT)<>0)
			WHERE 1=1
			and CAST(pp.PaymentDate  AS DATE) between @StartDate and @EndDate
			and o.OrderType = 'NEW'
			and o.Status = 'ACTIVE'
			GROUP BY m.MitelQueueID,m.MitelQueueName
		 ) cc on (cc.MitelQueueID=t.MitelQueueID)
WHERE 1=1
AND t.MitelQueueID  IN ('P100','P101','P107','P125','P126','P143','P163','P164') -- Discount Plans

union

-- Funded & Discount Plans for total
select 
3 as Seq
,@StartDate AS Start_Date
,@EndDate AS End_Date
,'Totals',''
,m.ACD_Calls_Handled
,ISNULL(nl.New_Leads,0) New_Leads
,ISNULL(ht.HT_Scheduled,0) HT_Scheduled
,ISNULL(u.Units_Sold,0) Units_Sold
,ISNULL(u.Units_Price,0) Units_Price
,ISNULL(cc.Cash_Collected,0) Cash_Collected
,m.AHT,m.ASA
,m.[ABN%],m.[SL%]
--,m.[ABN1%],m.[SL1%]
from (select 3 as seq,'Totals'  MitelQueueID ) t
left join (
			select 
			
			'Totals' QueueReporting
			--,QueueName
			--,sum(QueueOffered) ACD_Calls_Offered
			,sum(QueueAnswered) ACD_Calls_Handled
			--,sum(QueueAbandoned) ACD_Calls_Abandoned
			--,sum(QueueServiceCount) ACD_Calls_SL

			--,RIGHT('00' + CAST(sum(QueueInternalACDDuration+QueueExternalACDDuration)/3600  AS VARCHAR(2)), 2 ) +':'+ -- HH
			--RIGHT('00' + CAST((sum(QueueInternalACDDuration+QueueExternalACDDuration)%3600 )/60 AS VARCHAR(2)), 2 ) +':'+  --MM
			--RIGHT('00' + CAST(sum(QueueInternalACDDuration+QueueExternalACDDuration)%60  AS VARCHAR(2)), 2 ) AS ACD_HT-- SS

			,CASE WHEN sum(QueueAnswered) = 0 THEN '00:00:00' ELSE
			RIGHT('00' + CAST((sum(QueueInternalACDDuration+QueueExternalACDDuration)/sum(QueueAnswered))/3600  AS VARCHAR(2)), 2 ) +':'+ -- HH
			RIGHT('00' + CAST(((sum(QueueInternalACDDuration+QueueExternalACDDuration)/sum(QueueAnswered))%3600 )/60 AS VARCHAR(2)), 2 ) +':'+  --MM
			RIGHT('00' + CAST((sum(QueueInternalACDDuration+QueueExternalACDDuration)/sum(QueueAnswered))%60  AS VARCHAR(2)), 2 ) END AS AHT-- SS

			,CASE WHEN sum(QueueAnswered) = 0 THEN '00:00:00' ELSE
			RIGHT('00' + CAST((sum(QueueTimeToAnswerTotal)/sum(QueueAnswered))/3600  AS VARCHAR(2)), 2 ) +':'+ -- HH
			RIGHT('00' + CAST(((sum(QueueTimeToAnswerTotal)/sum(QueueAnswered))%3600 )/60 AS VARCHAR(2)), 2 ) +':'+  --MM
			RIGHT('00' + CAST((sum(QueueTimeToAnswerTotal)/sum(QueueAnswered))%60  AS VARCHAR(2)), 2 ) END AS ASA-- SS


			--,CASE WHEN sum(QueueAnswered)=0 THEN cast(0 as decimal(10,2)) ELSE (sum(QueueAbandoned)/CAST(sum(QueueAnswered) AS DECIMAL(10,2)))*100 END AS [ABN%]
			,CASE WHEN sum(QueueAnswered)=0 THEN CAST(cast(0 as decimal(10,2)) AS VARCHAR)+'%' else CAST( cast(sum(QueueAbandoned)/CAST(sum(QueueAnswered) AS DECIMAL(10,2))*100 as decimal(10,2)) AS VARCHAR)+'%' END AS [ABN%]			

			--,CASE WHEN sum(QueueOffered)=0 THEN cast(100 as decimal(10,2)) ELSE (sum(QueueServiceCount)/CAST(sum(QueueOffered) AS DECIMAL(10,2)))*100 END AS [SL%]
			,CASE WHEN sum(QueueOffered)=0 THEN CAST(cast(100 as decimal(10,2)) AS VARCHAR)+'%' ELSE CAST(CAST((sum(QueueServiceCount)/CAST(sum(QueueOffered) AS DECIMAL(10,2)))*100 AS DECIMAL(10,2)) AS VARCHAR)+'%' END AS [SL%]

			--,CASE WHEN sum(QueueAnswered)=0 THEN cast(0 as decimal(10,2)) ELSE (sum(QueueAbandoned)/CAST(sum(QueueAnswered) AS DECIMAL(10,2)))*100 END AS [ABN%]
			--,CASE WHEN sum(QueueOffered)=0 THEN cast(100 as decimal(10,2)) ELSE (sum(QueueServiceCount)/CAST(sum(QueueOffered) AS DECIMAL(10,2)))*100 END AS [SL%]
			--,CASE WHEN sum(QueueOffered)=0 THEN cast(0 as decimal(10,2)) ELSE (sum(QueueAnswered)/CAST(sum(QueueOffered) AS DECIMAL(10,2)))*100 END AS [Answered%]

			from [bireports].[Mitel_QueuePerformanceByPeriodStats] with (nolock)
			where 1=1
			and QueueReporting in ('P100','P101','P102','P104','P107','P125','P126','P129','P130','P139','P143','P159','P160','P161','P162','P163','P164','P171','P172','P177') -- Funded & Discount Plans for total
			and cast([MidnightStartDate] as date) between @StartDate and @EndDate
			--group by QueueReporting,QueueName
			--order by 1
		  ) m on (m.QueueReporting=t.MitelQueueID)

left join (
			select 
			'Totals' MitelQueueID
			--,m.MitelQueueName,
			,count(distinct NHMemberId) New_Leads
			from [ReportsData].[viewMemberInfoRpt1]  v
			join bireports.MitelQueue_CRMCarrier_Mapping m on (CASE WHEN v.HealthPlanName = 'HAP UAW Trust VEBA' THEN 'HAP UAW Trust VEBA' else v.[Program Name] END =m.CRMCarrierName)
			where 1=1
			and CAST([First Time Called] AT TIME ZONE 'UTC' AT TIME ZONE 'Eastern Standard Time' AS DATE) between @StartDate and @EndDate
			and ([Program Name] is not null or [Program Name] <> 'NULL')
			--group by m.MitelQueueID,m.MitelQueueName
		 ) nl on (nl.MitelQueueID=t.MitelQueueID)

left join (
			select 
			'Totals' MitelQueueID
			--,m.MitelQueueName,
			,count(distinct NHMemberId) HT_Scheduled
			from [ReportsData].[viewMemberInfoRpt1]   v
			join bireports.MitelQueue_CRMCarrier_Mapping m on (CASE WHEN v.HealthPlanName = 'HAP UAW Trust VEBA' THEN 'HAP UAW Trust VEBA' else v.[Program Name] END = m.CRMCarrierName)
			where 1=1
			and CAST([Date Appt was Created]  AS DATE) between @StartDate and @EndDate
			and ([Program Name] is not null or [Program Name] <> 'NULL')
			and [Program Name] <> 'Anthem Funded'
			--group by m.MitelQueueID,m.MitelQueueName
		  ) ht on (ht.MitelQueueID=t.MitelQueueID)

left join (
			select 
			'Totals' MitelQueueID
			--,m.MitelQueueName,
			,sum(v.[Device Count]) Units_Sold
			,SUM(v.[Product Price]) Units_Price 
			from [ReportsData].[4_CRMOrders] v
			join bireports.MitelQueue_CRMCarrier_Mapping m on (CASE WHEN v.[Plan or Program Name] = 'HAP UAW Trust VEBA' THEN 'HAP UAW Trust VEBA' else v.[Insurance Carrier Name] END = m.CRMCarrierName)
			where 1=1
			and CAST([Date Approved]  AS DATE) between @StartDate and @EndDate
			and [Status Code] not in ('','CAN')
			and [Order Type] = 'NEW'
			and Status = 'ACTIVE'
			and ([Insurance Carrier Name] is not null or [Insurance Carrier Name] <> 'NULL')
			and [Insurance Carrier Name] <> 'Anthem Funded'
			--group by m.MitelQueueID,m.MitelQueueName
		 ) u on (u.MitelQueueID=t.MitelQueueID)


left join (
			SELECT 'Totals' MitelQueueID
			--,m.MitelQueueName,
			,SUM(pp.AmountPaid) Cash_Collected
			FROM [bireports].[PPaymentInfo] pp
			LEFT JOIN orders.orders o ON (o.OrderID=pp.OrderID)
			LEFT JOIN Insurance.InsuranceCarriers c ON (CAST(JSON_VALUE(o.MemberData,'$.insCarrierId') AS INT) = c.InsuranceCarrierID)
			LEFT JOIN Insurance.InsuranceHealthPlans h ON (CAST(JSON_VALUE(o.MemberData,'$.insPlanId') AS INT)=h.InsuranceHealthPlanID)
			LEFT JOIN bireports.MitelQueue_CRMCarrier_Mapping m ON ((CASE WHEN h.HealthPlanName = 'HAP UAW Trust VEBA' THEN 'HAP UAW Trust VEBA' ELSE c.InsuranceCarrierName END=m.CRMCarrierName) AND CAST(JSON_VALUE(o.MemberData,'$.insCarrierId') AS INT)<>0)
			WHERE 1=1
			and CAST(pp.PaymentDate  AS DATE) between @StartDate and @EndDate
			and o.OrderType = 'NEW'
			and o.Status = 'ACTIVE'
			--GROUP BY m.MitelQueueID,m.MitelQueueName
		 ) cc on (cc.MitelQueueID=t.MitelQueueID)
WHERE 1=1
--AND t.MitelQueueID IN ('P100','P101','P102','P104','P107','P125','P126','P129','P130','P139','P143','P159','P160','P161','P162','P163','P164','P171','P172') -- Funded & Discount Plans for total

UNION

-- Outbound Calls
--select 
--4 as Seq
--,@StartDate AS Start_Date
--,@EndDate AS End_Date
--,NULL,NULL
--,999999
--,NULL,NULL,NULL,NULL,NULL,NULL,NULL,NULL,NULL

--UNION

select 
4 as Seq
,@StartDate AS Start_Date
,@EndDate AS End_Date
,NULL,'Outbound Calls'
,COUNT(*) OutboundCalls
,NULL,NULL,NULL,NULL,NULL,NULL,NULL,NULL,NULL
FROM bireports.Mitel_InOut_CallDetail 
WHERE 1=1
and cast([MidnightStartDate] as date) between @StartDate and @EndDate
AND CallDirection='Outbound'


order by Seq,MitelQueueName
-- EXEC bireports.sp_rpt_mitel_queue_stats 'W'
-- EXEC bireports.sp_rpt_mitel_queue_stats 'M'
CREATE proc [bireports].[sp_rpt_mitel_queue_stats] (@DateRange char(1))
as 



Declare @StartDate date;
Declare @EndDate date;

		-- Returns first and last day of previous month
		if @DateRange='M'
		begin

			set @EndDate = dateadd(dd,-1,cast(cast(year(getdate()) as varchar(4))+'/'+cast(month(getdate()) as varchar(2))+'/1' as date))
			set @StartDate = cast(cast(year(@EndDate) as varchar(4))+'/'+cast(month(@EndDate) as varchar(2))+'/1' as date);

			
		end

		-- Returns first and last day of previous week - first day of week starts with Sunday
		if @DateRange='W'
		begin
			set @StartDate = DATEADD(wk, -1, DATEADD(DAY, 1-DATEPART(WEEKDAY, GETDATE()), DATEDIFF(dd, 0, GETDATE())))
			set @EndDate = DATEADD(wk, 0, DATEADD(DAY, 0-DATEPART(WEEKDAY, GETDATE()), DATEDIFF(dd, 0, GETDATE())))
		end

--SELECT @StartDate
--SELECT @EndDate

--set @StartDate='01/01/2019';
--set @EndDate='12/31/2018'

select 
1 as Seq
,@StartDate AS Start_Date
,@EndDate AS End_Date
,QueueReporting
,QueueName
,sum(QueueOffered) ACD_Calls_Offered
,sum(QueueAnswered) ACD_Calls_Handled
,sum(QueueAbandoned) ACD_Calls_Abandoned_Long
,sum(QueueShortAbandoned) ACD_Calls_Abandoned_Short

,CASE WHEN sum(QueueAnswered) = 0 THEN '00:00:00' ELSE
RIGHT('00' + CAST((sum(QueueTimeToAnswerTotal)/sum(QueueAnswered))/3600  AS VARCHAR(2)), 2 ) +':'+ -- HH
RIGHT('00' + CAST(((sum(QueueTimeToAnswerTotal)/sum(QueueAnswered))%3600 )/60 AS VARCHAR(2)), 2 ) +':'+  --MM
RIGHT('00' + CAST((sum(QueueTimeToAnswerTotal)/sum(QueueAnswered))%60  AS VARCHAR(2)), 2 ) END AS ASA_Avg_Speed_Answer -- SS

,CASE WHEN sum(QueueAbandoned) = 0 THEN '00:00:00' ELSE
RIGHT('00' + CAST((sum(QueueTimeToAbandonTotal)/sum(QueueAbandoned))/3600  AS VARCHAR(2)), 2 ) +':'+ -- HH
RIGHT('00' + CAST(((sum(QueueTimeToAbandonTotal)/sum(QueueAbandoned))%3600 )/60 AS VARCHAR(2)), 2 ) +':'+  --MM
RIGHT('00' + CAST((sum(QueueTimeToAbandonTotal)/sum(QueueAbandoned))%60  AS VARCHAR(2)), 2 ) END AS ADA_Avg_Delay_Aban-- SS

,CASE   WHEN (sum(QueueInternalACDDuration+QueueExternalACDDuration)/3600)>999 		
		THEN
		RIGHT('0000' + CAST(sum(QueueInternalACDDuration+QueueExternalACDDuration)/3600  AS VARCHAR(4)), 4 ) +':'+ -- HH
		RIGHT('00' + CAST((sum(QueueInternalACDDuration+QueueExternalACDDuration)%3600 )/60 AS VARCHAR(2)), 2 ) +':'+  --MM
		RIGHT('00' + CAST(sum(QueueInternalACDDuration+QueueExternalACDDuration)%60  AS VARCHAR(2)), 2 ) -- SS

		WHEN (sum(QueueInternalACDDuration+QueueExternalACDDuration)/3600)>99 AND (sum(QueueInternalACDDuration+QueueExternalACDDuration)/3600)<=999
		THEN
		RIGHT('000' + CAST(sum(QueueInternalACDDuration+QueueExternalACDDuration)/3600  AS VARCHAR(3)), 3 ) +':'+ -- HH
		RIGHT('00' + CAST((sum(QueueInternalACDDuration+QueueExternalACDDuration)%3600 )/60 AS VARCHAR(2)), 2 ) +':'+  --MM
		RIGHT('00' + CAST(sum(QueueInternalACDDuration+QueueExternalACDDuration)%60  AS VARCHAR(2)), 2 ) -- SS

		ELSE
		RIGHT('00' + CAST(sum(QueueInternalACDDuration+QueueExternalACDDuration)/3600  AS VARCHAR(2)), 2 ) +':'+ -- HH
		RIGHT('00' + CAST((sum(QueueInternalACDDuration+QueueExternalACDDuration)%3600 )/60 AS VARCHAR(2)), 2 ) +':'+  --MM
		RIGHT('00' + CAST(sum(QueueInternalACDDuration+QueueExternalACDDuration)%60  AS VARCHAR(2)), 2 )  END AS ACD_Handle_T -- SS

,CASE WHEN sum(QueueAnswered) = 0 THEN '00:00:00' ELSE
RIGHT('00' + CAST((sum(QueueInternalACDDuration+QueueExternalACDDuration)/sum(QueueAnswered))/3600  AS VARCHAR(2)), 2 ) +':'+ -- HH
RIGHT('00' + CAST(((sum(QueueInternalACDDuration+QueueExternalACDDuration)/sum(QueueAnswered))%3600 )/60 AS VARCHAR(2)), 2 ) +':'+  --MM
RIGHT('00' + CAST((sum(QueueInternalACDDuration+QueueExternalACDDuration)/sum(QueueAnswered))%60  AS VARCHAR(2)), 2 ) END AS AHT_Avg_Handle_T -- SS

,CASE WHEN (sum(QueueACDHoldByAgentDuration)/3600)>99

		THEN
		RIGHT('000' + CAST(sum(QueueACDHoldByAgentDuration)/3600  AS VARCHAR(3)), 3 ) +':'+ -- HH
		RIGHT('00' + CAST((sum(QueueACDHoldByAgentDuration)%3600 )/60 AS VARCHAR(2)), 2 ) +':'+  --MM
		RIGHT('00' + CAST(sum(QueueACDHoldByAgentDuration)%60  AS VARCHAR(2)), 2 ) -- SS

		ELSE
		RIGHT('00' + CAST(sum(QueueACDHoldByAgentDuration)/3600  AS VARCHAR(2)), 2 ) +':'+ -- HH
		RIGHT('00' + CAST((sum(QueueACDHoldByAgentDuration)%3600 )/60 AS VARCHAR(2)), 2 ) +':'+  --MM
		RIGHT('00' + CAST(sum(QueueACDHoldByAgentDuration)%60  AS VARCHAR(2)), 2 ) END AS ACD_HOLD_T-- SS

,CASE WHEN sum(QueueACDHoldByAgent) = 0 THEN '00:00:00' ELSE
RIGHT('00' + CAST((sum(QueueACDHoldByAgentDuration)/sum(QueueACDHoldByAgent))/3600  AS VARCHAR(2)), 2 ) +':'+ -- HH
RIGHT('00' + CAST(((sum(QueueACDHoldByAgentDuration)/sum(QueueACDHoldByAgent))%3600 )/60 AS VARCHAR(2)), 2 ) +':'+  --MM
RIGHT('00' + CAST((sum(QueueACDHoldByAgentDuration)/sum(QueueACDHoldByAgent))%60  AS VARCHAR(2)), 2 ) END AS AVG_HOLD_T-- SS

,sum(QueueWrapUpByAgentCount) ACD_Calls_Hold

,RIGHT('00' + CAST(sum(QueueWrapUpByAgentDuration)/3600  AS VARCHAR(2)), 2 ) +':'+ -- HH
RIGHT('00' + CAST((sum(QueueWrapUpByAgentDuration)%3600 )/60 AS VARCHAR(2)), 2 ) +':'+  --MM
RIGHT('00' + CAST(sum(QueueWrapUpByAgentDuration)%60  AS VARCHAR(2)), 2 ) AS WRAP_T-- SS

,CASE WHEN sum(QueueWrapUpByAgentCount) = 0 THEN '00:00:00' ELSE
RIGHT('00' + CAST((sum(QueueWrapUpByAgentDuration)/sum(QueueWrapUpByAgentCount))/3600  AS VARCHAR(2)), 2 ) +':'+ -- HH
RIGHT('00' + CAST(((sum(QueueWrapUpByAgentDuration)/sum(QueueWrapUpByAgentCount))%3600 )/60 AS VARCHAR(2)), 2 ) +':'+  --MM
RIGHT('00' + CAST((sum(QueueWrapUpByAgentDuration)/sum(QueueWrapUpByAgentCount))%60  AS VARCHAR(2)), 2 ) END AS AVG_WRAP_T-- SS

,CASE WHEN sum(QueueOffered)=0 THEN CAST(cast(0 as decimal(10,2)) AS VARCHAR)+'%' else CAST( cast(sum(QueueAbandoned)/CAST(sum(QueueOffered) AS DECIMAL(10,2))*100 as decimal(10,2)) AS VARCHAR)+'%' END AS [ABN%]			

,CASE WHEN sum(QueueOffered)=0 THEN CAST(cast(100 as decimal(10,2)) AS VARCHAR)+'%' ELSE CAST(CAST((sum(QueueServiceCount)/CAST(sum(QueueOffered) AS DECIMAL(10,2)))*100 AS DECIMAL(10,2)) AS VARCHAR)+'%' END AS [SL%]

,CASE WHEN sum(QueueOffered)=0 THEN CAST(cast(100 as decimal(10,2)) AS VARCHAR)+'%' ELSE CAST(CAST((sum(QueueAnswered)/CAST(sum(QueueOffered) AS DECIMAL(10,2)))*100 AS DECIMAL(10,2)) AS VARCHAR)+'%' END AS [ANS%]

from bireports.Mitel_QueuePerformanceByPeriodStats with (nolock)
where 1=1
and cast(MidnightStartDate as date) between @StartDate and @EndDate
and QueueReporting in ('P143','P160','P102','P130','P100','P129','P126','P107','P172','P139','P171','P125','P159','P101','P161','P104','P177','P162','P163','P164')
group by QueueReporting, QueueName


UNION

-- Totals
select 
2 as Seq
,@StartDate AS Start_Date
,@EndDate AS End_Date
,'Totals'
,NULL
,sum(QueueOffered) ACD_Calls_Offered
,sum(QueueAnswered) ACD_Calls_Handled
,sum(QueueAbandoned) ACD_Calls_Abandoned_Long
,sum(QueueShortAbandoned) ACD_Calls_Abandoned_Short

,CASE WHEN sum(QueueAnswered) = 0 THEN '00:00:00' ELSE
RIGHT('00' + CAST((sum(QueueTimeToAnswerTotal)/sum(QueueAnswered))/3600  AS VARCHAR(2)), 2 ) +':'+ -- HH
RIGHT('00' + CAST(((sum(QueueTimeToAnswerTotal)/sum(QueueAnswered))%3600 )/60 AS VARCHAR(2)), 2 ) +':'+  --MM
RIGHT('00' + CAST((sum(QueueTimeToAnswerTotal)/sum(QueueAnswered))%60  AS VARCHAR(2)), 2 ) END AS ASA_Avg_Speed_Answer -- SS

,CASE WHEN sum(QueueAbandoned) = 0 THEN '00:00:00' ELSE
RIGHT('00' + CAST((sum(QueueTimeToAbandonTotal)/sum(QueueAbandoned))/3600  AS VARCHAR(2)), 2 ) +':'+ -- HH
RIGHT('00' + CAST(((sum(QueueTimeToAbandonTotal)/sum(QueueAbandoned))%3600 )/60 AS VARCHAR(2)), 2 ) +':'+  --MM
RIGHT('00' + CAST((sum(QueueTimeToAbandonTotal)/sum(QueueAbandoned))%60  AS VARCHAR(2)), 2 ) END AS ADA_Avg_Delay_Aban-- SS

,CASE   WHEN (sum(QueueInternalACDDuration+QueueExternalACDDuration)/3600)>999 		
		THEN
		RIGHT('0000' + CAST(sum(QueueInternalACDDuration+QueueExternalACDDuration)/3600  AS VARCHAR(4)), 4 ) +':'+ -- HH
		RIGHT('00' + CAST((sum(QueueInternalACDDuration+QueueExternalACDDuration)%3600 )/60 AS VARCHAR(2)), 2 ) +':'+  --MM
		RIGHT('00' + CAST(sum(QueueInternalACDDuration+QueueExternalACDDuration)%60  AS VARCHAR(2)), 2 ) -- SS

		WHEN (sum(QueueInternalACDDuration+QueueExternalACDDuration)/3600)>99 AND (sum(QueueInternalACDDuration+QueueExternalACDDuration)/3600)<=999
		THEN
		RIGHT('000' + CAST(sum(QueueInternalACDDuration+QueueExternalACDDuration)/3600  AS VARCHAR(3)), 3 ) +':'+ -- HH
		RIGHT('00' + CAST((sum(QueueInternalACDDuration+QueueExternalACDDuration)%3600 )/60 AS VARCHAR(2)), 2 ) +':'+  --MM
		RIGHT('00' + CAST(sum(QueueInternalACDDuration+QueueExternalACDDuration)%60  AS VARCHAR(2)), 2 ) -- SS

		ELSE
		RIGHT('00' + CAST(sum(QueueInternalACDDuration+QueueExternalACDDuration)/3600  AS VARCHAR(2)), 2 ) +':'+ -- HH
		RIGHT('00' + CAST((sum(QueueInternalACDDuration+QueueExternalACDDuration)%3600 )/60 AS VARCHAR(2)), 2 ) +':'+  --MM
		RIGHT('00' + CAST(sum(QueueInternalACDDuration+QueueExternalACDDuration)%60  AS VARCHAR(2)), 2 )  END AS ACD_Handle_T -- SS

,CASE WHEN sum(QueueAnswered) = 0 THEN '00:00:00' ELSE
RIGHT('00' + CAST((sum(QueueInternalACDDuration+QueueExternalACDDuration)/sum(QueueAnswered))/3600  AS VARCHAR(2)), 2 ) +':'+ -- HH
RIGHT('00' + CAST(((sum(QueueInternalACDDuration+QueueExternalACDDuration)/sum(QueueAnswered))%3600 )/60 AS VARCHAR(2)), 2 ) +':'+  --MM
RIGHT('00' + CAST((sum(QueueInternalACDDuration+QueueExternalACDDuration)/sum(QueueAnswered))%60  AS VARCHAR(2)), 2 ) END AS AHT_Avg_Handle_T -- SS

,CASE WHEN (sum(QueueACDHoldByAgentDuration)/3600)>99

		THEN
		RIGHT('000' + CAST(sum(QueueACDHoldByAgentDuration)/3600  AS VARCHAR(3)), 3 ) +':'+ -- HH
		RIGHT('00' + CAST((sum(QueueACDHoldByAgentDuration)%3600 )/60 AS VARCHAR(2)), 2 ) +':'+  --MM
		RIGHT('00' + CAST(sum(QueueACDHoldByAgentDuration)%60  AS VARCHAR(2)), 2 ) -- SS

		ELSE
		RIGHT('00' + CAST(sum(QueueACDHoldByAgentDuration)/3600  AS VARCHAR(2)), 2 ) +':'+ -- HH
		RIGHT('00' + CAST((sum(QueueACDHoldByAgentDuration)%3600 )/60 AS VARCHAR(2)), 2 ) +':'+  --MM
		RIGHT('00' + CAST(sum(QueueACDHoldByAgentDuration)%60  AS VARCHAR(2)), 2 ) END AS ACD_HOLD_T-- SS

,CASE WHEN sum(QueueACDHoldByAgent) = 0 THEN '00:00:00' ELSE
RIGHT('00' + CAST((sum(QueueACDHoldByAgentDuration)/sum(QueueACDHoldByAgent))/3600  AS VARCHAR(2)), 2 ) +':'+ -- HH
RIGHT('00' + CAST(((sum(QueueACDHoldByAgentDuration)/sum(QueueACDHoldByAgent))%3600 )/60 AS VARCHAR(2)), 2 ) +':'+  --MM
RIGHT('00' + CAST((sum(QueueACDHoldByAgentDuration)/sum(QueueACDHoldByAgent))%60  AS VARCHAR(2)), 2 ) END AS AVG_HOLD_T-- SS

,sum(QueueWrapUpByAgentCount) ACD_Calls_Hold

,RIGHT('00' + CAST(sum(QueueWrapUpByAgentDuration)/3600  AS VARCHAR(2)), 2 ) +':'+ -- HH
RIGHT('00' + CAST((sum(QueueWrapUpByAgentDuration)%3600 )/60 AS VARCHAR(2)), 2 ) +':'+  --MM
RIGHT('00' + CAST(sum(QueueWrapUpByAgentDuration)%60  AS VARCHAR(2)), 2 ) AS WRAP_T-- SS

,CASE WHEN sum(QueueWrapUpByAgentCount) = 0 THEN '00:00:00' ELSE
RIGHT('00' + CAST((sum(QueueWrapUpByAgentDuration)/sum(QueueWrapUpByAgentCount))/3600  AS VARCHAR(2)), 2 ) +':'+ -- HH
RIGHT('00' + CAST(((sum(QueueWrapUpByAgentDuration)/sum(QueueWrapUpByAgentCount))%3600 )/60 AS VARCHAR(2)), 2 ) +':'+  --MM
RIGHT('00' + CAST((sum(QueueWrapUpByAgentDuration)/sum(QueueWrapUpByAgentCount))%60  AS VARCHAR(2)), 2 ) END AS AVG_WRAP_T-- SS

,CASE WHEN sum(QueueOffered)=0 THEN CAST(cast(0 as decimal(10,2)) AS VARCHAR)+'%' else CAST( cast(sum(QueueAbandoned)/CAST(sum(QueueOffered) AS DECIMAL(10,2))*100 as decimal(10,2)) AS VARCHAR)+'%' END AS [ABN%]			

,CASE WHEN sum(QueueOffered)=0 THEN CAST(cast(100 as decimal(10,2)) AS VARCHAR)+'%' ELSE CAST(CAST((sum(QueueServiceCount)/CAST(sum(QueueOffered) AS DECIMAL(10,2)))*100 AS DECIMAL(10,2)) AS VARCHAR)+'%' END AS [SL%]

,CASE WHEN sum(QueueOffered)=0 THEN CAST(cast(100 as decimal(10,2)) AS VARCHAR)+'%' ELSE CAST(CAST((sum(QueueAnswered)/CAST(sum(QueueOffered) AS DECIMAL(10,2)))*100 AS DECIMAL(10,2)) AS VARCHAR)+'%' END AS [ANS%]

from bireports.Mitel_QueuePerformanceByPeriodStats with (nolock)
where 1=1
and cast(MidnightStartDate as date) between @StartDate and @EndDate
and QueueReporting in ('P143','P160','P102','P130','P100','P129','P126','P107','P172','P139','P171','P125','P159','P101','P161','P104','P177','P162','P163','P164')
--group by 2 
--,@StartDate 
--,@EndDate 
--,NULL
--,NULL

ORDER BY 1


/*  don't delete this section

-- ACD calls per hour by queue
select 
QueueReporting
,QueueName
,DATEPART(HH,MidnightStartDate) Date_Hour
,sum(QueueOffered) ACD_Calls_Offered
from bireports.Mitel_QueuePerformanceByPeriodStats with (nolock)
where 1=1
and cast(MidnightStartDate as date) between '05/01/2019' and '05/31/2019'
and QueueReporting in ('P143','P160','P102','P130','P100','P129','P126','P107','P172','P139','P171','P125','P159','P101','P161','P104','P177','P162','P163','P164')
and TimeIntervalID between 32 and 79 -- Only working hours 8 AM TO 8 PM
group by QueueReporting, QueueName, DATEPART(HH,MidnightStartDate)
order by QueueReporting, QueueName, DATEPART(HH,MidnightStartDate)

*/
-- EXEC bireports.sp_rpt_managed_care_dashboard 'D'
-- EXEC bireports.sp_rpt_managed_care_dashboard 'M'
CREATE proc [bireports].[sp_rpt_managed_care_dashboard_bkp_05132019] (@DateRange char(1))
as 



Declare @StartDate date;
Declare @EndDate date;

		-- Returns previous day when run on any weekday except Monday, date goes back to last Friday if it runs on Monday
		-- Use this for reports to include previous day data and runs from Monday to Friday only
		if @DateRange='D'
		begin
			set @StartDate = case when DATEPART(WEEKDAY,CONVERT(DATE,CAST(GETDATE() AT TIME ZONE 'UTC' AT TIME ZONE 'Eastern Standard Time' AS DATE))) <> 2 
							  then DATEADD(DAY,-1,CONVERT(DATE,CAST(GETDATE() AT TIME ZONE 'UTC' AT TIME ZONE 'Eastern Standard Time' AS DATE))) 
							  when DATEPART(WEEKDAY,CONVERT(DATE,CAST(GETDATE() AT TIME ZONE 'UTC' AT TIME ZONE 'Eastern Standard Time' AS DATE))) = 2 
			                  then DATEADD(DAY,-3,CONVERT(DATE,CAST(GETDATE() AT TIME ZONE 'UTC' AT TIME ZONE 'Eastern Standard Time' AS DATE)))
							  END
			set @EndDate = case when DATEPART(WEEKDAY,CONVERT(DATE,CAST(GETDATE() AT TIME ZONE 'UTC' AT TIME ZONE 'Eastern Standard Time' AS DATE))) <> 2 
							  then DATEADD(DAY,-1,CONVERT(DATE,CAST(GETDATE() AT TIME ZONE 'UTC' AT TIME ZONE 'Eastern Standard Time' AS DATE))) 
							  when DATEPART(WEEKDAY,CONVERT(DATE,CAST(GETDATE() AT TIME ZONE 'UTC' AT TIME ZONE 'Eastern Standard Time' AS DATE))) = 2 
			                  then DATEADD(DAY,-3,CONVERT(DATE,CAST(GETDATE() AT TIME ZONE 'UTC' AT TIME ZONE 'Eastern Standard Time' AS DATE)))
							  END
		end

		-- Returns first day and yesterday of the current month as start and end dates when run on any day except 1st day of any month, if run on 1st of any month gives first and last date of the previous month
		-- Use this for reports that should include MTD data and runs every day in a month.
		if @DateRange='M'
		begin
			set @StartDate = case when DATEPART(DAY,CONVERT(DATE,CAST(GETDATE() AT TIME ZONE 'UTC' AT TIME ZONE 'Eastern Standard Time' AS DATE))) <> 1
									then DATEADD(MONTH, DATEDIFF(MONTH, 0, CAST(GETDATE() AT TIME ZONE 'UTC' AT TIME ZONE 'Eastern Standard Time' AS DATE)), 0) 
								  when DATEPART(DAY,CONVERT(DATE,CAST(GETDATE() AT TIME ZONE 'UTC' AT TIME ZONE 'Eastern Standard Time' AS DATE))) = 1 
									then  DATEADD(MONTH, DATEDIFF(MONTH, 0, CAST(GETDATE() AT TIME ZONE 'UTC' AT TIME ZONE 'Eastern Standard Time' AS DATE))-1, 0)  
							  END
			set @EndDate = case when (DATEPART(DAY,CONVERT(DATE,CAST(GETDATE() AT TIME ZONE 'UTC' AT TIME ZONE 'Eastern Standard Time' AS DATE))) <> 1) and (DATEPART(WEEKDAY,CONVERT(DATE,CAST(GETDATE() AT TIME ZONE 'UTC' AT TIME ZONE 'Eastern Standard Time' AS DATE))) <> 2)
									then DATEADD(DAY, DATEDIFF(DAY, 0, CAST(GETDATE()-1 AT TIME ZONE 'UTC' AT TIME ZONE 'Eastern Standard Time' AS DATE)), 0) 
								when (DATEPART(DAY,CONVERT(DATE,CAST(GETDATE() AT TIME ZONE 'UTC' AT TIME ZONE 'Eastern Standard Time' AS DATE))) <> 1) and (DATEPART(WEEKDAY,CONVERT(DATE,CAST(GETDATE() AT TIME ZONE 'UTC' AT TIME ZONE 'Eastern Standard Time' AS DATE))) = 2)
									then DATEADD(DAY, DATEDIFF(DAY, 0, CAST(GETDATE()-3 AT TIME ZONE 'UTC' AT TIME ZONE 'Eastern Standard Time' AS DATE)), 0) 

								when (DATEPART(DAY,CONVERT(DATE,CAST(GETDATE() AT TIME ZONE 'UTC' AT TIME ZONE 'Eastern Standard Time' AS DATE))) = 1) and (DATEPART(WEEKDAY,CONVERT(DATE,CAST(GETDATE() AT TIME ZONE 'UTC' AT TIME ZONE 'Eastern Standard Time' AS DATE))) <> 2)
									then DATEADD(MONTH, DATEDIFF(MONTH, -1, CAST(GETDATE() AT TIME ZONE 'UTC' AT TIME ZONE 'Eastern Standard Time' AS DATE))-1, -1)
								when (DATEPART(DAY,CONVERT(DATE,CAST(GETDATE() AT TIME ZONE 'UTC' AT TIME ZONE 'Eastern Standard Time' AS DATE))) = 1) and (DATEPART(WEEKDAY,CONVERT(DATE,CAST(GETDATE() AT TIME ZONE 'UTC' AT TIME ZONE 'Eastern Standard Time' AS DATE))) = 2)
									then DATEADD(DAY, DATEDIFF(DAY, 0, CAST(GETDATE()-3 AT TIME ZONE 'UTC' AT TIME ZONE 'Eastern Standard Time' AS DATE)), 0) 
							  END
		end

--SELECT @StartDate
--SELECT @EndDate

--set @StartDate='12/01/2018';
--set @EndDate='12/31/2018'

-- Funded Plans
select 
1 as Seq
,@StartDate AS Start_Date
,@EndDate AS End_Date
,t.MitelQueueID
,CASE WHEN t.MitelQueueName='Member Support Web' THEN 'NationsHearing Discount' ELSE t.MitelQueueName END MitelQueueName
,m.ACD_Calls_Handled
,ISNULL(nl.New_Leads,0) New_Leads
,ISNULL(ht.HT_Scheduled,0) HT_Scheduled
,ISNULL(u.Units_Sold,0) Units_Sold
,ISNULL(u.Units_Price,0) Units_Price
,ISNULL(cc.Cash_Collected,0) Cash_Collected
,m.AHT,m.ASA
,m.[ABN%],m.[SL%]
--,m.[ABN1%],m.[SL1%]
from (select distinct 
		MitelQueueID
		,MitelQueueName
		from bireports.MitelQueue_CRMCarrier_Mapping) t

left join (
			select 
			--1 as seq,
			QueueReporting
			,QueueName
			--,sum(QueueOffered) ACD_Calls_Offered
			,sum(QueueAnswered) ACD_Calls_Handled
			--,sum(QueueAbandoned) ACD_Calls_Abandoned
			--,sum(QueueServiceCount) ACD_Calls_SL

			--,RIGHT('00' + CAST(sum(QueueInternalACDDuration+QueueExternalACDDuration)/3600  AS VARCHAR(2)), 2 ) +':'+ -- HH
			--RIGHT('00' + CAST((sum(QueueInternalACDDuration+QueueExternalACDDuration)%3600 )/60 AS VARCHAR(2)), 2 ) +':'+  --MM
			--RIGHT('00' + CAST(sum(QueueInternalACDDuration+QueueExternalACDDuration)%60  AS VARCHAR(2)), 2 ) AS ACD_HT-- SS

			,CASE WHEN sum(QueueAnswered) = 0 THEN '00:00:00' ELSE
			RIGHT('00' + CAST((sum(QueueInternalACDDuration+QueueExternalACDDuration)/sum(QueueAnswered))/3600  AS VARCHAR(2)), 2 ) +':'+ -- HH
			RIGHT('00' + CAST(((sum(QueueInternalACDDuration+QueueExternalACDDuration)/sum(QueueAnswered))%3600 )/60 AS VARCHAR(2)), 2 ) +':'+  --MM
			RIGHT('00' + CAST((sum(QueueInternalACDDuration+QueueExternalACDDuration)/sum(QueueAnswered))%60  AS VARCHAR(2)), 2 ) END AS AHT-- SS

			,CASE WHEN sum(QueueAnswered) = 0 THEN '00:00:00' ELSE
			RIGHT('00' + CAST((sum(QueueTimeToAnswerTotal)/sum(QueueAnswered))/3600  AS VARCHAR(2)), 2 ) +':'+ -- HH
			RIGHT('00' + CAST(((sum(QueueTimeToAnswerTotal)/sum(QueueAnswered))%3600 )/60 AS VARCHAR(2)), 2 ) +':'+  --MM
			RIGHT('00' + CAST((sum(QueueTimeToAnswerTotal)/sum(QueueAnswered))%60  AS VARCHAR(2)), 2 ) END AS ASA-- SS

			--,CASE WHEN sum(QueueAnswered)=0 THEN cast(0 as decimal(10,2)) ELSE (sum(QueueAbandoned)/CAST(sum(QueueAnswered) AS DECIMAL(10,2)))*100 END AS [ABN%]
			,CASE WHEN sum(QueueAnswered)=0 THEN CAST(cast(0 as decimal(10,2)) AS VARCHAR)+'%' else CAST( cast(sum(QueueAbandoned)/CAST(sum(QueueAnswered) AS DECIMAL(10,2))*100 as decimal(10,2)) AS VARCHAR)+'%' END AS [ABN%]			

			--,CASE WHEN sum(QueueOffered)=0 THEN cast(100 as decimal(10,2)) ELSE (sum(QueueServiceCount)/CAST(sum(QueueOffered) AS DECIMAL(10,2)))*100 END AS [SL%]
			,CASE WHEN sum(QueueOffered)=0 THEN CAST(cast(100 as decimal(10,2)) AS VARCHAR)+'%' ELSE CAST(CAST((sum(QueueServiceCount)/CAST(sum(QueueOffered) AS DECIMAL(10,2)))*100 AS DECIMAL(10,2)) AS VARCHAR)+'%' END AS [SL%]

			--,CASE WHEN sum(QueueAnswered)=0 THEN cast(0 as decimal(10,2)) ELSE (sum(QueueAbandoned)/CAST(sum(QueueAnswered) AS DECIMAL(10,2)))*100 END AS [ABN%]
			--,CASE WHEN sum(QueueOffered)=0 THEN cast(100 as decimal(10,2)) ELSE (sum(QueueServiceCount)/CAST(sum(QueueOffered) AS DECIMAL(10,2)))*100 END AS [SL%]
			--,CASE WHEN sum(QueueOffered)=0 THEN cast(0 as decimal(10,2)) ELSE (sum(QueueAnswered)/CAST(sum(QueueOffered) AS DECIMAL(10,2)))*100 END AS [Answered%]

			from [bireports].[Mitel_QueuePerformanceByPeriodStats] with (nolock)
			where 1=1
			and QueueReporting in ('P102','P104','P129','P130','P139','P159','P160','P161','P162','P171','P172','P177') -- Funded Plans
			and cast([MidnightStartDate] as date) between @StartDate and @EndDate
			group by QueueReporting
			,QueueName
			--order by 1
		  ) m on (m.QueueReporting=t.MitelQueueID)

left join (
			select 
			m.MitelQueueID
			,m.MitelQueueName
			,count(distinct NHMemberId) New_Leads
			from [ReportsData].[viewMemberInfoRpt1]  v
			left join bireports.MitelQueue_CRMCarrier_Mapping m on (CASE WHEN v.HealthPlanName = 'HAP UAW Trust VEBA' THEN 'HAP UAW Trust VEBA' else v.[Program Name] END =m.CRMCarrierName)
			where 1=1
			and CAST([First Time Called] AT TIME ZONE 'UTC' AT TIME ZONE 'Eastern Standard Time' AS DATE) between @StartDate and @EndDate
			and ([Program Name] is not null or [Program Name] <> 'NULL')
			group by m.MitelQueueID
			,m.MitelQueueName
		 ) nl on (nl.MitelQueueID=t.MitelQueueID)

left join (
			select 
			m.MitelQueueID
			,m.MitelQueueName
			,count(distinct NHMemberId) HT_Scheduled
			from [ReportsData].[viewMemberInfoRpt1]   v
			left join bireports.MitelQueue_CRMCarrier_Mapping m on (CASE WHEN v.HealthPlanName = 'HAP UAW Trust VEBA' THEN 'HAP UAW Trust VEBA' else v.[Program Name] END = m.CRMCarrierName)
			where 1=1
			and CAST([Date Appt was Created]  AS DATE) between @StartDate and @EndDate
			and ([Program Name] is not null or [Program Name] <> 'NULL')
			and [Program Name] <> 'Anthem Funded'
			group by m.MitelQueueID
			,m.MitelQueueName
		  ) ht on (ht.MitelQueueID=t.MitelQueueID)

left join (
			select m.MitelQueueID
			,m.MitelQueueName
			,sum(v.[Device Count]) Units_Sold
			,SUM(v.[Product Price]) Units_Price 
			from [ReportsData].[4_CRMOrders] v
			left join bireports.MitelQueue_CRMCarrier_Mapping m on (CASE WHEN v.[Plan or Program Name] = 'HAP UAW Trust VEBA' THEN 'HAP UAW Trust VEBA' else v.[Insurance Carrier Name] END = m.CRMCarrierName)
			where 1=1
			and CAST([Date Approved]  AS DATE) between @StartDate and @EndDate
			and [Status Code] not in ('','CAN')
			and [Order Type] = 'NEW'
			and Status = 'ACTIVE'
			and ([Insurance Carrier Name] is not null or [Insurance Carrier Name] <> 'NULL')
			and [Insurance Carrier Name] <> 'Anthem Funded'
			group by m.MitelQueueID
			,m.MitelQueueName
		 ) u on (u.MitelQueueID=t.MitelQueueID)


left join (
			SELECT m.MitelQueueID,m.MitelQueueName
			,SUM(pp.AmountPaid) Cash_Collected
			FROM [bireports].[PPaymentInfo] pp
			LEFT JOIN orders.orders o ON (o.OrderID=pp.OrderID)
			LEFT JOIN Insurance.InsuranceCarriers c ON (CAST(JSON_VALUE(o.MemberData,'$.insCarrierId') AS INT) = c.InsuranceCarrierID)
			LEFT JOIN Insurance.InsuranceHealthPlans h ON (CAST(JSON_VALUE(o.MemberData,'$.insPlanId') AS INT)=h.InsuranceHealthPlanID)
			LEFT JOIN bireports.MitelQueue_CRMCarrier_Mapping m ON ((CASE WHEN h.HealthPlanName = 'HAP UAW Trust VEBA' THEN 'HAP UAW Trust VEBA' ELSE c.InsuranceCarrierName END=m.CRMCarrierName) AND CAST(JSON_VALUE(o.MemberData,'$.insCarrierId') AS INT)<>0)
			WHERE 1=1
			and CAST(pp.PaymentDate  AS DATE) between @StartDate and @EndDate
			and o.OrderType = 'NEW'
			and o.Status = 'ACTIVE'
			GROUP BY m.MitelQueueID,m.MitelQueueName
		 ) cc on (cc.MitelQueueID=t.MitelQueueID)
WHERE 1=1
AND t.MitelQueueID  in ('P102','P104','P129','P130','P139','P159','P160','P161','P162','P171','P172','P177') -- Funded Plans


UNION

-- Discount Plans
select 
2 as Seq
,@StartDate AS Start_Date
,@EndDate AS End_Date
,t.MitelQueueID
,CASE WHEN t.MitelQueueName='Member Support Web' THEN 'NationsHearing Discount' ELSE t.MitelQueueName END MitelQueueName
,m.ACD_Calls_Handled
,ISNULL(nl.New_Leads,0) New_Leads
,ISNULL(ht.HT_Scheduled,0) HT_Scheduled
,ISNULL(u.Units_Sold,0) Units_Sold
,ISNULL(u.Units_Price,0) Units_Price
,ISNULL(cc.Cash_Collected,0) Cash_Collected
,m.AHT,m.ASA
,m.[ABN%],m.[SL%]
--,m.[ABN1%],m.[SL1%]
from (select distinct 
		MitelQueueID
		,MitelQueueName
		from bireports.MitelQueue_CRMCarrier_Mapping) t

left join (
			select 
			--1 as seq,
			QueueReporting
			,QueueName
			--,sum(QueueOffered) ACD_Calls_Offered
			,sum(QueueAnswered) ACD_Calls_Handled
			--,sum(QueueAbandoned) ACD_Calls_Abandoned
			--,sum(QueueServiceCount) ACD_Calls_SL

			--,RIGHT('00' + CAST(sum(QueueInternalACDDuration+QueueExternalACDDuration)/3600  AS VARCHAR(2)), 2 ) +':'+ -- HH
			--RIGHT('00' + CAST((sum(QueueInternalACDDuration+QueueExternalACDDuration)%3600 )/60 AS VARCHAR(2)), 2 ) +':'+  --MM
			--RIGHT('00' + CAST(sum(QueueInternalACDDuration+QueueExternalACDDuration)%60  AS VARCHAR(2)), 2 ) AS ACD_HT-- SS

			,CASE WHEN sum(QueueAnswered) = 0 THEN '00:00:00' ELSE
			RIGHT('00' + CAST((sum(QueueInternalACDDuration+QueueExternalACDDuration)/sum(QueueAnswered))/3600  AS VARCHAR(2)), 2 ) +':'+ -- HH
			RIGHT('00' + CAST(((sum(QueueInternalACDDuration+QueueExternalACDDuration)/sum(QueueAnswered))%3600 )/60 AS VARCHAR(2)), 2 ) +':'+  --MM
			RIGHT('00' + CAST((sum(QueueInternalACDDuration+QueueExternalACDDuration)/sum(QueueAnswered))%60  AS VARCHAR(2)), 2 ) END AS AHT-- SS

			,CASE WHEN sum(QueueAnswered) = 0 THEN '00:00:00' ELSE
			RIGHT('00' + CAST((sum(QueueTimeToAnswerTotal)/sum(QueueAnswered))/3600  AS VARCHAR(2)), 2 ) +':'+ -- HH
			RIGHT('00' + CAST(((sum(QueueTimeToAnswerTotal)/sum(QueueAnswered))%3600 )/60 AS VARCHAR(2)), 2 ) +':'+  --MM
			RIGHT('00' + CAST((sum(QueueTimeToAnswerTotal)/sum(QueueAnswered))%60  AS VARCHAR(2)), 2 ) END AS ASA-- SS

			--,CASE WHEN sum(QueueAnswered)=0 THEN cast(0 as decimal(10,2)) ELSE (sum(QueueAbandoned)/CAST(sum(QueueAnswered) AS DECIMAL(10,2)))*100 END AS [ABN%]
			,CASE WHEN sum(QueueAnswered)=0 THEN CAST(cast(0 as decimal(10,2)) AS VARCHAR)+'%' else CAST( cast(sum(QueueAbandoned)/CAST(sum(QueueAnswered) AS DECIMAL(10,2))*100 as decimal(10,2)) AS VARCHAR)+'%' END AS [ABN%]			

			--,CASE WHEN sum(QueueOffered)=0 THEN cast(100 as decimal(10,2)) ELSE (sum(QueueServiceCount)/CAST(sum(QueueOffered) AS DECIMAL(10,2)))*100 END AS [SL%]
			,CASE WHEN sum(QueueOffered)=0 THEN CAST(cast(100 as decimal(10,2)) AS VARCHAR)+'%' ELSE CAST(CAST((sum(QueueServiceCount)/CAST(sum(QueueOffered) AS DECIMAL(10,2)))*100 AS DECIMAL(10,2)) AS VARCHAR)+'%' END AS [SL%]

			--,CASE WHEN sum(QueueAnswered)=0 THEN cast(0 as decimal(10,2)) ELSE (sum(QueueAbandoned)/CAST(sum(QueueAnswered) AS DECIMAL(10,2)))*100 END AS [ABN%]
			--,CASE WHEN sum(QueueOffered)=0 THEN cast(100 as decimal(10,2)) ELSE (sum(QueueServiceCount)/CAST(sum(QueueOffered) AS DECIMAL(10,2)))*100 END AS [SL%]
			--,CASE WHEN sum(QueueOffered)=0 THEN cast(0 as decimal(10,2)) ELSE (sum(QueueAnswered)/CAST(sum(QueueOffered) AS DECIMAL(10,2)))*100 END AS [Answered%]

			from [bireports].[Mitel_QueuePerformanceByPeriodStats] with (nolock)
			where 1=1
			and QueueReporting in ('P100','P101','P107','P125','P126','P143','P163','P164') -- Discount Plans
			and cast([MidnightStartDate] as date) between @StartDate and @EndDate
			group by QueueReporting
			,QueueName
			--order by 1
		  ) m on (m.QueueReporting=t.MitelQueueID)

left join (
			select 
			m.MitelQueueID
			,m.MitelQueueName
			,count(distinct NHMemberId) New_Leads
			from [ReportsData].[viewMemberInfoRpt1]  v
			left join bireports.MitelQueue_CRMCarrier_Mapping m on (v.[Program Name]=m.CRMCarrierName)
			where 1=1
			and CAST([First Time Called] AT TIME ZONE 'UTC' AT TIME ZONE 'Eastern Standard Time' AS DATE) between @StartDate and @EndDate
			and ([Program Name] is not null or [Program Name] <> 'NULL')
			group by m.MitelQueueID
			,m.MitelQueueName
		 ) nl on (nl.MitelQueueID=t.MitelQueueID)

left join (
			select 
			m.MitelQueueID
			,m.MitelQueueName
			,count(distinct NHMemberId) HT_Scheduled
			from [ReportsData].[viewMemberInfoRpt1]   v
			left join bireports.MitelQueue_CRMCarrier_Mapping m on (v.[Program Name]=m.CRMCarrierName)
			where 1=1
			and CAST([Date Appt was Created]  AS DATE) between @StartDate and @EndDate
			and ([Program Name] is not null or [Program Name] <> 'NULL')
			and [Program Name] <> 'Anthem Funded'
			group by m.MitelQueueID
			,m.MitelQueueName
		  ) ht on (ht.MitelQueueID=t.MitelQueueID)

left join (
			select m.MitelQueueID
			,m.MitelQueueName
			,sum(v.[Device Count]) Units_Sold
			,SUM(v.[Product Price]) Units_Price 
			from [ReportsData].[4_CRMOrders] v
			left join bireports.MitelQueue_CRMCarrier_Mapping m on (v.[Insurance Carrier Name]=m.CRMCarrierName)
			where 1=1
			and CAST([Date Approved]  AS DATE) between @StartDate and @EndDate
			and [Status Code] not in ('','CAN')
			and [Order Type] = 'NEW'
			and Status = 'ACTIVE'
			and ([Insurance Carrier Name] is not null or [Insurance Carrier Name] <> 'NULL')
			and [Insurance Carrier Name] <> 'Anthem Funded'
			group by m.MitelQueueID
			,m.MitelQueueName
		 ) u on (u.MitelQueueID=t.MitelQueueID)


left join (
			SELECT m.MitelQueueID,m.MitelQueueName
			,SUM(pp.AmountPaid) Cash_Collected
			FROM [bireports].[PPaymentInfo] pp
			LEFT JOIN orders.orders o ON (o.OrderID=pp.OrderID)
			LEFT JOIN bireports.MitelQueue_CRMCarrier_Mapping m ON (CAST(JSON_VALUE(o.MemberData,'$.insCarrierId') AS INT)=m.CRMCarrierID AND CAST(JSON_VALUE(o.MemberData,'$.insCarrierId') AS INT)<>0)
			WHERE 1=1
			and CAST(pp.PaymentDate  AS DATE) between @StartDate and @EndDate
			and o.OrderType = 'NEW'
			and o.Status = 'ACTIVE'
			GROUP BY m.MitelQueueID,m.MitelQueueName
		 ) cc on (cc.MitelQueueID=t.MitelQueueID)
WHERE 1=1
AND t.MitelQueueID  IN ('P100','P101','P107','P125','P126','P143','P163','P164') -- Discount Plans

union

-- Funded & Discount Plans for total
select 
3 as Seq
,@StartDate AS Start_Date
,@EndDate AS End_Date
,'Totals',''
,m.ACD_Calls_Handled
,ISNULL(nl.New_Leads,0) New_Leads
,ISNULL(ht.HT_Scheduled,0) HT_Scheduled
,ISNULL(u.Units_Sold,0) Units_Sold
,ISNULL(u.Units_Price,0) Units_Price
,ISNULL(cc.Cash_Collected,0) Cash_Collected
,m.AHT,m.ASA
,m.[ABN%],m.[SL%]
--,m.[ABN1%],m.[SL1%]
from (select 3 as seq,'Totals'  MitelQueueID ) t
left join (
			select 
			
			'Totals' QueueReporting
			--,QueueName
			--,sum(QueueOffered) ACD_Calls_Offered
			,sum(QueueAnswered) ACD_Calls_Handled
			--,sum(QueueAbandoned) ACD_Calls_Abandoned
			--,sum(QueueServiceCount) ACD_Calls_SL

			--,RIGHT('00' + CAST(sum(QueueInternalACDDuration+QueueExternalACDDuration)/3600  AS VARCHAR(2)), 2 ) +':'+ -- HH
			--RIGHT('00' + CAST((sum(QueueInternalACDDuration+QueueExternalACDDuration)%3600 )/60 AS VARCHAR(2)), 2 ) +':'+  --MM
			--RIGHT('00' + CAST(sum(QueueInternalACDDuration+QueueExternalACDDuration)%60  AS VARCHAR(2)), 2 ) AS ACD_HT-- SS

			,CASE WHEN sum(QueueAnswered) = 0 THEN '00:00:00' ELSE
			RIGHT('00' + CAST((sum(QueueInternalACDDuration+QueueExternalACDDuration)/sum(QueueAnswered))/3600  AS VARCHAR(2)), 2 ) +':'+ -- HH
			RIGHT('00' + CAST(((sum(QueueInternalACDDuration+QueueExternalACDDuration)/sum(QueueAnswered))%3600 )/60 AS VARCHAR(2)), 2 ) +':'+  --MM
			RIGHT('00' + CAST((sum(QueueInternalACDDuration+QueueExternalACDDuration)/sum(QueueAnswered))%60  AS VARCHAR(2)), 2 ) END AS AHT-- SS

			,CASE WHEN sum(QueueAnswered) = 0 THEN '00:00:00' ELSE
			RIGHT('00' + CAST((sum(QueueTimeToAnswerTotal)/sum(QueueAnswered))/3600  AS VARCHAR(2)), 2 ) +':'+ -- HH
			RIGHT('00' + CAST(((sum(QueueTimeToAnswerTotal)/sum(QueueAnswered))%3600 )/60 AS VARCHAR(2)), 2 ) +':'+  --MM
			RIGHT('00' + CAST((sum(QueueTimeToAnswerTotal)/sum(QueueAnswered))%60  AS VARCHAR(2)), 2 ) END AS ASA-- SS


			--,CASE WHEN sum(QueueAnswered)=0 THEN cast(0 as decimal(10,2)) ELSE (sum(QueueAbandoned)/CAST(sum(QueueAnswered) AS DECIMAL(10,2)))*100 END AS [ABN%]
			,CASE WHEN sum(QueueAnswered)=0 THEN CAST(cast(0 as decimal(10,2)) AS VARCHAR)+'%' else CAST( cast(sum(QueueAbandoned)/CAST(sum(QueueAnswered) AS DECIMAL(10,2))*100 as decimal(10,2)) AS VARCHAR)+'%' END AS [ABN%]			

			--,CASE WHEN sum(QueueOffered)=0 THEN cast(100 as decimal(10,2)) ELSE (sum(QueueServiceCount)/CAST(sum(QueueOffered) AS DECIMAL(10,2)))*100 END AS [SL%]
			,CASE WHEN sum(QueueOffered)=0 THEN CAST(cast(100 as decimal(10,2)) AS VARCHAR)+'%' ELSE CAST(CAST((sum(QueueServiceCount)/CAST(sum(QueueOffered) AS DECIMAL(10,2)))*100 AS DECIMAL(10,2)) AS VARCHAR)+'%' END AS [SL%]

			--,CASE WHEN sum(QueueAnswered)=0 THEN cast(0 as decimal(10,2)) ELSE (sum(QueueAbandoned)/CAST(sum(QueueAnswered) AS DECIMAL(10,2)))*100 END AS [ABN%]
			--,CASE WHEN sum(QueueOffered)=0 THEN cast(100 as decimal(10,2)) ELSE (sum(QueueServiceCount)/CAST(sum(QueueOffered) AS DECIMAL(10,2)))*100 END AS [SL%]
			--,CASE WHEN sum(QueueOffered)=0 THEN cast(0 as decimal(10,2)) ELSE (sum(QueueAnswered)/CAST(sum(QueueOffered) AS DECIMAL(10,2)))*100 END AS [Answered%]

			from [bireports].[Mitel_QueuePerformanceByPeriodStats] with (nolock)
			where 1=1
			and QueueReporting in ('P100','P101','P102','P104','P107','P125','P126','P129','P130','P139','P143','P159','P160','P161','P162','P163','P164','P171','P172','P177') -- Funded & Discount Plans for total
			and cast([MidnightStartDate] as date) between @StartDate and @EndDate
			--group by QueueReporting,QueueName
			--order by 1
		  ) m on (m.QueueReporting=t.MitelQueueID)

left join (
			select 
			'Totals' MitelQueueID
			--,m.MitelQueueName,
			,count(distinct NHMemberId) New_Leads
			from [ReportsData].[viewMemberInfoRpt1]  v
			join bireports.MitelQueue_CRMCarrier_Mapping m on (CASE WHEN v.HealthPlanName = 'HAP UAW Trust VEBA' THEN 'HAP UAW Trust VEBA' else v.[Program Name] END =m.CRMCarrierName)
			where 1=1
			and CAST([First Time Called] AT TIME ZONE 'UTC' AT TIME ZONE 'Eastern Standard Time' AS DATE) between @StartDate and @EndDate
			and ([Program Name] is not null or [Program Name] <> 'NULL')
			--group by m.MitelQueueID,m.MitelQueueName
		 ) nl on (nl.MitelQueueID=t.MitelQueueID)

left join (
			select 
			'Totals' MitelQueueID
			--,m.MitelQueueName,
			,count(distinct NHMemberId) HT_Scheduled
			from [ReportsData].[viewMemberInfoRpt1]   v
			join bireports.MitelQueue_CRMCarrier_Mapping m on (CASE WHEN v.HealthPlanName = 'HAP UAW Trust VEBA' THEN 'HAP UAW Trust VEBA' else v.[Program Name] END = m.CRMCarrierName)
			where 1=1
			and CAST([Date Appt was Created]  AS DATE) between @StartDate and @EndDate
			and ([Program Name] is not null or [Program Name] <> 'NULL')
			and [Program Name] <> 'Anthem Funded'
			--group by m.MitelQueueID,m.MitelQueueName
		  ) ht on (ht.MitelQueueID=t.MitelQueueID)

left join (
			select 
			'Totals' MitelQueueID
			--,m.MitelQueueName,
			,sum(v.[Device Count]) Units_Sold
			,SUM(v.[Product Price]) Units_Price 
			from [ReportsData].[4_CRMOrders] v
			join bireports.MitelQueue_CRMCarrier_Mapping m on (CASE WHEN v.[Plan or Program Name] = 'HAP UAW Trust VEBA' THEN 'HAP UAW Trust VEBA' else v.[Insurance Carrier Name] END = m.CRMCarrierName)
			where 1=1
			and CAST([Date Approved]  AS DATE) between @StartDate and @EndDate
			and [Status Code] not in ('','CAN')
			and [Order Type] = 'NEW'
			and Status = 'ACTIVE'
			and ([Insurance Carrier Name] is not null or [Insurance Carrier Name] <> 'NULL')
			and [Insurance Carrier Name] <> 'Anthem Funded'
			--group by m.MitelQueueID,m.MitelQueueName
		 ) u on (u.MitelQueueID=t.MitelQueueID)


left join (
			SELECT 'Totals' MitelQueueID
			--,m.MitelQueueName,
			,SUM(pp.AmountPaid) Cash_Collected
			FROM [bireports].[PPaymentInfo] pp
			LEFT JOIN orders.orders o ON (o.OrderID=pp.OrderID)
			LEFT JOIN Insurance.InsuranceCarriers c ON (CAST(JSON_VALUE(o.MemberData,'$.insCarrierId') AS INT) = c.InsuranceCarrierID)
			LEFT JOIN Insurance.InsuranceHealthPlans h ON (CAST(JSON_VALUE(o.MemberData,'$.insPlanId') AS INT)=h.InsuranceHealthPlanID)
			LEFT JOIN bireports.MitelQueue_CRMCarrier_Mapping m ON ((CASE WHEN h.HealthPlanName = 'HAP UAW Trust VEBA' THEN 'HAP UAW Trust VEBA' ELSE c.InsuranceCarrierName END=m.CRMCarrierName) AND CAST(JSON_VALUE(o.MemberData,'$.insCarrierId') AS INT)<>0)
			WHERE 1=1
			and CAST(pp.PaymentDate  AS DATE) between @StartDate and @EndDate
			and o.OrderType = 'NEW'
			and o.Status = 'ACTIVE'
			--GROUP BY m.MitelQueueID,m.MitelQueueName
		 ) cc on (cc.MitelQueueID=t.MitelQueueID)
WHERE 1=1
--AND t.MitelQueueID IN ('P100','P101','P102','P104','P107','P125','P126','P129','P130','P139','P143','P159','P160','P161','P162','P163','P164','P171','P172') -- Funded & Discount Plans for total

order by Seq,MitelQueueName
-- EXEC bireports.sp_rpt_managed_care_dashboard 'D'
-- EXEC bireports.sp_rpt_managed_care_dashboard 'M'
CREATE proc [bireports].[sp_rpt_managed_care_dashboard] (@DateRange char(1))
as 



Declare @StartDate date;
Declare @EndDate date;

		-- Returns previous day when run on any weekday except Monday, date goes back to last Friday if it runs on Monday
		-- Use this for reports to include previous day data and runs from Monday to Friday only
		if @DateRange='D'
		begin
			set @StartDate = case when DATEPART(WEEKDAY,CONVERT(DATE,CAST(GETDATE() AT TIME ZONE 'UTC' AT TIME ZONE 'Eastern Standard Time' AS DATE))) <> 2 
							  then DATEADD(DAY,-1,CONVERT(DATE,CAST(GETDATE() AT TIME ZONE 'UTC' AT TIME ZONE 'Eastern Standard Time' AS DATE))) 
							  when DATEPART(WEEKDAY,CONVERT(DATE,CAST(GETDATE() AT TIME ZONE 'UTC' AT TIME ZONE 'Eastern Standard Time' AS DATE))) = 2 
			                  then DATEADD(DAY,-3,CONVERT(DATE,CAST(GETDATE() AT TIME ZONE 'UTC' AT TIME ZONE 'Eastern Standard Time' AS DATE)))
							  END
			set @EndDate = case when DATEPART(WEEKDAY,CONVERT(DATE,CAST(GETDATE() AT TIME ZONE 'UTC' AT TIME ZONE 'Eastern Standard Time' AS DATE))) <> 2 
							  then DATEADD(DAY,-1,CONVERT(DATE,CAST(GETDATE() AT TIME ZONE 'UTC' AT TIME ZONE 'Eastern Standard Time' AS DATE))) 
							  when DATEPART(WEEKDAY,CONVERT(DATE,CAST(GETDATE() AT TIME ZONE 'UTC' AT TIME ZONE 'Eastern Standard Time' AS DATE))) = 2 
			                  then DATEADD(DAY,-3,CONVERT(DATE,CAST(GETDATE() AT TIME ZONE 'UTC' AT TIME ZONE 'Eastern Standard Time' AS DATE)))
							  END
		end

		-- Returns first day and yesterday of the current month as start and end dates when run on any day except 1st day of any month, if run on 1st of any month gives first and last date of the previous month
		-- Use this for reports that should include MTD data and runs every day in a month.
		if @DateRange='M'
		begin
			set @StartDate = case when DATEPART(DAY,CONVERT(DATE,CAST(GETDATE() AT TIME ZONE 'UTC' AT TIME ZONE 'Eastern Standard Time' AS DATE))) <> 1
									then DATEADD(MONTH, DATEDIFF(MONTH, 0, CAST(GETDATE() AT TIME ZONE 'UTC' AT TIME ZONE 'Eastern Standard Time' AS DATE)), 0) 
								  when DATEPART(DAY,CONVERT(DATE,CAST(GETDATE() AT TIME ZONE 'UTC' AT TIME ZONE 'Eastern Standard Time' AS DATE))) = 1 
									then  DATEADD(MONTH, DATEDIFF(MONTH, 0, CAST(GETDATE() AT TIME ZONE 'UTC' AT TIME ZONE 'Eastern Standard Time' AS DATE))-1, 0)  
							  END
			--set @StartDate='05/01/2019'
			set @EndDate = case when (DATEPART(DAY,CONVERT(DATE,CAST(GETDATE() AT TIME ZONE 'UTC' AT TIME ZONE 'Eastern Standard Time' AS DATE))) <> 1) and (DATEPART(WEEKDAY,CONVERT(DATE,CAST(GETDATE() AT TIME ZONE 'UTC' AT TIME ZONE 'Eastern Standard Time' AS DATE))) <> 2)
									then DATEADD(DAY, DATEDIFF(DAY, 0, CAST(GETDATE()-1 AT TIME ZONE 'UTC' AT TIME ZONE 'Eastern Standard Time' AS DATE)), 0) 
								when (DATEPART(DAY,CONVERT(DATE,CAST(GETDATE() AT TIME ZONE 'UTC' AT TIME ZONE 'Eastern Standard Time' AS DATE))) <> 1) and (DATEPART(WEEKDAY,CONVERT(DATE,CAST(GETDATE() AT TIME ZONE 'UTC' AT TIME ZONE 'Eastern Standard Time' AS DATE))) = 2)
									then DATEADD(DAY, DATEDIFF(DAY, 0, CAST(GETDATE()-3 AT TIME ZONE 'UTC' AT TIME ZONE 'Eastern Standard Time' AS DATE)), 0) 

								when (DATEPART(DAY,CONVERT(DATE,CAST(GETDATE() AT TIME ZONE 'UTC' AT TIME ZONE 'Eastern Standard Time' AS DATE))) = 1) and (DATEPART(WEEKDAY,CONVERT(DATE,CAST(GETDATE() AT TIME ZONE 'UTC' AT TIME ZONE 'Eastern Standard Time' AS DATE))) <> 2)
									then DATEADD(MONTH, DATEDIFF(MONTH, -1, CAST(GETDATE() AT TIME ZONE 'UTC' AT TIME ZONE 'Eastern Standard Time' AS DATE))-1, -1)
								when (DATEPART(DAY,CONVERT(DATE,CAST(GETDATE() AT TIME ZONE 'UTC' AT TIME ZONE 'Eastern Standard Time' AS DATE))) = 1) and (DATEPART(WEEKDAY,CONVERT(DATE,CAST(GETDATE() AT TIME ZONE 'UTC' AT TIME ZONE 'Eastern Standard Time' AS DATE))) = 2)
									then DATEADD(DAY, DATEDIFF(DAY, 0, CAST(GETDATE()-3 AT TIME ZONE 'UTC' AT TIME ZONE 'Eastern Standard Time' AS DATE)), 0) 
							  END
		end

--SELECT @StartDate
--SELECT @EndDate

--set @StartDate='12/01/2018';
--set @EndDate='12/31/2018'

-- Funded Plans
select 
1 as Seq
,@StartDate AS Start_Date
,@EndDate AS End_Date
,t.MitelQueueID
,CASE WHEN t.MitelQueueName='Member Support Web' THEN 'NationsHearing Discount' ELSE t.MitelQueueName END MitelQueueName
,m.ACD_Calls_Handled
,ISNULL(nl.New_Leads,0) New_Leads
,ISNULL(ht.HT_Scheduled,0) HT_Scheduled
,ISNULL(u.Units_Sold,0) Units_Sold
,ISNULL(u.Units_Price,0) Units_Price
,ISNULL(u.Earmold_Units,0) Earmold_Units
,ISNULL(cc.Cash_Collected,0) Cash_Collected
,m.AHT,m.ASA
,m.[ABN%],m.[SL%]
--,m.[ABN1%],m.[SL1%]
from (select distinct 
		MitelQueueID
		,MitelQueueName
		from bireports.MitelQueue_CRMCarrier_Mapping) t

left join (
			select 
			--1 as seq,
			QueueReporting
			,QueueName
			--,sum(QueueOffered) ACD_Calls_Offered
			,sum(QueueAnswered) ACD_Calls_Handled
			--,sum(QueueAbandoned) ACD_Calls_Abandoned
			--,sum(QueueServiceCount) ACD_Calls_SL

			--,RIGHT('00' + CAST(sum(QueueInternalACDDuration+QueueExternalACDDuration)/3600  AS VARCHAR(2)), 2 ) +':'+ -- HH
			--RIGHT('00' + CAST((sum(QueueInternalACDDuration+QueueExternalACDDuration)%3600 )/60 AS VARCHAR(2)), 2 ) +':'+  --MM
			--RIGHT('00' + CAST(sum(QueueInternalACDDuration+QueueExternalACDDuration)%60  AS VARCHAR(2)), 2 ) AS ACD_HT-- SS

			,CASE WHEN sum(QueueAnswered) = 0 THEN '00:00:00' ELSE
			RIGHT('00' + CAST((sum(QueueInternalACDDuration+QueueExternalACDDuration)/sum(QueueAnswered))/3600  AS VARCHAR(2)), 2 ) +':'+ -- HH
			RIGHT('00' + CAST(((sum(QueueInternalACDDuration+QueueExternalACDDuration)/sum(QueueAnswered))%3600 )/60 AS VARCHAR(2)), 2 ) +':'+  --MM
			RIGHT('00' + CAST((sum(QueueInternalACDDuration+QueueExternalACDDuration)/sum(QueueAnswered))%60  AS VARCHAR(2)), 2 ) END AS AHT-- SS

			,CASE WHEN sum(QueueAnswered) = 0 THEN '00:00:00' ELSE
			RIGHT('00' + CAST((sum(QueueTimeToAnswerTotal)/sum(QueueAnswered))/3600  AS VARCHAR(2)), 2 ) +':'+ -- HH
			RIGHT('00' + CAST(((sum(QueueTimeToAnswerTotal)/sum(QueueAnswered))%3600 )/60 AS VARCHAR(2)), 2 ) +':'+  --MM
			RIGHT('00' + CAST((sum(QueueTimeToAnswerTotal)/sum(QueueAnswered))%60  AS VARCHAR(2)), 2 ) END AS ASA-- SS

			--,CASE WHEN sum(QueueAnswered)=0 THEN cast(0 as decimal(10,2)) ELSE (sum(QueueAbandoned)/CAST(sum(QueueAnswered) AS DECIMAL(10,2)))*100 END AS [ABN%]
			,CASE WHEN sum(QueueAnswered)=0 THEN CAST(cast(0 as decimal(10,2)) AS VARCHAR)+'%' else CAST( cast(sum(QueueAbandoned)/CAST(sum(QueueAnswered) AS DECIMAL(10,2))*100 as decimal(10,2)) AS VARCHAR)+'%' END AS [ABN%]			

			--,CASE WHEN sum(QueueOffered)=0 THEN cast(100 as decimal(10,2)) ELSE (sum(QueueServiceCount)/CAST(sum(QueueOffered) AS DECIMAL(10,2)))*100 END AS [SL%]
			,CASE WHEN sum(QueueOffered)=0 THEN CAST(cast(100 as decimal(10,2)) AS VARCHAR)+'%' ELSE CAST(CAST((sum(QueueServiceCount)/CAST(sum(QueueOffered) AS DECIMAL(10,2)))*100 AS DECIMAL(10,2)) AS VARCHAR)+'%' END AS [SL%]

			--,CASE WHEN sum(QueueAnswered)=0 THEN cast(0 as decimal(10,2)) ELSE (sum(QueueAbandoned)/CAST(sum(QueueAnswered) AS DECIMAL(10,2)))*100 END AS [ABN%]
			--,CASE WHEN sum(QueueOffered)=0 THEN cast(100 as decimal(10,2)) ELSE (sum(QueueServiceCount)/CAST(sum(QueueOffered) AS DECIMAL(10,2)))*100 END AS [SL%]
			--,CASE WHEN sum(QueueOffered)=0 THEN cast(0 as decimal(10,2)) ELSE (sum(QueueAnswered)/CAST(sum(QueueOffered) AS DECIMAL(10,2)))*100 END AS [Answered%]

			from [bireports].[Mitel_QueuePerformanceByPeriodStats] with (nolock)
			where 1=1
			and QueueReporting in ('P102','P104','P129','P130','P139','P159','P160','P161','P162','P171','P172','P177') -- Funded Plans
			and cast([MidnightStartDate] as date) between @StartDate and @EndDate
			group by QueueReporting
			,QueueName
			--order by 1
		  ) m on (m.QueueReporting=t.MitelQueueID)

left join (
			select 
			m.MitelQueueID
			,m.MitelQueueName
			,count(distinct NHMemberId) New_Leads
			from [ReportsData].[viewMemberInfoRpt1]  v
			left join bireports.MitelQueue_CRMCarrier_Mapping m on (CASE WHEN v.HealthPlanName = 'HAP UAW Trust VEBA' THEN 'HAP UAW Trust VEBA' else v.[Program Name] END =m.CRMCarrierName)
			where 1=1
			and CAST([First Time Called] AT TIME ZONE 'UTC' AT TIME ZONE 'Eastern Standard Time' AS DATE) between @StartDate and @EndDate
			and ([Program Name] is not null or [Program Name] <> 'NULL')
			group by m.MitelQueueID
			,m.MitelQueueName
		 ) nl on (nl.MitelQueueID=t.MitelQueueID)

left join (
			select 
			m.MitelQueueID
			,m.MitelQueueName
			,count(distinct NHMemberId) HT_Scheduled
			from [ReportsData].[viewMemberInfoRpt1]   v
			left join bireports.MitelQueue_CRMCarrier_Mapping m on (CASE WHEN v.HealthPlanName = 'HAP UAW Trust VEBA' THEN 'HAP UAW Trust VEBA' else v.[Program Name] END = m.CRMCarrierName)
			where 1=1
			and CAST([Date Appt was Created]  AS DATE) between @StartDate and @EndDate
			and ([Program Name] is not null or [Program Name] <> 'NULL')
			and [Program Name] <> 'Anthem Funded'
			group by m.MitelQueueID
			,m.MitelQueueName
		  ) ht on (ht.MitelQueueID=t.MitelQueueID)

left join (
			select m.MitelQueueID
			,m.MitelQueueName
			,sum(v.[Device Count]) Units_Sold
			,SUM(v.[Product Price]) Units_Price
			,SUM(case when v.[Left Ear Earmolds]='TRUE' THEN 1 ELSE 0 END)+SUM(case when v.[Right Ear Earmolds]='TRUE' THEN 1 ELSE 0 END) Earmold_Units 
			from [ReportsData].[4_CRMOrders] v
			left join bireports.MitelQueue_CRMCarrier_Mapping m on (CASE WHEN v.[Plan or Program Name] = 'HAP UAW Trust VEBA' THEN 'HAP UAW Trust VEBA' else v.[Insurance Carrier Name] END = m.CRMCarrierName)
			where 1=1
			and CAST([Date Approved]  AS DATE) between @StartDate and @EndDate
			and [Status Code] not in ('','CAN')
			and [Order Type] = 'NEW'
			and Status = 'ACTIVE'
			and ([Insurance Carrier Name] is not null or [Insurance Carrier Name] <> 'NULL')
			and [Insurance Carrier Name] <> 'Anthem Funded'
			group by m.MitelQueueID
			,m.MitelQueueName
		 ) u on (u.MitelQueueID=t.MitelQueueID)


left join (
			SELECT m.MitelQueueID,m.MitelQueueName
			,SUM(pp.AmountPaid) Cash_Collected
			FROM [bireports].[PPaymentInfo] pp
			LEFT JOIN orders.orders o ON (o.OrderID=pp.OrderID)
			LEFT JOIN Insurance.InsuranceCarriers c ON (CAST(JSON_VALUE(o.MemberData,'$.insCarrierId') AS INT) = c.InsuranceCarrierID)
			LEFT JOIN Insurance.InsuranceHealthPlans h ON (CAST(JSON_VALUE(o.MemberData,'$.insPlanId') AS INT)=h.InsuranceHealthPlanID)
			LEFT JOIN bireports.MitelQueue_CRMCarrier_Mapping m ON ((CASE WHEN h.HealthPlanName = 'HAP UAW Trust VEBA' THEN 'HAP UAW Trust VEBA' ELSE c.InsuranceCarrierName END=m.CRMCarrierName) AND CAST(JSON_VALUE(o.MemberData,'$.insCarrierId') AS INT)<>0)
			WHERE 1=1
			and CAST(pp.PaymentDate  AS DATE) between @StartDate and @EndDate
			and o.OrderType = 'NEW'
			and o.Status = 'ACTIVE'
			GROUP BY m.MitelQueueID,m.MitelQueueName
		 ) cc on (cc.MitelQueueID=t.MitelQueueID)
WHERE 1=1
AND t.MitelQueueID  in ('P102','P104','P129','P130','P139','P159','P160','P161','P162','P171','P172','P177') -- Funded Plans


UNION

-- Discount Plans
select 
2 as Seq
,@StartDate AS Start_Date
,@EndDate AS End_Date
,t.MitelQueueID
,CASE WHEN t.MitelQueueName='Member Support Web' THEN 'NationsHearing Discount' ELSE t.MitelQueueName END MitelQueueName
,m.ACD_Calls_Handled
,ISNULL(nl.New_Leads,0) New_Leads
,ISNULL(ht.HT_Scheduled,0) HT_Scheduled
,ISNULL(u.Units_Sold,0) Units_Sold
,ISNULL(u.Units_Price,0) Units_Price
,ISNULL(u.Earmold_Units,0) Earmold_Units
,ISNULL(cc.Cash_Collected,0) Cash_Collected
,m.AHT,m.ASA
,m.[ABN%],m.[SL%]
--,m.[ABN1%],m.[SL1%]
from (select distinct 
		MitelQueueID
		,MitelQueueName
		from bireports.MitelQueue_CRMCarrier_Mapping) t

left join (
			select 
			--1 as seq,
			QueueReporting
			,QueueName
			--,sum(QueueOffered) ACD_Calls_Offered
			,sum(QueueAnswered) ACD_Calls_Handled
			--,sum(QueueAbandoned) ACD_Calls_Abandoned
			--,sum(QueueServiceCount) ACD_Calls_SL

			--,RIGHT('00' + CAST(sum(QueueInternalACDDuration+QueueExternalACDDuration)/3600  AS VARCHAR(2)), 2 ) +':'+ -- HH
			--RIGHT('00' + CAST((sum(QueueInternalACDDuration+QueueExternalACDDuration)%3600 )/60 AS VARCHAR(2)), 2 ) +':'+  --MM
			--RIGHT('00' + CAST(sum(QueueInternalACDDuration+QueueExternalACDDuration)%60  AS VARCHAR(2)), 2 ) AS ACD_HT-- SS

			,CASE WHEN sum(QueueAnswered) = 0 THEN '00:00:00' ELSE
			RIGHT('00' + CAST((sum(QueueInternalACDDuration+QueueExternalACDDuration)/sum(QueueAnswered))/3600  AS VARCHAR(2)), 2 ) +':'+ -- HH
			RIGHT('00' + CAST(((sum(QueueInternalACDDuration+QueueExternalACDDuration)/sum(QueueAnswered))%3600 )/60 AS VARCHAR(2)), 2 ) +':'+  --MM
			RIGHT('00' + CAST((sum(QueueInternalACDDuration+QueueExternalACDDuration)/sum(QueueAnswered))%60  AS VARCHAR(2)), 2 ) END AS AHT-- SS

			,CASE WHEN sum(QueueAnswered) = 0 THEN '00:00:00' ELSE
			RIGHT('00' + CAST((sum(QueueTimeToAnswerTotal)/sum(QueueAnswered))/3600  AS VARCHAR(2)), 2 ) +':'+ -- HH
			RIGHT('00' + CAST(((sum(QueueTimeToAnswerTotal)/sum(QueueAnswered))%3600 )/60 AS VARCHAR(2)), 2 ) +':'+  --MM
			RIGHT('00' + CAST((sum(QueueTimeToAnswerTotal)/sum(QueueAnswered))%60  AS VARCHAR(2)), 2 ) END AS ASA-- SS

			--,CASE WHEN sum(QueueAnswered)=0 THEN cast(0 as decimal(10,2)) ELSE (sum(QueueAbandoned)/CAST(sum(QueueAnswered) AS DECIMAL(10,2)))*100 END AS [ABN%]
			,CASE WHEN sum(QueueAnswered)=0 THEN CAST(cast(0 as decimal(10,2)) AS VARCHAR)+'%' else CAST( cast(sum(QueueAbandoned)/CAST(sum(QueueAnswered) AS DECIMAL(10,2))*100 as decimal(10,2)) AS VARCHAR)+'%' END AS [ABN%]			

			--,CASE WHEN sum(QueueOffered)=0 THEN cast(100 as decimal(10,2)) ELSE (sum(QueueServiceCount)/CAST(sum(QueueOffered) AS DECIMAL(10,2)))*100 END AS [SL%]
			,CASE WHEN sum(QueueOffered)=0 THEN CAST(cast(100 as decimal(10,2)) AS VARCHAR)+'%' ELSE CAST(CAST((sum(QueueServiceCount)/CAST(sum(QueueOffered) AS DECIMAL(10,2)))*100 AS DECIMAL(10,2)) AS VARCHAR)+'%' END AS [SL%]

			--,CASE WHEN sum(QueueAnswered)=0 THEN cast(0 as decimal(10,2)) ELSE (sum(QueueAbandoned)/CAST(sum(QueueAnswered) AS DECIMAL(10,2)))*100 END AS [ABN%]
			--,CASE WHEN sum(QueueOffered)=0 THEN cast(100 as decimal(10,2)) ELSE (sum(QueueServiceCount)/CAST(sum(QueueOffered) AS DECIMAL(10,2)))*100 END AS [SL%]
			--,CASE WHEN sum(QueueOffered)=0 THEN cast(0 as decimal(10,2)) ELSE (sum(QueueAnswered)/CAST(sum(QueueOffered) AS DECIMAL(10,2)))*100 END AS [Answered%]

			from [bireports].[Mitel_QueuePerformanceByPeriodStats] with (nolock)
			where 1=1
			and QueueReporting in ('P100','P101','P107','P125','P126','P143','P163','P164') -- Discount Plans
			and cast([MidnightStartDate] as date) between @StartDate and @EndDate
			group by QueueReporting
			,QueueName
			--order by 1
		  ) m on (m.QueueReporting=t.MitelQueueID)

left join (
			select 
			m.MitelQueueID
			,m.MitelQueueName
			,count(distinct NHMemberId) New_Leads
			from [ReportsData].[viewMemberInfoRpt1]  v
			left join bireports.MitelQueue_CRMCarrier_Mapping m on (v.[Program Name]=m.CRMCarrierName)
			where 1=1
			and CAST([First Time Called] AT TIME ZONE 'UTC' AT TIME ZONE 'Eastern Standard Time' AS DATE) between @StartDate and @EndDate
			and ([Program Name] is not null or [Program Name] <> 'NULL')
			group by m.MitelQueueID
			,m.MitelQueueName
		 ) nl on (nl.MitelQueueID=t.MitelQueueID)

left join (
			select 
			m.MitelQueueID
			,m.MitelQueueName
			,count(distinct NHMemberId) HT_Scheduled
			from [ReportsData].[viewMemberInfoRpt1]   v
			left join bireports.MitelQueue_CRMCarrier_Mapping m on (v.[Program Name]=m.CRMCarrierName)
			where 1=1
			and CAST([Date Appt was Created]  AS DATE) between @StartDate and @EndDate
			and ([Program Name] is not null or [Program Name] <> 'NULL')
			and [Program Name] <> 'Anthem Funded'
			group by m.MitelQueueID
			,m.MitelQueueName
		  ) ht on (ht.MitelQueueID=t.MitelQueueID)

left join (
			select m.MitelQueueID
			,m.MitelQueueName
			,sum(v.[Device Count]) Units_Sold
			,SUM(v.[Product Price]) Units_Price
			,SUM(case when v.[Left Ear Earmolds]='TRUE' THEN 1 ELSE 0 END)+SUM(case when v.[Right Ear Earmolds]='TRUE' THEN 1 ELSE 0 END) Earmold_Units 
			from [ReportsData].[4_CRMOrders] v
			left join bireports.MitelQueue_CRMCarrier_Mapping m on (v.[Insurance Carrier Name]=m.CRMCarrierName)
			where 1=1
			and CAST([Date Approved]  AS DATE) between @StartDate and @EndDate
			and [Status Code] not in ('','CAN')
			and [Order Type] = 'NEW'
			and Status = 'ACTIVE'
			and ([Insurance Carrier Name] is not null or [Insurance Carrier Name] <> 'NULL')
			and [Insurance Carrier Name] <> 'Anthem Funded'
			group by m.MitelQueueID
			,m.MitelQueueName
		 ) u on (u.MitelQueueID=t.MitelQueueID)


left join (
			SELECT m.MitelQueueID,m.MitelQueueName
			,SUM(pp.AmountPaid) Cash_Collected
			FROM [bireports].[PPaymentInfo] pp
			LEFT JOIN orders.orders o ON (o.OrderID=pp.OrderID)
			LEFT JOIN bireports.MitelQueue_CRMCarrier_Mapping m ON (CAST(JSON_VALUE(o.MemberData,'$.insCarrierId') AS INT)=m.CRMCarrierID AND CAST(JSON_VALUE(o.MemberData,'$.insCarrierId') AS INT)<>0)
			WHERE 1=1
			and CAST(pp.PaymentDate  AS DATE) between @StartDate and @EndDate
			and o.OrderType = 'NEW'
			and o.Status = 'ACTIVE'
			GROUP BY m.MitelQueueID,m.MitelQueueName
		 ) cc on (cc.MitelQueueID=t.MitelQueueID)
WHERE 1=1
AND t.MitelQueueID  IN ('P100','P101','P107','P125','P126','P143','P163','P164') -- Discount Plans

union

-- Funded & Discount Plans for total
select 
3 as Seq
,@StartDate AS Start_Date
,@EndDate AS End_Date
,'Totals',''
,m.ACD_Calls_Handled
,ISNULL(nl.New_Leads,0) New_Leads
,ISNULL(ht.HT_Scheduled,0) HT_Scheduled
,ISNULL(u.Units_Sold,0) Units_Sold
,ISNULL(u.Units_Price,0) Units_Price
,ISNULL(u.Earmold_Units,0) Earmold_Units
,ISNULL(cc.Cash_Collected,0) Cash_Collected
,m.AHT,m.ASA
,m.[ABN%],m.[SL%]
--,m.[ABN1%],m.[SL1%]
from (select 3 as seq,'Totals'  MitelQueueID ) t
left join (
			select 
			
			'Totals' QueueReporting
			--,QueueName
			--,sum(QueueOffered) ACD_Calls_Offered
			,sum(QueueAnswered) ACD_Calls_Handled
			--,sum(QueueAbandoned) ACD_Calls_Abandoned
			--,sum(QueueServiceCount) ACD_Calls_SL

			--,RIGHT('00' + CAST(sum(QueueInternalACDDuration+QueueExternalACDDuration)/3600  AS VARCHAR(2)), 2 ) +':'+ -- HH
			--RIGHT('00' + CAST((sum(QueueInternalACDDuration+QueueExternalACDDuration)%3600 )/60 AS VARCHAR(2)), 2 ) +':'+  --MM
			--RIGHT('00' + CAST(sum(QueueInternalACDDuration+QueueExternalACDDuration)%60  AS VARCHAR(2)), 2 ) AS ACD_HT-- SS

			,CASE WHEN sum(QueueAnswered) = 0 THEN '00:00:00' ELSE
			RIGHT('00' + CAST((sum(QueueInternalACDDuration+QueueExternalACDDuration)/sum(QueueAnswered))/3600  AS VARCHAR(2)), 2 ) +':'+ -- HH
			RIGHT('00' + CAST(((sum(QueueInternalACDDuration+QueueExternalACDDuration)/sum(QueueAnswered))%3600 )/60 AS VARCHAR(2)), 2 ) +':'+  --MM
			RIGHT('00' + CAST((sum(QueueInternalACDDuration+QueueExternalACDDuration)/sum(QueueAnswered))%60  AS VARCHAR(2)), 2 ) END AS AHT-- SS

			,CASE WHEN sum(QueueAnswered) = 0 THEN '00:00:00' ELSE
			RIGHT('00' + CAST((sum(QueueTimeToAnswerTotal)/sum(QueueAnswered))/3600  AS VARCHAR(2)), 2 ) +':'+ -- HH
			RIGHT('00' + CAST(((sum(QueueTimeToAnswerTotal)/sum(QueueAnswered))%3600 )/60 AS VARCHAR(2)), 2 ) +':'+  --MM
			RIGHT('00' + CAST((sum(QueueTimeToAnswerTotal)/sum(QueueAnswered))%60  AS VARCHAR(2)), 2 ) END AS ASA-- SS


			--,CASE WHEN sum(QueueAnswered)=0 THEN cast(0 as decimal(10,2)) ELSE (sum(QueueAbandoned)/CAST(sum(QueueAnswered) AS DECIMAL(10,2)))*100 END AS [ABN%]
			,CASE WHEN sum(QueueAnswered)=0 THEN CAST(cast(0 as decimal(10,2)) AS VARCHAR)+'%' else CAST( cast(sum(QueueAbandoned)/CAST(sum(QueueAnswered) AS DECIMAL(10,2))*100 as decimal(10,2)) AS VARCHAR)+'%' END AS [ABN%]			

			--,CASE WHEN sum(QueueOffered)=0 THEN cast(100 as decimal(10,2)) ELSE (sum(QueueServiceCount)/CAST(sum(QueueOffered) AS DECIMAL(10,2)))*100 END AS [SL%]
			,CASE WHEN sum(QueueOffered)=0 THEN CAST(cast(100 as decimal(10,2)) AS VARCHAR)+'%' ELSE CAST(CAST((sum(QueueServiceCount)/CAST(sum(QueueOffered) AS DECIMAL(10,2)))*100 AS DECIMAL(10,2)) AS VARCHAR)+'%' END AS [SL%]

			--,CASE WHEN sum(QueueAnswered)=0 THEN cast(0 as decimal(10,2)) ELSE (sum(QueueAbandoned)/CAST(sum(QueueAnswered) AS DECIMAL(10,2)))*100 END AS [ABN%]
			--,CASE WHEN sum(QueueOffered)=0 THEN cast(100 as decimal(10,2)) ELSE (sum(QueueServiceCount)/CAST(sum(QueueOffered) AS DECIMAL(10,2)))*100 END AS [SL%]
			--,CASE WHEN sum(QueueOffered)=0 THEN cast(0 as decimal(10,2)) ELSE (sum(QueueAnswered)/CAST(sum(QueueOffered) AS DECIMAL(10,2)))*100 END AS [Answered%]

			from [bireports].[Mitel_QueuePerformanceByPeriodStats] with (nolock)
			where 1=1
			and QueueReporting in ('P100','P101','P102','P104','P107','P125','P126','P129','P130','P139','P143','P159','P160','P161','P162','P163','P164','P171','P172','P177') -- Funded & Discount Plans for total
			and cast([MidnightStartDate] as date) between @StartDate and @EndDate
			--group by QueueReporting,QueueName
			--order by 1
		  ) m on (m.QueueReporting=t.MitelQueueID)

left join (
			select 
			'Totals' MitelQueueID
			--,m.MitelQueueName,
			,count(distinct NHMemberId) New_Leads
			from [ReportsData].[viewMemberInfoRpt1]  v
			join bireports.MitelQueue_CRMCarrier_Mapping m on (CASE WHEN v.HealthPlanName = 'HAP UAW Trust VEBA' THEN 'HAP UAW Trust VEBA' else v.[Program Name] END =m.CRMCarrierName)
			where 1=1
			and CAST([First Time Called] AT TIME ZONE 'UTC' AT TIME ZONE 'Eastern Standard Time' AS DATE) between @StartDate and @EndDate
			and ([Program Name] is not null or [Program Name] <> 'NULL')
			--group by m.MitelQueueID,m.MitelQueueName
		 ) nl on (nl.MitelQueueID=t.MitelQueueID)

left join (
			select 
			'Totals' MitelQueueID
			--,m.MitelQueueName,
			,count(distinct NHMemberId) HT_Scheduled
			from [ReportsData].[viewMemberInfoRpt1]   v
			join bireports.MitelQueue_CRMCarrier_Mapping m on (CASE WHEN v.HealthPlanName = 'HAP UAW Trust VEBA' THEN 'HAP UAW Trust VEBA' else v.[Program Name] END = m.CRMCarrierName)
			where 1=1
			and CAST([Date Appt was Created]  AS DATE) between @StartDate and @EndDate
			and ([Program Name] is not null or [Program Name] <> 'NULL')
			and [Program Name] <> 'Anthem Funded'
			--group by m.MitelQueueID,m.MitelQueueName
		  ) ht on (ht.MitelQueueID=t.MitelQueueID)

left join (
			select 
			'Totals' MitelQueueID
			--,m.MitelQueueName,
			,sum(v.[Device Count]) Units_Sold
			,SUM(v.[Product Price]) Units_Price
			,SUM(case when v.[Left Ear Earmolds]='TRUE' THEN 1 ELSE 0 END)+SUM(case when v.[Right Ear Earmolds]='TRUE' THEN 1 ELSE 0 END) Earmold_Units 
			from [ReportsData].[4_CRMOrders] v
			join bireports.MitelQueue_CRMCarrier_Mapping m on (CASE WHEN v.[Plan or Program Name] = 'HAP UAW Trust VEBA' THEN 'HAP UAW Trust VEBA' else v.[Insurance Carrier Name] END = m.CRMCarrierName)
			where 1=1
			and CAST([Date Approved]  AS DATE) between @StartDate and @EndDate
			and [Status Code] not in ('','CAN')
			and [Order Type] = 'NEW'
			and Status = 'ACTIVE'
			and ([Insurance Carrier Name] is not null or [Insurance Carrier Name] <> 'NULL')
			and [Insurance Carrier Name] <> 'Anthem Funded'
			--group by m.MitelQueueID,m.MitelQueueName
		 ) u on (u.MitelQueueID=t.MitelQueueID)


left join (
			SELECT 'Totals' MitelQueueID
			--,m.MitelQueueName,
			,SUM(pp.AmountPaid) Cash_Collected
			FROM [bireports].[PPaymentInfo] pp
			LEFT JOIN orders.orders o ON (o.OrderID=pp.OrderID)
			LEFT JOIN Insurance.InsuranceCarriers c ON (CAST(JSON_VALUE(o.MemberData,'$.insCarrierId') AS INT) = c.InsuranceCarrierID)
			LEFT JOIN Insurance.InsuranceHealthPlans h ON (CAST(JSON_VALUE(o.MemberData,'$.insPlanId') AS INT)=h.InsuranceHealthPlanID)
			LEFT JOIN bireports.MitelQueue_CRMCarrier_Mapping m ON ((CASE WHEN h.HealthPlanName = 'HAP UAW Trust VEBA' THEN 'HAP UAW Trust VEBA' ELSE c.InsuranceCarrierName END=m.CRMCarrierName) AND CAST(JSON_VALUE(o.MemberData,'$.insCarrierId') AS INT)<>0)
			WHERE 1=1
			and CAST(pp.PaymentDate  AS DATE) between @StartDate and @EndDate
			and o.OrderType = 'NEW'
			and o.Status = 'ACTIVE'
			--GROUP BY m.MitelQueueID,m.MitelQueueName
		 ) cc on (cc.MitelQueueID=t.MitelQueueID)
WHERE 1=1
--AND t.MitelQueueID IN ('P100','P101','P102','P104','P107','P125','P126','P129','P130','P139','P143','P159','P160','P161','P162','P163','P164','P171','P172') -- Funded & Discount Plans for total

UNION

-- Outbound Calls
--select 
--4 as Seq
--,@StartDate AS Start_Date
--,@EndDate AS End_Date
--,NULL,NULL
--,999999
--,NULL,NULL,NULL,NULL,NULL,NULL,NULL,NULL,NULL

--UNION

select 
4 as Seq
,@StartDate AS Start_Date
,@EndDate AS End_Date
,NULL,'Outbound Calls'
,COUNT(*) OutboundCalls
,NULL,NULL,NULL,NULL,NULL,NULL,NULL,NULL,NULL,NULL
FROM bireports.Mitel_InOut_CallDetail 
WHERE 1=1
and cast([MidnightStartDate] as date) between @StartDate and @EndDate
AND CallDirection='Outbound'


order by Seq,MitelQueueName
CREATE view [bireports].[WebLeads]
as

select ID, LeadSource, [Name], EmailAddress, PhoneNbr as PhoneNumber, 
CAST(createdate AT TIME ZONE 'UTC'   AT TIME ZONE 'Eastern Standard Time' AS DATE) CreateDate
from contact.webleads
where leadsource<>'hearX'
and ReferenceId not in ( '175.101.1.50','0.0.0.1')





CREATE VIEW bireports.LocationLinkMissing AS
select distinct locationid from dbo.providerdatalocations
where locationid not in ('')
except
select distinct locationid from dbo.providerdataHCPMapping
where locationid not in ('');

CREATE VIEW bireports.PRHCPSummary AS

select distinct plhm.HCPID, 'HCPs' Category from bireports.PRProviderLocationHCPMapping plhm 
inner join bireports.PRLocations pl on (pl.ProviderId = plhm.ProviderId and pl.LocationId = plhm.LocationId)
inner join bireports.PRHCPs h on ( h.hcpid = plhm.hcpid )
where 1 = 1
and pl.LocationStatus = 'Active'
and plhm.MappingStatus = 'Active'
and h.HCPStatus = 'Active'

UNION

select distinct plhm.HCPID, 'Credentialed HCPs' Category from bireports.PRProviderLocationHCPMapping plhm 
inner join bireports.PRLocations pl on (pl.ProviderId = plhm.ProviderId and pl.LocationId = plhm.LocationId)
inner join bireports.PRHCPs h on ( h.hcpid = plhm.hcpid )
where 1 = 1
and pl.LocationStatus = 'Active'
and plhm.MappingStatus = 'Active'
and h.HCPStatus = 'Active'
and isnull(h.CredentialedStatus,'')  not in( '','NO','In Progress')

UNION

select distinct plhm.HCPID, 'Medicaid HCPs' Category from bireports.PRProviderLocationHCPMapping plhm 
inner join bireports.PRLocations pl on (pl.ProviderId = plhm.ProviderId and pl.LocationId = plhm.LocationId)
inner join bireports.PRHCPs h on ( h.hcpid = plhm.hcpid )
where 1 = 1
and pl.LocationStatus = 'Active'
and plhm.MappingStatus = 'Active'
and h.HCPStatus = 'Active'
and isnull(h.MedicaidID,'')  <> ''

UNION

select distinct plhm.HCPID, 'Medicare HCPs' Category from bireports.PRProviderLocationHCPMapping plhm 
inner join bireports.PRLocations pl on (pl.ProviderId = plhm.ProviderId and pl.LocationId = plhm.LocationId)
inner join bireports.PRHCPs h on ( h.hcpid = plhm.hcpid )
where 1 = 1
and pl.LocationStatus = 'Active'
and plhm.MappingStatus = 'Active'
and h.HCPStatus = 'Active'
and isnull(h.MedicareID,'')  <> ''

CREATE VIEW bireports.PRLocationSummary AS

select  pl.PLKey, 'Locations' Category from bireports.PRProviders p
inner join bireports.PRLocations pl on (p.ProviderId = pl.ProviderId)
where 1 = 1
and p.ProviderStatus = 'Active'
and pl.LocationStatus = 'Active'

UNION

select  distinct pl.PLKey, 'Medicaid Locations' Category from 
bireports.PRProviderLocationHCPMapping plhm
inner join bireports.PRLocations pl on (plhm.PLKey = pl.PLKey)
inner join bireports.PRHCPs h on (h.hcpid = plhm.hcpid)
where 1 = 1
and h.HCPStatus = 'Active'
and pl.LocationStatus = 'Active'
and MappingStatus = 'Active'
and isnull(h.MedicaidID,'')  <> ''

UNION

select  distinct pl.PLKey, 'Medicare Locations' Category from 
bireports.PRProviderLocationHCPMapping plhm
inner join bireports.PRLocations pl on (plhm.PLKey = pl.PLKey)
inner join bireports.PRHCPs h on (h.hcpid = plhm.hcpid)
where 1 = 1
and h.HCPStatus = 'Active'
and pl.LocationStatus = 'Active'
and MappingStatus = 'Active'
and isnull(h.MedicareID,'')  <> ''
CREATE View bireports.MembersLastCallInfo as
  select NHMemberID ,AgentUserProfileName LastAgent, cast(HTDispositionCreateDate as date) LastContactDate, ParentEventID EventID From 
                                  (
                                  select cc.MemberNHMemberId NHMemberID, AgentUserProfileName,  cc.createDate HTDispositionCreateDate,  dispevents.ParentEventID,
                                  dense_rank() over (partition by nhmemberid order by cc.createDate desc , cc.callconversationid desc) rank_code
                                  from callcenter.callpageevents cpe
                                  INNER JOIN CallCenter.CallConversations cc on (cc.CallConversationId =  cpe.CallConversationId )
								  INNER JOIN bireports.PMembers m on (m.NHMemberID = cc.MemberNHMemberId)
								  INNER JOIN  ( -- All Disposition Events except Maintenace and Complaint
													select EventId, ParentEventId From jobs.events
														where 1 = 1
														--and IsActive = 1
														and EventTriggerBy = 'DISPOSITION'
														and isnull(ParentEventId,'') <> ''
														and EventId not in -- Exclude all events who are Maintenance and Complaint
															(select EventId from jobs.events where isnull(ParentEventId,'')  in (46,232))
														UNION 
														select EventId, EventId ParentEventId  From jobs.events
														where 1 = 1
														--and IsActive = 1
														and EventTriggerBy = 'DISPOSITION'
														and isnull(ParentEventId,'') = ''
														and EventId not in (46,232)
												) dispevents on (cpe.EventId = dispevents.EventId )
                                         ) f
                                  where 1 = 1
                                  and rank_code = 1

CREATE VIEW bireports.PRSummary AS

select distinct plhm.HCPID, 'HCPs' Category from bireports.PRProviderLocationHCPMapping plhm 
inner join bireports.PRLocations pl on (pl.ProviderId = plhm.ProviderId and pl.LocationId = plhm.LocationId)
inner join bireports.PRHCPs h on ( h.hcpid = plhm.hcpid )
where 1 = 1
and pl.LocationStatus = 'Active'
and plhm.MappingStatus = 'Active'
and h.HCPStatus = 'Active'

UNION

select distinct plhm.HCPID, 'Credentialed HCPs' Category from bireports.PRProviderLocationHCPMapping plhm 
inner join bireports.PRLocations pl on (pl.ProviderId = plhm.ProviderId and pl.LocationId = plhm.LocationId)
inner join bireports.PRHCPs h on ( h.hcpid = plhm.hcpid )
where 1 = 1
and pl.LocationStatus = 'Active'
and plhm.MappingStatus = 'Active'
and h.HCPStatus = 'Active'
and isnull(h.CredentialedStatus,'')  not in( '','NO','In Progress')

UNION

select distinct plhm.HCPID, 'Medicaid HCPs' Category from bireports.PRProviderLocationHCPMapping plhm 
inner join bireports.PRLocations pl on (pl.ProviderId = plhm.ProviderId and pl.LocationId = plhm.LocationId)
inner join bireports.PRHCPs h on ( h.hcpid = plhm.hcpid )
where 1 = 1
and pl.LocationStatus = 'Active'
and plhm.MappingStatus = 'Active'
and h.HCPStatus = 'Active'
and isnull(h.MedicaidID,'')  <> ''

UNION

select distinct plhm.HCPID, 'Medicare HCPs' Category from bireports.PRProviderLocationHCPMapping plhm 
inner join bireports.PRLocations pl on (pl.ProviderId = plhm.ProviderId and pl.LocationId = plhm.LocationId)
inner join bireports.PRHCPs h on ( h.hcpid = plhm.hcpid )
where 1 = 1
and pl.LocationStatus = 'Active'
and plhm.MappingStatus = 'Active'
and h.HCPStatus = 'Active'
and isnull(h.MedicareID,'')  <> ''


UNION

select  pl.PLKey, 'Locations' Category from bireports.PRProviders p
inner join bireports.PRLocations pl on (p.ProviderId = pl.ProviderId)
where 1 = 1
and p.ProviderStatus = 'Active'
and pl.LocationStatus = 'Active'

UNION

select  distinct pl.PLKey, 'Medicaid Locations' Category from 
bireports.PRProviderLocationHCPMapping plhm
inner join bireports.PRLocations pl on (plhm.PLKey = pl.PLKey)
inner join bireports.PRHCPs h on (h.hcpid = plhm.hcpid)
where 1 = 1
and h.HCPStatus = 'Active'
and pl.LocationStatus = 'Active'
and MappingStatus = 'Active'
and isnull(h.MedicaidID,'')  <> ''

UNION

select  distinct pl.PLKey, 'Medicare Locations' Category from 
bireports.PRProviderLocationHCPMapping plhm
inner join bireports.PRLocations pl on (plhm.PLKey = pl.PLKey)
inner join bireports.PRHCPs h on (h.hcpid = plhm.hcpid)
where 1 = 1
and h.HCPStatus = 'Active'
and pl.LocationStatus = 'Active'
and MappingStatus = 'Active'
and isnull(h.MedicareID,'')  <> ''

create view bireports.testPR
AS
select hcp.hcpid, case when hcp.IsActive =0 then 'InActive'  when hcp.IsActive =1 then 'Active' end HCPStatus
,hcp.NPINumber HCPNPI, hcp.FirstName hcpFirstName, hcp.LastName hcpLastName , hcp.Title hcpTitle,h.*

,l.locationid loclocationid,l.BusinessName locDBA, case when l.IsActive =0 then 'InActive'  when l.IsActive =1 then 'Active' end   LocationStatus
,l.Brands LocBrands, l.Address1 locAddress1,l.Address2 locAddress2, l.City locCity,l.State locState, l.Zip locZip,l.County locCounty
, l.BusinessType locBusinessType, l.IsVerified locIsVerified,l.IsWheelChair locIsWheelChair
,l.Langauges locLanguages,l.Latitude locLatitude,l.Longitude locLongitude,l.TimeZone locTimeZone
,l.NPiNumber LocationNPINumber,l.LocationEmailAddress,l.IsMedicaid LocationMedicaid,l.ActiveDate locActiveDate, l.InActiveDate locInActiveDate
,l.InActiveReason locInActiveReason, l.IsMedicare locIsMedicare, l.IsCredentialsMet locIsCredentialsMet,l.IsMobileLocation locIsMobileLocation
,l.IsHandicapSpecialNeedsAccess locIsHandicapSpecialNeedsAccess,l.IsPediatricServices locIsPediatricServices,l.IsPublicTransport locIsPublicTransport
,l.IsADAComplauints locIsADAComplaints, l.IsAcceptNewPatients locIsAcceptNewPatients,l.PatientMinAge locPatientMinAge,l.PatientMaxAge locPatientMaxAge

,p.ProviderId,p.Brands provBrands, case when p.IsActive =0 then 'InActive'  when p.IsActive =1 then 'Active' end  ProviderStatus,p.ProviderName,p.PrimaryEmailAddress provPrimaryEmailAddress
,p.TaxId provTaxId,pa.*, case when pul.IsActive =0 then 'InActive'  when pul.IsActive =1 then 'Active' end  MappingStatus
from provider.hcpproviderprofile hcp
left join provider.provideruserlocations pul on pul.userprofileid = hcp.userprofileid
outer apply openjson (case when ISJSON(hcp.LicenseData) = 1 then hcp.LicenseData else '{}' end) with 
(
	hcplicenseNumber1 varchar(300)  '$.licenseNumber1'
	,hcplicenseStates1 varchar(300)  '$.licenseStates1'
	,hcplicenseNumber2 varchar(300)  '$.licenseNumber2'
	,hcplicenseStates2 varchar(300)  '$.licenseStates2'
	,hcplicenseNumber3 varchar(300)  '$.licenseNumber3'
	,hcplicenseStates3 varchar(300)  '$.licenseStates3'
	,hcpboardCertified varchar(300)  '$.boardCertified'
	,hcpcredentialDate varchar(300)  '$.credentialDate'
) as h
left join provider.locations l on pul.locationid = l.locationid
left join provider.providerprofiles p on pul.providerid = p.providerid
outer apply openjson (case when ISJSON(p.AdditionalData) = 1 then p.AdditionalData else '{}' end) with 
(
	provbaddress1 varchar(300)  '$.billingAddress.address1'
	,provbaddress2 varchar(300)  '$.billingAddress.address2'
	,provbcity varchar(300)  '$.billingAddress.city'
	,provbstate varchar(300)  '$.billingAddress.state'
	,provbzip varchar(300)  '$.billingAddress.zip'
	,provbcounty varchar(300)  '$.billingAddress.county'
	,provbphoneNumber varchar(300)  '$.billingAddress.phoneNumber'
	,provbemail varchar(300)  '$.billingAddress.email'
	,provsaddress1 varchar(300)  '$.shippingAddress.address1'
	,provsaddress2 varchar(300)  '$.shippingAddress.address2'
	,provscity varchar(300)  '$.shippingAddress.city'
	,provsstate varchar(300)  '$.shippingAddress.state'
	,provszip varchar(300)  '$.shippingAddress.zip'
	,provscounty varchar(300)  '$.shippingAddress.county'
	,provsphoneNumber varchar(300)  '$.shippingAddress.phoneNumber'
	,provsemail varchar(300)  '$.shippingAddress.email'
	,provownerFirstName varchar(300)  '$.owner.firstName'
	,provownerLastName varchar(300)  '$.owner.lastName'
	,provContractType varchar(300)  '$.contractInfo.contractType'
	,provinitialContractDate varchar(300)  '$.contractInfo.initialContractDate'
	,provrecentContractDate varchar(300)  '$.contractInfo.recentContractDate'
	,provcontractTerminationDate varchar(300)  '$.contractInfo.contractTerminationDate'
	,provanthemAmendmentDate varchar(300)  '$.contractInfo.anthemAmendmentDate'
	,provadaAttestationReceivedDate varchar(300)  '$.adaAttestationReceivedDate'
	,provmedicareAttestationReceivedDate varchar(300)  '$.medicareAttestationReceivedDate'
) as pa


CREATE VIEW bireports.HCPLinkMissing AS
select  distinct hcpid  from dbo.providerdataHCPs
where isnull(hcpid,'') not in ('')
except
select distinct hcpid  from dbo.providerdataHCPMapping;
  CREATE view [bireports].[DTC1ProductPricing] as  
  SELECT DISTINCT
  hpc.InsuranceHealthPlanID InsuranceHealthPlanID,
 -- hpc.HealthPlanContractId,
  cp.FAMILYPRODUCTCATCODE,
  --cp.FAMILYPRODUCTCODE TECHNOLOGYLEVELCODE, 
  cp.itemcode
 -- cp.PerDeviceCOGSPrice PerDeviceCOGS,
 -- cp.PerDeviceDispensingFee PerDeviceDispensingFee,
--  cp.PerDeviceMemberPrice PerDeviceMemberPrice,
 -- cp.PerPairMemberPrice PerPairMemberPrice
FROM insurance.healthplancontracts hpc
LEFT OUTER JOIN INSURANCE.CONTRACTPRODUCTS cp
  ON (cp.HealthPlanContractId = hpc.HealthPlanContractId)
create view bireports.CallConversationCount as
select cc.MemberNHMemberId NHMemberID, count(1) CallCount
from callcenter.callpageevents cpe
INNER JOIN CallCenter.CallConversations cc on (cc.CallConversationId =  cpe.CallConversationId )
INNER JOIN bireports.PMembers m on (m.NHMemberID = cc.MemberNHMemberId)
INNER JOIN  ( -- All Disposition Events except Maintenance and Complaint
				select EventId, ParentEventId From jobs.events
					where 1 = 1
					--and IsActive = 1
					and EventTriggerBy = 'DISPOSITION'
					and isnull(ParentEventId,'') <> ''
					and EventId not in -- Exclude all events who are Maintenance and Complaint
						(select EventId from jobs.events where isnull(ParentEventId,'')  in (46,232))
					UNION 
					select EventId, EventId ParentEventId  From jobs.events
					where 1 = 1
					--and IsActive = 1
					and EventTriggerBy = 'DISPOSITION'
					and isnull(ParentEventId,'') = ''
					and EventId not in (46,232)
			) dispevents on (cpe.EventId = dispevents.EventId )
group by cc.MemberNHMemberId
                                    
Create view [bireports].[AllEvents] as
select EventID, EventName from jobs.events
where 1 = 1
and IsActive = 1
and EventTriggerBy = 'DISPOSITION'
and EventId not in (46,232)

CREATE VIEW bireports.DTCAllTestingAppts as
select mp.NHMemberID, mp.MemberProfileID, AppointmentTypeName, ma.AppointmentStatus,  ma.isactive IsActive, 
--cast(dateadd(hour, -4, ma.createdate) as date) CreateDate, 
CAST(ma.createdate AT TIME ZONE 'UTC'   AT TIME ZONE 'Eastern Standard Time' AS DATE) CreateDate,
ma.createuser,
cast(ma.StartDate as date) AppointmentDate,
 JSON_VALUE(mcd.processData, '$.providerId') ProviderID , 
 JSON_VALUE(mcd.processData, '$.locationId')  LocationID , 
 JSON_VALUE(mcd.processData, '$.HCPUserProfileId') HCPUserProfileID,
dense_rank() over (partition by mp.MemberProfileID, AppointmentTypeName order by ma.CreateDate desc, ma.MemberAppointmentID desc) rankcode,
dense_rank() over (partition by mp.MemberProfileID, AppointmentTypeName order by ma.CreateDate , ma.MemberAppointmentID ) rankcodefirst
From [provider].[MemberAppointments] ma
LEFT OUTER JOIN [provider].[AppointmentTypes] at on (at.AppointmentTypeID = ma.AppointmentTypeID)
LEFT OUTER JOIN [provider].[MemberChartData] mcd on (ma.MemberChartDataID = mcd.MemberChartDataID)
LEFT OUTER JOIN [provider].[MemberCharts] mc on (mc.MemberChartID = mcd.MemberChartID)
LEFT OUTER JOIN provider.MemberProfiles mp on (mp.memberprofileid = mc.memberprofileid)
where 1 = 1
--and ma.AppointmentStatus not in ('Cancel','Cancelled')
and at.AppointmentTypeName = 'Testing'
--and ma.isactive = 1
and ma.createuser not in 
(
'RMaram',
'testsatish',
'NHAdmin',
'testramu',
'Sareddy  Raj',
'sleathem',
'LBrown',
'rsareddy',
'sraghavendran',
'testmegha',
'testbhanu'
) 

CREATE VIEW  [bireports].[POrderCOGS]
AS

select tb.OrderNumber,tb.UnitCOGS,tb.PairCOGS
from
(


-- COGS price for orders under carrier Anthem, HAP Medicaid or Medicaid Plans
SELECT
o.NHMemberID,
o.orderid AS 'OrderNumber',      
CAST(o.[DateOrderInitiated] AS DATE) AS 'OrderCreatedDate',
(CASE WHEN JSON_VALUE(O.MEMBERDATA, '$.insurance.carrierName') = 'None' OR JSON_VALUE(O.MEMBERDATA, '$.insurance.carrierName') = '' THEN JSON_VALUE(O.MEMBERDATA, '$.insurance.programeName')
      ELSE JSON_VALUE(O.MEMBERDATA, '$.insurance.carrierName')  END) AS 'Carrier',
JSON_VALUE(O.MEMBERDATA, '$.insCarrierId') insuranceCarrierID,
JSON_VALUE(O.MEMBERDATA, '$.insPlanId') insurancePlanID,
hp.IsMedicaid,
JSON_VALUE(O.MEMBERDATA, '$.insurance.planName') AS 'Plan',
JSON_VALUE([MemberData],'$.firstName') AS [MemberFirstName],
JSON_VALUE([MemberData],'$.lastName') AS [MemberLastName],
[BrandCode] AS [Manufacturer] ,
[FamilyCode] AS [Family],
[TechnologyLevelCode] [Product],
o.ItemCode,
[DeviceCount] AS 'Qty',
CASE WHEN [DeviceCountRet] is NULL THEN '' ELSE [DeviceCountRet] END AS 'QtyReturned',
o.OrderID,
case when  (CASE WHEN JSON_VALUE(O.MEMBERDATA, '$.insurance.carrierName') = 'None' OR JSON_VALUE(O.MEMBERDATA, '$.insurance.carrierName') = '' THEN  JSON_VALUE(O.MEMBERDATA, '$.insurance.programeName')
                ELSE JSON_VALUE(O.MEMBERDATA, '$.insurance.carrierName') END) in ('Anthem Funded') and pl.PriceType='ANTHEM' then pl.UnitCOGS -- ANTHEM COGS
               
                when  pl.PriceType='MEDICAID' and isnull(hp.IsMedicaid,0)=1 then pl.UnitCOGS -- Default Medicaid COGS
				                                  
                end UnitCOGS,

case when (CASE WHEN JSON_VALUE(O.MEMBERDATA, '$.insurance.carrierName') = 'None' OR JSON_VALUE(O.MEMBERDATA, '$.insurance.carrierName') = '' THEN  JSON_VALUE(O.MEMBERDATA, '$.insurance.programeName')
                ELSE JSON_VALUE(O.MEMBERDATA, '$.insurance.carrierName') END) in ('Anthem Funded') and pl.PriceType='ANTHEM' then pl.PairCOGS -- ANTHEM COGS
               
                when  pl.PriceType='MEDICAID' and isnull(hp.IsMedicaid,0)=1 then pl.PairCOGS -- Default Medicaid COGS
				                                  
                end PairCOGS,
pl.PriceType

--
--,O.ItemCode,PL.ItemCode,pl.UnitCOGS,HP.InsuranceHealthPlanID
--
          FROM
          (
          SELECT s.* , oi.BrandCode, oi.FamilyCode, oi.StyleCode, oi.TechnologyLevelCode, oi.ProductModelCode, oi.ItemCode, oq.DeviceCount, oqret.DeviceCountRet
          FROM orders.orders s
                      INNER JOIN
                      (
                             SELECT DISTINCT orderid, BrandCode, FamilyCode, StyleCode, TechnologyLevelCode, ProductModelCode, ItemCode
                             FROM orders.OrderItems
                             WHERE 1 = 1
                             AND ItemType IN ('HA')
                             AND IsActive = 1
                     ) oi ON (oi.orderid = s.orderid)

                      INNER JOIN
                      (
                             SELECT orderid, SUM(Quantity) DeviceCount
                             FROM orders.OrderItems
                             WHERE 1 = 1
                             AND ItemType IN ('HA','CROS')
                             AND IsActive = 1
                             GROUP BY ORDERID
                      ) oq ON (oq.orderid = s.orderid)

                      LEFT JOIN
                      (
                             SELECT orderid, SUM(Quantity) DeviceCountRet
                             FROM orders.OrderItems
                             WHERE 1 = 1
                             AND ItemType IN ('HA','CROS')
                             AND IsActive = 1
                             and STATUS='RETURNED'
                             GROUP BY ORDERID,STATUS
                      ) oqret ON (oqret.orderid = s.orderid)
           )  O
           left join (select distinct case when ItemCode like '%DRWZ%' then replace(ItemCode, 'DRWZ', 'DWRZ') when ItemCode like '%DWRZ%' then '' else ItemCode end ItemCode,pricetype,effectivefrom,effectiveto,unitcogs,paircogs from catalog.ItemMasterPriceList where IsActive=1 ) pl on (pl.ItemCode=o.ItemCode and CAST(o.[DateOrderInitiated] AS DATE) between  pl.EffectiveFrom and pl.EffectiveTo)
           left join Insurance.InsuranceHealthPlans hp on (hp.InsuranceHealthPlanID=cast(JSON_VALUE(O.MEMBERDATA, '$.insPlanId') as int))
           WHERE
           O.IsActive=1
           AND O.Status <> 'ALAN'
           AND O.OrderType not in ('OTC')
		   --AND O.ItemCode LIKE 'OT%'
           and case when  (CASE WHEN JSON_VALUE(O.MEMBERDATA, '$.insurance.carrierName') = 'None' OR JSON_VALUE(O.MEMBERDATA, '$.insurance.carrierName') = '' THEN  JSON_VALUE(O.MEMBERDATA, '$.insurance.programeName')
                ELSE JSON_VALUE(O.MEMBERDATA, '$.insurance.carrierName') END) in ('Anthem Funded') and pl.PriceType='ANTHEM' then pl.UnitCOGS -- ANTHEM COGS
               
                when  pl.PriceType='MEDICAID' and isnull(hp.IsMedicaid,0)=1 then pl.UnitCOGS -- Default Medicaid COGS
				                                  
                end is not null


UNION

-- COGS price for orders which are not under carrier Anthem, HAP Medicaid or Medicaid Plans, we use STANDARD COGS for all remaining orders
-- Exclude orders above
SELECT
o.NHMemberID,
o.orderid AS 'OrderNumber',      
CAST(o.[DateOrderInitiated] AS DATE) AS 'OrderCreatedDate',
(CASE WHEN JSON_VALUE(O.MEMBERDATA, '$.insurance.carrierName') = 'None' OR JSON_VALUE(O.MEMBERDATA, '$.insurance.carrierName') = '' THEN JSON_VALUE(O.MEMBERDATA, '$.insurance.programeName')
      ELSE JSON_VALUE(O.MEMBERDATA, '$.insurance.carrierName')  END) AS 'Carrier',
JSON_VALUE(O.MEMBERDATA, '$.insCarrierId') insuranceCarrierID,
JSON_VALUE(O.MEMBERDATA, '$.insPlanId') insurancePlanID,
hp.IsMedicaid,
JSON_VALUE(O.MEMBERDATA, '$.insurance.planName') AS 'Plan',
JSON_VALUE([MemberData],'$.firstName') AS [MemberFirstName],
JSON_VALUE([MemberData],'$.lastName') AS [MemberLastName],
[BrandCode] AS [Manufacturer] ,
[FamilyCode] AS [Family],
[TechnologyLevelCode] [Product],
o.ItemCode,
[DeviceCount] AS 'Qty',
CASE WHEN [DeviceCountRet] is NULL THEN '' ELSE [DeviceCountRet] END AS 'QtyReturned',
o.OrderID,
pl.UnitCOGS,
pl.PairCOGS,
pl.PriceType
          FROM
          (
          SELECT s.* , oi.BrandCode, oi.FamilyCode, oi.StyleCode, oi.TechnologyLevelCode, oi.ProductModelCode, oi.ItemCode, oq.DeviceCount, oqret.DeviceCountRet
          FROM orders.orders s
                      INNER JOIN
                      (
                             SELECT DISTINCT orderid, BrandCode, FamilyCode, StyleCode, TechnologyLevelCode, ProductModelCode, ItemCode
                             FROM orders.OrderItems
                             WHERE 1 = 1
                             AND ItemType IN ('HA')
                             AND IsActive = 1
                     ) oi ON (oi.orderid = s.orderid)

                      INNER JOIN
                      (
                             SELECT orderid, SUM(Quantity) DeviceCount
                             FROM orders.OrderItems
                             WHERE 1 = 1
                             AND ItemType IN ('HA','CROS')
                             AND IsActive = 1
                             GROUP BY ORDERID
                      ) oq ON (oq.orderid = s.orderid)

                      LEFT JOIN
                      (
                             SELECT orderid, SUM(Quantity) DeviceCountRet
                             FROM orders.OrderItems
                             WHERE 1 = 1
                             AND ItemType IN ('HA','CROS')
                             AND IsActive = 1
                             and STATUS='RETURNED'
                             GROUP BY ORDERID,STATUS
                      ) oqret ON (oqret.orderid = s.orderid)
           )  O
           left join (select distinct case when ItemCode like '%DRWZ%' then replace(ItemCode, 'DRWZ', 'DWRZ') when ItemCode like '%DWRZ%' then '' else ItemCode end ItemCode,pricetype,effectivefrom,effectiveto,unitcogs,paircogs from catalog.ItemMasterPriceList where IsActive=1 ) pl on (pl.ItemCode=o.ItemCode and pl.PriceType = 'STANDARD' and CAST(o.[DateOrderInitiated] AS DATE) between  pl.EffectiveFrom and pl.EffectiveTo)
           left join Insurance.InsuranceHealthPlans hp on (hp.InsuranceHealthPlanID=cast(JSON_VALUE(O.MEMBERDATA, '$.insPlanId') as int))
           WHERE
           O.IsActive=1
           AND O.Status <> 'ALAN'
           AND O.OrderType not in ('OTC')
		   AND O.OrderID NOT IN  -- Exclude orders under carrier Anthem, HAP Medicaid or Medicaid Plans
		   (
			   SELECT			
			   o.orderid 
			  FROM
			  (
			  SELECT s.* , oi.BrandCode, oi.FamilyCode, oi.StyleCode, oi.TechnologyLevelCode, oi.ProductModelCode, oi.ItemCode, oq.DeviceCount, oqret.DeviceCountRet
			  FROM orders.orders s
						  INNER JOIN
						  (
								 SELECT DISTINCT orderid, BrandCode, FamilyCode, StyleCode, TechnologyLevelCode, ProductModelCode, ItemCode
								 FROM orders.OrderItems
								 WHERE 1 = 1
								 AND ItemType IN ('HA')
								 AND IsActive = 1
						 ) oi ON (oi.orderid = s.orderid)

						  INNER JOIN
						  (
								 SELECT orderid, SUM(Quantity) DeviceCount
								 FROM orders.OrderItems
								 WHERE 1 = 1
								 AND ItemType IN ('HA','CROS')
								 AND IsActive = 1
								 GROUP BY ORDERID
						  ) oq ON (oq.orderid = s.orderid)

						  LEFT JOIN
						  (
								 SELECT orderid, SUM(Quantity) DeviceCountRet
								 FROM orders.OrderItems
								 WHERE 1 = 1
								 AND ItemType IN ('HA','CROS')
								 AND IsActive = 1
								 and STATUS='RETURNED'
								 GROUP BY ORDERID,STATUS
						  ) oqret ON (oqret.orderid = s.orderid)
			   )  O
			   left join (select distinct case when ItemCode like '%DRWZ%' then replace(ItemCode, 'DRWZ', 'DWRZ') when ItemCode like '%DWRZ%' then '' else ItemCode end ItemCode,pricetype,effectivefrom,effectiveto,unitcogs,paircogs from catalog.ItemMasterPriceList where IsActive=1 ) pl on (pl.ItemCode=o.ItemCode and CAST(o.[DateOrderInitiated] AS DATE) between  pl.EffectiveFrom and pl.EffectiveTo)
			   left join Insurance.InsuranceHealthPlans hp on (hp.InsuranceHealthPlanID=cast(JSON_VALUE(O.MEMBERDATA, '$.insPlanId') as int))
			   WHERE
			   O.IsActive=1
			   AND O.Status <> 'ALAN'
			   AND O.OrderType not in ('OTC')
			   and case when  (CASE WHEN JSON_VALUE(O.MEMBERDATA, '$.insurance.carrierName') = 'None' OR JSON_VALUE(O.MEMBERDATA, '$.insurance.carrierName') = '' THEN  JSON_VALUE(O.MEMBERDATA, '$.insurance.programeName')
                   ELSE JSON_VALUE(O.MEMBERDATA, '$.insurance.carrierName') END) in ('Anthem Funded') and pl.PriceType='ANTHEM' then pl.UnitCOGS -- ANTHEM COGS
               
                   when  pl.PriceType='MEDICAID' and isnull(hp.IsMedicaid,0)=1 then pl.UnitCOGS -- Default Medicaid COGS
				                                  
                   end is not null
		   )

) tb
create view bireports.ItemCodes as
select distinct ItemCode, replace(itemcode, ' ', '') MatchItemCode , MonauralHCPCSCode, BinauralHCPCSCode
From catalog.viewModelList 
create view bireports.MPhoneNbrs as
select memberid, PHoneNbr from (
select MemberId, PHoneNbr, dense_rank() over (partition by memberid order by phonetypecode, ID desc) rankcode
from master.phonenumbers
where isactive = 1
)a 
where rankcode = 1
CREATE view [bireports].[DTCMembers] as
select distinct p.NHMemberID From provider.MemberInsurances i
INNER JOIN provider.memberprofiles p on (p.memberprofileid = i.memberprofileid and p.isactive = 1)
where 1 = 1
 and i.InsuranceCarrierID=229
--UNION
--select distinct NHMemberID From [survey].[MemberSurveyQuestions]
--where 1 = 1
--and questionid = 2
--and NHMemberID<>'NH201901886346' -- Member moved to a different carrier
CREATE View bireports.DTCLeadSource as
select NHMemberID, a.Answer LeadSource
From [survey].[MemberSurveyQuestions] q
LEFT OUTER JOIN  [survey].[SurveyAnswers] a on (a.answerid = q.answerid)
where 1 = 1
and questionid = 2
CREATE view bireports.DTC_HearX_TestLead_Data as
select t.* , l.FirstName,l.LastName,l.Email, l.PhoneNbr, l.ZipCode, case isnull(l.UID,'')  when '' then 'Test Data Only' else 'Lead' end Datatype, CAST(getdate() AT TIME ZONE 'UTC' AT TIME ZONE 'Eastern Standard Time' AS DATETIME) RefreshDate
from
(
select 
ID,
json_value(eventdata, '$.data.uid') UID, 
json_value(eventdata, '$.data.pass') pass , 
CAST(dateadd(second, cast(json_value(eventdata, '$.data.test_date') as bigint),'1970-01-01') AT TIME ZONE 'UTC' AT TIME ZONE 'Eastern Standard Time' AS DATETIME) test_date ,
json_value(eventdata, '$.data.snr') snr , 
json_value(eventdata, '$.data.birth_date') birth_date , 
json_value(eventdata, '$.data.hearing_loss') hearing_loss ,
--case isnull(json_value(eventdata, '$.data.hearing_status'),'') when '' then 'Hearing Problem (No)' when 1 then 'Hearing Problem (Think), DO NOT Intend to take action now' when 2 then 'Hearing Problem (Yes), Intend to take action SOON' 
--when 3 then 'Hearing Problem (Yes), Here to take action NOW' end  hearing_status ,
case isnull(json_value(eventdata, '$.data.hearing_status'),'') 
	when '' then ''
	when 1 then 'Think'
	when 2 then 'Yes'
	when 3 then 'Yes' end hearing_status,
case isnull(json_value(eventdata, '$.data.hearing_status'),'') 
	when '' then ''
	when 1 then 'Not Now'
	when 2 then 'Soon'
	when 3 then 'Now' end Intended_Action,
json_value(eventdata, '$.data.score') score ,
json_value(eventdata, '$.data.resultText') resultText,
--convert(varchar,CAST(createdate AT TIME ZONE 'UTC' AT TIME ZONE 'Eastern Standard Time' AS DATETIME), 0) CreatedDate
CAST(createdate AT TIME ZONE 'UTC' AT TIME ZONE 'Eastern Standard Time' AS DATETIME) CreatedDate
from contact.webleads t
where 1 = 1
and  CAST(createdate AT TIME ZONE 'UTC'   AT TIME ZONE 'Eastern Standard Time' AS DATE) > cast('20190127' as date) 
and eventtype in ('test')
) t
LEFT OUTER JOIN 
(
select 
json_value(eventdata, '$.data.uid') UID, 
json_value(eventdata, '$.data.first_name') FirstName , 
json_value(eventdata, '$.data.last_name') LastName , 
json_value(eventdata, '$.data.email') Email , 
json_value(eventdata, '$.data.tel_number') PhoneNbr , 
json_value(eventdata, '$.data.zip_code') ZipCode
 from contact.webleads
 where 1 = 1
 and  CAST(createdate AT TIME ZONE 'UTC'   AT TIME ZONE 'Eastern Standard Time' AS DATE)  > cast('20190127' as date) 
  and eventtype in ('lead')
 ) l on l.UID = t.UID
where 1 = 1
and  not (
     isnull(hearing_status,'') = ''
 and isnull(birth_date,'') = '1970'
 and isnull(snr,'') = '20.5'
 and isnull(firstName,'') = ''
 and isnull(LastName,'') = ''
 and isnull(Email,'') = ''
 and isnull(PhoneNbr,'') = ''
 )




 CREATE view [bireports].[MemberAssignedMEA] AS
select a.NHMemberID
,ISNULL(t.AgentUserProfileName,a.MEA) MEA
,cast(a.CreateDate as date) FirstContactDate 
from (
		select MemberNHMemberId NHMemberID, AgentUserProfileName MEA,  CreateDate, dense_rank() over (partition by MemberNHMemberId order by CreateDate, callconversationID ) rank_code
		from callcenter.CallConversations c
		where 1 = 1
		and isnull(MemberNHMemberId,'') <> ''
) a 
left join bireports.DTCMemberCreatedByAgent t on (t.nhmemberid=a.NHMemberID)
where a.rank_code = 1

 create view bireports.PInsuranceDetails as
select 
  MemberInsuranceID
 ,GroupNbr
,isnull(InsuranceNbr,InsurerInsuranceNbr) InsuranceNbr
 from provider.memberinsurancedetails
 where IsActive = 1
 and isnull(InsuranceNbr,InsurerInsuranceNbr) is not null


CREATE view [bireports].[AnthemTestingDates] as
-- Added three JSON_Values ProviderID, LocationID, HCPUserProfileID below HAP on 02/11/2019
select distinct NHMemberID, MemberProfileID, AppointmentTypeName,  AppointmentStatus, IsActive, CreateDate, AppointmentDate, ProviderID, LocationID, HCPUserProfileID from (
select mp.NHMemberID, mp.MemberProfileID, AppointmentTypeName, ma.AppointmentStatus,  ma.isactive IsActive, 
--cast(dateadd(hour, -4, ma.createdate) as date) CreateDate, 
CAST(ma.createdate AT TIME ZONE 'UTC'   AT TIME ZONE 'Eastern Standard Time' AS DATE) CreateDate,
cast(ma.StartDate as date) AppointmentDate,
 JSON_VALUE(mcd.processData, '$.providerId') ProviderID , 
 JSON_VALUE(mcd.processData, '$.locationId')  LocationID , 
 JSON_VALUE(mcd.processData, '$.HCPUserProfileId') HCPUserProfileID,
dense_rank() over (partition by mp.MemberProfileID, AppointmentTypeName order by ma.CreateDate desc) rankcode
From [provider].[MemberAppointments] ma
LEFT OUTER JOIN [provider].[AppointmentTypes] at on (at.AppointmentTypeID = ma.AppointmentTypeID)
LEFT OUTER JOIN [provider].[MemberChartData] mcd on (ma.MemberChartDataID = mcd.MemberChartDataID)
LEFT OUTER JOIN [provider].[MemberCharts] mc on (mc.MemberChartID = mcd.MemberChartID)
LEFT OUTER JOIN provider.MemberProfiles mp on (mp.memberprofileid = mc.memberprofileid)
where 1 = 1
and cast(ma.StartDate as date) < cast('20190101' as date)
and ma.AppointmentStatus not in ('Cancel','Cancelled')
and at.AppointmentTypeName = 'Testing'
and ma.isactive = 1
and ma.createuser not in 
(
'RMaram',
'testsatish',
'NHAdmin',
'testramu',
'Sareddy  Raj',
'sleathem',
'LBrown',
'rsareddy',
'sraghavendran',
'testmegha',
'testbhanu'
) ) f
where f.rankcode = 1
CREATE view bireports.PMembers as
--Removing duplicates
select NHMemberID, MemberProfileID,  FirstName, LastName, DateofBirth,  CreateDate
From (
select  NHMemberID, MemberProfileID,  upper(FirstName) FirstName, upper(LastName) LastName, Cast(DateofBirth as date) DateofBirth, 
CAST(createdate AT TIME ZONE 'UTC'   AT TIME ZONE 'Eastern Standard Time' AS DATE) CreateDate,
-- RAJ CHANGED TO use UTC from SRI cast(dateadd(hour, -4, createdate) as date) CreateDate,
dense_rank() over (partition by nhmemberid order by MemberProfileID desc) rank_code
From provider.memberProfiles
where isactive  = 1
) a
where rank_code = 1
CREATE view bireports.PMemberInsurances as
select MemberProfileID,  InsuranceCarrierID from (
select  MemberProfileID,  InsuranceCarrierID , dense_rank() over (partition by MemberProfileID order by tablerank) rnkcode from 
		(
			select MemberProfileID,  InsuranceCarrierID, 1 tablerank, dense_rank() over (partition by MemberProfileID order by MemberInsuranceID desc) rankcode
					from Provider.MemberInsurances
					where 1 = 1
					and isactive = 1
					and insurancecarrierid <> 207
		) a
where rankcode = 1
) b
where rnkcode = 1
Create view bireports.IInsurances as
select InsuranceCarrierID, InsuranceCarrierName
from insurance.insurancecarriers
where isactive = 1


CREATE view bireports.PMemberAppts as
select  mp.NHMemberID, mp.MemberProfileID, AppointmentTypeName, ma.AppointmentStatus, 
--cast(dateadd(hour, -4, ma.createdate) as date) CreateDate, 
CAST(ma.createdate AT TIME ZONE 'UTC'   AT TIME ZONE 'Eastern Standard Time' AS DATE) CreateDate,
cast(ma.StartDate as date) AppointmentDate
From [provider].[MemberAppointments] ma
LEFT OUTER JOIN [provider].[AppointmentTypes] at on (at.AppointmentTypeID = ma.AppointmentTypeID)
LEFT OUTER JOIN [provider].[MemberChartData] mcd on (ma.MemberChartDataID = mcd.MemberChartDataID)
LEFT OUTER JOIN [provider].[MemberCharts] mc on (mc.MemberChartID = mcd.MemberChartID)
LEFT OUTER JOIN provider.MemberProfiles mp on (mp.memberprofileid = mc.memberprofileid)
where 1 = 1
and ma.AppointmentStatus not in ('Cancel','Cancelled')
and ma.isactive = 1
and ma.createuser not in 
(
'RMaram',
'testsatish',
'NHAdmin',
'testramu',
'Sareddy  Raj',
'sleathem',
'LBrown',
'rsareddy',
'sraghavendran',
'testmegha',
'testbhanu'
) 
Create view bireports.HAPMembers as
select Distinct NHMemberID From Provider.MemberInsurances mi
INNER JOIN provider.MemberProfiles mp on (mp.MemberProfileID = mi.MemberProfileID and mp.IsActive = 1)
where InsuranceCarrierID = 212
UNION
select OMDNHMemberID NHMemberID From bireports.POrderInfo
where OMDInsCarrierID = 212


CREATE VIEW [bireports].[PTestingDates] AS
-- Added three JSON_Values ProviderID, LocationID, HCPUserProfileID below HAP on 02/11/2019
SELECT DISTINCT NHMemberID, MemberProfileID, AppointmentTypeName,  AppointmentStatus, IsActive, CreateDate, AppointmentDate, ProviderID, LocationID, HCPUserProfileID, CreateUser, ModifyUser FROM (
SELECT mp.NHMemberID, mp.MemberProfileID, AppointmentTypeName, ma.AppointmentStatus,  ma.isactive IsActive, 
--cast(dateadd(hour, -4, ma.createdate) as date) CreateDate, 
CAST(ma.createdate AT TIME ZONE 'UTC'   AT TIME ZONE 'Eastern Standard Time' AS DATE) CreateDate,
CAST(ma.StartDate AS DATE) AppointmentDate,
 JSON_VALUE(mcd.processData, '$.providerId') ProviderID , 
 JSON_VALUE(mcd.processData, '$.locationId')  LocationID , 
 JSON_VALUE(mcd.processData, '$.HCPUserProfileId') HCPUserProfileID,
 ma.CreateUser, ma.ModifyUser,
DENSE_RANK() OVER (PARTITION BY mp.MemberProfileID, AppointmentTypeName ORDER BY ma.CreateDate DESC) rankcode
FROM [provider].[MemberAppointments] ma
LEFT OUTER JOIN [provider].[AppointmentTypes] at ON (at.AppointmentTypeID = ma.AppointmentTypeID)
LEFT OUTER JOIN [provider].[MemberChartData] mcd ON (ma.MemberChartDataID = mcd.MemberChartDataID)
LEFT OUTER JOIN [provider].[MemberCharts] mc ON (mc.MemberChartID = mcd.MemberChartID)
LEFT OUTER JOIN provider.MemberProfiles mp ON (mp.memberprofileid = mc.memberprofileid)
WHERE 1 = 1
AND ma.AppointmentStatus NOT IN ('Cancel','Cancelled')
AND at.AppointmentTypeName = 'Testing'
AND ma.isactive = 1
AND ma.createuser NOT IN 
(
'RMaram',
'testsatish',
'NHAdmin',
'testramu',
'Sareddy  Raj',
'sleathem',
'LBrown',
'rsareddy',
'sraghavendran',
'testmegha',
'testbhanu'
) ) f
WHERE f.rankcode = 1


CREATE view [bireports].[POrderInfo] as
SELECT 
 o.OrderID
--,MemberChartDataId
,( select MemberChartID from provider.MemberChartData mcd where mcd.MemberChartDataId = o.MemberChartDataId) MemberChartID
,BrandCode
,FamilyCode
,StyleCode
,TechnologyLevelCode
,DeviceCount
,oad.memberResponsibility OrderAmount
,o.NHMemberId
,OrderType
,RefOrderId
,Status
,oi.ItemCode
,IsActive
,cast(DateOrderReceived as date) DateOrderReceived
,case Source when 'CRM' then cast(dateadd(hour, -4, DateOrderInitiated) as date) else DateOrderInitiated end DateOrderInitiated
,md.firstName	FirstName
,md.lastName	LastName
,md.phoneNumber  PhoneNumber
,md.dob  		DOB
,md.address		MemberAddress
,md.city		MemberCity
,md.state		MemberState
,md.zip			MemberZip
,md.insuranceCarrierName	OMDCarrierName
,md.insurancePlanName		OMDPlanName
,md.programName				OMDProgramName
,md.insuranceMemberId		OMDInsuranceNbr
,md.nhMemberId				OMDNHMemberID
,md.insuranceBenefit		OMDInsuranceBenefit
,md.benefitUsed				OMDBenefitUsed
,md.lastBenefitUsedDate		OMDLastBenefitUsedDate
,md.insCarrierId			OMDInsCarrierID
,md.insPlanId				OMDHealthPlanID
,oad.productPrice			OADProductPrice
,oad.insuranceBenefit		OADInsuranceBenefit
,oad.benefitUsed			OADBenefitUsed
,oad.adjustments			OADAdjustments
,oad.benefitAvailable		OADBenefitAvailable
,oad.memberResponsibility	OADMemberResponsibility
,oad.itemcode				OADItemCode
,oad.vsPrice				OADVSPrice
,oad.vsTechLevel			OADVSTechLevel
,ship.providerBusinessName	    SHPProviderBusinessName
,ship.dba					    SHPDBA					
,ship.dispenser				    SHPDispenser				
,ship.address				    SHPAddress				
,ship.address1				    SHPAddress1				
,ship.address2				    SHPAddress2				
,ship.city					    SHPCity					
,ship.state					    SHPState					
,ship.zip					    SHPZip					
,ship.email					    SHPEmail					
,ship.phoneNumber			    SHPPhoneNumber			
,ship.shippingInstructions	    SHPShippingInstructions
,prov.providerLeagalBusinessName    PROVProviderLegalBusinessName
,prov.dba						    PROVDBA						
,prov.dispenser					    PROVDispenser					
,prov.state						    PROVState						
,prov.zip						    PROVZip						
,prov.providerId				    PROVProviderId				
,prov.emailId					    PROVEmailId					
,prov.locationId			        PROVLocationId			
,prov.address				        LocationAddress				
,prov.address1				        LocationAddress1				
,prov.address2				        LocationAddress2				
,prov.city					        LocationCity					
,prov.state					        LocationState					
,prov.zip					        LocationZip					
,prov.HCPFirstName			        HCPFirstName			
,prov.HCPlastName			        HCPLastName			
,prov.HCPnpiNumber			        HCPNPINumber			
,prov.HCPphoneNumber		        HCPPhoneNumber		
,prov.HCPId					        HCPId					
,prov.HCPFaxNumber			        HCPFaxNumber	
--,case when o.leftearorderdata = '{}' then 'RT' when o.rightearorderdata = '{}' then 'LT' else '' end Modifier
From orders.orders o
--outer apply openjson(case when ISJSON(o.MemberData) = 1 then o.MemberData 
--						  else '{}' end) 
outer apply openjson(case when ISJSON(o.MemberData) = 1 then (case when JSON_VALUE(MemberData,'$.insurance.benefitUsed')='' then JSON_MODIFY(MemberData,'$.insurance.benefitUsed',0) else MemberData end)
						  else '{}' end) 
with (
		 firstName varchar(50)
		,lastName varchar(50)
		,phoneNumber varchar(20)
		,dob varchar(20)
		,address		varchar(200)	'$.address.address'
		,city		varchar(100)	'$.address.city'
		,state		varchar(100)	'$.address.state'
		,zip			varchar(20)		'$.address.zip'
		,insuranceCarrierName	varchar(300)	'$.insurance.carrierName'
		,insurancePlanName		varchar(300)	'$.insurance.planName'
		,programName			varchar(300)	'$.insurance.programeName'
		,insuranceMemberId		varchar(30)		'$.insurance.insuranceMemberId'
		,nhMemberId				varchar(20)		'$.insurance.nhMemberId'
		,insuranceBenefit		int				'$.insurance.insuranceBenefit'
		,benefitUsed			decimal			    '$.insurance.benefitUsed'
		,lastBenefitUsedDate	varchar(300)	'$.insurance.lastBenefitUsedDate'
		,insCarrierId			int
		,insPlanId				int
	) as md
outer apply openjson(o.OrderAmountData) with (
		productPrice			decimal
		,insuranceBenefit		decimal
		,benefitUsed			decimal
		,adjustments			decimal
		,benefitAvailable		decimal
		,memberResponsibility	decimal
		,itemcode				varchar(150)
		,vsPrice				varchar(20)
		,vsTechLevel			varchar(50)
	) as oad
outer apply openjson(o.ShippingData) with (
		providerBusinessName	varchar(200)
		,dba					varchar(200)
		,dispenser				varchar(50)
		,address				varchar(200) '$.address.address'
		,address1				varchar(200) '$.address.address1'
		,address2				varchar(50) '$.address.address2'
		,city					varchar(100) '$.address.city'
		,state					varchar(10)	'$.address.state'
		,zip					varchar(10) '$.address.zip'
		,email					varchar(100)
		,phoneNumber			varchar(15)
		,shippingInstructions	varchar(400)
	) as ship
outer apply openjson(case when o.ProviderData = '' then '{}' else o.ProviderData end) with (
		providerLeagalBusinessName		varchar(200)
		,dba							varchar(200)
		,dispenser						varchar(50)
		,state							varchar(2)		'$.address.state'
		,zip							varchar(10)		'$.address.zip'
		,providerId						bigint
		,emailId				varchar(100)
		,locationId				int '$.address.locationId'
		,address				varchar(200) '$.address.address'
		,address1				varchar(200) '$.address.address1'
		,address2				varchar(50) '$.address.address2'
		,city					varchar(100) '$.address.city'
		,state					varchar(10)	'$.address.state'
		,zip					varchar(10) '$.address.zip'
		,HCPFirstName			varchar(50) '$.hcp.firstName'
		,HCPlastName			varchar(50) '$.hcp.lastName'
		,HCPnpiNumber			varchar(50) '$.hcp.npiNumber'
		,HCPphoneNumber			varchar(50) '$.hcp.phoneNumber'
		,HCPId			varchar(50) '$.hcp.hcpId'
		,HCPFaxNumber			varchar(50) '$.hcp.faxNumber'
	) as prov
INNER JOIN 
(
		SELECT DISTINCT orderid, BrandCode, FamilyCode, StyleCode, TechnologyLevelCode, ProductModelCode, ItemCode
		FROM orders.OrderItems
		WHERE 1 = 1
		AND ItemType IN ('HA') 
		AND IsActive = 1
		) oi ON (oi.orderid = o.orderid)
INNER JOIN 
(
		SELECT orderid, SUM(Quantity) DeviceCount
		FROM orders.OrderItems
		WHERE 1 = 1
		AND ItemType IN ('HA','CROS') 
		AND IsActive = 1
		--AND Status = 'ACTIVE'
		GROUP BY ORDERID
		) oq ON (oq.orderid = o.orderid)
Where O.IsActive = 1 
CREATE view bireports.PClaimInfo as
SELECT Distinct otd.ORDERID
,clm.TestingCopay
,clm.HACopay 
,clm.FittingCopay 
,hthcpcscode.value as TestHCPCS
,hahcpcscode.value as HAHCPCS
,hfhcpcscode.value as FittingHCPCS
,clm.ICD10Code	
,case CONVERT(varchar(10),clm.FittingDate,101) when '01/01/0001' then '' when null then '' else  CONVERT(varchar(10),clm.FittingDate,101) end FittingDate
,case CONVERT(varchar(10),clm.PurchaseDate,101) when '01/01/0001' then '' when null then '' else  CONVERT(varchar(10),clm.PurchaseDate,101) end PurchaseDate
,clm.ClaimSubmittedBy
,clm.ClaimSubmitDate	
,clm.IsClaimSubmitted	
--,case clm.ClaimAmount  when null then 0 else clm.ClaimAmount end ClaimAmount
,case isnull(clm.ClaimAmount,'')  when '' then 0 else cast(clm.claimAmount as decimal(20,2)) end ClaimAmount
,case clm.BenefitAmount  when null then 0 else clm.BenefitAmount end BenefitAmount
,clm.IsComplete	
,clm.DeliveryReceipt 
,clm.DeliveryDate
,clm.PurchaseAgmtChk
       --     JSON_VALUE([OrderTransactionData],'$.purchaseAgreementReceived') as [PurchaseAgreementRcvd],
FROM 
	[Orders].[OrderTransactionDetails] otd
cross apply openjson(otd.OrderTransactionData) with (
	 TestingCopay decimal '$.copayDues.htCopayDue'
	,HACopay decimal '$.copayDues.haCopayDue'
	,FittingCopay decimal '$.copayDues.hfCopayDue'
	,hcpcs nvarchar(max) as json 
	,ICD10Code	varchar(20) '$.hcpcs.icd10Codes'
	,FittingDate varchar(15) '$.fittingDate'
	,PurchaseDate	varchar(20) '$.purchaseDate'
	,ClaimSubmittedBy	varchar(20) '$.claimSubmittedBy'
	,ClaimSubmitDate	varchar(20) '$.claimSubmitDate'
	,IsClaimSubmitted	varchar(20) '$.isClaimSubmitted'
	,ClaimAmount varchar(20) '$.claimAmount'
	,BenefitAmount	int '$.benefitAmount'
	,IsComplete	varchar(20) '$.isComplete'
	,DeliveryReceipt	varchar(20) '$.deliveryReceipt'
	,DeliveryDate	varchar(20) '$.deliveryDate'
	,PurchaseAgmtChk	varchar(20) '$.purchaseAgreementChecked'
	) as clm
outer apply openjson(clm.hcpcs) with (
	haHCPCS nvarchar(max) as json,
	htHCPCS nvarchar(max) as json,
	hfHCPCS nvarchar(max) as json
) as hcpcscodes
outer apply openjson(hcpcscodes.haHCPCS) as hahcpcscode
outer apply openjson(hcpcscodes.htHCPCS) as hthcpcscode
outer apply openjson(hcpcscodes.hfHCPCS) as hfhcpcscode 
where 1 = 1
and otd.OrderStatusCode='CLM' 
and IsActive=1

CREATE view bireports.HCPs as
select 
 HCPId HCPID
,case IsActive when 1 then 'Active' else 'InActive'  end HCPStatus
,TermDate TerminationDate
,ReasonForTermination
,Classification
,case Gender when 'M' then 'Male' when 'F' then 'Female' else 'Not Specified' end Gender
,FirstName
,LastName
,NPINumber
,SSN
,DOB
,MedicaidID
,MedicareID
,PediatricServices
,BoardCertification
,BoardCertificationDate
,case CredentialDate when 'In Progress' then '' else CredentialDate end CredentialDate
,case isnull(CredentialDate,'')  when 'In Progress' then 'In Progress' when '' then 'No' else 'Credentialed' end CredentialedStatus
from dbo.ProviderDataHCPs
where  isnull(hcpid,'') <> ''

Create view bireports.HCPLicense as
select 
 HCPId HCPID
,LicenseNumber1 LicenseNumber
,LicenseState1 LicenseState
from dbo.ProviderDataHCPs
where isnull(LicenseNumber1,'') <> ''
and isnull(hcpid,'') <> ''
UNION
select 
 HCPId HCPID
,LicenseNumber2 LicenseNumber
,LicenseState2 LicenseState
from dbo.ProviderDataHCPs
where isnull(LicenseNumber2,'') <> ''
and isnull(hcpid,'') <> ''
UNION
select 
 HCPId HCPID
,LicenseNumber3 LicenseNumber
,LicenseState3 LicenseState
from dbo.ProviderDataHCPs
where isnull(LicenseNumber3,'') <> ''
and isnull(hcpid,'') <> ''



CREATE VIEW bireports.MarketShareProvider
AS


       select [providerName] [PROVIDER],[PROVIDERID],[LOCATIONID],LocationName
       ,ISNULL([GNR],0) GNR,ISNULL([BELTONE],0) BELTONE,ISNULL([STARKEY],0) STARKEY,ISNULL([PHONAK],0) PHONAK
       ,ISNULL([SIGNIA],0) SIGNIA,ISNULL([WIDEX],0) WIDEX,ISNULL([UNITRON],0) UNITRON,ISNULL([OTICON],0) OTICON
       from (select providerName,[PROVIDERID],[LOCATIONID],LocationName, brandcode, sum(QUANTITY) as 'cnt' 
       FROM(
SELECT        O.ORDERID, O.NHMEMBERID, OI.BRANDCODE, OI.TECHNOLOGYLEVELCODE, UPPER(P.FAMILYPRODUCTCATCODE) CATEGORY, OI.QUANTITY
       ,CAST(O.DATEORDERRECEIVED AS DATE) ORDERRECEIVEDDATE, CAST(O.DATEORDERINITIATED AS DATE) ORDERINITIATEDDATE,JSON_VALUE(OT.ORDERTRANSACTIONDATA,'$.poDate') ORDERAPPROVEDDATE
         ,UPPER(Pp.ProviderName) ProviderName, JSON_VALUE(O.PROVIDERDATA, '$.providerId') providerId
         , JSON_VALUE(O.PROVIDERDATA, '$.address.locationId') locationId, UPPER(l.businessname)  LocationName
		 --JSON_VALUE(O.SHIPPINGDATA, '$.providerBusinessName') LocationName
FROM  ORDERS.ORDERS O
INNER JOIN ORDERS.ORDERITEMS OI ON        O.ORDERID = OI.ORDERID
INNER JOIN ORDERS.ORDERTRANSACTIONDETAILS OT ON        O.ORDERID = OT.ORDERID
LEFT JOIN 
       (
             SELECT X.* FROM 
             (
                    SELECT FAMILYPRODUCTCATCODE, FAMILYPRODUCTCODE,ROW_NUMBER() OVER(PARTITION BY FAMILYPRODUCTCODE ORDER BY CONTRACTPRODUCTID DESC) RN
                    FROM INSURANCE.CONTRACTPRODUCTS
             )X  WHERE X.RN = 1
       ) P    ON OI.TECHNOLOGYLEVELCODE = P.FAMILYPRODUCTCODE
LEFT JOIN provider.ProviderProfiles pp ON pp.providerId = JSON_VALUE(O.PROVIDERDATA, '$.providerId')
LEFT JOIN provider.locations l ON l.locationid = JSON_VALUE(O.PROVIDERDATA, '$.address.locationId')
WHERE O.MEMBERDATA <>'' AND OT.ORDERSTATUSCODE = 'PO' AND OT.ISCOMPLETE = 1
and O.ordertype = 'NEW'
and O.status = 'ACTIVE'
and  DATEPART(wk, ISNULL(json_value(OrdertransactionData, '$.poDate'),json_value(OrdertransactionData, '$[0].poDate')))  = DATEPART(wk, DATEADD(wk,-1,getdate()))
	   and Year(ISNULL(json_value(OrdertransactionData, '$.poDate'),json_value(OrdertransactionData, '$[0].poDate'))) = Year(getdate())
) t
  group by providerName,[PROVIDERID],[LOCATIONID],LocationName, brandcode ) a
       pivot
       (   sum(cnt)
           for brandcode in ([GNR],[BELTONE],[STARKEY],[PHONAK],[SIGNIA],[WIDEX],[UNITRON],[OTICON])
       ) as P
       --order by 
       --[PROVIDER],[PROVIDERID],[LOCATIONID],LocationName

CREATE view [bireports].[DispositionEvents] as
select EventID, right('00'+ cast(Row# as varchar),2 ) +' '+  EventName EventName from (
select ROW_NUMBER() OVER(ORDER BY EventID ASC) AS Row# , EventID, EventName from jobs.events
where 1 = 1
and IsActive = 1
and EventTriggerBy = 'DISPOSITION'
and isnull(ParentEventId,'') = ''
and EventId not in (46,232)
) a

CREATE VIEW bireports.MarketShareInsurance
AS

select [carriername] CARRIER,
       ISNULL([GNR],0) GNR,ISNULL([BELTONE],0) BELTONE,ISNULL([STARKEY],0) STARKEY,ISNULL([PHONAK],0) PHONAK
       ,ISNULL([SIGNIA],0) SIGNIA,ISNULL([WIDEX],0) WIDEX,ISNULL([UNITRON],0) UNITRON,ISNULL([OTICON],0) OTICON
       from (select carriername, brandcode, sum(devicecount) as 'cnt' 
       FROM(
SELECT 
       O.ORDERID, O.NHMEMBERID, OI.BRANDCODE, OI.TECHNOLOGYLEVELCODE, UPPER(P.FAMILYPRODUCTCATCODE) CATEGORY, OI.QUANTITY DEVICECOUNT
       ,CAST(O.DATEORDERRECEIVED AS DATE) ORDERRECEIVEDDATE, CAST(O.DATEORDERINITIATED AS DATE) ORDERINITIATEDDATE,JSON_VALUE(OT.ORDERTRANSACTIONDATA,'$.poDate') ORDERAPPROVEDDATE
       ,   IC.INSURANCECARRIERNAME CARRIERNAME
FROM  ORDERS.ORDERS O
INNER JOIN ORDERS.ORDERITEMS OI ON OI.OrderID = O.OrderID
INNER JOIN INSURANCE.INSURANCECARRIERS IC ON IC.INSURANCECARRIERID = JSON_VALUE(O.MEMBERDATA, '$.insCarrierId')
INNER JOIN ORDERS.ORDERTRANSACTIONDETAILS OT ON        O.ORDERID = OT.ORDERID
LEFT JOIN 
       (SELECT X.* FROM 
             (
                    SELECT FAMILYPRODUCTCATCODE, FAMILYPRODUCTCODE,ROW_NUMBER() OVER(PARTITION BY FAMILYPRODUCTCODE ORDER BY CONTRACTPRODUCTID DESC) RN
                    FROM INSURANCE.CONTRACTPRODUCTS
             )X  WHERE X.RN = 1
       ) P ON OI.TECHNOLOGYLEVELCODE = P.FAMILYPRODUCTCODE
WHERE O.MEMBERDATA <>'' AND OT.ORDERSTATUSCODE = 'PO' AND OT.ISCOMPLETE = 1
and O.ordertype = 'NEW'
and O.status = 'ACTIVE'
and  DATEPART(wk, ISNULL(json_value(OrdertransactionData, '$.poDate'),json_value(OrdertransactionData, '$[0].poDate')))  = DATEPART(wk, DATEADD(wk,-1,getdate()))
	   and Year(ISNULL(json_value(OrdertransactionData, '$.poDate'),json_value(OrdertransactionData, '$[0].poDate'))) = Year(getdate())

) t
  group by carriername, brandcode ) a
       pivot
       (   sum(cnt)
           for brandcode in ([GNR],[BELTONE],[STARKEY],[PHONAK],[SIGNIA],[WIDEX],[UNITRON],[OTICON])
       ) as P
	   


CREATE view [bireports].[DTC1Testings] as
select  NHMemberID, MemberAppointmentID, MemberProfileID, MemberChartId, MemberChartDataID, AppointmentTypeName,  AppointmentStatus, CreateDate, AppointmentDate, ProviderID, LocationID, HCPUserProfileID ,--FutureAppts,
CancelReason,AppointmentConfirmation--TestScheduled,TestCompleted,TestCancelled
from (
select ma.MemberAppointmentID  ,mp.NHMemberID, mp.MemberProfileID, mc.MemberChartID, mcd.MemberChartDataID,  'Testing' AppointmentTypeName, ma.AppointmentStatus, 
CAST(ma.createdate AT TIME ZONE 'UTC'   AT TIME ZONE 'Eastern Standard Time' AS DATE) CreateDate,
cast(ma.StartDate as date) AppointmentDate,
 JSON_VALUE(mcd.processData, '$.providerId') ProviderID , 
 JSON_VALUE(mcd.processData, '$.locationId')  LocationID , 
 JSON_VALUE(mcd.processData, '$.HCPUserProfileId') HCPUserProfileID,
 upper(ma.CancelReason) CancelReason
 ,case when Confirmed=0 then 'NotConfirmed' else 'Confirmed' end AppointmentConfirmation
-- case when ma.startdate > getdate() then mp.NHMemberID end FutureAppts,
--	mp.NHMemberId TestScheduled,
--case when ma.AppointmentStatus = 'Complete' then mp.NHMemberId end TestCompleted,
--case when ma.AppointmentStatus = 'Cancel' then mp.NHMemberId end TestCancelled
From provider.MemberAppointments ma
LEFT OUTER JOIN provider.MemberChartData mcd on (ma.MemberChartDataID = mcd.MemberChartDataID)
LEFT OUTER JOIN provider.MemberCharts mc on (mc.MemberChartID = mcd.MemberChartID)
LEFT OUTER JOIN provider.MemberProfiles mp on (mp.memberprofileid = mc.memberprofileid)
INNER JOIN bireports.DTCMembers dm on (dm.NHMemberID = mp.NHMemberId)
where 1 = 1
and ma.AppointmentTypeId = 1 -- Testing Appointment Only
--and ma.isactive = 1 --Removed because of Cancelled is made inactive
and ma.createuser not in 
(
'RMaram',
'testsatish',
'NHAdmin',
'testramu',
'Sareddy  Raj',
'sleathem',
'LBrown',
'rsareddy',
'sraghavendran',
'testmegha',
'testbhanu'
) ) f
create view bireports.PMemberAddress as
select MemberProfileid, State, ZipCode
from (
select MemberProfileid, State, ZipCode, dense_rank() over (partition by MemberProfileid order by MemberLocationId) rankcode
from provider.memberlocations ml
where 1 = 1
and ml.isactive = 1
) a
where rankcode = 1


create view bireports.DTC1TestingStatus as
select 'Hearing Tests Scheduled' TestingStatus, 'Cancel' AppointmentStatus
Union
select 'Hearing Tests Scheduled', 'CheckedIn' AppointmentStatus
Union
select 'Hearing Tests Scheduled', 'Complete' AppointmentStatus
Union
select 'Hearing Tests Scheduled', 'Scheduled' AppointmentStatus
Union
select 'Hearing Tests Completed', 'Complete' AppointmentStatus
Union
select 'Hearing Tests Cancelled', 'Cancel' AppointmentStatus
CREATE view bireports.MMemberAddress as
select MemberID, State MasterState, ZipCode MasterZipcode, NHmemberID, FirstName, LastName, MiddleInitial, DOB
from (
select ma.MemberID, State, Zipcode, dense_rank() over (partition by ma.memberid order by addresstypecode desc, ID desc) rankcode, mm.NHmemberID, mm.FirstName, mm.LastName, mm.middleInitial, cast(DateOfBirth as date) DOB
from master.addresses ma
INNER JOIN master.members mm on (mm.memberid = ma.memberid)
and exists (select 1 from provider.memberprofiles mp where mp.nhmemberid = mm.nhmemberid)
) a where rankcode = 1
CREATE view [bireports].[DTC1FutureTestings] as
select * from bireports.DTC1Testings
where 1 = 1
and AppointmentDate > CAST(getdate() AT TIME ZONE 'UTC'   AT TIME ZONE 'Eastern Standard Time' AS DATE)
and AppointmentStatus = 'Scheduled'

CREATE view [bireports].[PPOInfo] as
select 
 otd.OrderID
,otd.IsComplete
,otd.IsActive
,p.poDate PODate
,p.poSentDate POSentDate
,max(p.poNumber) PONumber
from orders.OrderTransactionDetails otd 
outer apply OPENJSON(otd.OrderTransactionData) 
      WITH (
		poDate date,
		poSentDate date,
		poNumber varchar(20)
	  ) as p
where 1 = 1
and otd.OrderStatusCode = 'PO' 
and otd.isactive = 1
group  by otd.OrderID
,otd.IsComplete
,otd.IsActive
,p.poDate 
,p.poSentDate 
Create view bireports.POrderApprovalInfo as
select 
 otd.OrderID
,otd.IsComplete
,otd.IsActive
,p.approvedDate OrderApprovedDate
,p.approvedBy OrderApprovedBy
from orders.OrderTransactionDetails otd 
outer apply OPENJSON(otd.OrderTransactionData) 
      WITH (
		approvedBy varchar(50),
		approvedDate date
	  ) as p
where 1 = 1
and otd.OrderStatusCode = 'APP' 
and otd.isactive = 1

Create view bireports.POrderDocInfo as
select 
 otd.OrderID
,otd.IsComplete
,otd.IsActive
,p.hipaa OrderApprovedDate
,p.hipaaReceivedDate OrderApprovedBy
,p.aob AOB
,p.aobReceivedDate AOBRecvdDate
,p.audiogram Audiogram
,p.audiogramReceivedDate AudiogramRecvdDate
,p.nhMemberId NHMemberID
from orders.OrderTransactionDetails otd 
outer apply OPENJSON(otd.OrderTransactionData) 
      WITH (
		hipaa varchar(10),
		hipaaReceivedDate date,
		aob varchar(10),
		aobReceivedDate date,
		audiogram varchar(10),
		audiogramReceivedDate date,
		nhMemberId varchar(30)
	  ) as p
where 1 = 1
and otd.OrderStatusCode = 'DOC' 
and otd.isactive = 1
CREATE view [bireports].[POrderInitateInfo] as
select 
 otd.OrderID
,otd.IsComplete
,otd.IsActive
,cast(p.orderDate as date) OrderDate
from orders.OrderTransactionDetails otd 
outer apply OPENJSON(otd.OrderTransactionData) 
      WITH (
		orderDate datetime
	  ) as p
where 1 = 1
and otd.OrderStatusCode = 'INI' 
and otd.isactive = 1
and not exists (select 1 from orders.orders o where otd.orderid = o.orderid and o.ordertype = 'OTC' )

CREATE view bireports.IProductPricing as  
  SELECT DISTINCT
  hpc.InsuranceHealthPlanID InsPlanId,
  hpc.HealthPlanContractId,
  cp.FAMILYPRODUCTCATCODE,
  cp.FAMILYPRODUCTCODE TECHNOLOGYLEVELCODE, 
--  case cp.FAMILYPRODUCTCODE
--  when 'HA JAM HD3' then 0
--  when 'HA JAM HD3' then 0
--when 'PH PHONAK CROS' then 0
--when 'PH PHONAK CROS 13' then 0
--when 'PH PHONAK CROS H2O' then 0
--when 'ST SOUNDLENS 1600' then 0
--when 'ST SOUNDLENS 2000' then 0
--when 'ST SOUNDLENS 2400' then 0
--when 'ST Z SERIES I20' then 0
--when 'ST Z SERIES I30' then 0 else cp.PerDeviceCOGSPrice end PerDeviceCOGS,
  0 PerDeviceCOGS,
 0 PerDeviceDispensingFee, --cp.PerDeviceDispensingFee,
 0 PerDeviceMemberPrice --cp.PerDeviceMemberPrice
FROM insurance.healthplancontracts hpc
LEFT OUTER JOIN INSURANCE.CONTRACTPRODUCTS cp
  ON (cp.HealthPlanContractId = hpc.HealthPlanContractId)
  where cp.FAMILYPRODUCTCODE <> 'PH NAIDA B70 D R'
  and cp.FAMILYPRODUCTCATCODE <> 'Premium'
CREATE view bireports.PPaymentInfo as
select 
 otd.OrderID
,otd.OrderStatusCode
,otd.IsComplete
,p.paymentDate PaymentDate
,case p.paymentType when 'Finance' then 'FIN' when 'Financing' then 'FIN' else p.paymentType end  PaymentType
,p.amountPaid AmountPaid
,p.cardOrBank CardorBank
,p.transactionStatus TransactionStatus
,f.name AccountName
--,f.approvedAmount ApprovedAmount
--,f.financeCompany FinanceCompany
,tm.totalAmount TotalAmount
from orders.OrderTransactionDetails otd 
outer apply OPENJSON(otd.OrderTransactionData) 
      WITH (
		totalAmount decimal
	  ) as tm
outer apply OPENJSON(OrderTransactionData, '$.transactions') 
      WITH (
	         paymentDate date,
	         paymentType nvarchar(20),
			 amountPaid decimal,
			 cardOrBank nvarchar(20),
			 transactionStatus bit,
			 totalAmount bit,
			 formInputDetails nvarchar(max) as JSON
	       ) as p
outer apply OPENJSON(p.formInputDetails, '$')
      WITH(
	        name nvarchar(30)--,
			--financeCompany nvarchar(30),
			--approvedAmount int
		  ) as f
where 1 = 1
and otd.OrderStatusCode = 'PAY' 
and ISJSON(otd.OrderTransactionData) > 0
and otd.isactive = 1
and p.amountPaid > 0 
create view bireports.IHealthPlans as
select InsuranceHealthPlanID, HealthPlanName, InsuranceCarrierID
from insurance.insuranceHealthPlans inh
where exists (select 1 from insurance.insurancecarriers ic where ic.InsuranceCarrierID = inh.InsuranceCarrierID and ic.isactive = 1)

 CREATE VIEW bireports.DTCLeadMemberEmails AS
select distinct o.nhmemberid, 
m.FirstName, m.LastName,e.EmailAddress, LastContactDate, EventName
From bireports.DTCMembersLastCallInfo o
inner  join master.members m on m.nhmemberid = o.nhmemberid
inner join [Master].[Emails] e on (e.memberid = m.memberid and e.emailaddress is not null)
inner join bireports.DispositionEvents d on d.eventid = o.eventid
where not exists 
( 
	select 1 from callcenter.callconversations c 
	where c.membernhmemberid = o.nhmemberid 
	and CallEndSummary like '%$100 off any hearing aid purchase in the next 15 days%'
)
and Eventname in('11 Closed Lead - Do not call','01 Lead')
CREATE View bireports.DTCMembersLastCallInfo as
  select NHMemberID ,AgentUserProfileName LastAgent, cast(HTDispositionCreateDate as date) LastContactDate, ParentEventID EventID , ReasonID From 
                                  (
                                  select cc.MemberNHMemberId NHMemberID, AgentUserProfileName,  cc.createDate HTDispositionCreateDate,  dispevents.ParentEventID, cpe.EventID ReasonID,
                                  dense_rank() over (partition by nhmemberid order by cc.createDate desc ) rank_code
                                  from callcenter.callpageevents cpe
                                  INNER JOIN CallCenter.CallConversations cc on (cc.CallConversationId =  cpe.CallConversationId )
                                  INNER JOIN bireports.DTCMembers m on (m.NHMemberID = cc.MemberNHMemberId) -- All DTC Members
								  INNER JOIN  ( -- All Disposition Events except Maintenace and Complaint
													select EventId, ParentEventId From jobs.events
														where 1 = 1
														and IsActive = 1
														and EventTriggerBy = 'DISPOSITION'
														and isnull(ParentEventId,'') <> ''
														and EventId not in -- Exclude all events who are Maintenance and Complaint
															(select EventId from jobs.events where isnull(ParentEventId,'')  in (46,232))
														UNION 
														select EventId, EventId ParentEventId  From jobs.events
														where 1 = 1
														and IsActive = 1
														and EventTriggerBy = 'DISPOSITION'
														and isnull(ParentEventId,'') = ''
														and EventId not in (46,232)
												) dispevents on (cpe.EventId = dispevents.EventId )
                                         ) f
                                  where 1 = 1
                                  and rank_code = 1


CREATE view [bireports].[DTC1SummaryData] as

	select 'Total Qualified Leads' ReportDescription, NHMemberID,'' OrderID,'' MemberAppointmentID ,''modifier, ''quantity
	 from bireports.DTCMembers

UNION

		select distinct 'Members with Hearing Tests' ReportDescription, NHMemberID ,'' OrderID ,'' MemberAppointmentID ,''modifier, ''quantity
		 from bireports.DTC1Testings

UNION
		
		select  distinct 'Hearing Tests Completed' ReportDescription, NHMemberID,'' OrderID ,'' MemberAppointmentID ,''modifier, ''quantity
	    from bireports.DTC1Testings t where AppointmentStatus = 'Complete'
		and not exists 
		(
				select 1 from bireports.DTC1Testings t1
				where AppointmentStatus = 'Scheduled'
				and t1.nhmemberid = t.nhmemberid
		)

UNION

		select distinct 'Hearing Tests Cancelled' ReportDescription, NHMemberID,'' OrderID  ,'' MemberAppointmentID  ,''modifier, ''quantity
		from bireports.DTC1Testings a
		where AppointmentStatus = 'Cancel'
		and not exists(
				select 1 from bireports.DTC1Testings b
				where a.NHMemberID=b.NHMemberID
				and b.AppointmentStatus<>'Cancel' 
		)

UNION
		select  distinct 'Past Tests in Scheduled Status' ReportDescription, NHMemberID,'' OrderID ,'' MemberAppointmentID ,''modifier, ''quantity
	    from bireports.DTC1Testings t 
		where AppointmentStatus = 'Scheduled'
		and appointmentdate <  CAST(getdate() AT TIME ZONE 'UTC'   AT TIME ZONE 'Eastern Standard Time' AS DATE)	

UNION

		select distinct 'Hearing Tests Future Preview' ReportDescription , NHMemberID,'' OrderID,'' MemberAppointmentID   ,''modifier, ''quantity
		from bireports.DTC1Testings 
		where AppointmentDate > CAST(getdate() AT TIME ZONE 'UTC'   AT TIME ZONE 'Eastern Standard Time' AS DATE)

UNION

		select distinct 'Members Sold' ReportDescription, o.NHMemberID,'' OrderID,'' MemberAppointmentID ,''modifier, ''quantity
		from  orders.orders o
		inner join bireports.DTCMembers m on o.NHMemberId= m.NHMemberID
			where o.OrderType in  ('NEW','EXCHANGE')
				and JSON_VALUE(o.memberdata,'$.insCarrierId') = 229
				and  exists
				(
					select 1 from orders.OrderTransactionDetails ot 
					where o.OrderID=ot.OrderID
					and OrderStatusCode='PO'
				)
UNION

	select distinct 'Members with Active Orders' ReportDescription, o.NHMemberID,'' OrderID,'' MemberAppointmentID ,''modifier, ''quantity
	from  orders.orders o
	inner join bireports.DTCMembers m on o.NHMemberId= m.NHMemberID
		where o.OrderType in  ('NEW','EXCHANGE')
			and o.Status = 'ACTIVE'
			and JSON_VALUE(o.memberdata,'$.insCarrierId') = 229
			and  exists
			(
				select 1 from orders.OrderTransactionDetails ot 
				where o.OrderID=ot.OrderID
				and OrderStatusCode='PO'
			)

UNION

	select distinct 'Members Returned' ReportDescription, o.NHMemberID,'' OrderID,'' MemberAppointmentID ,''modifier, ''quantity
	from  orders.orders o
	inner join bireports.DTCMembers m on o.NHMemberId= m.NHMemberID
		where o.OrderType in  ('NEW','EXCHANGE')
			and o.Status = 'RETURNED'
			and JSON_VALUE(o.memberdata,'$.insCarrierId') = 229
			and  exists
			(
				select 1 from orders.OrderTransactionDetails ot 
				where o.OrderID=ot.OrderID
				and OrderStatusCode='PO'
			)
			and not exists	
			(
					select 1 from (
						select  o1.NHMemberID
								from  orders.orders o1
								inner join bireports.DTCMembers m1 on o1.NHMemberId= m1.NHMemberID
									where o1.OrderType in  ('NEW','EXCHANGE')
										and o1.Status = 'ACTIVE'
										and JSON_VALUE(o1.memberdata,'$.insCarrierId') = 229
										and  exists
										(
											select 1 from orders.OrderTransactionDetails ot1 
											where o1.OrderID=ot1.OrderID
											and ot1.OrderStatusCode='PO'
										)
					)J where j.nhmemberid = o.nhmemberid
			)

UNION
	
			select distinct 'Total Units Sold' ReportDescription,  o.nhmemberid, o.orderid , '' MemberAppointmentID ,oi.modifier, oi.quantity
			from  orders.orders o
			inner join orders.orderitems oi on o.orderid = oi.orderid
			inner join bireports.DTCMembers m on o.NHMemberId= m.NHMemberID
				where  oi.itemtype in('HA','CROS')
					and o.OrderType in ('NEW', 'EXCHANGE')
					and JSON_VALUE(o.memberdata,'$.insCarrierId') = 229
					and  exists
					(
						select 1 from orders.OrderTransactionDetails ot 
						where o.OrderID=ot.OrderID
						and OrderStatusCode='PO'
					)

UNION

			select 'Active Units Sold' ReportDescription,  o.nhmemberid, o.orderid , '' MemberAppointmentID ,oi.modifier, oi.quantity
			from  orders.orders o
			inner join orders.orderitems oi on o.orderid = oi.orderid
			inner join bireports.DTCMembers m on o.NHMemberId= m.NHMemberID
				where oi.status='ACTIVE'
					and  oi.itemtype in('HA','CROS')
					and o.OrderType in ('NEW', 'EXCHANGE')
					and o.status='ACTIVE' 
					and JSON_VALUE(o.memberdata,'$.insCarrierId') = 229
					and  exists
					(
						select 1 from orders.OrderTransactionDetails ot 
						where o.OrderID=ot.OrderID
						and OrderStatusCode='PO'
					)

UNION
		select 'Units Returned' ReportDescription,  nhmemberid,'' orderid , '' MemberAppointmentID ,modifier, quantity
		from (
				select distinct o.nhmemberid ,oi.modifier, oi.quantity
				from  orders.orders o
				inner join orders.orderitems oi on o.orderid = oi.orderid
				inner join bireports.DTCMembers m on o.NHMemberId= m.NHMemberID
				where oi.status='RETURNED' and  oi.itemtype in('HA','CROS')
				except
					select distinct o.nhmemberid ,oi.modifier, oi.quantity
					from  orders.orders o
					inner join orders.orderitems oi on o.orderid = oi.orderid
					where oi.status='ACTIVE' and  oi.itemtype in('HA','CROS')
			)i
			
UNION

			select 'Pending Orders' ReportDescription,o.NHMemberID, o.OrderID , '' MemberAppointmentID ,''modifier, ''quantity
			from orders.orders o
			inner join bireports.DTCMembers m on o.NHMemberId= m.NHMemberID
				where o.Status not in ('Cancelled')
					and o.OrderType in  ('NEW','EXCHANGE')
					and JSON_VALUE(o.memberdata,'$.insCarrierId') = 229
					and not exists
					(
							select 1 from orders.OrderTransactionDetails ot 
							where o.OrderID=ot.OrderID
							and OrderStatusCode='PO'
					)

UNION

			select distinct 'Tests Completed-Did not buy' ReportDescription, NHMemberID,'' OrderID ,'' MemberAppointmentID ,''modifier, ''quantity
			from bireports.DTC1Testings where AppointmentStatus = 'Complete'
			except
				select distinct 'Tests Completed-Did not buy' ReportDescription, o.NHMemberID,'' OrderID,'' MemberAppointmentID ,''modifier, ''quantity
				from  orders.orders o
				inner join bireports.DTCMembers m on o.NHMemberId= m.NHMemberID
					where o.OrderType in  ('NEW','EXCHANGE')
						and JSON_VALUE(o.memberdata,'$.insCarrierId') = 229
						and  exists
						(
							select 1 from orders.OrderTransactionDetails ot 
							where o.OrderID=ot.OrderID
							and OrderStatusCode='PO'
						)



UNION

			select 'Closed Leads' ReportDescription, nhmemberid,'' OrderID,'' MemberAppointmentID,''modifier, ''quantity
			from [bireports].[DTCMembersLastCallInfo] c
			inner join [bireports].[DispositionEvents] d on c.EventID=d.EventID
			where c.Eventid=231




--select * from dbo.ProviderDataProviders

CREATE VIEW bireports.PRProviders
AS
select 
ProviderId
,TaxId
,LegalBusinessName
,case IsActive when 1 then 'Active' else 'InActive'  end ProviderStatus
,Brands
,InitialContract
,ContractType
,ContractTermination
,ReasonForTermination
,PrimaryEmailAddress
,BillingAddress
,BillingCity
,BillingState
,BillingZip
,BillingCounty
,BillingCountyCode
,BillingPhoneNumber
,OwnerLastName
,OwnerFirstName
,ShippingAddress
,ShippingAddress2
,ShippingCity
,ShippingState
,ShippingZip
from dbo.ProviderDataProviders



CREATE view [bireports].[PRLocationLanguages] as
select
ProviderId
,LocationId
,'P'+ProviderId+'L'+LocationId PLKey
,TRIM(Value) Languages
From dbo.ProviderDataLocations
CROSS APPLY STRING_SPLIT(Languages, ',')
where isnull(languages,'') not in ('N/A','')
CREATE  VIEW [bireports].[PRLocations] AS
select 
pl.LocationId
,ProviderId
,'P'+ProviderId+'L'+pl.LocationId PLKey
,case pl.IsActive when 1 then 'Active' else 'InActive'  end LocationStatus
,ProviderDBA
,pl.NPINumber
,pl.Address1
,pl.Address2
,pl.City
,pl.State
,pl.Zip
,pl.County
,pl.CountyCode
,pl.TimeZone
,l.Latitude
,l.Longitude
,pl.LocationEmailAddress
,LocationPhoneNumber
,LocationFaxNumber
,'' MobileServices
,WheelChair
,LocationLastAudited
from dbo.ProviderDataLocations pl
left join provider.locations l on pl.locationid = l.locationid



CREATE VIEW [bireports].[PRProviderLocationHCPMapping] AS
select 
ProviderID
,LocationID
,'P'+ProviderId+'L'+LocationId PLKey
,HCPID
--,case when HCPStatus=0 or locationStatus=0 then 'InActive' else 'Active' end AS MappingStatus Need to check with Diana
,case when HCPStatus=0 then 'InActive' else 'Active' end AS MappingStatus
from dbo.ProviderDataHCPMapping
where HCPID<>'' and LocationId <>'' and ProviderID<>''


CREATE view [bireports].[PRHCPs] as
select 
 HCPId HCPID
,case IsActive when 1 then 'Active' else 'InActive'  end HCPStatus
,TermDate TerminationDate
,ReasonForTermination
,Classification
,case Gender when 'M' then 'Male' when 'F' then 'Female' else 'Not Specified' end Gender
,FirstName
,LastName
,NPINumber
,SSN
,DOB
,MedicaidID
,case isnull(MedicaidID,'')  when '' then '' else 'Y' end isMedicaid
,MedicareID
,case isnull(MedicareID,'')  when '' then '' else 'Y' end isMedicare
,PediatricServices
,BoardCertification
,case isnull(upper(BoardCertification),'')  when 'YES' then 'Y' else '' end isBoardCertified
,BoardCertificationDate
,case CredentialDate when 'In Progress' then '' else CredentialDate end CredentialDate
,case isnull(CredentialDate,'')  when 'In Progress' then 'In Progress' when '' then 'No' else 'Credentialed' end CredentialedStatus
from dbo.ProviderDataHCPs
where  isnull(hcpid,'') <> ''

Create view [bireports].[PRHCPLicense] as
select 
 HCPId HCPID
,LicenseNumber1 LicenseNumber
,LicenseState1 LicenseState
from dbo.ProviderDataHCPs
where isnull(LicenseNumber1,'') <> ''
and isnull(hcpid,'') <> ''
UNION
select 
 HCPId HCPID
,LicenseNumber2 LicenseNumber
,LicenseState2 LicenseState
from dbo.ProviderDataHCPs
where isnull(LicenseNumber2,'') <> ''
and isnull(hcpid,'') <> ''
UNION
select 
 HCPId HCPID
,LicenseNumber3 LicenseNumber
,LicenseState3 LicenseState
from dbo.ProviderDataHCPs
where isnull(LicenseNumber3,'') <> ''
and isnull(hcpid,'') <> ''
-- =============================================
-- Author:      Micah Elliott
-- Create Date: 9/13/2019
-- Description: Creates a new MEA Account
-- =============================================
CREATE PROCEDURE callcenter.CreateMEAAccount
(
    @FirstName varchar(50) = '',
	@LastName varchar(100) = '',
	@Username varchar(12) = NULL
)
AS
BEGIN
    -- SET NOCOUNT ON added to prevent extra result sets from
    -- interfering with SELECT statements.
    SET NOCOUNT ON

	declare @createuser varchar(100)

	declare @appmoduleroleid bigint
	declare @appmoduleid bigint
	declare @userprofileid bigint
	declare @usergroupid bigint
	declare @usergroupmoduleid bigint
	declare @usergroupmoduleroleid bigint
	declare @appmodulerolemenuid bigint

	declare @output table (id bigint)

	-------------------
	set @createuser = 'NHAdmin'
	-------------------

	-- Get Module
	set @appmoduleid = (select AppModuleId from auth.AppModules where ModuleName = 'CallCenter Portal')

	-- Get role
	set @appmoduleroleid = (select AppModuleRoleId from auth.AppModuleRoles where AppModuleId = @appmoduleid and AppModuleRoleName = 'CallCenter Agent')

	-- Get Menus for Role
	set @appmodulerolemenuid = (select AppModuleRoleMenuId from auth.AppModuleRoleMenus where AppModuleRoleId = @appmoduleroleid and AppModuleRoleMenuName = 'Home')

	-- Get User Groups for Role
	set @usergroupid = (select UserGroupId from auth.UserGroups where UserGroupName = 'NH-CallCenter Agent Group')

	-- Get usergroup<-->appmodule connection for Role
	set @usergroupmoduleid = (select UserGroupModuleId from auth.UserGroupModules where AppModuleId = @appmoduleid and UserGroupId = @usergroupid)

	-- Get usergroup<-->appmodulerole connection for Role
	set @usergroupmoduleroleid = (select UserGroupModuleRoleId from auth.UserGroupModuleRoles where UserGroupId = @usergroupid and AppModuleRoleId = @appmoduleroleid)

	-- Create new user 
	insert into auth.UserProfiles(FirstName, MiddleName, LastName, IsBlocked, IsEnabled, IsRegister, TemproryKeyCode, UserName, 
		CreateUser, CreateDate, ModifyUser, ModifyDate, IsActive)
	output inserted.UserProfileId into @output
	values (
		@firstname,
		'',
		@lastname,
		0, 1, 0,
		@lastname,
		ISNULL(@Username, LOWER(CONCAT(LEFT(@firstname, 1), @lastname))),
		@createuser, GETDATE(), @createuser, GETDATE(), 1
	)
	set @userprofileid = (select top 1 id from @output)
	delete from @output

	-- Add user group
	insert into auth.UserProfileGroups(UserGroupId, UserProfileId, CreateUser, CreateDate, ModifyUser, ModifyDate, IsActive)
	values (
		@usergroupid,
		@userprofileid,
		@createuser, GETDATE(), @createuser, GETDATE(), 1
	)

	-- Add user settings
	insert into auth.UserProfileSettings(UserProfileId, SettingName, SettingValue, CreateUser, CreateDate, ModifyUser, ModifyDate, IsActive)
	values (
		@userprofileid,
		'Roles',
		'["'+ cast(@appmoduleroleid as varchar) +'"]',
		@createuser, GETDATE(), @createuser, GETDATE(), 1
	)

	-- Set default NH Provider Code
	update auth.UserProfiles set ProviderCode = 180000 where UserProfileId = @userprofileid 

	select @userprofileid
END

-- =============================================
-- Author:      <Author, , Suneetha>
-- Create Date: <Create Date, , 4th April 2019>
-- Description: <Description, , Gets the Member Call conversation notes and provider notes together>
-- =============================================
CREATE PROCEDURE [CallCenter].[GetMemberCallLogHistory]
(
   @nhMemberId nvarchar(150)
)
AS
BEGIN
select ROW_NUMBER() OVER(ORDER BY AgentId) as RowId,* from(
	select c.AgentUserProfileName as AgentName,c.AgentUserProfileId as AgentId,e.eventCode as DispositionCode,
	e.eventName as DispositionText,c.createDate as CallDateAndTime,'' as LeadStatus,
	c.CallEndSummary as EndCallSummary,c.CallBound as CallType 
	from [CallCenter].[CallConversations] c 
	inner join [CallCenter].[CallPageEvents] p on p.[CallConversationId] = c.[CallConversationId]
	inner join [jobs].[Events] e on e.eventId = p.eventId
	where c.MemberNHMemberId = @nhMemberId AND EventTriggerBy = 'DISPOSITION'
	UNION
	select n.CreateUser,n.ProviderId, null,null,n.createDate,null,n.Notes,case when PP.ProviderCode=180000 then 'ADM' else 'PRV' end 
	from [provider].[ConsultationNotes] n 
	join [provider].[ProviderProfiles] as PP on PP.providerid=n.providerid
	where n.nhmemberid=@nhMemberId and  n.isactive=1
	UNION
	SELECT CreateUser,MemberNoteId,'','',CreateDate,'' as LeadStatus, 
	MemberNoteText,'NOTE'
	FROM [provider].[MemberNotes]  WHERE NHMemberId= @nhMemberId
	)s order by CallDateAndTime desc
END



-- EXEC [catalog].[sp_ssis_PHONAK_ItemMaster_Temp_To_Stg]

CREATE PROCEDURE [catalog].[sp_ssis_PHONAK_ItemMaster_Temp_To_Stg]
AS 


BEGIN

	BEGIN TRY
	BEGIN TRANSACTION PHONAK_ItemMaster_Temp_To_Stg

	-- Check column datatype and length
	-- ALTER TABLE [catalog].[PhonakProductTemp] ALTER COLUMN [styles] nvarchar(255) NULL;


	-- Insert new attributevalue code SHELL_TYPE in static table
	--    select * from catalog.ItemAttributes order by 1
	--INSERT INTO catalog.ItemAttributes
	--select 11,'SHELL_TYPE','SHELL_TYPE',1,NULL
	

-------------------------------------------------- Manual updates because of missing info. in catalog file Start --------------------------------------------------------------------------------------------------------
-- Replace special characters
UPDATE catalog.PhonakIdentifierTemp SET en = REPLACE(en,'','e')
UPDATE catalog.PhonakIdentifierTemp SET en = REPLACE(en,'','i') 

UPDATE catalog.PhonakFamilyTemp SET en = REPLACE(en,'','e')
UPDATE catalog.PhonakFamilyTemp SET en = REPLACE(en,'','i')

-- Incorrect Model description in catalog file
UPDATE [catalog].[PhonakIdentifierTemp] SET en= 'Phonak Audeo B50-13' WHERE en= 'Phonak Audeo B 50-13'

-- Incorrect Model description in catalog file
update i
set i.en='Phonak Naida Q70-RIC'
-- select i.en,'Phonak Nada Q70-RIC'
from [catalog].[PhonakIdentifierTemp] i
where 1=1
and en = 'Phonak Naida Q70 RIC'


/*
Style info. is missing for the following models
	Phonak Bolero B50-PR
	Phonak Bolero B70-PR
	Phonak Bolero B90-PR
*/ 
insert into [catalog].[PhonakStylesTemp]
select p.product_id,'BTE' styles
from [catalog].[PhonakCodeTemp] p
--left join [catalog].[PhonakIdentifierTemp] i on (i.product_Id=p.product_id)
left join [catalog].[PhonakStylesTemp] s on (s.product_id=p.product_id)
where 1=1
and s.styles is null
and (p.code like '050-0374%' or p.code like '050-0375%' or p.code like '050-0376%')


/*
Style info. is missing for the following models
	Phonak CROS B-13 Custom
	Phonak CROS B-R
*/ 
insert into [catalog].[PhonakStylesTemp]
select p.product_id,'ITE' styles
from [catalog].[PhonakCodeTemp] p
--left join [catalog].[PhonakIdentifierTemp] i on (i.product_Id=p.product_id)
left join [catalog].[PhonakStylesTemp] s on (s.product_id=p.product_id)
where 1=1
and s.styles is null
and (p.code like '063-0247%' or p.code like '050-0601%')
-------------------------------------------------- Manual updates because of missing info. in catalog file Start --------------------------------------------------------------------------------------------------------





-----------------------------------------------------------------------------------------------------------------------------------------------------------------------------
-- Delete all PHONAK HA's  and attributes in stg table 
DELETE FROM catalog.ItemMasterList_Staging WHERE BrandCode = 'PHONAK'
DELETE FROM catalog.ItemMasterAttributeValues_Staging WHERE Brandcode='PHONAK'
-----------------------------------------------------------------------------------------------------------------------------------------------------------------------------






-------------------------------------------------- Hearing Aids Start --------------------------------------------------------------------------------------------------------
-- Insert all HA items to staging table
INSERT INTO [catalog].[ItemMasterList_Staging]
select 
distinct
pln.en+'_'+id.en ItemCode
,'HA' ItemType
,'PHONAK' BrandCode

-- Case statment for family is written because few products like Naida Q & CROS doesn't have family info. provided in the catalog
--,f.en FamilyCode
,case when f.en is null and id.en like '%CROS%' then 'CROS'
      when f.en is null and id.en not like '%CROS%' then ltrim(substring(id.en,charindex(' ',id.en), CHARINDEX(' ',ltrim(SUBSTRING(id.en,charindex(' ',id.en),LEN(id.en)-charindex(' ',id.en)))) ))+' '+SUBSTRING(pl.code,1,1)
	  else f.en end FamilyCode

,pln.en TechnologyCode
,id.en ModelCode
,case when 'RIC,' IN (select value from STRING_SPLIT(s.styles,' ')) then 'RIC'
	  when 'BTE,' IN (select value from STRING_SPLIT(s.styles,' ')) then 'BTE'
	  when 'ITC,' IN (select value from STRING_SPLIT(s.styles,' ')) then 'ITC'
	  when 'ITE,' IN (select value from STRING_SPLIT(s.styles,' ')) then 'ITE'
	  when 'CIC/IIC,' IN (select value from STRING_SPLIT(s.styles,' ')) then 'CIC/IIC'
	  when id.en like 'Phonak Virto %-10' then 'CIC/IIC' -- style info. is missing for these models in API
	  else s.styles end StyleCode
	  ,1
	  --,*
--,case when p.styles like '%RIC%' and p.styles like '%BTECRT%' then 'RIC'
--	  when p.styles like '%BTE%' then 'BTE'
--	  when p.styles like '%RIC%' then 'RIC'	  
--	  when p.styles like '%ITC%' then 'ITC'
--	  when p.styles like '%ITE%' then 'ITE'
--	  when p.styles like '%CIC/IIC%' then 'CIC/IIC'
--	  when id.en like 'Phonak Virto %-10' then 'CIC/IIC'
--	  else p.styles end StyleCode
--,p.*,'%%%%%' 
--,id.*,'%%%%%' 
--,m.*,'%%%%%'
--,fn.*,'%%%%%' 
--,f.*,'%%%%%'
--,pl.*,'%%%%%' 
----,pln.*
from [catalog].[PhonakProductTemp] p -- Product
left join [catalog].[PhonakCodeTemp] c on (c.product_Id=p.product_Id)
left join [catalog].[PhonakIdentifierTemp] id on (id.product_Id=p.product_Id) -- Model Code
left join [catalog].[PhonakModelTypeTemp] m on (m.product_Id=p.product_Id) -- Battery/Power
-- Family
left join [catalog].[PhonakFamilyNameTemp] fn on (fn.product_Id=p.product_Id)
left join [catalog].[PhonakFamilyTemp] f on (f.family_Id=fn.family_Id)		 
-- Technology Code
left join [catalog].[PhonakPerformanceLevelTemp] pl on (pl.product_Id=p.product_Id)
left join [catalog].[PhonakPerformanceLevelNameTemp] pln on (pln.performanceLevel_Id=pl.performanceLevel_Id)
--styles
left join [catalog].[PhonakStylesTemp] s on (s.product_id=p.product_id)

where 1=1
and pln.en is not null
and f.en is not null
and s.styles is not null

-------------------------------------------------- Hearing Aids End --------------------------------------------------------------------------------------------------------




-------------------------------------------------- Batteries Start --------------------------------------------------------------------------------------------------------
-- Load batteries for all HA's (BTE, RIC & CUSTOM)
INSERT INTO [catalog].[ItemMasterAttributeValues_Staging]
select 
DISTINCT
'PHONAK'
,'BATTERY_SIZES' AttributeCode
,pln.en+'_'+id.en ItemCode
,b.batterySize ModelAttributeValue
,1 IsActive
,null VendorCode
,'NA' Modifier
,b.batterySize ModelAttributeValueDescription
from  [catalog].[PhonakBatterySizeTemp] b
left join [catalog].[PhonakCodeTemp] c on (c.product_Id=b.product_Id)
left join [catalog].[PhonakIdentifierTemp] id on (id.product_Id=b.product_Id)
left join [catalog].[PhonakPerformanceLevelTemp] pl on (pl.product_Id=b.product_Id)
left join [catalog].[PhonakPerformanceLevelNameTemp] pln on (pln.performanceLevel_Id=pl.performanceLevel_Id)
join catalog.ItemMasterList_Staging st on (st.ItemCode=(pln.en+'_'+id.en) and st.BrandCode = 'PHONAK')
where 1=1

UNION

-- Battery missing for these rechargable models in catalog
select 
DISTINCT
'PHONAK'
,'BATTERY_SIZES' AttributeCode
,pln.en+'_'+id.en ItemCode
,'R' ModelAttributeValue
,1 IsActive
,null VendorCode
,'NA' Modifier
,'R' ModelAttributeValueDescription
from  [catalog].[PhonakProductTemp] b
left join [catalog].[PhonakCodeTemp] c on (c.product_Id=b.product_Id)
left join [catalog].[PhonakIdentifierTemp] id on (id.product_Id=b.product_Id)
left join [catalog].[PhonakPerformanceLevelTemp] pl on (pl.product_Id=b.product_Id)
left join [catalog].[PhonakPerformanceLevelNameTemp] pln on (pln.performanceLevel_Id=pl.performanceLevel_Id)
join catalog.ItemMasterList_Staging st on (st.ItemCode=(pln.en+'_'+id.en) and st.BrandCode = 'PHONAK')
where 1=1
and id.en like '%Phonak%B%-R'
and pln.en is not null

UNION

-- Battery missing for these rechargable models in catalog
select 
DISTINCT
'PHONAK'
,'BATTERY_SIZES' AttributeCode
,pln.en+'_'+id.en ItemCode
,'R' ModelAttributeValue
,1 IsActive
,null VendorCode
,'NA' Modifier
,'R' ModelAttributeValueDescription
from  [catalog].[PhonakProductTemp] b
left join [catalog].[PhonakCodeTemp] c on (c.product_Id=b.product_Id)
left join [catalog].[PhonakIdentifierTemp] id on (id.product_Id=b.product_Id)
left join [catalog].[PhonakPerformanceLevelTemp] pl on (pl.product_Id=b.product_Id)
left join [catalog].[PhonakPerformanceLevelNameTemp] pln on (pln.performanceLevel_Id=pl.performanceLevel_Id)
join catalog.ItemMasterList_Staging st on (st.ItemCode=(pln.en+'_'+id.en) and st.BrandCode = 'PHONAK')
where 1=1
and id.en like '%Phonak%B%-PR'
and pln.en is not null


-------------------------------------------------- Batteries End --------------------------------------------------------------------------------------------------------



-------------------------------------------------- Color Start --------------------------------------------------------------------------------------------------------

-- BTE RIC Colors
INSERT INTO [catalog].[ItemMasterAttributeValues_Staging]
select 
DISTINCT
'PHONAK'
,'COLOR' AttributeCode
--,pln.en,id.en
,pln.en+'_'+id.en ItemCode
,cn.en +'-'+ co.code ModelAttributeValue
,1 IsActive
,c.code VendorCode
--,id.en
,'NA' Modifier
,cn.en ModelAttributeValueDescription
--,*
from  [catalog].[PhonakProductTemp] b
left join [catalog].[PhonakCodeTemp] c on (c.product_Id=b.product_Id)
left join [catalog].[PhonakIdentifierTemp] id on (id.product_Id=b.product_Id)
left join [catalog].[PhonakPerformanceLevelTemp] pl on (pl.product_Id=b.product_Id)
left join [catalog].[PhonakPerformanceLevelNameTemp] pln on (pln.performanceLevel_Id=pl.performanceLevel_Id)
left join [catalog].[PhonakColorTemp] co on (co.product_Id=b.product_Id)
left join [catalog].[PhonakColorNameTemp] cn on (cn.color_Id=co.color_Id)
join catalog.ItemMasterList_Staging st on (st.ItemCode=(pln.en+'_'+id.en) and st.BrandCode = 'PHONAK')
where 1=1
and cn.en is not null
and pl.code is not null
and pln.en is not null



-- CUSTOM Color (Faceplate colors)

-- Add CUSTOM_HA attribute for all custom HA's to map its VendorCode with color code
INSERT INTO [catalog].[ItemMasterAttributeValues_Staging]
select 
DISTINCT
'PHONAK'
,'CUSTOM_HA' AttributeCode
--,pln.en,id.en
,pln.en+'_'+id.en ItemCode
,'Custom Hearing Aid' ModelAttributeValue
,1 IsActive
,left(c.code,len(c.code)-3) VendorCode
--,id.en
,'NA' Modifier
,'Custom Hearing Aid' ModelAttributeValueDescription
--,*
from  [catalog].[PhonakProductTemp] b
left join [catalog].[PhonakCodeTemp] c on (c.product_Id=b.product_Id)
left join [catalog].[PhonakIdentifierTemp] id on (id.product_Id=b.product_Id)
left join [catalog].[PhonakPerformanceLevelTemp] pl on (pl.product_Id=b.product_Id)
left join [catalog].[PhonakPerformanceLevelNameTemp] pln on (pln.performanceLevel_Id=pl.performanceLevel_Id)
left join [catalog].[phonakOptionsTemp] co on (co.product_Id=b.product_Id and co.code='FC')
left join [catalog].[phonakOptionsValuesTemp] cn on (cn.initialOptions_Id=co.initialOptions_Id)
join catalog.ItemMasterList_Staging st on (st.ItemCode=(pln.en+'_'+id.en) and st.BrandCode = 'PHONAK')
left join (
			select 
			DISTINCT col.code
			,coln.en
			from [catalog].[PhonakColorTemp] col
			join [catalog].[PhonakColorNameTemp] coln on (coln.color_Id=col.color_Id)
		  ) cust on (cust.code=cn.[values])
where 1=1
and cn.[values] is not null
and pl.code is not null
and pln.en is not null



-- Load available colors for all custom HA's
INSERT INTO [catalog].[ItemMasterAttributeValues_Staging]
select 
DISTINCT
'PHONAK'
,'COLOR' AttributeCode
--,pln.en,id.en
,pln.en+'_'+id.en ItemCode
,cust.en +'-'+ cn.[values] ModelAttributeValue
,1 IsActive
,left(c.code,len(c.code)-3)+'-'+cn.[values] VendorCode
--,id.en
,'NA' Modifier
,cust.en ModelAttributeValueDescription
--,*
from  [catalog].[PhonakProductTemp] b
left join [catalog].[PhonakCodeTemp] c on (c.product_Id=b.product_Id)
left join [catalog].[PhonakIdentifierTemp] id on (id.product_Id=b.product_Id)
left join [catalog].[PhonakPerformanceLevelTemp] pl on (pl.product_Id=b.product_Id)
left join [catalog].[PhonakPerformanceLevelNameTemp] pln on (pln.performanceLevel_Id=pl.performanceLevel_Id)
left join [catalog].[phonakOptionsTemp] co on (co.product_Id=b.product_Id and co.code='FC')		-- Faceplate Color
left join [catalog].[phonakOptionsValuesTemp] cn on (cn.initialOptions_Id=co.initialOptions_Id)
join catalog.ItemMasterList_Staging st on (st.ItemCode=(pln.en+'_'+id.en) and st.BrandCode = 'PHONAK')
left join (
			select 
			DISTINCT col.code
			,coln.en
			from [catalog].[PhonakColorTemp] col
			join [catalog].[PhonakColorNameTemp] coln on (coln.color_Id=col.color_Id)
		  ) cust on (cust.code=cn.[values])
where 1=1
and cn.[values] is not null
and pl.code is not null
and pln.en is not null

-------------------------------------------------- Color End --------------------------------------------------------------------------------------------------------


-------------------------------------------------- BTE Tubes (RECEIVER_SIZES)  Start--------------------------------------------------------------------------------------------------------

-- Load SPAREPART's tubes compatible for all BTE models
INSERT INTO [catalog].[ItemMasterAttributeValues_Staging]
SELECT
DISTINCT
'PHONAK'
,'RECIEVER_SIZES' AttributeCode
--,pln.en,id.en
,pln.en+'_'+id.en ItemCode
,id1.en ModelAttributeValue
,1 IsActive
,r.target VendorCode
--,id.en
,case when id1.en like '%-L' then 'LT' 
	  when id1.en like '%-R' then 'RT' else 'NA' end Modifier
,id1.en ModelAttributeValueDescription
from  [catalog].[PhonakProductTemp] b
left join [catalog].[PhonakCodeTemp] c on (c.product_Id=b.product_Id)
left join [catalog].[PhonakIdentifierTemp] id on (id.product_Id=b.product_Id)
left join [catalog].[PhonakPerformanceLevelTemp] pl on (pl.product_Id=b.product_Id)
left join [catalog].[PhonakPerformanceLevelNameTemp] pln on (pln.performanceLevel_Id=pl.performanceLevel_Id)
left join [catalog].[PhonakReferencesTemp] r on (r.product_Id=b.product_Id)
left join [catalog].[PhonakCodeTemp] c1 on (c1.code=r.target)
left join [catalog].[PhonakIdentifierTemp] id1 on (id1.product_Id=c1.product_Id)
join catalog.ItemMasterList_Staging st on (st.ItemCode=(pln.en+'_'+id.en) and st.BrandCode = 'PHONAK')
where 1=1
and r.type='SPAREPART'
AND id1.en like '%SlimTube%'

-------------------------------------------------- BTE Tubes (RECEIVER_SIZES)  End --------------------------------------------------------------------------------------------------------


-------------------------------------------------- RIC Receiver Power & Sizes (RECIEVER_POWER & RECEIVER_SIZES)  Start --------------------------------------------------------------------------------------------------------

-- Receiver power and sizes are loaded from the same attribute  (NECESSARYITEMLEFT & NECESSARYITEMRIGHT references)
INSERT INTO [catalog].[ItemMasterAttributeValues_Staging]
SELECT
DISTINCT
'PHONAK'
,'RECIEVER_POWER' AttributeCode
--,pln.en,id.en
,pln.en+'_'+id.en ItemCode
,id1.en ModelAttributeValue
,1 IsActive
,r.target VendorCode
--,r.type
,case when id1.en like '%L' then 'LT' 
	  when id1.en like '%R' then 'RT' else 'NA' end Modifier
,id1.en ModelAttributeValueDescription
from  [catalog].[PhonakProductTemp] b
left join [catalog].[PhonakCodeTemp] c on (c.product_Id=b.product_Id)
left join [catalog].[PhonakIdentifierTemp] id on (id.product_Id=b.product_Id)
left join [catalog].[PhonakPerformanceLevelTemp] pl on (pl.product_Id=b.product_Id)
left join [catalog].[PhonakPerformanceLevelNameTemp] pln on (pln.performanceLevel_Id=pl.performanceLevel_Id)
left join [catalog].[PhonakReferencesTemp] r on (r.product_Id=b.product_Id)
left join [catalog].[PhonakCodeTemp] c1 on (c1.code=r.target)
left join [catalog].[PhonakIdentifierTemp] id1 on (id1.product_Id=c1.product_Id)
join catalog.ItemMasterList_Staging st on (st.ItemCode=(pln.en+'_'+id.en) and st.BrandCode = 'PHONAK')
where 1=1
and r.type in ('NECESSARYITEMLEFT','NECESSARYITEMRIGHT')
AND id1.en like '%receiver%'
-------------------------------------------------- RIC Receiver Power & Sizes (RECIEVER_POWER & RECEIVER_SIZES)  End --------------------------------------------------------------------------------------------------------



-------------------------------------------------- CUSTOM Receiver Power (PL) Start --------------------------------------------------------------------------------------------------------
-- CUSTOM Receivers (Power lever PL)

INSERT INTO [catalog].[ItemMasterAttributeValues_Staging]
select 
DISTINCT
'PHONAK'
,'RECIEVER_POWER' AttributeCode
--,pln.en,id.en
,pln.en+'_'+id.en ItemCode
,cust.code+'-'+cust.en ModelAttributeValue
,1 IsActive
,cn.[values] VendorCode
--,id.en
,'NA' Modifier
,cust.code ModelAttributeValueDescription
--,*
from  [catalog].[PhonakProductTemp] b
left join [catalog].[PhonakCodeTemp] c on (c.product_Id=b.product_Id)
left join [catalog].[PhonakIdentifierTemp] id on (id.product_Id=b.product_Id)
left join [catalog].[PhonakPerformanceLevelTemp] pl on (pl.product_Id=b.product_Id)
left join [catalog].[PhonakPerformanceLevelNameTemp] pln on (pln.performanceLevel_Id=pl.performanceLevel_Id)
left join [catalog].[phonakOptionsTemp] co on (co.product_Id=b.product_Id and co.code='PL')		-- Power Level
left join [catalog].[phonakOptionsValuesTemp] cn on (cn.initialOptions_Id=co.initialOptions_Id)
join catalog.ItemMasterList_Staging st on (st.ItemCode=(pln.en+'_'+id.en) and st.BrandCode = 'PHONAK')
left join (
			select 
			DISTINCT case when coln.en ='M' then 'Moderate' 
					      when coln.en ='P' then 'Power'
					      when coln.en ='S' then 'Standard'
					 else col.code end code
			,coln.en
			from [catalog].[PhonakPerformanceLevelTemp] col
			join [catalog].[PhonakPerformanceLevelNameTemp] coln on (coln.performanceLevel_Id=col.performanceLevel_Id)
			where 1=1
			and col.code like 'RECEIVER_%'
			UNION
			select 'Super Power','SP'
			UNION
			select 'Ultra Power','UP'   -- Add more power levels if available going forward
			UNION
			select 'None','NONE'
		  ) cust on (cust.en=cn.[values])
where 1=1
and cn.[values] is not null
-------------------------------------------------- CUSTOM Receiver Power (PL) End --------------------------------------------------------------------------------------------------------



-------------------------------------------------- CUSTOM Shell Type (ST) Start --------------------------------------------------------------------------------------------------------
-- CUSTOM Shell Type (Shell Type ST)
INSERT INTO [catalog].[ItemMasterAttributeValues_Staging]
select 
DISTINCT
'PHONAK'
,'SHELL_TYPE' AttributeCode
--,pln.en,id.en
,pln.en+'_'+id.en ItemCode
,case when cn.[values] = 'H' then 'Half Shell'+'-'+cn.[values]
      when cn.[values] = 'N' then 'IIC'+'-'+cn.[values]
	  when cn.[values] = 'I' then 'CIC'+'-'+cn.[values]
	  when cn.[values] = 'M' then 'Mini Canal'+'-'+cn.[values]
	  when cn.[values] = 'C' then 'Canal'+'-'+cn.[values]
	  when cn.[values] = 'F' then 'Full Shell'+'-'+cn.[values]
else cn.[values] end ModelAttributeValue
,1 IsActive
,cn.[values] VendorCode
--,id.en
,'NA' Modifier
,case when cn.[values] = 'H' then 'Half Shell'
      when cn.[values] = 'N' then 'IIC'
	  when cn.[values] = 'I' then 'CIC'
	  when cn.[values] = 'M' then 'Mini Canal'
	  when cn.[values] = 'C' then 'Canal'
	  when cn.[values] = 'F' then 'Full Shell'
else cn.[values] end ModelAttributeValueDescription
--,*
from  [catalog].[PhonakProductTemp] b
left join [catalog].[PhonakCodeTemp] c on (c.product_Id=b.product_Id)
left join [catalog].[PhonakIdentifierTemp] id on (id.product_Id=b.product_Id)
left join [catalog].[PhonakPerformanceLevelTemp] pl on (pl.product_Id=b.product_Id)
left join [catalog].[PhonakPerformanceLevelNameTemp] pln on (pln.performanceLevel_Id=pl.performanceLevel_Id)
left join [catalog].[phonakOptionsTemp] co on (co.product_Id=b.product_Id and co.code='ST')		-- Shell Style
left join [catalog].[phonakOptionsValuesTemp] cn on (cn.initialOptions_Id=co.initialOptions_Id)
join catalog.ItemMasterList_Staging st on (st.ItemCode=(pln.en+'_'+id.en) and st.BrandCode = 'PHONAK')
left join (
			select 
			DISTINCT col.code
			,coln.en
			from [catalog].[PhonakColorTemp] col
			join [catalog].[PhonakColorNameTemp] coln on (coln.color_Id=col.color_Id)
		  ) cust on (cust.code=cn.[values])
where 1=1
and cn.[values] is not null
and pl.code is not null
and pln.en is not null
-------------------------------------------------- CUSTOM Shell Type (ST) End --------------------------------------------------------------------------------------------------------





-------------------------------------------------- Picture & Thumbnail URL's Start --------------------------------------------------------------------------------------------------------

-- Phonak pictures and thumbnail urls
/*
select 
c.code Vendor_Code
,id.en Product_Description
,pl.code PerformanceLevel_Code
,pln.en PerformanceLevel_Description
,co.code Color_Code
,co.value1 Color_RGB_or_HEX
,cn.en Color_Description
,pu.pictureURL Picture_URL
,tu.thumbnailURL Thumbnail_URL
from  [catalog].[PhonakProductTemp] b
left join [catalog].[PhonakCodeTemp] c on (c.product_Id=b.product_Id)
left join [catalog].[PhonakIdentifierTemp] id on (id.product_Id=b.product_Id)
left join [catalog].[PhonakPerformanceLevelTemp] pl on (pl.product_Id=b.product_Id)
left join [catalog].[PhonakPerformanceLevelNameTemp] pln on (pln.performanceLevel_Id=pl.performanceLevel_Id)
left join [catalog].[PhonakColorTemp] co on (co.product_Id=b.product_Id)
left join [catalog].[PhonakColorNameTemp] cn on (cn.color_Id=co.color_Id)
left join [catalog].[PhonakPictureURLTemp] pu on (pu.product_Id=b.product_Id)
left join [catalog].[PhonakThumbnailURLTemp] tu on (tu.product_Id=b.product_Id)
where 1=1
and pu.pictureURL!='https://dc-cached.phonakpro.comnull'
order by c.code
*/
-------------------------------------------------- Picture & Thumbnail URL's End --------------------------------------------------------------------------------------------------------

	COMMIT TRANSACTION PHONAK_ItemMaster_Temp_To_Stg
	PRINT 'SUCCESS'
	

	END TRY
	

	BEGIN CATCH

	DECLARE @ErrorMessage NVARCHAR(4000);  
    DECLARE @ErrorSeverity INT;  
    DECLARE @ErrorState INT;  

    SELECT   
        @ErrorMessage = ERROR_MESSAGE(),  
        @ErrorSeverity = ERROR_SEVERITY(),  
        @ErrorState = ERROR_STATE();  

		IF (@@TRANCOUNT > 0)
		BEGIN
			ROLLBACK TRANSACTION PHONAK_ItemMaster_Temp_To_Stg
			RAISERROR(@ErrorMessage,@ErrorSeverity,@ErrorState);
			PRINT 'FAILED'
		END

	END CATCH
END


-- EXEC [catalog].[sp_ssis_PHONAK_ItemMaster_Stg_To_Master]

CREATE PROCEDURE [catalog].[sp_ssis_PHONAK_ItemMaster_Stg_To_Master]
AS 


BEGIN

	BEGIN TRY
	BEGIN TRANSACTION PHONAK_ItemMaster_Stg_To_Master

	-- CRUD operation for ItemMasterList
	DECLARE @user NVARCHAR(50)
	--SET @user=SYSTEM_USER
	SET @user='SDaggubati'

	-- CRUD query for ItemMasterList
	MERGE [Catalog].[ItemMasterList] IL 
	USING (SELECT * FROM [Catalog].[ItemMasterList_Staging] WHERE BrandCode IN ('PHONAK')) ILS 
	ON (IL.ItemCode = ILS.ItemCode AND IL.Modelcode=ILS.ModelCode AND IL.BrandCode = ILS.BrandCode AND IL.FamilyCode = ILS.FamilyCode AND IL.BrandCode IN ('PHONAK') AND ILS.BrandCode IN ('PHONAK'))

	WHEN MATCHED AND IL.BrandCode IN ('PHONAK')  THEN -- Update existing item for changes
															
		UPDATE SET  IL.ItemType= ILS.ItemType,
					IL.TechnologyCode=ILS.TechnologyCode,
					IL.StyleCode=ILS.StyleCode,
					IL.IsActive=ILS.IsActive,
					IL.ModifyDate=GETDATE(),
					IL.ModifyUser=@user

	WHEN NOT MATCHED BY TARGET AND ILS.BrandCode IN ('PHONAK') THEN -- Load new HA's 

	INSERT  (ItemCode,ItemType,BrandCode,FamilyCode,TechnologyCode,ModelCode,StyleCode,IsActive,CreateDate,CreateUser,ModifyDate,ModifyUser,MonauralHCPCSCode,BinauralHCPCSCode)
	VALUES ( ILS.ItemCode,ILS.ItemType,ILS.BrandCode,ILS.FamilyCode,ILS.TechnologyCode,ILS.ModelCode,ILS.StyleCode,ILS.IsActive, GETDATE(),@user ,GETDATE(),@user 
		   ,CASE WHEN ( (ILS.StyleCode LIKE '%CIC' OR ILS.StyleCode LIKE '%IIC' ) ) THEN 'V5254'
				 WHEN ( (ILS.StyleCode LIKE '%ITC' OR ILS.StyleCode LIKE '%HS' OR ILS.StyleCode LIKE '%MIH' OR ILS.StyleCode LIKE '%MIH-S') ) THEN 'V5255'
				 WHEN ( (ILS.StyleCode LIKE '%ITE' OR ILS.StyleCode LIKE '%LP') ) THEN 'V5256'

				 WHEN ( ILS.StyleCode IN ('BTE','RIE','RIC') ) THEN 'V5257'

		   END 
		   ,CASE WHEN ( (ILS.StyleCode LIKE '%CIC' OR ILS.StyleCode LIKE '%IIC') ) THEN 'V5258'
				 WHEN ( (ILS.StyleCode LIKE '%ITC' OR ILS.StyleCode LIKE '%HS' OR ILS.StyleCode LIKE '%MIH' OR ILS.StyleCode LIKE '%MIH-S') ) THEN 'V5259'
				 WHEN ( (ILS.StyleCode LIKE '%ITE' OR ILS.StyleCode LIKE '%LP') ) THEN 'V5260'

				 WHEN ( ILS.StyleCode IN ('BTE','RIE','RIC') ) THEN 'V5261'
		   END
		   )

	WHEN NOT MATCHED BY SOURCE AND IL.BrandCode IN ('PHONAK')  THEN -- Disable existing items since they are not available in latest catalog file -- AND IL.ItemType='HA' (CROS models also should be disabled)

	UPDATE SET IL.IsActive=0, IL.ModifyDate=GETDATE(), IL.ModifyUser=@user;


	-- CRUD query for ItemMasterAttributeValue
	MERGE [Catalog].[ItemMasterAttributeValues] IL 
	USING (SELECT * FROM [Catalog].[ItemMasterAttributeValues_Staging] WHERE BrandCode IN ('PHONAK')) ILS 
	ON (IL.ItemCode = ILS.ItemCode AND IL.Attributecode=ILS.Attributecode AND IL.ModelAttributeValue = ILS.ModelAttributeValue AND ILS.BrandCode IN ('PHONAK'))

	WHEN MATCHED THEN -- Update existing attribute values for changes
															
		UPDATE SET  IL.VendorCode= ILS.VendorCode,
					IL.ModelAttributeValueDescription=ILS.ModelAttributeValueDescription,
					IL.IsActive=ILS.IsActive,
					IL.ModifyDate=GETDATE(),
					IL.ModifyUser=@user

	WHEN NOT MATCHED BY TARGET AND ILS.BrandCode IN ('PHONAK') THEN -- Load new attribute values

	INSERT  (AttributeCode,ItemCode,ModelAttributeValue,IsActive,VendorCode,Modifier,CreateDate,CreateUser,ModifyDate,ModifyUser,ModelAttributeValueDescription)
	VALUES ( ILS.AttributeCode,ILS.ItemCode,ILS.ModelAttributeValue,ILS.IsActive,ILS.VendorCode,ILS.Modifier, GETDATE(),@user ,GETDATE(),@user,ILS.ModelAttributeValueDescription);

	-- Disable attribute since they are not available in latest catalog file
	UPDATE IAV 
	SET IAV.IsActive=0  , IAV.ModifyDate=GETDATE(), IAV.ModifyUser=@user
	-- SELECT IAV.*,IL.*
	FROM Catalog.ItemMasterAttributevalues IAV 
	JOIN catalog.ItemMasterList iml ON (iav.Itemcode=iml.ItemCode AND iml.BrandCode IN ('PHONAK'))
	LEFT JOIN Catalog.ItemMasterAttributevalues_staging IL ON (IL.Itemcode=IAV.Itemcode AND IL.Attributecode=IAV.Attributecode AND IL.ModelAttributeValue = IAV.ModelAttributeValue AND IL.BrandCode IN ('PHONAK'))
	WHERE 1=1
	AND IL.Itemcode IS NULL


	COMMIT TRANSACTION PHONAK_ItemMaster_Stg_To_Master
	PRINT 'SUCCESS'
	

	END TRY
	

	BEGIN CATCH

	DECLARE @ErrorMessage NVARCHAR(4000);  
    DECLARE @ErrorSeverity INT;  
    DECLARE @ErrorState INT;  

    SELECT   
        @ErrorMessage = ERROR_MESSAGE(),  
        @ErrorSeverity = ERROR_SEVERITY(),  
        @ErrorState = ERROR_STATE();  

		IF (@@TRANCOUNT > 0)
		BEGIN
			ROLLBACK TRANSACTION PHONAK_ItemMaster_Stg_To_Master
			RAISERROR(@ErrorMessage,@ErrorSeverity,@ErrorState);
			PRINT 'FAILED'
		END

	END CATCH
END


-- EXEC [catalog].[sp_ssis_UNITRON_ItemMaster_Stg_To_Master]

CREATE PROCEDURE [catalog].[sp_ssis_UNITRON_ItemMaster_Stg_To_Master]
AS 


BEGIN

	BEGIN TRY
	BEGIN TRANSACTION UNITRON_ItemMaster_Stg_To_Master

	-- CRUD operation for ItemMasterList
	DECLARE @user NVARCHAR(50)
	--SET @user=SYSTEM_USER
	SET @user='SDaggubati'

	-- CRUD query for ItemMasterList
	MERGE [Catalog].[ItemMasterList] IL 
	USING (SELECT * FROM [Catalog].[ItemMasterList_Staging] WHERE BrandCode IN ('UNITRON')) ILS 
	ON (IL.ItemCode = ILS.ItemCode AND IL.Modelcode=ILS.ModelCode AND IL.BrandCode = ILS.BrandCode AND IL.FamilyCode = ILS.FamilyCode AND IL.BrandCode IN ('UNITRON') AND ILS.BrandCode IN ('UNITRON'))

	WHEN MATCHED AND IL.BrandCode IN ('UNITRON')  THEN -- Update existing item for changes
															
		UPDATE SET  IL.ItemType= ILS.ItemType,
					IL.TechnologyCode=ILS.TechnologyCode,
					IL.StyleCode=ILS.StyleCode,
					IL.IsActive=ILS.IsActive,
					IL.ModifyDate=GETDATE(),
					IL.ModifyUser=@user

	WHEN NOT MATCHED BY TARGET AND ILS.BrandCode IN ('UNITRON') THEN -- Load new HA's 

	INSERT  (ItemCode,ItemType,BrandCode,FamilyCode,TechnologyCode,ModelCode,StyleCode,IsActive,CreateDate,CreateUser,ModifyDate,ModifyUser,MonauralHCPCSCode,BinauralHCPCSCode)
	VALUES ( ILS.ItemCode,ILS.ItemType,ILS.BrandCode,ILS.FamilyCode,ILS.TechnologyCode,ILS.ModelCode,ILS.StyleCode,ILS.IsActive, GETDATE(),@user ,GETDATE(),@user 
		   ,CASE WHEN ( (ILS.StyleCode LIKE '%CIC' OR ILS.StyleCode LIKE '%IIC' ) ) THEN 'V5254'
				 WHEN ( (ILS.StyleCode LIKE '%ITC' OR ILS.StyleCode LIKE '%HS' OR ILS.StyleCode LIKE '%MIH' OR ILS.StyleCode LIKE '%MIH-S') ) THEN 'V5255'
				 WHEN ( (ILS.StyleCode LIKE '%ITE' OR ILS.StyleCode LIKE '%LP') ) THEN 'V5256'

				 WHEN ( ILS.StyleCode IN ('BTE','RIE','RIC') ) THEN 'V5257'

		   END 
		   ,CASE WHEN ( (ILS.StyleCode LIKE '%CIC' OR ILS.StyleCode LIKE '%IIC') ) THEN 'V5258'
				 WHEN ( (ILS.StyleCode LIKE '%ITC' OR ILS.StyleCode LIKE '%HS' OR ILS.StyleCode LIKE '%MIH' OR ILS.StyleCode LIKE '%MIH-S') ) THEN 'V5259'
				 WHEN ( (ILS.StyleCode LIKE '%ITE' OR ILS.StyleCode LIKE '%LP') ) THEN 'V5260'

				 WHEN ( ILS.StyleCode IN ('BTE','RIE','RIC') ) THEN 'V5261'
		   END
		   )

	WHEN NOT MATCHED BY SOURCE AND IL.BrandCode IN ('UNITRON')  THEN -- Disable existing items since they are not available in latest catalog file -- AND IL.ItemType='HA' (CROS models also should be disabled)

	UPDATE SET IL.IsActive=0, IL.ModifyDate=GETDATE(), IL.ModifyUser=@user;


	-- CRUD query for ItemMasterAttributeValue
	MERGE [Catalog].[ItemMasterAttributeValues] IL 
	USING (SELECT * FROM [Catalog].[ItemMasterAttributeValues_Staging] WHERE BrandCode IN ('UNITRON')) ILS 
	ON (IL.ItemCode = ILS.ItemCode AND IL.Attributecode=ILS.Attributecode AND IL.ModelAttributeValue = ILS.ModelAttributeValue AND ILS.BrandCode IN ('UNITRON'))

	WHEN MATCHED THEN -- Update existing attribute values for changes
															
		UPDATE SET  IL.VendorCode= ILS.VendorCode,
					IL.ModelAttributeValueDescription=ILS.ModelAttributeValueDescription,
					IL.IsActive=ILS.IsActive,
					IL.ModifyDate=GETDATE(),
					IL.ModifyUser=@user

	WHEN NOT MATCHED BY TARGET AND ILS.BrandCode IN ('UNITRON') THEN -- Load new attribute values

	INSERT  (AttributeCode,ItemCode,ModelAttributeValue,IsActive,VendorCode,Modifier,CreateDate,CreateUser,ModifyDate,ModifyUser,ModelAttributeValueDescription)
	VALUES ( ILS.AttributeCode,ILS.ItemCode,ILS.ModelAttributeValue,ILS.IsActive,ILS.VendorCode,ILS.Modifier, GETDATE(),@user ,GETDATE(),@user,ILS.ModelAttributeValueDescription);

	-- Disable attribute since they are not available in latest catalog file
	UPDATE IAV 
	SET IAV.IsActive=0  , IAV.ModifyDate=GETDATE(), IAV.ModifyUser=@user
	-- SELECT IAV.*,IL.*
	FROM Catalog.ItemMasterAttributevalues IAV 
	JOIN catalog.ItemMasterList iml ON (iav.Itemcode=iml.ItemCode AND iml.BrandCode IN ('UNITRON'))
	LEFT JOIN Catalog.ItemMasterAttributevalues_staging IL ON (IL.Itemcode=IAV.Itemcode AND IL.Attributecode=IAV.Attributecode AND IL.ModelAttributeValue = IAV.ModelAttributeValue AND IL.BrandCode IN ('UNITRON'))
	WHERE 1=1
	AND IL.Itemcode IS NULL


	COMMIT TRANSACTION UNITRON_ItemMaster_Stg_To_Master
	PRINT 'SUCCESS'
	

	END TRY
	

	BEGIN CATCH

	DECLARE @ErrorMessage NVARCHAR(4000);  
    DECLARE @ErrorSeverity INT;  
    DECLARE @ErrorState INT;  

    SELECT   
        @ErrorMessage = ERROR_MESSAGE(),  
        @ErrorSeverity = ERROR_SEVERITY(),  
        @ErrorState = ERROR_STATE();  

		IF (@@TRANCOUNT > 0)
		BEGIN
			ROLLBACK TRANSACTION UNITRON_ItemMaster_Stg_To_Master
			RAISERROR(@ErrorMessage,@ErrorSeverity,@ErrorState);
			PRINT 'FAILED'
		END

	END CATCH
END

create PROCEDURE [catalog].[sp_ssis_STARKEY_ItemMaster_Temp_To_Stg]
AS
BEGIN
--------------------------------------Loading Starkey Products to #Temp Tables--------------------------------------------------------------
------Delete Starkey data from Staging

DELETE FROM catalog.ItemMasterList_Staging WHERE Brandcode='STARKEY'
DELETE FROM catalog.ItemMasterAttributeValues_Staging WHERE Brandcode='STARKEY'


-------STEP 1-------Loading all HA and Custom Items into #TempProducts table

SELECT DISTINCT SM.Brandcode,SM.FAMILYCODE,SM.TECHCODE,SM.modelcode,SM.ModelName,AV.vendormodelcode VendorCode,SM.stylecode,SM.Itemtypecode,SM.IsActive,AV.Attributecode,
	CASE WHEN SM.Itemtypecode='Hearing Aid' THEN 'HA' 
		 WHEN SM.Itemtypecode='EARMOLD' THEN 'EM' 
		 WHEN SM.Itemtypecode ='CROS' THEN 'CROS' 
		 WHEN SM.ITEMTYPECODE='Batteries' THEN 'BATT'
		 WHEN SM.ITEMTYPECODE='Custom' THEN 'HA'
		 WHEN SM.ITEMTYPECODE='STANDARD PRODUCT' THEN 'HA'
		 ELSE 'OTHERS' END AS ItemType,
	Av.MOdelAttributrevalue
INTO #TempProducts
FROM [catalog].[StarKeyModelsTemp] SM 
INNER JOIN [catalog].[StarKeyAttributeValuesTemp] AV ON AV.modelcode=SM.modelcode --AND AV.vendormodelcode=SM.vendormodelcode
INNER JOIN[catalog].[StarKeyAttributesTemp] A ON A.Attributecode=AV.Attributecode
WHERE  1=1 

AND SM.Itemtypecode IN ('EARMOLD','Hearing Aid','CUSTOM','STANDARD PRODUCT')
--AND Stylecode IN ('CIC','ITE','ITC','IIC','HS','BTE','RIC','mRIC','ITE') 
AND Stylecode NOT IN ('NA') 
AND SM.IsActive=1 AND AV.IsActive=1 AND A.IsActive=1

--------------------------------------------------Loading in to Staging from #TempTables---------------------------------------------------

----STEP 2----Loading all BTE/RIC & CUSTOM Itemcodes in Itemmasterlist_Staging
INSERT INTO [catalog].[ItemMasterList_Staging]
SELECT DISTINCT TECHCODE + '_' +modelcode AS Itemcode,ItemType,BrandCode,FamilyCode,TECHCODE AS TechnologyCode,ModelCode,StyleCode,IsActive
FROM #TempProducts


-----STEP 3-----Loading  BTE/RIC Colors in ItemMasterAttributeValues_Staging
INSERT INTO [catalog].[ItemMasterAttributeValues_Staging]
SELECT BrandCode,AttributeCode,TECHCODE + '_' +modelcode AS Itemcode,ModelAttributrevalue AS ModelAttributeValue,IsActive,VendorCode AS VendorCode,'NA' AS Modifier,ModelAttributrevalue AS ModelAttributeValueDescription 
FROM #TempProducts WHERE AttributeCode='COLOR'

-----------Loading CUSTOM Hearing Aid into AttributeValues with code 'CUSTOM_HA' to save CUSTOM HA 'VendorCode' for EDI

INSERT INTO [catalog].[ItemMasterAttributeValues_Staging]
SELECT  BrandCode, 'CUSTOM_HA' AS AttributeCode,TECHCODE + '_' +modelcode AS Itemcode, ModelAttributrevalue AS ModelAttributeValue,IsActive,VendorCode AS VendorCode,'NA' AS Modifier,ModelAttributrevalue AS ModelAttributeValueDescription 
FROM #TempProducts WHERE AttributeCode='Custom Hearing Aid' 

-----------Loading  Colors options for CUSTOM HA's

INSERT INTO [catalog].[ItemMasterAttributeValues_Staging]
SELECT  BrandCode, 'COLOR' AS AttributeCode,TECHCODE + '_' +modelcode AS Itemcode, LEFT(ModelAttributrevalue, CHARINDEX('(',ModelAttributrevalue)-1) AS ModelAttributeValue,IsActive,VendorCode AS VendorCode,'NA' AS Modifier,ModelAttributrevalue AS ModelAttributeValueDescription 
FROM #TempProducts WHERE AttributeCode='Faceplate colors' 


--SELECT  P.BrandCode, 'COLOR' AS AttributeCode,P.TECHCODE + '_' +P.modelcode AS Itemcode,LEFT(C.ModelAttributrevalue, CHARINDEX('(',C.ModelAttributrevalue)-1)  AS ModelAttributeValue,P.IsActive,P.VendorCode +'-' + C.VendorCode AS VendorCode,'NA' AS Modifier,C.ModelAttributrevalue AS ModelAttributeValueDescription 
--FROM #TempProducts P
--INNER JOIN #TempProducts C ON C.modelcode=P.modelcode
--WHERE P.AttributeCode ='Custom Hearing Aid' AND C.AttributeCode='Faceplate colors'


------STEP 4--------Loading BTE/RIC BatterySizes in ItemMasterAttributeValues_Staging(Battery sizes are dervied from Model itself)

INSERT INTO [catalog].[ItemMasterAttributeValues_Staging]

SELECT DISTINCT BrandCode,'BATTERY_SIZES' AS AttributeCode,(TECHCODE+'_'+modelcode) AS ItemCode,RIGHT(IL.CODE, CHARINDEX('.', REVERSE(IL.CODE)) -1) AS ModelAttributeValue,IsActive,
 NULL AS VendorCode,'NA' AS Modifier,RIGHT(IL.CODE, CHARINDEX('.', REVERSE(IL.CODE)) -1) AS ModelAttributeValueDescription
FROM(
SELECT LEFT(C.Modelcode,len(C.Modelcode)+1-charindex('.',reverse(C.Modelcode))-1) AS CODE,* FROM #TempProducts C WHERE  Stylecode IN('BTE','RIC','mRIC'))IL  

--------STEP 5 Load CUSTOM HA's BatterySizes with all possible values 10,13,312


INSERT INTO [catalog].[ItemMasterAttributeValues_Staging]
SELECT DISTINCT BrandCode,'BATTERY_SIZES' AS AttributeCode,(TECHCODE+'_'+modelcode) AS ItemCode,'10' AS ModelAttributeValue, IsActive, NULL AS VendorCode,'NA' AS Modifier,'10' AS ModelAttributeValueDescription
FROM #TempProducts IL WHERE  Stylecode IN('CIC','ITE','ITC','IIC','HS')
UNION
SELECT DISTINCT BrandCode,'BATTERY_SIZES' AS AttributeCode,(TECHCODE+'_'+modelcode) AS ItemCode,'13' AS ModelAttributeValue,1 AS IsActive, NULL AS VendorCode,'NA' AS Modifier,'13' AS ModelAttributeValueDescription
FROM #TempProducts IL WHERE  Stylecode IN('CIC','ITE','ITC','IIC','HS')
UNION
SELECT DISTINCT BrandCode,'BATTERY_SIZES' AS AttributeCode,(TECHCODE+'_'+modelcode) AS ItemCode,'312' AS ModelAttributeValue,1 AS IsActive, NULL AS VendorCode,'NA' AS Modifier,'312' AS ModelAttributeValueDescription
FROM #TempProducts IL WHERE  Stylecode IN('CIC','ITE','ITC','IIC','HS')


----STEP 6------Loading Recievers Power with Modifiers in ItemMasterAttributeValues_Staging only available for RIC models, BTE models doesn't have receiver powers

INSERT INTO [catalog].[ItemMasterAttributeValues_Staging]

SELECT  DISTINCT BrandCode,'RECIEVER_POWER' AS AttributeCode,(C.TECHCODE + '_' + C.ModelCode) AS ItemCode, R.ModelAttributreValue,C.IsActive,R.VENDORMODELCODE AS VendorCode,
(CASE WHEN R.ModelAttributreValue LIKE '%L1%' THEN 'LT'  WHEN R.ModelAttributreValue LIKE '%L2%' THEN 'LT' WHEN R.ModelAttributreValue LIKE '%L3%' THEN 'LT' WHEN R.ModelAttributreValue LIKE '%L4%' THEN 'LT' WHEN R.ModelAttributreValue LIKE '%L5%' THEN 'LT'
	 WHEN R.ModelAttributreValue LIKE '%R1%' THEN 'RT' WHEN R.ModelAttributreValue LIKE '%R2%' THEN 'RT' WHEN R.ModelAttributreValue LIKE '%R3%' THEN 'RT' WHEN R.ModelAttributreValue LIKE '%R4%' THEN 'RT' WHEN R.ModelAttributreValue LIKE '%R5%' THEN 'RT'
	 WHEN R.ModelAttributreValue LIKE '%Right%' THEN 'RT' WHEN R.ModelAttributreValue LIKE '%Left%' THEN 'LT'
	  ELSE R.ModelAttributreValue END) AS Modifier,R.ModelAttributreValue AS ModelAttributeValueDescription
FROM #TempProducts C
INNER JOIN [catalog].[StarKeyAttributeValuesTemp] R ON R.MODELCODE=C.MODELCODE
WHERE R.AttributeCode='RIC RECIEVERS'


----STEP 7-------Loading receiver tube sizes which are available only for BTE models
INSERT INTO [catalog].[ItemMasterAttributeValues_Staging]
SELECT  DISTINCT BrandCode,'RECIEVER_SIZES' AS AttributeCode,(C.TECHCODE + '_' + C.ModelCode) AS ItemCode, R.ModelAttributreValue,C.IsActive,R.VENDORMODELCODE AS VendorCode,
(CASE 
		WHEN R.ModelAttributreValue LIKE '%Left%' THEN 'LT'
		WHEN R.ModelAttributreValue LIKE '%Right%' THEN 'RT'
		ELSE 'NA' END) AS Modifier
		,R.ModelAttributreValue AS ModelAttributeValueDescription
FROM #TempProducts C
INNER JOIN [catalog].[StarKeyAttributeValuesTemp] R ON R.MODELCODE=C.MODELCODE
WHERE R.AttributeCode='BTE TRANSDUCER TUBES'


-- List of items to verify  Battery for CUSTOM, ReceiverPower for CUSTOM

END


-- EXEC [catalog].[sp_ssis_BT_GNR_ItemMaster_Stg_To_Master]

create PROCEDURE [catalog].[sp_ssis_BT_GNR_ItemMaster_Stg_To_Master]
AS 


BEGIN

	BEGIN TRY
	BEGIN TRANSACTION BT_GNR_ItemMaster_Stg_To_Master

	-- CRUD operation for ItemMasterList
	DECLARE @user NVARCHAR(50)
	--SET @user=SYSTEM_USER
	SET @user='SDaggubati'

	-- CRUD query for ItemMasterList
	MERGE [Catalog].[ItemMasterList] IL 
	USING (SELECT * FROM [Catalog].[ItemMasterList_Staging] WHERE BrandCode IN ('BELTONE','GNR')) ILS 
	ON (IL.ItemCode = ILS.ItemCode AND IL.Modelcode=ILS.ModelCode AND IL.BrandCode = ILS.BrandCode AND IL.FamilyCode = ILS.FamilyCode AND IL.BrandCode IN ('BELTONE','GNR') AND ILS.BrandCode IN ('BELTONE','GNR'))

	WHEN MATCHED AND IL.BrandCode IN ('BELTONE','GNR')  THEN -- Update existing item for changes
															
		UPDATE SET  IL.ItemType= ILS.ItemType,
					IL.TechnologyCode=ILS.TechnologyCode,
					IL.StyleCode=ILS.StyleCode,
					IL.IsActive=ILS.IsActive,
					IL.ModifyDate=GETDATE(),
					IL.ModifyUser=@user

	WHEN NOT MATCHED BY TARGET AND ILS.BrandCode IN ('BELTONE','GNR') THEN -- Load new HA's 

	INSERT  (ItemCode,ItemType,BrandCode,FamilyCode,TechnologyCode,ModelCode,StyleCode,IsActive,CreateDate,CreateUser,ModifyDate,ModifyUser,MonauralHCPCSCode,BinauralHCPCSCode)
	VALUES ( ILS.ItemCode,ILS.ItemType,ILS.BrandCode,ILS.FamilyCode,ILS.TechnologyCode,ILS.ModelCode,ILS.StyleCode,ILS.IsActive, GETDATE(),@user ,GETDATE(),@user 
		   ,CASE WHEN ( (ILS.ModelCode LIKE '%CIC' OR ILS.ModelCode LIKE '%IIC') ) THEN 'V5254'
				 WHEN ( (ILS.ModelCode LIKE '%ITC' OR ILS.ModelCode LIKE '%HS' OR ILS.ModelCode LIKE '%MIH' OR ILS.ModelCode LIKE '%MIH-S') ) THEN 'V5255'
				 WHEN ( (ILS.ModelCode LIKE '%ITE' OR ILS.ModelCode LIKE '%LP') ) THEN 'V5256'

				 WHEN ( ILS.StyleCode IN ('BTE','RIE') ) THEN 'V5257'

		   END 
		   ,CASE WHEN ( (ILS.ModelCode LIKE '%CIC' OR ILS.ModelCode LIKE '%IIC') ) THEN 'V5258'
				 WHEN ( (ILS.ModelCode LIKE '%ITC' OR ILS.ModelCode LIKE '%HS' OR ILS.ModelCode LIKE '%MIH' OR ILS.ModelCode LIKE '%MIH-S') ) THEN 'V5259'
				 WHEN ( (ILS.ModelCode LIKE '%ITE' OR ILS.ModelCode LIKE '%LP') ) THEN 'V5260'

				 WHEN ( ILS.StyleCode IN ('BTE','RIE') ) THEN 'V5261'
		   END
		   )

	WHEN NOT MATCHED BY SOURCE AND IL.BrandCode IN ('BELTONE','GNR') AND IL.ItemType='HA' THEN -- Disable existing items since they are not available in latest catalog file

	UPDATE SET IL.IsActive=0, IL.ModifyDate=GETDATE(), IL.ModifyUser=@user;


	-- CRUD query for ItemMasterAttributeValue
	MERGE [Catalog].[ItemMasterAttributeValues] IL 
	USING (SELECT * FROM [Catalog].[ItemMasterAttributeValues_Staging] WHERE BrandCode IN ('BELTONE','GNR')) ILS 
	ON (IL.ItemCode = ILS.ItemCode AND IL.Attributecode=ILS.Attributecode AND IL.ModelAttributeValue = ILS.ModelAttributeValue AND ILS.BrandCode IN ('BELTONE','GNR'))

	WHEN MATCHED THEN -- Update existing attribute values for changes
															
		UPDATE SET  IL.VendorCode= ILS.VendorCode,
					IL.ModelAttributeValueDescription=ILS.ModelAttributeValueDescription,
					IL.IsActive=ILS.IsActive,
					IL.ModifyDate=GETDATE(),
					IL.ModifyUser=@user

	WHEN NOT MATCHED BY TARGET AND ILS.BrandCode IN ('BELTONE','GNR') THEN -- Load new attribute values

	INSERT  (AttributeCode,ItemCode,ModelAttributeValue,IsActive,VendorCode,Modifier,CreateDate,CreateUser,ModifyDate,ModifyUser,ModelAttributeValueDescription)
	VALUES ( ILS.AttributeCode,ILS.ItemCode,ILS.ModelAttributeValue,ILS.IsActive,ILS.VendorCode,ILS.Modifier, GETDATE(),@user ,GETDATE(),@user,ILS.ModelAttributeValueDescription);

	-- Disable attribute since they are not available in latest catalog file
	UPDATE IAV 
	SET IAV.IsActive=0  , IAV.ModifyDate=GETDATE(), IAV.ModifyUser=@user
	-- SELECT IAV.*,IL.*
	FROM Catalog.ItemMasterAttributevalues IAV 
	JOIN catalog.ItemMasterList iml ON (iav.Itemcode=iml.ItemCode AND iml.BrandCode IN ('BELTONE','GNR'))
	LEFT JOIN Catalog.ItemMasterAttributevalues_staging IL ON (IL.Itemcode=IAV.Itemcode AND IL.Attributecode=IAV.Attributecode AND IL.ModelAttributeValue = IAV.ModelAttributeValue AND IL.BrandCode IN ('BELTONE','GNR'))
	WHERE 1=1
	AND IL.Itemcode IS NULL


	COMMIT TRANSACTION BT_GNR_ItemMaster_Stg_To_Master
	PRINT 'SUCCESS'
	

	END TRY
	

	BEGIN CATCH

	DECLARE @ErrorMessage NVARCHAR(4000);  
    DECLARE @ErrorSeverity INT;  
    DECLARE @ErrorState INT;  

    SELECT   
        @ErrorMessage = ERROR_MESSAGE(),  
        @ErrorSeverity = ERROR_SEVERITY(),  
        @ErrorState = ERROR_STATE();  

		IF (@@TRANCOUNT > 0)
		BEGIN
			ROLLBACK TRANSACTION BT_GNR_ItemMaster_Stg_To_Master
			RAISERROR(@ErrorMessage,@ErrorSeverity,@ErrorState);
			PRINT 'FAILED'
		END

	END CATCH
END

create PROCEDURE [catalog].[sp_ssis_STARKEY_ItemMaster_Stg_To_Master]
AS
BEGIN

BEGIN TRY
BEGIN TRANSACTION STARKEY_ItemMaster_Stg_To_Master

DECLARE @user NVARCHAR(50)
--SET @user=SYSTEM_USER
SET @user='systemuser'

-------------Itemmasterlist C R U D Operation
MERGE [Catalog].[ItemMasterList] IL
USING [Catalog].[ItemMasterList_Staging] ILS
ON (IL.ItemCode = ILS.ItemCode AND IL.Modelcode=ILS.ModelCode AND IL.FamilyCode=ILS.Familycode AND IL.BrandCode ='STARKEY' AND ILS.BrandCode ='STARKEY')

WHEN MATCHED AND ILS.BrandCode ='STARKEY' THEN
															
	UPDATE SET  IL.ItemType= ILS.ItemType,
				IL.TechnologyCode=ILS.TechnologyCode,
				IL.StyleCode=ILS.StyleCode,
				IL.IsActive=ILS.IsActive,
				IL.ModifyDate=GETDATE(),
				IL.ModifyUser=@user

WHEN NOT MATCHED BY TARGET AND ILS.BrandCode ='STARKEY' THEN

INSERT  (ItemCode,ItemType,BrandCode,FamilyCode,TechnologyCode,ModelCode,StyleCode,IsActive,CreateDate,CreateUser,ModifyDate,ModifyUser)
VALUES ( ItemCode,ItemType,BrandCode,FamilyCode,TechnologyCode,ModelCode,StyleCode,IsActive, GETDATE(),@user ,GETDATE(),@user )

WHEN NOT MATCHED BY SOURCE AND IL.BrandCode ='STARKEY' AND IL.ItemType='HA' THEN

UPDATE SET IL.IsActive=0, IL.ModifyDate=GETDATE(),IL.ModifyUser=@user;

-----------ItemMasterAttributeValues C R U D Operation

MERGE [catalog].[ItemMasterAttributeValues] ILAV
USING [catalog].[ItemMasterAttributeValues_Staging] ILAVS
ON (ILAV.ItemCode = ILAVS.ItemCode AND ILAV.ModelAttributeValue=ILAVS.ModelAttributeValue  AND ILAVS.BrandCode ='STARKEY')
																
WHEN MATCHED  THEN

	UPDATE SET  ILAV.ModelAttributeValue= ILAVS.ModelAttributeValue,
				ILAV.Vendorcode= ILAVS.Vendorcode,
				ILAV.Modifier=ILAVS.Modifier,
				ILAV.IsActive=ILAVS.IsActive,
				ILAV.ModifyDate=GETDATE(),
				ILAV.ModifyUser=@user

WHEN NOT MATCHED BY TARGET  AND ILAVS.Attributecode NOT IN('BATTERY_SIZES')  AND ILAVS.BrandCode ='STARKEY' THEN

INSERT  (AttributeCode,ItemCode,ModelAttributeValue,IsActive,VendorCode,Modifier,ModelAttributeValueDescription,CreateDate,CreateUser,ModifyDate,ModifyUser)
VALUES ( AttributeCode,ItemCode,ModelAttributeValue,IsActive,VendorCode,Modifier,ModelAttributeValueDescription,GETDATE(),@user ,GETDATE(),@user );

-----Insert Missing Battries separtely since we are inserting Null value in Vendor Codes into Catalog

INSERT INTO [catalog].[ItemMasterAttributeValues] (AttributeCode,ItemCode,ModelAttributeValue,IsActive,VendorCode,Modifier,ModelAttributeValueDescription,CreateDate,CreateUser,ModifyDate,ModifyUser)
SELECT AttributeCode,ItemCode,ModelAttributeValue,IsActive,VendorCode,Modifier,ModelAttributeValueDescription,GETDATE() AS CreateDate,@user AS CreateUser ,GETDATE() AS ModifyDate,@user  AS ModifyUser
FROM [catalog].[ItemmasterAttributevalues_Staging]
WHERE itemcode NOT IN (SELECT ItemCode From [catalog].[ItemmasterAttributevalues] WHERE Attributecode='BATTERY_SIZES')
AND  Attributecode='BATTERY_SIZES' AND Brandcode='STARKEY'

------Update IsActive Required Attributes

UPDATE IAV
SET IAV.IsActive=0 ,IAV.ModifyDate=GETDATE(),IAV.ModifyUser=@user
FROM [Catalog].[ItemMasterAttributeValues] IAV
INNER JOIN [Catalog].[ItemMasterList] IL ON (IL.ItemCode=IAV.Itemcode AND IL.Brandcode='STARKEY')
LEFT JOIN [catalog].[ItemmasterAttributevalues_Staging] IAVS ON (IAVS.Itemcode=IAV.Itemcode AND IAVS.Attributecode=IAV.Attributecode AND IAVS.ModelAttributeValue=IAV.ModelAttributeValue AND IL.Brandcode='STARKEY')
WHERE IAVS.Itemcode IS NULL

------Update IsActive for All Attributes

UPDATE IAV SET IAV.IsActive=0 ,IAV.ModifyDate=GETDATE(),IAV.ModifyUser=@user  FROM Catalog.ItemMasterAttributevalues IAV 
INNER JOIN Catalog.ItemMasterList IL ON (IL.Itemcode=IAV.Itemcode AND IL.Brandcode='STARKEY' AND IL.IsActive=0)

------UPDATE HCPS CODES

UPDATE catalog.itemmasterlist SET MonauralHCPCScode =CASE  WHEN Stylecode  IN ('CIC','IIC','mCIC')	THEN 'V5254' 
														   WHEN Stylecode  IN ('ITC','HS','MIH','mini canal','canal','mITC')	THEN 'V5255' 
														   WHEN Stylecode  IN ('ITE','LP')	THEN 'V5256' 
														   WHEN Stylecode  IN ('BTE','RIE', 'RIC','mBTE', 'mRIC', 'mRITE', 'RITE', 'designRITE')	THEN 'V5257' END, 
									
								BinauralHCPCSCode =CASE when Stylecode  IN ('CIC','IIC','mCIC')	THEN 'V5258' 
															WHEN Stylecode  IN ('ITC','HS','MIH','mini canal','canal','mITC') THEN 'V5259' 
															WHEN Stylecode  IN ('ITE','LP')	THEN 'V5260' 
															WHEN Stylecode  IN ('BTE','RIE', 'RIC','mBTE', 'mRIC', 'mRITE', 'RITE', 'designRITE')	THEN 'V5261' END

WHERE BrandCode='STARKEY' AND (MonauralHCPCScode IS NULL OR BinauralHCPCSCode IS NULL)

	COMMIT TRANSACTION STARKEY_ItemMaster_Stg_To_Master
	PRINT 'SUCCESS'
	

	END TRY
	

	BEGIN CATCH

	DECLARE @ErrorMessage NVARCHAR(4000);  
    DECLARE @ErrorSeverity INT;  
    DECLARE @ErrorState INT;  

    SELECT   
        @ErrorMessage = ERROR_MESSAGE(),  
        @ErrorSeverity = ERROR_SEVERITY(),  
        @ErrorState = ERROR_STATE();  

		IF (@@TRANCOUNT > 0)
		BEGIN
			ROLLBACK TRANSACTION ST
			RAISERROR(@ErrorMessage,@ErrorSeverity,@ErrorState);
			PRINT 'FAILED'
		END

	END CATCH

END
CREATE procedure [catalog].[UpdateItemMasterCOGS](
	@cogs decimal,
	@itemCode varchar(500),
	@priceType varchar(100)
)
as
begin
declare @previous table(
	priceId bigint not null default(0),
	version int not null default(0),
	cogs decimal not null default(0),
	effFrom datetime2 null,
	effTo datetime2 null
);
insert into @previous (priceId, version, cogs, effFrom, effTo)
select top (1) [ItemPriceID], [PriceVersion], [UnitCOGS], [EffectiveFrom], [EffectiveTo]
from [catalog].[ItemMasterPriceList]
where [ItemCode]=@itemCode and [PriceType]=@priceType and [IsActive]=1
order by [PriceVersion] desc;

if((select count(*) from @previous) = 0)
	begin
		insert into [catalog].[ItemMasterPriceList]
		([ItemCode]
			  ,[PriceType]
			  ,[PriceVersion]
			  ,[EffectiveFrom]
			  ,[EffectiveTo]
			  ,[UnitCOGS]
			  ,[PairCOGS]
			  ,[RebateUnitPrice]
			  ,[RebatePairPrice]
			  ,[IsActive]
			  ,[CreateUser]
			  ,[CreateDate]
			  ,[ModifyUser]
			  ,[ModifiedDate]) values
			  (@itemCode, @priceType, 1, cast(getdate() as date), datefromparts(2099, 12, 31), @cogs, @cogs*2, null, null, 1, 'SystemUser', getdate(), 'SystemUser', getdate());
	end
else if((select effFrom from @previous) is not null and (select cast(effFrom as date) from @previous) <= cast(getdate() as date) and
((select effTo from @previous) is null or (select cast(effTo as date) from @previous) > cast(getdate() as date)) and (select cogs from @previous) <> @cogs)
	begin
		if((select cast(effFrom as date) from @previous) < cast(getdate() as date))
			begin
				update [catalog].[ItemMasterPriceList] set [EffectiveTo]=cast(getdate() as date) where [ItemPriceID]=(select priceid from @previous);
				insert into [catalog].[ItemMasterPriceList]
				([ItemCode]
					  ,[PriceType]
					  ,[PriceVersion]
					  ,[EffectiveFrom]
					  ,[EffectiveTo]
					  ,[UnitCOGS]
					  ,[PairCOGS]
					  ,[RebateUnitPrice]
					  ,[RebatePairPrice]
					  ,[IsActive]
					  ,[CreateUser]
					  ,[CreateDate]
					  ,[ModifyUser]
					  ,[ModifiedDate]) values
					  (@itemCode, @priceType, (select version from @previous)+1, cast(getdate() as date), datefromparts(2099, 12, 31), @cogs, @cogs*2, null, null, 1, 'SystemUser', getdate(), 'SystemUser', getdate());
			end
		else
			begin
				update [catalog].[ItemMasterPriceList] set [UnitCOGS]=@cogs,[PairCOGS]=@cogs*2,[EffectiveTo]=datefromparts(2099, 12, 31),[ModifyUser]='SystemUser',[ModifiedDate]=getdate() where [ItemPriceID]=(select priceid from @previous);
			end
	end
end



-- EXEC [catalog].[sp_ssis_BT_GNR_ItemMaster_Rules_To_Stg]

CREATE PROCEDURE [catalog].[sp_ssis_BT_GNR_ItemMaster_Rules_To_Stg]
AS 


BEGIN

	BEGIN TRY
	BEGIN TRANSACTION BT_GNR_ItemMaster_Rules_To_Stg

-- Delete all BT & GNR HA's in stg table 

DELETE FROM catalog.ItemMasterList_Staging WHERE BrandCode in ('BELTONE','GNR')
-----------------------------------------------------------------------------------------------------------------------------------------------------------------------------

-- Insert all HA items to staging table

INSERT INTO catalog.ItemMasterList_Staging
select 
distinct
replace(mr.FamilyProductCode,' ','')+'_'+replace(mr.ProductModelCode,' ','') ItemCode
,'HA' Type
,mr.BrandCode
,mr.BrandFamilyCode
,mr.FamilyProductCode
,mr.ProductModelCode
--,case when mr.ProductTypeCode like '%RIE%' then 'RIE' ELSE substring( LEFT(s.StyleCode, charindex('CATALOG', s.StyleCode)-1), CHARINDEX('EDI_', s.StyleCode) + len('EDI_'), LEN(s.StyleCode))  END StyleCode

-- Updated to show actual shellcode instead of CUSTOM for custom HA's
,case when (mr.ProductTypeCode IS NOT NULL AND mr.ProductTypeCode like '%RIE%') then 'RIE' 
      WHEN (mr.ProductTypeCode IS NOT NULL AND mr.ProductTypeCode NOT like '%RIE%') THEN 'BTE'
	  WHEN (mr.ProductTypeCode IS NULL)  THEN mr.ShellCode END StyleCode

--,mr.ProductTypeCode,mr.ShellCode
--,isnull(mr.ProductTypeCode,mr.ShellCode) StypleCode
--,s.StyleCode StypleCode_temp

,1
from [catalog].[ProductModelRules] mr
left join [catalog].[Styles] s on (mr.StyleID=s.StyleID)
WHERE 1=1
and BrandCode in ('BELTONE','GNR')
ORDER BY StyleCode,ItemCode
-----------------------------------------------------------------------------------------------------------------------------------------------------------------------------

-- Delete all BT & GNR attribute values in stg table 
DELETE FROM catalog.ItemMasterAttributeValues_Staging WHERE BrandCode in ('BELTONE','GNR')
-----------------------------------------------------------------------------------------------------------------------------------------------------------------------------


-- BATTERY (BATTERY_SIZES) - Attribute Values
-- Shell Code is for CUSTOM items 
-- BATTERY for Custom HA's

INSERT INTO catalog.ItemMasterAttributeValues_Staging
select 
DISTINCT
a.BrandCode
,'BATTERY_SIZES' AttributeCode
,a.ItemCode
,b.FeatureValueCode
,1 IsActive
,a.ProductModelCode
,'NA' Modifier
,b.Description 


from (
	
	select 
	distinct
	replace(mr.FamilyProductCode,' ','')+'_'+replace(mr.ProductModelCode,' ','') ItemCode
	,'HA' Type
	,mr.BrandCode
	,mr.BrandFamilyCode
	,mr.FamilyProductCode
	,mr.ProductModelCode
	,case when mr.ProductTypeCode like '%RIE%' then 'RIE' ELSE substring( LEFT(s.StyleCode, charindex('CATALOG', s.StyleCode)-1), CHARINDEX('EDI_', s.StyleCode) + len('EDI_'), LEN(s.StyleCode))  END StyleCode
	,mr.ProductTypeCode
	,mr.ShellCode
	,isnull(mr.ProductTypeCode,mr.ShellCode) StyleCode1
	,s.StyleCode StypleCode_temp
	,1 IsActive
	from [catalog].[ProductModelRules] mr
	left join [catalog].[Styles] s on (mr.StyleID=s.StyleID)
	WHERE 1=1
	and BrandCode in ('BELTONE','GNR')
	and mr.ShellCode is not null
    ) a
left join
(
	SELECT fvr.ShellCode StyleCode
	,pmr.BrandCode
	,fvr.BrandFamilyCode,fv.*   
	FROM  catalog.FeatureValues  fv  
	left join catalog.FeatureValueRules fvr on (fvr.FeatureValueID=fv.FeatureValueID AND ShellCode IS NOT NULL ) --and BrandFamilyCode='TRUST' )  
	left join (select distinct BrandCode, BrandFamilyCode from catalog.ProductModelRules where BrandCode is not null) pmr on (pmr.BrandFamilyCode=fvr.BrandFamilyCode)
	where 1=1  
	AND fv.FeatureName IN ('BATTERY')  
	and fvr.ShellCode is not null
) b on (a.BrandCode=b.BrandCode and a.BrandFamilyCode=b.BrandFamilyCode and a.StyleCode1=b.StyleCode)
where 1=1
and b.FeatureValueCode is not NULL

UNION

-- Shell Code is for CUSTOM items - BATTERY for Custom  
-- Battery 'FACTORY' for shell codes MIH, MIH-S

--INSERT INTO catalog.ItemMasterAttributeValues_Staging
select 
DISTINCT
a.BrandCode
,'BATTERY_SIZES' AttributeCode
,a.ItemCode
,b.FeatureValueCode
,1 IsActive
,a.ProductModelCode
,'NA' Modifier
,b.Description 


from (
	
	select 
	distinct
	replace(mr.FamilyProductCode,' ','')+'_'+replace(mr.ProductModelCode,' ','') ItemCode
	,'HA' Type
	,mr.BrandCode
	,mr.BrandFamilyCode
	,mr.FamilyProductCode
	,mr.ProductModelCode
	,case when mr.ProductTypeCode like '%RIE%' then 'RIE' ELSE substring( LEFT(s.StyleCode, charindex('CATALOG', s.StyleCode)-1), CHARINDEX('EDI_', s.StyleCode) + len('EDI_'), LEN(s.StyleCode))  END StyleCode
	,mr.ProductTypeCode
	,mr.ShellCode
	,isnull(mr.ProductTypeCode,mr.ShellCode) StyleCode1
	,s.StyleCode StypleCode_temp
	,1 IsActive
	from [catalog].[ProductModelRules] mr
	left join [catalog].[Styles] s on (mr.StyleID=s.StyleID)
	WHERE 1=1
	and BrandCode in ('BELTONE','GNR')
	and mr.ShellCode is not NULL
	AND mr.ShellCode IN ('MIH','MIH-S')
    ) a
left join
(
	SELECT fvr.ShellCode StyleCode
	,pmr.BrandCode
	,fvr.BrandFamilyCode,fv.*
	--,fvr.*,pmr.*  
	FROM  catalog.FeatureValues  fv  
	left join catalog.FeatureValueRules fvr on (fvr.FeatureValueID=fv.FeatureValueID AND ShellCode IS NOT NULL ) --and BrandFamilyCode='TRUST' )  
	left join (select distinct BrandCode, BrandFamilyCode from catalog.ProductModelRules where BrandCode is not null) pmr on (pmr.BrandFamilyCode=fvr.BrandFamilyCode)
	where 1=1  
	AND fv.FeatureName IN ('BATTERY')  
	AND fv.FeatureValueCode='FACTORY'
	
) b on (1=1)
where 1=1
and b.FeatureValueCode is not null



-- BATTERY (BATTERY_SIZES) - Attribute Values
-- ProductType Code is for BTE/RIE 
-- BATTERY for BTE/RIE

-- Query 1
 
INSERT INTO catalog.ItemMasterAttributeValues_Staging
select 
DISTINCT
a.BrandCode
,'BATTERY_SIZES' AttributeCode
,a.ItemCode
,b.FeatureValueCode
,1 IsActive
,a.ProductModelCode
,'NA' Modifier
,b.Description 


from (
	
	select 
	distinct
	replace(mr.FamilyProductCode,' ','')+'_'+replace(mr.ProductModelCode,' ','') ItemCode
	,'HA' Type
	,mr.BrandCode
	,mr.BrandFamilyCode
	,mr.FamilyProductCode
	,mr.ProductModelCode
	,case when mr.ProductTypeCode like '%RIE%' then 'RIE' ELSE substring( LEFT(s.StyleCode, charindex('CATALOG', s.StyleCode)-1), CHARINDEX('EDI_', s.StyleCode) + len('EDI_'), LEN(s.StyleCode))  END StyleCode
	,mr.ProductTypeCode
	,mr.ShellCode
	,isnull(mr.ProductTypeCode,mr.ShellCode) StyleCode1
	,s.StyleCode StypleCode_temp
	,1 IsActive
	from [catalog].[ProductModelRules] mr
	left join [catalog].[Styles] s on (mr.StyleID=s.StyleID)
	WHERE 1=1
	and BrandCode in ('BELTONE','GNR')
	and mr.ProductTypeCode is not null
    ) a
left join
(
	SELECT fvr.ProductTypeCode StyleCode
,pmr.BrandCode
,fvr.BrandFamilyCode,fv.*   
FROM  catalog.FeatureValues  fv  
left join catalog.FeatureValueRules fvr on (fvr.FeatureValueID=fv.FeatureValueID  AND fvr.ProductTypeCode IS NOT NULL ) --and BrandFamilyCode='TRUST')  
left join (select distinct BrandCode, BrandFamilyCode from catalog.ProductModelRules where BrandCode is not null) pmr on (pmr.BrandFamilyCode=fvr.BrandFamilyCode)
where 1=1  
AND fv.FeatureName IN ('BATTERY')  
and fvr.ProductTypeCode is not null
and fvr.BrandFamilyCode is not null
) b on (a.BrandCode=b.BrandCode and a.BrandFamilyCode=b.BrandFamilyCode and a.StyleCode1=b.StyleCode)
where 1=1
and b.FeatureValueCode is not NULL

UNION

-- Query 2
--INSERT INTO catalog.ItemMasterAttributeValues_Staging
select 
DISTINCT
a.BrandCode
,'BATTERY_SIZES' AttributeCode
,a.ItemCode
,b.FeatureValueCode
,1 IsActive
,a.ProductModelCode
,'NA' Modifier
,b.Description 


from (
	
	select 
	distinct
	replace(mr.FamilyProductCode,' ','')+'_'+replace(mr.ProductModelCode,' ','') ItemCode
	,'HA' Type
	,mr.BrandCode
	,mr.BrandFamilyCode
	,mr.FamilyProductCode
	,mr.ProductModelCode
	,case when mr.ProductTypeCode like '%RIE%' then 'RIE' ELSE substring( LEFT(s.StyleCode, charindex('CATALOG', s.StyleCode)-1), CHARINDEX('EDI_', s.StyleCode) + len('EDI_'), LEN(s.StyleCode))  END StyleCode
	,mr.ProductTypeCode
	,mr.ShellCode
	,isnull(mr.ProductTypeCode,mr.ShellCode) StyleCode1
	,s.StyleCode StypleCode_temp
	,1 IsActive
	from [catalog].[ProductModelRules] mr
	left join [catalog].[Styles] s on (mr.StyleID=s.StyleID)
	WHERE 1=1
	and BrandCode in ('BELTONE','GNR')
	and mr.ProductTypeCode is not null
    ) a
left join
(
	SELECT fvr.ProductTypeCode StyleCode
,pmr.BrandCode
,fvr.BrandFamilyCode,fv.*   
FROM  catalog.FeatureValues  fv  
left join catalog.FeatureValueRules fvr on (fvr.FeatureValueID=fv.FeatureValueID  AND fvr.ProductTypeCode IS NOT NULL ) --and BrandFamilyCode='TRUST')  
left join (select distinct BrandCode, BrandFamilyCode from catalog.ProductModelRules where BrandCode is not null) pmr on (pmr.BrandFamilyCode=fvr.BrandFamilyCode)
where 1=1  
AND fv.FeatureName IN ('BATTERY')  
and fvr.ProductTypeCode is NOT null
and fvr.BrandFamilyCode is null
) b on ( a.StyleCode1=b.StyleCode)
where 1=1
and b.FeatureValueCode is not null

-----------------------------------------------------------------------------------------------------------------------------------------------------------------------------

-- HOUSING COLOR (COLOR)  Only for RIE/BTE color Attribute Values
-- Colors available to only a specific model (RIE/BTE) in a family  - ProductModelCode IS NOT NULL

INSERT INTO catalog.ItemMasterAttributeValues_Staging
select 
DISTINCT
a.BrandCode
,'COLOR' AttributeCode
,a.ItemCode
,b.FeatureValueCode
,1 IsActive
,a.ProductModelCode
,'NA' Modifier
,b.Description 


from (
	
	select 
	distinct
	replace(mr.FamilyProductCode,' ','')+'_'+replace(mr.ProductModelCode,' ','') ItemCode
	,'HA' Type
	,mr.BrandCode
	,mr.BrandFamilyCode
	,mr.FamilyProductCode
	,mr.ProductModelCode
	,case when mr.ProductTypeCode like '%RIE%' then 'RIE' ELSE substring( LEFT(s.StyleCode, charindex('CATALOG', s.StyleCode)-1), CHARINDEX('EDI_', s.StyleCode) + len('EDI_'), LEN(s.StyleCode))  END StyleCode
	,mr.ProductTypeCode
	,mr.ShellCode
	,isnull(mr.ProductTypeCode,mr.ShellCode) StyleCode1
	,s.StyleCode StypleCode_temp
	,1 IsActive
	from [catalog].[ProductModelRules] mr
	left join [catalog].[Styles] s on (mr.StyleID=s.StyleID)
	WHERE 1=1
	and BrandCode in ('BELTONE','GNR')
	AND mr.ProductTypeCode IS NOT NULL
	) a
join
(
SELECT  pmr.BrandCode,fv.FeatureValueCode,fv.Description,fvr.BrandFamilyCode,fvr.ProductModelCode
FROM catalog.FeatureValueRules fvr
left join catalog.FeatureValues fv on (fv.FeatureValueID=fvr.FeatureValueID)
left join (select distinct BrandCode, BrandFamilyCode from catalog.ProductModelRules where BrandCode is not null) pmr on (pmr.BrandFamilyCode=fvr.BrandFamilyCode)
WHERE 1=1
and  fv.FeatureName IN ('HOUSING COLOR')
and fvr.ProductModelCode is not null
) b on (a.BrandCode=b.BrandCode and a.BrandFamilyCode=b.BrandFamilyCode and a.ProductModelCode=b.ProductModelCode)
where 1=1
and b.FeatureValueCode is not null

UNION

-- Colors available by family which are compatible with all models (RIE/BTE) in the family - ProductModelCode IS NULL
-- INSERT INTO catalog.ItemMasterAttributeValues_Staging
select 
DISTINCT
a.BrandCode
,'COLOR' AttributeCode
,a.ItemCode
,b.FeatureValueCode
,1 IsActive
,a.ProductModelCode
,'NA' Modifier
,b.Description 


from (
	
	select 
	distinct
	replace(mr.FamilyProductCode,' ','')+'_'+replace(mr.ProductModelCode,' ','') ItemCode
	,'HA' Type
	,mr.BrandCode
	,mr.BrandFamilyCode
	,mr.FamilyProductCode
	,mr.ProductModelCode
	,case when mr.ProductTypeCode like '%RIE%' then 'RIE' ELSE substring( LEFT(s.StyleCode, charindex('CATALOG', s.StyleCode)-1), CHARINDEX('EDI_', s.StyleCode) + len('EDI_'), LEN(s.StyleCode))  END StyleCode
	,mr.ProductTypeCode
	,mr.ShellCode
	,isnull(mr.ProductTypeCode,mr.ShellCode) StyleCode1
	,s.StyleCode StypleCode_temp
	,1 IsActive
	from [catalog].[ProductModelRules] mr
	left join [catalog].[Styles] s on (mr.StyleID=s.StyleID)
	WHERE 1=1
	and BrandCode in ('BELTONE','GNR')
	AND mr.ProductTypeCode IS NOT NULL
	--and mr.ProductModelCode not in (
	--								SELECT  distinct fvr.ProductModelCode
	--								FROM catalog.FeatureValueRules fvr
	--								left join catalog.FeatureValues fv on (fv.FeatureValueID=fvr.FeatureValueID)
	--								left join (select distinct BrandCode, BrandFamilyCode from catalog.ProductModelRules where BrandCode is not null) pmr on (pmr.BrandFamilyCode=fvr.BrandFamilyCode)
	--								WHERE 1=1
	--								and  fv.FeatureName IN ('HOUSING COLOR')
	--								and fvr.ProductModelCode is not null
	--								)
    ) a
join
(
SELECT pmr.BrandCode,fv.FeatureValueCode,fv.Description,fvr.BrandFamilyCode,fvr.ProductModelCode
--,* 
FROM catalog.FeatureValueRules fvr
left join catalog.FeatureValues fv on (fv.FeatureValueID=fvr.FeatureValueID)
left join (select distinct BrandCode, BrandFamilyCode from catalog.ProductModelRules where BrandCode is not null) pmr on (pmr.BrandFamilyCode=fvr.BrandFamilyCode)
WHERE 1=1
and  fv.FeatureName IN ('HOUSING COLOR')
and fvr.ProductModelCode is null
) b on (a.BrandCode=b.BrandCode and a.BrandFamilyCode=b.BrandFamilyCode )
where 1=1
and b.FeatureValueCode is not null

-----------------------------------------------------------------------------------------------------------------------------------------------------------------------------

-- POWER LEVEL (Only for custom items)(RECIEVER_POWER) - Attribute Values - ShellCode is the custom item
-- Reciever powers for custom items which are based on style codes like IIC, ITE

INSERT INTO catalog.ItemMasterAttributeValues_Staging
select 
DISTINCT
a.BrandCode
,'RECIEVER_POWER' AttributeCode
,a.ItemCode
,b.FeatureValueCode
,1 IsActive
,a.ProductModelCode
,'NA' Modifier
,b.Description 


from (
	
	select 
	distinct
	replace(mr.FamilyProductCode,' ','')+'_'+replace(mr.ProductModelCode,' ','') ItemCode
	,'HA' Type
	,mr.BrandCode
	,mr.BrandFamilyCode
	,mr.FamilyProductCode
	,mr.ProductModelCode
	,case when mr.ProductTypeCode like '%RIE%' then 'RIE' ELSE substring( LEFT(s.StyleCode, charindex('CATALOG', s.StyleCode)-1), CHARINDEX('EDI_', s.StyleCode) + len('EDI_'), LEN(s.StyleCode))  END StyleCode
	,mr.ProductTypeCode
	,mr.ShellCode
	,isnull(mr.ProductTypeCode,mr.ShellCode) StyleCode1
	,s.StyleCode StypleCode_temp
	,1 IsActive
	from [catalog].[ProductModelRules] mr
	left join [catalog].[Styles] s on (mr.StyleID=s.StyleID)
	WHERE 1=1
	and BrandCode in ('BELTONE','GNR')
	and mr.ShellCode is not NULL
	) a
join
(
SELECT pmr.BrandCode,fvr.ShellCode,fv.FeatureValueCode,fv.Description,fvr.BrandFamilyCode,fvr.ProductModelCode

FROM catalog.FeatureValueRules fvr
left join catalog.FeatureValues fv on (fv.FeatureValueID=fvr.FeatureValueID)
left join (select distinct BrandCode, BrandFamilyCode from catalog.ProductModelRules where BrandCode is not null) pmr on (pmr.BrandFamilyCode=fvr.BrandFamilyCode)
WHERE 1=1
and  fv.FeatureName IN ('POWER LEVEL')
) b on (a.BrandCode=b.BrandCode and a.BrandFamilyCode=b.BrandFamilyCode and a.ShellCode=b.ShellCode)
where 1=1
and b.FeatureValueCode is not null




-- Reciever powers for RIE/BTE styles like (STANDARD RIE, RIE BTE 63)

INSERT INTO catalog.ItemMasterAttributeValues_Staging
select 
DISTINCT
a.BrandCode
,'RECIEVER_POWER' AttributeCode
,a.ItemCode
,b.FeatureValueCode
,1 IsActive
,a.ProductModelCode
,'NA' Modifier
,b.Description 
from (	
	select 
	distinct
	replace(mr.FamilyProductCode,' ','')+'_'+replace(mr.ProductModelCode,' ','') ItemCode
	,'HA' Type
	,mr.BrandCode
	,mr.BrandFamilyCode
	,mr.FamilyProductCode
	,mr.ProductModelCode
	,case when mr.ProductTypeCode like '%RIE%' then 'RIE' ELSE substring( LEFT(s.StyleCode, charindex('CATALOG', s.StyleCode)-1), CHARINDEX('EDI_', s.StyleCode) + len('EDI_'), LEN(s.StyleCode))  END StyleCode
	,mr.ProductTypeCode
	,mr.ShellCode
	,isnull(mr.ProductTypeCode,mr.ShellCode) StyleCode1
	,s.StyleCode StypleCode_temp
	,1 IsActive
	from [catalog].[ProductModelRules] mr
	left join [catalog].[Styles] s on (mr.StyleID=s.StyleID)
	WHERE 1=1
	and BrandCode in ('BELTONE','GNR')
	and mr.ProductTypeCode is not NULL
	) a
join
(
SELECT pmr.BrandCode,fvr.ShellCode,fv.FeatureValueCode,fv.Description,fvr.BrandFamilyCode,fvr.ProductModelCode
,fvr.ProductTypeCode
FROM catalog.FeatureValueRules fvr
left join catalog.FeatureValues fv on (fv.FeatureValueID=fvr.FeatureValueID)
left join (select distinct BrandCode, BrandFamilyCode from catalog.ProductModelRules where BrandCode is not null) pmr on (pmr.BrandFamilyCode=fvr.BrandFamilyCode)
WHERE 1=1
and  fv.FeatureName IN ('CRT POWER')
) b on (a.BrandCode=b.BrandCode and a.BrandFamilyCode=b.BrandFamilyCode and a.ProductTypeCode=b.ProductTypeCode)
where 1=1


-----------------------------------------------------------------------------------------------------------------------------------------------------------------------------

-- CRT SIZE (RECIEVER_SIZES) - Attribute Values
-- Reciever sizes are needed only for RIE & BTE items and they are based on ProductTypeCode like RIE BTE 64, POWER BTE

INSERT INTO catalog.ItemMasterAttributeValues_Staging
select 
DISTINCT
a.BrandCode
,'RECIEVER_SIZES' AttributeCode
,a.ItemCode
,b.FeatureValueCode
,1 IsActive
,a.ProductModelCode
,'NA' Modifier
,b.Description 
--,a.ProductTypeCode,b.ProductTypeCode

from (
	
	select 
	distinct
	replace(mr.FamilyProductCode,' ','')+'_'+replace(mr.ProductModelCode,' ','') ItemCode
	,'HA' Type
	,mr.BrandCode
	,mr.BrandFamilyCode
	,mr.FamilyProductCode
	,mr.ProductModelCode
	,case when mr.ProductTypeCode like '%RIE%' then 'RIE' ELSE substring( LEFT(s.StyleCode, charindex('CATALOG', s.StyleCode)-1), CHARINDEX('EDI_', s.StyleCode) + len('EDI_'), LEN(s.StyleCode))  END StyleCode
	,mr.ProductTypeCode
	,mr.ShellCode
	,isnull(mr.ProductTypeCode,mr.ShellCode) StyleCode1
	,s.StyleCode StypleCode_temp
	,1 IsActive
	from [catalog].[ProductModelRules] mr
	left join [catalog].[Styles] s on (mr.StyleID=s.StyleID)
	WHERE 1=1
	and BrandCode in ('BELTONE','GNR')
	and mr.ProductTypeCode is not NULL
	) a
join
(
SELECT DISTINCT
fvr.ProductTypeCode,fv.FeatureValueCode,fv.Description,fvr.BrandFamilyCode,fvr.ProductModelCode
,fv.FeatureName
FROM catalog.FeatureValueRules fvr
left join catalog.FeatureValues fv on (fv.FeatureValueID=fvr.FeatureValueID)
WHERE 1=1
and  fv.FeatureName IN ('CRT SIZE')
) b on (a.ProductTypeCode=b.ProductTypeCode)
where 1=1

-----------------------------------------------------------------------------------------------------------------------------------------------------------------------------

-- FACEPLATE COLOR (COLOR) - only for CUSTOM items
-- Shell Code is for CUSTOM items - COLOR for Custom 
-- We have 6 rules for loading COLOR for CUSTOM items 

INSERT INTO catalog.ItemMasterAttributeValues_Staging

-- Rule 1 - based on Brand
select 
DISTINCT
a.BrandCode
,'COLOR' AttributeCode
,a.ItemCode
,b.FeatureValueCode
,1 IsActive
,a.ProductModelCode
,'NA' Modifier
,b.Description 
--
--,a.BrandFamilyCode
--,a.ShellCode


from (
	
	select 
	distinct
	replace(mr.FamilyProductCode,' ','')+'_'+replace(mr.ProductModelCode,' ','') ItemCode
	,'HA' Type
	,mr.BrandCode
	,mr.BrandFamilyCode
	,mr.FamilyProductCode
	,mr.ProductModelCode
	,case when mr.ProductTypeCode like '%RIE%' then 'RIE' ELSE substring( LEFT(s.StyleCode, charindex('CATALOG', s.StyleCode)-1), CHARINDEX('EDI_', s.StyleCode) + len('EDI_'), LEN(s.StyleCode))  END StyleCode
	,mr.ProductTypeCode
	,mr.ShellCode
	,isnull(mr.ProductTypeCode,mr.ShellCode) StyleCode1
	,s.StyleCode StypleCode_temp
	,1 IsActive
	from [catalog].[ProductModelRules] mr
	left join [catalog].[Styles] s on (mr.StyleID=s.StyleID)
	WHERE 1=1
	and BrandCode in ('BELTONE','GNR')
	and mr.ShellCode is not null
    ) a
JOIN
(

	SELECT distinct
	fv.description,fv.featurevaluecode, fvr.brandcode,fvr.brandfamilycode
	,fvr.shellcode
	--,*  
	FROM   catalog.FeatureValueRules fvr
	left join  catalog.FeatureValues  fv on (fvr.FeatureValueID=fv.FeatureValueID AND fv.FeatureName IN ('FACEPLATE COLOR') )
	LEFT JOIN catalog.Features f ON (fv.FeatureID=f.FeatureID)
	LEFT JOIN catalog.Styles s ON (s.StyleID=f.StyleID AND s.StyleName='EDI_EMCATALOG')
	where 1=1  
	AND fv.description IS NOT NULL
	AND ISNULL(fvr.ProductModelCode,'') <> 'ENCASED'
	--ORDER BY fv.description,fvr.brandcode,fvr.brandfamilycode,fvr.shellcode
	AND fvr.BrandCode IS NOT NULL
	AND fvr.BrandFamilyCode IS NULL
	AND fvr.ShellCode IS null

  ) b ON (a.BrandCode=b.BrandCode)


UNION 

-- Rule 2 - based on Family
select 
DISTINCT
a.BrandCode
,'COLOR' AttributeCode
,a.ItemCode
,b.FeatureValueCode
,1 IsActive
,a.ProductModelCode
,'NA' Modifier
,b.Description 
--
--,a.BrandFamilyCode
--,a.ShellCode


from (
	
	select 
	distinct
	replace(mr.FamilyProductCode,' ','')+'_'+replace(mr.ProductModelCode,' ','') ItemCode
	,'HA' Type
	,mr.BrandCode
	,mr.BrandFamilyCode
	,mr.FamilyProductCode
	,mr.ProductModelCode
	,case when mr.ProductTypeCode like '%RIE%' then 'RIE' ELSE substring( LEFT(s.StyleCode, charindex('CATALOG', s.StyleCode)-1), CHARINDEX('EDI_', s.StyleCode) + len('EDI_'), LEN(s.StyleCode))  END StyleCode
	,mr.ProductTypeCode
	,mr.ShellCode
	,isnull(mr.ProductTypeCode,mr.ShellCode) StyleCode1
	,s.StyleCode StypleCode_temp
	,1 IsActive
	from [catalog].[ProductModelRules] mr
	left join [catalog].[Styles] s on (mr.StyleID=s.StyleID)
	WHERE 1=1
	and BrandCode in ('BELTONE','GNR')
	and mr.ShellCode is not null
    ) a
JOIN
(

	SELECT distinct
	fv.description,fv.featurevaluecode, fvr.brandcode,fvr.brandfamilycode
	,fvr.shellcode
	--,*  
	FROM   catalog.FeatureValueRules fvr
	left join  catalog.FeatureValues  fv on (fvr.FeatureValueID=fv.FeatureValueID AND fv.FeatureName IN ('FACEPLATE COLOR') )
	LEFT JOIN catalog.Features f ON (fv.FeatureID=f.FeatureID)
	LEFT JOIN catalog.Styles s ON (s.StyleID=f.StyleID AND s.StyleName='EDI_EMCATALOG')
	where 1=1  
	AND fv.description IS NOT NULL
	AND ISNULL(fvr.ProductModelCode,'') <> 'ENCASED'
	--ORDER BY fv.description,fvr.brandcode,fvr.brandfamilycode,fvr.shellcode
	AND fvr.BrandCode IS NULL
	AND fvr.BrandFamilyCode IS NOT NULL
	AND fvr.ShellCode IS null

  ) b ON (a.BrandFamilyCode=b.BrandFamilyCode)


  UNION 

-- Rule 3 - based on ShellCode
select 
DISTINCT
a.BrandCode
,'COLOR' AttributeCode
,a.ItemCode
,b.FeatureValueCode
,1 IsActive
,a.ProductModelCode
,'NA' Modifier
,b.Description 
--
--,a.BrandFamilyCode
--,a.ShellCode


from (
	
	select 
	distinct
	replace(mr.FamilyProductCode,' ','')+'_'+replace(mr.ProductModelCode,' ','') ItemCode
	,'HA' Type
	,mr.BrandCode
	,mr.BrandFamilyCode
	,mr.FamilyProductCode
	,mr.ProductModelCode
	,case when mr.ProductTypeCode like '%RIE%' then 'RIE' ELSE substring( LEFT(s.StyleCode, charindex('CATALOG', s.StyleCode)-1), CHARINDEX('EDI_', s.StyleCode) + len('EDI_'), LEN(s.StyleCode))  END StyleCode
	,mr.ProductTypeCode
	,mr.ShellCode
	,isnull(mr.ProductTypeCode,mr.ShellCode) StyleCode1
	,s.StyleCode StypleCode_temp
	,1 IsActive
	from [catalog].[ProductModelRules] mr
	left join [catalog].[Styles] s on (mr.StyleID=s.StyleID)
	WHERE 1=1
	and BrandCode in ('BELTONE','GNR')
	and mr.ShellCode is not null
    ) a
JOIN
(

	SELECT distinct
	fv.description,fv.featurevaluecode, fvr.brandcode,fvr.brandfamilycode
	,fvr.shellcode
	--,*  
	FROM   catalog.FeatureValueRules fvr
	left join  catalog.FeatureValues  fv on (fvr.FeatureValueID=fv.FeatureValueID AND fv.FeatureName IN ('FACEPLATE COLOR') )
	LEFT JOIN catalog.Features f ON (fv.FeatureID=f.FeatureID)
	LEFT JOIN catalog.Styles s ON (s.StyleID=f.StyleID AND s.StyleName='EDI_EMCATALOG')
	where 1=1  
	AND fv.description IS NOT NULL
	AND ISNULL(fvr.ProductModelCode,'') <> 'ENCASED'
	--ORDER BY fv.description,fvr.brandcode,fvr.brandfamilycode,fvr.shellcode
	AND fvr.BrandCode IS NULL
	AND fvr.BrandFamilyCode IS NULL
	AND fvr.ShellCode IS NOT null

  ) b ON (a.ShellCode=b.ShellCode)


  UNION 

-- Rule 4 - based on Brand & ShellCode
select 
DISTINCT
a.BrandCode
,'COLOR' AttributeCode
,a.ItemCode
,b.FeatureValueCode
,1 IsActive
,a.ProductModelCode
,'NA' Modifier
,b.Description 
--
--,a.BrandFamilyCode
--,a.ShellCode


from (
	
	select 
	distinct
	replace(mr.FamilyProductCode,' ','')+'_'+replace(mr.ProductModelCode,' ','') ItemCode
	,'HA' Type
	,mr.BrandCode
	,mr.BrandFamilyCode
	,mr.FamilyProductCode
	,mr.ProductModelCode
	,case when mr.ProductTypeCode like '%RIE%' then 'RIE' ELSE substring( LEFT(s.StyleCode, charindex('CATALOG', s.StyleCode)-1), CHARINDEX('EDI_', s.StyleCode) + len('EDI_'), LEN(s.StyleCode))  END StyleCode
	,mr.ProductTypeCode
	,mr.ShellCode
	,isnull(mr.ProductTypeCode,mr.ShellCode) StyleCode1
	,s.StyleCode StypleCode_temp
	,1 IsActive
	from [catalog].[ProductModelRules] mr
	left join [catalog].[Styles] s on (mr.StyleID=s.StyleID)
	WHERE 1=1
	and BrandCode in ('BELTONE','GNR')
	and mr.ShellCode is not null
    ) a
JOIN
(

	SELECT distinct
	fv.description,fv.featurevaluecode, fvr.brandcode,fvr.brandfamilycode
	,fvr.shellcode
	--,*  
	FROM   catalog.FeatureValueRules fvr
	left join  catalog.FeatureValues  fv on (fvr.FeatureValueID=fv.FeatureValueID AND fv.FeatureName IN ('FACEPLATE COLOR') )
	LEFT JOIN catalog.Features f ON (fv.FeatureID=f.FeatureID)
	LEFT JOIN catalog.Styles s ON (s.StyleID=f.StyleID AND s.StyleName='EDI_EMCATALOG')
	where 1=1  
	AND fv.description IS NOT NULL
	AND ISNULL(fvr.ProductModelCode,'') <> 'ENCASED'
	--ORDER BY fv.description,fvr.brandcode,fvr.brandfamilycode,fvr.shellcode
	AND fvr.BrandCode IS NOT NULL
	AND fvr.BrandFamilyCode IS NULL
	AND fvr.ShellCode IS NOT null

  ) b ON (a.BrandCode=b.BrandCode AND a.ShellCode=b.ShellCode)


  UNION 

-- Rule 5 - based on Family & ShellCode
select 
DISTINCT
a.BrandCode
,'COLOR' AttributeCode
,a.ItemCode
,b.FeatureValueCode
,1 IsActive
,a.ProductModelCode
,'NA' Modifier
,b.Description 
--
--,a.BrandFamilyCode
--,a.ShellCode


from (
	
	select 
	distinct
	replace(mr.FamilyProductCode,' ','')+'_'+replace(mr.ProductModelCode,' ','') ItemCode
	,'HA' Type
	,mr.BrandCode
	,mr.BrandFamilyCode
	,mr.FamilyProductCode
	,mr.ProductModelCode
	,case when mr.ProductTypeCode like '%RIE%' then 'RIE' ELSE substring( LEFT(s.StyleCode, charindex('CATALOG', s.StyleCode)-1), CHARINDEX('EDI_', s.StyleCode) + len('EDI_'), LEN(s.StyleCode))  END StyleCode
	,mr.ProductTypeCode
	,mr.ShellCode
	,isnull(mr.ProductTypeCode,mr.ShellCode) StyleCode1
	,s.StyleCode StypleCode_temp
	,1 IsActive
	from [catalog].[ProductModelRules] mr
	left join [catalog].[Styles] s on (mr.StyleID=s.StyleID)
	WHERE 1=1
	and BrandCode in ('BELTONE','GNR')
	and mr.ShellCode is not null
    ) a
JOIN
(

	SELECT distinct
	fv.description,fv.featurevaluecode, fvr.brandcode,fvr.brandfamilycode
	,fvr.shellcode
	--,*  
	FROM   catalog.FeatureValueRules fvr
	left join  catalog.FeatureValues  fv on (fvr.FeatureValueID=fv.FeatureValueID AND fv.FeatureName IN ('FACEPLATE COLOR') )
	LEFT JOIN catalog.Features f ON (fv.FeatureID=f.FeatureID)
	LEFT JOIN catalog.Styles s ON (s.StyleID=f.StyleID AND s.StyleName='EDI_EMCATALOG')
	where 1=1  
	AND fv.description IS NOT NULL
	AND ISNULL(fvr.ProductModelCode,'') <> 'ENCASED'
	--ORDER BY fv.description,fvr.brandcode,fvr.brandfamilycode,fvr.shellcode
	AND fvr.BrandCode IS  NULL
	AND fvr.BrandFamilyCode IS NOT NULL
	AND fvr.ShellCode IS NOT null

  ) b ON (a.BrandFamilyCode=b.BrandFamilyCode AND a.ShellCode=b.ShellCode)


  UNION 

-- Rule 6 - based on Brand, Family & ShellCode
select 
DISTINCT
a.BrandCode
,'COLOR' AttributeCode
,a.ItemCode
,b.FeatureValueCode
,1 IsActive
,a.ProductModelCode
,'NA' Modifier
,b.Description 
--
--,a.BrandFamilyCode
--,a.ShellCode


from (
	
	select 
	distinct
	replace(mr.FamilyProductCode,' ','')+'_'+replace(mr.ProductModelCode,' ','') ItemCode
	,'HA' Type
	,mr.BrandCode
	,mr.BrandFamilyCode
	,mr.FamilyProductCode
	,mr.ProductModelCode
	,case when mr.ProductTypeCode like '%RIE%' then 'RIE' ELSE substring( LEFT(s.StyleCode, charindex('CATALOG', s.StyleCode)-1), CHARINDEX('EDI_', s.StyleCode) + len('EDI_'), LEN(s.StyleCode))  END StyleCode
	,mr.ProductTypeCode
	,mr.ShellCode
	,isnull(mr.ProductTypeCode,mr.ShellCode) StyleCode1
	,s.StyleCode StypleCode_temp
	,1 IsActive
	from [catalog].[ProductModelRules] mr
	left join [catalog].[Styles] s on (mr.StyleID=s.StyleID)
	WHERE 1=1
	and BrandCode in ('BELTONE','GNR')
	and mr.ShellCode is not null
    ) a
JOIN
(

	SELECT distinct
	fv.description,fv.featurevaluecode, fvr.brandcode,fvr.brandfamilycode
	,fvr.shellcode
	--,*  
	FROM   catalog.FeatureValueRules fvr
	left join  catalog.FeatureValues  fv on (fvr.FeatureValueID=fv.FeatureValueID AND fv.FeatureName IN ('FACEPLATE COLOR') )
	LEFT JOIN catalog.Features f ON (fv.FeatureID=f.FeatureID)
	LEFT JOIN catalog.Styles s ON (s.StyleID=f.StyleID AND s.StyleName='EDI_EMCATALOG')
	where 1=1  
	AND fv.description IS NOT NULL
	AND ISNULL(fvr.ProductModelCode,'') <> 'ENCASED'
	--ORDER BY fv.description,fvr.brandcode,fvr.brandfamilycode,fvr.shellcode
	AND fvr.BrandCode IS NOT NULL
	AND fvr.BrandFamilyCode IS NOT NULL
	AND fvr.ShellCode IS NOT null

  ) b ON (a.BrandCode=b.BrandCode and a.BrandFamilyCode=b.BrandFamilyCode AND a.ShellCode=b.ShellCode)

  UNION

  -- Rule 7 - based on Brand, Family
select 
DISTINCT
a.BrandCode
,'COLOR' AttributeCode
,a.ItemCode
,b.FeatureValueCode
,1 IsActive
,a.ProductModelCode
,'NA' Modifier
,b.Description 
--
--,a.BrandFamilyCode
--,a.ShellCode


from (
	
	select 
	distinct
	replace(mr.FamilyProductCode,' ','')+'_'+replace(mr.ProductModelCode,' ','') ItemCode
	,'HA' Type
	,mr.BrandCode
	,mr.BrandFamilyCode
	,mr.FamilyProductCode
	,mr.ProductModelCode
	,case when mr.ProductTypeCode like '%RIE%' then 'RIE' ELSE substring( LEFT(s.StyleCode, charindex('CATALOG', s.StyleCode)-1), CHARINDEX('EDI_', s.StyleCode) + len('EDI_'), LEN(s.StyleCode))  END StyleCode
	,mr.ProductTypeCode
	,mr.ShellCode
	,isnull(mr.ProductTypeCode,mr.ShellCode) StyleCode1
	,s.StyleCode StypleCode_temp
	,1 IsActive
	from [catalog].[ProductModelRules] mr
	left join [catalog].[Styles] s on (mr.StyleID=s.StyleID)
	WHERE 1=1
	and BrandCode in ('BELTONE','GNR')
	and mr.ShellCode is not null
    ) a
JOIN
(

	SELECT distinct
	fv.description,fv.featurevaluecode, fvr.brandcode,fvr.brandfamilycode
	,fvr.shellcode
	--,*  
	FROM   catalog.FeatureValueRules fvr
	left join  catalog.FeatureValues  fv on (fvr.FeatureValueID=fv.FeatureValueID AND fv.FeatureName IN ('FACEPLATE COLOR') )
	LEFT JOIN catalog.Features f ON (fv.FeatureID=f.FeatureID)
	LEFT JOIN catalog.Styles s ON (s.StyleID=f.StyleID AND s.StyleName='EDI_EMCATALOG')
	where 1=1  
	AND fv.description IS NOT NULL
	AND ISNULL(fvr.ProductModelCode,'') <> 'ENCASED'
	--ORDER BY fv.description,fvr.brandcode,fvr.brandfamilycode,fvr.shellcode
	AND fvr.BrandCode IS NOT NULL
	AND fvr.BrandFamilyCode IS NOT NULL
	AND fvr.ShellCode IS null

  ) b ON (a.BrandCode=b.BrandCode and a.BrandFamilyCode=b.BrandFamilyCode)


-- Attribute CONNECTIVITY for both CUSTOM & BTE products
-- Connectivity is classified based on FamilyCode & ProductType

INSERT INTO catalog.ItemMasterAttributeValues_Staging
SELECT DISTINCT
a.BrandCode, 'CONNECTIVITY' AttributeCode, a.ItemCode, b.TechnologyLevelCode, 1, a.ProductModelCode, 'NA', b.TechnologyLevelCode
--b.*
FROM
(
	select 
	distinct
	replace(mr.FamilyProductCode,' ','')+'_'+replace(mr.ProductModelCode,' ','') ItemCode
	,'HA' Type
	,mr.BrandCode
	,mr.BrandFamilyCode
	,mr.FamilyProductCode
	,mr.ProductModelCode
	,case when (mr.ProductTypeCode IS NOT NULL AND mr.ProductTypeCode like '%RIE%') then 'RIE' 
		  WHEN (mr.ProductTypeCode IS NOT NULL AND mr.ProductTypeCode NOT like '%RIE%') THEN 'BTE'
		  WHEN (mr.ProductTypeCode IS NULL)  THEN mr.ShellCode END StyleCode
	,isnull(mr.ProductTypeCode,mr.ShellCode) StyleCode1
	from [catalog].[ProductModelRules] mr
	left join [catalog].[Styles] s on (mr.StyleID=s.StyleID)
	WHERE 1=1
	and BrandCode in ('BELTONE','GNR')
	) a
JOIN 
(
	SELECT 
	tlr.BrandFamilyCode, tlr.ProductTypeCode, tlr.TechnologyLevelCode
	FROM catalog.TechnologyLevelRules tlr
	WHERE 1=1
	AND tlr.ProductTypeCode IS NOT NULL
) b ON (a.BrandFamilyCode=b.BrandFamilyCode AND a.StyleCode1=b.ProductTypeCode)


-- Attribute PRODUCT_TYPE for both CUSTOM & BTE products
-- We will have only one attribute for each HA

INSERT INTO catalog.ItemMasterAttributeValues_Staging
SELECT DISTINCT
a.BrandCode, 'PRODUCT_TYPE' AttributeCode, a.ItemCode, a.StyleCode1, 1, a.ProductModelCode, 'NA', a.StyleCode1
--b.*
FROM
(
	select 
	distinct
	replace(mr.FamilyProductCode,' ','')+'_'+replace(mr.ProductModelCode,' ','') ItemCode
	,'HA' Type
	,mr.BrandCode
	,mr.BrandFamilyCode
	,mr.FamilyProductCode
	,mr.ProductModelCode
	,case when (mr.ProductTypeCode IS NOT NULL AND mr.ProductTypeCode like '%RIE%') then 'RIE' 
		  WHEN (mr.ProductTypeCode IS NOT NULL AND mr.ProductTypeCode NOT like '%RIE%') THEN 'BTE'
		  WHEN (mr.ProductTypeCode IS NULL)  THEN mr.ShellCode END StyleCode
	,isnull(mr.ProductTypeCode,mr.ShellCode) StyleCode1
	from [catalog].[ProductModelRules] mr
	left join [catalog].[Styles] s on (mr.StyleID=s.StyleID)
	WHERE 1=1
	and BrandCode in ('BELTONE','GNR')
	) a



	COMMIT TRANSACTION BT_GNR_ItemMaster_Rules_To_Stg
	PRINT 'SUCCESS'
	

	END TRY
	

	BEGIN CATCH

	DECLARE @ErrorMessage NVARCHAR(4000);  
    DECLARE @ErrorSeverity INT;  
    DECLARE @ErrorState INT;  

    SELECT   
        @ErrorMessage = ERROR_MESSAGE(),  
        @ErrorSeverity = ERROR_SEVERITY(),  
        @ErrorState = ERROR_STATE();  

		IF (@@TRANCOUNT > 0)
		BEGIN
			ROLLBACK TRANSACTION BT_GNR_ItemMaster_Rules_To_Stg
			RAISERROR(@ErrorMessage,@ErrorSeverity,@ErrorState);
			PRINT 'FAILED'
		END

	END CATCH
END



-- EXEC [catalog].[sp_ssis_UNITRON_ItemMaster_Temp_To_Stg]

CREATE PROCEDURE [catalog].[sp_ssis_UNITRON_ItemMaster_Temp_To_Stg]
AS 


BEGIN

	BEGIN TRY
	BEGIN TRANSACTION UNITRON_ItemMaster_Temp_To_Stg

	-- Check column datatype and length
	-- ALTER TABLE [catalog].[UnitronProductTemp] ALTER COLUMN [styles] nvarchar(255) NULL;




-------------------------------------------------- Manual updates because of missing info. in catalog file Start --------------------------------------------------------------------------------------------------------

-- Update model names with superscript
update id
set en = case when en='Quantum E S' THEN 'Quantum2 E S'
		    when en='Quantum 10 S' THEN 'Quantum2 10 S'
			ELSE en end
--select case when en='Quantum E S' THEN 'Quantum2 E S'
--		    when en='Quantum 10 S' THEN 'Quantum2 10 S'
--			ELSE en end en
--			,en en1
from [catalog].[UnitronIdentifierTemp] id
where 1=1
and en in ('Quantum E S','Quantum 10 S')


-- Family info. is missing for the following models in catalog file
-- Covered in HA section
/*
select * 
from [catalog].[UnitronIdentifierTemp] id
left join [catalog].[UnitronFamilyNameTemp] fn on (id.product_Id=fn.product_Id)
left join [catalog].[UnitronFamilyTemp] f on (f.family_Id=fn.family_Id)
where 1=1
and id.en in (
'Quantum E S'
,'Quantum 10 S'
,'Vista T 610 M 312'
,'Vista T 810 M 312'
)
*/

-- ModelType for 'Stride 500 10A IIC' is given as 'DOME_OPEN' instead of 'IIC'
update m
set m.code='IIC'
--select m.code,'IIC',*
from [catalog].[UnitronModelTypeTemp] m
left join [catalog].[UnitronIdentifierTemp] i on (m.product_Id=i.product_Id)
where 1=1
and i.en ='Stride 500 10A IIC'

-- Incorrect identifier description in catalog file, color is embedded by mistake in it
update id
set id.en = case when id.en ='FLEX:TRIAL Max SP Beige' then 'Max SP FLEX:TRIAL'
                 when id.en ='Max 6 SPm Light Gray' then 'Max 6 SPm'
				 else id.en end
from [catalog].[UnitronIdentifierTemp] id
where 1=1
and en in ('FLEX:TRIAL Max SP Beige','Max 6 SPm Light Gray')



-------------------------------------------------- Manual updates because of missing info. in catalog file Start --------------------------------------------------------------------------------------------------------





-----------------------------------------------------------------------------------------------------------------------------------------------------------------------------
-- Delete all UNITRON HA's  and attributes in stg table 
DELETE FROM catalog.ItemMasterList_Staging WHERE BrandCode = 'UNITRON'
DELETE FROM catalog.ItemMasterAttributeValues_Staging WHERE Brandcode='UNITRON'
-----------------------------------------------------------------------------------------------------------------------------------------------------------------------------






-------------------------------------------------- Hearing Aids Start --------------------------------------------------------------------------------------------------------
-- Insert all HA items to staging table
INSERT INTO [catalog].[ItemMasterList_Staging]
select 
distinct
--pl.code
case when id.en like 'T Stride M%' and id.en not in ('T Stride M FLEX:TRIAL') then pln.en+'_'+mn.en+' '+pln.en
     else pln.en+'_'+id.en end ItemCode

	 --,pln.en, mn.en, id.en
,'HA' ItemType
,'UNITRON' BrandCode
,case when id.en in ('Quantum2 E S','Quantum2 10 S') then 'Quantum2'
      when id.en in ('Vista T 610 M 312')  then 'Vista Tempus BTE'
	  when id.en in ('Vista T 810 M 312')  then 'Vista Tempus BTE'
      else f.en end FamilyCode
,pln.en TechnologyCode
,case when id.en like 'T Stride M%' and id.en not in ('T Stride M FLEX:TRIAL') then mn.en+' '+pln.en
 else id.en end ModelCode
--,mn.en
,case when 'RIC,' IN (select value from STRING_SPLIT(s.styles,' ')) then 'RIC'
	  when 'BTE,' IN (select value from STRING_SPLIT(s.styles,' ')) then 'BTE'
	  when 'ITC,' IN (select value from STRING_SPLIT(s.styles,' ')) then 'ITC'
	  when 'ITE,' IN (select value from STRING_SPLIT(s.styles,' ')) then 'ITE'
	  when id.en in ('Vista T 610 M 312')  then 'BTE'
	  when id.en in ('Vista T 810 M 312')  then 'BTE'
	  when s.styles is null and  f.en like 'Vista Tempus BTE' and (fn.type is null or fn.type = 'RICBTE' ) then 'BTE'
	  when s.styles is null and  f.en like 'Vista Tempus RIC' then 'RIC'
	  when s.styles is null and  ISNULL(fn.type,' ')='ITECustom' then 'ITE'
	  when s.styles = 'Slim' and  ISNULL(fn.type,' ')='ITECustom' then 'ITE'
	  when id.en  in ('Stride M 500','Stride P 500') then 'BTE'
	  when id.en in ('T Max UP FLEX:TRIAL') then 'BTE'
	  when id.en like 'T Max %P%' then 'BTE'
	  else s.styles end StyleCode
	  ,1
	 --,substring(c.code,1,8)
	 --,mn.en
	 --,id.en
	 --,m.code
	 --,m.name
	 --,fn.code
	 --,fn.type
	 --,f.en
	 --,pl.code
	 --,pln.en
	 --,s.styles

from [catalog].[UnitronProductTemp] p -- Product
left join [catalog].[UnitronCodeTemp] c on (c.product_Id=p.product_Id)
left join [catalog].[UnitronIdentifierTemp] id on (id.product_Id=p.product_Id) -- Model Code
left join [catalog].[UnitronModelTypeTemp] m on (m.product_Id=p.product_Id) -- Battery/Power
left join [catalog].[UnitronModelTypeNameTemp] mn on (mn.ModelTypeId=m.ModelTypeId) -- Battery/Power
-- Family
left join [catalog].[UnitronFamilyNameTemp] fn on (fn.product_Id=p.product_Id)
left join [catalog].[UnitronFamilyTemp] f on (f.family_Id=fn.family_Id)		 
-- Technology Code
left join [catalog].[UnitronPerformanceLevelTemp] pl on (pl.product_Id=p.product_Id)
left join [catalog].[UnitronPerformanceLevelNameTemp] pln on (pln.performanceLevel_Id=pl.performanceLevel_Id)
--styles
left join [catalog].[UnitronStylesTemp] s on (s.product_id=p.product_id)

where 1=1
and pln.en is not null
and m.code not like 'DOME_%'
and m.code not like 'RECEIVER_%'
and isnull(f.en,'') <> 'Earpieces'
and id.en not in ('FLEX:TRIAL Max SP Beige','Max 6 SPm Light Gray')

-------------------------------------------------- Hearing Aids End --------------------------------------------------------------------------------------------------------




-------------------------------------------------- Batteries Start --------------------------------------------------------------------------------------------------------
-- Load batteries for all HA's (BTE, RIC & CUSTOM)
INSERT INTO [catalog].[ItemMasterAttributeValues_Staging]
select 
DISTINCT
'UNITRON' Modelcode
,'BATTERY_SIZES' AttributeCode
,pln.en+'_'+id.en ItemCode
,b.batterySize ModelAttributeValue
,1 IsActive
,null VendorCode
,'NA' Modifier
,b.batterySize ModelAttributeValueDescription
from  [catalog].[UnitronBatterySizeTemp] b
left join [catalog].[UnitronCodeTemp] c on (c.product_Id=b.product_Id)
left join [catalog].[UnitronIdentifierTemp] id on (id.product_Id=b.product_Id)
left join [catalog].[UnitronPerformanceLevelTemp] pl on (pl.product_Id=b.product_Id)
left join [catalog].[UnitronPerformanceLevelNameTemp] pln on (pln.performanceLevel_Id=pl.performanceLevel_Id)
join catalog.ItemMasterList_Staging st on (st.ItemCode=(pln.en+'_'+id.en) and st.BrandCode = 'UNITRON')
where 1=1
and id.en not in ('FLEX:TRIAL Max SP Beige','Max 6 SPm Light Gray')

UNION

-- Batteries for models missing in API xml catalog file
select DISTINCT
'UNITRON' BrandCode
,'BATTERY_SIZES' AttributeCode
,t.ItemCode
,case when t.ItemCode like '% R %' then 'R'
      when t.ItemCode like '% 10A %'  then '10A'
	  when t.ItemCode like '% 13 %' or t.ItemCode like '% 13' then '13'
	  when t.ItemCode like '% 312 %' or t.ItemCode like '% 312' then '312'
      else NULL end ModelAttributeValue  
,1 IsActive
,NULL VendorCode
,'NA' Modifier
,case when t.ItemCode like '% R %' then 'R'
      when t.ItemCode like '% 10A %'  then '10A'
	  when t.ItemCode like '% 13 %' or t.ItemCode like '% 13' then '13'
	  when t.ItemCode like '% 312 %' or t.ItemCode like '% 312' then '312'
      else NULL end ModelAttributeValueDescription
from 
(
select distinct itemcode from 
catalog.ItemMasterList_Staging st where st.BrandCode = 'UNITRON'

except 

select 
DISTINCT
--'UNITRON'
--,'BATTERY_SIZES' AttributeCode
pln.en+'_'+id.en ItemCode
--,b.batterySize ModelAttributeValue
--,1 IsActive
--,null VendorCode
--,'NA' Modifier
--,b.batterySize ModelAttributeValueDescription
from  [catalog].[UnitronBatterySizeTemp] b
left join [catalog].[UnitronCodeTemp] c on (c.product_Id=b.product_Id)
left join [catalog].[UnitronIdentifierTemp] id on (id.product_Id=b.product_Id)
left join [catalog].[UnitronPerformanceLevelTemp] pl on (pl.product_Id=b.product_Id)
left join [catalog].[UnitronPerformanceLevelNameTemp] pln on (pln.performanceLevel_Id=pl.performanceLevel_Id)
join catalog.ItemMasterList_Staging st on (st.ItemCode=(pln.en+'_'+id.en) and st.BrandCode = 'UNITRON')
where 1=1
and id.en not in ('FLEX:TRIAL Max SP Beige','Max 6 SPm Light Gray')
) t


-------------------------------------------------- Batteries End --------------------------------------------------------------------------------------------------------



-------------------------------------------------- Color Start --------------------------------------------------------------------------------------------------------

-- BTE RIC Colors
INSERT INTO [catalog].[ItemMasterAttributeValues_Staging]
select 
DISTINCT
'UNITRON'
,'COLOR' AttributeCode
--,pln.en,id.en
--,pln.en+'_'+id.en ItemCode
,case when id.en like 'T Stride M%' and id.en not in ('T Stride M FLEX:TRIAL') then pln.en+'_'+mn.en+' '+pln.en
     else pln.en+'_'+id.en end ItemCode
,cn.en +'-'+ co.code ModelAttributeValue
,1 IsActive
,c.code VendorCode
--,id.en
,'NA' Modifier
,cn.en ModelAttributeValueDescription
--,*
from  [catalog].[UnitronProductTemp] b
left join [catalog].[UnitronCodeTemp] c on (c.product_Id=b.product_Id)
left join [catalog].[UnitronIdentifierTemp] id on (id.product_Id=b.product_Id)
left join [catalog].[UnitronPerformanceLevelTemp] pl on (pl.product_Id=b.product_Id)
left join [catalog].[UnitronModelTypeTemp] m on (m.product_Id=c.product_Id) 
left join [catalog].[UnitronModelTypeNameTemp] mn on (mn.ModelTypeId=m.ModelTypeId) 
left join [catalog].[UnitronPerformanceLevelNameTemp] pln on (pln.performanceLevel_Id=pl.performanceLevel_Id)
left join [catalog].[UnitronColorTemp] co on (co.product_Id=b.product_Id)
left join [catalog].[UnitronColorNameTemp] cn on (cn.color_Id=co.color_Id)
join catalog.ItemMasterList_Staging st on (st.ItemCode=(pln.en+'_'+id.en) and st.BrandCode = 'UNITRON')
where 1=1
and cn.en is not null
and pl.code is not null
and pln.en is not null


-- Add CUSTOM_HA attribute for all custom HA's to map its VendorCode with color code
INSERT INTO [catalog].[ItemMasterAttributeValues_Staging]
select 
DISTINCT
'UNITRON'
,'CUSTOM_HA' AttributeCode
--,pln.en,id.en
,pln.en+'_'+id.en ItemCode
,'Custom Hearing Aid' ModelAttributeValue
,1 IsActive
,left(c.code,len(c.code)-3) VendorCode
--,id.en
,'NA' Modifier
,'Custom Hearing Aid' ModelAttributeValueDescription
--,*
from  [catalog].[UnitronProductTemp] b
left join [catalog].[UnitronCodeTemp] c on (c.product_Id=b.product_Id)
left join [catalog].[UnitronIdentifierTemp] id on (id.product_Id=b.product_Id)
left join [catalog].[UnitronPerformanceLevelTemp] pl on (pl.product_Id=b.product_Id)
left join [catalog].[UnitronPerformanceLevelNameTemp] pln on (pln.performanceLevel_Id=pl.performanceLevel_Id)
left join [catalog].[UnitronOptionsTemp] co on (co.product_Id=b.product_Id and co.code='FC')
left join [catalog].[UnitronOptionsValuesTemp] cn on (cn.initialOptions_Id=co.initialOptions_Id)
join catalog.ItemMasterList_Staging st on (st.ItemCode=(pln.en+'_'+id.en) and st.BrandCode = 'UNITRON')
left join (
			select 
			DISTINCT col.code
			,coln.en
			from [catalog].[UnitronColorTemp] col
			join [catalog].[UnitronColorNameTemp] coln on (coln.color_Id=col.color_Id)
		  ) cust on (cust.code=cn.[values])
where 1=1
and cn.[values] is not null
and pl.code is not null
and pln.en is not null


-- Load available colors for all custom HA's
INSERT INTO [catalog].[ItemMasterAttributeValues_Staging]
select 
DISTINCT
'UNITRON'
,'COLOR' AttributeCode
--,pln.en,id.en
,pln.en+'_'+id.en ItemCode
,cust.en +'-'+ cn.[values] ModelAttributeValue
--,cust.en
--,cn.[values]
,1 IsActive
,left(c.code,len(c.code)-3)+'-'+cn.[values] VendorCode
--,id.en
,'NA' Modifier
,cust.en ModelAttributeValueDescription
--,*
from  [catalog].[UnitronProductTemp] b
left join [catalog].[UnitronCodeTemp] c on (c.product_Id=b.product_Id)
left join [catalog].[UnitronIdentifierTemp] id on (id.product_Id=b.product_Id)
left join [catalog].[UnitronPerformanceLevelTemp] pl on (pl.product_Id=b.product_Id)
left join [catalog].[UnitronPerformanceLevelNameTemp] pln on (pln.performanceLevel_Id=pl.performanceLevel_Id)
left join [catalog].[UnitronOptionsTemp] co on (co.product_Id=b.product_Id and co.code='FC')		-- Faceplate Color
left join [catalog].[UnitronOptionsValuesTemp] cn on (cn.initialOptions_Id=co.initialOptions_Id)
join catalog.ItemMasterList_Staging st on (st.ItemCode=(pln.en+'_'+id.en) and st.BrandCode = 'UNITRON')
left join (
			select 
			DISTINCT col.code
			,coln.en
			from [catalog].[UnitronColorTemp] col
			join [catalog].[UnitronColorNameTemp] coln on (coln.color_Id=col.color_Id)
		  ) cust on (cust.code=cn.[values])
where 1=1
and cn.[values] is not null
and pl.code is not null
and pln.en is not null

-------------------------------------------------- Color End --------------------------------------------------------------------------------------------------------


-------------------------------------------------- BTE Tubes (RECEIVER_SIZES)  Start--------------------------------------------------------------------------------------------------------

-- Load SPAREPART's tubes compatible for all BTE models
INSERT INTO [catalog].[ItemMasterAttributeValues_Staging]
SELECT
DISTINCT
'UNITRON'
,'RECIEVER_SIZES' AttributeCode
--,pln.en,id.en
,case when id.en like 'T Stride M%' and id.en not in ('T Stride M FLEX:TRIAL') then pln.en+'_'+mn.en+' '+pln.en
     else pln.en+'_'+id.en end ItemCode
,id1.en ModelAttributeValue
,1 IsActive
,r.target VendorCode
--,id.en
,case when id1.en like '%-L%' then 'LT' 
	  when id1.en like '%-R%' then 'RT' else 'NA' end Modifier
,id1.en ModelAttributeValueDescription
--,r.type,id1.en
from  [catalog].[UnitronProductTemp] b
left join [catalog].[UnitronCodeTemp] c on (c.product_Id=b.product_Id)
left join [catalog].[UnitronIdentifierTemp] id on (id.product_Id=b.product_Id)
left join [catalog].[UnitronPerformanceLevelTemp] pl on (pl.product_Id=b.product_Id)
left join [catalog].[UnitronPerformanceLevelNameTemp] pln on (pln.performanceLevel_Id=pl.performanceLevel_Id)
left join [catalog].[UnitronModelTypeTemp] m on (m.product_Id=c.product_Id) 
left join [catalog].[UnitronModelTypeNameTemp] mn on (mn.ModelTypeId=m.ModelTypeId) 
left join [catalog].[UnitronReferencesTemp] r on (r.product_Id=b.product_Id)
left join [catalog].[UnitronCodeTemp] c1 on (c1.code=r.target)
left join [catalog].[UnitronIdentifierTemp] id1 on (id1.product_Id=c1.product_Id)
join catalog.ItemMasterList_Staging st on (st.ItemCode=(pln.en+'_'+id.en) and st.BrandCode = 'UNITRON')
where 1=1
and r.type='SPAREPART'
AND id1.en like '%Slim Tube%'
and id1.en not in ('BTE Tool, Measurement tool (for Slim Tube/Receiver Length)')

-------------------------------------------------- BTE Tubes (RECEIVER_SIZES)  End --------------------------------------------------------------------------------------------------------


-------------------------------------------------- RIC Receiver Power & Sizes (RECIEVER_POWER & RECEIVER_SIZES)  Start --------------------------------------------------------------------------------------------------------

-- Receiver power and sizes are loaded from the same attribute  (NECESSARYITEMLEFT & NECESSARYITEMRIGHT references)
INSERT INTO [catalog].[ItemMasterAttributeValues_Staging]
SELECT
DISTINCT
'UNITRON'
,'RECIEVER_POWER' AttributeCode
--,pln.en,id.en
,case when id.en like 'T Stride M%' and id.en not in ('T Stride M FLEX:TRIAL') then pln.en+'_'+mn.en+' '+pln.en
     else pln.en+'_'+id.en end ItemCode
,id1.en ModelAttributeValue
,1 IsActive
,r.target VendorCode
--,r.type
,case when id1.en like '%L' or id1.en like '%Left' then 'LT' 
	  when id1.en like '%R' or id1.en like '%Right' then 'RT' 
	  else 'NA' end Modifier
,id1.en ModelAttributeValueDescription
from  [catalog].[UnitronProductTemp] b
left join [catalog].[UnitronCodeTemp] c on (c.product_Id=b.product_Id)
left join [catalog].[UnitronIdentifierTemp] id on (id.product_Id=b.product_Id)
left join [catalog].[UnitronPerformanceLevelTemp] pl on (pl.product_Id=b.product_Id)
left join [catalog].[UnitronPerformanceLevelNameTemp] pln on (pln.performanceLevel_Id=pl.performanceLevel_Id)
left join [catalog].[UnitronModelTypeTemp] m on (m.product_Id=c.product_Id) 
left join [catalog].[UnitronModelTypeNameTemp] mn on (mn.ModelTypeId=m.ModelTypeId) 
left join [catalog].[UnitronReferencesTemp] r on (r.product_Id=b.product_Id)
left join [catalog].[UnitronCodeTemp] c1 on (c1.code=r.target)
left join [catalog].[UnitronIdentifierTemp] id1 on (id1.product_Id=c1.product_Id)
join catalog.ItemMasterList_Staging st on (st.ItemCode=(pln.en+'_'+id.en) and st.BrandCode = 'UNITRON')
where 1=1
and r.type in ('NECESSARYITEMLEFT','NECESSARYITEMRIGHT','SPAREPART')
AND id1.en like '%receiver%'
and id1.en not like 'BTE Tool%'
-------------------------------------------------- RIC Receiver Power & Sizes (RECIEVER_POWER & RECEIVER_SIZES)  End --------------------------------------------------------------------------------------------------------



-------------------------------------------------- CUSTOM Receiver Power (PL) Start --------------------------------------------------------------------------------------------------------
-- CUSTOM Receivers (Power lever PL)
INSERT INTO [catalog].[ItemMasterAttributeValues_Staging]
select 
DISTINCT
'UNITRON'
,'RECIEVER_POWER' AttributeCode
--,pln.en,id.en
,pln.en+'_'+id.en ItemCode
,cust.code+'-'+cust.en ModelAttributeValue
,1 IsActive
,cn.[values] VendorCode
--,id.en
,'NA' Modifier
,cust.code ModelAttributeValueDescription
--,*
from  [catalog].[UnitronProductTemp] b
left join [catalog].[UnitronCodeTemp] c on (c.product_Id=b.product_Id)
left join [catalog].[UnitronIdentifierTemp] id on (id.product_Id=b.product_Id)
left join [catalog].[UnitronPerformanceLevelTemp] pl on (pl.product_Id=b.product_Id)
left join [catalog].[UnitronPerformanceLevelNameTemp] pln on (pln.performanceLevel_Id=pl.performanceLevel_Id)
left join [catalog].[UnitronOptionsTemp] co on (co.product_Id=b.product_Id and co.code='PL')		-- Power Level
left join [catalog].[UnitronOptionsValuesTemp] cn on (cn.initialOptions_Id=co.initialOptions_Id)
join catalog.ItemMasterList_Staging st on (st.ItemCode=(pln.en+'_'+id.en) and st.BrandCode = 'UNITRON')
left join (
			select 
			DISTINCT case when coln.en ='M' then 'Moderate' 
					      when coln.en ='P' then 'Power'
					      when coln.en ='S' then 'Standard'
					 else col.code end code
			,coln.en
			from [catalog].[UnitronPerformanceLevelTemp] col
			join [catalog].[UnitronPerformanceLevelNameTemp] coln on (coln.performanceLevel_Id=col.performanceLevel_Id)
			where 1=1
			and col.code like 'RECEIVER_%'
			UNION
			select 'Super Power','SP'
			UNION
			select 'Ultra Power','UP'   -- Add more power levels if available going forward
			UNION
			select 'None','NONE'
		  ) cust on (cust.en=cn.[values])
where 1=1
and cn.[values] is not null
-------------------------------------------------- CUSTOM Receiver Power (PL) Start --------------------------------------------------------------------------------------------------------

-------------------------------------------------- CUSTOM Shell Type (ST) Start --------------------------------------------------------------------------------------------------------
-- CUSTOM Shell Type (Shell Type ST)
INSERT INTO [catalog].[ItemMasterAttributeValues_Staging]
select 
DISTINCT
'UNITRON'
,'SHELL_TYPE' AttributeCode
--,pln.en,id.en
,pln.en+'_'+id.en ItemCode
,case when cn.[values] = 'H' then 'Half Shell'+'-'+cn.[values]
      when cn.[values] = 'N' then 'IIC'+'-'+cn.[values]
	  when cn.[values] = 'I' then 'CIC'+'-'+cn.[values]
	  when cn.[values] = 'M' then 'Mini Canal'+'-'+cn.[values]
	  when cn.[values] = 'C' then 'Canal'+'-'+cn.[values]
	  when cn.[values] = 'F' then 'Full Shell'+'-'+cn.[values]
else cn.[values] end ModelAttributeValue
,1 IsActive
,cn.[values] VendorCode
--,id.en
,'NA' Modifier
,case when cn.[values] = 'H' then 'Half Shell'
      when cn.[values] = 'N' then 'IIC'
	  when cn.[values] = 'I' then 'CIC'
	  when cn.[values] = 'M' then 'Mini Canal'
	  when cn.[values] = 'C' then 'Canal'
	  when cn.[values] = 'F' then 'Full Shell'
else cn.[values] end ModelAttributeValueDescription
--,*
from  [catalog].[UnitronProductTemp] b
left join [catalog].[UnitronCodeTemp] c on (c.product_Id=b.product_Id)
left join [catalog].[UnitronIdentifierTemp] id on (id.product_Id=b.product_Id)
left join [catalog].[UnitronPerformanceLevelTemp] pl on (pl.product_Id=b.product_Id)
left join [catalog].[UnitronPerformanceLevelNameTemp] pln on (pln.performanceLevel_Id=pl.performanceLevel_Id)
left join [catalog].[UnitronOptionsTemp] co on (co.product_Id=b.product_Id and co.code='ST')		-- Shell Style
left join [catalog].[UnitronOptionsValuesTemp] cn on (cn.initialOptions_Id=co.initialOptions_Id)
join catalog.ItemMasterList_Staging st on (st.ItemCode=(pln.en+'_'+id.en) and st.BrandCode = 'UNITRON')
left join (
			select 
			DISTINCT col.code
			,coln.en
			from [catalog].[UnitronColorTemp] col
			join [catalog].[UnitronColorNameTemp] coln on (coln.color_Id=col.color_Id)
		  ) cust on (cust.code=cn.[values])
where 1=1
and cn.[values] is not null
and pl.code is not null
and pln.en is not null
-------------------------------------------------- CUSTOM Shell Type (ST) End --------------------------------------------------------------------------------------------------------



-------------------------------------------------- Picture & Thumbnail URL's Start --------------------------------------------------------------------------------------------------------

-- Unitron pictures and thumbnail urls
/*
select 
c.code Vendor_Code
,id.en Product_Description
,pl.code PerformanceLevel_Code
,pln.en PerformanceLevel_Description
,co.code Color_Code
,co.value1 Color_RGB_or_HEX
,cn.en Color_Description
,pu.pictureURL Picture_URL
,tu.thumbnailURL Thumbnail_URL
from  [catalog].[UnitronProductTemp] b
left join [catalog].[UnitronCodeTemp] c on (c.product_Id=b.product_Id)
left join [catalog].[UnitronIdentifierTemp] id on (id.product_Id=b.product_Id)
left join [catalog].[UnitronPerformanceLevelTemp] pl on (pl.product_Id=b.product_Id)
left join [catalog].[UnitronPerformanceLevelNameTemp] pln on (pln.performanceLevel_Id=pl.performanceLevel_Id)
left join [catalog].[UnitronColorTemp] co on (co.product_Id=b.product_Id)
left join [catalog].[UnitronColorNameTemp] cn on (cn.color_Id=co.color_Id)
left join [catalog].[UnitronPictureURLTemp] pu on (pu.product_Id=b.product_Id)
left join [catalog].[UnitronThumbnailURLTemp] tu on (tu.product_Id=b.product_Id)
where 1=1
and pu.pictureURL!='https://dc-cached.phonakpro.comnull'
order by c.code
*/
-------------------------------------------------- Picture & Thumbnail URL's End --------------------------------------------------------------------------------------------------------

	COMMIT TRANSACTION UNITRON_ItemMaster_Temp_To_Stg
	PRINT 'SUCCESS'
	

	END TRY
	

	BEGIN CATCH

	DECLARE @ErrorMessage NVARCHAR(4000);  
    DECLARE @ErrorSeverity INT;  
    DECLARE @ErrorState INT;  

    SELECT   
        @ErrorMessage = ERROR_MESSAGE(),  
        @ErrorSeverity = ERROR_SEVERITY(),  
        @ErrorState = ERROR_STATE();  

		IF (@@TRANCOUNT > 0)
		BEGIN
			ROLLBACK TRANSACTION UNITRON_ItemMaster_Temp_To_Stg
			RAISERROR(@ErrorMessage,@ErrorSeverity,@ErrorState);
			PRINT 'FAILED'
		END

	END CATCH
END




-- EXEC [catalog].[sp_ssis_PHONAK_ItemMaster_Temp_To_Stg]

CREATE PROCEDURE [catalog].[sp_ssis_PHONAK_ItemMaster_Temp_To_Stg]
AS 


BEGIN

	BEGIN TRY
	BEGIN TRANSACTION PHONAK_ItemMaster_Temp_To_Stg

	-- Check column datatype and length
	-- ALTER TABLE [catalog].[PhonakProductTemp] ALTER COLUMN [styles] nvarchar(255) NULL;


	-- Insert new attributevalue code SHELL_TYPE in static table
	--    select * from catalog.ItemAttributes order by 1
	--INSERT INTO catalog.ItemAttributes
	--select 11,'SHELL_TYPE','SHELL_TYPE',1,NULL
	

-------------------------------------------------- Manual updates because of missing info. in catalog file Start --------------------------------------------------------------------------------------------------------
-- Replace special characters
UPDATE catalog.PhonakIdentifierTemp SET en = REPLACE(en,'','e')
UPDATE catalog.PhonakIdentifierTemp SET en = REPLACE(en,'','i') 

UPDATE catalog.PhonakFamilyTemp SET en = REPLACE(en,'','e')
UPDATE catalog.PhonakFamilyTemp SET en = REPLACE(en,'','i')

-- Incorrect Model description in catalog file
UPDATE [catalog].[PhonakIdentifierTemp] SET en= 'Phonak Audeo B50-13' WHERE en= 'Phonak Audeo B 50-13'

-- Incorrect Model description in catalog file
update i
set i.en='Phonak Naida Q70-RIC'
-- select i.en,'Phonak Nada Q70-RIC'
from [catalog].[PhonakIdentifierTemp] i
where 1=1
and en = 'Phonak Naida Q70 RIC'


/*
Style info. is missing for the following models
	Phonak Bolero B50-PR
	Phonak Bolero B70-PR
	Phonak Bolero B90-PR
*/ 
insert into [catalog].[PhonakStylesTemp]
select p.product_id,'BTE' styles
from [catalog].[PhonakCodeTemp] p
--left join [catalog].[PhonakIdentifierTemp] i on (i.product_Id=p.product_id)
left join [catalog].[PhonakStylesTemp] s on (s.product_id=p.product_id)
where 1=1
and s.styles is null
and (p.code like '050-0374%' or p.code like '050-0375%' or p.code like '050-0376%')


/*
Style info. is missing for the following models
	Phonak CROS B-13 Custom
	Phonak CROS B-R
*/ 
insert into [catalog].[PhonakStylesTemp]
select p.product_id,'ITE' styles
from [catalog].[PhonakCodeTemp] p
--left join [catalog].[PhonakIdentifierTemp] i on (i.product_Id=p.product_id)
left join [catalog].[PhonakStylesTemp] s on (s.product_id=p.product_id)
where 1=1
and s.styles is null
and (p.code like '063-0247%' or p.code like '050-0601%')
-------------------------------------------------- Manual updates because of missing info. in catalog file Start --------------------------------------------------------------------------------------------------------





-----------------------------------------------------------------------------------------------------------------------------------------------------------------------------
-- Delete all PHONAK HA's  and attributes in stg table 
DELETE FROM catalog.ItemMasterList_Staging WHERE BrandCode = 'PHONAK'
DELETE FROM catalog.ItemMasterAttributeValues_Staging WHERE Brandcode='PHONAK'
-----------------------------------------------------------------------------------------------------------------------------------------------------------------------------






-------------------------------------------------- Hearing Aids Start --------------------------------------------------------------------------------------------------------
-- Insert all HA items to staging table
INSERT INTO [catalog].[ItemMasterList_Staging]
select 
distinct
pln.en+'_'+id.en ItemCode
,'HA' ItemType
,'PHONAK' BrandCode

-- Case statment for family is written because few products like Naida Q & CROS doesn't have family info. provided in the catalog
--,f.en FamilyCode
,case when f.en is null and id.en like '%CROS%' then 'CROS'
      when f.en is null and id.en not like '%CROS%' then ltrim(substring(id.en,charindex(' ',id.en), CHARINDEX(' ',ltrim(SUBSTRING(id.en,charindex(' ',id.en),LEN(id.en)-charindex(' ',id.en)))) ))+' '+SUBSTRING(pl.code,1,1)
	  else f.en end FamilyCode

,pln.en TechnologyCode
,id.en ModelCode
,case when 'RIC,' IN (select value from STRING_SPLIT(s.styles,' ')) then 'RIC'
	  when 'BTE,' IN (select value from STRING_SPLIT(s.styles,' ')) then 'BTE'
	  when 'ITC,' IN (select value from STRING_SPLIT(s.styles,' ')) then 'ITC'
	  when 'ITE,' IN (select value from STRING_SPLIT(s.styles,' ')) then 'ITE'
	  when 'CIC/IIC,' IN (select value from STRING_SPLIT(s.styles,' ')) then 'CIC/IIC'
	  when id.en like 'Phonak Virto %-10' then 'CIC/IIC' -- style info. is missing for these models in API
	  else s.styles end StyleCode
	  ,1
	  --,*
--,case when p.styles like '%RIC%' and p.styles like '%BTECRT%' then 'RIC'
--	  when p.styles like '%BTE%' then 'BTE'
--	  when p.styles like '%RIC%' then 'RIC'	  
--	  when p.styles like '%ITC%' then 'ITC'
--	  when p.styles like '%ITE%' then 'ITE'
--	  when p.styles like '%CIC/IIC%' then 'CIC/IIC'
--	  when id.en like 'Phonak Virto %-10' then 'CIC/IIC'
--	  else p.styles end StyleCode
--,p.*,'%%%%%' 
--,id.*,'%%%%%' 
--,m.*,'%%%%%'
--,fn.*,'%%%%%' 
--,f.*,'%%%%%'
--,pl.*,'%%%%%' 
----,pln.*
from [catalog].[PhonakProductTemp] p -- Product
left join [catalog].[PhonakCodeTemp] c on (c.product_Id=p.product_Id)
left join [catalog].[PhonakIdentifierTemp] id on (id.product_Id=p.product_Id) -- Model Code
left join [catalog].[PhonakModelTypeTemp] m on (m.product_Id=p.product_Id) -- Battery/Power
-- Family
left join [catalog].[PhonakFamilyNameTemp] fn on (fn.product_Id=p.product_Id)
left join [catalog].[PhonakFamilyTemp] f on (f.family_Id=fn.family_Id)		 
-- Technology Code
left join [catalog].[PhonakPerformanceLevelTemp] pl on (pl.product_Id=p.product_Id)
left join [catalog].[PhonakPerformanceLevelNameTemp] pln on (pln.performanceLevel_Id=pl.performanceLevel_Id)
--styles
left join [catalog].[PhonakStylesTemp] s on (s.product_id=p.product_id)

where 1=1
and pln.en is not null
and f.en is not null
and s.styles is not null

-------------------------------------------------- Hearing Aids End --------------------------------------------------------------------------------------------------------




-------------------------------------------------- Batteries Start --------------------------------------------------------------------------------------------------------
-- Load batteries for all HA's (BTE, RIC & CUSTOM)
INSERT INTO [catalog].[ItemMasterAttributeValues_Staging]
select 
DISTINCT
'PHONAK'
,'BATTERY_SIZES' AttributeCode
,pln.en+'_'+id.en ItemCode
,b.batterySize ModelAttributeValue
,1 IsActive
,null VendorCode
,'NA' Modifier
,b.batterySize ModelAttributeValueDescription
from  [catalog].[PhonakBatterySizeTemp] b
left join [catalog].[PhonakCodeTemp] c on (c.product_Id=b.product_Id)
left join [catalog].[PhonakIdentifierTemp] id on (id.product_Id=b.product_Id)
left join [catalog].[PhonakPerformanceLevelTemp] pl on (pl.product_Id=b.product_Id)
left join [catalog].[PhonakPerformanceLevelNameTemp] pln on (pln.performanceLevel_Id=pl.performanceLevel_Id)
join catalog.ItemMasterList_Staging st on (st.ItemCode=(pln.en+'_'+id.en) and st.BrandCode = 'PHONAK')
where 1=1

UNION

-- Battery missing for these rechargable models in catalog
select 
DISTINCT
'PHONAK'
,'BATTERY_SIZES' AttributeCode
,pln.en+'_'+id.en ItemCode
,'R' ModelAttributeValue
,1 IsActive
,null VendorCode
,'NA' Modifier
,'R' ModelAttributeValueDescription
from  [catalog].[PhonakProductTemp] b
left join [catalog].[PhonakCodeTemp] c on (c.product_Id=b.product_Id)
left join [catalog].[PhonakIdentifierTemp] id on (id.product_Id=b.product_Id)
left join [catalog].[PhonakPerformanceLevelTemp] pl on (pl.product_Id=b.product_Id)
left join [catalog].[PhonakPerformanceLevelNameTemp] pln on (pln.performanceLevel_Id=pl.performanceLevel_Id)
join catalog.ItemMasterList_Staging st on (st.ItemCode=(pln.en+'_'+id.en) and st.BrandCode = 'PHONAK')
where 1=1
and id.en like '%Phonak%B%-R'
and pln.en is not null

UNION

-- Battery missing for these rechargable models in catalog
select 
DISTINCT
'PHONAK'
,'BATTERY_SIZES' AttributeCode
,pln.en+'_'+id.en ItemCode
,'R' ModelAttributeValue
,1 IsActive
,null VendorCode
,'NA' Modifier
,'R' ModelAttributeValueDescription
from  [catalog].[PhonakProductTemp] b
left join [catalog].[PhonakCodeTemp] c on (c.product_Id=b.product_Id)
left join [catalog].[PhonakIdentifierTemp] id on (id.product_Id=b.product_Id)
left join [catalog].[PhonakPerformanceLevelTemp] pl on (pl.product_Id=b.product_Id)
left join [catalog].[PhonakPerformanceLevelNameTemp] pln on (pln.performanceLevel_Id=pl.performanceLevel_Id)
join catalog.ItemMasterList_Staging st on (st.ItemCode=(pln.en+'_'+id.en) and st.BrandCode = 'PHONAK')
where 1=1
and id.en like '%Phonak%B%-PR'
and pln.en is not null


-------------------------------------------------- Batteries End --------------------------------------------------------------------------------------------------------



-------------------------------------------------- Color Start --------------------------------------------------------------------------------------------------------

-- BTE RIC Colors
INSERT INTO [catalog].[ItemMasterAttributeValues_Staging]
select 
DISTINCT
'PHONAK'
,'COLOR' AttributeCode
--,pln.en,id.en
,pln.en+'_'+id.en ItemCode
,cn.en +'-'+ co.code ModelAttributeValue
,1 IsActive
,c.code VendorCode
--,id.en
,'NA' Modifier
,cn.en ModelAttributeValueDescription
--,*
from  [catalog].[PhonakProductTemp] b
left join [catalog].[PhonakCodeTemp] c on (c.product_Id=b.product_Id)
left join [catalog].[PhonakIdentifierTemp] id on (id.product_Id=b.product_Id)
left join [catalog].[PhonakPerformanceLevelTemp] pl on (pl.product_Id=b.product_Id)
left join [catalog].[PhonakPerformanceLevelNameTemp] pln on (pln.performanceLevel_Id=pl.performanceLevel_Id)
left join [catalog].[PhonakColorTemp] co on (co.product_Id=b.product_Id)
left join [catalog].[PhonakColorNameTemp] cn on (cn.color_Id=co.color_Id)
join catalog.ItemMasterList_Staging st on (st.ItemCode=(pln.en+'_'+id.en) and st.BrandCode = 'PHONAK')
where 1=1
and cn.en is not null
and pl.code is not null
and pln.en is not null



-- CUSTOM Color (Faceplate colors)

-- Add CUSTOM_HA attribute for all custom HA's to map its VendorCode with color code
INSERT INTO [catalog].[ItemMasterAttributeValues_Staging]
select 
DISTINCT
'PHONAK'
,'CUSTOM_HA' AttributeCode
--,pln.en,id.en
,pln.en+'_'+id.en ItemCode
,'Custom Hearing Aid' ModelAttributeValue
,1 IsActive
,left(c.code,len(c.code)-3)+'-01' VendorCode
--,id.en
,'NA' Modifier
,'Custom Hearing Aid' ModelAttributeValueDescription
--,*
from  [catalog].[PhonakProductTemp] b
left join [catalog].[PhonakCodeTemp] c on (c.product_Id=b.product_Id)
left join [catalog].[PhonakIdentifierTemp] id on (id.product_Id=b.product_Id)
left join [catalog].[PhonakPerformanceLevelTemp] pl on (pl.product_Id=b.product_Id)
left join [catalog].[PhonakPerformanceLevelNameTemp] pln on (pln.performanceLevel_Id=pl.performanceLevel_Id)
left join [catalog].[phonakOptionsTemp] co on (co.product_Id=b.product_Id and co.code='FC')
left join [catalog].[phonakOptionsValuesTemp] cn on (cn.initialOptions_Id=co.initialOptions_Id)
join catalog.ItemMasterList_Staging st on (st.ItemCode=(pln.en+'_'+id.en) and st.BrandCode = 'PHONAK')
left join (
			select 
			DISTINCT col.code
			,coln.en
			from [catalog].[PhonakColorTemp] col
			join [catalog].[PhonakColorNameTemp] coln on (coln.color_Id=col.color_Id)
		  ) cust on (cust.code=cn.[values])
where 1=1
and cn.[values] is not null
and pl.code is not null
and pln.en is not null



-- Load available colors for all custom HA's
INSERT INTO [catalog].[ItemMasterAttributeValues_Staging]
select 
DISTINCT
'PHONAK'
,'COLOR' AttributeCode
--,pln.en,id.en
,pln.en+'_'+id.en ItemCode
,cust.en +'-'+ cn.[values] ModelAttributeValue
,1 IsActive
--,left(c.code,len(c.code)-3)+'-'+cn.[values] VendorCode
,left(c.code,len(c.code)-3)+'-01' VendorCode
--,id.en
,'NA' Modifier
,cust.en ModelAttributeValueDescription
--,*
from  [catalog].[PhonakProductTemp] b
left join [catalog].[PhonakCodeTemp] c on (c.product_Id=b.product_Id)
left join [catalog].[PhonakIdentifierTemp] id on (id.product_Id=b.product_Id)
left join [catalog].[PhonakPerformanceLevelTemp] pl on (pl.product_Id=b.product_Id)
left join [catalog].[PhonakPerformanceLevelNameTemp] pln on (pln.performanceLevel_Id=pl.performanceLevel_Id)
left join [catalog].[phonakOptionsTemp] co on (co.product_Id=b.product_Id and co.code='FC')		-- Faceplate Color
left join [catalog].[phonakOptionsValuesTemp] cn on (cn.initialOptions_Id=co.initialOptions_Id)
join catalog.ItemMasterList_Staging st on (st.ItemCode=(pln.en+'_'+id.en) and st.BrandCode = 'PHONAK')
left join (
			select 
			DISTINCT col.code
			,coln.en
			from [catalog].[PhonakColorTemp] col
			join [catalog].[PhonakColorNameTemp] coln on (coln.color_Id=col.color_Id)
		  ) cust on (cust.code=cn.[values])
where 1=1
and cn.[values] is not null
and pl.code is not null
and pln.en is not null

-------------------------------------------------- Color End --------------------------------------------------------------------------------------------------------


-------------------------------------------------- BTE Tubes (RECEIVER_SIZES)  Start--------------------------------------------------------------------------------------------------------

-- Load SPAREPART's tubes compatible for all BTE models
INSERT INTO [catalog].[ItemMasterAttributeValues_Staging]
SELECT
DISTINCT
'PHONAK'
,'RECIEVER_SIZES' AttributeCode
--,pln.en,id.en
,pln.en+'_'+id.en ItemCode
,id1.en ModelAttributeValue
,1 IsActive
,r.target VendorCode
--,id.en
,case when id1.en like '%-L' then 'LT' 
	  when id1.en like '%-R' then 'RT' else 'NA' end Modifier
,id1.en ModelAttributeValueDescription
from  [catalog].[PhonakProductTemp] b
left join [catalog].[PhonakCodeTemp] c on (c.product_Id=b.product_Id)
left join [catalog].[PhonakIdentifierTemp] id on (id.product_Id=b.product_Id)
left join [catalog].[PhonakPerformanceLevelTemp] pl on (pl.product_Id=b.product_Id)
left join [catalog].[PhonakPerformanceLevelNameTemp] pln on (pln.performanceLevel_Id=pl.performanceLevel_Id)
left join [catalog].[PhonakReferencesTemp] r on (r.product_Id=b.product_Id)
left join [catalog].[PhonakCodeTemp] c1 on (c1.code=r.target)
left join [catalog].[PhonakIdentifierTemp] id1 on (id1.product_Id=c1.product_Id)
join catalog.ItemMasterList_Staging st on (st.ItemCode=(pln.en+'_'+id.en) and st.BrandCode = 'PHONAK')
where 1=1
and r.type='SPAREPART'
AND id1.en like '%SlimTube%'

-------------------------------------------------- BTE Tubes (RECEIVER_SIZES)  End --------------------------------------------------------------------------------------------------------


-------------------------------------------------- RIC Receiver Power & Sizes (RECIEVER_POWER & RECEIVER_SIZES)  Start --------------------------------------------------------------------------------------------------------

-- Receiver power and sizes are loaded from the same attribute  (NECESSARYITEMLEFT & NECESSARYITEMRIGHT references)
INSERT INTO [catalog].[ItemMasterAttributeValues_Staging]
SELECT
DISTINCT
'PHONAK'
,'RECIEVER_POWER' AttributeCode
--,pln.en,id.en
,pln.en+'_'+id.en ItemCode
,id1.en ModelAttributeValue
,1 IsActive
,r.target VendorCode
--,r.type
,case when id1.en like '%L' then 'LT' 
	  when id1.en like '%R' then 'RT' else 'NA' end Modifier
,id1.en ModelAttributeValueDescription
from  [catalog].[PhonakProductTemp] b
left join [catalog].[PhonakCodeTemp] c on (c.product_Id=b.product_Id)
left join [catalog].[PhonakIdentifierTemp] id on (id.product_Id=b.product_Id)
left join [catalog].[PhonakPerformanceLevelTemp] pl on (pl.product_Id=b.product_Id)
left join [catalog].[PhonakPerformanceLevelNameTemp] pln on (pln.performanceLevel_Id=pl.performanceLevel_Id)
left join [catalog].[PhonakReferencesTemp] r on (r.product_Id=b.product_Id)
left join [catalog].[PhonakCodeTemp] c1 on (c1.code=r.target)
left join [catalog].[PhonakIdentifierTemp] id1 on (id1.product_Id=c1.product_Id)
join catalog.ItemMasterList_Staging st on (st.ItemCode=(pln.en+'_'+id.en) and st.BrandCode = 'PHONAK')
where 1=1
and r.type in ('NECESSARYITEMLEFT','NECESSARYITEMRIGHT')
AND id1.en like '%receiver%'
-------------------------------------------------- RIC Receiver Power & Sizes (RECIEVER_POWER & RECEIVER_SIZES)  End --------------------------------------------------------------------------------------------------------



-------------------------------------------------- CUSTOM Receiver Power (PL) Start --------------------------------------------------------------------------------------------------------
-- CUSTOM Receivers (Power lever PL)

INSERT INTO [catalog].[ItemMasterAttributeValues_Staging]
select 
DISTINCT
'PHONAK'
,'RECIEVER_POWER' AttributeCode
--,pln.en,id.en
,pln.en+'_'+id.en ItemCode
,cust.code+'-'+cust.en ModelAttributeValue
,1 IsActive
,cn.[values] VendorCode
--,id.en
,'NA' Modifier
,cust.code ModelAttributeValueDescription
--,*
from  [catalog].[PhonakProductTemp] b
left join [catalog].[PhonakCodeTemp] c on (c.product_Id=b.product_Id)
left join [catalog].[PhonakIdentifierTemp] id on (id.product_Id=b.product_Id)
left join [catalog].[PhonakPerformanceLevelTemp] pl on (pl.product_Id=b.product_Id)
left join [catalog].[PhonakPerformanceLevelNameTemp] pln on (pln.performanceLevel_Id=pl.performanceLevel_Id)
left join [catalog].[phonakOptionsTemp] co on (co.product_Id=b.product_Id and co.code='PL')		-- Power Level
left join [catalog].[phonakOptionsValuesTemp] cn on (cn.initialOptions_Id=co.initialOptions_Id)
join catalog.ItemMasterList_Staging st on (st.ItemCode=(pln.en+'_'+id.en) and st.BrandCode = 'PHONAK')
left join (
			select 
			DISTINCT case when coln.en ='M' then 'Moderate' 
					      when coln.en ='P' then 'Power'
					      when coln.en ='S' then 'Standard'
					 else col.code end code
			,coln.en
			from [catalog].[PhonakPerformanceLevelTemp] col
			join [catalog].[PhonakPerformanceLevelNameTemp] coln on (coln.performanceLevel_Id=col.performanceLevel_Id)
			where 1=1
			and col.code like 'RECEIVER_%'
			UNION
			select 'Super Power','SP'
			UNION
			select 'Ultra Power','UP'   -- Add more power levels if available going forward
			UNION
			select 'None','NONE'
		  ) cust on (cust.en=cn.[values])
where 1=1
and cn.[values] is not null
-------------------------------------------------- CUSTOM Receiver Power (PL) End --------------------------------------------------------------------------------------------------------



-------------------------------------------------- CUSTOM Shell Type (ST) Start --------------------------------------------------------------------------------------------------------
-- CUSTOM Shell Type (Shell Type ST)
INSERT INTO [catalog].[ItemMasterAttributeValues_Staging]
select 
DISTINCT
'PHONAK'
,'SHELL_TYPE' AttributeCode
--,pln.en,id.en
,pln.en+'_'+id.en ItemCode
,case when cn.[values] = 'H' then 'Half Shell'+'-'+cn.[values]
      when cn.[values] = 'N' then 'IIC'+'-'+cn.[values]
	  when cn.[values] = 'I' then 'CIC'+'-'+cn.[values]
	  when cn.[values] = 'M' then 'Mini Canal'+'-'+cn.[values]
	  when cn.[values] = 'C' then 'Canal'+'-'+cn.[values]
	  when cn.[values] = 'F' then 'Full Shell'+'-'+cn.[values]
else cn.[values] end ModelAttributeValue
,1 IsActive
,cn.[values] VendorCode
--,id.en
,'NA' Modifier
,case when cn.[values] = 'H' then 'Half Shell'
      when cn.[values] = 'N' then 'IIC'
	  when cn.[values] = 'I' then 'CIC'
	  when cn.[values] = 'M' then 'Mini Canal'
	  when cn.[values] = 'C' then 'Canal'
	  when cn.[values] = 'F' then 'Full Shell'
else cn.[values] end ModelAttributeValueDescription
--,*
from  [catalog].[PhonakProductTemp] b
left join [catalog].[PhonakCodeTemp] c on (c.product_Id=b.product_Id)
left join [catalog].[PhonakIdentifierTemp] id on (id.product_Id=b.product_Id)
left join [catalog].[PhonakPerformanceLevelTemp] pl on (pl.product_Id=b.product_Id)
left join [catalog].[PhonakPerformanceLevelNameTemp] pln on (pln.performanceLevel_Id=pl.performanceLevel_Id)
left join [catalog].[phonakOptionsTemp] co on (co.product_Id=b.product_Id and co.code='ST')		-- Shell Style
left join [catalog].[phonakOptionsValuesTemp] cn on (cn.initialOptions_Id=co.initialOptions_Id)
join catalog.ItemMasterList_Staging st on (st.ItemCode=(pln.en+'_'+id.en) and st.BrandCode = 'PHONAK')
left join (
			select 
			DISTINCT col.code
			,coln.en
			from [catalog].[PhonakColorTemp] col
			join [catalog].[PhonakColorNameTemp] coln on (coln.color_Id=col.color_Id)
		  ) cust on (cust.code=cn.[values])
where 1=1
and cn.[values] is not null
and pl.code is not null
and pln.en is not null
-------------------------------------------------- CUSTOM Shell Type (ST) End --------------------------------------------------------------------------------------------------------





-------------------------------------------------- Picture & Thumbnail URL's Start --------------------------------------------------------------------------------------------------------

-- Phonak pictures and thumbnail urls
/*
select 
c.code Vendor_Code
,id.en Product_Description
,pl.code PerformanceLevel_Code
,pln.en PerformanceLevel_Description
,co.code Color_Code
,co.value1 Color_RGB_or_HEX
,cn.en Color_Description
,pu.pictureURL Picture_URL
,tu.thumbnailURL Thumbnail_URL
from  [catalog].[PhonakProductTemp] b
left join [catalog].[PhonakCodeTemp] c on (c.product_Id=b.product_Id)
left join [catalog].[PhonakIdentifierTemp] id on (id.product_Id=b.product_Id)
left join [catalog].[PhonakPerformanceLevelTemp] pl on (pl.product_Id=b.product_Id)
left join [catalog].[PhonakPerformanceLevelNameTemp] pln on (pln.performanceLevel_Id=pl.performanceLevel_Id)
left join [catalog].[PhonakColorTemp] co on (co.product_Id=b.product_Id)
left join [catalog].[PhonakColorNameTemp] cn on (cn.color_Id=co.color_Id)
left join [catalog].[PhonakPictureURLTemp] pu on (pu.product_Id=b.product_Id)
left join [catalog].[PhonakThumbnailURLTemp] tu on (tu.product_Id=b.product_Id)
where 1=1
and pu.pictureURL!='https://dc-cached.phonakpro.comnull'
order by c.code
*/
-------------------------------------------------- Picture & Thumbnail URL's End --------------------------------------------------------------------------------------------------------

	COMMIT TRANSACTION PHONAK_ItemMaster_Temp_To_Stg
	PRINT 'SUCCESS'
	

	END TRY
	

	BEGIN CATCH

	DECLARE @ErrorMessage NVARCHAR(4000);  
    DECLARE @ErrorSeverity INT;  
    DECLARE @ErrorState INT;  

    SELECT   
        @ErrorMessage = ERROR_MESSAGE(),  
        @ErrorSeverity = ERROR_SEVERITY(),  
        @ErrorState = ERROR_STATE();  

		IF (@@TRANCOUNT > 0)
		BEGIN
			ROLLBACK TRANSACTION PHONAK_ItemMaster_Temp_To_Stg
			RAISERROR(@ErrorMessage,@ErrorSeverity,@ErrorState);
			PRINT 'FAILED'
		END

	END CATCH
END
--EXEC [catalog].[V_GetBrands1] 4,5,720
CREATE PROCEDURE [catalog].[V_GetBrands]
	@InsuranceCarrierID int = 0 ,
	@InsuranceHealthPlanID int = 0,
	@ProviderId int = 0
	AS
	BEGIN
	SET NOCOUNT ON

	DECLARE @BrandType nvarchar(200) = ''
	SET @BrandType = (SELECT BRANDS FROM [provider].[ProviderProfiles] WHERE ProviderId = @ProviderId)

	IF (@BrandType = 'BELTONE')
		BEGIN
				SELECT DISTINCT
						br.[BrandId] AS 'BrandID',
						br.[BrandName] AS 'BrandName',
						br.[BrandCode] AS 'BrandCode',
						br.[Description] AS 'Description',
						br.[ImageURL] AS 'ImageURL'
				FROM [catalog].[Brands] br
					 LEFT JOIN [catalog].[ItemMasterList] vm ON br.[BrandCode] = vm.[BrandCode]
					 JOIN insurance.ContractProducts conProd ON vm.[BrandCode] = conProd.BrandCode			
					 LEFT JOIN insurance.HealthPlanContracts healthPC ON healthPC.HealthPlanContractID = conProd.HealthPlanContractID			
					 LEFT JOIN insurance.InsuranceHealthPlans insHP ON healthPC.InsuranceHealthPlanID = insHP.InsuranceHealthPlanID
					 LEFT JOIN insurance.InsuranceCarriers insCarr ON
					 healthPC.InsuranceCarrierId = insCarr.InsuranceCarrierId

				WHERE healthPC.InsuranceHealthPlanID=@InsuranceHealthPlanID
						AND healthPC.InsuranceCarrierID=@InsuranceCarrierID
						AND vm.IsActive=1 and br.[BrandCode] = 'BELTONE'
		END
	ELSE IF (@BrandType = 'INDEPENDENT')
		BEGIN
				SELECT DISTINCT
						br.[BrandId] AS 'BrandID',
						br.[BrandName] AS 'BrandName',
						br.[BrandCode] AS 'BrandCode',
						br.[Description] AS 'Description',
						br.[ImageURL] AS 'ImageURL'
				FROM [catalog].[Brands] br
					 LEFT JOIN [catalog].[ItemMasterList] vm ON br.[BrandCode] = vm.[BrandCode]
					 JOIN insurance.ContractProducts conProd ON vm.[BrandCode] = conProd.BrandCode			
					 LEFT JOIN insurance.HealthPlanContracts healthPC ON healthPC.HealthPlanContractID = conProd.HealthPlanContractID			
					 LEFT JOIN insurance.InsuranceHealthPlans insHP ON healthPC.InsuranceHealthPlanID = insHP.InsuranceHealthPlanID
					 LEFT JOIN insurance.InsuranceCarriers insCarr ON
					 healthPC.InsuranceCarrierId = insCarr.InsuranceCarrierId

				WHERE healthPC.InsuranceHealthPlanID=@InsuranceHealthPlanID
						AND healthPC.InsuranceCarrierID=@InsuranceCarrierID
						AND vm.IsActive=1 and br.[BrandCode] <> 'BELTONE'
		END
	ELSE
		BEGIN
		SELECT DISTINCT
						br.[BrandId] AS 'BrandID',
						br.[BrandName] AS 'BrandName',
						br.[BrandCode] AS 'BrandCode',
						br.[Description] AS 'Description',
						br.[ImageURL] AS 'ImageURL'
				FROM [catalog].[Brands] br
					 LEFT JOIN [catalog].[ItemMasterList] vm ON br.[BrandCode] = vm.[BrandCode]
					 JOIN insurance.ContractProducts conProd ON vm.[BrandCode] = conProd.BrandCode			
					 LEFT JOIN insurance.HealthPlanContracts healthPC ON healthPC.HealthPlanContractID = conProd.HealthPlanContractID			
					 LEFT JOIN insurance.InsuranceHealthPlans insHP ON healthPC.InsuranceHealthPlanID = insHP.InsuranceHealthPlanID
					 LEFT JOIN insurance.InsuranceCarriers insCarr ON
					 healthPC.InsuranceCarrierId = insCarr.InsuranceCarrierId

				WHERE healthPC.InsuranceHealthPlanID=@InsuranceHealthPlanID
						AND healthPC.InsuranceCarrierID=@InsuranceCarrierID
						AND vm.IsActive=1
		END
END
CREATE PROCEDURE [catalog].[getModelDetailsByModelCode]
	@modelCode varchar(30),
	@insuranceCarrierID int = 0 ,
	@healthPlanID int = 0,
	@itemCode	varchar(100) = ''
	AS
	BEGIN

	IF @itemCode = ''
			BEGIN
			 SELECT DISTINCT
			 vm.ModelCode AS ProductModelCode,
			 vm.BrandCode AS BrandCode,
			 vm.FamilyCode AS BrandFamilyCode,
			 NULL AS EarmoldTypeCode,
			 vm.TechnologyCode AS FamilyProductCode,
			 NULL AS ProductTypeCode,
			 vm.StyleCode as ShellCode,
			 vm.TechnologyCode AS TechnologyLevelCode,
			 mContent.ModelOverview AS ModelOverview,
			 mContent.ModelLongDescription AS ModelLongDescription,
			 ISNULL(conProd.[PerDeviceMemberPrice],0) AS UnitProductPrice,
			 ISNULL([PerPairMemberPrice],0) AS PairProductPrice,
			 ISNULL(contBen.BenefitAmt,0) AS Benefit,
			 mContent.ModelShortDescription AS [Description],
			 mContent.DefaultImage AS MediaURL,
			 mContent.FamilyLogoImage AS FamilyLogoImage,
			 mContent.FamilyBannerImage AS FamilyBannerImage,
			 vm.StyleCode AS StyleName,
			 0 AS StyleID,
			 vm.StyleCode AS StyleCode,
			 vm.ItemCode AS ItemCode
	 
			 FROM [catalog].[ItemMasterList] vm
			 LEFT JOIN insurance.ContractProducts conProd ON conProd.ItemCode = vm.ItemCode
			 LEFT JOIN CMS.ItemMasterContent mContent ON vm.ItemCode = mContent.ItemCode
			 LEFT JOIN insurance.ContractBenefits contBen ON contBen.HealthPlanContractID = conProd.HealthPlanContractID
			 LEFT JOIN insurance.HealthPlanContracts healthPC ON healthPC.HealthPlanContractID = contBen.HealthPlanContractID
			 LEFT JOIN insurance.InsuranceHealthPlans insHP ON healthPC.[InsuranceHealthPlanID] = insHP.[InsuranceHealthPlanID]
			 WHERE vm.ModelCode =  @modelCode AND healthPC.InsuranceHealthPlanID=@healthPlanID
					AND healthPC.InsuranceCarrierID=@insuranceCarrierID AND vm.IsActive=1
	END
	ELSE
		BEGIN
			SELECT DISTINCT
			 vm.ModelCode AS ProductModelCode,
			 vm.BrandCode AS BrandCode,
			 vm.FamilyCode AS BrandFamilyCode,
			 NULL AS EarmoldTypeCode,
			 vm.TechnologyCode AS FamilyProductCode,
			 NULL AS ProductTypeCode,
			 vm.StyleCode as ShellCode,
			 vm.TechnologyCode AS TechnologyLevelCode,
			 mContent.ModelOverview AS ModelOverview,
			 mContent.ModelLongDescription AS ModelLongDescription,
			 ISNULL(conProd.[PerDeviceMemberPrice],0) AS UnitProductPrice,
			 ISNULL([PerPairMemberPrice],0) AS PairProductPrice,
			 ISNULL(contBen.BenefitAmt,0) AS Benefit,
			 mContent.ModelShortDescription AS [Description],
			 mContent.DefaultImage AS MediaURL,
			 mContent.FamilyLogoImage AS FamilyLogoImage,
			 mContent.FamilyBannerImage AS FamilyBannerImage,
			 vm.StyleCode AS StyleName,
			 0 AS StyleID,
			 vm.StyleCode AS StyleCode,
			 vm.ItemCode AS ItemCode	 
			 FROM [catalog].[ItemMasterList] vm
			
			 LEFT JOIN insurance.ContractProducts conProd ON conProd.ItemCode =  vm.ItemCode 
						

			 --LEFT JOIN insurance.ContractProducts conProd ON conProd.FamilyProductCode = CASE
				--	WHEN vm.BrandCode not in ('BELTONE', 'GNR','PHONAK')
				--		THEN TRIM(CONCAT(LEFT(vm.BrandCode, 2), ' ', vm.FamilyCode, ' ', CASE WHEN vm.TechnologyCode = 'NA' THEN '' ELSE vm.TechnologyCode END))
				--		ELSE vm.TechnologyCode
				--	END


			 LEFT JOIN CMS.ItemMasterContent mContent ON vm.ItemCode = mContent.ItemCode
			 LEFT JOIN insurance.ContractBenefits contBen ON contBen.HealthPlanContractID = conProd.HealthPlanContractID
			 LEFT JOIN insurance.HealthPlanContracts healthPC ON healthPC.HealthPlanContractID = contBen.HealthPlanContractID
			 LEFT JOIN insurance.InsuranceHealthPlans insHP ON healthPC.[InsuranceHealthPlanID] = insHP.[InsuranceHealthPlanID]
			 WHERE  vm.ItemCode =  @itemCode and healthPC.InsuranceHealthPlanID=@healthPlanID
				AND healthPC.InsuranceCarrierID=@insuranceCarrierID AND vm.IsActive=1
	END
END



-- EXEC [catalog].[sp_ssis_UNITRON_ItemMaster_Temp_To_Stg]

CREATE PROCEDURE [catalog].[sp_ssis_UNITRON_ItemMaster_Temp_To_Stg]
AS 


BEGIN

	BEGIN TRY
	BEGIN TRANSACTION UNITRON_ItemMaster_Temp_To_Stg

	-- Check column datatype and length
	-- ALTER TABLE [catalog].[UnitronProductTemp] ALTER COLUMN [styles] nvarchar(255) NULL;




-------------------------------------------------- Manual updates because of missing info. in catalog file Start --------------------------------------------------------------------------------------------------------

-- Update model names with superscript
update id
set en = case when en='Quantum E S' THEN 'Quantum2 E S'
		    when en='Quantum 10 S' THEN 'Quantum2 10 S'
			ELSE en end
--select case when en='Quantum E S' THEN 'Quantum2 E S'
--		    when en='Quantum 10 S' THEN 'Quantum2 10 S'
--			ELSE en end en
--			,en en1
from [catalog].[UnitronIdentifierTemp] id
where 1=1
and en in ('Quantum E S','Quantum 10 S')


-- Family info. is missing for the following models in catalog file
-- Covered in HA section
/*
select * 
from [catalog].[UnitronIdentifierTemp] id
left join [catalog].[UnitronFamilyNameTemp] fn on (id.product_Id=fn.product_Id)
left join [catalog].[UnitronFamilyTemp] f on (f.family_Id=fn.family_Id)
where 1=1
and id.en in (
'Quantum E S'
,'Quantum 10 S'
,'Vista T 610 M 312'
,'Vista T 810 M 312'
)
*/

-- ModelType for 'Stride 500 10A IIC' is given as 'DOME_OPEN' instead of 'IIC'
update m
set m.code='IIC'
--select m.code,'IIC',*
from [catalog].[UnitronModelTypeTemp] m
left join [catalog].[UnitronIdentifierTemp] i on (m.product_Id=i.product_Id)
where 1=1
and i.en ='Stride 500 10A IIC'

-- Incorrect identifier description in catalog file, color is embedded by mistake in it
update id
set id.en = case when id.en ='FLEX:TRIAL Max SP Beige' then 'Max SP FLEX:TRIAL'
                 when id.en ='Max 6 SPm Light Gray' then 'Max 6 SPm'
				 else id.en end
from [catalog].[UnitronIdentifierTemp] id
where 1=1
and en in ('FLEX:TRIAL Max SP Beige','Max 6 SPm Light Gray')



-------------------------------------------------- Manual updates because of missing info. in catalog file Start --------------------------------------------------------------------------------------------------------





-----------------------------------------------------------------------------------------------------------------------------------------------------------------------------
-- Delete all UNITRON HA's  and attributes in stg table 
DELETE FROM catalog.ItemMasterList_Staging WHERE BrandCode = 'UNITRON'
DELETE FROM catalog.ItemMasterAttributeValues_Staging WHERE Brandcode='UNITRON'
-----------------------------------------------------------------------------------------------------------------------------------------------------------------------------






-------------------------------------------------- Hearing Aids Start --------------------------------------------------------------------------------------------------------
-- Insert all HA items to staging table
INSERT INTO [catalog].[ItemMasterList_Staging]
select 
distinct
--pl.code
case when id.en like 'T Stride M%' and id.en not in ('T Stride M FLEX:TRIAL') then pln.en+'_'+mn.en+' '+pln.en
     else pln.en+'_'+id.en end ItemCode

	 --,pln.en, mn.en, id.en
,'HA' ItemType
,'UNITRON' BrandCode
,case when id.en in ('Quantum2 E S','Quantum2 10 S') then 'Quantum2'
      when id.en in ('Vista T 610 M 312')  then 'Vista Tempus BTE'
	  when id.en in ('Vista T 810 M 312')  then 'Vista Tempus BTE'
      else f.en end FamilyCode
,pln.en TechnologyCode
,case when id.en like 'T Stride M%' and id.en not in ('T Stride M FLEX:TRIAL') then mn.en+' '+pln.en
 else id.en end ModelCode
--,mn.en
,case when 'RIC,' IN (select value from STRING_SPLIT(s.styles,' ')) then 'RIC'
	  when 'BTE,' IN (select value from STRING_SPLIT(s.styles,' ')) then 'BTE'
	  when 'ITC,' IN (select value from STRING_SPLIT(s.styles,' ')) then 'ITC'
	  when 'ITE,' IN (select value from STRING_SPLIT(s.styles,' ')) then 'ITE'
	  when id.en in ('Vista T 610 M 312')  then 'BTE'
	  when id.en in ('Vista T 810 M 312')  then 'BTE'
	  when s.styles is null and  f.en like 'Vista Tempus BTE' and (fn.type is null or fn.type = 'RICBTE' ) then 'BTE'
	  when s.styles is null and  f.en like 'Vista Tempus RIC' then 'RIC'
	  when s.styles is null and  ISNULL(fn.type,' ')='ITECustom' then 'ITE'
	  when s.styles = 'Slim' and  ISNULL(fn.type,' ')='ITECustom' then 'ITE'
	  when id.en  in ('Stride M 500','Stride P 500') then 'BTE'
	  when id.en in ('T Max UP FLEX:TRIAL') then 'BTE'
	  when id.en like 'T Max %P%' then 'BTE'
	  else s.styles end StyleCode
	  ,1
	 --,substring(c.code,1,8)
	 --,mn.en
	 --,id.en
	 --,m.code
	 --,m.name
	 --,fn.code
	 --,fn.type
	 --,f.en
	 --,pl.code
	 --,pln.en
	 --,s.styles

from [catalog].[UnitronProductTemp] p -- Product
left join [catalog].[UnitronCodeTemp] c on (c.product_Id=p.product_Id)
left join [catalog].[UnitronIdentifierTemp] id on (id.product_Id=p.product_Id) -- Model Code
left join [catalog].[UnitronModelTypeTemp] m on (m.product_Id=p.product_Id) -- Battery/Power
left join [catalog].[UnitronModelTypeNameTemp] mn on (mn.ModelTypeId=m.ModelTypeId) -- Battery/Power
-- Family
left join [catalog].[UnitronFamilyNameTemp] fn on (fn.product_Id=p.product_Id)
left join [catalog].[UnitronFamilyTemp] f on (f.family_Id=fn.family_Id)		 
-- Technology Code
left join [catalog].[UnitronPerformanceLevelTemp] pl on (pl.product_Id=p.product_Id)
left join [catalog].[UnitronPerformanceLevelNameTemp] pln on (pln.performanceLevel_Id=pl.performanceLevel_Id)
--styles
left join [catalog].[UnitronStylesTemp] s on (s.product_id=p.product_id)

where 1=1
and pln.en is not null
and m.code not like 'DOME_%'
and m.code not like 'RECEIVER_%'
and isnull(f.en,'') <> 'Earpieces'
and id.en not in ('FLEX:TRIAL Max SP Beige','Max 6 SPm Light Gray')

-------------------------------------------------- Hearing Aids End --------------------------------------------------------------------------------------------------------




-------------------------------------------------- Batteries Start --------------------------------------------------------------------------------------------------------
-- Load batteries for all HA's (BTE, RIC & CUSTOM)
INSERT INTO [catalog].[ItemMasterAttributeValues_Staging]
select 
DISTINCT
'UNITRON' Modelcode
,'BATTERY_SIZES' AttributeCode
,pln.en+'_'+id.en ItemCode
,b.batterySize ModelAttributeValue
,1 IsActive
,null VendorCode
,'NA' Modifier
,b.batterySize ModelAttributeValueDescription
from  [catalog].[UnitronBatterySizeTemp] b
left join [catalog].[UnitronCodeTemp] c on (c.product_Id=b.product_Id)
left join [catalog].[UnitronIdentifierTemp] id on (id.product_Id=b.product_Id)
left join [catalog].[UnitronPerformanceLevelTemp] pl on (pl.product_Id=b.product_Id)
left join [catalog].[UnitronPerformanceLevelNameTemp] pln on (pln.performanceLevel_Id=pl.performanceLevel_Id)
join catalog.ItemMasterList_Staging st on (st.ItemCode=(pln.en+'_'+id.en) and st.BrandCode = 'UNITRON')
where 1=1
and id.en not in ('FLEX:TRIAL Max SP Beige','Max 6 SPm Light Gray')

UNION

-- Batteries for models missing in API xml catalog file
select DISTINCT
'UNITRON' BrandCode
,'BATTERY_SIZES' AttributeCode
,t.ItemCode
,case when t.ItemCode like '% R %' then 'R'
      when t.ItemCode like '% 10A %'  then '10A'
	  when t.ItemCode like '% 13 %' or t.ItemCode like '% 13' then '13'
	  when t.ItemCode like '% 312 %' or t.ItemCode like '% 312' then '312'
      else NULL end ModelAttributeValue  
,1 IsActive
,NULL VendorCode
,'NA' Modifier
,case when t.ItemCode like '% R %' then 'R'
      when t.ItemCode like '% 10A %'  then '10A'
	  when t.ItemCode like '% 13 %' or t.ItemCode like '% 13' then '13'
	  when t.ItemCode like '% 312 %' or t.ItemCode like '% 312' then '312'
      else NULL end ModelAttributeValueDescription
from 
(
select distinct itemcode from 
catalog.ItemMasterList_Staging st where st.BrandCode = 'UNITRON'

except 

select 
DISTINCT
--'UNITRON'
--,'BATTERY_SIZES' AttributeCode
pln.en+'_'+id.en ItemCode
--,b.batterySize ModelAttributeValue
--,1 IsActive
--,null VendorCode
--,'NA' Modifier
--,b.batterySize ModelAttributeValueDescription
from  [catalog].[UnitronBatterySizeTemp] b
left join [catalog].[UnitronCodeTemp] c on (c.product_Id=b.product_Id)
left join [catalog].[UnitronIdentifierTemp] id on (id.product_Id=b.product_Id)
left join [catalog].[UnitronPerformanceLevelTemp] pl on (pl.product_Id=b.product_Id)
left join [catalog].[UnitronPerformanceLevelNameTemp] pln on (pln.performanceLevel_Id=pl.performanceLevel_Id)
join catalog.ItemMasterList_Staging st on (st.ItemCode=(pln.en+'_'+id.en) and st.BrandCode = 'UNITRON')
where 1=1
and id.en not in ('FLEX:TRIAL Max SP Beige','Max 6 SPm Light Gray')
) t


-------------------------------------------------- Batteries End --------------------------------------------------------------------------------------------------------



-------------------------------------------------- Color Start --------------------------------------------------------------------------------------------------------

-- BTE RIC Colors
INSERT INTO [catalog].[ItemMasterAttributeValues_Staging]
select 
DISTINCT
'UNITRON'
,'COLOR' AttributeCode
--,pln.en,id.en
--,pln.en+'_'+id.en ItemCode
,case when id.en like 'T Stride M%' and id.en not in ('T Stride M FLEX:TRIAL') then pln.en+'_'+mn.en+' '+pln.en
     else pln.en+'_'+id.en end ItemCode
,cn.en +'-'+ co.code ModelAttributeValue
,1 IsActive
,c.code VendorCode
--,id.en
,'NA' Modifier
,cn.en ModelAttributeValueDescription
--,*
from  [catalog].[UnitronProductTemp] b
left join [catalog].[UnitronCodeTemp] c on (c.product_Id=b.product_Id)
left join [catalog].[UnitronIdentifierTemp] id on (id.product_Id=b.product_Id)
left join [catalog].[UnitronPerformanceLevelTemp] pl on (pl.product_Id=b.product_Id)
left join [catalog].[UnitronModelTypeTemp] m on (m.product_Id=c.product_Id) 
left join [catalog].[UnitronModelTypeNameTemp] mn on (mn.ModelTypeId=m.ModelTypeId) 
left join [catalog].[UnitronPerformanceLevelNameTemp] pln on (pln.performanceLevel_Id=pl.performanceLevel_Id)
left join [catalog].[UnitronColorTemp] co on (co.product_Id=b.product_Id)
left join [catalog].[UnitronColorNameTemp] cn on (cn.color_Id=co.color_Id)
join catalog.ItemMasterList_Staging st on (st.ItemCode=(pln.en+'_'+id.en) and st.BrandCode = 'UNITRON')
where 1=1
and cn.en is not null
and pl.code is not null
and pln.en is not null


-- Add CUSTOM_HA attribute for all custom HA's to map its VendorCode with color code
INSERT INTO [catalog].[ItemMasterAttributeValues_Staging]
select 
DISTINCT
'UNITRON'
,'CUSTOM_HA' AttributeCode
--,pln.en,id.en
,pln.en+'_'+id.en ItemCode
,'Custom Hearing Aid' ModelAttributeValue
,1 IsActive
,left(c.code,len(c.code)-3)+'-01' VendorCode
--,id.en
,'NA' Modifier
,'Custom Hearing Aid' ModelAttributeValueDescription
--,*
from  [catalog].[UnitronProductTemp] b
left join [catalog].[UnitronCodeTemp] c on (c.product_Id=b.product_Id)
left join [catalog].[UnitronIdentifierTemp] id on (id.product_Id=b.product_Id)
left join [catalog].[UnitronPerformanceLevelTemp] pl on (pl.product_Id=b.product_Id)
left join [catalog].[UnitronPerformanceLevelNameTemp] pln on (pln.performanceLevel_Id=pl.performanceLevel_Id)
left join [catalog].[UnitronOptionsTemp] co on (co.product_Id=b.product_Id and co.code='FC')
left join [catalog].[UnitronOptionsValuesTemp] cn on (cn.initialOptions_Id=co.initialOptions_Id)
join catalog.ItemMasterList_Staging st on (st.ItemCode=(pln.en+'_'+id.en) and st.BrandCode = 'UNITRON')
left join (
			select 
			DISTINCT col.code
			,coln.en
			from [catalog].[UnitronColorTemp] col
			join [catalog].[UnitronColorNameTemp] coln on (coln.color_Id=col.color_Id)
		  ) cust on (cust.code=cn.[values])
where 1=1
and cn.[values] is not null
and pl.code is not null
and pln.en is not null


-- Load available colors for all custom HA's
INSERT INTO [catalog].[ItemMasterAttributeValues_Staging]
select 
DISTINCT
'UNITRON'
,'COLOR' AttributeCode
--,pln.en,id.en
,pln.en+'_'+id.en ItemCode
,cust.en +'-'+ cn.[values] ModelAttributeValue
--,cust.en
--,cn.[values]
,1 IsActive
--,left(c.code,len(c.code)-3)+'-'+cn.[values] VendorCode
,left(c.code,len(c.code)-3)+'-01' VendorCode
--,id.en
,'NA' Modifier
,cust.en ModelAttributeValueDescription
--,*
from  [catalog].[UnitronProductTemp] b
left join [catalog].[UnitronCodeTemp] c on (c.product_Id=b.product_Id)
left join [catalog].[UnitronIdentifierTemp] id on (id.product_Id=b.product_Id)
left join [catalog].[UnitronPerformanceLevelTemp] pl on (pl.product_Id=b.product_Id)
left join [catalog].[UnitronPerformanceLevelNameTemp] pln on (pln.performanceLevel_Id=pl.performanceLevel_Id)
left join [catalog].[UnitronOptionsTemp] co on (co.product_Id=b.product_Id and co.code='FC')		-- Faceplate Color
left join [catalog].[UnitronOptionsValuesTemp] cn on (cn.initialOptions_Id=co.initialOptions_Id)
join catalog.ItemMasterList_Staging st on (st.ItemCode=(pln.en+'_'+id.en) and st.BrandCode = 'UNITRON')
left join (
			select 
			DISTINCT col.code
			,coln.en
			from [catalog].[UnitronColorTemp] col
			join [catalog].[UnitronColorNameTemp] coln on (coln.color_Id=col.color_Id)
		  ) cust on (cust.code=cn.[values])
where 1=1
and cn.[values] is not null
and pl.code is not null
and pln.en is not null

-------------------------------------------------- Color End --------------------------------------------------------------------------------------------------------


-------------------------------------------------- BTE Tubes (RECEIVER_SIZES)  Start--------------------------------------------------------------------------------------------------------

-- Load SPAREPART's tubes compatible for all BTE models
INSERT INTO [catalog].[ItemMasterAttributeValues_Staging]
SELECT
DISTINCT
'UNITRON'
,'RECIEVER_SIZES' AttributeCode
--,pln.en,id.en
,case when id.en like 'T Stride M%' and id.en not in ('T Stride M FLEX:TRIAL') then pln.en+'_'+mn.en+' '+pln.en
     else pln.en+'_'+id.en end ItemCode
,id1.en ModelAttributeValue
,1 IsActive
,r.target VendorCode
--,id.en
,case when id1.en like '%-L%' then 'LT' 
	  when id1.en like '%-R%' then 'RT' else 'NA' end Modifier
,id1.en ModelAttributeValueDescription
--,r.type,id1.en
from  [catalog].[UnitronProductTemp] b
left join [catalog].[UnitronCodeTemp] c on (c.product_Id=b.product_Id)
left join [catalog].[UnitronIdentifierTemp] id on (id.product_Id=b.product_Id)
left join [catalog].[UnitronPerformanceLevelTemp] pl on (pl.product_Id=b.product_Id)
left join [catalog].[UnitronPerformanceLevelNameTemp] pln on (pln.performanceLevel_Id=pl.performanceLevel_Id)
left join [catalog].[UnitronModelTypeTemp] m on (m.product_Id=c.product_Id) 
left join [catalog].[UnitronModelTypeNameTemp] mn on (mn.ModelTypeId=m.ModelTypeId) 
left join [catalog].[UnitronReferencesTemp] r on (r.product_Id=b.product_Id)
left join [catalog].[UnitronCodeTemp] c1 on (c1.code=r.target)
left join [catalog].[UnitronIdentifierTemp] id1 on (id1.product_Id=c1.product_Id)
join catalog.ItemMasterList_Staging st on (st.ItemCode=(pln.en+'_'+id.en) and st.BrandCode = 'UNITRON')
where 1=1
and r.type='SPAREPART'
AND id1.en like '%Slim Tube%'
and id1.en not in ('BTE Tool, Measurement tool (for Slim Tube/Receiver Length)')

-------------------------------------------------- BTE Tubes (RECEIVER_SIZES)  End --------------------------------------------------------------------------------------------------------


-------------------------------------------------- RIC Receiver Power & Sizes (RECIEVER_POWER & RECEIVER_SIZES)  Start --------------------------------------------------------------------------------------------------------

-- Receiver power and sizes are loaded from the same attribute  (NECESSARYITEMLEFT & NECESSARYITEMRIGHT references)
INSERT INTO [catalog].[ItemMasterAttributeValues_Staging]
SELECT
DISTINCT
'UNITRON'
,'RECIEVER_POWER' AttributeCode
--,pln.en,id.en
,case when id.en like 'T Stride M%' and id.en not in ('T Stride M FLEX:TRIAL') then pln.en+'_'+mn.en+' '+pln.en
     else pln.en+'_'+id.en end ItemCode
,id1.en ModelAttributeValue
,1 IsActive
,r.target VendorCode
--,r.type
,case when id1.en like '%L' or id1.en like '%Left' then 'LT' 
	  when id1.en like '%R' or id1.en like '%Right' then 'RT' 
	  else 'NA' end Modifier
,id1.en ModelAttributeValueDescription
from  [catalog].[UnitronProductTemp] b
left join [catalog].[UnitronCodeTemp] c on (c.product_Id=b.product_Id)
left join [catalog].[UnitronIdentifierTemp] id on (id.product_Id=b.product_Id)
left join [catalog].[UnitronPerformanceLevelTemp] pl on (pl.product_Id=b.product_Id)
left join [catalog].[UnitronPerformanceLevelNameTemp] pln on (pln.performanceLevel_Id=pl.performanceLevel_Id)
left join [catalog].[UnitronModelTypeTemp] m on (m.product_Id=c.product_Id) 
left join [catalog].[UnitronModelTypeNameTemp] mn on (mn.ModelTypeId=m.ModelTypeId) 
left join [catalog].[UnitronReferencesTemp] r on (r.product_Id=b.product_Id)
left join [catalog].[UnitronCodeTemp] c1 on (c1.code=r.target)
left join [catalog].[UnitronIdentifierTemp] id1 on (id1.product_Id=c1.product_Id)
join catalog.ItemMasterList_Staging st on (st.ItemCode=(pln.en+'_'+id.en) and st.BrandCode = 'UNITRON')
where 1=1
and r.type in ('NECESSARYITEMLEFT','NECESSARYITEMRIGHT','SPAREPART')
AND id1.en like '%receiver%'
and id1.en not like 'BTE Tool%'
-------------------------------------------------- RIC Receiver Power & Sizes (RECIEVER_POWER & RECEIVER_SIZES)  End --------------------------------------------------------------------------------------------------------



-------------------------------------------------- CUSTOM Receiver Power (PL) Start --------------------------------------------------------------------------------------------------------
-- CUSTOM Receivers (Power lever PL)
INSERT INTO [catalog].[ItemMasterAttributeValues_Staging]
select 
DISTINCT
'UNITRON'
,'RECIEVER_POWER' AttributeCode
--,pln.en,id.en
,pln.en+'_'+id.en ItemCode
,cust.code+'-'+cust.en ModelAttributeValue
,1 IsActive
,cn.[values] VendorCode
--,id.en
,'NA' Modifier
,cust.code ModelAttributeValueDescription
--,*
from  [catalog].[UnitronProductTemp] b
left join [catalog].[UnitronCodeTemp] c on (c.product_Id=b.product_Id)
left join [catalog].[UnitronIdentifierTemp] id on (id.product_Id=b.product_Id)
left join [catalog].[UnitronPerformanceLevelTemp] pl on (pl.product_Id=b.product_Id)
left join [catalog].[UnitronPerformanceLevelNameTemp] pln on (pln.performanceLevel_Id=pl.performanceLevel_Id)
left join [catalog].[UnitronOptionsTemp] co on (co.product_Id=b.product_Id and co.code='PL')		-- Power Level
left join [catalog].[UnitronOptionsValuesTemp] cn on (cn.initialOptions_Id=co.initialOptions_Id)
join catalog.ItemMasterList_Staging st on (st.ItemCode=(pln.en+'_'+id.en) and st.BrandCode = 'UNITRON')
left join (
			select 
			DISTINCT case when coln.en ='M' then 'Moderate' 
					      when coln.en ='P' then 'Power'
					      when coln.en ='S' then 'Standard'
					 else col.code end code
			,coln.en
			from [catalog].[UnitronPerformanceLevelTemp] col
			join [catalog].[UnitronPerformanceLevelNameTemp] coln on (coln.performanceLevel_Id=col.performanceLevel_Id)
			where 1=1
			and col.code like 'RECEIVER_%'
			UNION
			select 'Super Power','SP'
			UNION
			select 'Ultra Power','UP'   -- Add more power levels if available going forward
			UNION
			select 'None','NONE'
		  ) cust on (cust.en=cn.[values])
where 1=1
and cn.[values] is not null
-------------------------------------------------- CUSTOM Receiver Power (PL) Start --------------------------------------------------------------------------------------------------------

-------------------------------------------------- CUSTOM Shell Type (ST) Start --------------------------------------------------------------------------------------------------------
-- CUSTOM Shell Type (Shell Type ST)
INSERT INTO [catalog].[ItemMasterAttributeValues_Staging]
select 
DISTINCT
'UNITRON'
,'SHELL_TYPE' AttributeCode
--,pln.en,id.en
,pln.en+'_'+id.en ItemCode
,case when cn.[values] = 'H' then 'Half Shell'+'-'+cn.[values]
      when cn.[values] = 'N' then 'IIC'+'-'+cn.[values]
	  when cn.[values] = 'I' then 'CIC'+'-'+cn.[values]
	  when cn.[values] = 'M' then 'Mini Canal'+'-'+cn.[values]
	  when cn.[values] = 'C' then 'Canal'+'-'+cn.[values]
	  when cn.[values] = 'F' then 'Full Shell'+'-'+cn.[values]
else cn.[values] end ModelAttributeValue
,1 IsActive
,cn.[values] VendorCode
--,id.en
,'NA' Modifier
,case when cn.[values] = 'H' then 'Half Shell'
      when cn.[values] = 'N' then 'IIC'
	  when cn.[values] = 'I' then 'CIC'
	  when cn.[values] = 'M' then 'Mini Canal'
	  when cn.[values] = 'C' then 'Canal'
	  when cn.[values] = 'F' then 'Full Shell'
else cn.[values] end ModelAttributeValueDescription
--,*
from  [catalog].[UnitronProductTemp] b
left join [catalog].[UnitronCodeTemp] c on (c.product_Id=b.product_Id)
left join [catalog].[UnitronIdentifierTemp] id on (id.product_Id=b.product_Id)
left join [catalog].[UnitronPerformanceLevelTemp] pl on (pl.product_Id=b.product_Id)
left join [catalog].[UnitronPerformanceLevelNameTemp] pln on (pln.performanceLevel_Id=pl.performanceLevel_Id)
left join [catalog].[UnitronOptionsTemp] co on (co.product_Id=b.product_Id and co.code='ST')		-- Shell Style
left join [catalog].[UnitronOptionsValuesTemp] cn on (cn.initialOptions_Id=co.initialOptions_Id)
join catalog.ItemMasterList_Staging st on (st.ItemCode=(pln.en+'_'+id.en) and st.BrandCode = 'UNITRON')
left join (
			select 
			DISTINCT col.code
			,coln.en
			from [catalog].[UnitronColorTemp] col
			join [catalog].[UnitronColorNameTemp] coln on (coln.color_Id=col.color_Id)
		  ) cust on (cust.code=cn.[values])
where 1=1
and cn.[values] is not null
and pl.code is not null
and pln.en is not null
-------------------------------------------------- CUSTOM Shell Type (ST) End --------------------------------------------------------------------------------------------------------



-------------------------------------------------- Picture & Thumbnail URL's Start --------------------------------------------------------------------------------------------------------

-- Unitron pictures and thumbnail urls
/*
select 
c.code Vendor_Code
,id.en Product_Description
,pl.code PerformanceLevel_Code
,pln.en PerformanceLevel_Description
,co.code Color_Code
,co.value1 Color_RGB_or_HEX
,cn.en Color_Description
,pu.pictureURL Picture_URL
,tu.thumbnailURL Thumbnail_URL
from  [catalog].[UnitronProductTemp] b
left join [catalog].[UnitronCodeTemp] c on (c.product_Id=b.product_Id)
left join [catalog].[UnitronIdentifierTemp] id on (id.product_Id=b.product_Id)
left join [catalog].[UnitronPerformanceLevelTemp] pl on (pl.product_Id=b.product_Id)
left join [catalog].[UnitronPerformanceLevelNameTemp] pln on (pln.performanceLevel_Id=pl.performanceLevel_Id)
left join [catalog].[UnitronColorTemp] co on (co.product_Id=b.product_Id)
left join [catalog].[UnitronColorNameTemp] cn on (cn.color_Id=co.color_Id)
left join [catalog].[UnitronPictureURLTemp] pu on (pu.product_Id=b.product_Id)
left join [catalog].[UnitronThumbnailURLTemp] tu on (tu.product_Id=b.product_Id)
where 1=1
and pu.pictureURL!='https://dc-cached.phonakpro.comnull'
order by c.code
*/
-------------------------------------------------- Picture & Thumbnail URL's End --------------------------------------------------------------------------------------------------------

	COMMIT TRANSACTION UNITRON_ItemMaster_Temp_To_Stg
	PRINT 'SUCCESS'
	

	END TRY
	

	BEGIN CATCH

	DECLARE @ErrorMessage NVARCHAR(4000);  
    DECLARE @ErrorSeverity INT;  
    DECLARE @ErrorState INT;  

    SELECT   
        @ErrorMessage = ERROR_MESSAGE(),  
        @ErrorSeverity = ERROR_SEVERITY(),  
        @ErrorState = ERROR_STATE();  

		IF (@@TRANCOUNT > 0)
		BEGIN
			ROLLBACK TRANSACTION UNITRON_ItemMaster_Temp_To_Stg
			RAISERROR(@ErrorMessage,@ErrorSeverity,@ErrorState);
			PRINT 'FAILED'
		END

	END CATCH
END
create PROCEDURE [catalog].[GetModelContentByItemCode]
	-- Add the parameters for the stored procedure here
@ItemCode nvarchar(100) = null
AS
BEGIN
	-- SET NOCOUNT ON added to prevent extra result sets from
	-- interfering with SELECT statements.
	SET NOCOUNT ON;

    -- Insert statements for procedure here
SELECT TOP 1 [ItemmasterContentID] as 'ModelContentID',
       [BrandFamilyCode],[ModelCode],[ModelName],[DefaultImage],[FamilyBannerImage],[FamilyLogoImage],[FamilyProductCode],
       [ModelLongDescription],[ModelMobileAppsDescription],[ModelOverview],[ModelRatings],[ModelShortDescription],[ModelTitle],
	   CreateDate, CreateUser, ModifyDate, ModifyUser, IsActive
FROM [cms].[ItemmasterContent]
WHERE [ItemCode] = @ItemCode

END
-- =============================================
-- Author:		Mohan Nanduri
-- Create date: Feb 16th 2019
-- Description:	Returns Media  for given ItemCode
-- =============================================
CREATE PROCEDURE [catalog].[GetModelMediaByItemCode]
	-- Add the parameters for the stored procedure here
@ItemCode nvarchar(100) = null
AS
BEGIN
	-- SET NOCOUNT ON added to prevent extra result sets from
	-- interfering with SELECT statements.
	SET NOCOUNT ON;

    -- Insert statements for procedure here
SELECT a.[ItemmasterMediaID] as 'ModelMediaID', 
       null as 'Media',
       a.[MediaURL],
	   a.[MediaType],
	   a.[ModelCode],
	   a.[ModelColor],
	   a.[DefaultMedia],
	   '' as 'MediaDescription',
	   '' as 'IsWirelessAccessory',
	   a.CreateDate, a.CreateUser, a.ModifyDate, a.ModifyUser, a.IsActive
FROM [cms].[ItemmasterMedias] a
INNER JOIN [cms].[ItemmasterContent] b on a.[ItemmasterContentID] = b.[ItemmasterContentID]
WHERE a.ItemCode=@ItemCode

END
CREATE PROCEDURE [catalog].[proc_ProductModelFeaturesbyModelCode]
    @productModelCodes nvarchar(max) = null,
	@styleID int = 0
	--@catalogType nvarchar(max)=null,
	as
	select fv.* from [Catalog].FeatureValues fv
    inner join	[Catalog].Features f 
	--on f.FeatureName = fv.FeatureName where
	on f.FeatureID = fv.FeatureID where
	--f.StyleID = @styleID and
	 --((@catalogType = 'Custom' And f.StyleID = 1) OR (@catalogType = 'Standard' And f.StyleID > 1) OR (@catalogType is null And 1=1)) and
	 (fv.FeatureValueID in 
  (select FeatureValueID from [Catalog].[FeatureValueRules] where 
  (REPLACE(ProductModelCode, ' ','') in (select * from [Catalog].splitstring(@productModelCodes)))) or fv.IsDefault = 'Y') 
  and (fv.FeatureName='color')
  --and fv.FeatureName!='side' and fv.FeatureName!='processing'



--[catalog].[getModelDetailsByModelCode]
CREATE PROCEDURE [catalog].[proc_GetFeatures]
    @brandCodes nvarchar(max) = null,
    @brandFamilyCodes nvarchar(max) = null,
    @familyProductCodes nvarchar(max) = null,
    @productTypeCodes nvarchar(max) = null,
    @technologyLevelCodes nvarchar(max) = null,
    @shellCodes nvarchar(max) = null,
    @productModelCodes nvarchar(max) = null,
    @earmoldTypeCodes nvarchar(max) = null,
    @powerLevels nvarchar(max) = null,
    @pushButtons nvarchar(max) = null,
    @teleCoils nvarchar(max) = null,
    @sendReceivers nvarchar(max) = null,
    @materials nvarchar(max) = null,
    @couplings nvarchar(max)= null,
	@catalogType nvarchar(10) = null
	as

	
	select fv.* from [Catalog].FeatureValues fv
    inner join	[Catalog].Features f 
	on f.FeatureName = fv.FeatureName where
	 ((@catalogType = 'Custom' And f.StyleID = 1) OR (@catalogType = 'Standard' And f.StyleID > 1) OR (@catalogType is null And 1=1) ) and
	 (fv.FeatureValueID in 
  (select FeatureValueID from [Catalog].[FeatureValueRules] where
  (BrandCode in (select * from [Catalog].splitstring(@brandCodes)) or BrandCode is null) and
  (BrandFamilyCode in (select * from [Catalog].splitstring(@brandFamilyCodes)) or BrandFamilyCode is null) and
  (FamilyProductCode in (select * from [Catalog].splitstring(@familyProductCodes)) or FamilyProductCode is null) and
  (ProductTypeCode in (select * from [Catalog].splitstring(@productTypeCodes)) or ProductTypeCode is null) and
  (TechnologyLevelCode in (select * from [Catalog].splitstring(@technologyLevelCodes)) or TechnologyLevelCode is null) and
  (ShellCode in (select * from [Catalog].splitstring(@shellCodes)) or ShellCode is null) and
  (ProductModelCode in (select * from [Catalog].splitstring(@productModelCodes)) or ProductModelCode is null) and
  (EarmoldTypeCode   in (select * from [Catalog].splitstring(@earmoldTypeCodes)) or EarmoldTypeCode is null) and
  (PowerLevel in (select * from [Catalog].splitstring(@powerLevels)) or PowerLevel is null) and
  (PushButton in (select * from [Catalog].splitstring(@pushButtons)) or PushButton is null) and
  (TeleCoil in (select * from [Catalog].splitstring(@teleCoils)) or TeleCoil is null) and
  (SendReceiver in (select * from [Catalog].splitstring(@sendReceivers)) or SendReceiver is null) and
  (Material in (select * from [Catalog].splitstring(@materials)) or Material is null) and
  (Coupling in (select * from [Catalog].splitstring(@couplings)) or Coupling is null)) or fv.IsDefault = 'Y')
CREATE PROCEDURE [catalog].[proc_LoadCMSData]
	@brandFamilyCode varchar(30),  
	@familyProductCode varchar(30),
	@itemCode nvarchar(100),
	@shortDescription nvarchar(max),  -- done
	@longDescription nvarchar(max),  -- done
	@images nvarchar(max),   -- done
	@defaultImage nvarchar(max),  --done
	@videos nvarchar(max),   -- done
	@familyLogoImage nvarchar(max),  
	@familyBannerImage nvarchar(max), 
	@overview nvarchar(max),  -- done
	@quickGuidePdfs nvarchar(max), -- done
	-- @techSpecificationPdfs nvarchar(max), -- done
	@productBrochurePdfs nvarchar(max), -- done
	@reviews nvarchar(max)  

AS
BEGIN
insert into [cms].[ItemmasterContent](ModelLongDescription, ModelShortDescription,IsActive,BrandFamilyCode,FamilyProductCode, FamilyLogoImage, FamilyBannerImage,
			 DefaultImage,ModelRatings,ItemCode,createUser,ModifyUser) 
			 values (@longDescription,@shortDescription,1,@brandFamilyCode,@familyProductCode,@familyLogoImage,@familyBannerImage,@defaultImage,0,@itemCode,'rsareddy','rsareddy')
	if(@images is not null)
		begin

			
			
			insert into [cms].[ItemmasterMedias]([ItemmasterContentID],DefaultMedia, IsActive,MediaType,MediaURL,ItemCode,createUser,ModifyUser)  
			values ((select TOP 1 ItemmasterContentID from [cms].[ItemmasterContent] where ItemCode = @itemCode ORDER BY ItemmasterContentID),0,1,'Image',@images,@itemCode,'rsareddy','rsareddy')

			insert into [cms].[ItemMasterAccessories](IsActive,IsWirelessAccessory,[ItemmasterMediaID],ModelAccessoryName,BrandFamilyCode, FamilyProductCode,createUser,ModifyUser) 
			values (1,0,(select top 1 ItemmasterMediaID  from [cms].[ItemmasterMedias] where ItemCode = @itemCode order by ItemmasterMediaID desc), 'Images',@brandFamilyCode,@familyProductCode,'rsareddy','rsareddy')
		end


	if(@videos is not null)
		begin
			
			
			insert into [cms].[ItemmasterMedias]([ItemmasterContentID],DefaultMedia, IsActive,MediaType,MediaURL,ItemCode,createUser,ModifyUser)  
			values ((select TOP 1 ItemmasterContentID from [cms].[ItemmasterContent] where ItemCode = @itemCode ORDER BY ItemmasterContentID),0,1,'Video',@videos,@itemCode,'rsareddy','rsareddy')

			insert into [cms].[ItemMasterAccessories](IsActive,IsWirelessAccessory,[ItemmasterMediaID],ModelAccessoryName,BrandFamilyCode, FamilyProductCode,createUser,ModifyUser)  
			values (1,0,(select top 1 ItemmasterMediaID  from [cms].[ItemmasterMedias] where ItemCode = @itemCode order by ItemmasterMediaID desc), 'Videos',@brandFamilyCode,@familyProductCode,'rsareddy','rsareddy')
		end

	if(@overview is not null)
		begin
			
			insert into [cms].[ItemmasterMedias]([ItemmasterContentID],DefaultMedia, IsActive,MediaType,MediaURL,ItemCode,createUser,ModifyUser) 
			values ((select TOP 1 ItemmasterContentID from [cms].[ItemmasterContent] where ItemCode = @itemCode ORDER BY ItemmasterContentID),0,1,'Pdf',@overview,@itemCode,'rsareddy','rsareddy')

			insert into [cms].[ItemMasterAccessories](IsActive,IsWirelessAccessory,[ItemmasterMediaID],ModelAccessoryName,BrandFamilyCode, FamilyProductCode,createUser,ModifyUser)  
			values (1,0,(select top 1 ItemmasterMediaID  from [cms].[ItemmasterMedias] where ItemCode = @itemCode order by ItemmasterMediaID desc), 'Overview',@brandFamilyCode,@familyProductCode,'rsareddy','rsareddy')
		end

	if(@quickGuidePdfs is not null)
		begin
			
			insert into [cms].[ItemmasterMedias]([ItemmasterContentID],DefaultMedia, IsActive,MediaType,MediaURL,ItemCode,createUser,ModifyUser) 
			values ((select TOP 1 ItemmasterContentID from [cms].[ItemmasterContent] where ItemCode = @itemCode ORDER BY ItemmasterContentID),0,1,'Pdf',@quickGuidePdfs,@itemCode,'rsareddy','rsareddy')

			insert into [cms].[ItemMasterAccessories](IsActive,IsWirelessAccessory,[ItemmasterMediaID],ModelAccessoryName,BrandFamilyCode, FamilyProductCode,createUser,ModifyUser)  
			values (1,0,(select top 1 ItemmasterMediaID  from [cms].[ItemmasterMedias] where ItemCode = @itemCode order by ItemmasterMediaID desc), 'QuickGuide',@brandFamilyCode,@familyProductCode,'rsareddy','rsareddy')
		end

	

	if(@productBrochurePdfs is not null)
		begin
			
			insert into [cms].[ItemmasterMedias]([ItemmasterContentID],DefaultMedia, IsActive,MediaType,MediaURL,ItemCode,createUser,ModifyUser) 
			values ((select TOP 1 ItemmasterContentID from [cms].[ItemmasterContent] where ItemCode = @itemCode ORDER BY ItemmasterContentID),0,1,'Pdf',@productBrochurePdfs,@itemCode,'rsareddy','rsareddy')

			insert into [cms].[ItemMasterAccessories](IsActive,IsWirelessAccessory,[ItemmasterMediaID],ModelAccessoryName,BrandFamilyCode, FamilyProductCode,createUser,ModifyUser)  
			values (1,0,(select top 1 ItemmasterMediaID  from [cms].[ItemmasterMedias] where ItemCode = @itemCode order by ItemmasterMediaID desc), 'ProductBrochures',@brandFamilyCode,@familyProductCode,'rsareddy','rsareddy')
		end

	if(@reviews is not null)
		begin
			 insert into cms.ModelReviews(ModelReviewDescription,BrandFamilyCode, FamilyProductCode,IsActive,createUser,ModifyUser) 
			 values (@reviews,@brandFamilyCode,@familyProductCode,1,'rsareddy','rsareddy')
		
		end

END
CREATE PROCEDURE [catalog].[getModelDetailsByModelCodeMediaName]
@modelCode varchar(30),
@mediaName varchar(20)
AS
BEGIN

	SET NOCOUNT ON;

	if(@mediaName = 'Videos' or @mediaName = 'Downloads')
		begin
			select REPLACE(ModelCode, ' ',''),null as [Description],Media,MediaURL,null as ModelOverview from CMS.ItemMasterMedias where REPLACE( ModelCode, ' ','') = @modelCode  and MediaType = @mediaName
		end
	else if(@mediaName = 'Reviews')
		begin
			select REPLACE(ModelCode, ' ',''),ModelReviewDescription as [Description],null as Media, null as MediaURL,null as ModelOverview from CMS.ModelReviews where REPLACE(ModelCode, ' ','') = @modelCode 
		end
	else if(@mediaName = 'Mobile Apps')
		begin
			select REPLACE(ModelCode, ' ',''),ModelMobileAppsDescription as [Description],null as Media, null as MediaURL,null as ModelOverview from CMS.ItemMasterContent where REPLACE(ModelCode, ' ','') = @modelCode 
		end
	else if(@mediaName = 'Overview')
		begin
			select REPLACE(ModelCode, ' ',''),null as [Description],null as Media, null as MediaURL,ModelOverview from CMS.ItemMasterContent where REPLACE(ModelCode, ' ','') = @modelCode 
		end
	else 
		begin
			select REPLACE(ModelCode, ' ',''),[Description],null as Media, null as MediaURL,null as ModelOverview from CMS.ModelAccessories where REPLACE(ModelCode, ' ','') = @modelCode and ModelAccessoryName = @mediaName
		end
END
--******************************************************************
-- Crated by: Chandra Annapragada
-- Created Date: 24th June 2019
-- Description: This stored procedure is used to decide whether to bring the OrderItem information from the old catalog (especially for beltone and resound) Or from the new catalog.
-- Note: there were changes to the tables and their structures used in storing the item information for each brand.
--******************************************************************


CREATE PROCEDURE [catalog].[GetOrderItemDetails](
	@ToIncludeOldCataLogItems varchar(10),
	@OrderID bigint
	)
	AS
	BEGIN

	if(ltrim(rtrim(@ToIncludeOldCataLogItems)) ='YES')

		BEGIN
		    select distinct A.OrderID,A.ShippingData, A.MemberData, A.ProviderData,A.SpecialInstructions, C.Stylecode, C.TechnologyLevelCode,(select top 1 VendorCode from [catalog].[ItemMasterAttributeValues] where IsActive = 1 and ItemCode = C.ItemCode  and AttributeCode = 'COLOR'  and ltrim(rtrim(ModelAttributeValue)) = JSON_VALUE(C.ItemData,'$.color') and IsActive = 1) as ProductModelCode, (select top 1 VendorCode from [catalog].[ItemMasterAttributeValues] where ItemCode = C.ItemCode  and (attributeCode = 'RECIEVER_POWER')  and ltrim(rtrim(REPLACE(ModelAttributeValue,',',''))) = JSON_VALUE(C.ItemData,'$.receiverPower')  and Modifier = C.Modifier and IsActive = 1) as RiceiverCode,(select top 1 VendorCode from [catalog].[ItemMasterAttributeValues] where ItemCode = C.ItemCode  and (attributeCode = 'RECIEVER_SIZES')  and ltrim(rtrim(REPLACE(ModelAttributeValue,',',''))) = JSON_VALUE(C.ItemData,'$.receiverSize')  and Modifier = C.Modifier and IsActive = 1) as RiceiverSize, C.ItemCode, C.Modifier, C.Quantity, C.FamilyCode, C.BrandCode,(SELECT top 1[ProductTypeCode]  FROM[catalog].[ProductModelRules] where ProductModelCode in (C.ProductModelCode) and IsActive = 1) ProductType,(select top 1 technologyLevelcode from catalog.TechnologyLevelRules where isActive = 1 and ProducttypeCode = (SELECT top 1[ProductTypeCode]  FROM[catalog].[ProductModelRules] where isActive = 1 and ProductModelCode in (C.ProductModelCode)))  Connectivity,A.OrderStatusCode,C.[OrderItemId],C.[Amount],C.[ItemData],C.[itemType],C.[UnitPrice],C.[ProductModelCode] as ModelCode from Orders.Orders A left join [Orders].[OrderPOs] B on A.OrderID = B.OrderID left join[Orders].[OrderItems] C on A.OrderID = C.OrderID where  A.OrderStatusCode = 'APP' and C.IsActive = 1 and A.OrderID = ltrim(rtrim(@OrderID)); 
		END
	if(ltrim(rtrim(@ToIncludeOldCataLogItems)) ='NO')

		BEGIN
		select distinct A.OrderID,A.ShippingData, A.MemberData, A.ProviderData,A.SpecialInstructions, C.Stylecode, C.TechnologyLevelCode,(select top 1 VendorCode from [catalog].[ItemMasterAttributeValues] where IsActive = 1 and ItemCode = C.ItemCode  and AttributeCode = 'COLOR'  and ltrim(rtrim(ModelAttributeValue)) = JSON_VALUE(C.ItemData,'$.color') and IsActive = 1) as ProductModelCode,(select top 1 VendorCode from [catalog].[ItemMasterAttributeValues] where ItemCode = C.ItemCode  and (attributeCode = 'RECIEVER_POWER')  and ltrim(rtrim(REPLACE(ModelAttributeValue,',',''))) = JSON_VALUE(C.ItemData,'$.receiverPower')  and Modifier = C.Modifier and IsActive = 1) as RiceiverCode,(select top 1 VendorCode from [catalog].[ItemMasterAttributeValues] where ItemCode = C.ItemCode  and (attributeCode = 'RECIEVER_SIZES')  and ltrim(rtrim(REPLACE(ModelAttributeValue,',',''))) = JSON_VALUE(C.ItemData,'$.receiverSize')  and Modifier = C.Modifier and IsActive = 1) as RiceiverSize,C.ItemCode, C.Modifier, C.Quantity, C.FamilyCode, C.BrandCode,(select TOP 1 ModelAttributeValue from Catalog.ItemMasterAttributevalues where ItemCode = C.ItemCode and AttributeCode = 'CONNECTIVITY' and IsActive = 1) Connectivity,(select TOP 1 ModelAttributeValue from Catalog.ItemMasterAttributevalues where ItemCode = C.ItemCode and AttributeCode = 'PRODUCT_TYPE' and IsActive = 1) ProductType,A.OrderStatusCode,C.[OrderItemId],C.[Amount],C.[ItemData],C.[itemType],C.[UnitPrice],C.[ProductModelCode] as ModelCode from Orders.Orders A left join [Orders].[OrderPOs] B on A.OrderID = B.OrderID left join [Orders].[OrderItems] C on A.OrderID = C.OrderID where  A.OrderStatusCode = 'APP' and C.IsActive = 1 and A.OrderID = ltrim(rtrim(@OrderID));
		END

	END


CREATE PROCEDURE [catalog].[proc_ProductModels] 
  @BrandCode varchar(50),
  @EarmoldCode varchar(max),
  @BrandFamilyCode varchar(max),
  @FamilyProductCode varchar(max),
  @ProductTypeCode varchar(max),
  @TechnologyLevelCode varchar(max),
  @ShellCode varchar(max),
  @ReturnTable varchar(50),
  @InsuranceCarrierID int = 0 ,
  @HealthPlanID int = 0,
  @CatalogType varchar(50) = null,
  @Styles varchar(max)=null
   as
   begin
     
      declare @query varchar(max)
         declare @Schema varchar(50)
         set @Schema='[Catalog]'

              declare @ProductTypeResult varchar(max)
              declare @EarmoldTypeResult varchar(max)
              declare @TechnologyLevelResult varchar(max)
              declare @FamilyProductResult varchar(max)
              declare @ShellResult varchar(max)        
              declare @result varchar(max)

         -- Brands (Start)
       --  begin
       --select 'brand' as Brand,'CatalogType' as CatalogType,'Connectivity' as Connectivity,'EarmoldTypes' as EarmoldTypes,'Families' as Families,'ProductLines' as ProductLines,'ProductTypes' as ProductTypes,'Shells' as Shells 
         --select * from Brands
       -- end
       -- Brands (End)


       -- EarmoldTypes (Start)
       if(@ReturnTable ='EarmoldType')
       BEGIN
       
          set @query = ''
          set @query  = 'select EarmoldTypeCode from '+@Schema+'.EarMoldTypeRules where '

      if (@BrandCode is not null)
           set @query  = @query + ' BrandCode = '''+@BrandCode +''''
      else
           set @query  = @query + '1 = 1'

              if (@EarmoldCode is not null and @BrandFamilyCode is not null)
              begin
                     SELECT @result = COALESCE(@result + ',', '') +  CAST('''' + EarmoldTypeCode + ''''  AS VARCHAR(200)) + ''  FROM [Catalog].BrandFamilyRules  WHERE EarmoldTypeCode in (select * from  [Catalog].splitstring(@EarmoldCode)) group by EarmoldTypeCode
              end

              if (@result is not null)
              begin
                 if(@EarmoldCode is not null)
              set @query = 'Select * from '+@Schema+'.EarMoldTypes where EarmoldTypeCode in (' + @query + ') and (EarmoldTypeCode in (' + @result + ') or EarmoldTypeCode in (select * from [Catalog].splitstring('''+@EarmoldCode+''')))' 
                     else
                     set @query = 'Select * from '+@Schema+'.EarMoldTypes where EarmoldTypeCode in (' + @query + ') and EarmoldTypeCode in (' + @result + ')' 
               end
                else
                begin
                if(@EarmoldCode is not null)
                set @query = 'Select * from '+@Schema+'.EarMoldTypes where (EarmoldTypeCode in (' + @query + ') or EarmoldTypeCode in (select * from [Catalog].splitstring('''+@EarmoldCode+''')))'
                     else
                     set @query = 'Select * from '+@Schema+'.EarMoldTypes where EarmoldTypeCode in (' + @query + ')'
                     end
              --set @query = 'Select * from '+@Schema+'.EarMoldTypes where EarmoldTypeCode in (' + @query + ')'

                                                   if (@InsuranceCarrierID > 0 and @HealthPlanID > 0)
                    begin
                                                                                set @query =  @query + ' and EarmoldTypeCode in ( select distinct EarmoldTypeCode from [Catalog].ProductModels prod 
                                                                                                                                                inner join [Catalog].ProductModelRules prodr 
                                                                                                                                                on prod.ProductModelCode = prodr.ProductModelCode 
                                                                                                                                                left join insurance.ContractProducts conProd
                                                                                                                                                on conProd.FamilyProductCode = prodr.FamilyProductCode
                                                                                                                                             --   or conProd.ProductTypeCode = prodr.ProductTypeCode
                                                                                                                                                left join insurance.ContractBenefits contBen
                                                                                                                                                on contBen.HealthPlanContractID = conProd.HealthPlanContractID
                                                                                                                                                left join insurance.HealthPlanContracts healthPC
                                                                                                                                                on healthPC.HealthPlanContractID = contBen.HealthPlanContractID
                                                                                                                                                left join insurance.InsuranceHealthPlans insHP
                                                                                                                                                on healthPC.InsuranceHealthPlanID = insHP.InsuranceHealthPlanID   
                                                                                                                                                where insHP.InsuranceHealthPlanID = ' +CONVERT(varchar(10), @HealthPlanID)+ ' 
                                                                                                                                                and healthPC.InsuranceCarrierID = ' +CONVERT(varchar(10), @InsuranceCarrierID)+' 
                                                                                                                                                and EarmoldTypeCode is not null)'
                                                                                end


              print @query
              print @result
              exec (@query)
       END
       -- EarmoldTypes (End)

       else if(@ReturnTable ='BrandFamily')
       -- BrandFamilies (Start)
         BEGIN

         set @query = ''
          set @query  = 'select BrandFamilyCode from '+@Schema+'.BrandFamilyRules where '

      if (@BrandCode is not null)
          set @query  = @query + ' BrandCode = '''+@BrandCode+''''
      else
           set @query  = @query + '1 = 1'

              set @query = @query + ' And '

          if (@EarmoldCode is not null)
           set @query  = @query + ' (EarmoldTypeCode in (select * from [Catalog].splitstring('''+@EarmoldCode+''')) or EarmoldTypeCode is null)' 
      else
           set @query  = @query + '1 = 1'

              if (@ProductTypeCode is not null)
              begin
                     SELECT @ProductTypeResult = COALESCE(@ProductTypeResult + ',', '') +  CAST('''' + BrandFamilyCode + ''''  AS VARCHAR(200)) + ''  FROM [Catalog].ProductTypeRules  WHERE ProductTypeCode in (select * from  [Catalog].splitstring(@ProductTypeCode)) group by BrandFamilyCode
                     set @result = @ProductTypeResult;
              end
         
              if (@TechnologyLevelCode is not null)
              begin                      
                     SELECT @TechnologyLevelResult = COALESCE(@TechnologyLevelResult + ',', '') +  CAST('''' + BrandFamilyCode + ''''  AS VARCHAR(200)) + ''  from [Catalog].TechnologyLevelRules where TechnologyLevelCode in (select * from  [Catalog].splitstring(@TechnologyLevelCode)) group by BrandFamilyCode
                     if(@result is not null)
                           set @result = @result + @TechnologyLevelResult;
                     else
                           set @result = @TechnologyLevelResult;
              end

              if (@FamilyProductCode is not null)
              begin                      
                     SELECT @FamilyProductResult = COALESCE(@FamilyProductResult + ',', '') +  CAST('''' + BrandFamilyCode + ''''  AS VARCHAR(200)) + ''  from [Catalog].FamilyProductRules where FamilyProductCode in (select * from  [Catalog].splitstring(@FamilyProductCode)) group by BrandFamilyCode
                     if(@result is not null)
                           set @result = @result + @FamilyProductResult;
                     else
                           set @result = @FamilyProductResult;
              end

              if (@ShellCode is not null)
              begin                      
                     SELECT @ShellResult = COALESCE(@ShellResult + ',', '') +  CAST('''' + BrandFamilyCode + ''''  AS VARCHAR(200)) + ''  from [Catalog].ShellRules where ShellCode in (select * from  [Catalog].splitstring(@ShellCode)) group by BrandFamilyCode
                     if(@result is not null)
                           set @result = @result + @ShellResult;
                     else
                           set @result = @ShellResult;
              end

              if (@result is not null)
              begin

                 if(@BrandFamilyCode is not null)
                  set @query = 'Select * from '+@Schema+'.BrandFamilies where BrandFamilyCode in (' + @query + ') and (BrandFamilyCode in (' + @result + ') or BrandFamilyCode in (select * from [Catalog].splitstring('''+@BrandFamilyCode+''')))' 
                     else
                     set @query = 'Select * from '+@Schema+'.BrandFamilies where BrandFamilyCode in (' + @query + ') and BrandFamilyCode in (' + @result + ')' 
                     end
                else
                begin
                if(@BrandFamilyCode is not null)
                  set @query = 'Select * from '+@Schema+'.BrandFamilies where (BrandFamilyCode in (' + @query + ') or BrandFamilyCode in (select * from [Catalog].splitstring('''+@BrandFamilyCode+''')))'
                     else
                     set @query = 'Select * from '+@Schema+'.BrandFamilies where BrandFamilyCode in (' + @query + ')'
              end

                                                  if (@InsuranceCarrierID > 0 and @HealthPlanID > 0)
                    begin
                                                                                set @query =  @query + ' and BrandFamilyCode in ( select distinct BrandFamilyCode from [Catalog].ProductModels prod 
                                                                                                                                                inner join [Catalog].ProductModelRules prodr 
                                                                                                                                                on prod.ProductModelCode = prodr.ProductModelCode 
                                                                                                                                                left join insurance.ContractProducts conProd
                                                                                                                                                on conProd.FamilyProductCode = prodr.FamilyProductCode
                                                                                                                                             --   or conProd.ProductTypeCode = prodr.ProductTypeCode
                                                                                                                                                left join insurance.ContractBenefits contBen
                                                                                                                                                on contBen.HealthPlanContractID = conProd.HealthPlanContractID
                                                                                                                                                left join insurance.HealthPlanContracts healthPC
                                                                                                                                                on healthPC.HealthPlanContractID = contBen.HealthPlanContractID
                                                                                                                                                left join insurance.InsuranceHealthPlans insHP
                                                                                                                                                on healthPC.InsuranceHealthPlanID = insHP.InsuranceHealthPlanID   
                                                                                                                                                where insHP.InsuranceHealthPlanID = ' +CONVERT(varchar(10), @HealthPlanID)+ ' 
                                                                                                                                                and healthPC.InsuranceCarrierID = ' +CONVERT(varchar(10), @InsuranceCarrierID)+' 
                                                                                                                                                and BrandFamilyCode is not null)'
                                                                                end

              --set @query = 'Select * from '+@Schema+'.BrandFamilies where BrandFamilyCode in (' + @query + ')' 
              
              --print @BrandFamilyCode
           print @query
              exec (@query) 

       END
       -- BrandFamilies (End)
       else if(@ReturnTable ='Shell')
         -- Shells (Start)
       BEGIN

          set @query = ''
          set @query  = 'select ShellCode from '+@Schema+'.ShellRules where '

      if (@BrandFamilyCode is not null)
           set @query  = @query + ' BrandFamilyCode in  (select * from [Catalog].splitstring('''+@BrandFamilyCode +'''))'
         else if (@BrandCode is not null)
          set @query  = @query + ' BrandFamilyCode in (select BrandFamilyCode from Catalog.BrandFamilyRules where BrandCode in ('''+@BrandCode+'''))'
         else
           set @query  = @query + '1 = 1'
          
               set @query  = @query + ' AND '

         if (@FamilyProductCode is not null)
           set @query  = @query + ' (FamilyProductCode in (select * from [Catalog].splitstring('''+@FamilyProductCode +''')) or FamilyProductCode is null)' 
      else
           set @query  = @query + '1 = 1'

              set @query = 'Select * from '+@Schema+'.Shells where ShellCode in (' + @query + ')'

                                if (@InsuranceCarrierID > 0 and @HealthPlanID > 0)
            begin
                                                set @query =  @query + ' and ShellCode in ( select distinct ShellCode from [Catalog].ProductModels prod 
                                                                                                                inner join [Catalog].ProductModelRules prodr 
                                                                                                                on prod.ProductModelCode = prodr.ProductModelCode 
                                                                                                                left join insurance.ContractProducts conProd
                                                                                                                on conProd.FamilyProductCode = prodr.FamilyProductCode
                                                                                                              --  or conProd.ProductTypeCode = prodr.ProductTypeCode
                                                                                                                left join insurance.ContractBenefits contBen
                                                                                                                on contBen.HealthPlanContractID = conProd.HealthPlanContractID
                                                                                                                left join insurance.HealthPlanContracts healthPC
                                                                                                                on healthPC.HealthPlanContractID = contBen.HealthPlanContractID
                                                                                                                left join insurance.InsuranceHealthPlans insHP
                                                                                                                on healthPC.InsuranceHealthPlanID = insHP.InsuranceHealthPlanID   
                                                                                                                where insHP.InsuranceHealthPlanID = ' +CONVERT(varchar(10), @HealthPlanID)+ ' 
                                                                                                                and healthPC.InsuranceCarrierID = ' +CONVERT(varchar(10), @InsuranceCarrierID)+' 
                                                                                                                and ShellCode is not null)'
                                                end

              print @query
              exec (@query)
       END
       -- Shells (End)
       else if(@ReturnTable ='FamilyProduct')
       -- Family Products (Start) //Technology Level
       BEGIN

         set @query = ''
          set @query  = 'select FamilyProductCode from '+@Schema+'.FamilyProductRules where '

      if (@BrandFamilyCode is not null)
           set @query  = @query + ' BrandFamilyCode in (select * from [Catalog].splitstring('''+@BrandFamilyCode+'''))'
      else if (@BrandCode is not null)
          set @query  = @query + ' BrandFamilyCode in (select BrandFamilyCode from Catalog.BrandFamilyRules where BrandCode in ('''+@BrandCode+'''))'
         else
           set @query  = @query + '1 = 1'

              set @query = @query + ' And '

              if (@TechnologyLevelCode is not null)
           set @query  = @query + ' (TechnologyLevelCode  in (select * from [Catalog].splitstring('''+ @TechnologyLevelCode+''')) or TechnologyLevelCode is null)'  
      else
           set @query  = @query + '1 = 1'

              if (@ShellCode is not null)
              begin
                     SELECT @ShellResult = COALESCE(@ShellResult + ',', '') +  CAST('''' + FamilyProductCode + ''''  AS VARCHAR(200)) + ''  FROM [Catalog].ShellRules  WHERE ShellCode in (select * from  [Catalog].splitstring(@ShellCode)) group by FamilyProductCode
                     set @result = @ShellResult;
              end
         
              if (@ProductTypeCode is not null)
              begin                      
                     SELECT @ProductTypeResult = COALESCE(@ProductTypeResult + ',', '') +  CAST('''' + FamilyProductCode + ''''  AS VARCHAR(200)) + ''  from [Catalog].ProductTypeRules where ProductTypeCode in (select * from  [Catalog].splitstring(@ProductTypeCode)) group by FamilyProductCode
                     if(@result is not null)
                           set @result = @result + @ProductTypeResult;
                     else
                           set @result = @ProductTypeResult;
              end
              
              if (@result is not null)
              begin
                if(@FamilyProductCode is not null)
                  set @query = 'Select * from '+@Schema+'.FamilyProducts where FamilyProductCode in (' + @query + ') and (FamilyProductCode in (' + @result + ') or FamilyProductCode in (select * from [Catalog].splitstring('''+@FamilyProductCode+''')))'
                     else
                     set @query = 'Select * from '+@Schema+'.FamilyProducts where FamilyProductCode in (' + @query + ') and FamilyProductCode in (' + @result + ')'
              end
                     
                else
                begin
                if(@FamilyProductCode is not null)
                  set @query = 'Select * from '+@Schema+'.FamilyProducts where (FamilyProductCode in (' + @query + ') or FamilyProductCode in (select * from [Catalog].splitstring('''+@FamilyProductCode+''')))'
                     else
                     set @query = 'Select * from '+@Schema+'.FamilyProducts where FamilyProductCode in (' + @query + ')'
                     end
              --set @query = 'Select * from '+@Schema+'.FamilyProducts where FamilyProductCode in (' + @query + ')'
			  declare @styleQuery varchar(max);
			  if(@Styles is not null)
			  set @styleQuery= ' prodr.StyleID in (select * from [Catalog].splitstring('''+@Styles+'''))'
			  else 
			  set @styleQuery=' 1=1'
            if (@InsuranceCarrierID > 0 and @HealthPlanID > 0)
            begin
                                                set @query =  @query + ' and FamilyProductCode in ( select distinct prodr.FamilyProductCode from [Catalog].ProductModels prod 
                                                                                                                inner join [Catalog].ProductModelRules prodr 
                                                                                                                on prod.ProductModelCode = prodr.ProductModelCode 
                                                                                                                left join insurance.ContractProducts conProd
                                                                                                                on conProd.FamilyProductCode = prodr.FamilyProductCode
                                                                                                              --  or conProd.ProductTypeCode = prodr.ProductTypeCode
                                                                                                                left join insurance.ContractBenefits contBen
                                                                                                                on contBen.HealthPlanContractID = conProd.HealthPlanContractID
                                                                                                                left join insurance.HealthPlanContracts healthPC
                                                                                                                on healthPC.HealthPlanContractID = contBen.HealthPlanContractID
                                                                                                                left join insurance.InsuranceHealthPlans insHP
                                                                                                                on healthPC.InsuranceHealthPlanID = insHP.InsuranceHealthPlanID   
                                                                                                                where insHP.InsuranceHealthPlanID = ' +CONVERT(varchar(10), @HealthPlanID)+ ' 
                                                                                                                and healthPC.InsuranceCarrierID = ' +CONVERT(varchar(10), @InsuranceCarrierID)+' 
                                                                                                                and prodr.FamilyProductCode is not null and '+@styleQuery+') and IsActive=1'
                                                end
                                                  
              print @query
              exec (@query)

       END
       -- Family Products (End)

       else if(@ReturnTable ='ProductType')
       -- Product Type (Start)
       BEGIN

         set @query = ''
          set @query  = 'select ProductTypeCode from '+@Schema+'.ProductTypeRules where '

      if (@BrandFamilyCode is not null)
           set @query  = @query + ' BrandFamilyCode  in (select * from [Catalog].splitstring('''+@BrandFamilyCode+'''))'  
      else if (@BrandCode is not null)
          set @query  = @query + ' BrandFamilyCode in (select BrandFamilyCode from Catalog.BrandFamilyRules where BrandCode in ('''+@BrandCode+'''))'
         else
           set @query  = @query + '1 = 1'

              set @query = @query + ' And '

              if (@FamilyProductCode is not null)
           set @query  = @query + ' (FamilyProductCode  in (select * from [Catalog].splitstring('''+@FamilyProductCode+''')) or FamilyProductCode is null)' 
      else
           set @query  = @query + '1 = 1'

              if (@TechnologyLevelCode is not null)
              begin
                     SELECT @result = COALESCE(@result + ',', '') +  CAST('''' + ProductTypeCode + ''''  AS VARCHAR(200)) + ''  FROM [Catalog].TechnologyLevelRules  WHERE TechnologyLevelCode in (select * from  [Catalog].splitstring(@TechnologyLevelCode)) group by ProductTypeCode
              end

              if (@result is not null)
              begin
                if(@ProductTypeCode is not null)
                  set @query = 'Select * from '+@Schema+'.ProductTypes where ProductTypeCode in (' + @query + ') and (ProductTypeCode in (' + @result + ') or ProductTypeCode in (select * from [Catalog].splitstring('''+@ProductTypeCode+''')))'
                     else
                     set @query = 'Select * from '+@Schema+'.ProductTypes where ProductTypeCode in (' + @query + ') and ProductTypeCode in (' + @result + ')'
              end
                     
                else
                begin
                if(@ProductTypeCode is not null)
                  set @query = 'Select * from '+@Schema+'.ProductTypes where (ProductTypeCode in (' + @query + ') or ProductTypeCode in (select * from [Catalog].splitstring('''+@ProductTypeCode+''')))'
                     else
                     set @query = 'Select * from '+@Schema+'.ProductTypes where ProductTypeCode in (' + @query + ')'
                     end


            if (@InsuranceCarrierID > 0 and @HealthPlanID > 0)
            begin
                                                set @query =  @query + ' and ProductTypeCode in ( select distinct prodr.ProductTypeCode from [Catalog].ProductModels prod 
                                                                                                                inner join [Catalog].ProductModelRules prodr 
                                                                                                                on prod.ProductModelCode = prodr.ProductModelCode 
                                                                                                                left join insurance.ContractProducts conProd
                                                                                                                on conProd.FamilyProductCode = prodr.FamilyProductCode
                                                                                                             --   or conProd.ProductTypeCode = prodr.ProductTypeCode
                                                                                                                left join insurance.ContractBenefits contBen
                                                                                                                on contBen.HealthPlanContractID = conProd.HealthPlanContractID
                                                                                                                left join insurance.HealthPlanContracts healthPC
                                                                                                                on healthPC.HealthPlanContractID = contBen.HealthPlanContractID
                                                                                                                left join insurance.InsuranceHealthPlans insHP
                                                                                                                on healthPC.InsuranceHealthPlanID = insHP.InsuranceHealthPlanID   
                                                                                                                where insHP.InsuranceHealthPlanID = ' +CONVERT(varchar(10), @HealthPlanID)+ ' 
                                                                                                                and healthPC.InsuranceCarrierID = ' +CONVERT(varchar(10), @InsuranceCarrierID)+' 
                                                                                                                and prodr.ProductTypeCode is not null)'
                                                end

         print @query
         exec (@query)

       END
       -- Product Type (End)
       else if(@ReturnTable ='TechnologyLevel')
       -- Technology Levels (Start)
       BEGIN

          set @query = ''
          set @query  = 'select TechnologyLevelCode from '+@Schema+'.TechnologyLevelRules where '

      if (@BrandFamilyCode is not null)
           set @query  = @query + ' BrandFamilyCode  in (select * from [Catalog].splitstring('''+@BrandFamilyCode+'''))'  
      else if (@BrandCode is not null)
          set @query  = @query + ' BrandFamilyCode in (select BrandFamilyCode from Catalog.BrandFamilyRules where BrandCode in ('''+@BrandCode+'''))'
         else
           set @query  = @query + '1 = 1'

              set @query = @query + ' And '

              if (@ProductTypeCode is not null)
           set @query  = @query + ' (ProductTypeCode in (select * from [Catalog].splitstring('''+@ProductTypeCode+''')) or ProductTypeCode is null)'   
      else
           set @query  = @query + '1 = 1'

              if (@FamilyProductCode is not null)
              begin
                     SELECT @result = COALESCE(@result + ',', '') +  CAST('''' + TechnologyLevelCode + ''''  AS VARCHAR(200)) + ''  FROM [Catalog].FamilyProductRules  WHERE FamilyProductCode in (select * from  [Catalog].splitstring(@FamilyProductCode)) group by TechnologyLevelCode
              end
         
               if (@result is not null)
              begin
                 if(@TechnologyLevelCode is not null)
                  set @query = 'Select * from '+@Schema+'.TechnologyLevel where TechnologyLevelCode in (' + @query + ') and (TechnologyLevelCode in (' + @result + ') or TechnologyLevelCode in (select * from [Catalog].splitstring('''+@TechnologyLevelCode+''')))'
                     else
                     set @query = 'Select * from '+@Schema+'.TechnologyLevel where TechnologyLevelCode in (' + @query + ') and TechnologyLevelCode in (' + @result + ')'
              end
                     
                else
                begin
                if(@TechnologyLevelCode is not null)
                  set @query = 'Select * from '+@Schema+'.TechnologyLevel where (TechnologyLevelCode in (' + @query + ') or TechnologyLevelCode in (select * from [Catalog].splitstring('''+@TechnologyLevelCode+''')))'
                     else
                     set @query = 'Select * from '+@Schema+'.TechnologyLevel where TechnologyLevelCode in (' + @query + ')'
                     end


                                if (@InsuranceCarrierID > 0 and @HealthPlanID > 0)
                                                                                begin
                                                                                set @query =  @query + ' and TechnologyLevelCode in ( select distinct prodr.TechnologyLevelCode from [Catalog].ProductModels prod 
                                                                                                                                                inner join [Catalog].ProductModelRules prodr 
                                                                                                                                                on prod.ProductModelCode = prodr.ProductModelCode 
                                                                                                                                                left join insurance.ContractProducts conProd
                                                                                                                                                on conProd.FamilyProductCode = prodr.FamilyProductCode
                                                                                                                                              --  or conProd.ProductTypeCode = prodr.ProductTypeCode
                                                                                                                                                left join insurance.ContractBenefits contBen
                                                                                                                                                on contBen.HealthPlanContractID = conProd.HealthPlanContractID
                                                                                                                                                left join insurance.HealthPlanContracts healthPC
                                                                                                                                                on healthPC.HealthPlanContractID = contBen.HealthPlanContractID
                                                                                                                                                left join insurance.InsuranceHealthPlans insHP
                                                                                                                                                on healthPC.InsuranceHealthPlanID = insHP.InsuranceHealthPlanID   
                                                                                                                                                where insHP.InsuranceHealthPlanID = ' +CONVERT(varchar(10), @HealthPlanID)+ ' 
                                                                                                                                                and healthPC.InsuranceCarrierID = ' +CONVERT(varchar(10), @InsuranceCarrierID)+' 
                                                                                                                                                and prodr.TechnologyLevelCode is not null)'
                                                                                end

              print @query
              exec (@query)

       END
       -- Technology Levels (End)
         else if(@ReturnTable ='ProductModel')
       -- Product Models (Start)
         BEGIN
         
          set @query = ''
          if (@InsuranceCarrierID = 0 and @HealthPlanID = 0)
          set @query  = ' where '
      if (@BrandCode is not null)
           set @query  =  @query + ' (prodr.BrandCode = '''+@BrandCode+''' or prodr.BrandCode is null)'
         else
           set @query  = @query + '1 = 1'

              set @query = @query + ' And '

              if (@EarmoldCode is not null)
           set @query  = @query + ' (prodr.EarmoldTypeCode in (select * from [Catalog].splitstring('''+@EarmoldCode+''')))'    
      else
           set @query  = @query + '1 = 1'
              
              set @query = @query + ' And '

              if (@BrandFamilyCode is not null)
           set @query  = @query + ' (prodr.BrandFamilyCode in (select * from [Catalog].splitstring('''+@BrandFamilyCode+''')))' 
      else
           set @query  = @query + '1 = 1'

              set @query = @query + ' And '

              if (@ProductTypeCode is not null)
           set @query  = @query + ' (prodr.ProductTypeCode in (select * from [Catalog].splitstring('''+@ProductTypeCode+''')))' 
      else
           set @query  = @query + '1 = 1'

              set @query = @query + ' And '

              if (@TechnologyLevelCode is not null)
           set @query  = @query + ' (prodr.TechnologyLevelCode  in (select * from [Catalog].splitstring('''+@TechnologyLevelCode+''')))'
      else
           set @query  = @query + '1 = 1'

              set @query = @query + ' And '

              if (@FamilyProductCode is not null)
           set @query  = @query + ' (prodr.FamilyProductCode  in (select * from [Catalog].splitstring('''+@FamilyProductCode+''')))'
      else
           set @query  = @query + '1 = 1'

              set @query = @query + ' And '

              if (@ShellCode is not null)
           set @query  = @query + ' (prodr.ShellCode  in (select * from [Catalog].splitstring('''+@ShellCode+''')))'
      else
           set @query  = @query + '1 = 1'

              set @query = @query + ' And '

              --if(@CatalogType is not null)
              --       begin
              --       if(@CatalogType = 'Custom')
              --       set @query = @query + 'prodr.StyleID =1'
              --       else if(@CatalogType = 'Standard')
              --       set @query = @query + 'prodr.StyleID > 1'
              --       else 
              --       set @query = @query + '1 = 1'
              --       end
              --else
              --set @query = @query + '1 = 1'
			  if(@Styles is not null)
                     begin
                     set @query = @query + 'prodr.StyleID in (select * from [Catalog].splitstring('''+@Styles+'''))'
                     end
              else
              set @query = @query + '1 = 1'
                           if (@InsuranceCarrierID > 0 and @HealthPlanID > 0)
                                  begin
                                         set @query = 'select prod.ProductModelID,prod.ProductModelCode,prod.ProductModelName,prod.CreateDate,prod.ModifyDate,prod.CreateUser,prod.Modifyuser,prod.ImageURL,
                             prodr.BrandCode,prodr.BrandFamilyCode,prodr.EarmoldTypeCode,prodr.FamilyProductCode,prodr.ProductTypeCode,prodr.ShellCode,prodr.TechnologyLevelCode,prod.IsActive,prod.StyleID,
                                     ISNULL(conProd.PerDeviceMemberPrice,0) as UnitProductPrice, 0 as PairProductPrice, ISNULL(contBen.BenefitAmt,0) as Benefit,modelcontent.ModelRatings,modelcontent.ModelShortDescription as Description,modelcontent.DefaultImage as MediaURL,style.StyleName
                                     from '+@Schema+'.ProductModels prod join '+@Schema+'.ProductModelRules prodr 
                                             on prod.ProductModelCode = prodr.ProductModelCode 
											 left join '+@Schema+'.Styles style 
											 on prodr.StyleID = style.StyleID
                                             left join insurance.ContractProducts conProd
                                                on conProd.FamilyProductCode = prodr.FamilyProductCode
                                               -- or conProd.ProductTypeCode = prodr.ProductTypeCode
                                                left join insurance.ContractBenefits contBen
                                                on contBen.HealthPlanContractID = conProd.HealthPlanContractID
                                                left join insurance.HealthPlanContracts healthPC
                                                on healthPC.HealthPlanContractID = contBen.HealthPlanContractID
                                                left join insurance.InsuranceHealthPlans insHP
                                                on healthPC.InsuranceHealthPlanID = insHP.InsuranceHealthPlanID                                            
                                             left join CMS.ItemMasterContent modelcontent
                                             on prodr.BrandFamilyCode = modelcontent.BrandFamilyCode
                                                and (prodr.FamilyProductCode = modelcontent.FamilyProductCode or prodr.FamilyProductCode is null)
                                                where (insHP.InsuranceHealthPlanID = ' +CONVERT(varchar(10), @HealthPlanID)+ ' and healthPC.InsuranceCarrierID = ' +CONVERT(varchar(10), @InsuranceCarrierID)+') and prod.isActive=1 and healthPC.isActive=1 and ' + @query + ''  
                                  end
                           else 
                                  begin
                                         set @query = 'select prod.ProductModelID,prod.ProductModelCode,prod.ProductModelName,prod.CreateDate,prod.ModifyDate,prod.CreateUser,prod.Modifyuser,prod.ImageURL,
                                                       prodr.BrandCode,prodr.BrandFamilyCode,prodr.EarmoldTypeCode,prodr.FamilyProductCode,prodr.ProductTypeCode,prodr.ShellCode,prodr.TechnologyLevelCode,prod.IsActive,prod.StyleID,
                                                       CAST(''2700'' AS DECIMAL)  as UnitProductPrice,CAST(''2200'' AS DECIMAL) as PairProductPrice, CAST(''300'' AS DECIMAL) as Benefit,modelmedia.MediaURL,modelcontent.ModelRatings,modelcontent.ModelShortDescription as Description,modelcontent.DefaultImage as MediaURL
                                                       from '+@Schema+'.ProductModels prod join '+@Schema+'.ProductModelRules prodr 
                                                       on prod.ProductModelCode = prodr.ProductModelCode 
                                                       left join CMS.ItemMasterContent modelcontent
                                                 on prodr.BrandFamilyCode = modelcontent.BrandFamilyCode
                                                       and (prodr.FamilyProductCode = modelcontent.FamilyProductCode or prodr.FamilyProductCode is null)
                                                       ' + @query + ''

                                                              --   left join CMS.ModelContents modelcontent
                                                  --on prodr.ProductModelCode = modelcontent.ModelCode
                                  end
              print @query
              exec (@query)

              End  
              -- Product Models (End)
              
   end

----------------------------------------------------------------
/*

 exec [Catalog].[proc_ProductModels] 
'GNR',
  null,
  null,
  null,
  null,
  null,
  null,
  'ProduCtModel',
 1,
  1,
  'Standard'

  */

/****** To get PRODUCT MODEL FEATURES ******/
/****** Object:  StoredProcedure [Catalog].[proc_ProductModelsByFeatures]    Script Date: 15-Nov-17 9:39:28 PM ******/
 CREATE PROCEDURE [catalog].[proc_ProductModels_b] 
  @BrandCode varchar(50),
  @EarmoldCode varchar(50),
  @BrandFamilyCode varchar(50),
  @FamilyProductCode varchar(50),
  @ProductTypeCode varchar(50),
  @TechnologyLevelCode varchar(50),
  @ShellCode varchar(50),
  @ReturnTable varchar(50)   
   as
   begin
     
      declare @query varchar(max)
	  declare @Schema varchar(50)
	  set @Schema='[Catalog]'

	  	declare @ProductTypeResult varchar(max)
		declare @EarmoldTypeResult varchar(max)
		declare @TechnologyLevelResult varchar(max)
		declare @FamilyProductResult varchar(max)
		declare @ShellResult varchar(max)		
		declare @result varchar(max)

	  -- Brands (Start)
	--  begin
	--select 'brand' as Brand,'CatalogType' as CatalogType,'Connectivity' as Connectivity,'EarmoldTypes' as EarmoldTypes,'Families' as Families,'ProductLines' as ProductLines,'ProductTypes' as ProductTypes,'Shells' as Shells 
	  --select * from Brands
	-- end
	 -- Brands (End)


	 -- EarmoldTypes (Start)
	 if(@ReturnTable ='EarmoldType')
	BEGIN
	
	   set @query = ''
	   set @query  = 'select EarmoldTypeCode from '+@Schema+'.EarMoldTypeRules where '

      if (@BrandCode is not null)
	    set @query  = @query + ' BrandCode = '''+@BrandCode +''''
      else
	    set @query  = @query + '1 = 1'

		if (@EarmoldCode is not null)
		begin
			SELECT @result = COALESCE(@result + ',', '') +  CAST('''' + EarmoldTypeCode + ''''  AS VARCHAR(200)) + ''  FROM [Catalog].BrandFamilyRules  WHERE EarmoldTypeCode in (select * from  [Catalog].splitstring(@EarmoldCode)) group by EarmoldTypeCode
		end

		 if (@result is not null)
			set @query = 'Select * from '+@Schema+'.EarMoldTypes where EarmoldTypeCode in (' + @query + ') and EarmoldTypeCode in (' + @result + ')' 
		  else
		    set @query = 'Select * from '+@Schema+'.EarMoldTypes where EarmoldTypeCode in (' + @query + ')'

		--set @query = 'Select * from '+@Schema+'.EarMoldTypes where EarmoldTypeCode in (' + @query + ')'

		 --print @query
		exec (@query)
	END
	 -- EarmoldTypes (End)

	 else if(@ReturnTable ='BrandFamily')
	 -- BrandFamilies (Start)
	  BEGIN

	  set @query = ''
	   set @query  = 'select BrandFamilyCode from '+@Schema+'.BrandFamilyRules where '

      if (@BrandCode is not null)
	    set @query  = @query + ' BrandCode = '''+@BrandCode+''''
      else
	    set @query  = @query + '1 = 1'

		set @query = @query + ' And '

		 if (@EarmoldCode is not null)
	    set @query  = @query + ' EarmoldTypeCode in (select * from [Catalog].splitstring('''+@EarmoldCode+'''))' 
      else
	    set @query  = @query + '1 = 1'

		if (@ProductTypeCode is not null)
		begin
			SELECT @ProductTypeResult = COALESCE(@ProductTypeResult + ',', '') +  CAST('''' + BrandFamilyCode + ''''  AS VARCHAR(200)) + ''  FROM [Catalog].ProductTypeRules  WHERE ProductTypeCode in (select * from  [Catalog].splitstring(@ProductTypeCode)) group by BrandFamilyCode
			set @result = @ProductTypeResult;
		end
	  
		if (@TechnologyLevelCode is not null)
		begin				
			SELECT @TechnologyLevelResult = COALESCE(@TechnologyLevelResult + ',', '') +  CAST('''' + BrandFamilyCode + ''''  AS VARCHAR(200)) + ''  from [Catalog].TechnologyLevelRules where TechnologyLevelCode in (select * from  [Catalog].splitstring(@TechnologyLevelCode)) group by BrandFamilyCode
			if(@result is not null)
				set @result = @result + @TechnologyLevelResult;
			else
				set @result = @TechnologyLevelResult;
		end

		if (@FamilyProductCode is not null)
		begin				
			SELECT @FamilyProductResult = COALESCE(@FamilyProductResult + ',', '') +  CAST('''' + BrandFamilyCode + ''''  AS VARCHAR(200)) + ''  from [Catalog].FamilyProductRules where FamilyProductCode in (select * from  [Catalog].splitstring(@FamilyProductCode)) group by BrandFamilyCode
			if(@result is not null)
				set @result = @result + @FamilyProductResult;
			else
				set @result = @FamilyProductResult;
		end

		if (@ShellCode is not null)
		begin				
			SELECT @ShellResult = COALESCE(@ShellResult + ',', '') +  CAST('''' + BrandFamilyCode + ''''  AS VARCHAR(200)) + ''  from [Catalog].ShellRules where ShellCode in (select * from  [Catalog].splitstring(@ShellCode)) group by BrandFamilyCode
			if(@result is not null)
				set @result = @result + @ShellResult;
			else
				set @result = @ShellResult;
		end

		 if (@result is not null)
			set @query = 'Select * from '+@Schema+'.BrandFamilies where BrandFamilyCode in (' + @query + ') and BrandFamilyCode in (' + @result + ')' 
		  else
		    set @query = 'Select * from '+@Schema+'.BrandFamilies where BrandFamilyCode in (' + @query + ')' 


		--set @query = 'Select * from '+@Schema+'.BrandFamilies where BrandFamilyCode in (' + @query + ')' 
		

	    --print @query
		exec (@query) 

	 END
	 -- BrandFamilies (End)
	 else if(@ReturnTable ='Shell')
	  -- Shells (Start)
	BEGIN

	   set @query = ''
	   set @query  = 'select ShellCode from '+@Schema+'.ShellRules where '

      if (@BrandFamilyCode is not null)
	    set @query  = @query + ' BrandFamilyCode in  (select * from [Catalog].splitstring('''+@BrandFamilyCode +'''))'
      else
	    set @query  = @query + '1 = 1'

		 set @query  = @query + ' AND '

		  if (@FamilyProductCode is not null)
	    set @query  = @query + ' FamilyProductCode in (select * from [Catalog].splitstring('''+@FamilyProductCode +'''))' 
      else
	    set @query  = @query + '1 = 1'

		set @query = 'Select * from '+@Schema+'.Shells where ShellCode in (' + @query + ')'

		--print @query
		exec (@query)
	END
	 -- Shells (End)
	 else if(@ReturnTable ='FamilyProduct')
	 -- Family Products (Start)
	 BEGIN

	  set @query = ''
	   set @query  = 'select FamilyProductCode from '+@Schema+'.FamilyProductRules where '

      if (@BrandFamilyCode is not null)
	    set @query  = @query + ' BrandFamilyCode in (select * from [Catalog].splitstring('''+@BrandFamilyCode+'''))'
      else
	    set @query  = @query + '1 = 1'

		set @query = @query + ' And '

		 if (@TechnologyLevelCode is not null)
	    set @query  = @query + ' TechnologyLevelCode  in (select * from [Catalog].splitstring('''+ @TechnologyLevelCode+'''))'  
      else
	    set @query  = @query + '1 = 1'

		if (@ShellCode is not null)
		begin
			SELECT @ShellResult = COALESCE(@ShellResult + ',', '') +  CAST('''' + FamilyProductCode + ''''  AS VARCHAR(200)) + ''  FROM [Catalog].ShellRules  WHERE ShellCode in (select * from  [Catalog].splitstring(@ShellCode)) group by FamilyProductCode
			set @result = @ShellResult;
		end
	  
		if (@ProductTypeCode is not null)
		begin				
			SELECT @ProductTypeResult = COALESCE(@ProductTypeResult + ',', '') +  CAST('''' + FamilyProductCode + ''''  AS VARCHAR(200)) + ''  from [Catalog].ProductTypeRules where ProductTypeCode in (select * from  [Catalog].splitstring(@ProductTypeCode)) group by FamilyProductCode
			if(@result is not null)
				set @result = @result + @ProductTypeResult;
			else
				set @result = @ProductTypeResult;
		end
		
		 if (@result is not null)
			set @query = 'Select * from '+@Schema+'.FamilyProducts where FamilyProductCode in (' + @query + ') and FamilyProductCode in (' + @result + ')' 
		  else
		    set @query = 'Select * from '+@Schema+'.FamilyProducts where FamilyProductCode in (' + @query + ')'


		--set @query = 'Select * from '+@Schema+'.FamilyProducts where FamilyProductCode in (' + @query + ')'

		--print @query
		exec (@query)

	 END
	 -- Family Products (End)

	 else if(@ReturnTable ='ProductType')
	 -- Product Type (Start)
	 BEGIN

	  set @query = ''
	   set @query  = 'select ProductTypeCode from '+@Schema+'.ProductTypeRules where '

      if (@BrandFamilyCode is not null)
	    set @query  = @query + ' BrandFamilyCode  in (select * from [Catalog].splitstring('''+@BrandFamilyCode+'''))'  
      else
	    set @query  = @query + '1 = 1'

		set @query = @query + ' And '

		 if (@FamilyProductCode is not null)
	    set @query  = @query + ' FamilyProductCode  in (select * from [Catalog].splitstring('''+@FamilyProductCode+'''))' 
      else
	    set @query  = @query + '1 = 1'

		--set @query = 'Select * from '+@Schema+'.ProductTypes where ProductTypeCode in (' + @query + ')'

		if (@TechnologyLevelCode is not null)
		begin
			SELECT @result = COALESCE(@result + ',', '') +  CAST('''' + ProductTypeCode + ''''  AS VARCHAR(200)) + ''  FROM [Catalog].TechnologyLevelRules  WHERE TechnologyLevelCode in (select * from  [Catalog].splitstring(@TechnologyLevelCode)) group by ProductTypeCode
		end

		 if (@result is not null)
			set @query = 'Select * from '+@Schema+'.ProductTypes where ProductTypeCode in (' + @query + ') and ProductTypeCode in (' + @result + ')' 
		  else
		    set @query = 'Select * from '+@Schema+'.ProductTypes where ProductTypeCode in (' + @query + ')'

		--print @query
	 exec (@query)

	 END
	 -- Product Type (End)
	 else if(@ReturnTable ='TechnologyLevel')
	 -- Technology Levels (Start)
	 BEGIN

	   set @query = ''
	   set @query  = 'select TechnologyLevelCode from '+@Schema+'.TechnologyLevelRules where '

      if (@BrandFamilyCode is not null)
	    set @query  = @query + ' BrandFamilyCode  in (select * from [Catalog].splitstring('''+@BrandFamilyCode+'''))'  
      else
	    set @query  = @query + '1 = 1'

		set @query = @query + ' And '

		 if (@ProductTypeCode is not null)
	    set @query  = @query + ' ProductTypeCode in (select * from [Catalog].splitstring('''+@ProductTypeCode+'''))'   
      else
	    set @query  = @query + '1 = 1'

		--set @query = 'Select * from '+@Schema+'.TechnologyLevel where TechnologyLevelCode in (' + @query + ')'

		if (@FamilyProductCode is not null)
		begin
			SELECT @result = COALESCE(@result + ',', '') +  CAST('''' + TechnologyLevelCode + ''''  AS VARCHAR(200)) + ''  FROM [Catalog].FamilyProductRules  WHERE FamilyProductCode in (select * from  [Catalog].splitstring(@FamilyProductCode)) group by TechnologyLevelCode
		end
	  
		 if (@result is not null)
			set @query = 'Select * from '+@Schema+'.TechnologyLevel where TechnologyLevelCode in (' + @query + ') and TechnologyLevelCode in (' + @result + ')' 
		  else
		    set @query = 'Select * from '+@Schema+'.TechnologyLevel where TechnologyLevelCode in (' + @query + ')'

		--print @query
		exec (@query)

	 END
	 -- Technology Levels (End)
	  else if(@ReturnTable ='ProductModel')
	 -- Product Models (Start)
	  BEGIN
	  
	   set @query = ''
	   --set @query  = 'select ProductModelCode from '+@Schema+'.ProductModelRules where '
	   set @query  = ' where '
      if (@BrandCode is not null and @EarmoldCode is not null)
	    set @query  =  @query + ' BrandCode = '''+@BrandCode+''''
	  else
	    set @query  = @query + '1 = 1'

		set @query = @query + ' And '

		if (@EarmoldCode is not null)
	    set @query  = @query + ' EarmoldTypeCode in (select * from [Catalog].splitstring('''+@EarmoldCode+'''))'    
      else
	    set @query  = @query + '1 = 1'
		
		set @query = @query + ' And '

		if (@BrandFamilyCode is not null)
	    set @query  = @query + ' BrandFamilyCode in (select * from [Catalog].splitstring('''+@BrandFamilyCode+'''))' 
      else
	    set @query  = @query + '1 = 1'

		set @query = @query + ' And '

		if (@ProductTypeCode is not null)
	    set @query  = @query + ' ProductTypeCode in (select * from [Catalog].splitstring('''+@ProductTypeCode+'''))' 
      else
	    set @query  = @query + '1 = 1'

		set @query = @query + ' And '

		if (@TechnologyLevelCode is not null)
	    set @query  = @query + ' TechnologyLevelCode  in (select * from [Catalog].splitstring('''+@TechnologyLevelCode+'''))'
      else
	    set @query  = @query + '1 = 1'

		set @query = @query + ' And '

		if (@FamilyProductCode is not null)
	    set @query  = @query + ' FamilyProductCode  in (select * from [Catalog].splitstring('''+@FamilyProductCode+'''))'
      else
	    set @query  = @query + '1 = 1'

		set @query = @query + ' And '

		if (@ShellCode is not null)
	    set @query  = @query + ' ShellCode  in (select * from [Catalog].splitstring('''+@ShellCode+'''))'
      else
	    set @query  = @query + '1 = 1'
		
       -- set @query = 'select * from '+@Schema+'.ProductModels where ProductModelCode in (' + @query + ')' 
	   --set @query = 'select distinct prod.*,prodr.* from '+@Schema+'.ProductModels prod join '+@Schema+'.ProductModelRules prodr on prod.ProductModelCode = prodr.ProductModelCode where prod.ProductModelCode in (' + @query + ')'
     	 --set @query = 'select distinct prod.ProductModelCode,prod.ProductModelID,prod.ProductModelName,prod.Description,prod.CreateDate,prod.ModifyDate,prod.CreateUser,prod.Modifyuser,prod.ImageURL,
		     --          prodr.BrandCode,prodr.BrandFamilyCode,prodr.EarmoldTypeCode,prodr.FamilyProductCode,prodr.ProductTypeCode,prodr.ShellCode,prodr.TechnologyLevelCode,prod.IsActive
					  --  from '+@Schema+'.ProductModels prod join '+@Schema+'.ProductModelRules prodr 
					  -- on prod.ProductModelCode = prodr.ProductModelCode where prod.ProductModelCode in (' + @query + ')'
	   set @query = 'select prod.ProductModelID,prod.ProductModelCode,prod.ProductModelName,prod.Description,prod.CreateDate,prod.ModifyDate,prod.CreateUser,prod.Modifyuser,prod.ImageURL,
		               prodr.BrandCode,prodr.BrandFamilyCode,prodr.EarmoldTypeCode,prodr.FamilyProductCode,prodr.ProductTypeCode,prodr.ShellCode,prodr.TechnologyLevelCode,prod.IsActive,prod.StyleID
					    from '+@Schema+'.ProductModels prod join '+@Schema+'.ProductModelRules prodr 
					   on prod.ProductModelCode = prodr.ProductModelCode ' + @query + ''  
		 
		 print @query
		 exec (@query)

		End  
		-- Product Models (End)
		 
   end

   --exec [Catalog].[proc_ProductModels] 'GNR',null,null,'RS VERSO 9','MINI BTE',null,null,'ProductModel'
   --select * from [Catalog].BrandFamilies
   
create PROCEDURE [catalog].[sp_GetAllBrands](@BrandName Nvarchar(100))
AS
BEGIN
    -- SET NOCOUNT ON added to prevent extra result sets from
    -- interfering with SELECT statements.
    SET NOCOUNT ON
    -- Insert statements for procedure here
    If( @BrandName is null or @BrandName='')
		Begin
			SELECT distinct BrandName from [catalog].[Brands]
		End
	Else
		Begin
			SELECT distinct BrandName from [catalog].[Brands]  where BrandName like @BrandName + '%'
		End
END
--exec [catalog].[getModelDetailsByModelCodeAndAccessoryName] 'EN588-DW','ENZO2','RS ENZO2 5','QuickGuide','RSENZO25_EN588-DW'
CREATE PROCEDURE [catalog].[getModelDetailsByModelCodeAndAccessoryName]
	@productModelCode varchar(30),
	@brandFamilyCode varchar(30),
	@familyProductCode varchar(30),
	@accessoryName varchar(20),
	@itemCode nvarchar(100)
AS
BEGIN

	if(@accessoryName = 'Videos' or @accessoryName = 'Overview' or @accessoryName = 'QuickGuide' or @accessoryName = 'ProductBrochures')
	begin
	select accessory.[ItemMasterAccessoryID], media.Media, 
										 media.MediaURL, accessory.Description as [MediaDescription],
										 media.DefaultMedia, accessory.IsWirelessAccessory,
										 media.MediaType
										 from [cms].[ItemMasterAccessories] accessory left join [cms].[ItemmasterMedias] media
										 on accessory.[ItemmasterMediaID] = media.[ItemmasterMediaID] and media.itemCode = @itemCode
										 where accessory.ModelAccessoryName = @accessoryName and ((accessory.FamilyProductCode = @familyProductCode or accessory.FamilyProductCode is null)  and accessory.BrandFamilyCode = @brandFamilyCode)
										 and media.MediaURL is not null 
										 order by media.DefaultMedia desc
	end
	else if(@accessoryName = 'Wireless Accessories')
	begin
	select accessory.[ItemMasterAccessoryID], media.Media, 
										 media.MediaURL, accessory.Description as [MediaDescription],
										 media.DefaultMedia, accessory.IsWirelessAccessory,
										 media.MediaType
										 from cms.[ItemMasterAccessories] accessory left join [cms].[ItemmasterMedias] media
										 on accessory.[ItemmasterMediaID] = media.[ItemmasterMediaID] and media.itemCode = @itemCode
										 where accessory.IsWirelessAccessory = 1 and REPLACE(accessory.ModelCode, ' ','') = @productModelCode
										 and media.MediaURL is not null
										 order by media.DefaultMedia desc
	end
END

----------------------------------------------------------------

CREATE PROCEDURE [catalog].[proc_ProductModelsByFeatures]
  @BrandCode varchar(max),
  @EarmoldCode varchar(max),
  @BrandFamilyCode varchar(max),
  @FamilyProductCode varchar(max),
  @ProductTypeCode varchar(max),
  @TechnologyLevelCode varchar(max),
  @ShellCode varchar(max),
  @InsuranceCarrierID int = 0 ,
  @HealthPlanID int = 0,
  @featureName varchar(max),
  @featureValueCode varchar(max),
  @catalogType varchar(50) = null
       as

BEGIN

         declare @query varchar(max)
         declare @Schema varchar(50)            
         declare @result varchar(max)
         set @Schema='[Catalog]'

            set @query = ''
          --set @query  = 'select ProductModelCode from '+@Schema+'.ProductModelRules where '
          if (@InsuranceCarrierID = 0 and @HealthPlanID = 0)
          set @query  = ' where '
      if (@BrandCode is not null)
           set @query  =  @query + ' (BrandCode = '''+@BrandCode+'''or BrandCode is null)'
         else
           set @query  = @query + '1 = 1'

              set @query = @query + ' And '

              if (@EarmoldCode is not null)
           set @query  = @query + ' (prodr.EarmoldTypeCode in (select * from [Catalog].splitstring('''+@EarmoldCode+''')) or prodr.EarmoldTypeCode is null)'    
      else
           set @query  = @query + '1 = 1'
              
              set @query = @query + ' And '

             if (@BrandFamilyCode is not null)
           set @query  = @query + ' (prodr.BrandFamilyCode in (select * from [Catalog].splitstring('''+@BrandFamilyCode+''')) or prodr.BrandFamilyCode is null)' 
      else
           set @query  = @query + '1 = 1'

              set @query = @query + ' And '

              if (@ProductTypeCode is not null)
           set @query  = @query + ' (prodr.ProductTypeCode in (select * from [Catalog].splitstring('''+@ProductTypeCode+''')) or prodr.ProductTypeCode is null)' 
      else
           set @query  = @query + '1 = 1'

              set @query = @query + ' And '

              if (@TechnologyLevelCode is not null)
           set @query  = @query + ' (prodr.TechnologyLevelCode  in (select * from [Catalog].splitstring('''+@TechnologyLevelCode+''')) or prodr.TechnologyLevelCode is null)'
      else
           set @query  = @query + '1 = 1'

              set @query = @query + ' And '

              if (@FamilyProductCode is not null)
           set @query  = @query + ' (prodr.FamilyProductCode  in (select * from [Catalog].splitstring('''+@FamilyProductCode+''')) or prodr.FamilyProductCode is null)'
      else
           set @query  = @query + '1 = 1'

              set @query = @query + ' And '

              if (@ShellCode is not null)
           set @query  = @query + ' (prodr.ShellCode  in (select * from [Catalog].splitstring('''+@ShellCode+''')) or prodr.ShellCode is null)'
      else
           set @query  = @query + '1 = 1'

              if (@featureName is not null and @featureValueCode is not null)
              begin
                     select @result = COALESCE(@result + ',', '') +  CAST('''' + ProductModelCode + ''''  AS VARCHAR(200)) + '' from [Catalog].FeatureValueRules 
                        where FeatureValueID in 
                        (select fv.FeatureValueID from [Catalog].FeatureValues fv 
                        left join [Catalog].Features f on fv.FeatureID=f.FeatureID
                        where fv.FeatureName in (select * from  [Catalog].splitstring(@featureName))
                        and FeatureValueCode in (select * from  [Catalog].splitstring(@featureValueCode))
                        and ((@catalogType = 'Custom' And f.StyleID = 1) OR (@catalogType = 'Standard' And f.StyleID > 1) OR (@catalogType is null And 1=1))) 
                        and ProductModelCode is not null group by ProductModelCode 
              end
              if(@result is not null) 
            set @query= @query + ' and prod.ProductModelCode in (' + @result + ')'
              else
           set @query  = @query + ' and 1 = 1' 

              if(@catalogType is not null)
                     begin
                     if(@catalogType = 'Custom')
                     set @query = @query + ' and prodr.StyleID = 1'
                     else if(@catalogType = 'Standard')
                     set @query = @query + ' and prodr.StyleID > 1'
                     else 
                     set @query = @query + ' and 1 = 1'
                     end
              
              else
              set @query = @query + ' and 1 = 1'

       
                           
                           if (@InsuranceCarrierID > 0 and @HealthPlanID > 0 and @featureName is not null and @featureValueCode is not null)
                                  begin
                                         set @query = 'select prod.ProductModelID,prod.ProductModelCode,prod.ProductModelName,prod.CreateDate,prod.ModifyDate,prod.CreateUser,prod.Modifyuser,prod.ImageURL,
                             prodr.BrandCode,prodr.BrandFamilyCode,prodr.EarmoldTypeCode,prodr.FamilyProductCode,prodr.ProductTypeCode,prodr.ShellCode,prodr.TechnologyLevelCode,prod.IsActive,prod.StyleID,
                                     ISNULL(conProd.UnitPrice,0) as UnitProductPrice, ISNULL(conProd.PairPrice,0) as PairProductPrice, ISNULL(contBen.BenefitAmt,0) as Benefit,modelcontent.ModelRatings,modelcontent.ModelShortDescription as Description,modelcontent.DefaultImage as MediaURL
                                      from '+@Schema+'.ProductModels prod join '+@Schema+'.ProductModelRules prodr 
                                         on prod.ProductModelCode = prodr.ProductModelCode 
                                            left join insurance.ContractProducts conProd
                                                on conProd.FamilyProductCode = prodr.FamilyProductCode
                                                or conProd.ProductTypeCode = prodr.ProductTypeCode
                                                left join insurance.ContractBenefits contBen
                                                on contBen.HealthPlanContractID = conProd.HealthPlanContractID
                                                left join insurance.HealthPlanContracts healthPC
                                                on healthPC.HealthPlanContractID = contBen.HealthPlanContractID
                                                left join insurance.InsuranceHealthPlans insHP
                                                on healthPC.HealthPlanID = insHP.HealthPlanID
                                             left join CMS.ModelContents modelcontent
                                             on prodr.BrandFamilyCode = modelcontent.BrandFamilyCode
                                                and (prodr.FamilyProductCode = modelcontent.FamilyProductCode or prodr.FamilyProductCode is null)
                                                where (insHP.HealthPlanID = ' +CONVERT(varchar(10), @HealthPlanID)+ ' and healthPC.InsuranceCarrierID = ' +CONVERT(varchar(10), @InsuranceCarrierID)+') and ' + @query + ''   
                                  end
                           else 
                                  begin
                                  --if(@result is null)
                                  --begin
                                  --     set @query = 'select prod.ProductModelID,prod.ProductModelCode,prod.ProductModelName,prod.Description,prod.CreateDate,prod.ModifyDate,prod.CreateUser,prod.Modifyuser,prod.ImageURL,
                 --            prodr.BrandCode,prodr.BrandFamilyCode,prodr.EarmoldTypeCode,prodr.FamilyProductCode,prodr.ProductTypeCode,prodr.ShellCode,prodr.TechnologyLevelCode,prod.IsActive,prod.StyleID,
                                  --   CAST(''2700'' AS DECIMAL)  as UnitProductPrice,CAST(''2200'' AS DECIMAL) as PairProductPrice, CAST(''300'' AS DECIMAL) as Benefit,modelcontent.ModelRatings,modelcontent.ModelShortDescription as Description,modelcontent.DefaultImage as MediaURL
                                  --   from '+@Schema+'.ProductModels prod join '+@Schema+'.ProductModelRules prodr 
                                  --   on prod.ProductModelCode = prodr.ProductModelCode 
                                  --   left join CMS.ModelContents modelcontent
                                  --   on prodr.BrandFamilyCode = modelcontent.BrandFamilyCode
                                  --   and (prodr.FamilyProductCode = modelcontent.FamilyProductCode or prodr.FamilyProductCode is null)
                                  --    ' + @query + ''
                                  --end
                                  --else
                                  set @query = 'select prod.ProductModelID,prod.ProductModelCode,prod.ProductModelName,prod.Description,prod.CreateDate,prod.ModifyDate,prod.CreateUser,prod.Modifyuser,prod.ImageURL,
                             prodr.BrandCode,prodr.BrandFamilyCode,prodr.EarmoldTypeCode,prodr.FamilyProductCode,prodr.ProductTypeCode,prodr.ShellCode,prodr.TechnologyLevelCode,prod.IsActive,prod.StyleID,
                                     CAST(''2700'' AS DECIMAL)  as UnitProductPrice,CAST(''2200'' AS DECIMAL) as PairProductPrice, CAST(''300'' AS DECIMAL) as Benefit,modelcontent.ModelRatings,modelcontent.ModelShortDescription as Description,modelcontent.DefaultImage as MediaURL
                                     from '+@Schema+'.ProductModels prod join '+@Schema+'.ProductModelRules prodr 
                                     on prod.ProductModelCode = prodr.ProductModelCode 
                                     left join CMS.ModelContents modelcontent
                                     on prodr.BrandFamilyCode = modelcontent.BrandFamilyCode
                                     and (prodr.FamilyProductCode = modelcontent.FamilyProductCode or prodr.FamilyProductCode is null)
                                     ' + @query + '' 

                                                              --   left join CMS.ModelContents modelcontent
                                            --on prodr.ProductModelCode = modelcontent.ModelCode
                                  end
              print @result
              print @query
              exec (@query)

End  
CREATE PROCEDURE [catalog].[Get_HearingService_HA_Item]  
(    
    -- Add the parameters for the stored procedure here    
   @ProductItemCode nvarchar(100),       
   @DeviceCount int     
)    
AS    
BEGIN    
     
    SET NOCOUNT ON    
 IF (@DeviceCount = 1)    
	 BEGIN      

	   SELECT ItemID,
			  ItemType,
			  BrandCode,     
			  FamilyCode,     
			  TechnologyCode,     
			  ModelCode, 
			  ITEMCODE,    
			  StyleCode,  
			  MonauralHCPCSCode,    
			  MonauralHCPCSCode as 'HCPCSAidCode',    
			  BinauralHCPCSCode
			  FROM  [catalog].[ItemMasterList]  
			  WHERE ITEMCODE = @ProductItemCode    
        
	 END    
 IF (@DeviceCount = 2)    
	 BEGIN    
	   SELECT ItemID,
			  ItemType,
			  BrandCode,     
			  FamilyCode,     
			  TechnologyCode,     
			  ModelCode,  
			  ItemCode,   
			  StyleCode,
			  MonauralHCPCSCode,
			  BinauralHCPCSCode as 'HCPCSAidCode',       
			  BinauralHCPCSCode  
			 FROM  [catalog].[ItemMasterList]  
			 WHERE ITEMCODE = @ProductItemCode      
        
	 END    
END
--exec [catalog].[GetStylesByBrand] 'BELTONE'
CREATE PROCEDURE [catalog].[GetStylesByBrand] 
	-- Add the parameters for the stored procedure here
	@BrandCode varchar(20) = '',
	@BrandFamilyCodes varchar(MAX) = null,
	@TechnologyCodes varchar(MAX)=null
	AS
	BEGIN
		SET NOCOUNT ON;
		IF (@BrandCode = '')
			BEGIN	  
				  SELECT 
				  row_number() OVER (ORDER BY vm.[StyleCode]) AS 'RowId',
				  vm.[StyleCode] AS 'StyleName',
				  vm.[StyleCode] AS'StyleCode'
				FROM [catalog].[ItemMasterList] vm				 
					 WHERE vm.[StyleCode] IS NOT NULL AND vm.[IsActive]=1
					 GROUP BY vm.[StyleCode];	
			END
		ELSE
		BEGIN
		DECLARE @query VARCHAR(MAX);
		  SET @query='SELECT 
					  ROW_NUMBER() OVER (ORDER BY vm.[StyleCode]) AS ''RowId'',
					  vm.[StyleCode] AS ''StyleName'',
					  vm.[StyleCode] AS''StyleCode''
					FROM [catalog].[ItemMasterList] vm
					WHERE vm.[BrandCode] = '''+@BrandCode+''' AND vm.[StyleCode] IS NOT NULL and vm.[StyleCode] <> '''' AND vm.[IsActive]=1'
		   IF(@BrandFamilyCodes IS NOT NULL)
				SET @query=@query + ' AND vm.FamilyCode IN (SELECT * FROM [Catalog].splitstring('''+@BrandFamilyCodes+'''))'
		   IF(@TechnologyCodes IS NOT NULL)
				SET @query=@query + ' AND vm.TechnologyCode IN (SELECT * FROM [Catalog].splitstring('''+@TechnologyCodes+'''))'
			SET @query = @query+' GROUP BY vm.[StyleCode]'
		exec(@query);
		END
	END



-- exec [catalog].[V_ProductModelsList] 'STARKEY',NULL,NULL,NULL,4,5,'ProductModel'
CREATE proc [catalog].[V_ProductModelsList] 
	@BrandCode varchar(50),
	@BrandFamilyCode varchar(max)=null,
	@TechnologyLevelCode varchar(max)=null,
	@Styles varchar(max)=null,
	@InsuranceCarrierID int = 0 ,
	@InsuranceHealthPlanID int = 0,
	@ReturnTable varchar(50)
	 as 
	begin
  declare @query varchar(max)
   declare @query2 varchar(max)
  declare @healthPlanContractId varchar(20)

  set @healthPlanContractId =  (select TOP 1 HealthPlanContractID from insurance.healthplancontracts where InsuranceCarrierId=@InsuranceCarrierID and insuranceHealthPlanId=@InsuranceHealthPlanID and isactive=1);

    if(@ReturnTable ='BrandFamily')
		Begin
		  set @query='select (case when fm.[BrandFamilyName] is null then vm.[FamilyCode] else fm.[BrandFamilyName] end)  as BrandFamilyName,
			vm.[FamilyCode] as BrandFamilyCode,
			(case when fm.[Description] is null then vm.[FamilyCode] else fm.[Description] end) as Description
			from [catalog].[ItemMasterList] vm
			left join [catalog].[BrandFamilies] fm
			on vm.[FamilyCode] = fm.[BrandFamilyCode]
			where vm.BrandCode='''+@BrandCode+'''';
		  if(@BrandFamilyCode is not null)
			set @query=@query + ' and vm.[FamilyCode] in (select * from [Catalog].splitstring('''+@BrandFamilyCode+'''))'

		   if(@TechnologyLevelCode is not null)
		  set @query=@query + ' and vm.[TechnologyCode] in (select * from [Catalog].splitstring('''+@TechnologyLevelCode+'''))'

		  if(@Styles is not null)
		  set @query=@query + ' and vm.[StyleCode] in (select * from [Catalog].splitstring('''+@Styles+'''))'
		  if(@healthPlanContractId is not null)
			 --set @query=@query + ' and vm.[TechnologyCode] in (select FamilyProductCode from insurance.contractproducts where HealthPlanContractID='+@healthPlanContractId+') and vm.IsActive=1';
			 set @query=@query + ' and vm.[ItemCode] in (select ItemCode from insurance.contractproducts where HealthPlanContractID='+@healthPlanContractId+') and vm.IsActive=1';
			 set @query2 = 'select row_number() over (order by p.BrandFamilyCode) as RowID,p.* from (select distinct c.* from (' + @query + ') c) p'
		End
		
	if(@ReturnTable ='FamilyProduct') --Technology
		Begin
		  set @query='select distinct 
		  (case when fp.[FamilyProductName] is null then vm.[TechnologyCode] else fp.[FamilyProductName] end)  as FamilyProductName,
		  vm.[TechnologyCode] as FamilyProductCode,
		  (case when fp.[Description] is null then vm.[TechnologyCode] else fp.[Description] end) as Description
		  from [catalog].[ItemMasterList] vm
		  left join [catalog].[FamilyProducts] fp
		  on vm.[TechnologyCode] = fp.[FamilyProductCode]
		  where vm.BrandCode='''+@BrandCode+'''';

		  if(@BrandFamilyCode is not null)
		  set @query=@query + ' and vm.[FamilyCode] in (select * from [Catalog].splitstring('''+@BrandFamilyCode+'''))'

		   if(@TechnologyLevelCode is not null)
		  set @query=@query + ' and vm.[TechnologyCode] in (select * from [Catalog].splitstring('''+@TechnologyLevelCode+'''))'

		  if(@Styles is not null)
		  set @query=@query + ' and vm.[StyleCode] in (select * from [Catalog].splitstring('''+@Styles+'''))'
		   if(@healthPlanContractId is not null)
		  set @query=@query + ' and vm.[ItemCode] in (select ItemCode from insurance.contractproducts where HealthPlanContractID='+@healthPlanContractId+') and vm.IsActive=1'
		   set @query2 = 'select row_number() over (order by p.FamilyProductCode) as RowID,p.* from (select distinct c.* from (' + @query + ') c) p'
		End



	if(@ReturnTable ='ProductModel') --Model
		Begin
		  --set @query='select REPLACE(vm.ItemCode,'' '','''') as ItemCode, vm.Model as ProductModelName, REPLACE(vm.Model,'' '','''') as ProductModelCode,vm.Brand as BrandCode,vm.Family as BrandFamilyCode,
		  set @query='select  vm.ModelCode as ProductModelCode,
		              vm.ItemCode as ItemCode,
		              vm.ModelCode as ProductModelName,
		              vm.[BrandCode] as BrandCode,
			          vm.[FamilyCode] as BrandFamilyCode,
			          vm.[TechnologyCode] as FamilyProductCode,
			          ISNULL(conProd.PerDeviceMemberPrice,0) as UnitProductPrice,
		              ISNULL(conProd.PerPairMemberPrice,0) as PairProductPrice,
		              ISNULL(contBen.BenefitAmt,0) as Benefit,
		              modelcontent.ModelRatings,
		              modelcontent.ModelShortDescription as Description,
					  modelcontent.DefaultImage as MediaURL,
					  style.[StyleName] as StyleName,
					  style.[StyleCode] as StyleCode
					 from [catalog].[ItemMasterList] vm

				LEFT join(SELECT DISTINCT PerDeviceMemberPrice,PerPairMemberPrice,ItemCode,HealthPlanContractID, IsActive FROM  insurance.ContractProducts) conProd
		           on vm.ItemCode = conProd.ItemCode and conProd.IsActive = 1
		  
		          left join insurance.ContractBenefits contBen
		          on contBen.HealthPlanContractID = conProd.HealthPlanContractID
		  
		  left join catalog.Styles style 
		  on vm.[StyleCode] = style.StyleCode
		  
		  left join insurance.HealthPlanContracts healthPC
		  on healthPC.HealthPlanContractID = contBen.HealthPlanContractID and healthPC.IsActive = 1
		  
		  left join insurance.InsuranceHealthPlans insHP
		  on healthPC.InsuranceHealthPlanID = insHP.InsuranceHealthPlanID    and insHP.IsActive = 1
		  
		  left join CMS.ItemMasterContent modelcontent
		  on vm.ItemCode = modelcontent.itemcode --and (vm.[TechnologyCode] = modelcontent.FamilyProductCode or vm.[TechnologyCode] is null)
		  
		  where vm.[BrandCode] ='''+@BrandCode+'''';

		  if(@BrandFamilyCode is not null)
		  set @query=@query + ' and vm.[FamilyCode] in (select * from [Catalog].splitstring('''+@BrandFamilyCode+'''))'

		   if(@TechnologyLevelCode is not null)
		  set @query=@query + ' and vm.[TechnologyCode] in (select * from [Catalog].splitstring('''+@TechnologyLevelCode+'''))'

		  if(@Styles is not null)
		  set @query=@query + ' and vm.[StyleCode] in (select * from [Catalog].splitstring('''+@Styles+'''))'
		   if(@healthPlanContractId is not null)
		  set @query=@query + 'and healthPC.InsuranceHealthPlanID=' +CONVERT(varchar(10), @InsuranceHealthPlanID)+ ' and healthPC.InsuranceCarrierID=' +CONVERT(varchar(10), @InsuranceCarrierID)+' and vm.IsActive=1'
		  --set @query=@query + ' and vm.technology in (select FamilyProductCode from insurance.contractproducts where HealthPlanContractID='+@healthPlanContractId+')'
		  set @query2 = 'select row_number() over (order by p.ProductModelCode) as RowID,p.* from (select distinct c.* from (' + @query + ') c) p'
		End
		
  exec(@query2);
 END

 /** Changes
 6/14/2019 - Micah - added IsActive checks to ProductModel query
 
 */
	CREATE PROCEDURE [catalog].[InsertorUpdateCatalogProducts]  
 -- Add the parameters for the stored procedure here  

AS  
BEGIN  

--making all the products inactive
UPDATE [catalog].[ItemMasterList] set IsActive=0;

--deleting temp table if exists
IF OBJECT_ID (N'catalog.TempCatalogModels', N'U') IS NOT NULL 
    DROP TABLE [catalog].[TempCatalogModels];

--creating the temp table
	CREATE TABLE [catalog].TempCatalogModels(
	[Brand] [nvarchar](200) NULL,
	[Family] [nvarchar](200) NULL,
	[Technology] [nvarchar](200) NULL,
	[Model] [nvarchar](200) NULL,
	[ItemCode] [nvarchar](50) NOT NULL,
	[Style] [varchar](200) NULL,
	[Colors] [nvarchar](max) NULL,
	[BatterySizes] [varchar](203) NULL,
	[ReceiverSizes] [varchar](203) NULL,
	[ReceiverPowers] [varchar](203) NULL,
	[MonauralHCPCSCode] [varchar](5) NOT NULL,
	[BinauralHCPCSCode] [varchar](5) NOT NULL
	)

--inserting the data to the temp table from catalog schema tables([catalog].[ProductModelRules],[catalog].[OtherProductsRules],[catalog].[Features],[catalog].[FeatureValues],[catalog].[FeatureValueRules])
INSERT INTO [catalog].[TempCatalogModels]([Brand],[Family],[Technology],[Model],[ItemCode],[Style],[Colors],[BatterySizes],
[ReceiverSizes],[ReceiverPowers],[MonauralHCPCSCode],[BinauralHCPCSCode])
SELECT 
BrandCode AS 'Brand', 
BrandFamilyCode AS 'Family', 
FamilyProductCode AS 'Technology',
ProductModelCode AS 'Model',
UPPER(FamilyProductCode + '_' + ProductModelCode) as 'ItemCode',
(case 
    WHEN StyleId = (SELECT styleid FROM catalog.styles WHERE stylecode='EDI_CUSTOMCATALOG')	THEN 'CUSTOM'
	WHEN ProductModelCode like '%DRW%'	THEN 'RIE'
	WHEN ProductModelCode like '%DWRZ%'	THEN 'RIE' -- This value wrong in catalog it is supposed to be DRWZ
	WHEN ProductModelCode like '%DR%'	THEN 'RIE'
	WHEN ProductModelCode like '%DVIR%'	THEN 'RIE'
	WHEN ProductModelCode like '%DW%'	THEN 'BTE' 
	WHEN ProductModelCode like '%DVI%'	THEN 'BTE' 
	WHEN ProductModelCode like '%DI%'	THEN 'BTE' 
	ELSE '---'
END) AS 'Style',
(SELECT Stuff(
    (
    SELECT ', ' + A.[FeatureValueCode]
    FROM [catalog].[FeatureValues] A
	INNER JOIN [catalog].[FeatureValueRules] B ON B.[FeatureValueID] = A.[FeatureValueID] and B.[BrandFamilyCode] = [catalog].[ProductModelRules].BrandFamilyCode
	INNER JOIN [catalog].[Features] C ON C.[FeatureID] = A.[FeatureID]
	WHERE A.[FeatureName] in ('HOUSING COLOR','SHELL COLOR') 
    FOR XML PATH('')
    ), 1, 2, '')) + ',NA' AS Colors,
'10,13,312,675,NA' AS 'BatterySizes',
'0,1,2,3,4,NA' AS 'ReceiverSizes',
'LOW POWER,MEDIUM POWER,NORMAL POWER,HIGH POWER,ULTRA POWER,NA' AS 'ReceiverPowers',
(CASE 
	 WHEN [ShellCode]  in ('CIC','IIC')                THEN 'V5254' 
     WHEN [ShellCode]  in ('ITC','HS','MIH')           THEN 'V5255' 
	 WHEN [ShellCode]  in ('ITE','LP')                 THEN 'V5256' 
	 WHEN [ShellCode]  is null
	 AND 
	      [ProductModelCode] like '%DW%'  or 			   
		  [ProductModelCode] like '%DVI%' or 			   
	      [ProductModelCode] like '%DI%'			   THEN 'V5257' -- BTE 
	 else													'V5257' -- RIE 
END) AS  'MonauralHCPCSCode', 
(CASE 
	 WHEN [ShellCode]  in ('CIC','IIC')                THEN 'V5258' 
     WHEN [ShellCode]  in ('ITC','HS','MIH')           THEN 'V5259' 
	 WHEN [ShellCode]  in ('ITE','LP')                 THEN 'V5260' 
	 WHEN [ShellCode]  is null
	 and 
	      [ProductModelCode] like '%DW%'  or 			   
		  [ProductModelCode] like '%DVI%' or 			   
	      [ProductModelCode] like '%DI%'			   THEN 'V5261' -- BTE 
	 ELSE											        'V5261' -- RIE 
END ) AS  'BinauralHCPCSCode'
FROM
[catalog].[ProductModelRules]
WHERE 
BrandCode IS NOT  NULL
AND NOT (ProductModelCode like '%DRWZ%' OR  ProductModelCode LIKE '%DWRZ%' )

UNION

SELECT 
BrandCode as 'Brand', 
BrandFamilyCode as 'Family', 
FamilyProductCode + ' DRWZ' as 'Technology',
ProductModelCode as 'Model',
upper(FamilyProductCode + '_' + ProductModelCode) as 'ItemCode',
(case 
    WHEN StyleId = (SELECT styleid FROM catalog.styles WHERE stylecode='EDI_CUSTOMCATALOG')	THEN 'CUSTOM'
	WHEN ProductModelCode LIKE '%DRW%'	THEN 'RIE'
	WHEN ProductModelCode LIKE '%DWRZ%'	THEN 'RIE' -- This value wrong in catalog it is supposed to be DRWZ
	WHEN ProductModelCode LIKE '%DR%'	THEN 'RIE'
	WHEN ProductModelCode LIKE '%DVIR%'	THEN 'RIE'
	WHEN ProductModelCode LIKE '%DW%'	THEN 'BTE' 
	WHEN ProductModelCode LIKE '%DVI%'	THEN 'BTE' 
	WHEN ProductModelCode LIKE '%DI%'	THEN 'BTE' 

	ELSE '---'
END) AS 'Style',
(SELECT Stuff(
    (
    SELECT ', ' + A.[FeatureValueCode]
    FROM [catalog].[FeatureValues] A
	INNER JOIN [catalog].[FeatureValueRules] B ON B.[FeatureValueID] = A.[FeatureValueID] and B.[BrandFamilyCode] = [catalog].[ProductModelRules].BrandFamilyCode
	INNER JOIN [catalog].[Features] C ON C.[FeatureID] = A.[FeatureID]
	WHERE A.[FeatureName] in ('HOUSING COLOR','SHELL COLOR') 
    FOR XML PATH('')
    ), 1, 2, '')) + ',NA' AS Colors,
'10,13,312,675,NA' as 'BatterySizes',
'0,1,2,3,4,NA' as 'ReceiverSizes',
'LOW POWER,MEDIUM POWER,NORMAL POWER,HIGH POWER,ULTRA POWER,NA' as 'ReceiverPowers',
(case 
	 when [ShellCode]  in ('CIC','IIC')                then 'V5254' 
     when [ShellCode]  in ('ITC','HS','MIH')           then 'V5255' 
	 when [ShellCode]  in ('ITE','LP')                 then 'V5256' 
	 when [ShellCode]  is null
	 and 
	      [ProductModelCode] like '%DW%'  or 			   
		  [ProductModelCode] like '%DVI%' or 			   
	      [ProductModelCode] like '%DI%'			   then 'V5257' -- BTE 
	 else													'V5257' -- RIE 
end) as  'MonauralHCPCSCode', 
(case 
	 when [ShellCode]  in ('CIC','IIC')                then 'V5258' 
     when [ShellCode]  in ('ITC','HS','MIH')           then 'V5259' 
	 when [ShellCode]  in ('ITE','LP')                 then 'V5260' 
	 when [ShellCode]  is null
	 and 
	      [ProductModelCode] like '%DW%'  or 			   
		  [ProductModelCode] like '%DVI%' or 			   
	      [ProductModelCode] like '%DI%'			   then 'V5261' -- BTE 
	 else											        'V5261' -- RIE 
end ) as  'BinauralHCPCSCode'
FROM
[catalog].[ProductModelRules]
WHERE 
BrandCode IS NOT  NULL
and 
(ProductModelCode like '%DRWZ%' or  ProductModelCode like '%DWRZ%' )
--and IsActive=1

UNION

SELECT 
rtrim(upper(Manufacturer)) as 'Brand', 
rtrim(upper(Family)) as 'Family', 
rtrim(upper(Technology)) as 'Technology',
upper(Model) as 'Model',
upper(rtrim(Technology)) + '_' + upper(Model) as 'ItemCode',
upper(rtrim(Style)) as 'Style',
(
  case 
      when Colors is null or rtrim(colors)='' then 'NA'
	  else upper(Colors) +',NA'
  end
) as 'Colors',
(case 
      when BatterySize is null or rtrim(BatterySize) = '' then 'NA'
	  else BatterySize + ',NA'
 end
) as 'BatterySizes',
--BatterySize + ',NA' as 'BatterySizes',
(case 
      when ReceiverSize is null or rtrim(ReceiverSize) = '' then 'NA'
	  else ReceiverSize + ',NA'
 end
) as 'ReceiverSizes',
(case 
      when ReceiverPower is null or rtrim(ReceiverPower) = '' then 'NA'
	  else ReceiverPower +',NA'
 end
) as 'ReceiverPowers',
  (case 
	 when Style  in ('CIC','IIC','mCIC')												then 'V5254' 
     when Style  in ('ITC','HS','MIH','mini canal','canal','mITC')						then 'V5255' 
	 when Style  in ('ITE','LP')														then 'V5256' 
	 when Style  in ('BTE','RIE', 'RIC','mBTE', 'mRIC', 'mRITE', 'RITE', 'designRITE')	then 'V5257' 
	 else																					 'V5257'
end) as  'MonauralHCPCSCode', 

(case 
	 when Style  in ('CIC','IIC','mCIC')												then 'V5258' 
     when Style  in ('ITC','HS','MIH','mini canal','canal','mITC')						then 'V5259' 
	 when Style  in ('ITE','LP')														then 'V5260' 
	 when Style  in ('BTE','RIE', 'RIC','mBTE', 'mRIC', 'mRITE', 'RITE', 'designRITE')	then 'V5261'  
	 else																					 'V5261'  
end ) as  'BinauralHCPCSCode'

FROM
[catalog].[OtherProductsRules]

UNION
SELECT

'GNR' as 'Brand', 
'MAGNA' as 'Family', 
'RS MAGNA 4' as 'Technology',
'MG 490-DVI' as 'Model',
'RS MAGNA 4_MG 490-DVI'  as 'ItemCode',
'BTE' as 'Style',
'BEIGE, DARK BROWN, BLACK, MEDIUM BLONDE,NA' as 'Colors',
'675,NA' as 'BatterySizes',
'NA' as 'ReceiverSizes',
'NA' as 'ReceiverPowers',
 'V5257' as  'MonauralHCPCSCode', 
 'V5261'  as  'BinauralHCPCSCode'


BEGIN TRAN;
MERGE [catalog].[ItemMasterList] AS T
USING [catalog].[TempCatalogModels] AS S
ON (T.ItemCode = S.ItemCode) 
WHEN NOT MATCHED BY TARGET --AND S.EmployeeName LIKE 'S%' 
    THEN
	 INSERT([Brand],[Family],[Technology],[Model],[ItemCode],[Style],[Colors],[BatterySizes],
[ReceiverSizes],[ReceiverPowers],[MonauralHCPCSCode],[BinauralHCPCSCode],[IsActive]) VALUES(S.Brand, S.Family,S.Technology,S.Model,S.ItemCode,S.Style,
S.Colors,S.BatterySizes,S.ReceiverSizes,S.ReceiverPowers,S.MonauralHCPCSCode,S.BinauralHCPCSCode,1)
WHEN MATCHED 
    THEN UPDATE SET T.Brand = S.Brand,T.Family=S.Family,T.Technology=S.Technology,T.Model=S.Model,T.ItemCode=S.ItemCode,T.Style=S.Style,T.Colors=S.Colors,
	T.BatterySizes=S.BatterySizes,T.ReceiverSizes=S.ReceiverSizes,T.MonauralHCPCSCode=S.MonauralHCPCSCode,T.BinauralHCPCSCode=S.BinauralHCPCSCode,T.IsActive=1,T.ModifyDate=getdate()

OUTPUT $action, inserted.*, deleted.*;--,Deleted.Quantity, Deleted.ModifiedDate;
Commit Tran
--ROLLBACK TRAN;
--GO 

END  

CREATE PROCEDURE [catalog].[getModelInputOptions]
	(
	  @modelName NVARCHAR(550) = ''
	  ,@itemCode NVARCHAR(100) = ''
	  ,@modifier NVARCHAR(2) = 'LT'
	)
	AS
	BEGIN
		SET NOCOUNT ON
		DECLARE @ColorList AS varchar(MAX)
		DECLARE @ReceiverSizesList AS varchar(MAX) 
		DECLARE @ReceiverPowersList AS varchar(MAX) 
		DECLARE @BatterySizesList AS varchar(MAX)
		DECLARE @AttrCodeDesc AS nvarchar(MAX)
		DECLARE @AttrTable AS TABLE(Name varchar(20), ModelAttributeValue varchar(1000), ItemCode varchar(1000), IsActive bit)
		
		BEGIN

			INSERT INTO @AttrTable
			SELECT
				*
			FROM (
				select 'COLOR' as [Name],  REPLACE(ModelAttributeValue, ',', '') as  ModelAttributeValue, ItemCode, IsActive from [catalog].[ItemMasterAttributeValues] where AttributeCode = 'COLOR' and modifier in ('NA', @modifier)
				union
				select 'RECV_SIZE' as [Name],  REPLACE(ModelAttributeValue, ',', '') as ModelAttributeValue, ItemCode, IsActive from [catalog].[ItemMasterAttributeValues] where AttributeCode = 'RECIEVER_SIZES' and modifier in ('NA', @modifier)
				union
				select 'RECV_POW' as [Name],  REPLACE(ModelAttributeValue, ',', '') as ModelAttributeValue, ItemCode, IsActive from [catalog].[ItemMasterAttributeValues] where AttributeCode = 'RECIEVER_POWER' and modifier in ('NA', @modifier)
				union
				select 'BATT_SIZE' as [Name],  REPLACE(ModelAttributeValue, ',', '') as ModelAttributeValue, ItemCode, IsActive from [catalog].[ItemMasterAttributeValues] where AttributeCode = 'BATTERY_SIZES' and modifier in ('NA', @modifier)
			) tbl
			WHERE 1=1
				AND ItemCode = @itemCode
				AND IsActive = 1

			SET @ColorList = (select STRING_AGG (TRIM( REPLACE(ModelAttributeValue, ',', '') ), ',') from @AttrTable a where a.Name = 'COLOR')
			SET @ReceiverSizesList = (select STRING_AGG (TRIM( REPLACE(ModelAttributeValue, ',', '') ), ',') from @AttrTable a where a.Name = 'RECV_SIZE')
			SET @ReceiverPowersList = (select STRING_AGG (TRIM( REPLACE(ModelAttributeValue, ',', '') ), ',') from @AttrTable a where a.Name = 'RECV_POW')
			SET @BatterySizesList = (select STRING_AGG (TRIM( REPLACE(ModelAttributeValue, ',', '') ), ',') from @AttrTable a where a.Name = 'BATT_SIZE')
			IF NOT EXISTS (SELECT * FROM @AttrTable WHERE Name = 'COLOR') SET @ColorList = (SELECT 'NA')
			IF NOT EXISTS (SELECT * FROM @AttrTable WHERE Name = 'RECV_SIZE')  SET @ReceiverSizesList = (SELECT 'NA')
			IF NOT EXISTS (SELECT * FROM @AttrTable WHERE Name = 'RECV_POW')  SET @ReceiverPowersList = (SELECT 'NA')
			IF NOT EXISTS (SELECT * FROM @AttrTable WHERE Name = 'BATT_SIZE')  SET @BatterySizesList = (SELECT 'NA')
			IF 
				1=1 
				AND (SELECT StyleCode from catalog.ItemMasterList where ItemCode = @itemCode) not in ('BTE', 'RIC', 'RIE')
					BEGIN
						IF @ColorList <> 'NA' SET @ColorList = CONCAT(@ColorList, ',NA')
						IF @ReceiverSizesList <> 'NA' SET @ReceiverSizesList = CONCAT(@ReceiverSizesList, ',NA')
						IF @ReceiverPowersList <> 'NA' SET @ReceiverPowersList = CONCAT(@ReceiverPowersList, ',NA')
						IF @BatterySizesList <> 'NA' SET @BatterySizesList = CONCAT(@BatterySizesList, ',NA')
					END

			SET @AttrCodeDesc = (
				select 
					AttributeCode, '{' + STRING_AGG( '"' +TRIM(REPLACE(ModelAttributeValue, ',', '')) + '":"' + STRING_ESCAPE(ModelAttributeValueDescription,'json') + '"' ,',') + '}' as attributes
				from [catalog].[ItemMasterAttributeValues] 
				where ItemCode = @itemCode
				group by AttributeCode
				for json auto
			)
			
			SELECT DISTINCT
				[BrandCode], [FamilyCode], [TechnologyCode]
				, [ModelCode], iml.[ItemCode], [StyleCode]
				, @ColorList AS [Colors], @ReceiverSizesList AS [ReceiverSizes], @ReceiverPowersList AS [ReceiverPowers], @BatterySizesList AS [BatterySizes]
				, @AttrCodeDesc AS [AttributeCodeDescriptions] 
				, iml.[CreateDate], iml.[CreateUser]
				 , iml.[ModifyDate], iml.[ModifyUser], iml.[IsActive]
				 , [ItemID], [ItemType]
				 , '' as BinauralHCPCSCode,'' as MonauralHCPCSCode
			FROM [catalog].[ItemMasterList] iml
			INNER JOIN [catalog].[ItemMasterAttributeValues] imav on iml.ItemCode = imav.Itemcode
			WHERE 1=1
				AND iml.ModelCode = CASE WHEN @itemCode = '' THEN @modelName ELSE iml.ModelCode END
				AND iml.ItemCode = CASE WHEN @modelName = '' THEN @itemCode ELSE iml.ItemCode END
				AND imav.IsActive = 1
		END
    END

CREATE PROCEDURE [catalog].[GetVendorCode] @OrderItemId bigint
AS
BEGIN
    SET NOCOUNT ON

	SELECT TOP 1 case when BrandCode in ('STARKEY','PHONAK', 'UNITRON') then dbo.getproductmodelcode(OrderId,ItemCode,JSON_VALUE(ItemData,'$.color')) else ItemCode end as [VendorCode]
  FROM [Orders].[OrderItems] OI where OI.OrderItemId = @OrderItemId;
END

CREATE FUNCTION [catalog].[splitstring] ( @stringToSplit VARCHAR(MAX) )
RETURNS
 @returnList TABLE ([Name] [nvarchar] (500))
AS
BEGIN

 DECLARE @name NVARCHAR(255)
 DECLARE @pos INT

 WHILE CHARINDEX(',', @stringToSplit) > 0
 BEGIN
  SELECT @pos  = CHARINDEX(',', @stringToSplit)  
  SELECT @name = SUBSTRING(@stringToSplit, 1, @pos-1)

  INSERT INTO @returnList 
  SELECT @name

  SELECT @stringToSplit = SUBSTRING(@stringToSplit, @pos+1, LEN(@stringToSplit)-@pos)
 END

 INSERT INTO @returnList
 SELECT @stringToSplit

 RETURN
END
CREATE VIEW [catalog].[viewItemList] AS

SELECT rtrim(Itemcode)+'_1' as 'ItemCode', 'Monaural ' + Brand+' '+ Family + ' ' + Style as 'ItemDescription'  from [catalog].[viewModelList]
union
SELECT rtrim(Itemcode)+'_2' as 'ItemCode', 'Binaural ' + Brand+' '+ Family + ' ' + Style as 'ItemDescription'  from [catalog].[viewModelList]
union 
select 'TESTING' as 'ItemCode', 'Testing Complete and CoPayment' as 'ItemDescription'
union 
select 'FITTING' as 'ItemCode', 'Fitting Complete and CoPayment' as 'ItemDescription'
union 
select 'FOLLOWUP' as 'ItemCode', 'Followup Complete and CoPayment' as 'ItemDescription'
union 
select 'HAORDER' as 'ItemCode', 'Hearing Aid order CoPayment' as 'ItemDescription'




CREATE VIEW [catalog].[NobleDirectItemMaster] AS
	select * from 
	(
		select 
			'FOLLOWUP' as 'ITEM_ID',
			'V5011' as 'HCPCS_CODE',
			'Hearing Followup Service' as 'ITEM_DESCRIPTION',
			'10' as 'ITEM_PRICE'
		union
		select 
			'TESTING' as 'ITEM_ID',
			'992591' as 'HCPCS_CODE',
			'Hearing Test Service' as 'ITEM_DESCRIPTION',
			'10' as 'ITEM_PRICE'
		union
		select distinct
			ItemCode+'_2' as 'ITEM_ID',
			BinauralHCPCSCode as 'HCPCS_CODE',
			'Monaural Device,Brand:'+BrandCode+',Family:'+FamilyCode+',Shell:'+StyleCode  as 'ITEM_DESCRIPTION',
			'0' as 'ITEM_PRICE'
		from catalog.itemmasterlist
		union
		select distinct
			ItemCode+'_1' as 'ITEM_ID',
			MonauralHCPCSCode as 'HCPCS_CODE',
			'Binaural Device,Brand:'+BrandCode+', Family:'+FamilyCode+',Shell:'+StyleCode as 'ITEM_DESCRIPTION',
			'0' as 'ITEM_PRICE'
		from catalog.itemmasterlist
	) tbl
	where 1=1 
	and ITEM_ID <> '__1' 
	and ITEM_ID <> '__2'
	and ITEM_DESCRIPTION is not NULL

--select * from [catalog].[viewModelList] where family='CROS'


CREATE  VIEW [catalog].[viewModelList] AS

SELECT 
BrandCode as 'Brand', 
BrandFamilyCode as 'Family', 
FamilyProductCode as 'Technology',
ProductModelCode as 'Model',
upper(FamilyProductCode + '_' + ProductModelCode) as 'ItemCode',
(case 
    when StyleId = (select styleid from catalog.styles where stylecode='EDI_CUSTOMCATALOG')					then 'CUSTOM'
	when ProductModelCode like '%DRW%'	then 'RIE'
	when ProductModelCode like '%DWRZ%'	then 'RIE' -- This value wrong in catalog it is supposed to be DRWZ
	when ProductModelCode like '%DR%'	then 'RIE'
	when ProductModelCode like '%DVIR%'	then 'RIE'
	when ProductModelCode like '%DW%'	then 'BTE' 
	when ProductModelCode like '%DVI%'	then 'BTE' 
	when ProductModelCode like '%DI%'	then 'BTE' 
	--when ProductTypeCode like 'BTE'		then 'BTE'
    --when ProductTypeCode like 'RIE'		then 'RIE'
	else '---'
end) as 'Style',
(SELECT Stuff(
    (
    SELECT ', ' + A.[FeatureValueCode]
    FROM [catalog].[FeatureValues] A
	INNER JOIN [catalog].[FeatureValueRules] B ON B.[FeatureValueID] = A.[FeatureValueID] and B.[BrandFamilyCode] = [catalog].[ProductModelRules].BrandFamilyCode
	INNER JOIN [catalog].[Features] C ON C.[FeatureID] = A.[FeatureID]
	WHERE A.[FeatureName] in ('HOUSING COLOR','SHELL COLOR') 
    FOR XML PATH('')
    ), 1, 2, '')) + ',NA' AS Colors,
'10,13,312,675,NA' as 'BatterySizes',
'0,1,2,3,4,NA' as 'ReceiverSizes',
'LOW POWER,MEDIUM POWER,NORMAL POWER,HIGH POWER,ULTRA POWER,NA' as 'ReceiverPowers',
(case 
	 when [ShellCode]  in ('CIC','IIC')                then 'V5254' 
     when [ShellCode]  in ('ITC','HS','MIH')           then 'V5255' 
	 when [ShellCode]  in ('ITE','LP')                 then 'V5256' 
	 when [ShellCode]  is null
	 and 
	      [ProductModelCode] like '%DW%'  or 			   
		  [ProductModelCode] like '%DVI%' or 			   
	      [ProductModelCode] like '%DI%'			   then 'V5257' -- BTE 
	 else													'V5257' -- RIE 
end) as  'MonauralHCPCSCode', 
(case 
	 when [ShellCode]  in ('CIC','IIC')                then 'V5258' 
     when [ShellCode]  in ('ITC','HS','MIH')           then 'V5259' 
	 when [ShellCode]  in ('ITE','LP')                 then 'V5260' 
	 when [ShellCode]  is null
	 and 
	      [ProductModelCode] like '%DW%'  or 			   
		  [ProductModelCode] like '%DVI%' or 			   
	      [ProductModelCode] like '%DI%'			   then 'V5261' -- BTE 
	 else											        'V5261' -- RIE 
end ) as  'BinauralHCPCSCode'
FROM
[catalog].[ProductModelRules]
WHERE 
BrandCode IS NOT  NULL
and Not (ProductModelCode like '%DRWZ%' or  ProductModelCode like '%DWRZ%' )
and IsActive=1

--- Below  Union is only handle DWRZ Models to Match with Benefit Matrix 
UNION

SELECT 
BrandCode as 'Brand', 
BrandFamilyCode as 'Family', 
FamilyProductCode + ' DRWZ' as 'Technology',
ProductModelCode as 'Model',
upper(FamilyProductCode + '_' + ProductModelCode) as 'ItemCode',
(case 
    when StyleId = (select styleid from catalog.styles where stylecode='EDI_CUSTOMCATALOG')						then 'CUSTOM'
	when ProductModelCode like '%DRW%'	then 'RIE'
	when ProductModelCode like '%DWRZ%'	then 'RIE' -- This value wrong in catalog it is supposed to be DRWZ
	when ProductModelCode like '%DR%'	then 'RIE'
	when ProductModelCode like '%DVIR%'	then 'RIE'
	when ProductModelCode like '%DW%'	then 'BTE' 
	when ProductModelCode like '%DVI%'	then 'BTE' 
	when ProductModelCode like '%DI%'	then 'BTE' 
	--when ProductTypeCode like 'BTE'		then 'BTE'
    --when ProductTypeCode like 'RIE'		then 'RIE'
	else '---'
end) as 'Style',
--'BEIGE,BLUE-RED,CLEAR,DARK,EARLUSION LIGHT,ESPRESSO,LIGHT,MEDIUM,ROSE' as 'Colors',
(SELECT Stuff(
    (
    SELECT ', ' + A.[FeatureValueCode]
    FROM [catalog].[FeatureValues] A
	INNER JOIN [catalog].[FeatureValueRules] B ON B.[FeatureValueID] = A.[FeatureValueID] and B.[BrandFamilyCode] = [catalog].[ProductModelRules].BrandFamilyCode
	INNER JOIN [catalog].[Features] C ON C.[FeatureID] = A.[FeatureID]
	WHERE A.[FeatureName] in ('HOUSING COLOR','SHELL COLOR') 
    FOR XML PATH('')
    ), 1, 2, '')) + ',NA' AS Colors,
'10,13,312,675,NA' as 'BatterySizes',
'0,1,2,3,4,NA' as 'ReceiverSizes',
'LOW POWER,MEDIUM POWER,NORMAL POWER,HIGH POWER,ULTRA POWER,NA' as 'ReceiverPowers',
(case 
	 when [ShellCode]  in ('CIC','IIC')                then 'V5254' 
     when [ShellCode]  in ('ITC','HS','MIH')           then 'V5255' 
	 when [ShellCode]  in ('ITE','LP')                 then 'V5256' 
	 when [ShellCode]  is null
	 and 
	      [ProductModelCode] like '%DW%'  or 			   
		  [ProductModelCode] like '%DVI%' or 			   
	      [ProductModelCode] like '%DI%'			   then 'V5257' -- BTE 
	 else													'V5257' -- RIE 
end) as  'MonauralHCPCSCode', 
(case 
	 when [ShellCode]  in ('CIC','IIC')                then 'V5258' 
     when [ShellCode]  in ('ITC','HS','MIH')           then 'V5259' 
	 when [ShellCode]  in ('ITE','LP')                 then 'V5260' 
	 when [ShellCode]  is null
	 and 
	      [ProductModelCode] like '%DW%'  or 			   
		  [ProductModelCode] like '%DVI%' or 			   
	      [ProductModelCode] like '%DI%'			   then 'V5261' -- BTE 
	 else											        'V5261' -- RIE 
end ) as  'BinauralHCPCSCode'
FROM
[catalog].[ProductModelRules]
WHERE 
BrandCode IS NOT  NULL
and 
(ProductModelCode like '%DRWZ%' or  ProductModelCode like '%DWRZ%' )
and IsActive=1



UNION

SELECT 
rtrim(upper(Manufacturer)) as 'Brand', 
rtrim(upper(Family)) as 'Family', 
rtrim(upper(Technology)) as 'Technology',
upper(Model) as 'Model',
upper(rtrim(Technology)) + '_' + upper(Model) as 'ItemCode',
upper(rtrim(Style)) as 'Style',
(
  case 
      when Colors is null or rtrim(colors)='' then 'NA'
	  else upper(Colors) +',NA'
  end
) as 'Colors',
(case 
      when BatterySize is null or rtrim(BatterySize) = '' then 'NA'
	  else BatterySize + ',NA'
 end
) as 'BatterySizes',
--BatterySize + ',NA' as 'BatterySizes',
(case 
      when ReceiverSize is null or rtrim(ReceiverSize) = '' then 'NA'
	  else ReceiverSize + ',NA'
 end
) as 'ReceiverSizes',
(case 
      when ReceiverPower is null or rtrim(ReceiverPower) = '' then 'NA'
	  else ReceiverPower +',NA'
 end
) as 'ReceiverPowers',
  (case 
	 when Style  in ('CIC','IIC','mCIC')												then 'V5254' 
     when Style  in ('ITC','HS','MIH','mini canal','canal','mITC')						then 'V5255' 
	 when Style  in ('ITE','LP')														then 'V5256' 
	 when Style  in ('BTE','RIE', 'RIC','mBTE', 'mRIC', 'mRITE', 'RITE', 'designRITE')	then 'V5257' 
	 when  Family in ('CROS')															then  'NA'
	 else																					 'V5257'
end) as  'MonauralHCPCSCode', 

(case 
	 when Style  in ('CIC','IIC','mCIC')												then 'V5258' 
     when Style  in ('ITC','HS','MIH','mini canal','canal','mITC')						then 'V5259' 
	 when Style  in ('ITE','LP')														then 'V5260' 
	 when Style  in ('BTE','RIE', 'RIC','mBTE', 'mRIC', 'mRITE', 'RITE', 'designRITE')	then 'V5261' 
	 when  Family in ('CROS')															then  'NA'
	 else																					 'V5261'  
end ) as  'BinauralHCPCSCode'


FROM
[catalog].[OtherProductsRules]
--where IsActive=1

UNION
SELECT

'GNR' as 'Brand', 
'MAGNA' as 'Family', 
'RS MAGNA 4' as 'Technology',
'MG 490-DVI' as 'Model',
'RS MAGNA 4_MG 490-DVI'  as 'ItemCode',
'BTE' as 'Style',
'BEIGE, DARK BROWN, BLACK, MEDIUM BLONDE,NA' as 'Colors',
'675,NA' as 'BatterySizes',
'NA' as 'ReceiverSizes',
'NA' as 'ReceiverPowers',
 'V5257' as  'MonauralHCPCSCode', 
 'V5261'  as  'BinauralHCPCSCode'








 CREATE view ccai.ViewccaiInsNotRcvd as
SELECT 
	 NHLinkID,
	MemberIdentificationNumber,
	EligPlanNbr,
	EligibilityEffectiveDate,
	EligibilityTerminationDate,
	GroupNumber
FROM ccai.CCAIInsurance
where statusflag not in ('D','O')
EXCEPT
SELECT	DISTINCT 
	MemberIdentificationNumber NHLinkID,
	MemberIdentificationNumber,
	EligPlanNbr,
	MedicaidEffectiveDate,
	MedicaidTerminationDate,
	GroupNumber
FROM ccai.CCAIStgEligData 

create view ccai.ViewccaiMembers as 
SELECT  DISTINCT MemberIdentificationNumber NHLinkID,
		MemberIdentificationNumber,
		MembersDateOfBirth,
		ClientNumber,
		MemberLastName,
		MemberFirstName,
		MemberMiddleName,
		SocialSecurityNumber,
		MemberPhoneNumber,
		MemberAddressLine1,
		MemberAddressLine2,
		MemberCityName,
		MemberStateName,
		MemberZipCode,
		MemberDateOfDeath,
		MemberSex,
		MemberRace,
		MemberLanguage,
		MemberMailingAddressLine1,
		MemberMailingAddressLine2,
		MemberMailingCityName,
		MemberMailingStateName,
		MemberMailingZipCode
		from ccai.CCAIStgEligData
EXCEPT
SELECT 
		NHLinkID,
		MemberIdentificationNumber,
		MembersDateOfBirth,
		ClientNumber,
		MemberLastName,
		MemberFirstName,
		MemberMiddleName,
		SocialSecurityNumber,
		cast(MemberPhoneNumber as varchar) MemberPhoneNumber,
		MemberAddressLine1,
		MemberAddressLine2,
		MemberCityName,
		MemberStateName,
		MemberZipCode,
		MemberDateOfDeath,
		MemberSex,
		MemberRace,
		MemberLanguage,
		MemberMailingAddressLine1,
		MemberMailingAddressLine2,
		MemberMailingCityName,
		MemberMailingStateName,
		MemberMailingZipCode
from ccai.CCAIMembers
where statusflag not in ('D','O')

create view ccai.ViewccaiMemNotRcvd as
SELECT  NHLinkID,
		MemberIdentificationNumber,
		MembersDateOfBirth,
		ClientNumber,
		MemberLastName,
		MemberFirstName,
		MemberMiddleName,
		SocialSecurityNumber,
		cast(MemberPhoneNumber as varchar) MemberPhoneNumber ,
		MemberAddressLine1,
		MemberAddressLine2,
		MemberCityName,
		MemberStateName,
		MemberZipCode,
		MemberDateOfDeath,
		MemberSex,
		MemberRace,
		MemberLanguage,
		MemberMailingAddressLine1,
		MemberMailingAddressLine2,
		MemberMailingCityName,
		MemberMailingStateName,
		MemberMailingZipCode
from ccai.CCAIMembers
where statusflag not in ('D','O')
EXCEPT
SELECT DISTINCT MemberIdentificationNumber NHLinkID,
		MemberIdentificationNumber,
		MembersDateOfBirth,
		ClientNumber,
		MemberLastName,
		MemberFirstName,
		MemberMiddleName,
		SocialSecurityNumber,
		MemberPhoneNumber,
		MemberAddressLine1,
		MemberAddressLine2,
		MemberCityName,
		MemberStateName,
		MemberZipCode,
		MemberDateOfDeath,
		MemberSex,
		MemberRace,
		MemberLanguage,
		MemberMailingAddressLine1,
		MemberMailingAddressLine2,
		MemberMailingCityName,
		MemberMailingStateName,
		MemberMailingZipCode
from ccai.CCAIStgEligData

		

CREATE view ccai.ViewccaiInsurance as
SELECT	
	 MemberIdentificationNumber NHLinkID,
	MemberIdentificationNumber,
	EligPlanNbr,
	case when EligibilityEffectiveDate ='' then MedicaidEffectiveDate else EligibilityEffectiveDate end as EligibilityEffectiveDate,
	case when  EligibilityTerminationDate ='' then MedicaidTerminationDate else EligibilityTerminationDate end  as EligibilityTerminationDate,
	GroupNumber
FROM ccai.CCAIStgEligData 
where EligibilityTerminationDate > getdate()  and MedicaidTerminationDate > MedicaidEffectiveDate
--where (EligibilityTerminationDate > cast('20181231' as date)) or EligibilityTerminationDate =''
EXCEPT 
SELECT 
	NHLinkID,
	MemberIdentificationNumber,
	EligPlanNbr,
	EligibilityEffectiveDate,
	EligibilityTerminationDate,
	GroupNumber
FROM ccai.CCAIInsurance
where statusflag not in ('D','O')
CREATE PROCEDURE [centralhealth].[CH_elig_file_load_ssis_sp_merge] 
@Client_Name varchar(20)
AS
-- exec [centralhealth].[CH_elig_file_load_ssis_sp_merge] 'ELIG_CH'

IF @Client_Name = 'ELIG_CH'

BEGIN
		
		BEGIN TRY
	    BEGIN TRANSACTION CH_elig_file_load_ssis


			EXEC [centralhealth].[CH_elig_file_load_ssis_sp_merge_stg_to_ch]

			EXEC [centralhealth].[CH_elig_file_load_ssis_sp_merge_ch_to_masters]


		COMMIT TRANSACTION CH_elig_file_load_ssis

		PRINT 'SUCCESS'
		END TRY

		BEGIN CATCH
		DECLARE @ErrorMessage NVARCHAR(4000);  
		DECLARE @ErrorSeverity INT;  
		DECLARE @ErrorState INT;  

		SELECT   
			@ErrorMessage = ERROR_MESSAGE(),  
			@ErrorSeverity = ERROR_SEVERITY(),  
			@ErrorState = ERROR_STATE();  

		IF (@@TRANCOUNT > 0)
		BEGIN
			ROLLBACK TRANSACTION CH_elig_file_load_ssis
			RAISERROR(@ErrorMessage,@ErrorSeverity,@ErrorState);
			PRINT 'FAILED'
		END

		END CATCH




END


-- EXEC [centralhealth].[CH_elig_file_load_ssis_sp_merge_stg_to_ch]

CREATE PROCEDURE [centralhealth].[CH_elig_file_load_ssis_sp_merge_stg_to_ch]
AS


BEGIN

	--BEGIN TRY
	--BEGIN TRANSACTION CH_ELIG_MERGE_stg_to_ch




		DECLARE @sys_usr CHAR(30)
		       ,@sys_date DATETIME;  

		SET @sys_usr = SYSTEM_USER
		SET @sys_date = CAST(GETDATE() AT TIME ZONE 'UTC' AT TIME ZONE 'Eastern Standard Time' AS DATETIME);  -- Time in EST

		drop table if exists centralhealth.DataViewCHMembers
		drop table if exists centralhealth.DataVCHMemNotRcvd 
		drop table if exists centralhealth.DataVCHIns
		drop table if exists centralhealth.DataVCHInsNotRcvd
		
		


		select * into centralhealth.DataViewCHMembers from centralhealth.ViewCHMembers --New or cHanged Members
		create index dataview_idx1 on centralhealth.DataViewCHMembers (NHLinkID) 

		select * into centralhealth.DataVCHMemNotRcvd from centralhealth.ViewCHMemNotRcvd n  --Memebers who are completely dropped off the new file
		where not exists (select 1 from centralhealth.DataViewCHMembers d where d.NHLinkID = n.NHLinkID) 
		create index dataview_idx2 on centralhealth.DataVCHMemNotRcvd (NHLinkID)

		select * into centralhealth.DataVCHIns from centralhealth.ViewCHInsurance
		create index dataview_idx2 on centralhealth.DataVCHIns (NHLinkID) 


		select * into centralhealth.DataVCHInsNotRcvd from centralhealth.ViewCHInsNotRcvd n 
		where not exists (select 1 from centralhealth.DataVCHIns d where d.NHLinkID = n.NHLinkID and d.EligibilityEffectiveDate = n.EligibilityEffectiveDate)
		create index dataview_idx2 on centralhealth.DataVCHInsNotRcvd (NHLinkID) 

		update centralhealth.CHInsurance
		set tobeprocessed = 'N'
		where ToBeProcessed = 'Y'

		update centralhealth.CHMEMBERS
		set tobeprocessed = 'N'
		where ToBeProcessed = 'Y'

		update centralhealth.DataViewCHMembers 
		set MemberPhoneNumber = ''
		where MemberIdentificationNumber in ( select MemberIdentificationNumber from centralhealth.DataViewCHMembers
		where len(Memberphonenumber) >10)


		MERGE centralhealth.CHmembers m USING centralhealth.DataViewCHMembers d
		ON (m.NHLinkID = d.NHLinkID)
		WHEN MATCHED THEN
		UPDATE SET
		MemberIdentificationNumber = d.MemberIdentificationNumber,
		MembersDateOfBirth = d.MembersDateOfBirth,
		MemberLastName = d.MemberLastName,
		MemberFirstName = d.MemberFirstName,
		MemberMiddleName = d.MemberMiddleName,
		SocialSecurityNumber = d.SocialSecurityNumber,
		MemberPhoneNumber = case isnull(d.MemberPhoneNumber,'') when '' then 0 else cast(d.MemberPhoneNumber as bigint) end,
		MemberAddressLine1 = d.MemberAddressLine1,
		MemberAddressLine2 = d.MemberAddressLine2,
		MemberCityName = d.MemberCityName,
		MemberStateName = d.MemberStateName,
		MemberZipCode = d.MemberZipCode,
		MemberDateOfDeath = d.MemberDateOfDeath,
		MemberSex = d.MemberSex,
		MemberRace = d.MemberRace,
		MemberLanguage = d.MemberLanguage,
		MemberMailingAddressLine1 = d.MemberMailingAddressLine1,
		MemberMailingAddressLine2 = d.MemberMailingAddressLine2,
		MemberMailingCityName = d.MemberMailingCityName,
		MemberMailingStateName = d.MemberMailingStateName,
		MemberMailingZipCode = d.MemberMailingZipCode,
		statusflag = 'U',
		tobeprocessed = 'Y',
		ModifyDate = @sys_date,
		ModifyUser = @sys_usr
		WHEN NOT MATCHED THEN
		INSERT (
		NHLinkID,
		MemberIdentificationNumber,
		MembersDateOfBirth,
		MemberLastName,
		MemberFirstName,
		MemberMiddleName,
		SocialSecurityNumber,
		MemberPhoneNumber,
		MemberAddressLine1,
		MemberAddressLine2,
		MemberCityName,
		MemberStateName,
		MemberZipCode,
		MemberDateOfDeath,
		MemberSex,
		MemberRace,
		MemberLanguage,
		MemberMailingAddressLine1,
		MemberMailingAddressLine2,
		MemberMailingCityName,
		MemberMailingStateName,
		MemberMailingZipCode,
		statusflag,
		tobeprocessed,
		createDate,
		CreateUser,
		ModifyDate,
		ModifyUser)
		VALUES (
		d.NHLinkID,
		d.MemberIdentificationNumber,
		d.MembersDateOfBirth,
		d.MemberLastName,
		d.MemberFirstName,
		d.MemberMiddleName,
		d.SocialSecurityNumber,
		case isnull(d.MemberPhoneNumber,'') when '' then 0 else cast(d.MemberPhoneNumber as bigint) end,
		d.MemberAddressLine1,
		d.MemberAddressLine2,
		d.MemberCityName,
		d.MemberStateName,
		d.MemberZipCode,
		d.MemberDateOfDeath,
		d.MemberSex,
		d.MemberRace,
		d.MemberLanguage,
		d.MemberMailingAddressLine1,
		d.MemberMailingAddressLine2,
		d.MemberMailingCityName,
		d.MemberMailingStateName,
		d.MemberMailingZipCode,
		'N',
		'Y',@sys_date,
		@sys_usr, @sys_date, @sys_usr);



		MERGE centralhealth.CHinsurance i USING centralhealth.DataVCHIns d
		ON (i.NHLinkID = d.NHLinkID and i.EligibilityEffectiveDate = d.EligibilityEffectiveDate)
		WHEN MATCHED THEN
		UPDATE SET
		EligibilityTerminationDate = d.EligibilityTerminationDate,
		GroupNumber = d.GroupNumber,
		EligPlanNbr=d.EligPlanNbr,
		statusflag = 'U',
		tobeprocessed = 'Y',
		ModifyDate = @sys_date,
		ModifyUser = @sys_usr
		WHEN NOT MATCHED THEN
		INSERT (
		NHLinkID,
		MemberIdentificationNumber,
		EligibilityEffectiveDate,
		EligibilityTerminationDate,
		GroupNumber,
		EligPlanNbr,
		statusflag,
		tobeprocessed,
		CreateDate,
		CreateUser,
		ModifyDate,
		ModifyUser)
		VALUES (
		d.NHLinkID,
		d.MemberIdentificationNumber,
		 d.EligibilityEffectiveDate,d.EligibilityTerminationDate,d.GroupNumber,d.EligPlanNbr,
		'N',
		'Y',@sys_date,
		@sys_usr, @sys_date, @sys_usr);


		update centralhealth.CHInsurance
		set  statusflag = 'O', tobeprocessed = 'N'
		where eligibilityterminationdate < cast('20180101' as date)

		update a
		set statusflag = 'D', tobeprocessed = 'Y', modifydate = @sys_date, modifyuser = @sys_usr
		from centralhealth.CHmembers a
		where exists (select 1 from centralhealth.DataVCHMemNotRcvd d where d.NHLinkID = a.NHLinkID)


		update a
		set statusflag = 'D', tobeprocessed = 'Y', modifydate = @sys_date, modifyuser = @sys_usr
		from centralhealth.CHinsurance a
		where exists (select 1 from centralhealth.DataVCHInsNotRcvd d where d.NHLinkID = a.NHLinkID and d.EligibilityEffectiveDate = a.EligibilityEffectiveDate)


		update i
		set i.PlanNumber = a.BenefitMatrixPlanNbr
		from centralhealth.CHInsurance i
		inner join centralhealth.CHlink a
		on (a.EligPlanNbr = i.EligPlanNbr) 
		and i.ToBeProcessed = 'Y'


		update centralhealth.CHInsurance
		set healthplanid = null
		where tobeprocessed = 'Y'


		update  i
		set healthplanid = hp.insurancehealthplanid
		from centralhealth.CHInsurance  i
		inner join insurance.insurancehealthplans hp
		on (i.PlanNumber = hp.healthplannumber and hp.insurancecarrierid = 4 and hp.healthplannumber is not null)
		where tobeprocessed = 'Y'


		update  centralhealth.CHInsurance
		set statusflag = 'E', tobeprocessed = 'E'
		where plannumber is null and tobeprocessed = 'Y'
				


	--COMMIT TRANSACTION CH_ELIG_MERGE_stg_to_ch
	--PRINT 'SUCCESS'
	--END TRY

	--BEGIN CATCH
	--DECLARE @ErrorMessage NVARCHAR(4000);  
 --   DECLARE @ErrorSeverity INT;  
 --   DECLARE @ErrorState INT;  

 --   SELECT   
 --       @ErrorMessage = ERROR_MESSAGE(),  
 --       @ErrorSeverity = ERROR_SEVERITY(),  
 --       @ErrorState = ERROR_STATE();  

	--IF (@@TRANCOUNT > 0)
	--BEGIN
	--	ROLLBACK TRANSACTION CH_ELIG_MERGE_stg_to_ch
	--	RAISERROR(@ErrorMessage,@ErrorSeverity,@ErrorState);
	--	PRINT 'FAILED'
	--END

	--END CATCH

END


-- EXEC [centralhealth].[CH_elig_file_load_ssis_sp_merge_ch_to_masters]

CREATE PROCEDURE [centralhealth].[CH_elig_file_load_ssis_sp_merge_ch_to_masters]
AS


BEGIN

	--BEGIN TRY
	--BEGIN TRANSACTION CH_ELIG_MERGE_ch_to_masters




		DECLARE @sys_usr CHAR(30)
		       ,@sys_date DATETIME;  

		SET @sys_usr = SYSTEM_USER
		SET @sys_date = CAST(GETDATE() AT TIME ZONE 'UTC' AT TIME ZONE 'Eastern Standard Time' AS DATETIME);  -- Time in EST

		-- drop not null record insert constraint (unique index) on NHMemberID in master.members before inserting new members or updating NHMemberID for new records inserted
		ALTER TABLE [otc].[Cards] DROP CONSTRAINT [FK_Cards_NHMemberId]
		
		ALTER TABLE [Master].[Members] DROP CONSTRAINT [IX_Members_NHMemberID_U]

		merge into master.members d
		using (select * from centralhealth.CHmembers where tobeprocessed = 'Y' and statusflag in ('N','U')) s
		on (d.memberid = s.mastermemberid )
		when matched then 
		update set
		d.datasource = 'ELIG_CH',
		d.DateOfBirth = s.MembersDateOfBirth,
		d.FirstName = s.MemberFirstName,
		d.Gender = s.MemberSex,
		d.IsActive = 1,
		d.LastName = s.MemberLastName,
		d.MiddleInitial = s.MemberMiddleName,
		d.ModifyDate = @sys_date,
		d.ModifyUser = @sys_usr,
		d.eligFile = 'ELIG_CH',
		d.eligFileID = s.ID
		when not matched then 
		insert ( 
		CreateDate,
		 CreateUser,
		 DataSource,
		 DateOfBirth,
		 FirstName,
		 Gender,
		 IsActive,
		 LastName,
		 MiddleInitial,
		 ModifyDate,
		 ModifyUser,
		 eligFile,
		 eligFileID) 
		 values 
		 (
		 @sys_date
		,@sys_usr
		,'ELIG_CH'
		,MembersDateOfBirth
		,MemberFirstName
		,MemberSex
		,1
		,MemberLastName
		,MemberMiddleName
		,@sys_date
		,@sys_usr
		,'ELIG_CH'
		,s.ID 
		);

		update master.members
		SET nhmemberid = 'NH'+RIGHT(YEAR(GETDATE()),4)+ FORMAT(memberid,'00000000')							 --    'NH2018'+ FORMAT(memberid,'00000000')
		WHERE EligFile = 'ELIG_CH'
		AND nhmemberid IS NULL

		ALTER TABLE [Master].[Members] ADD  CONSTRAINT [IX_Members_NHMemberID_U] UNIQUE NONCLUSTERED 
				(
					[NHMemberID] ASC
				)

		ALTER TABLE [otc].[Cards]  ADD  CONSTRAINT [FK_Cards_NHMemberId] FOREIGN KEY
		(
			[NHMemberId]
		)
		REFERENCES [Master].[Members] ([NHMemberID])
		
		

		update a 
		set mastermemberid = (select memberid from master.members m where m.eligfile= 'ELIG_CH' and m.eligFileID = a.id)
		from centralhealth.CHmembers a
		where tobeprocessed = 'Y'
		and mastermemberid is null

		
		update i
		set mastermemberid = (select mastermemberid from centralhealth.CHMembers m where m.NHLinkID = i.NHLinkID )
		from centralhealth.CHInsurance i
		where exists (select 1 from centralhealth.CHmembers m1 where m1.NHLinkID = i.NHLinkID)
		and i.ToBeProcessed = 'Y'
		and mastermemberid is null 


		merge master.addresses d
		using (select * from centralhealth.CHmembers where tobeprocessed = 'Y' and MemberAddressLine1 <> '') s
		on (d.memberid = s.mastermemberid and d.AddressTypeCode = 'PERM')
		when matched then
		update set
		Address1 = s.MemberAddressLine1
		,Address2 = s.MemberAddressLine2
		,City = s.MemberCityName
		,State = s.MemberStateName
		,ZipCode = s.MemberZipCode
		,IsActive = 1
		,IsPreferredAddress = 1
		,MemberID = s.mastermemberid
		,ModifyDate = @sys_date
		, ModifyUser = @sys_usr
		when not matched then 
		insert (
		 Address1
		,Address2
		,AddressTypeCode
		,City
		,State
		,ZipCode
		,EffectiveFromDate
		,EffectiveToDate
		,IsActive
		,IsPreferredAddress
		,MemberID
		,CreateDate
		,CreateUser
		,ModifyDate
		, ModifyUser
		)
		values(
		 s.MemberAddressLine1
		,s.MemberAddressLine2
		,'PERM'
		,s.MemberCityName
		,s.MemberStateName
		,s.MemberZipCode
		,@sys_date 
		,cast('20991231' as date) 
		,1 
		,1 
		,s.mastermemberid
		,@sys_date
		,@sys_usr
		,@sys_date
		,@sys_usr);


		merge master.addresses d
		using (select * from centralhealth.CHmembers where tobeprocessed = 'Y' and MemberMailingAddressLine1 <> '') s
		on (d.memberid = s.mastermemberid and d.AddressTypeCode = 'MAIL')
		when matched then
		update set
		Address1 = s.MemberMailingAddressLine1
		,Address2 = s.MemberMailingAddressLine2
		,City = s.MemberMailingCityName
		,State = s.MemberMailingStateName
		,ZipCode = s.MemberMailingZipCode
		,IsActive = 1
		,IsPreferredAddress = 0
		,MemberID = s.mastermemberid
		,ModifyDate = @sys_date
		, ModifyUser = @sys_usr
		when not matched then 
		insert (
		 Address1
		,Address2
		,AddressTypeCode
		,City
		,State
		,ZipCode
		,EffectiveFromDate
		,EffectiveToDate
		,IsActive
		,IsPreferredAddress
		,MemberID
		,CreateDate
		,CreateUser
		,ModifyDate
		, ModifyUser
		)
		values(
		 s.MemberMailingAddressLine1
		,s.MemberMailingAddressLine2
		,'MAIL'
		,s.MemberMailingCityName
		,s.MemberMailingStateName
		,s.MemberMailingZipCode
		,@sys_date
		,cast('20991231' as date) 
		,1 
		,0 
		,s.mastermemberid
		,@sys_date
		,@sys_usr
		,@sys_date
		,@sys_usr);

		

		merge master.PhoneNumbers d
		using (select * from centralhealth.CHmembers where tobeprocessed = 'Y' and MemberPhoneNumber <> 0) s
		on (d.memberid = s.mastermemberid and d.PhoneTypeCode = 'HOME')
		when matched then 
		update set
		CountryCode = '001'
		,PhoneNbr = s.MemberPhoneNumber
		, IsActive = 1
		,MemberID = s.mastermemberid
		, ModifyDate = @sys_date
		, ModifyUser = @sys_usr
		when not matched then 
		insert (
		CountryCode
		,PhoneNbr
		, PhoneTypeCode
		, EffectiveFromDate
		,EffectiveToDate
		, IsActive
		,IsPreferredPhoneNumber
		,MemberID
		,CreateDate
		, CreateUser
		, ModifyDate
		, ModifyUser
		)
		Values ( 
		'001' 
		,s.MemberPhoneNumber 
		,'HOME' 
		,@sys_date 
		,cast('20991231' as date) 
		,1 
		,0 
		,s.mastermemberid 
		,@sys_date 
		,@sys_usr
		,@sys_date
		,@sys_usr);

		merge into master.memberinsurances d
		using (select * from centralhealth.CHinsurance where tobeprocessed = 'Y'  and statusflag in ('N','U') ) s --and HealthPlanId is not null
		on (s.memberinsuranceid = d.id)
		when matched then
		update set
		InsuranceEndDate = EligibilityTerminationDate,
		InsuranceHealthPlanID = s.healthplanid,
		IsActive = 1,
		ModifyDate = @sys_date,
		ModifyUser = @sys_usr
		when not matched then 
		insert (CreateDate,CreateUser,InsuranceCarrierID,InsuranceEffectiveDate,InsuranceEndDate,
		InsuranceHealthPlanID,IsActive,MemberID,ModifyDate,ModifyUser,eligFile,eligFileID)
		values (
		@sys_date 
		, @sys_usr 
		,4 
		,EligibilityEffectiveDate 
		,EligibilityTerminationDate 
		,healthplanid 
		,1 
		,mastermemberid 
		,@sys_date
		, @sys_usr ,'ELIG_CH',s.ID);

		
		update i
		set memberinsuranceid = (select m.id from master.memberinsurances m where m.memberid = i.mastermemberid and m.eligFile = 'ELIG_CH'  and m.eligFileID = i.ID and m.insurancecarrierid = 4)
		from centralhealth.CHinsurance i
		where tobeprocessed = 'Y'
		and memberinsuranceid is null


		merge master.MemberInsuranceDetails d
		using (select * from centralhealth.CHinsurance where tobeprocessed = 'Y' and statusflag in ('N','U')) s
		on (d.MemberInsuranceID = s.memberinsuranceid)
		when matched then 
		update set
		InsuranceNbr = s.MemberIdentificationNumber,
		IsInsuranceEligibilityVerified = case s.statusflag when 'D' then 0 else 1 end,
		ModifyDate = @sys_date,
		ModifyUser = @sys_usr
		when not matched then
		insert (
		CreateDate
		,CreateUser
		,InsuranceNbr
		,IsActive
		,IsInsuranceEligibilityVerified
		,MemberInsuranceID
		,ModifyDate
		,ModifyUser
		)
		values ( 
		@sys_date
		,@sys_usr
		,s.MemberIdentificationNumber
		,1 
		,1 
		,s.MemberInsuranceID
		,@sys_date
		,@sys_usr
		);


	--COMMIT TRANSACTION CH_ELIG_MERGE_ch_to_masters
	--PRINT 'SUCCESS'
	--END TRY

	--BEGIN CATCH
	--DECLARE @ErrorMessage NVARCHAR(4000);  
 --   DECLARE @ErrorSeverity INT;  
 --   DECLARE @ErrorState INT;  

 --   SELECT   
 --       @ErrorMessage = ERROR_MESSAGE(),  
 --       @ErrorSeverity = ERROR_SEVERITY(),  
 --       @ErrorState = ERROR_STATE();  

	--IF (@@TRANCOUNT > 0)
	--BEGIN
	--	ROLLBACK TRANSACTION CH_ELIG_MERGE_ch_to_masters
	--	RAISERROR(@ErrorMessage,@ErrorSeverity,@ErrorState);
	--	PRINT 'FAILED'
	--END

	--END CATCH

END

CREATE view centralhealth.ViewCHOtherData as 
SELECT  DISTINCT MemberIdentificationNumber NHLinkID,
		[NationalProviderIdentification],
		[ProviderPhoneNumber],
		[ProviderEffectiveDate],
		[ProviderTerminationDate]
		from centralhealth.CHStgEligData
EXCEPT
SELECT 
		NHLinkID,
		[NationalProviderIdentification],
		cast([ProviderPhoneNumber] as varchar)[ProviderPhoneNumber],
		[ProviderEffectiveDate],
		[ProviderTerminationDate]		
from centralhealth.CHOtherData
where statusflag not in ('D','O')



CREATE view [centralhealth].[ViewCHMembers] as -- New Members or Any CHanged members

SELECT  DISTINCT MemberIdentificationNumber NHLinkID,
		MemberIdentificationNumber,
		cast(MembersDateOfBirth as date) MembersDateOfBirth,
		ClientNumber,
		MemberLastName,
		MemberFirstName,
		MemberMiddleName,
		SocialSecurityNumber,
		MemberPhoneNumber,
		MemberAddressLine1,
		MemberAddressLine2,
		MemberCityName,
		MemberStateName,
		MemberZipCode,
		MemberDateOfDeath,
		MemberSex,
		MemberRace,
		MemberLanguage,
		MemberMailingAddressLine1,
		MemberMailingAddressLine2,
		MemberMailingCityName,
		MemberMailingStateName,
		MemberMailingZipCode
		from centralhealth.CHStgEligData
EXCEPT
SELECT 
		NHLinkID,
		MemberIdentificationNumber,
		cast(MembersDateOfBirth as date) MembersDateOfBirth,
		MemberIdentificationNumber ClientNumber,
		MemberLastName,
		MemberFirstName,
		MemberMiddleName,
		SocialSecurityNumber,
		case when cast(MemberPhoneNumber as varchar) ='0' then '' else cast(MemberPhoneNumber as varchar) end MemberPhoneNumber,
		MemberAddressLine1,
		MemberAddressLine2,
		MemberCityName,
		MemberStateName,
		MemberZipCode,
		MemberDateOfDeath,
		MemberSex,
		MemberRace,
		MemberLanguage,
		MemberMailingAddressLine1,
		MemberMailingAddressLine2,
		MemberMailingCityName,
		MemberMailingStateName,
		MemberMailingZipCode
from centralhealth.CHMembers
where statusflag not in ('D','O')



CREATE view [centralhealth].[ViewCHMemNotRcvd] as -- Members Not received and also Mmebers who changed from Existing Members
SELECT  NHLinkID,
		MemberIdentificationNumber,
		MembersDateOfBirth,
		MemberIdentificationNumber as ClientNumber,
		MemberLastName,
		MemberFirstName,
		MemberMiddleName,
		SocialSecurityNumber,
		case when cast(MemberPhoneNumber as varchar) ='0' then '' else cast(MemberPhoneNumber as varchar) end MemberPhoneNumber,
		MemberAddressLine1,
		MemberAddressLine2,
		MemberCityName,
		MemberStateName,
		MemberZipCode,
		MemberDateOfDeath,
		MemberSex,
		MemberRace,
		MemberLanguage,
		MemberMailingAddressLine1,
		MemberMailingAddressLine2,
		MemberMailingCityName,
		MemberMailingStateName,
		MemberMailingZipCode
from centralhealth.CHMembers
where statusflag not in ('D','O')
EXCEPT
SELECT DISTINCT MemberIdentificationNumber NHLinkID,
		MemberIdentificationNumber,
		MembersDateOfBirth,
		ClientNumber,
		MemberLastName,
		MemberFirstName,
		MemberMiddleName,
		SocialSecurityNumber,
		MemberPhoneNumber,
		MemberAddressLine1,
		MemberAddressLine2,
		MemberCityName,
		MemberStateName,
		MemberZipCode,
		MemberDateOfDeath,
		MemberSex,
		MemberRace,
		MemberLanguage,
		MemberMailingAddressLine1,
		MemberMailingAddressLine2,
		MemberMailingCityName,
		MemberMailingStateName,
		MemberMailingZipCode
from centralhealth.CHStgEligData

		
		



CREATE view [centralhealth].[ViewCHInsurance] as --New Insurance or any changes
SELECT	
	 MemberIdentificationNumber NHLinkID,
	MemberIdentificationNumber,
	EligPlanNbr,
	EligibilityEffectiveDate,
	EligibilityTerminationDate,
	GroupNumber
FROM centralhealth.CHStgEligData 
where EligibilityTerminationDate > cast('20181231' as date)
EXCEPT 
SELECT 
	NHLinkID,
	MemberIdentificationNumber,
	EligPlanNbr,
	EligibilityEffectiveDate,
	EligibilityTerminationDate,
	GroupNumber
FROM centralhealth.CHInsurance
where statusflag not in ('D','O')


CREATE view centralhealth.ViewCHInsNotRcvd as
SELECT 
	 NHLinkID,
	MemberIdentificationNumber,
	EligPlanNbr,
	EligibilityEffectiveDate,
	EligibilityTerminationDate,
	GroupNumber
FROM centralhealth.CHInsurance
where statusflag not in ('D','O')
EXCEPT
SELECT	
	MemberIdentificationNumber NHLinkID,
	MemberIdentificationNumber,
	EligPlanNbr,
	EligibilityEffectiveDate,
	EligibilityTerminationDate,
	GroupNumber
FROM centralhealth.CHStgEligData 

CREATE view [data].[OrderItems] as
select 
OrderItemID,
OrderID, 
Brandcode,
FamilyCode,
StyleCode,
TechnologyLevelCode,
ProductModelCode,
ItemCode,
Modifier,
Quantity,
Amount,
Status OrderItemStatus,
UnitPrice,
PairPrice,
ItemType,
PONumber,
case ItemType when 'HA' then color when 'CROS' then isnull(lcolor,rcolor) end color,
case ItemType when 'HA' then batterySize when 'CROS' then isnull(lbatterySize,rbatterySize) end batterySize,
receiverSize,
receiverPower,
sendingImpression,
case ItemType when 'CROS' then isnull(lslimTubeSize,rslimTubeSize) end slimTubeSize
--case ItemType when 'CROS' then isnull(lplatform,rplatform) end platform Removed since its same as ModelCode
from	
 orders.orderitems oi 
  outer apply openjson(oi.ItemData) with (
		 color	varchar(100)
		,batterySize					varchar(20)
		,receiverSize				varchar(20)
		,receiverPower				varchar(100)
		,sendingImpression varchar(20)
		,lplatform				varchar(200) '$.leftEar.platform'
		,lbatterySize				varchar(200) '$.leftEar.batterySize'
		,lslimTubeSize				varchar(50) '$.leftEar.slimTubeSize'
		,lcolor					varchar(100) '$.leftEar.color'
		,rplatform				varchar(200) '$.rightEar.platform'
		,rbatterySize				varchar(200) '$.rightEar.batterySize'
		,rslimTubeSize				varchar(50) '$.rightEar.slimTubeSize'
		,rcolor					varchar(100) '$.rightEar.color'
	) as itemdata
where 1 = 1
--and itemtype = 'CROS' This is for testing purposes only


--select * From orders.orderitems where itemtype = 'EM'

CREATE view data.[OrderInfo] as
SELECT 
 o.OrderID
,( select MemberChartID from provider.MemberChartData mcd where mcd.MemberChartDataId = o.MemberChartDataId) MemberChartID
--,BrandCode
--,FamilyCode
--,StyleCode
--,TechnologyLevelCode
--,DeviceCount
,oad.memberResponsibility OrderAmount
,o.NHMemberId
,OrderType
,RefOrderID ReferenceOrderId
,Status
--,oi.ItemCode
,IsActive
,cast(DateOrderReceived as date) DateOrderReceived
,case Source when 'CRM' then cast(dateadd(hour, -4, DateOrderInitiated) as date) else DateOrderInitiated end DateOrderInitiated
,md.firstName	FirstName
,md.lastName	LastName
,md.phoneNumber  PhoneNbr
,md.dob  		DOB
,md.address		MemberAddress
,md.city		MemberCity
,md.state		MemberState
,md.zip			MemberZip
,md.insuranceCarrierName	OMDCarrierName
,md.insurancePlanName		OMDPlanName
,md.programName				OMDProgramName
,md.insuranceMemberId		OMDInsuranceNbr
,md.nhMemberId				OMDNHMemberID
,md.insuranceBenefit		OMDInsuranceBenefit
,md.benefitUsed				OMDBenefitUsed
,md.lastBenefitUsedDate		OMDLastBenefitUsedDate
,md.insCarrierId			OMDInsCarrierID
,md.insPlanId				OMDHealthPlanID
,oad.productPrice			OADProductPrice
,oad.insuranceBenefit		OADInsuranceBenefit
,oad.benefitUsed			OADBenefitUsed
,oad.adjustments			OADAdjustments
,oad.benefitAvailable		OADBenefitAvailable
,oad.memberResponsibility	OADMemberResponsibility
,oad.itemcode				OADItemCode
,oad.vsPrice				OADVSPrice
,oad.vsTechLevel			OADVSTechLevel
,ship.providerBusinessName	    SHPProviderBusinessName
,ship.dba					    SHPDBA					
,ship.dispenser				    SHPDispenser				
,ship.address				    SHPAddress				
,ship.address1				    SHPAddress1				
,ship.address2				    SHPAddress2				
,ship.city					    SHPCity					
,ship.state					    SHPState					
,ship.zip					    SHPZip					
,ship.email					    SHPEmail					
,ship.phoneNumber			    SHPPhoneNumber			
,ship.shippingInstructions	    SHPShippingInstructions
,prov.providerLeagalBusinessName    PROVProviderLegalBusinessName
,prov.dba						    PROVDBA						
,prov.dispenser					    PROVDispenser					
,prov.state						    PROVState						
,prov.zip						    PROVZip						
,prov.providerId				    PROVProviderId				
,prov.emailId					    PROVEmailId					
,prov.locationId			        PROVLocationId			
,prov.address				        PROVLocationAddress				
,prov.address1				        PROVLocationAddress1				
,prov.address2				        PROVLocationAddress2				
,prov.city					        PROVLocationCity					
,prov.state					        PROVLocationState					
,prov.zip					        PROVLocationZip					
,prov.HCPFirstName			        PROVHCPFirstName			
,prov.HCPlastName			        PROVHCPLastName			
,prov.HCPnpiNumber			        PROVHCPNPINumber			
,prov.HCPphoneNumber		        PROVHCPPhoneNumber		
,prov.HCPId					        PROVHCPId					
,prov.HCPFaxNumber			        PROVHCPFaxNumber	
From orders.orders o
outer apply openjson(case when ISJSON(o.MemberData) = 1 then o.MemberData else '{}' end) with (
		 firstName varchar(50)
		,lastName varchar(50)
		,phoneNumber varchar(20)
		,dob varchar(20)
		,address		varchar(200)	'$.address.address'
		,city		varchar(100)	'$.address.city'
		,state		varchar(100)	'$.address.state'
		,zip			varchar(20)		'$.address.zip'
		,insuranceCarrierName	varchar(300)	'$.insurance.carrierName'
		,insurancePlanName		varchar(300)	'$.insurance.planName'
		,programName			varchar(300)	'$.insurance.programeName'
		,insuranceMemberId		varchar(30)		'$.insurance.insuranceMemberId'
		,nhMemberId				varchar(20)		'$.insurance.nhMemberId'
		,insuranceBenefit		int				'$.insurance.insuranceBenefit'
		,benefitUsed			int				'$.insurance.benefitUsed'
		,lastBenefitUsedDate	varchar(300)	'$.insurance.lastBenefitUsedDate'
		,insCarrierId			int
		,insPlanId				int
	) as md
outer apply openjson(o.OrderAmountData) with (
		productPrice			decimal
		,insuranceBenefit		decimal
		,benefitUsed			decimal
		,adjustments			decimal
		,benefitAvailable		decimal
		,memberResponsibility	decimal
		,itemcode				varchar(150)
		,vsPrice				varchar(20)
		,vsTechLevel			varchar(50)
	) as oad
outer apply openjson(o.ShippingData) with (
		providerBusinessName	varchar(200)
		,dba					varchar(200)
		,dispenser				varchar(50)
		,address				varchar(200) '$.address.address'
		,address1				varchar(200) '$.address.address1'
		,address2				varchar(50) '$.address.address2'
		,city					varchar(100) '$.address.city'
		,state					varchar(10)	'$.address.state'
		,zip					varchar(10) '$.address.zip'
		,email					varchar(100)
		,phoneNumber			varchar(15)
		,shippingInstructions	varchar(400)
	) as ship
outer apply openjson(case when o.ProviderData = '' then '{}' else o.ProviderData end) with (
		providerLeagalBusinessName		varchar(200)
		,dba							varchar(200)
		,dispenser						varchar(50)
		,state							varchar(2)		'$.address.state'
		,zip							varchar(10)		'$.address.zip'
		,providerId						bigint
		,emailId				varchar(100)
		,locationId				int '$.address.locationId'
		,address				varchar(200) '$.address.address'
		,address1				varchar(200) '$.address.address1'
		,address2				varchar(50) '$.address.address2'
		,city					varchar(100) '$.address.city'
		,state					varchar(10)	'$.address.state'
		,zip					varchar(10) '$.address.zip'
		,HCPFirstName			varchar(50) '$.hcp.firstName'
		,HCPlastName			varchar(50) '$.hcp.lastName'
		,HCPnpiNumber			varchar(50) '$.hcp.npiNumber'
		,HCPphoneNumber			varchar(50) '$.hcp.phoneNumber'
		,HCPId			varchar(50) '$.hcp.hcpId'
		,HCPFaxNumber			varchar(50) '$.hcp.faxNumber'
	) as prov
Where O.IsActive = 1 
create function [dbo].[getproductmodelcode]
(
    @OrderId bigint,
	@itemcode nvarchar(50),
	@color nvarchar(30)
    
) returns nvarchar(50)
as
begin

    declare @productmodelcodeOriginal nvarchar(50) = null;
	
    declare @productmodelcode nvarchar(50) = null;
	declare @ReceiverCode nvarchar(50) = null;
    set @productmodelcode =(select top 1 VendorCode from [catalog].[ItemMasterAttributeValues] IMA
	 inner join [Orders].[OrderItems] OI on IMA.ItemCode = @itemcode 
	  and IMA.AttributeCode = 'COLOR'  and ltrim(rtrim(IMA.ModelAttributeValue)) = @color and OI.OrderId = @OrderId);
	
	set @ReceiverCode = (select top 1 VendorCode from [catalog].[ItemMasterAttributeValues] IMA
 inner join [Orders].[OrderItems] OI on IMA.Modifier = OI.Modifier and IMA.ItemCode = @itemcode
 and IMA.ItemCode = @itemcode  and IMA.attributeCode = 'RECIEVER_POWER' and ltrim(rtrim(REPLACE(ModelAttributeValue,',',''))) =  JSON_VALUE(OI.ItemData,'$.receiverPower'));
    
	if(@ReceiverCode is null)

	BEGIN
	set @ReceiverCode = (select top 1 VendorCode from [catalog].[ItemMasterAttributeValues] IMA
		inner join [Orders].[OrderItems] OI on IMA.Modifier = OI.Modifier and IMA.ItemCode = @itemcode
		and IMA.ItemCode = @itemcode  and IMA.attributeCode = 'RECIEVER_SIZES' and ltrim(rtrim(REPLACE(ModelAttributeValue,',',''))) =  JSON_VALUE(OI.ItemData,'$.receiverSize'));
	END

   set @productmodelcodeOriginal = (select ModelCode from catalog.ItemMasterList where ItemCode = @itemcode);  

	if (@productmodelcode is null) 
	BEGIN
	
	if (@ReceiverCode is not null) 
	  BEGIN
	   set @productmodelcode = @ReceiverCode;
	  END
	else
	  BEGIN

	   if(@itemcode = 'EARMOLD')
	   BEGIN
	   set @productmodelcode = 'EARMOLD';
	   END
	   ELSE

	   BEGIN
	   set @productmodelcode = @productmodelcodeOriginal;
	   END

	  END

	END

	return @productmodelcode;

end

CREATE FUNCTION [dbo].[GetShippingAmount](@BrandCode NVARCHAR(30)) RETURNS FLOAT
AS
BEGIN
DECLARE @ShippingAmount FLOAT;
SET @ShippingAmount  = (SELECT ShippingAmount FROM [catalog].[BrandShippingFees] WHERE BrandCode = @BrandCode);
RETURN @ShippingAmount;
END
CREATE FUNCTION [dbo].[GetCOGSPrice](@InsuranceCarrierID BIGINT, @InsuranceHealthPlanID BIGINT, @FamilyProductCode NVARCHAR(50)) RETURNS FLOAT
AS
BEGIN
DECLARE @COGSPrice FLOAT;
SET @COGSPrice = (SELECT PerDeviceCOGSPrice FROM [insurance].[ContractProducts] 
WHERE HealthPlanContractID IN (SELECT TOP 1 HealthPlanContractID FROM [insurance].[HealthPlanContracts] WHERE InsuranceCarrierID = @InsuranceCarrierID AND InsuranceHealthPlanID  = @InsuranceHealthPlanID) 
AND FamilyProductCode = @FamilyProductCode)
RETURN @COGSPrice;
END

CREATE FUNCTION [dbo].[fn_GetInvoiceCount](@BatchID BIGINT,@VendorType NVARCHAR(10)) RETURNS INT
AS
BEGIN
DECLARE @Counter INT;
SET @Counter  = (SELECT COUNT(*)  AS InvoiceCount FROM (SELECT distinct pp.ProviderName AS 'ProviderName',inv.InvoiceID,
JSON_VALUE(iit.[ItemData], '$.nhMemberId') AS 'NHMemberID',inv.PONumber,JSON_VALUE(iit.[ItemData], '$.orderStatus') AS 'OrderStatus',
JSON_VALUE(iit.[ItemData], '$.fittingDate') AS 'FittingDate',
JSON_VALUE(iit.[ItemData], '$.memberFirstName')  + ' ' +  JSON_VALUE(iit.[ItemData], '$.memberLastName') AS 'MemberName',
CAST(JSON_VALUE(iit.[ItemData], '$.dispensingFee') AS FLOAT) AS 'DispensingFee',CAST(InvoiceAmount AS FLOAT) AS InvoiceAmount,
cast(isnull(json_value(inv.PaymentData, '$.creditApplied'), 0) as float) AS Credit,
(InvoiceAmount - (case inv.[Status] when 'InProcess' then isnull(cast(json_value(inv.[PaymentData], '$.invoicePayment') as float), 0) when 'Paid' then isnull(cast(json_value(inv.[PaymentData], '$.invoicePayment') as float), 0) when 'Authorize' then isnull(cast(json_value(inv.[PaymentData], '$.invoicePayment') as float), 0) else 0 end) - CAST(0 AS FLOAT)) AS InvoicesSelected,BatchID
FROM [accounts].[invoices] AS inv INNER JOIN [accounts].[InvoiceItems] iit on inv.InvoiceId = iit.InvoiceId
INNER  JOIN (SELECT * FROM accounts.InvoiceTransactions AS it WHERE it.[Status]='Approval' AND it.IsActive=1) AS invt
ON inv.InvoiceId = invt.InvoiceId INNER JOIN provider.providerprofiles AS pp ON inv.ProviderId = pp.ProviderId	
WHERE (inv.VendorType=@VendorType) AND inv.[Status]='Approval' AND inv.ProviderId IS NOT NULL AND inv.BatchID = @BatchID) r)
RETURN @Counter
END


CREATE FUNCTION [dbo].[fn_GetInvoiceAmount](@BatchID BIGINT,@VendorType NVARCHAR(10)) RETURNS FLOAT
AS
BEGIN
DECLARE @Counter FLOAT;
SET @Counter  = (SELECT SUM(InvoiceAmount) FROM (SELECT distinct pp.ProviderName AS 'ProviderName',inv.InvoiceID,
JSON_VALUE(iit.[ItemData], '$.nhMemberId') AS 'NHMemberID',inv.PONumber,JSON_VALUE(iit.[ItemData], '$.orderStatus') AS 'OrderStatus',
JSON_VALUE(iit.[ItemData], '$.fittingDate') AS 'FittingDate',
JSON_VALUE(iit.[ItemData], '$.memberFirstName')  + ' ' +  JSON_VALUE(iit.[ItemData], '$.memberLastName') AS 'MemberName',
CAST(JSON_VALUE(iit.[ItemData], '$.dispensingFee') AS FLOAT) AS 'DispensingFee',CAST(InvoiceAmount AS FLOAT) AS InvoiceAmount,
cast(isnull(json_value(inv.PaymentData, '$.creditApplied'), 0) as float) AS Credit,
(InvoiceAmount - (case inv.[Status] when 'InProcess' then isnull(cast(json_value(inv.[PaymentData], '$.invoicePayment') as float), 0) when 'Paid' then isnull(cast(json_value(inv.[PaymentData], '$.invoicePayment') as float), 0) when 'Authorize' then isnull(cast(json_value(inv.[PaymentData], '$.invoicePayment') as float), 0) else 0 end) - CAST(0 AS FLOAT)) AS InvoicesSelected,BatchID
FROM [accounts].[invoices] AS inv INNER JOIN [accounts].[InvoiceItems] iit on inv.InvoiceId = iit.InvoiceId
INNER  JOIN (SELECT * FROM accounts.InvoiceTransactions AS it WHERE it.[Status]='Approval' AND it.IsActive=1) AS invt
ON inv.InvoiceId = invt.InvoiceId INNER JOIN provider.providerprofiles AS pp ON inv.ProviderId = pp.ProviderId	
WHERE (inv.VendorType=@VendorType) AND inv.[Status]='Approval' AND inv.ProviderId IS NOT NULL AND inv.BatchID = @BatchID) r)
RETURN @Counter
END
create function [dbo].[getPriceTypeofItem]
(
    @PODate date,
	@itemcode nvarchar(50),
	@IsMedicaid int,
	@InsuranceCarrierName nvarchar(50)
    
) returns nvarchar(50)
as
BEGIN

   Declare @UnitPrice as nvarchar(50);
   
   Declare @PriceType as nvarchar(50);

    set @UnitPrice = cast( (select top (1) [UnitCOGS] from [catalog].[ItemMasterPriceList] where [EffectiveFrom]<= @PODate and [EffectiveTo] > @PODate and IsActive=1 and ItemCode=@itemcode
   and PriceType =	case when @IsMedicaid=1 then 'Medicaid' 
                    when (@InsuranceCarrierName like 'Anthem%' and @InsuranceCarrierName like '%Funded%') then 'Anthem' 
			        else 'Standard' end) as nvarchar)
 
  set @PriceType = (select top 1 (case when @IsMedicaid=1 then 'Medicaid'  when (@InsuranceCarrierName like 'Anthem%' and @InsuranceCarrierName like '%Funded%') then 'Anthem' 
			        else 'Standard' end) as nvarchar from [catalog].[ItemMasterPriceList] where [EffectiveFrom]<= @PODate and [EffectiveTo] > @PODate and IsActive=1 and ItemCode=@itemcode);
  
	
	if ((@UnitPrice is null) OR (@UnitPrice = '')) 
		BEGIN
        
	    set @PriceType = (select top 1 'Anthem' from [catalog].[ItemMasterPriceList] )

			if ((@UnitPrice is null) OR (@UnitPrice = '')) 
			BEGIN
        
			set @PriceType = (select top 1 'Standard' from [catalog].[ItemMasterPriceList])



			END

		END



   return @PriceType;
	

END

CREATE function [dbo].[getunitPriceofItem]
(
    @PODate date,
	@itemcode nvarchar(50),
	@IsMedicaid int,
	@InsuranceCarrierName nvarchar(50)
    
) returns nvarchar(50)
as
BEGIN

   Declare @UnitPrice as nvarchar(50);

   Declare @BrandCode as nvarchar(50);

   set @BrandCode = (select top 1 BrandCode from catalog.ItemMasterList where ItemCode = @itemcode);

   if (lTRIM(RTRIM(@BrandCode)) = 'STARKEY')

   BEGIN
   set @UnitPrice = (select top 1 [UnitCOGS] from [catalog].[ItemMasterPriceList] where [EffectiveFrom]<= @PODate and [EffectiveTo] > @PODate and IsActive=1 and ItemCode=@itemcode and PriceType = 'Standard')

   END

   ELSE

   BEGIN

	   set @UnitPrice = cast( (select top (1) [UnitCOGS] from [catalog].[ItemMasterPriceList] where [EffectiveFrom]<= @PODate and [EffectiveTo] > @PODate and IsActive=1 and ItemCode=@itemcode
					   and PriceType =	case when @IsMedicaid=1 then 'Medicaid' 
											 when (@InsuranceCarrierName like 'Anthem%' and @InsuranceCarrierName like '%Funded%') then 'Anthem' 
											 else 'Standard' end) as nvarchar)
		if ((@UnitPrice is null) OR (@UnitPrice = '')) 
			BEGIN
			set @UnitPrice = (select top 1 [UnitCOGS] from [catalog].[ItemMasterPriceList] where [EffectiveFrom]<= @PODate and [EffectiveTo] > @PODate and IsActive=1 and ItemCode=@itemcode and PriceType = 'Anthem')
				if ((@UnitPrice is null) OR (@UnitPrice = '')) 
				BEGIN
				   set @UnitPrice = (select top 1 [UnitCOGS] from [catalog].[ItemMasterPriceList] where [EffectiveFrom]<= @PODate and [EffectiveTo] > @PODate and IsActive=1 and ItemCode=@itemcode and PriceType = 'Standard')
				END
			END

    END

   return @UnitPrice;
	

END

CREATE function [dbo].[getunitPriceofItem]
(
    @PODate date,
	@itemcode nvarchar(50),
	@IsMedicaid int,
	@InsuranceCarrierName nvarchar(50)
    
) returns nvarchar(50)
as
BEGIN

   Declare @UnitPrice as nvarchar(50);
   Declare @AnthemUnitPrice as nvarchar(50);
   Declare @MedicaidUnitPrice as nvarchar(50);
   Declare @StandardUnitPrice as nvarchar(50);
   Declare @MedicaidPerson as varchar(10);
   Declare @StandardPerson as varchar(10);
   Declare @AnthemPerson as varchar(10);
   Declare @AnthemandMedicaidPerson as varchar(10);
 
   Declare @AnthemUnitPricefinal as DECIMAL(18,2);
   Declare @MedicaidUnitPricefinal as DECIMAL(18,2);
   Declare @StandardUnitPricefinal as DECIMAL(18,2);

   set @MedicaidPerson = 'NO';
   set @StandardPerson = 'NO';
   set @AnthemPerson = 'NO';
   set @AnthemandMedicaidPerson = 'NO';
 




   Declare @BrandCode as nvarchar(50);

   set @BrandCode = (select top 1 BrandCode from catalog.ItemMasterList where ItemCode = @itemcode);

   if (lTRIM(RTRIM(@BrandCode)) = 'STARKEY')

   BEGIN
   set @UnitPrice = (select top 1 [UnitCOGS] from [catalog].[ItemMasterPriceList] where [EffectiveFrom]<= @PODate and [EffectiveTo] > @PODate and IsActive=1 and ItemCode=@itemcode and PriceType = 'Standard')
   return @UnitPrice;
   END
   ELSE   if ((lTRIM(RTRIM(@BrandCode)) = 'SONOVA') OR (lTRIM(RTRIM(@BrandCode)) = 'PHONAK') OR (lTRIM(RTRIM(@BrandCode)) = 'UNITRON') )

   BEGIN
   set @UnitPrice = (select top 1 [UnitCOGS] from [catalog].[ItemMasterPriceList] where [EffectiveFrom]<= @PODate and [EffectiveTo] > @PODate and IsActive=1 and ItemCode=@itemcode and PriceType = 'Standard')
   return @UnitPrice;
   END
   ELSE

   BEGIN
   


   set @AnthemUnitPrice = (select top 1 [UnitCOGS] from [catalog].[ItemMasterPriceList] where [EffectiveFrom]<= @PODate and [EffectiveTo] > @PODate and IsActive=1 and ItemCode=@itemcode and PriceType = 'Anthem')
   set @StandardUnitPrice = (select top 1 [UnitCOGS] from [catalog].[ItemMasterPriceList] where [EffectiveFrom]<= @PODate and [EffectiveTo] > @PODate and IsActive=1 and ItemCode=@itemcode and PriceType = 'Standard')
   set @MedicaidUnitPrice = (select top 1 [UnitCOGS] from [catalog].[ItemMasterPriceList] where [EffectiveFrom]<= @PODate and [EffectiveTo] > @PODate and IsActive=1 and ItemCode=@itemcode and PriceType = 'Medicaid')



	   if(@IsMedicaid=1)
		BEGIN
		set @MedicaidPerson = 'YES';
		END


	    set @AnthemPerson =	(case when (@InsuranceCarrierName like 'Anthem%' and @InsuranceCarrierName like '%Funded%') then 'YES'  else 'NO' end) ;


		  if((@MedicaidPerson = 'YES') AND (@AnthemPerson = 'YES'))
		   BEGIN
			set @AnthemandMedicaidPerson = 'NO';
			set @AnthemPerson = 'NO';

		   END

	   if ((@MedicaidUnitPrice is not null) AND (@MedicaidUnitPrice <> '')) 
			BEGIN
	          set @MedicaidUnitPricefinal = (Select CONVERT(DECIMAL(18,2),replace(@MedicaidUnitPrice, ',', '')) );
	        END

       if ((@AnthemUnitPrice is not null) AND (@AnthemUnitPrice <> '')) 
			BEGIN
	          set @AnthemUnitPricefinal = (Select CONVERT(DECIMAL(18,2),replace(@AnthemUnitPrice, ',', '')) );
	        END

	   if ((@StandardUnitPrice is not null) AND (@StandardUnitPrice <> '')) 
			BEGIN
	          set @StandardUnitPricefinal = (Select CONVERT(DECIMAL(18,2),replace(@StandardUnitPrice, ',', '')) );
	        END
	  

	    if(@AnthemandMedicaidPerson = 'YES')
			BEGIN
			DECLARE @temporartytable TABLE
			(
			  ID int
			  
			);
			   if ((@AnthemUnitPrice is not null) AND (@AnthemUnitPrice <> '') AND (@MedicaidUnitPrice is not null) AND (@MedicaidUnitPrice <> '') AND (@StandardUnitPrice is not null) AND (@StandardUnitPrice <> '')) 
			      BEGIN

				     Declare @MinofAnthemandMedicaid as DECIMAL(18,2);
					 Declare @MinimumofAnthemMedicaidandStandard as DECIMAL(18,2);
				    
					 set @MinofAnthemandMedicaid =  (select case when @AnthemUnitPricefinal > @MedicaidUnitPricefinal then @MedicaidUnitPricefinal else @AnthemUnitPricefinal end );

					 set @MinimumofAnthemMedicaidandStandard = (select case when @MinofAnthemandMedicaid > @StandardUnitPricefinal then @StandardUnitPricefinal else @MinofAnthemandMedicaid end );

					set @UnitPrice = (select case when @MinofAnthemandMedicaid > @MinimumofAnthemMedicaidandStandard then @MinimumofAnthemMedicaidandStandard else @MinofAnthemandMedicaid end );
					--set @UnitPrice = (select min(@AnthemUnitPricefinal,@StandardUnitPricefinal,@MedicaidUnitPricefinal);

				  END
			  ELSE if((@AnthemUnitPrice is null OR @AnthemUnitPrice = '') AND (@MedicaidUnitPrice is not null AND @MedicaidUnitPrice <> '' AND @StandardUnitPrice is not null AND @StandardUnitPrice <> ''))
		          BEGIN

				   Declare @MinimumofMedicaidandStandard as DECIMAL(18,2);
				   set @MinimumofMedicaidandStandard = (select case when @MedicaidUnitPricefinal > @StandardUnitPricefinal then @StandardUnitPricefinal else @MedicaidUnitPricefinal end );

				   set @UnitPrice = @MinimumofMedicaidandStandard;
				  END
              ELSE if((@AnthemUnitPrice is not null AND @AnthemUnitPrice <> '') AND (@MedicaidUnitPrice is null OR @MedicaidUnitPrice = '') AND (@StandardUnitPrice is not null AND @StandardUnitPrice <> ''))
		          BEGIN

				   Declare @MinimumofAnthemandStandard as DECIMAL(18,2);
				   set @MinimumofAnthemandStandard = (select case when @AnthemUnitPricefinal > @StandardUnitPricefinal then @StandardUnitPricefinal else @AnthemUnitPricefinal end );

				   set @UnitPrice = @MinimumofAnthemandStandard;
				  END
			  ELSE if((@AnthemUnitPrice is  null OR @AnthemUnitPrice = '') AND (@MedicaidUnitPrice is null OR @MedicaidUnitPrice = '') AND (@StandardUnitPrice is not null AND @StandardUnitPrice <> ''))
		          BEGIN

				   set @UnitPrice = @StandardUnitPricefinal;
				  END
              ELSE if((@AnthemUnitPrice is not null AND @AnthemUnitPrice <> '') AND (@MedicaidUnitPrice is null OR @MedicaidUnitPrice = '') AND (@StandardUnitPrice is null OR @StandardUnitPrice = ''))
		          BEGIN

				   set @UnitPrice = @AnthemUnitPricefinal;
				  END
			  ELSE if((@AnthemUnitPrice is  null OR @AnthemUnitPrice = '') AND (@MedicaidUnitPrice is not null ANd @MedicaidUnitPrice <> '') AND (@StandardUnitPrice is null OR @StandardUnitPrice = ''))
		          BEGIN

				   set @UnitPrice = @MedicaidUnitPricefinal;
				  END
			  ELSE if((@AnthemUnitPrice is not null AND @AnthemUnitPrice <> '') AND (@MedicaidUnitPrice is not null AND @MedicaidUnitPrice <> '') AND (@StandardUnitPrice is null OR @StandardUnitPrice = ''))
		          BEGIN
				     Declare @MinofAnthemandMedicaid1 as DECIMAL(18,2);
					 set @MinofAnthemandMedicaid1 =  (select case when @AnthemUnitPricefinal > @MedicaidUnitPricefinal then @MedicaidUnitPricefinal else @AnthemUnitPricefinal end );
					 set @UnitPrice  = @MinofAnthemandMedicaid1;
				  END
			  ELSE if((@AnthemUnitPrice is null OR @AnthemUnitPrice = '') AND (@MedicaidUnitPrice is  null OR @MedicaidUnitPrice = '') AND (@StandardUnitPrice is  null OR @StandardUnitPrice = ''))
		          BEGIN
				    
					 set @UnitPrice  = NULL;
				  END

				  return @UnitPrice;
			END


		 if((@MedicaidPerson = 'YES') AND (@AnthemPerson = 'NO'))
		   BEGIN
		       if((@MedicaidUnitPrice is not null AND @MedicaidUnitPrice <> '') AND (@StandardUnitPrice is not null AND @StandardUnitPrice <> ''))
		          BEGIN
				     Declare @MinimumofMedicaidandStandard1 as DECIMAL(18,2);
				     set @MinimumofMedicaidandStandard1 = (select case when @MedicaidUnitPricefinal > @StandardUnitPricefinal then @StandardUnitPricefinal else @MedicaidUnitPricefinal end );

				     set @UnitPrice = @MinimumofMedicaidandStandard1;
				  END
			   else if((@MedicaidUnitPrice is null OR @MedicaidUnitPrice = '') AND (@StandardUnitPrice is not null ANd @StandardUnitPrice <> ''))
				   BEGIN
				   set @UnitPrice = @StandardUnitPricefinal;
				   END
			   else if((@MedicaidUnitPrice is null OR @MedicaidUnitPrice = '') AND (@StandardUnitPrice is  null OR @StandardUnitPrice = ''))
				   BEGIN
				   set @UnitPrice = NULL;
				   END
			  else if((@MedicaidUnitPrice is not null and  @MedicaidUnitPrice <> '') AND (@StandardUnitPrice is  null OR @StandardUnitPrice = ''))
				   BEGIN
				   set @UnitPrice = @MedicaidUnitPricefinal;
				   END

			   return @UnitPrice;

		   END
	  if((@MedicaidPerson = 'NO') AND (@AnthemPerson = 'YES'))
		   BEGIN

		   if((@AnthemUnitPrice is not null AND @AnthemUnitPrice <> '') AND (@StandardUnitPrice is not null AND @StandardUnitPrice <> ''))
		          BEGIN

				   Declare @MinimumofAnthemandStandard1 as DECIMAL(18,2);
				   set @MinimumofAnthemandStandard1 = (select case when @AnthemUnitPricefinal > @StandardUnitPricefinal then @StandardUnitPricefinal else @AnthemUnitPricefinal end );

				   set @UnitPrice = @MinimumofAnthemandStandard1;
				  END
			else if((@AnthemUnitPrice is null OR @AnthemUnitPrice = '') AND (@StandardUnitPrice is not null AND @StandardUnitPrice <> ''))
		          BEGIN
				  				  
				   set @UnitPrice = @StandardUnitPricefinal;
				  END
             else if((@AnthemUnitPrice is null OR @AnthemUnitPrice = '') AND (@StandardUnitPrice is  null OR @StandardUnitPrice = ''))
				   BEGIN
				   set @UnitPrice = NULL;
				   END
             else if((@AnthemUnitPrice is not null and @AnthemUnitPrice <> '') AND (@StandardUnitPrice is  null OR @StandardUnitPrice = ''))
				   BEGIN
				   set @UnitPrice = @AnthemUnitPricefinal;
				   END
				   return @UnitPrice;
       
		   END

		    if((@MedicaidPerson = 'NO') AND (@AnthemPerson = 'NO'))
			   BEGIN
			    if(@StandardUnitPrice is not null and @StandardUnitPrice <> '')
					   BEGIN
					   set @UnitPrice = @StandardUnitPricefinal;
					   END
				else if(@StandardUnitPrice is null OR @StandardUnitPrice = '')
					   BEGIN
					   set @UnitPrice = NULL;
					   END
					  
					return @UnitPrice;
			   END




    END

   return @UnitPrice;
	
	
END


--select top 10 * from accounts.Invoices order by createdate desc
--select top 10 * from orders.OrderTransactionDetails order by createdate desc


--select top 10 * from accounts.Invoiceexceptions order by createdate desc

--select * from Orders.OrderPOs where OrderID = 190002454
CREATE function [dbo].[getTotalInvoiceAmount]
(
    @Quantity int = 0,
    @PODate date,
	@itemcode nvarchar(50),
	@IsMedicaid int,
	@InsuranceCarrierName nvarchar(50)
    
) returns nvarchar(50)
as
BEGIN

   Declare @UnitPrice as decimal(19,4);

   set @UnitPrice = cast( (select top (1) [UnitCOGS] from [catalog].[ItemMasterPriceList] where [EffectiveFrom]<= @PODate and [EffectiveTo] > @PODate and IsActive=1 and ItemCode=@itemcode
   and PriceType =	case when @IsMedicaid=1 then 'Medicaid' 
                    when (@InsuranceCarrierName like 'Anthem%' and @InsuranceCarrierName like '%Funded%') then 'AnthemPrice' 
			        else 'Standard' end) as decimal(19,4))

	
	if ((@UnitPrice is null)) 
		BEGIN
        
	    set @UnitPrice = (select top 1 [UnitCOGS] from [catalog].[ItemMasterPriceList] where [EffectiveFrom]<= @PODate and [EffectiveTo] > @PODate and IsActive=1 and ItemCode=@itemcode and PriceType = 'AnthemPrice')

			if ((@UnitPrice is null)) 
			BEGIN
        
			set @UnitPrice = (select top 1 [UnitCOGS] from [catalog].[ItemMasterPriceList] where [EffectiveFrom]<= @PODate and [EffectiveTo] > @PODate and IsActive=1 and ItemCode=@itemcode and PriceType = 'Standard')



			END

		END


		if((@UnitPrice is null))
		BEGIN
		set @UnitPrice = 0.00;

		END

		if(@Quantity is null)
		BEGIN
		 set @Quantity = 0;
		END
		
		
		    set @UnitPrice = @UnitPrice * @Quantity;
		

   return cast( @UnitPrice as nvarchar(50));
	

END

CREATE FUNCTION [dbo].[InitCap] ( @InputString varchar(4000) ) 
RETURNS VARCHAR(4000)
AS
BEGIN

DECLARE @Index          INT
DECLARE @Char           CHAR(1)
DECLARE @PrevChar       CHAR(1)
DECLARE @OutputString   VARCHAR(255)

SET @OutputString = LOWER(@InputString)
SET @Index = 1

WHILE @Index <= LEN(@InputString)
BEGIN
    SET @Char     = SUBSTRING(@InputString, @Index, 1)
    SET @PrevChar = CASE WHEN @Index = 1 THEN ' '
                         ELSE SUBSTRING(@InputString, @Index - 1, 1)
                    END

    IF @PrevChar IN (' ', ';', ':', '!', '?', ',', '.', '_', '-', '/', '&', '''', '(')
    BEGIN
        IF @PrevChar != '''' OR UPPER(@Char) != 'S'
            SET @OutputString = STUFF(@OutputString, @Index, 1, UPPER(@Char))
    END

    SET @Index = @Index + 1
END

RETURN @OutputString

END

CREATE FUNCTION [dbo].[fn_extract_numbers_Only](@string VARCHAR(2000))
RETURNS VARCHAR(2000)
    AS

    BEGIN
        DECLARE @count int
        DECLARE @intNumbers VARCHAR(1000)
        SET @count = 0
        SET @intNumbers = ''

        WHILE @count <= LEN(@string)
        BEGIN 
            IF SUBSTRING(@string, @count, 1)>='0' and SUBSTRING (@string, @count, 1) <='9'
                BEGIN
                    SET @intNumbers = @intNumbers + SUBSTRING (@string, @count, 1)
                END
            SET @count = @count + 1
        END
        RETURN @intNumbers
    END
-- =====================================================================================================
-- SELECT * FROM [Insurance].[InsuranceHealthPlans]
-- EXEC InsertorUpdateInsHealthPlans 20, 'Scripts', 'Anthem MediBlue Access (PPO', 'NULL', 6, 1, 'Scripts', 0
-- =====================================================================================================
CREATE Procedure [dbo].[InsertorUpdateInsHealthPlans_BM]
	-- Add the parameters for the stored procedure here	 
				 @action NVARCHAR(5),
				 @insuranceHealthPlanID bigint = 0,				
				 @createSource NVARCHAR(150), 				 
				 @healthPlanName NVARCHAR(50), 
				 @healthPlanNumber NVARCHAR(100) = null, 
				 @insuranceCarrierID BIGINT,
				 @isActive BIT,
				 @modifySource NVARCHAR(150) = null,
				 @isDiscountProgram BIT
				 				
AS
BEGIN
	-- SET NOCOUNT ON added to prevent extra result sets from
	-- interfering with SELECT statements.
	SET NOCOUNT ON;
    -- Insert statements for procedure here
	IF @action = 'N'
	  BEGIN
		if not exists (SELECT 1 FROM [Insurance].[InsuranceHealthPlans])
			BEGIN
				DBCC CHECKIDENT ('[Insurance].[InsuranceHealthPlans]', RESEED, 1) 
			END
		 INSERT INTO [Insurance].[InsuranceHealthPlans] 
					 (CreateDate, 
					  CreateUser, 
					  HealthPlanName, 
					  HealthPlanNumber, 
					  InsuranceCarrierID, 
					  IsActive, 
					  ModifyDate, 
					  ModifyUser,
					  IsDiscountProgram) 
		 VALUES		 (getdate(),
					  @createSource, 
					  @healthPlanName, 
					  @healthPlanNumber, 
					  @insuranceCarrierID, 
					  @isActive, 
					  getdate(),			
					  @modifySource,
					  @isDiscountProgram) 
    END
	ELSE if  @action = 'R'--exists (SELECT 1 FROM [Insurance].[InsuranceHealthPlans]  WHERE HealthPlanName = @healthPlanName and InsuranceCarrierID = @insuranceCarrierID)
		BEGIN
			UPDATE  [Insurance].[InsuranceHealthPlans] 
				SET		HealthPlanName = @healthPlanName,
						HealthPlanNumber = @healthPlanNumber,				 
						InsuranceCarrierID= @insuranceCarrierID,
						IsActive = @isActive,
						ModifyDate = getdate(), 
						ModifyUser = @modifySource,
						IsDiscountProgram = @isDiscountProgram
				WHERE   InsuranceHealthPlanID = @insuranceHealthPlanID
	   END
 ELSE if  @action = 'D' 
	BEGIN
	  UPDATE  [Insurance].[InsuranceHealthPlans]  
	     SET IsActive=0  WHERE   InsuranceHealthPlanID = @insuranceHealthPlanID   
	END 
END
-- =====================================================================================================
--SELECT * FROM [Insurance].[ContractProducts] 
--EXEC InsertorUpdateInsHealthPlanContractProducts 1, 'GNR',  'Scripts', 'Prem', null, 'RS Trust 17', 53, null, 1,  'Scripts', 1008, 600, 2250
-- =====================================================================================================
CREATE Procedure [dbo].[InsertorUpdateInsHealthPlanContractProducts_BM]
	-- Add the parameters for the stored procedure here
				@action NVARCHAR(5),
				@contractProductID	BIGINT =0,
				@brandCode	NVARCHAR(30) = NULL,				
				@CreateUser	NVARCHAR(150) = NULL,
				@familyProductCatCode	NVARCHAR(50)= NULL,
				@familyProductCategoryFamilyProductID	BIGINT = NULL,
				@familyProductCode	NVARCHAR(50) = NULL,
				@healthPlanContractID	INT,
				@healthPlanContractID1	BIGINT,
				@isActive	BIT,				
				@modifyUser	NVARCHAR(150) = NULL,
				@perDeviceCOGSPrice	FLOAT,
				@perDeviceDispensingFee	FLOAT,
				@perDeviceMemberPrice	FLOAT
					 				
AS
BEGIN
	-- SET NOCOUNT ON added to prevent extra result sets from
	-- interfering with SELECT statements.
	SET NOCOUNT ON;
    -- Insert statements for procedure here
IF @action = 'N'
  BEGIN
	if not exists (SELECT 1 FROM [Insurance].[ContractProducts])
	BEGIN
		DBCC CHECKIDENT ('[Insurance].[ContractProducts]', RESEED, 1) 
	END	
  INSERT INTO  [Insurance].[ContractProducts]  
				 (					
					BrandCode,
					CreateDate,
					CreateUser,
					FamilyProductCatCode,
					FamilyProductCategoryFamilyProductID,
					FamilyProductCode,
					HealthPlanContractID,
					HealthPlanContractID1,
					IsActive,
					ModifyDate,
					ModifyUser,
					PerDeviceCOGSPrice,
					PerDeviceDispensingFee,
					PerDeviceMemberPrice
				)
	Values		(
				@brandCode,
				getdate(),
				@CreateUser,
				@familyProductCatCode,
				@familyProductCategoryFamilyProductID,
				UPPER(@familyProductCode),
				@healthPlanContractID,
				@healthPlanContractID1,
				@isActive,
				getdate(),
				@modifyUser,
				@perDeviceCOGSPrice,
				@perDeviceDispensingFee,
				@perDeviceMemberPrice
				) 
	END	
	ELSE if  @action = 'R' --if exists (SELECT 1 FROM [Insurance].[ContractProducts]  WHERE ContractProductID = @contractProductID and FamilyProductCatCode = @familyProductCatCode and FamilyProductCode = @familyProductCode and HealthPlanContractID = @healthPlanContractID)
	BEGIN
		UPDATE  [Insurance].[ContractProducts] 
		SET		    BrandCode = @brandCode,		
					FamilyProductCatCode = @familyProductCatCode,
					FamilyProductCategoryFamilyProductID = @familyProductCategoryFamilyProductID,
					FamilyProductCode = UPPER(@familyProductCode),
					HealthPlanContractID = @healthPlanContractID,
					HealthPlanContractID1 = @healthPlanContractID1,
					IsActive = @isActive,
					ModifyDate = getdate(),
					ModifyUser = @modifyUser,
					PerDeviceCOGSPrice =@perDeviceCOGSPrice ,
					PerDeviceDispensingFee = @perDeviceDispensingFee,
					PerDeviceMemberPrice = @perDeviceMemberPrice			
		WHERE   ContractProductID	= @contractProductID
	END
	ELSE if  @action = 'D' 
	BEGIN
	  UPDATE  [Insurance].[ContractProducts]   
	     SET IsActive=0  WHERE  ContractProductID	= @contractProductID  
	END
END

CREATE PROCEDURE [dbo].[sp_GetInsurancehistoryUpdates]    
(    
 @MemberProfileID     BIGINT = 0    
)    
AS    
BEGIN    
 SET NOCOUNT ON;    
  SELECT ROW_NUMBER() OVER (ORDER BY InsuranceCarrierName) RowID,  
  [Status],InsuranceCarrierName,HealthPlanName,NHMemberId,InsuranceEffectiveDate,InsuranceEndDate,ModifyDate,ModifyUser,CreateDate FROM   
		(SELECT CASE WHEN mi.InsuranceEndDate >= GETDATE() 
		THEN 'Active' ELSE 'Inactive' END AS [Status],
		ic.InsuranceCarrierName,hp.HealthPlanName,mp.NHMemberId,    
			mi.InsuranceEffectiveDate,mi.InsuranceEndDate,mi.ModifyDate,mi.ModifyUser,mi.CreateDate  
   FROM [provider].[MemberInsurances_History] mi INNER JOIN [provider].[MemberProfiles] mp ON mp.MemberProfileID = mi.MemberProfileId AND mi.IsActive = 1          
 INNER JOIN [Insurance].[InsuranceCarriers] ic ON mi.InsuranceCarrierID = ic.InsuranceCarrierID AND ic.IsActive =1      
 INNER JOIN [Insurance].[InsuranceHealthPlans] hp ON mi.InsuranceHealthPlanID = hp.InsuranceHealthPlanID  AND hp.IsActive = 1 WHERE mp.MemberProfileID = @MemberProfileID)tmp 
 WHERE tmp.InsuranceCarrierName <> 'None' ORDER BY RowID   
 END  

	CREATE Procedure [dbo].[sp_helpdiagramdefinition]
	(
		@diagramname 	sysname,
		@owner_id	int	= null 		
	)
	WITH EXECUTE AS N'dbo'
	AS
	BEGIN
		set nocount on

		declare @theId 		int
		declare @IsDbo 		int
		declare @DiagId		int
		declare @UIDFound	int
	
		if(@diagramname is null)
		begin
			RAISERROR (N'E_INVALIDARG', 16, 1);
			return -1
		end
	
		execute as caller;
		select @theId = DATABASE_PRINCIPAL_ID();
		select @IsDbo = IS_MEMBER(N'db_owner');
		if(@owner_id is null)
			select @owner_id = @theId;
		revert; 
	
		select @DiagId = diagram_id, @UIDFound = principal_id from dbo.sysdiagrams where principal_id = @owner_id and name = @diagramname;
		if(@DiagId IS NULL or (@IsDbo = 0 and @UIDFound <> @theId ))
		begin
			RAISERROR ('Diagram does not exist or you do not have permission.', 16, 1);
			return -3
		end

		select version, definition FROM dbo.sysdiagrams where diagram_id = @DiagId ; 
		return 0
	END
	

-- EXEC [dbo].[sp_rpt_qb_ff_payment_checks_remittance]

CREATE procedure [dbo].[sp_rpt_qb_ff_payment_checks_remittance] 
@BatchId bigint,
@CheckNumber bigint
as
select IP.*,  cp.PONumber, cp.paymentMethod,cp.paymentDate,cp.checkNum
from (

select 
d.InvoiceBatchId
,p.providerid
,p.vendorName
,p.paymentAmount
--,CAST(p.paymentDate AS DATE) paymentDate
,i.invoiceId
,CAST(i.date AS DATE) FittingDate
,i.reference
,i.originalAmount
,i.payment
,NULL as BalanceDue
,NULL as Discount
,'Bill' Type
from paymentgateway.invoicedata d
outer apply openjson(d.invoicecheckdata) with (
       checks nvarchar(max) as json
) f
outer apply openjson(f.checks) with(
       providerId bigint,
       vendorName varchar(200),
       paymentAmount decimal(10,2),
       paymentDate varchar(50),
       invoices nvarchar(max) as json
) p
outer apply openjson(p.invoices) with(
       invoiceId bigint,
       date varchar(50),
       reference varchar(100),
       originalAmount decimal(10,2),
       payment decimal(10,2)
) i
) IP

left JOIN
(
select 
i.InvoiceId, 
i.PONumber
--, i.InvoiceAmount
--, JSON_VALUE(i.PaymentData,'$.invoicePayment') invoicePayment
, JSON_VALUE(i.PaymentData,'$.paymentMethod') paymentMethod
, i.BatchId
, JSON_VALUE(i.PaymentData,'$.payData.paymentDate') paymentDate,
cast(JSON_VALUE(i.PaymentData,'$.payData.checkNum') as bigint) checkNum
from accounts.Invoices i
where 1=1
and i.Status='Paid'
and BatchId is not null
) CP ON (CP.InvoiceId=IP.invoiceId AND CP.BatchId=IP.InvoiceBatchId)
where 1=1
and IP.InvoiceBatchId=@BatchId
and cp.checkNum=@CheckNumber

	CREATE Procedure [dbo].[sp_helpdiagrams]
	(
		@diagramname sysname = NULL,
		@owner_id int = NULL
	)
	WITH EXECUTE AS N'dbo'
	AS
	BEGIN
		DECLARE @user sysname
		DECLARE @dboLogin bit
		EXECUTE AS CALLER;
			SET @user = USER_NAME();
			SET @dboLogin = CONVERT(bit,IS_MEMBER('db_owner'));
		REVERT;
		SELECT
			[Database] = DB_NAME(),
			[Name] = name,
			[ID] = diagram_id,
			[Owner] = USER_NAME(principal_id),
			[OwnerID] = principal_id
		FROM
			sysdiagrams
		WHERE
			(@dboLogin = 1 OR USER_NAME(principal_id) = @user) AND
			(@diagramname IS NULL OR name = @diagramname) AND
			(@owner_id IS NULL OR principal_id = @owner_id)
		ORDER BY
			4, 5, 1
	END
	

	CREATE Procedure [dbo].[sp_dropdiagram]
	(
		@diagramname 	sysname,
		@owner_id	int	= null
	)
	WITH EXECUTE AS 'dbo'
	AS
	BEGIN
		set nocount on
		declare @theId 			int
		declare @IsDbo 			int
		
		declare @UIDFound 		int
		declare @DiagId			int
	
		if(@diagramname is null)
		begin
			RAISERROR ('Invalid value', 16, 1);
			return -1
		end
	
		EXECUTE AS CALLER;
		select @theId = DATABASE_PRINCIPAL_ID();
		select @IsDbo = IS_MEMBER(N'db_owner'); 
		if(@owner_id is null)
			select @owner_id = @theId;
		REVERT; 
		
		select @DiagId = diagram_id, @UIDFound = principal_id from dbo.sysdiagrams where principal_id = @owner_id and name = @diagramname 
		if(@DiagId IS NULL or (@IsDbo = 0 and @UIDFound <> @theId))
		begin
			RAISERROR ('Diagram does not exist or you do not have permission.', 16, 1)
			return -3
		end
	
		delete from dbo.sysdiagrams where diagram_id = @DiagId;
	
		return 0;
	END
	
CREATE Procedure [dbo].[sp_generate_insertscripts]
(
    @TABLENAME VARCHAR(MAX),
    @FILTER_CONDITION VARCHAR(MAX)=''
)
AS
BEGIN

SET NOCOUNT ON

DECLARE @TABLE_NAME VARCHAR(MAX),
        @CSV_COLUMN VARCHAR(MAX),
        @QUOTED_DATA VARCHAR(MAX),
        @TEXT VARCHAR(MAX),
        @FILTER VARCHAR(MAX) 

SET @TABLE_NAME=@TABLENAME

SELECT @FILTER=@FILTER_CONDITION

SELECT @CSV_COLUMN=STUFF
(
    (
     SELECT ',['+ NAME +']' FROM sys.all_columns 
     WHERE OBJECT_ID=OBJECT_ID(@TABLE_NAME) --AND 
     --is_identity!=1 
	 FOR XML PATH('')
    ),1,1,''
)

SELECT @QUOTED_DATA=STUFF
(
    (
     SELECT ' ISNULL(QUOTENAME('+NAME+','+QUOTENAME('''','''''')+'),'+'''NULL'''+')+'','''+'+' FROM sys.all_columns 
     WHERE OBJECT_ID=OBJECT_ID(@TABLE_NAME)
	  --AND is_identity!=1 
	  FOR XML PATH('')
    ),1,1,''
)

SELECT @TEXT='SELECT ''INSERT INTO '+@TABLE_NAME+'('+@CSV_COLUMN+')VALUES('''+'+'+SUBSTRING(@QUOTED_DATA,1,LEN(@QUOTED_DATA)-5)+'+'+''')'''+' Insert_Scripts FROM '+@TABLE_NAME + @FILTER

--SELECT @CSV_COLUMN AS CSV_COLUMN,@QUOTED_DATA AS QUOTED_DATA,@TEXT TEXT

EXECUTE (@TEXT)

SET NOCOUNT OFF

END
CREATE Procedure [dbo].[sp_GetMemDetailsForCreateOrder]
 @nhMemberId [nvarchar](50),
 @memChartDataId bigint=0

AS
BEGIN
    SET NOCOUNT ON
	if(@memChartDataId = 0)
	  begin 
		SELECT  distinct
			  mp.NHMemberId,
			  mp.MemberProfileId,
			  mcd.[MemberChartDataId],		 
			  mcd.ProviderId,
			  mcd.LocationId as ProviderLocationId,
			  mi.InsuranceCarrierId,
			  mi.InsuranceHealthPlanID as HealthPlanId,
			  pgm.InsuranceCarrierID as ProgramInsuranceCarrierId,
			  pgm.InsuranceHealthPlanID as ProgramHealthPlanId,
			  pp.Brands as Brand		  
			from provider.MemberProfiles mp 
				join provider.MemberCharts mc on mc.MemberProfileId=mp.MemberProfileId				
				join provider.MemberChartData mcd on mcd.MemberChartId = mc.MemberChartId
				join provider.ProviderProfiles pp on pp.ProviderId = mcd.ProviderId
				join provider.MemberInsurances mi on mi.MemberProfileId=mp.MemberProfileId
				join provider.MemberProgramDetails pgm on pgm.MemberProfileId = mp.MemberProfileId
            where mp.NHMemberId = @nhMemberId --and (getdate() > mi.[InsuranceEffectiveDate] and getdate() < mi.[InsuranceEndDate]) 
			--order by mcd.[MemberChartDataId] desc
	 end
  else
	   begin 
		   SELECT  distinct
				  mp.NHMemberId,
				  mp.MemberProfileId,
				  mcd.[MemberChartDataId],		 
				  mcd.ProviderId,
			      mcd.LocationId as ProviderLocationId,
				  mi.InsuranceCarrierId,
				  mi.InsuranceHealthPlanID as HealthPlanId,
				  pgm.InsuranceCarrierID as ProgramInsuranceCarrierId,
				  pgm.InsuranceHealthPlanID as ProgramHealthPlanId,
				  pp.Brands as Brand		  
				from provider.MemberProfiles mp 
				join provider.MemberCharts mc on mc.MemberProfileId=mp.MemberProfileId				
				join provider.MemberChartData mcd on mcd.MemberChartId = mc.MemberChartId
				join provider.ProviderProfiles pp on pp.ProviderId = mcd.ProviderId
				join provider.MemberInsurances mi on mi.MemberProfileId=mp.MemberProfileId
				join provider.MemberProgramDetails pgm on pgm.MemberProfileId = mp.MemberProfileId
				where mp.NHMemberId = @nhMemberId and mcd.MemberChartDataId = @memChartDataId --and (getdate() > mi.[InsuranceEffectiveDate] and getdate() < mi.[InsuranceEndDate]) 
			--order by mcd.[MemberChartDataId] desc
	   end
END

	CREATE Procedure [dbo].[sp_creatediagram]
	(
		@diagramname 	sysname,
		@owner_id		int	= null, 	
		@version 		int,
		@definition 	varbinary(max)
	)
	WITH EXECUTE AS 'dbo'
	AS
	BEGIN
		set nocount on
	
		declare @theId int
		declare @retval int
		declare @IsDbo	int
		declare @userName sysname
		if(@version is null or @diagramname is null)
		begin
			RAISERROR (N'E_INVALIDARG', 16, 1);
			return -1
		end
	
		execute as caller;
		select @theId = DATABASE_PRINCIPAL_ID(); 
		select @IsDbo = IS_MEMBER(N'db_owner');
		revert; 
		
		if @owner_id is null
		begin
			select @owner_id = @theId;
		end
		else
		begin
			if @theId <> @owner_id
			begin
				if @IsDbo = 0
				begin
					RAISERROR (N'E_INVALIDARG', 16, 1);
					return -1
				end
				select @theId = @owner_id
			end
		end
		-- next 2 line only for test, will be removed after define name unique
		if EXISTS(select diagram_id from dbo.sysdiagrams where principal_id = @theId and name = @diagramname)
		begin
			RAISERROR ('The name is already used.', 16, 1);
			return -2
		end
	
		insert into dbo.sysdiagrams(name, principal_id , version, definition)
				VALUES(@diagramname, @theId, @version, @definition) ;
		
		select @retval = @@IDENTITY 
		return @retval
	END
	

	CREATE Procedure [dbo].[sp_alterdiagram]
	(
		@diagramname 	sysname,
		@owner_id	int	= null,
		@version 	int,
		@definition 	varbinary(max)
	)
	WITH EXECUTE AS 'dbo'
	AS
	BEGIN
		set nocount on
	
		declare @theId 			int
		declare @retval 		int
		declare @IsDbo 			int
		
		declare @UIDFound 		int
		declare @DiagId			int
		declare @ShouldChangeUID	int
	
		if(@diagramname is null)
		begin
			RAISERROR ('Invalid ARG', 16, 1)
			return -1
		end
	
		execute as caller;
		select @theId = DATABASE_PRINCIPAL_ID();	 
		select @IsDbo = IS_MEMBER(N'db_owner'); 
		if(@owner_id is null)
			select @owner_id = @theId;
		revert;
	
		select @ShouldChangeUID = 0
		select @DiagId = diagram_id, @UIDFound = principal_id from dbo.sysdiagrams where principal_id = @owner_id and name = @diagramname 
		
		if(@DiagId IS NULL or (@IsDbo = 0 and @theId <> @UIDFound))
		begin
			RAISERROR ('Diagram does not exist or you do not have permission.', 16, 1);
			return -3
		end
	
		if(@IsDbo <> 0)
		begin
			if(@UIDFound is null or USER_NAME(@UIDFound) is null) -- invalid principal_id
			begin
				select @ShouldChangeUID = 1 ;
			end
		end

		-- update dds data			
		update dbo.sysdiagrams set definition = @definition where diagram_id = @DiagId ;

		-- change owner
		if(@ShouldChangeUID = 1)
			update dbo.sysdiagrams set principal_id = @theId where diagram_id = @DiagId ;

		-- update dds version
		if(@version is not null)
			update dbo.sysdiagrams set version = @version where diagram_id = @DiagId ;

		return 0
	END
	

-- =============================================
-- Author:		RAMU KUNJA
-- Create date: 11-dEC-2017
-- Description:	PROCEDURE for Member Search Results
-- =============================================
CREATE Procedure [dbo].[sp_Admin_SearchMember](
	-- Add the parameters for the stored procedure here
	@MemberID           BIGINT = NULL, 
    @NHMemberID         NVARCHAR(50) = NULL, 
	@FirstName          NVARCHAR(250) = NULL,
    @LastName           NVARCHAR(50) = NULL,
	@DateOfBirth        DATETIME = NULL,
	@Gender             NVARCHAR(10) = NULL,
	@MaritalStatus      NVARCHAR(25) = NULL,
	@Address1           NVARCHAR(500) = NULL,
	@Address2           NVARCHAR(500) = NULL,
	@City               NVARCHAR(50) = NULL,
	@State              NVARCHAR(10) = NULL,
	@Country            NVARCHAR(50) = NULL,
	@ZipCode            NVARCHAR(10) = NULL, 
    @EmailAddress       NVARCHAR(50) = NULL, 
    @Phone               NVARCHAR(50) = NULL,
	@InsuranceHealthPlanNumber NVARCHAR(250) = NULL,
	@InsuranceHealthPlanName NVARCHAR(250) = NULL,
	@InsuranceCarrierName NVARCHAR(250) = NULL)
AS
BEGIN
	-- SET NOCOUNT ON added to prevent extra result sets from
	-- interfering with SELECT statements.
	SET NOCOUNT ON;
	DECLARE @SQLQuery AS NVARCHAR(4000)

   SET @SQLQuery = 'SELECT DISTINCT M.MemberID,M.NHMemberID,M.FirstName,M.LastName,M.DateOfBirth,M.Gender,M.MiddleInitial,M.IsActive,
	       A.Address1,A.Address2,A.City,A.State,A.Country,A.ZipCode,A.AddressTypeCode,
	       P.PhoneNbr,P.CountryCode,P.IsPreferredPhoneNumber,P.PhoneExtension,
		   EM.EmailAddress,
		   MA.AttributeTypeCode,MA.AttributeValue,
		   MI.InsuranceCarrierID,MI.InsuranceEffectiveDate,MI.InsuranceHealthPlanID,MI.InsuranceType,
		   MD.InsuranceNbr,
		   IC.InsuranceCarrierName,IC.MemberDataFileProvided,
		   IH.HealthPlanName,IH.HealthPlanNumber
	FROM [Master].Members M
	LEFT JOIN [Master].Addresses A on M.MemberID=A.MemberID
	LEFT JOIN [Master].PhoneNumbers P on M.MemberID=P.MemberID
	LEFT JOIN [Master].Emails EM on M.MemberID = EM.MemberID
	LEFT JOIN [Master].MemberAttributes MA on M.MemberID=MA.MemberID
	LEFT JOIN [Master].MemberInsurances MI on M.MemberID=MI.MemberID
	LEFT JOIN [Master].MemberInsuranceDetails MD on MI.ID=MD.MemberInsuranceID
	LEFT JOIN Insurance.InsuranceCarriers IC on MI.InsuranceCarrierID=IC.InsuranceCarrierID
	LEFT JOIN Insurance.InsuranceHealthPlans IH on MI.InsuranceHealthPlanID=IH.InsuranceHealthPlanID
	 '
	--If any Single Value ---
	if(@FirstName IS NOT NULL)
	SET @SQLQuery = @SQLQuery + 'WHERE M.FirstName LIKE ''%' + @FirstName+'%'''
	if (@FirstName IS NOT NULL AND @LastName IS NOT NULL)
	SET @SQLQuery = @SQLQuery + ' AND M.LastName LIKE ''%' + @LastName+'%'''
	else if (@LastName IS NOT NULL)
	SET @SQLQuery = @SQLQuery + ' WHERE M.LastName LIKE ''%' + @LastName+'%'''

	if (@FirstName IS NOT NULL AND @LastName IS NOT NULL AND @DateOfBirth IS NOT NULL)
	SET @SQLQuery = @SQLQuery + ' AND M.DateOfBirth =''' + @DateOfBirth +''
	else IF (@DateOfBirth IS NOT NULL)
	SET @SQLQuery = @SQLQuery + ' WHERE M.DateOfBirth =''' + @DateOfBirth +''


	if (@FirstName IS NOT NULL AND @LastName IS NOT NULL AND @DateOfBirth IS NOT NULL AND @Gender IS NOT NULL)
	SET @SQLQuery = @SQLQuery + ' AND M.Gender =''' + @Gender +''
	else if (@Gender IS NOT NULL)
	SET @SQLQuery = @SQLQuery + ' WHERE M.Gender =''' + @Gender + ''''
	
	if (@FirstName IS NOT NULL AND @LastName IS NOT NULL AND @DateOfBirth IS NOT NULL AND @Gender IS NOT NULL AND @MaritalStatus IS NOT NULL)
	SET @SQLQuery = @SQLQuery + ' AND M.MaritalStatus =''' + @MaritalStatus +''''
	else if (@MaritalStatus IS NOT NULL)
	SET @SQLQuery = @SQLQuery + ' WHERE M.MaritalStatus =''' + @MaritalStatus +''''
	
	if (@FirstName IS NOT NULL AND @LastName IS NOT NULL AND @DateOfBirth IS NOT NULL AND @Gender IS NOT NULL AND @MaritalStatus IS NOT NULL AND @Address1 IS NOT NULL)
	SET @SQLQuery = @SQLQuery + ' AND A.Address1 LIKE ''%'+@Address1+'%'''
	else if (@Address1 IS NOT NULL)
	SET @SQLQuery = @SQLQuery + ' WHERE A.Address1 LIKE ''%'+@Address1+'%'''
	
	if (@FirstName IS NOT NULL AND @LastName IS NOT NULL AND @DateOfBirth IS NOT NULL AND @Gender IS NOT NULL AND @MaritalStatus IS NOT NULL AND @Address1 IS NOT NULL AND @Address2 IS NOT NULL)
	SET @SQLQuery = @SQLQuery + ' AND A.Address2 LIKE ''%'+@Address2+'%'''
	else if (@Address2 IS NOT NULL)
	SET @SQLQuery = @SQLQuery + ' WHERE A.Address2 LIKE ''%'+@Address2+'%'''
	
	if (@FirstName IS NOT NULL AND @LastName IS NOT NULL AND @DateOfBirth IS NOT NULL AND @Gender IS NOT NULL AND @MaritalStatus IS NOT NULL AND @Address1 IS NOT NULL AND @Address2 IS NOT NULL AND @City IS NOT NULL)
	SET @SQLQuery = @SQLQuery + ' AND A.City =''' +@City + ''''
	else if (@City IS NOT NULL)
	SET @SQLQuery = @SQLQuery + ' WHERE A.City =''' +@City + ''''
	
	if (@FirstName IS NOT NULL AND @LastName IS NOT NULL AND @DateOfBirth IS NOT NULL AND @Gender IS NOT NULL AND @MaritalStatus IS NOT NULL AND @Address1 IS NOT NULL AND @Address2 IS NOT NULL AND @City IS NOT NULL AND @State IS NOT NULL)
	SET @SQLQuery = @SQLQuery + ' AND A.[State] LIKE ''%'+@State+'%'''
	else if (@State IS NOT NULL)
	SET @SQLQuery = @SQLQuery + ' WHERE A.[State] LIKE ''%'+@State+'%'''
	
	if (@FirstName IS NOT NULL AND @LastName IS NOT NULL AND @DateOfBirth IS NOT NULL AND @Gender IS NOT NULL AND @MaritalStatus IS NOT NULL AND @Address1 IS NOT NULL AND @Address2 IS NOT NULL AND @City IS NOT NULL AND @State IS NOT NULL AND @Country IS NOT NULL)
	SET @SQLQuery = @SQLQuery + ' AND A.Country LIKE ''%'+@Country+'%'''
	else if (@Country IS NOT NULL)
	SET @SQLQuery = @SQLQuery + ' WHERE A.Country LIKE ''%'+@Country+'%'''
	
	if (@FirstName IS NOT NULL AND @LastName IS NOT NULL AND @DateOfBirth IS NOT NULL AND @Gender IS NOT NULL AND @MaritalStatus IS NOT NULL AND @Address1 IS NOT NULL AND @Address2 IS NOT NULL AND @City IS NOT NULL AND @State IS NOT NULL AND @Country IS NOT NULL AND @ZipCode IS NOT NULL)
	SET @SQLQuery = @SQLQuery + ' AND A.ZipCode =''' +@ZipCode + ''''
	else if (@ZipCode IS NOT NULL)	 
	SET @SQLQuery = @SQLQuery + ' WHERE A.ZipCode =''' +@ZipCode + ''''
	
	if (@FirstName IS NOT NULL AND @LastName IS NOT NULL AND @DateOfBirth IS NOT NULL AND @Gender IS NOT NULL AND @MaritalStatus IS NOT NULL AND @Address1 IS NOT NULL AND @Address2 IS NOT NULL AND @City IS NOT NULL AND @State IS NOT NULL AND @Country IS NOT NULL AND @ZipCode IS NOT NULL AND @EmailAddress IS NOT NULL)
	SET @SQLQuery = @SQLQuery + ' AND EM.EmailAddress =''' + @EmailAddress +''''
	if (@EmailAddress IS NOT NULL)	 
	SET @SQLQuery = @SQLQuery + ' WHERE EM.EmailAddress =''' + @EmailAddress +''''
	
	if (@FirstName IS NOT NULL AND @LastName IS NOT NULL AND @DateOfBirth IS NOT NULL AND @Gender IS NOT NULL AND @MaritalStatus IS NOT NULL AND @Address1 IS NOT NULL AND @Address2 IS NOT NULL AND @City IS NOT NULL AND @State IS NOT NULL AND @Country IS NOT NULL AND @ZipCode IS NOT NULL AND @EmailAddress IS NOT NULL AND @Phone IS NOT NULL)
	SET @SQLQuery = @SQLQuery + ' AND P.PhoneNbr = ''' +@Phone + ''''
	else if (@Phone IS NOT NULL)	 
	SET @SQLQuery = @SQLQuery + ' WHERE P.PhoneNbr = ''' +@Phone + ''''
	
	if (@FirstName IS NOT NULL AND @LastName IS NOT NULL AND @DateOfBirth IS NOT NULL AND @Gender IS NOT NULL AND @MaritalStatus IS NOT NULL AND @Address1 IS NOT NULL AND @Address2 IS NOT NULL AND @City IS NOT NULL AND @State IS NOT NULL AND @Country IS NOT NULL AND @ZipCode IS NOT NULL AND @EmailAddress IS NOT NULL AND @Phone IS NOT NULL AND @InsuranceHealthPlanNumber IS NOT NULL)
	SET @SQLQuery = @SQLQuery + ' AND MD.InsuranceNbr LIKE ''%'+@InsuranceHealthPlanNumber+'%'''
	else if (@InsuranceHealthPlanNumber IS NOT NULL)	 
	SET @SQLQuery = @SQLQuery + ' WHERE MD.InsuranceNbr LIKE ''%'+@InsuranceHealthPlanNumber+'%'''
	--If any Single Value ---

	SET @SQLQuery = @SQLQuery + ' Order by M.FirstName, M.LastName'
	--PRINT @SQLQuery
	EXECUTE sp_executesql @SQLQuery

	 If @@ERROR <> 0 GoTo ErrorHandler
    Set NoCount OFF
    Return(0)
  
ErrorHandler:
    Return(@@ERROR)
END


--EXEC [dbo].[sp_SearchMember] @MemberID = NULL , 
--    @NHMemberID  = NULL, 
--	@FirstName = NULL,
--    @LastName = NULL,
--	@DateOfBirth= NULL,
--	@Gender = NULL,
--	@MaritalStatus = NULL,
--	@Address1 = null,
--	@Address2 = NULL,
--	@City = NULL,
--	@State = NULL,
--	@Country = NULL,
--	@ZipCode = NULL, 
--    @EmailAddress = NULL, 
--    @Phone  = NULL,
--	@InsuranceHealthPlanNumber = 'GA00001561',
--	@InsuranceHealthPlanName = NULL,
--	@InsuranceCarrierName = NULL


CREATE PROCEDURE [dbo].[DataSync_Get_LocationHCPsMapping_4PVN]
AS
BEGIN
SELECT distinct
    '' AS ACTION, 
    [HCP].[IsActive] AS 'IsActive',
    [PPP].[PROVIDERID] AS 'ProviderId', 
    [PPP].[TAXID] AS 'TaxId',
    [PPP].[PROVIDERNAME] AS 'ProviderName',
    [PL].[LocationId] AS 'LocationId', 
    [PL].[BusinessName] AS 'BusinessName',
	[HCP].[HCPId] AS 'HCPId',
	[HCP].[FirstName] AS 'FirstName',
	[HCP].[LastName] AS 'LastName',
	[HCP].[NHNPI] AS 'NHNPI',
	[HCP].[NPINumber] AS 'NPINumber'     
FROM [provider].[ProviderUserLocations] PUL
INNER JOIN [provider].[HCPProviderProfile] HCP ON PUL.UserProfileId =  HCP.UserProfileId
INNER JOIN [provider].[Locations] PL ON PL.LocationId =  PUL.LocationId
INNER JOIN [provider].[ProviderProfiles] PPP ON  PPP.PROVIDERID = PUL.PROVIDERID
where pul.ISactive=1
ORDER BY  PPP.[PROVIDERID] ASC
END




CREATE PROCEDURE [dbo].[DataSync_Get_Locations_4PVN]
AS
BEGIN
SELECT
'' as 'Action',
pl.providerId as 'ProviderId',
pp.[TaxId] as 'TaxId',
pp.[ProviderName] as 'ProviderName',
l.[IsActive] as 'IsActive',
pl.[LocationId] as 'LocationId',
l.[BusinessName] as 'BusinessName',
l.[NPINumber] as 'NPINumber',
l.[Address1] as 'Address1',
l.[Address2] as 'Address2',
l.[City] as 'City',
l.[State] as 'State',
l.[Zip] as 'Zip',
isnull(l.[LocationEmailAddress], '') as 'LocationEmailAddress',
isnull((select top 1 PhoneNumber from [provider].[LocationPhoneNumbers] where [LocationId]=pl.[LocationId] and [PhoneTypeId]=1), '') as 'LocationPhoneNumber',
isnull((select top 1 PhoneNumber from [provider].[LocationPhoneNumbers] where [LocationId]=pl.[LocationId] and [PhoneTypeId]=3), '') as 'LocationFaxNumber',
isnull(JSON_VALUE([LocationServicesData], '$.mobileServices'), '') as 'MobileServices',
isnull((select top 1 [Dispenser] from [provider].[LocationsAccountNbrs] where [LocationId]=pl.[LocationId] and [BrandCode]='GNR'), '') as 'ResoundAccountNumber',
isnull((select top 1 [Dispenser] from [provider].[LocationsAccountNbrs] where [LocationId]=pl.[LocationId] and [BrandCode]='BELTONE'), '') as 'BeltoneAccountNumber',
isnull((select top 1 [Dispenser] from [provider].[LocationsAccountNbrs] where [LocationId]=pl.[LocationId] and [BrandCode]='STARKEY'), '') as 'StarkeyAccountNumber',
isnull((select top 1 [Dispenser] from [provider].[LocationsAccountNbrs] where [LocationId]=pl.[LocationId] and [BrandCode]='PHONAK'), '') as 'PhonakAccountNumber',
isnull((select top 1 [Dispenser] from [provider].[LocationsAccountNbrs] where [LocationId]=pl.[LocationId] and [BrandCode]='WIDEX'), '') as 'WidexAccountNumber',
isnull((select top 1 [Dispenser] from [provider].[LocationsAccountNbrs] where [LocationId]=pl.[LocationId] and [BrandCode]='SIGNIA'), '') as 'SigniaAccountNumber',
isnull((select top 1 [Dispenser] from [provider].[LocationsAccountNbrs] where [LocationId]=pl.[LocationId] and [BrandCode]='UNITRON'), '') as 'UnitronAccountNumber',
isnull((select top 1 [Dispenser] from [provider].[LocationsAccountNbrs] where [LocationId]=pl.[LocationId] and [BrandCode]='OTICON'), '') as 'OticonAccountNumber',
isnull(JSON_VALUE([LocationServicesData], '$.wheelChair'), '') as 'WheelChair',
isnull(JSON_VALUE([LocationServicesData], '$.pediatricServices'), '') as 'PeditatricServices',
l.[Langauges] as 'Languages',
'' as 'CentralHealth',
'' as 'Ultimate',
'' as 'EON',
'' as 'HealthAlliance',
'' as 'UniversityofMaryland',
'' as 'Anthem',
(select Count(*) from [provider].[ProviderUserLocations] where ProviderId = pp.ProviderId and LocationId = l.LocationId) as 'TotalHCPs',
'' as 'HCPsCredentialed',
'' as 'PercentageHCPsCredentialed'
FROM [provider].[ProviderLocations] pl
INNER JOIN [provider].[ProviderProfiles] pp
on pl.providerId = pp.providerId
INNER JOIN [provider].[Locations] l
on pl.locationId = l.locationId
END
CREATE PROCEDURE [dbo].[GetAllOrderItems] @OrderId bigint
AS
BEGIN
    SET NOCOUNT ON

	SELECT [OrderItemId]
      ,[OrderId]
      ,[BrandCode]
      ,[FamilyCode]
      ,[StyleCode]
      ,[TechnologyLevelCode]
      ,[ProductModelCode]
      ,[ItemCode]
      ,[Modifier]
      ,[Quantity]
      ,[Amount]
      ,[Status]
      ,[UnitPrice]
      ,[PairPrice]
      ,[ItemData]
      ,[ItemType]
      ,[PONumber]
      ,[InvoiceNumber]
      ,[CreateUser]
      ,[CreateDate]
      ,[ModifyUser]
      ,[ModifyDate]
      ,[IsActive]
      ,[PreviousAmount]
  FROM [Orders].[OrderItems] OI where OI.OrderId = @OrderId;


END
CREATE Procedure [dbo].[sp_GetOrderDetailsForCreateOrder]  
 @nhMemberId [nvarchar](50)  
  
AS  
BEGIN  
    SET NOCOUNT ON  

-- declare  @nhMemberId varchar(50)='QA201700004486'
  SELECT  distinct  
     o.[OrderID]  
    ,o.[MemberChartDataId]
	,o.NhMemberID      
    ,o.CreateDate as OrderDate  
    ,os.OrderStatusName     
    ,items.DeviceCount  
    ,ma.StartDate   
    ,ma.AppointmentTypeId      
  from [Orders].[Orders] o  
  join Orders.OrderStatusTypes os on o.OrderStatusCode = os.OrderStatusCode   
  join provider.MemberChartData mcd on mcd.MemberChartDataId=o.MemberChartDataId 
  join provider.MemberAppointments ma on ma.MemberChartDataId = mcd.MemberChartDataId  
  inner join  (SELECT  count(*) as DeviceCount,OrderId as OrderId    
								 FROM orders.orderitems orderitem 
								 
								 where  orderitem.IsActive=1 and  orderitem.ItemCode!='EARMOLD'
								 group by OrderId						 
								 ) items  	 on Items.OrderId=o.OrderId 
  where (ISJSON(MemberData) > 0) and (ISJSON(OrderAmountData) > 0) and NHMemberId= @nhMemberId and ma.AppointmentTypeId=1
  order by o.CreateDate desc    

      
END  


CREATE PROCEDURE [dbo].[DataSync_Get_Providers_4PVN]
AS
BEGIN
SELECT
'' as 'Action',
cast([ProviderId] as varchar) AS 'ProviderId', [TaxId] AS 'TaxId', isnull([ProviderName], '') AS 'ProviderName',
cast([IsActive] as varchar) AS 'IsActive',
isnull([AgeRestrictions], '') as 'AgeRestrictions',
isnull([Languages], '') as 'Languages',
isnull([Brands], '') AS 'Brands',
isnull(JSON_VALUE([AdditionalData], '$.contractInfo.initialContractDate'), '') AS 'InitialContract',
isnull(JSON_VALUE([AdditionalData], '$.contractInfo.recentContractDate'), '') AS 'RecentContract',
isnull(JSON_VALUE([AdditionalData], '$.contractInfo.contractType'), '') AS 'ContractType',
isnull(JSON_VALUE([AdditionalData], '$.contractInfo.contractTerminationDate'), '') AS 'ContractTermination',
isnull(JSON_VALUE([AdditionalData], '$.contractInfo.AnthemAmendmentDate'), '') AS 'AnthemAmendment',
cast(isnull([PracticeTypeId], '') as varchar) AS 'PracticeTypeId', isnull([PracticeTypeId1], '') AS 'PracticeTypeId1',
cast(isnull([PrimaryEmailAddress], '') as varchar) AS 'PrimaryEmailAddress',
isnull(JSON_VALUE([AdditionalData], '$.billingAddress.address1'), '') AS 'BillingAddress',
isnull(JSON_VALUE([AdditionalData], '$.billingAddress.city'), '') AS 'BillingCity',
isnull(JSON_VALUE([AdditionalData], '$.billingAddress.state'), '') AS 'BillingState',
isnull(JSON_VALUE([AdditionalData], '$.billingAddress.zip'), '') AS 'BillingZip',
isnull(JSON_VALUE([AdditionalData], '$.billingAddress.county'), '') AS 'BillingCounty',
isnull(JSON_VALUE([AdditionalData], '$.billingAddress.phoneNumber'), '') AS 'BillingPhoneNumber',
isnull(JSON_VALUE([AdditionalData], '$.owner.lastName'), '') AS 'OwnerLastName',
isnull(JSON_VALUE([AdditionalData], '$.owner.firstName'), '') AS 'OwnerFirstName',
isnull(JSON_VALUE([AdditionalData], '$.shippingAddress.address1'), '') AS 'ShippingAddress',
isnull(JSON_VALUE([AdditionalData], '$.shippingAddress.address2'), '') AS 'ShippingAddress2',
isnull(JSON_VALUE([AdditionalData], '$.shippingAddress.city'), '') AS 'ShippingCity',
isnull(JSON_VALUE([AdditionalData], '$.shippingAddress.state'), '') AS 'ShippingState',
isnull(JSON_VALUE([AdditionalData], '$.shippingAddress.zip'), '') AS 'ShippingZip',
isnull(JSON_VALUE([AdditionalData], '$.adaAttestationReceivedDate'), '') AS 'ADAAttestationReceivedDate',
isnull(JSON_VALUE([AdditionalData], '$.medicareAttestationReceivedDate'), '') AS 'MedicareAttestationReceivedDate'
FROM [provider].[ProviderProfiles]
END
CREATE Procedure [dbo].[InsertorUpdateInsHealthPlanBenefits_BM]
	-- Add the parameters for the stored procedure here
				@action Nvarchar(5),
				@ContractBenefitID	bigint = 0,
				@BenefitAmt	float = 0.0,
				@BenefitAmtPer	nvarchar(50) = null,
				@BenefitFrequencyYears	nvarchar(20) = null,
				@BenefitFrequencyYearsBy	nvarchar(50) = null,				
				@CreateUser	nvarchar(150) = null,
				@FittingCoPay float = 0.0,
				@HealthPlanContractID int,
				@HealthPlanContractInsuranceHealthPlanID bigint = null,
				@HearingAidCoPay float,
				@HearingAidCoPayPer	nvarchar(50)= null,
				@HearingExamCoPay	float,
				@InsurancePayerID	nvarchar(100) = null,
				@IsAbilityToBalanceBillMember bit,
				@IsActive	bit,
				@IsClaimEqualToProductListPricePerDevice	bit,
				@IsClaimPayToPatient	bit,
				@IsDefaultBenefit	bit,
				@IsFileClaim	bit,
				@IsHearingAidBenefitVerificationRequired	bit,
				@IsMedicaidIsSecondaryCoverage	bit,
				@IsPMNPM	bit,
				@IsPriorAuth	bit,
				@IsRebate	bit,				
				@ModifyUser	nvarchar(150) = NULL,
				@PMPMAmount	float,
				@RebatePercentage	int
				
				 				
AS
BEGIN
	-- SET NOCOUNT ON added to prevent extra result sets from
	-- interfering with SELECT statements.
	SET NOCOUNT ON;
    -- Insert statements for procedure here
IF @action = 'N'
  BEGIN
	if not exists (SELECT 1 FROM [Insurance].[ContractBenefits])
	BEGIN
		DBCC CHECKIDENT ('[Insurance].[ContractBenefits]', RESEED, 1) 
	END
	INSERT INTO  [Insurance].[ContractBenefits]  
				 (
					BenefitAmt,
					BenefitAmtPer,
					BenefitFrequencyYears,
					BenefitFrequencyYearsBy,
					CreateDate,
					CreateUser,
					FittingCoPay,
					HealthPlanContractID,
					HealthPlanContractInsuranceHealthPlanID,
					HearingAidCoPay,
					HearingAidCoPayPer,
					HearingExamCoPay,
					InsurancePayerID,
					IsAbilityToBalanceBillMember,
					IsActive,
					IsClaimEqualToProductListPricePerDevice,
					IsClaimPayToPatient,
					IsDefaultBenefit,
					IsFileClaim,
					IsHearingAidBenefitVerificationRequired,
					IsMedicaidIsSecondaryCoverage,
					IsPMNPM,
					IsPriorAuth,
					IsRebate,
					ModifyDate,
					ModifyUser,
					PMPMAmount,
					RebatePercentage
				)
	Values		(
				@BenefitAmt,
				@BenefitAmtPer,
				@BenefitFrequencyYears,
				@BenefitFrequencyYearsBy,
				getdate(),
				@CreateUser,
				@FittingCoPay,
				@HealthPlanContractID,
				@HealthPlanContractInsuranceHealthPlanID,
				@HearingAidCoPay,
				@HearingAidCoPayPer,
				@HearingExamCoPay,
				@InsurancePayerID,
				@IsAbilityToBalanceBillMember,
				@IsActive,
				@IsClaimEqualToProductListPricePerDevice,
				@IsClaimPayToPatient,
				@IsDefaultBenefit,
				@IsFileClaim,
				@IsHearingAidBenefitVerificationRequired,
				@IsMedicaidIsSecondaryCoverage,
				@IsPMNPM,
				@IsPriorAuth,
				@IsRebate,
				getdate(),
				@ModifyUser,
				@PMPMAmount,
				@RebatePercentage
				) 
	END	
ELSE if @action = 'R'--exists (SELECT 1 FROM [Insurance].[ContractBenefits]  WHERE ContractBenefitID = @ContractBenefitID and HealthPlanContractID = @HealthPlanContractID)
	BEGIN	
		UPDATE  [Insurance].[ContractBenefits] 
		SET		    BenefitAmt = @BenefitAmt,
					BenefitAmtPer = @BenefitAmtPer,
					BenefitFrequencyYears = @BenefitFrequencyYears,
					BenefitFrequencyYearsBy = @BenefitFrequencyYearsBy,					
					FittingCoPay = @FittingCoPay,
					HealthPlanContractID = @HealthPlanContractID ,
					HealthPlanContractInsuranceHealthPlanID = @HealthPlanContractInsuranceHealthPlanID,
					HearingAidCoPay = @HearingAidCoPay,
					HearingAidCoPayPer = @HearingAidCoPayPer,
					HearingExamCoPay = @HearingExamCoPay,
					InsurancePayerID = @InsurancePayerID,
					IsAbilityToBalanceBillMember = @IsAbilityToBalanceBillMember,
					IsActive = @IsActive,
					IsClaimEqualToProductListPricePerDevice = @IsClaimEqualToProductListPricePerDevice,
					IsClaimPayToPatient = @IsClaimPayToPatient,
					IsDefaultBenefit = @IsDefaultBenefit,
					IsFileClaim = @IsFileClaim,
					IsHearingAidBenefitVerificationRequired = @IsHearingAidBenefitVerificationRequired,
					IsMedicaidIsSecondaryCoverage = @IsMedicaidIsSecondaryCoverage,
					IsPMNPM = @IsPMNPM,
					IsPriorAuth = @IsPriorAuth,
					IsRebate = @IsRebate,
					ModifyDate = getdate(),
					ModifyUser = @ModifyUser,
					PMPMAmount = @PMPMAmount,
					RebatePercentage = @RebatePercentage				
		WHERE   ContractBenefitID = @ContractBenefitID
	END
ELSE if  @action = 'D' 
	BEGIN
	  UPDATE  [Insurance].[ContractBenefits]  
	     SET IsActive=0  WHERE  ContractBenefitID = @ContractBenefitID  
	END 
END
-- =====================================================================================================
--SELECT * FROM [Insurance].[InsuranceCarriers]   
--EXEC InsertorUpdateInsCarriers 7, 'Scripts', 'GEHA_FEHBP', 1, 0, 'Scripts', 0
-- =====================================================================================================
CREATE Procedure [dbo].[InsertorUpdateInsCarriers_BM]  
 -- Add the parameters for the stored procedure here  
     @action NVARCHAR(5),
	 @insuranceCarrierID BIGINT = 0,      
     @createSource NVARCHAR(150),       
     @insuranceCarrierName NVARCHAR(50),   
     @isActive BIT,   
     @memberDataFileProvided BIT,      
     @modifySource NVARCHAR(150),  
     @isDiscountProgram bit,
	 @custServiceAddress1 nvarchar(200),
	 @custServiceAddress2  nvarchar(200),
	 @custServiceCity  nvarchar(100),
	 @custServiceState  nvarchar(100),
	 @custServiceZipCode  nvarchar(10),
	 @custServicePhoneNbr bigint,
	 @custServiceEmailAddress  nvarchar(100),
	 @claimsAddress1  nvarchar(200),
	 @claimsAddress2  nvarchar(200),
	 @claimsCity  nvarchar(100),
	 @claimsState  nvarchar(100),
	 @claimsZipCode  nvarchar(10),
	 @claimsPhoneNbr bigint,
	 @claimsEmailAddress  nvarchar(100),
	 @isContracted bit
	 
AS  
BEGIN  
 -- SET NOCOUNT ON added to prevent extra result sets from  
 -- interfering with SELECT statements.  
 SET NOCOUNT ON;  
 --reseeded the identity column in the table  
 --end
    -- Insert statements for procedure here  
 IF @action = 'N'
  BEGIN
	if not exists (SELECT 1 FROM [Insurance].[InsuranceCarriers])
	BEGIN
		DBCC CHECKIDENT ('[Insurance].[InsuranceCarriers]', RESEED, 1) 
	END	
	 INSERT INTO [Insurance].[InsuranceCarriers]   
		(Createdate,   
		 CreateUser,   
		 InsuranceCarrierName,   
		 IsActive,   
		 MemberDataFileProvided,   
		 ModifyDate,   
		 ModifyUser,
		 IsDiscountProgram,
		 CustServiceAddress1,
		 CustServiceAddress2,
		 CustServiceCity,
		 CustServiceState,
		 CustServiceZipCode,
		 CustServicePhoneNbr,
		 CustServiceEmailAddress,
		 ClaimsAddress1,
		 ClaimsAddress2,
		 ClaimsCity,
		 ClaimsState,
		 ClaimsZipCode,
		 ClaimsPhoneNbr,
		 ClaimsEmailAddress,
		 IsContracted
		 )   
		 VALUES  (getdate(),  
		 @createSource,   
		 @insuranceCarrierName,   
		 @isActive,   
		 @memberDataFileProvided,   
		 getdate(),   
		 @modifySource,
		 @isDiscountProgram,
		 @custServiceAddress1,
		 @custServiceAddress2,
		 @custServiceCity,
		 @custServiceState,
		 @custServiceZipCode,
		 @custServicePhoneNbr,
		 @custServiceEmailAddress,
		 @claimsAddress1,
		 @claimsAddress2,
		 @claimsCity,
		 @claimsState,
		 @claimsZipCode,
		 @claimsPhoneNbr,
		 @claimsEmailAddress,
		 @isContracted
		 ) 
  END
  ELSE if  @action = 'R'--exists (SELECT 1 FROM [Insurance].[InsuranceCarriers] WHERE INSURANCECARRIERNAME = @insuranceCarrierName)
   BEGIN
	  UPDATE  [Insurance].[InsuranceCarriers]   
		  SET  InsuranceCarrierName = @insuranceCarrierName,  
			   IsActive = @isActive,   
			   MemberDataFileProvided= @memberDataFileProvided,   
			   ModifyDate = getdate(),   
			   ModifyUser = @modifySource,
			   IsDiscountProgram = @isDiscountProgram,
				CustServiceAddress1 = @custServiceAddress1,
				CustServiceAddress2 = @custServiceAddress2,
				CustServiceCity = @custServiceCity,
				CustServiceState = @custServiceState,
				CustServiceZipCode = @custServiceZipCode,
				CustServicePhoneNbr = @custServicePhoneNbr,
				CustServiceEmailAddress = @custServiceEmailAddress,
				ClaimsAddress1 = @claimsAddress1,
				ClaimsAddress2 = @claimsAddress2,
				ClaimsCity = @claimsCity,
				ClaimsState = @claimsState,
				ClaimsZipCode = @claimsZipCode,
				ClaimsPhoneNbr = @claimsPhoneNbr,
				ClaimsEmailAddress =  @claimsEmailAddress,
				IsContracted =  @isContracted
	  WHERE   InsuranceCarrierID = @insuranceCarrierID  
   END
  ELSE if  @action = 'D' 
	BEGIN
	  UPDATE  [Insurance].[InsuranceCarriers]  
	     SET IsActive=0  WHERE   InsuranceCarrierID = @insuranceCarrierID   
	END 
END 

	CREATE Procedure [dbo].[sp_renamediagram]
	(
		@diagramname 		sysname,
		@owner_id		int	= null,
		@new_diagramname	sysname
	
	)
	WITH EXECUTE AS 'dbo'
	AS
	BEGIN
		set nocount on
		declare @theId 			int
		declare @IsDbo 			int
		
		declare @UIDFound 		int
		declare @DiagId			int
		declare @DiagIdTarg		int
		declare @u_name			sysname
		if((@diagramname is null) or (@new_diagramname is null))
		begin
			RAISERROR ('Invalid value', 16, 1);
			return -1
		end
	
		EXECUTE AS CALLER;
		select @theId = DATABASE_PRINCIPAL_ID();
		select @IsDbo = IS_MEMBER(N'db_owner'); 
		if(@owner_id is null)
			select @owner_id = @theId;
		REVERT;
	
		select @u_name = USER_NAME(@owner_id)
	
		select @DiagId = diagram_id, @UIDFound = principal_id from dbo.sysdiagrams where principal_id = @owner_id and name = @diagramname 
		if(@DiagId IS NULL or (@IsDbo = 0 and @UIDFound <> @theId))
		begin
			RAISERROR ('Diagram does not exist or you do not have permission.', 16, 1)
			return -3
		end
	
		-- if((@u_name is not null) and (@new_diagramname = @diagramname))	-- nothing will change
		--	return 0;
	
		if(@u_name is null)
			select @DiagIdTarg = diagram_id from dbo.sysdiagrams where principal_id = @theId and name = @new_diagramname
		else
			select @DiagIdTarg = diagram_id from dbo.sysdiagrams where principal_id = @owner_id and name = @new_diagramname
	
		if((@DiagIdTarg is not null) and  @DiagId <> @DiagIdTarg)
		begin
			RAISERROR ('The name is already used.', 16, 1);
			return -2
		end		
	
		if(@u_name is null)
			update dbo.sysdiagrams set [name] = @new_diagramname, principal_id = @theId where diagram_id = @DiagId
		else
			update dbo.sysdiagrams set [name] = @new_diagramname where diagram_id = @DiagId
		return 0
	END
	
CREATE PROCEDURE [dbo].[sp_SearchMemberPP](                        
       @NHMemberID         NVARCHAR(50) = NULL,                         
       @FirstName          NVARCHAR(250) = NULL,                        
       @LastName           NVARCHAR(50) = NULL,                        
       @DateOfBirth        VARCHAR(20) = NULL,                        
       @Address1           NVARCHAR(500) = NULL,                        
       @Address2           NVARCHAR(500) = NULL,                        
       @City               NVARCHAR(50) = NULL,                        
       @State              NVARCHAR(10) = NULL,                        
       @ZipCode            NVARCHAR(10) = NULL,                         
       @Phone               NVARCHAR(50) = NULL,            
       @ProviderID NVARCHAR(50) = NULL,                  
       @searchType NVARCHAR(50) = NULL,            
       @InsuranceHealthPlanNumber NVARCHAR(250) = NULL,        
       @ProviderCode NVARCHAR(20) = NULL        
  )                        
AS                        
BEGIN                  
DECLARE @SQLSubQuery AS NVARCHAR(4000)                  
DECLARE @condition AS NVARCHAR(5)        
if(@ProviderCode=NULL)        
begin        
SET @ProviderCode = (SELECT PROVIDERCODE FROM [provider].[ProviderProfiles] WHERE [ProviderId] = @ProviderID)        
end        
IF(@ProviderCode = '180000')        
BEGIN        
SET @SQLSubQuery = 'select distinct m.firstname,m.middlename,m.lastname,m.nhmemberid,convert(varchar(10), m.DateOfBirth, 101) as DateOfBirth,ml.address1,ml.address2,ml.city,ml.state,p.phonenumber,ml.zipcode,                  
     convert(varchar(10),json_value(d.ProcessData, ''$.appointmentDate''),101) as appointmentDate,          
        row_number() over (partition by nhmemberid order by  convert(varchar(10),json_value(d.ProcessData, ''$.appointmentDate''),101) desc) AS Rownum,                 
      ISNULL(CONCAT(up.FirstName, '''',up.LastName),'''') AS AppointmentWith,CONCAT(l.Address1,'' '','','',l.address2,'' '','','',l.city,'' '',l.state,'' '','','',l.zip) AS ApptLocationAddress,IH.healthplanname             
       from [provider].[MemberProfiles] m                   
     inner join [provider].[MemberLocations] ml on ml.memberprofileid = m.memberprofileid and ml.isactive = 1   AND ml.IsPreferredAddress=1              
     left outer join [provider].[MemberPhoneNumbers] p on p.memberprofileid = m.memberprofileid and p.isactive = 1                 
     inner join [provider].[MemberChartData] d on  json_value(d.ProcessData, ''$.MemberProfileId'') = m.memberprofileid and d.isactive = 1 and d.minorprocessid = 16                  
     LEFT JOIN [provider].[HCPProviderProfile] h ON h.HCPID = JSON_VALUE(D.ProcessData, ''$.HCPUserProfileId'') and h.isactive = 1                  
     LEFT JOIN [provider].[Locations] l ON l.LocationId = d.LocationId and l.isactive = 1        
  LEFT JOIN [provider].[ProviderUserLocations] pul ON pul.LocationId = d.LocationId and pul.isactive = 1       
  LEFT JOIN [auth].[UserProfiles] up ON up.UserProfileId = pul.UserProfileId AND up.isactive = 1 and  json_value(d.ProcessData, ''$.HCPUserProfileId'') = up.UserProfileId and CONCAT(up.FirstName, '''',up.LastName) <> ''''           
     LEFT JOIN [provider].[MemberInsurances] MI  on M.memberprofileid=MI.memberprofileid  AND  MI.IsActive = 1                  
     LEFT JOIN [provider].[MemberInsuranceDetails] MD  on MI.MemberInsuranceID=MD.MemberInsuranceID    AND  MD.IsActive = 1                  
     LEFT JOIN Insurance.InsuranceCarriers IC  on MI.InsuranceCarrierID=IC.InsuranceCarrierID      AND  IC.IsActive = 1            
     LEFT JOIN Insurance.InsuranceHealthPlans IH  on MI.InsuranceHealthPlanID=IH.InsuranceHealthPlanID  AND IH.IsActive = 1  where m.isactive = 1 AND  ISNULL(CONCAT(up.FirstName, '''',up. LastName),'''')<> '''''        
END        
ELSE        
BEGIN        
SET @SQLSubQuery = 'select distinct m.firstname,m.middlename,m.lastname,m.nhmemberid,convert(varchar(10), m.DateOfBirth, 101) as DateOfBirth,ml.address1,ml.address2,ml.city,ml.state,p.phonenumber,ml.zipcode,                  
     convert(varchar(10),json_value(d.ProcessData, ''$.appointmentDate''),101) as appointmentDate,row_number() over (partition by nhmemberid order by  convert(varchar(10),json_value(d.ProcessData, ''$.appointmentDate''),101) desc) AS Rownum,              
  
    
      
             
       ISNULL(CONCAT(up.FirstName, '''',up. LastName),'''') AS AppointmentWith,CONCAT(l.Address1,'' '','','',l.address2,'' '','','',l.city,'' '','','',l.state,'' '','','',l.zip) AS ApptLocationAddress,IH.healthplanname                    
       from [provider].[MemberProfiles] m                   
     inner join [provider].[MemberLocations] ml on ml.memberprofileid = m.memberprofileid and ml.isactive = 1   AND ml.IsPreferredAddress=1              
     left outer join [provider].[MemberPhoneNumbers] p on p.memberprofileid = m.memberprofileid and p.isactive = 1         
     inner join [provider].[MemberChartData] d on  json_value(d.ProcessData, ''$.MemberProfileId'') = m.memberprofileid and d.isactive = 1  and d.minorprocessid = 16               
     LEFT JOIN [provider].[HCPProviderProfile] h ON h.HCPID = JSON_VALUE(D.ProcessData, ''$.HCPUserProfileId'') and h.isactive = 1                  
     LEFT JOIN [provider].[Locations] l ON l.LocationId = d.LocationId and l.isactive = 1          
  LEFT JOIN [provider].[ProviderUserLocations] pul ON pul.LocationId = d.LocationId and pul.isactive = 1       
  LEFT JOIN [auth].[UserProfiles] up ON up.UserProfileId = pul.UserProfileId AND up.isactive = 1  and  json_value(d.ProcessData, ''$.HCPUserProfileId'') = up.UserProfileId  and CONCAT(up.FirstName, '''',up.LastName) <> ''''       
     LEFT JOIN [provider].[MemberInsurances] MI  on M.memberprofileid=MI.memberprofileid  AND  MI.IsActive = 1                  
     LEFT JOIN [provider].[MemberInsuranceDetails] MD  on MI.MemberInsuranceID=MD.MemberInsuranceID    AND  MD.IsActive = 1                  
     LEFT JOIN Insurance.InsuranceCarriers IC  on MI.InsuranceCarrierID=IC.InsuranceCarrierID      AND  IC.IsActive = 1         
     LEFT JOIN Insurance.InsuranceHealthPlans IH  on MI.InsuranceHealthPlanID=IH.InsuranceHealthPlanID  AND IH.IsActive=1                      
     where m.isactive = 1 AND  ISNULL(CONCAT(up.FirstName, '''',up. LastName),'''') <> '''' and d.providerid = '''+@ProviderID +''''                  
END        
                    
              
   IF (@searchType = 'quick')              
   BEGIN          
   IF(@ProviderCode = '180000')        
   BEGIN            
    IF @FirstName IS NOT NULL        
    set @SQLSubQuery = @SQLSubQuery + ' and (m.firstname like ''%'+@FirstName+'%'' OR m.lastname like ''%'+@FirstName+'%'')'              
    IF @LastName IS NOT NULL              
    set @SQLSubQuery = @SQLSubQuery + ' and (m.firstname like ''%'+@LastName+'%'' OR m.lastname like ''%'+@LastName+'%'')'              
                   
    IF @NHMemberID IS NOT NULL                             
      SET @SQLSubQuery = @SQLSubQuery + ' and  m.NHMemberID = '''+@NHMemberID+''''              
    IF @DateOfBirth is not null                          
        set @SQLSubQuery = @SQLSubQuery + ' and  m.DateOfBirth = '''+@DateOfBirth+''''              
    IF @ZipCode is not null                          
      set @SQLSubQuery = @SQLSubQuery + ' and  ml.ZipCode = '''+@ZipCode+''''              
    IF (@Phone is not null)                        
      set @SQLSubQuery = @SQLSubQuery+ ' and  p.phonenumber = '''+@Phone+''''              
    IF (@Address1 is not null)                                         
       set @SQLSubQuery = @SQLSubQuery + ' and  ml.Address1 = '''+@Address1+''''               
    IF (@Address2 is not null)                                
      set @SQLSubQuery = @SQLSubQuery +' and ml.Address2 = '''+@Address2+''''              
    IF (@City is not null)                                 
      set @SQLSubQuery = @SQLSubQuery +' and  ml.City = '''+@City+''''                     
    IF (@State is not null)                              
                 set @SQLSubQuery = @SQLSubQuery +' and ml.State = '''+@State+''''                
                    
    IF (@InsuranceHealthPlanNumber is not null)                        
                 set @SQLSubQuery = @SQLSubQuery +' and IH.healthplannumber = '''+@InsuranceHealthPlanNumber+''''                             
   END        
   ELSE        
   BEGIN        
     IF @FirstName IS NOT NULL              
    set @SQLSubQuery = @SQLSubQuery + ' and (m.firstname like ''%'+@FirstName+'%'' OR m.lastname like ''%'+@FirstName+'%'')'              
     
    IF @LastName IS NOT NULL              
    set @SQLSubQuery = @SQLSubQuery + ' and (m.firstname like ''%'+@LastName+'%'' OR m.lastname like ''%'+@LastName+'%'')'              
                   
    IF @NHMemberID IS NOT NULL                             
      SET @SQLSubQuery = @SQLSubQuery + ' and  m.NHMemberID = '''+@NHMemberID+''''              
    IF @DateOfBirth is not null                          
        set @SQLSubQuery = @SQLSubQuery + ' and  m.DateOfBirth = '''+@DateOfBirth+''''              
    IF @ZipCode is not null                    
      set @SQLSubQuery = @SQLSubQuery + ' and  ml.ZipCode = '''+@ZipCode+''''              
    IF (@Phone is not null)                        
      set @SQLSubQuery = @SQLSubQuery+ ' and  p.phonenumber = '''+@Phone+''''              
    IF (@Address1 is not null)                                         
       set @SQLSubQuery = @SQLSubQuery + ' and  ml.Address1 = '''+@Address1+''''               
    IF (@Address2 is not null)                                
      set @SQLSubQuery = @SQLSubQuery +' and ml.Address2 = '''+@Address2+''''              
    IF (@City is not null)                                 
      set @SQLSubQuery = @SQLSubQuery +' and  ml.City = '''+@City+''''                     
    IF (@State is not null)                              
                 set @SQLSubQuery = @SQLSubQuery +' and ml.State = '''+@State+''''                
                    
    IF (@InsuranceHealthPlanNumber is not null)                              
                 set @SQLSubQuery = @SQLSubQuery +' and IH.healthplannumber = '''+@InsuranceHealthPlanNumber+''''             
   END          
 -- PRINT @SQLSubQuery               
  END              
              
  ELSE IF (@searchType = 'Advance')              
                 
   BEGIN              
    IF(@ProviderCode = '180000')        
       BEGIN            
   IF ((@FirstName IS NOT NULL) AND (@LastName IS NULL))              
   SET @SQLSubQuery = @SQLSubQuery + ' and  m.firstname like ''%'+@FirstName+'%'''              
   IF ((@FirstName IS NULL) AND (@LastName IS NOT NULL))              
   SET @SQLSubQuery = @SQLSubQuery + ' and  m.lastname like ''%'+@LastName+'%'''              
   IF ((@FirstName IS NOT NULL) AND (@LastName IS NOT NULL))              
   set @SQLSubQuery = @SQLSubQuery + ' and (m.firstname like ''%'+@FirstName+'%'' AND m.lastname like ''%'+@LastName+'%'')'              
  IF @NHMemberID IS NOT NULL                             
   SET @SQLSubQuery = @SQLSubQuery + ' and  m.NHMemberID = '''+@NHMemberID+''''              
  IF @DateOfBirth is not null                          
    set @SQLSubQuery = @SQLSubQuery + ' and  m.DateOfBirth = '''+@DateOfBirth+''''           
  IF @ZipCode is not null                          
    set @SQLSubQuery = @SQLSubQuery + ' and  ml.ZipCode = '''+@ZipCode+''''               
  IF (@Phone is not null)                        
    set @SQLSubQuery = @SQLSubQuery+ ' and  p.phonenumber = '''+@Phone+''''              
  IF (@Address1 is not null)                                         
    set @SQLSubQuery = @SQLSubQuery + ' and  ml.Address1 = '''+@Address1+''''                 
  IF (@Address2 is not null)                                
    set @SQLSubQuery = @SQLSubQuery +' and ml.Address2 = '''+@Address2+''''                 
  IF (@City is not null)                                 
    set @SQLSubQuery = @SQLSubQuery +' and  ml.City = '''+@City+''''                     
  IF (@State is not null)                              
                set @SQLSubQuery = @SQLSubQuery +' and ml.State = '''+@State+''''                
  IF (@InsuranceHealthPlanNumber is not null)                              
                 set @SQLSubQuery = @SQLSubQuery +' and IH.healthplannumber = '''+@InsuranceHealthPlanNumber+''''              
END              
ELSE        
BEGIN        
  IF ((@FirstName IS NOT NULL) AND (@LastName IS NULL))              
   SET @SQLSubQuery = @SQLSubQuery + ' and  m.firstname like ''%'+@FirstName+'%'''              
   IF ((@FirstName IS NULL) AND (@LastName IS NOT NULL))              
   SET @SQLSubQuery = @SQLSubQuery + ' and  m.lastname like ''%'+@LastName+'%'''              
   IF ((@FirstName IS NOT NULL) AND (@LastName IS NOT NULL))              
   set @SQLSubQuery = @SQLSubQuery + ' and (m.firstname like ''%'+@FirstName+'%'' AND m.lastname like ''%'+@LastName+'%'')'              
  IF @NHMemberID IS NOT NULL                             
   SET @SQLSubQuery = @SQLSubQuery + ' and  m.NHMemberID = '''+@NHMemberID+''''              
  IF @DateOfBirth is not null                          
    set @SQLSubQuery = @SQLSubQuery + ' and  m.DateOfBirth = '''+@DateOfBirth+''''           
  IF @ZipCode is not null                          
    set @SQLSubQuery = @SQLSubQuery + ' and  ml.ZipCode = '''+@ZipCode+''''               
  IF (@Phone is not null)                        
    set @SQLSubQuery = @SQLSubQuery+ ' and  p.phonenumber = '''+@Phone+''''              
  IF (@Address1 is not null)                                         
    set @SQLSubQuery = @SQLSubQuery + ' and  ml.Address1 = '''+@Address1+''''                 
  IF (@Address2 is not null)                                
    set @SQLSubQuery = @SQLSubQuery +' and ml.Address2 = '''+@Address2+''''                 
  IF (@City is not null)                                 
    set @SQLSubQuery = @SQLSubQuery +' and  ml.City = '''+@City+''''                     
  IF (@State is not null)                              
                set @SQLSubQuery = @SQLSubQuery +' and ml.State = '''+@State+''''                
  IF (@InsuranceHealthPlanNumber is not null)                              
                 set @SQLSubQuery = @SQLSubQuery +' and IH.healthplannumber = '''+@InsuranceHealthPlanNumber+''''            
END              
  END              
           
   IF(@ProviderCode = '180000')        
   BEGIN         
   SET @SQLSubQuery = 'select top 50 ROW_NUMBER() OVER (ORDER BY C.RowNum) as RowID,firstname,middlename,lastname,nhmemberid,DateOfBirth,address1,address2,city,state,phonenumber,zipcode,appointmentDate,AppointmentWith,ApptLocationAddress,healthplanname from ('+@SQLSubQuery+') C WHERE C.RowNum = 1 order by nhmemberid'        
   END        
   ELSE        
   BEGIN        
    SET @SQLSubQuery = 'select top 50 ROW_NUMBER() OVER (ORDER BY C.RowNum) as RowID,firstname,middlename,lastname,nhmemberid,DateOfBirth,address1,address2,city,state,phonenumber,zipcode,appointmentDate,AppointmentWith,ApptLocationAddress,healthplanname from ('+@SQLSubQuery+') C WHERE C.RowNum = 1 order by nhmemberid'         
   END        
           
           
           
  --PRINT @SQLSubQuery        
   exec sp_ExecuteSQL @SQLSubQuery        
           
           
             
    IF @@ERROR <> 0 GoTo ErrorHandler                        
    Set NoCount OFF                        
    Return(0)                        
                          
ErrorHandler:                  
    Return(@@ERROR)                        
                     
END 

CREATE Procedure [dbo].[sp_SearchMemberCall1](
	-- Add the parameters for the stored procedure here
	@MemberID           BIGINT = NULL, 
    @NHMemberID         NVARCHAR(50) = NULL, 
	@FirstName          NVARCHAR(250) = NULL,
    @LastName           NVARCHAR(50) = NULL,
	@DateOfBirth        DATETIME = NULL,
	@Gender             NVARCHAR(10) = NULL,
	@MaritalStatus      NVARCHAR(25) = NULL,
	@Address1           NVARCHAR(500) = NULL,
	@Address2           NVARCHAR(500) = NULL,
	@City               NVARCHAR(50) = NULL,
	@State              NVARCHAR(10) = NULL,
	@Country            NVARCHAR(50) = NULL,
	@ZipCode            NVARCHAR(10) = NULL, 
    @EmailAddress       NVARCHAR(50) = NULL, 
    @Phone               NVARCHAR(50) = NULL,
	@InsuranceHealthPlanNumber NVARCHAR(250) = NULL,
	@InsuranceHealthPlanName NVARCHAR(250) = NULL,
	@InsuranceCarrierName NVARCHAR(250) = NULL)
AS
BEGIN
	SET NOCOUNT ON;
	DECLARE @SQLQueryRes AS NVARCHAR(4000)
	DECLARE @SQLQuery AS NVARCHAR(4000)
	DECLARE @SQLQueryM AS NVARCHAR(2000)
	DECLARE @SQLQueryA AS NVARCHAR(2000)
	DECLARE @SQLQueryP AS NVARCHAR(2000)
	DECLARE @SQLQueryI AS NVARCHAR(2000)
	DECLARE @tables AS VARCHAR(50)
	DECLARE @Where AS VARCHAR(500)
	DECLARE @DateOfBirth1  AS VARCHAR(20) = NULL

	set @LastName = REPLACE(@LastName,'''','''''')

	set @FirstName = REPLACE(@FirstName,'''','''''')

	SET @DateOfBirth1 = cast(@DateOfBirth as datetime)


	SET @SQLQuery = 'SELECT DISTINCT TOP 100 M.MemberID, m.NHMEMBERID from '

	SET @SQLQueryM = 'Master.Members m where  1 = 1 '

	SET @SQLQueryP = 'Master.Members m , Master.PhoneNumbers p where 1 = 1 and m.memberid = p.memberid '

	SET @SQLQueryA = 'Master.Members m , Master.Addresses a where 1 = 1 and m.memberid = a.memberid '

	SET @SQLQueryI = 'master.members m where exists (select 1 from (
	select mi.memberid from master.MemberInsurances mi
	 where exists (select 1 from Master.MemberInsuranceDetails mid where 
								mid.memberinsuranceid = mi.id and mid.InsuranceNbr  = '

	if (@FirstName is not null )
		Begin
		set @tables = 'MEMBER'
		set @Where = ' and m.firstname like '''+@FirstName+'%'''
			if @ZipCode is not null 
				Begin
					set @tables = 'MEMBERADDRESS'
					set @Where = @Where + ' and a.ZipCode like '''+@ZipCode+'%'''
			    End
			else
				Begin
					if @LastName is not null
						set @Where = @Where + ' and m.lastname like '''+@LastName+'%'''
					if @DateOfBirth1 is not null
						set @Where = @Where + ' and m.DateOfBirth = cast('''+@DateOfBirth1+''''+' as datetime)'
				End
	    End
	else
 
if (@LastName is not null )
		Begin
		set @tables = 'MEMBER'
		set @Where = ' and m.lastname like '''+@LastName+'%'''
			if @ZipCode is not null 
				Begin
					set @tables = 'MEMBERADDRESS'
					set @Where = @Where + ' and a.ZipCode like '''+@ZipCode+'%'''
			    End
			else
				Begin
					if @FirstName is not null
						set @Where = @Where + ' and m.firstname like '''+@FirstName+'%'''
					if @DateOfBirth1 is not null
						set @Where = @Where + ' and m.DateOfBirth = cast('''+@DateOfBirth1+''''+' as datetime)'
				End
	    End
	else if (@DateOfBirth1 is not null)
		Begin
			set @tables = 'MEMBER'
			set @Where = ' and m.DateOfBirth = cast('''+@DateOfBirth1+''''+' as datetime)'
		End
	else if (@Phone is not null)
		Begin
			set @tables = 'PHONE'
			set @Where = ' and p.PhoneNbr = '+@Phone
		End
	else if (@Address1 is not null)
		Begin
			set @tables = 'ADDRESS'
			set @Where = ' and a.Address1 like '''+@Address1+'%'''
			if @ZipCode is not null
				set @Where = @Where + ' and a.ZipCode like '''+@ZipCode+'%'''
		End
	else if @InsuranceHealthPlanNumber is not null
		Begin
			set @tables = 'INSURANCE'
			set  @Where = @Where + ' and mid.InsuranceNbr like ''%'+@InsuranceHealthPlanNumber+'%'''
		End

	IF @tables = 'MEMBER'
		set @SQLQUERY = @SQLQUERY + @SQLQUERYM + @Where
	else if @tables = 'ADDRESS'
		set @SQLQUERY = @SQLQUERY + @SQLQUERYA + @Where
	else if @tables = 'PHONE'
		set @SQLQUERY = @SQLQUERY + @SQLQUERYP + @Where
	else if @tables = 'MEMBERADDRESS'
		set @SQLQUERY = @SQLQUERY + @SQLQUERYA + @Where
	else if @tables = 'INSURANCE'
		set @SQLQUERY = @SQLQUERY + @SQLQUERYI + @Where + ')) a where a.memberid = m.memberid)'
	else
		set @SQLQUERY = @SQLQUERY + '  master.members m'



	SET @SQLQueryRes = 'SELECT DISTINCT  TOP 100 M.MemberID,M.NHMemberID NhMemberNbr,M.FirstName,M.LastName,cast(cast(M.DateOfBirth as date) as varchar) DOB,
	       A.Address1 Address,A.Address2,A.City,A.State,A.Country,A.ZipCode zip,A.AddressTypeCode,
		   MD.InsuranceNbr PlanProgramID
	FROM [Master].Members M
	LEFT JOIN [Master].Addresses A on (M.MemberID=A.MemberID and a.IsPreferredAddress=1)
	LEFT JOIN [Master].MemberInsurances MI on M.MemberID=MI.MemberID
	LEFT JOIN [Master].MemberInsuranceDetails MD on MI.ID=MD.MemberInsuranceID
	 WHERE m.IsActive=1 and m.memberid in ( select memberid from (' + @SQLQuery + ')sq ) order  by LastName,FirstName'


 --and (A.AddressTypeCode=''HOME'' or A.AddressTypeCode=''PERM'')
	PRINT @SQLQueryRes
	
	EXECUTE sp_ExecuteSQL @SQLQueryRes
	

	 If @@ERROR <> 0 GoTo ErrorHandler
    Set NoCount OFF
    Return(0)
  
ErrorHandler:
    Return(@@ERROR)
END


--exec [dbo].[sp_SearchMemberCall]
--	@MemberID           = NULL, 
--    @NHMemberID         = NULL, 
--	@FirstName          = NULL,
--    @LastName           = 'DOW',
--	@DateOfBirth        = NULL,
--	@Gender             = NULL,
--	@MaritalStatus      = NULL,
--	@Address1           = NULL,
--	@Address2           = NULL,
--	@City               = NULL,
--	@State              = NULL,
--	@Country            = NULL,
--	@ZipCode            = NULL, 
--    @EmailAddress       = NULL, 
--    @Phone              = NULL,
--	@InsuranceHealthPlanNumber  = NULL,
--	@InsuranceHealthPlanName = NULL,
--	@InsuranceCarrierName = NULL
CREATE  procedure [dbo].[sp_GetBrands](@locationId bigint)
as
begin

 select ROW_NUMBER() OVER (ORDER BY BrandCode) as RowID,LocationId, BrandCode,Dispenser,IsActive,LocationAccountNumberId 
 from [provider].[LocationsAccountNbrs] where LocationId = @locationId and IsActive = 1
end


CREATE Procedure [dbo].[sp_SearchMemberCall_Test](
	-- Add the parameters for the stored procedure here
	@MemberID           BIGINT = NULL, 
    @NHMemberID         NVARCHAR(50) = NULL, 
	@FirstName          NVARCHAR(250) = NULL,
    @LastName           NVARCHAR(50) = NULL,
	@DateOfBirth        DATETIME = NULL,
	@Gender             NVARCHAR(10) = NULL,
	@MaritalStatus      NVARCHAR(25) = NULL,
	@Address1           NVARCHAR(500) = NULL,
	@Address2           NVARCHAR(500) = NULL,
	@City               NVARCHAR(50) = NULL,
	@State              NVARCHAR(10) = NULL,
	@Country            NVARCHAR(50) = NULL,
	@ZipCode            NVARCHAR(10) = NULL, 
    @EmailAddress       NVARCHAR(50) = NULL, 
    @Phone               NVARCHAR(50) = NULL,
	@InsuranceHealthPlanNumber NVARCHAR(250) = NULL,
	@InsuranceHealthPlanName NVARCHAR(250) = NULL,
	@InsuranceCarrierName NVARCHAR(250) = NULL)
AS
BEGIN
	SET NOCOUNT ON;
	DECLARE @SQLQueryRes AS NVARCHAR(4000)
	DECLARE @SQLQuery AS NVARCHAR(4000)
	DECLARE @SQLQueryM AS NVARCHAR(2000)
	DECLARE @SQLQueryA AS NVARCHAR(2000)
	DECLARE @SQLQueryP AS NVARCHAR(2000)
	DECLARE @SQLQueryI AS NVARCHAR(2000)
	DECLARE @tables AS VARCHAR(50)
	DECLARE @Where AS VARCHAR(500)
	DECLARE @DateOfBirth1  AS VARCHAR(20) = NULL

	set @LastName = REPLACE(@LastName,'''','''''')

	set @FirstName = REPLACE(@FirstName,'''','''''')

	SET @DateOfBirth1 = cast(@DateOfBirth as datetime)


	SET @SQLQuery = 'SELECT DISTINCT TOP 100 M.MemberID, m.NHMEMBERID from '

	SET @SQLQueryM = 'Master.Members m where  1 = 1 '

	SET @SQLQueryP = 'Master.Members m , Master.PhoneNumbers p where 1 = 1 and m.memberid = p.memberid '

	SET @SQLQueryA = 'Master.Members m , Master.Addresses a where 1 = 1 and m.memberid = a.memberid '

	SET @SQLQueryI = 'master.members m where exists (select 1 from (
	select mi.memberid from master.MemberInsurances mi
	 where exists (select 1 from Master.MemberInsuranceDetails mid where 
								mid.memberinsuranceid = mi.id and mid.InsuranceNbr  = '

	if (@FirstName is not null )
		Begin
		set @tables = 'MEMBER'
		set @Where = ' and m.firstname like '''+@FirstName+'%'''
			if @ZipCode is not null 
				Begin
					set @tables = 'MEMBERADDRESS'
					set @Where = @Where + ' and a.ZipCode like '''+@ZipCode+'%'''
			    End
			else
				Begin
					if @LastName is not null
						set @Where = @Where + ' and m.lastname like '''+@LastName+'%'''
					if @DateOfBirth1 is not null
						set @Where = @Where + ' and m.DateOfBirth = cast('''+@DateOfBirth1+''''+' as datetime)'
				End
	    End
	else
 
if (@LastName is not null )
		Begin
		set @tables = 'MEMBER'
		set @Where = ' and m.lastname like '''+@LastName+'%'''
			if @ZipCode is not null 
				Begin
					set @tables = 'MEMBERADDRESS'
					set @Where = @Where + ' and a.ZipCode like '''+@ZipCode+'%'''
			    End
			else
				Begin
					if @FirstName is not null
						set @Where = @Where + ' and m.firstname like '''+@FirstName+'%'''
					if @DateOfBirth1 is not null
						set @Where = @Where + ' and m.DateOfBirth = cast('''+@DateOfBirth1+''''+' as datetime)'
				End
	    End
	else if (@DateOfBirth1 is not null)
		Begin
			set @tables = 'MEMBER'
			set @Where = ' and m.DateOfBirth = cast('''+@DateOfBirth1+''''+' as datetime)'
		End
	else if (@Phone is not null)
		Begin
			set @tables = 'PHONE'
			set @Where = ' and p.PhoneNbr = '+@Phone
		End
	else if (@Address1 is not null)
		Begin
			set @tables = 'ADDRESS'
			set @Where = ' and a.Address1 like '''+@Address1+'%'''
			if @ZipCode is not null
				set @Where = @Where + ' and a.ZipCode like '''+@ZipCode+'%'''
		End
	else if @InsuranceHealthPlanNumber is not null
		Begin
			set @tables = 'INSURANCE'
			set  @Where = @Where + ' and mid.InsuranceNbr like ''%'+@InsuranceHealthPlanNumber+'%'''
		End

	IF @tables = 'MEMBER'
		set @SQLQUERY = @SQLQUERY + @SQLQUERYM + @Where
	else if @tables = 'ADDRESS'
		set @SQLQUERY = @SQLQUERY + @SQLQUERYA + @Where
	else if @tables = 'PHONE'
		set @SQLQUERY = @SQLQUERY + @SQLQUERYP + @Where
	else if @tables = 'MEMBERADDRESS'
		set @SQLQUERY = @SQLQUERY + @SQLQUERYA + @Where
	else if @tables = 'INSURANCE'
		set @SQLQUERY = @SQLQUERY + @SQLQUERYI + @Where + ')) a where a.memberid = m.memberid)'
	else
		set @SQLQUERY = @SQLQUERY + '  master.members m'



	SET @SQLQueryRes = 'SELECT DISTINCT  TOP 100 M.MemberID,M.NHMemberID NhMemberNbr,M.FirstName,M.LastName,cast(cast(M.DateOfBirth as date) as varchar) DOB,
	       A.Address1 Address,A.Address2,A.City,A.State,A.Country,A.ZipCode zip,A.AddressTypeCode,
		   MD.InsuranceNbr PlanProgramID, IC.InsuranceCarrierName,IH.HealthPlanName
	FROM [Master].Members M
	LEFT JOIN [Master].Addresses A on (M.MemberID=A.MemberID and a.IsPreferredAddress=1)
	LEFT JOIN [Master].MemberInsurances MI on M.MemberID=MI.MemberID
	LEFT JOIN [Master].MemberInsuranceDetails MD on MI.ID=MD.MemberInsuranceID
	LEFT JOIN Insurance.InsuranceCarriers IC on MI.InsuranceCarrierID=IC.InsuranceCarrierID
	LEFT JOIN Insurance.InsuranceHealthPlans IH on MI.InsuranceHealthPlanID=IH.InsuranceHealthPlanID
	 WHERE m.IsActive=1 and m.memberid in ( select memberid from (' + @SQLQuery + ')sq ) order  by LastName,FirstName'


 --and (A.AddressTypeCode=''HOME'' or A.AddressTypeCode=''PERM'')
	PRINT @SQLQueryRes
	
	EXECUTE sp_ExecuteSQL @SQLQueryRes
	

	 If @@ERROR <> 0 GoTo ErrorHandler
    Set NoCount OFF
    Return(0)
  
ErrorHandler:
    Return(@@ERROR)
END


	CREATE Procedure [dbo].[sp_upgraddiagrams]
	AS
	BEGIN
		IF OBJECT_ID(N'dbo.sysdiagrams') IS NOT NULL
			return 0;
	
		CREATE TABLE dbo.sysdiagrams
		(
			name sysname NOT NULL,
			principal_id int NOT NULL,	-- we may change it to varbinary(85)
			diagram_id int PRIMARY KEY IDENTITY,
			version int,
	
			definition varbinary(max)
			CONSTRAINT UK_principal_name UNIQUE
			(
				principal_id,
				name
			)
		);


		/* Add this if we need to have some form of extended properties for diagrams */
		/*
		IF OBJECT_ID(N'dbo.sysdiagram_properties') IS NULL
		BEGIN
			CREATE TABLE dbo.sysdiagram_properties
			(
				diagram_id int,
				name sysname,
				value varbinary(max) NOT NULL
			)
		END
		*/

		IF OBJECT_ID(N'dbo.dtproperties') IS NOT NULL
		begin
			insert into dbo.sysdiagrams
			(
				[name],
				[principal_id],
				[version],
				[definition]
			)
			select	 
				convert(sysname, dgnm.[uvalue]),
				DATABASE_PRINCIPAL_ID(N'dbo'),			-- will change to the sid of sa
				0,							-- zero for old format, dgdef.[version],
				dgdef.[lvalue]
			from dbo.[dtproperties] dgnm
				inner join dbo.[dtproperties] dggd on dggd.[property] = 'DtgSchemaGUID' and dggd.[objectid] = dgnm.[objectid]	
				inner join dbo.[dtproperties] dgdef on dgdef.[property] = 'DtgSchemaDATA' and dgdef.[objectid] = dgnm.[objectid]
				
			where dgnm.[property] = 'DtgSchemaNAME' and dggd.[uvalue] like N'_EA3E6268-D998-11CE-9454-00AA00A3F36E_' 
			return 2;
		end
		return 1;
	END
	
CREATE PROCEDURE [dbo].[sp_SearchMemberCall_testdelete](      
       @MemberID           BIGINT = NULL,       
       @NHMemberID         NVARCHAR(50) = NULL,       
       @FirstName          NVARCHAR(250) = NULL,      
       @LastName           NVARCHAR(50) = NULL,      
       @DateOfBirth        DATETIME = NULL,      
       @Gender             NVARCHAR(10) = NULL,      
       @MaritalStatus      NVARCHAR(25) = NULL,      
       @Address1           NVARCHAR(500) = NULL,      
       @Address2           NVARCHAR(500) = NULL,      
       @City               NVARCHAR(50) = NULL,      
       @State              NVARCHAR(10) = NULL,      
       @Country            NVARCHAR(50) = NULL,      
       @ZipCode            NVARCHAR(10) = NULL,       
       @EmailAddress       NVARCHAR(50) = NULL,       
       @Phone               NVARCHAR(50) = NULL,      
       @InsuranceHealthPlanNumber NVARCHAR(250) = NULL,      
       @InsuranceHealthPlanName NVARCHAR(250) = NULL,      
       @InsuranceCarrierName NVARCHAR(250) = NULL,      
       @OrderID BIGINT = 0)      
AS      
BEGIN      
       SET NOCOUNT ON;      
      SET ANSI_WARNINGS OFF;    
       DECLARE @SQLQueryRes AS NVARCHAR(4000)      
       DECLARE @SQLQuery AS NVARCHAR(4000)      
       DECLARE @SQLQueryM AS NVARCHAR(2000)      
       DECLARE @SQLQueryA AS NVARCHAR(2000)      
       DECLARE @SQLQueryP AS NVARCHAR(2000)      
       DECLARE @SQLQueryI AS NVARCHAR(2000)      
       DECLARE @tables AS VARCHAR(50)      
       DECLARE @Where AS VARCHAR(500)      
       DECLARE @DateOfBirth1  AS VARCHAR(20) = NULL      
      
       set @LastName = REPLACE(@LastName,'''','''''')      
      
       set @FirstName = REPLACE(@FirstName,'''','''''')      
      
       SET @DateOfBirth1 = cast(@DateOfBirth as datetime)      
      
      
       SET @SQLQuery = 'SELECT DISTINCT TOP 100 M.MemberID, m.NHMEMBERID from '      
      
       SET @SQLQueryM = 'Master.Members m where  1 = 1 '      
      
       SET @SQLQueryP = 'Master.Members m , Master.PhoneNumbers p where 1 = 1 and m.memberid = p.memberid '      
      
       SET @SQLQueryA = 'Master.Members m , Master.Addresses a where 1 = 1 and m.memberid = a.memberid '      
      
       SET @SQLQueryI = 'master.members m where exists (select 1 from (      
       select mi.memberid from master.MemberInsurances mi      
       where exists (select 1 from Master.MemberInsuranceDetails mid where       
                                                       mid.memberinsuranceid = mi.id and mid.InsuranceNbr  = '      
      
       if (@FirstName is not null )      
              Begin      
              set @tables = 'MEMBER'      
              set @Where = ' and m.firstname like '''+@FirstName+'%'''      
                     if @ZipCode is not null       
                           Begin      
                                  set @tables = 'MEMBERADDRESS'      
                                  set @Where = @Where + ' and a.ZipCode like '''+@ZipCode+'%'''      
                         End      
                     else      
                           Begin      
                                  if @LastName is not null      
                                         set @Where = @Where + ' and m.lastname like '''+@LastName+'%'''      
                                  if @DateOfBirth1 is not null      
                                         set @Where = @Where + ' and m.DateOfBirth = cast('''+@DateOfBirth1+''''+' as datetime)'      
                           End      
           End      
       else      
      
if (@LastName is not null )      
              Begin      
              set @tables = 'MEMBER'      
              set @Where = ' and m.lastname like '''+@LastName+'%'''      
                     if @ZipCode is not null       
                           Begin      
                                  set @tables = 'MEMBERADDRESS'      
                                  set @Where = @Where + ' and a.ZipCode like '''+@ZipCode+'%'''      
                         End      
                     else      
                           Begin      
                                  if @FirstName is not null      
                                         set @Where = @Where + ' and m.firstname like '''+@FirstName+'%'''      
                                  if @DateOfBirth1 is not null      
               set @Where = @Where + ' and m.DateOfBirth = cast('''+@DateOfBirth1+''''+' as datetime)'      
                           End      
           End      
       else if (@DateOfBirth1 is not null)      
              Begin      
                     set @tables = 'MEMBER'      
                     set @Where = ' and m.DateOfBirth = cast('''+@DateOfBirth1+''''+' as datetime)'      
              End      
       else if (@Phone is not null)      
              Begin      
                     set @tables = 'PHONE'      
                     set @Where = ' and p.PhoneNbr = '+@Phone      
              End      
       else if (@Address1 is not null)      
              Begin      
                     set @tables = 'ADDRESS'      
                     set @Where = ' and a.Address1 like '''+@Address1+'%'''      
                     if @ZipCode is not null      
                           set @Where = @Where + ' and a.ZipCode like '''+@ZipCode+'%'''     
         set @ZipCode = NULL   
              End    
      else if (@Address2 is not null)      
              Begin      
                     set @tables = 'ADDRESS'      
                     set @Where = ' and a.Address2 like '''+@Address2+'%'''      
                     if @ZipCode is not null      
                           set @Where = @Where + ' and a.ZipCode like '''+@ZipCode+'%'''   
         set @ZipCode = NULL     
              End   
      else if (@City is not null)      
              Begin      
                     set @tables = 'ADDRESS'      
                     set @Where = ' and a.City like '''+@City+'%'''      
                     if @ZipCode is not null      
                           set @Where = @Where + ' and a.ZipCode like '''+@ZipCode+'%'''      
         set @ZipCode = NULL  
              End    
      else if (@State is not null)      
              Begin      
                     set @tables = 'ADDRESS'      
                     set @Where = ' and a.State like '''+@State+'%'''      
                     if @ZipCode is not null      
                           set @Where = @Where + ' and a.ZipCode like '''+@ZipCode+'%'''    
         set @ZipCode = NULL    
              End              
    
        
            
      
       IF @tables = 'MEMBER'      
              set @SQLQUERY = @SQLQUERY + @SQLQUERYM + @Where      
       else if @tables = 'ADDRESS'      
              set @SQLQUERY = @SQLQUERY + @SQLQUERYA + @Where      
       else if @tables = 'PHONE'      
              set @SQLQUERY = @SQLQUERY + @SQLQUERYP + @Where      
       else if @tables = 'MEMBERADDRESS'      
              set @SQLQUERY = @SQLQUERY + @SQLQUERYA + @Where      
       else if @tables = 'INSURANCE'      
              set @SQLQUERY = @SQLQUERY + @SQLQUERYI + @Where + ')) a where a.memberid = m.memberid)'      
       else      
              set @SQLQUERY = @SQLQUERY + '  master.members m'      
      
     --- Added BY MOIN (Code to Search By NHMemberID)    
  IF @NHMemberID IS NOT NULL    
  BEGIN    
   IF @Where IS NOT NULL    
   BEGIN    
   SET @SQLQUERY = @SQLQUERY + ' ' + 'AND m.NHMemberID = '''+@NHMemberID+''''    
   END    
   ELSE    
   BEGIN    
    SET @SQLQUERY = @SQLQUERY + ' ' + 'where m.NHMemberID = '''+@NHMemberID+''''    
   END    
  END    
  --- END Added by MOIN    
 IF @InsuranceHealthPlanNumber IS NOT NULL
 BEGIN
  print @SQLQUERY
  print @SQLQueryRes
  SET @SQLQUERY = @SQLQUERY + ' '  + 'where md.InsuranceNbr like ''%'+@InsuranceHealthPlanNumber+'%''' 
  SET @SQLQUERY = (SELECT REPLACE(@SQLQuery,'TOP 100',''))      
 END

 IF @ZipCode IS NOT NULL  
   BEGIN  
    SET @SQLQUERY = (SELECT REPLACE(@SQLQuery,'TOP 100','')) 
    SET @SQLQUERY = @SQLQUERY + ' ' + 'where a.ZipCode LIKE '''+@ZipCode+'%'''   
   END  
                    
    IF (@OrderID > 0)      
       BEGIN      
       DECLARE @Order VARCHAR(10);      
       SET @Order = CAST(@OrderID AS VARCHAR(10))      
    IF(@SQLQuery = 'SELECT DISTINCT TOP 100 M.MemberID, m.NHMEMBERID from   master.members m')      
    BEGIN      
      SET @SQLQueryRes = 'SELECT TOP 1 M.MemberID,CAST(1 AS BIGINT) AS RowID,  
   M.NHMemberID NhMemberNbr,M.FirstName,M.LastName,convert(varchar,(M.DateOfBirth),101) DOB,      
              A.Address1 Address,A.Address2,A.City,A.State,A.Country,A.ZipCode zip,A.AddressTypeCode,      
                 MD.InsuranceNbr PlanProgramID, IC.InsuranceCarrierName,IH.HealthPlanName,ISNULL(O.OrderID,0) AS OrderNumber      
       FROM [Master].Members M      
       LEFT JOIN Orders.Orders O	WITH (NOLOCK)  ON O.NHMemberId = M.NHMemberID         
       LEFT JOIN [Master].Addresses A	WITH (NOLOCK)  on (M.MemberID=A.MemberID and a.IsPreferredAddress=1)      
       LEFT JOIN [Master].MemberInsurances MI	WITH (NOLOCK)  on M.MemberID=MI.MemberID      
       LEFT JOIN [Master].MemberInsuranceDetails MD	WITH (NOLOCK)  on MI.ID=MD.MemberInsuranceID      
       LEFT JOIN Insurance.InsuranceCarriers IC	WITH (NOLOCK)  on MI.InsuranceCarrierID=IC.InsuranceCarrierID      
       LEFT JOIN Insurance.InsuranceHealthPlans IH	WITH (NOLOCK)  on MI.InsuranceHealthPlanID=IH.InsuranceHealthPlanID      
       WHERE m.IsActive=1 AND O.OrderID ='+@Order+' order  by LastName,FirstName'      
    END      
    ELSE      
    BEGIN      
       SET @SQLQueryRes = 'SELECT DISTINCT TOP 1 M.MemberID,ROW_NUMBER() OVER (ORDER BY MD.InsuranceNbr) RowID,M.NHMemberID NhMemberNbr,M.FirstName,M.LastName,convert(varchar,(M.DateOfBirth),101) DOB,      
              A.Address1 Address,A.Address2,A.City,A.State,A.Country,A.ZipCode zip,A.AddressTypeCode,      
                 MD.InsuranceNbr PlanProgramID, IC.InsuranceCarrierName,IH.HealthPlanName,ISNULL(O.OrderID,0) AS OrderNumber      
       FROM [Master].Members M      
       LEFT JOIN Orders.Orders O	WITH (NOLOCK)  ON O.NHMemberId = M.NHMemberID         
       LEFT JOIN [Master].Addresses A	WITH (NOLOCK)  on (M.MemberID=A.MemberID and a.IsPreferredAddress=1)      
       LEFT JOIN [Master].MemberInsurances MI	WITH (NOLOCK)  on M.MemberID=MI.MemberID      
       LEFT JOIN [Master].MemberInsuranceDetails MD	WITH (NOLOCK)  on MI.ID=MD.MemberInsuranceID      
       LEFT JOIN Insurance.InsuranceCarriers IC	WITH (NOLOCK)  on MI.InsuranceCarrierID=IC.InsuranceCarrierID      
       LEFT JOIN Insurance.InsuranceHealthPlans IH	WITH (NOLOCK)  on MI.InsuranceHealthPlanID=IH.InsuranceHealthPlanID      
       WHERE m.IsActive=1 AND O.OrderID ='+@Order+'  AND m.memberid in ( select memberid from (' + @SQLQuery + ')sq ) order  by LastName,FirstName'      
    END      
       END      
       ELSE      
       BEGIN      
       SET @SQLQueryRes = 'SELECT DISTINCT  TOP 50 M.MemberID,ROW_NUMBER() OVER (ORDER BY MD.InsuranceNbr) RowID,M.NHMemberID NhMemberNbr,M.FirstName,M.LastName,convert(varchar,(M.DateOfBirth),101) DOB,      
              A.Address1 Address,A.Address2,A.City,A.State,A.Country,A.ZipCode zip,A.AddressTypeCode,      
                 MD.InsuranceNbr PlanProgramID, IC.InsuranceCarrierName,IH.HealthPlanName,ISNULL(MAX(O.OrderID),0) AS OrderNumber      
       FROM [Master].Members M      
       LEFT JOIN Orders.Orders O	WITH (NOLOCK)  ON O.NHMemberId = M.NHMemberID         
       LEFT JOIN [Master].Addresses A	WITH (NOLOCK)  on (M.MemberID=A.MemberID and a.IsPreferredAddress=1)      
       LEFT JOIN [Master].MemberInsurances MI	WITH (NOLOCK)  on M.MemberID=MI.MemberID      
       LEFT JOIN [Master].MemberInsuranceDetails MD	WITH (NOLOCK)  on MI.ID=MD.MemberInsuranceID      
       LEFT JOIN Insurance.InsuranceCarriers IC	WITH (NOLOCK)  on MI.InsuranceCarrierID=IC.InsuranceCarrierID      
       LEFT JOIN Insurance.InsuranceHealthPlans IH	WITH (NOLOCK)  on MI.InsuranceHealthPlanID=IH.InsuranceHealthPlanID      
       WHERE m.IsActive=1 AND m.memberid in ( select memberid from (' + @SQLQuery + ')sq )       
       group by M.MemberID,M.NHMemberID,M.FirstName,M.LastName,A.Address1,A.Address2,A.City,A.State,A.Country,A.ZipCode,A.AddressTypeCode,      
       MD.InsuranceNbr, IC.InsuranceCarrierName,IH.HealthPlanName,M.DateOfBirth order by LastName,FirstName'      
       END      
      
  IF @NHMemberID IS NOT NULL    
  BEGIN  
  SET @SQLQueryRes = (SELECT REPLACE(@SQLQueryRes,'TOP 50','TOP 1'))  
  --SET @SQLQueryRes = (SELECT REPLACE(@SQLQueryRes,'where a.ZipCode','and a.ZipCode'))
  END  
  
  PRINT @SQLQueryRes      
             
   EXECUTE sp_ExecuteSQL @SQLQueryRes      
             
      
    IF @@ERROR <> 0 GoTo ErrorHandler      
    Set NoCount OFF      
    Return(0)      
        
ErrorHandler:      
    Return(@@ERROR)      
END 
-- =============================================
-- Author:      Ramu K
-- Create Date: 03-01-2018
-- Description: Gets all the brands from view
-- =============================================
CREATE PROCEDURE [dbo].[V_GetBrands]
AS
BEGIN
    -- SET NOCOUNT ON added to prevent extra result sets from
    -- interfering with SELECT statements.
    SET NOCOUNT ON

	select distinct brand from [catalog].[viewModelList]

END



CREATE PROCEDURE [dbo].[sp_SearchMemberCall_TestDelete1](      
       @MemberID           BIGINT = NULL,       
       @NHMemberID         NVARCHAR(50) = NULL,       
       @FirstName          NVARCHAR(250) = NULL,      
       @LastName           NVARCHAR(50) = NULL,      
       @DateOfBirth        DATETIME = NULL,      
       @Gender             NVARCHAR(10) = NULL,      
       @MaritalStatus      NVARCHAR(25) = NULL,      
       @Address1           NVARCHAR(500) = NULL,      
       @Address2           NVARCHAR(500) = NULL,      
       @City               NVARCHAR(50) = NULL,      
       @State              NVARCHAR(10) = NULL,      
       @Country            NVARCHAR(50) = NULL,      
       @ZipCode            NVARCHAR(10) = NULL,       
       @EmailAddress       NVARCHAR(50) = NULL,       
       @Phone               NVARCHAR(50) = NULL,      
       @InsuranceHealthPlanNumber NVARCHAR(250) = NULL,      
       @InsuranceHealthPlanName NVARCHAR(250) = NULL,      
       @InsuranceCarrierName NVARCHAR(250) = NULL,      
       @OrderID BIGINT = 0)      
AS      
BEGIN      
       SET NOCOUNT ON;      
      SET ANSI_WARNINGS OFF;    
       DECLARE @SQLQueryRes AS NVARCHAR(4000)      
       DECLARE @SQLQuery AS NVARCHAR(4000)      
       DECLARE @SQLQueryM AS NVARCHAR(2000)      
       DECLARE @SQLQueryA AS NVARCHAR(2000)      
       DECLARE @SQLQueryP AS NVARCHAR(2000)      
       DECLARE @SQLQueryI AS NVARCHAR(2000)      
       DECLARE @tables AS VARCHAR(50)      
       DECLARE @Where AS VARCHAR(500)      
       DECLARE @DateOfBirth1  AS VARCHAR(20) = NULL      
      
       set @LastName = REPLACE(@LastName,'''','''''')      
      
       set @FirstName = REPLACE(@FirstName,'''','''''')      
      
       SET @DateOfBirth1 = cast(@DateOfBirth as datetime)      
      
      
       SET @SQLQuery = 'SELECT DISTINCT TOP 100 M.MemberID, m.NHMEMBERID from '      
      
       SET @SQLQueryM = 'Master.Members m where  1 = 1 '      
      
       SET @SQLQueryP = 'Master.Members m , Master.PhoneNumbers p where 1 = 1 and m.memberid = p.memberid '      
      
       SET @SQLQueryA = 'Master.Members m , Master.Addresses a where 1 = 1 and m.memberid = a.memberid '      
      
       SET @SQLQueryI = 'master.members m where exists (select 1 from (      
       select mi.memberid from master.MemberInsurances mi      
       where exists (select 1 from Master.MemberInsuranceDetails mid where       
                                                       mid.memberinsuranceid = mi.id and mid.InsuranceNbr  = '      
      
       if (@FirstName is not null )      
              Begin      
              set @tables = 'MEMBER'      
              set @Where = ' and m.firstname like '''+@FirstName+'%'''      
                     if @ZipCode is not null       
                           Begin      
                                  set @tables = 'MEMBERADDRESS'      
                                  set @Where = @Where + ' and a.ZipCode like '''+@ZipCode+'%'''      
                         End      
                     else      
                           Begin      
                                  if @LastName is not null      
                                         set @Where = @Where + ' and m.lastname like '''+@LastName+'%'''      
                                  if @DateOfBirth1 is not null      
                                         set @Where = @Where + ' and m.DateOfBirth = cast('''+@DateOfBirth1+''''+' as datetime)'      
                           End      
           End      
       else      
      
if (@LastName is not null )      
              Begin      
              set @tables = 'MEMBER'      
              set @Where = ' and m.lastname like '''+@LastName+'%'''      
                     if @ZipCode is not null       
                           Begin      
                                  set @tables = 'MEMBERADDRESS'      
                                  set @Where = @Where + ' and a.ZipCode like '''+@ZipCode+'%'''      
                         End      
                     else      
                           Begin      
                                  if @FirstName is not null      
                                         set @Where = @Where + ' and m.firstname like '''+@FirstName+'%'''      
                                  if @DateOfBirth1 is not null      
               set @Where = @Where + ' and m.DateOfBirth = cast('''+@DateOfBirth1+''''+' as datetime)'      
                           End      
           End      
       else if (@DateOfBirth1 is not null)      
              Begin      
                     set @tables = 'MEMBER'      
                     set @Where = ' and m.DateOfBirth = cast('''+@DateOfBirth1+''''+' as datetime)'      
              End      
       else if (@Phone is not null)      
              Begin      
                     set @tables = 'PHONE'      
                     set @Where = ' and p.PhoneNbr = '+@Phone      
              End      
       else if (@Address1 is not null)      
              Begin      
                     set @tables = 'ADDRESS'      
                     set @Where = ' and a.Address1 like '''+@Address1+'%'''      
                     if @ZipCode is not null      
                           set @Where = @Where + ' and a.ZipCode like '''+@ZipCode+'%'''     
         set @ZipCode = NULL   
              End    
      else if (@Address2 is not null)      
              Begin      
                     set @tables = 'ADDRESS'      
                     set @Where = ' and a.Address2 like '''+@Address2+'%'''      
                     if @ZipCode is not null      
                           set @Where = @Where + ' and a.ZipCode like '''+@ZipCode+'%'''   
         set @ZipCode = NULL     
              End   
      else if (@City is not null)      
              Begin      
                     set @tables = 'ADDRESS'      
                     set @Where = ' and a.City like '''+@City+'%'''      
                     if @ZipCode is not null      
                           set @Where = @Where + ' and a.ZipCode like '''+@ZipCode+'%'''      
         set @ZipCode = NULL  
              End    
      else if (@State is not null)      
              Begin      
                     set @tables = 'ADDRESS'      
                     set @Where = ' and a.State like '''+@State+'%'''      
                     if @ZipCode is not null      
                           set @Where = @Where + ' and a.ZipCode like '''+@ZipCode+'%'''    
         set @ZipCode = NULL    
              End              
    
        
            
      
       IF @tables = 'MEMBER'      
              set @SQLQUERY = @SQLQUERY + @SQLQUERYM + @Where      
       else if @tables = 'ADDRESS'      
              set @SQLQUERY = @SQLQUERY + @SQLQUERYA + @Where      
       else if @tables = 'PHONE'      
              set @SQLQUERY = @SQLQUERY + @SQLQUERYP + @Where      
       else if @tables = 'MEMBERADDRESS'      
              set @SQLQUERY = @SQLQUERY + @SQLQUERYA + @Where      
       else if @tables = 'INSURANCE'      
              set @SQLQUERY = @SQLQUERY + @SQLQUERYI + @Where + ')) a where a.memberid = m.memberid)'      
       else      
              set @SQLQUERY = @SQLQUERY + '  master.members m'      
      
     --- Added BY MOIN (Code to Search By NHMemberID)    
  IF @NHMemberID IS NOT NULL    
  BEGIN    
   IF @Where IS NOT NULL    
   BEGIN    
   SET @SQLQUERY = @SQLQUERY + ' ' + 'AND m.NHMemberID = '''+@NHMemberID+''''    
   END    
   ELSE    
   BEGIN    
    SET @SQLQUERY = @SQLQUERY + ' ' + 'where m.NHMemberID = '''+@NHMemberID+''''    
   END    
  END    
  --- END Added by MOIN    
 IF @InsuranceHealthPlanNumber IS NOT NULL
 BEGIN
  print @SQLQUERY
  print @SQLQueryRes
  SET @SQLQUERY = @SQLQUERY + ' '  + 'where md.InsuranceNbr like ''%'+@InsuranceHealthPlanNumber+'%''' 
  SET @SQLQUERY = (SELECT REPLACE(@SQLQuery,'TOP 100',''))      
 END

 IF @ZipCode IS NOT NULL  
   BEGIN  
    SET @SQLQUERY = (SELECT REPLACE(@SQLQuery,'TOP 100','')) 
    SET @SQLQUERY = @SQLQUERY + ' ' + 'where a.ZipCode LIKE '''+@ZipCode+'%'''   
   END  
                    
    IF (@OrderID > 0)      
       BEGIN      
       DECLARE @Order VARCHAR(10);      
       SET @Order = CAST(@OrderID AS VARCHAR(10))      
    IF(@SQLQuery = 'SELECT DISTINCT TOP 100 M.MemberID, m.NHMEMBERID from   master.members m')      
    BEGIN      
      SET @SQLQueryRes = 'SELECT TOP 1 M.MemberID,CAST(1 AS BIGINT) AS RowID,  
   M.NHMemberID NhMemberNbr,M.FirstName,M.LastName,convert(varchar,(M.DateOfBirth),101) DOB,      
              A.Address1 Address,A.Address2,A.City,A.State,A.Country,A.ZipCode zip,A.AddressTypeCode,      
                 MD.InsuranceNbr PlanProgramID, IC.InsuranceCarrierName,IH.HealthPlanName,ISNULL(O.OrderID,0) AS OrderNumber      
       FROM [Master].Members M      
       LEFT JOIN Orders.Orders O ON O.NHMemberId = M.NHMemberID         
       LEFT JOIN [Master].Addresses A on (M.MemberID=A.MemberID and a.IsPreferredAddress=1)      
       LEFT JOIN [Master].MemberInsurances MI on M.MemberID=MI.MemberID      
       LEFT JOIN [Master].MemberInsuranceDetails MD on MI.ID=MD.MemberInsuranceID      
       LEFT JOIN Insurance.InsuranceCarriers IC on MI.InsuranceCarrierID=IC.InsuranceCarrierID      
       LEFT JOIN Insurance.InsuranceHealthPlans IH on MI.InsuranceHealthPlanID=IH.InsuranceHealthPlanID      
       WHERE m.IsActive=1 AND O.OrderID ='+@Order+' order  by LastName,FirstName'      
    END      
    ELSE      
    BEGIN      
       SET @SQLQueryRes = 'SELECT DISTINCT TOP 1 M.MemberID,ROW_NUMBER() OVER (ORDER BY MD.InsuranceNbr) RowID,M.NHMemberID NhMemberNbr,M.FirstName,M.LastName,convert(varchar,(M.DateOfBirth),101) DOB,      
              A.Address1 Address,A.Address2,A.City,A.State,A.Country,A.ZipCode zip,A.AddressTypeCode,      
                 MD.InsuranceNbr PlanProgramID, IC.InsuranceCarrierName,IH.HealthPlanName,ISNULL(O.OrderID,0) AS OrderNumber      
       FROM [Master].Members M      
       LEFT JOIN Orders.Orders O ON O.NHMemberId = M.NHMemberID         
       LEFT JOIN [Master].Addresses A on (M.MemberID=A.MemberID and a.IsPreferredAddress=1)      
       LEFT JOIN [Master].MemberInsurances MI on M.MemberID=MI.MemberID      
       LEFT JOIN [Master].MemberInsuranceDetails MD on MI.ID=MD.MemberInsuranceID      
       LEFT JOIN Insurance.InsuranceCarriers IC on MI.InsuranceCarrierID=IC.InsuranceCarrierID      
       LEFT JOIN Insurance.InsuranceHealthPlans IH on MI.InsuranceHealthPlanID=IH.InsuranceHealthPlanID      
       WHERE m.IsActive=1 AND O.OrderID ='+@Order+'  AND m.memberid in ( select memberid from (' + @SQLQuery + ')sq ) order  by LastName,FirstName'      
    END      
       END      
       ELSE      
       BEGIN      
       SET @SQLQueryRes = 'SELECT DISTINCT  TOP 50 M.MemberID,ROW_NUMBER() OVER (ORDER BY MD.InsuranceNbr) RowID,M.NHMemberID NhMemberNbr,M.FirstName,M.LastName,convert(varchar,(M.DateOfBirth),101) DOB,      
              A.Address1 Address,A.Address2,A.City,A.State,A.Country,A.ZipCode zip,A.AddressTypeCode,      
                 MD.InsuranceNbr PlanProgramID, IC.InsuranceCarrierName,IH.HealthPlanName,ISNULL(MAX(O.OrderID),0) AS OrderNumber      
       FROM [Master].Members M      
       LEFT JOIN Orders.Orders O ON O.NHMemberId = M.NHMemberID         
       LEFT JOIN [Master].Addresses A on (M.MemberID=A.MemberID and a.IsPreferredAddress=1)      
       LEFT JOIN [Master].MemberInsurances MI on M.MemberID=MI.MemberID      
       LEFT JOIN [Master].MemberInsuranceDetails MD on MI.ID=MD.MemberInsuranceID      
       LEFT JOIN Insurance.InsuranceCarriers IC on MI.InsuranceCarrierID=IC.InsuranceCarrierID      
       LEFT JOIN Insurance.InsuranceHealthPlans IH on MI.InsuranceHealthPlanID=IH.InsuranceHealthPlanID      
       WHERE m.IsActive=1 AND m.memberid in ( select memberid from (' + @SQLQuery + ')sq )       
       group by M.MemberID,M.NHMemberID,M.FirstName,M.LastName,A.Address1,A.Address2,A.City,A.State,A.Country,A.ZipCode,A.AddressTypeCode,      
       MD.InsuranceNbr, IC.InsuranceCarrierName,IH.HealthPlanName,M.DateOfBirth order by LastName,FirstName'      
       END      
      
  IF @NHMemberID IS NOT NULL    
  BEGIN  
  SET @SQLQueryRes = (SELECT REPLACE(@SQLQueryRes,'TOP 50','TOP 1'))  
  --SET @SQLQueryRes = (SELECT REPLACE(@SQLQueryRes,'where a.ZipCode','and a.ZipCode'))
  END  
  
  PRINT @SQLQueryRes      
             
   EXECUTE sp_ExecuteSQL @SQLQueryRes      
             
      
    IF @@ERROR <> 0 GoTo ErrorHandler      
    Set NoCount OFF      
    Return(0)      
        
ErrorHandler:      
    Return(@@ERROR)      
END 
-- =======================================================
-- Create Stored Procedure Template for Azure SQL Database
-- =======================================================
-- =============================================
-- Author:      BHANU PRAKASH INTURI
-- Create Date: 15-NOV-2017
-- Description: INSERT CALL CENTER AGENT SCRIPTS
--select * from [CallCenter].[AgentScripts]
-- =============================================
CREATE Procedure [dbo].[DeleteAgentScripts]
(
    -- Add the parameters for the stored procedure here
   @scriptID BIGINT,  
   @operationType NVARCHAR(10)

)
AS
BEGIN
    -- SET NOCOUNT ON added to prevent extra result sets from
    -- interfering with SELECT statements.
    SET NOCOUNT ON
	    -- Insert statements for procedure here
    
	IF @operationType = 'DELETE'
	BEGIN
	UPDATE [CallCenter].[AgentScripts] 
	SET 
	IsActive = 0	
	WHERE ScriptID = @scriptID
	END
END

-- ================================================
-- Template generated from Template Explorer using:
-- Alter Procedure (New Menu).SQL
--
-- Use the Specify Values for Template Parameters 
-- command (Ctrl-Shift-M) to fill in the parameter 
-- values below.
--
-- This block of comments will not be included in
-- the definition of the procedure.
-- ================================================
-- =====================================================================================================
-- Author:      BHANU PRAKASH INTURI
-- Create Date: 13-NOV-2017
-- Description: SOFT DELETE FOR INSURANCE CARRIER DETAILS IN PRODUCTION
  --SELECT * FROM [INSURANCE].[InsuranceCarriers]
  		-- @insuranceCarrierID, @isActive, @operationType
--EXEC DeleteInsCarriers 9, 1, 'DELETE'
-- =====================================================================================================
CREATE Procedure [dbo].[DeleteInsCarriers]
	-- Add the parameters for the stored procedure here				
				 @insuranceCarrierID BIGINT = 0,
				 @operationType Nvarchar(10)
				 				
AS
BEGIN
	-- SET NOCOUNT ON added to prevent extra result sets from
	-- interfering with SELECT statements.
	SET NOCOUNT ON;
    -- Insert statements for procedure here
	IF @operationType = 'DELETE'
	BEGIN
		UPDATE [Insurance].[InsuranceCarriers] 
		SET IsActive = 0
		WHERE InsuranceCarrierID = @insuranceCarrierID	
	END
END

-- ================================================
-- Template generated from Template Explorer using:
-- Alter Procedure (New Menu).SQL
--
-- Use the Specify Values for Template Parameters 
-- command (Ctrl-Shift-M) to fill in the parameter 
-- values below.
--
-- This block of comments will not be included in
-- the definition of the procedure.
-- ================================================

-- =====================================================================================================
-- Author:      BHANU PRAKASH INTURI
-- Create Date: 13-NOV-2017
-- Description: SCRIPTS FOR EXECUTE INSURANCE HEALTH PLAN BENEFIT DETAILS IN PRODUCTION
--SELECT * FROM Insurance.ContractBenefits
--	@ContractBenefitID , @operationType
 
 --EXEC DeleteInsHealthPlanBenefits 20035,  'DELETE'

-- =====================================================================================================
CREATE Procedure [dbo].[DeleteInsHealthPlanBenefits]
	-- Add the parameters for the stored procedure here	
				@ContractBenefitID	bigint = 0,	
				@operationType nVarchar(10)	
			
AS
BEGIN
	-- SET NOCOUNT ON added to prevent extra result sets from
	-- interfering with SELECT statements.
	SET NOCOUNT ON;
    -- Insert statements for procedure here
	IF @operationType = 'DELETE'
	BEGIN		
		UPDATE  [Insurance].[ContractBenefits] 
		SET		IsActive = 0								
		WHERE   ContractBenefitID = @ContractBenefitID
	END	
END
-- =====================================================================================================
-- Author:      BHANU PRAKASH INTURI
-- Create Date: 13-NOV-2017
-- Description: SCRIPTS FOR EXECUTE INSURANCE HEALTH PLAN DETAILS IN PRODUCTION
-- SELECT * FROM [INSURANCE].[InsuranceHealthPlans]
-- SERIAL WISE -->  @createDateTime, @createSource, @insuranceHealthPlanID [If Insert it will be 0], @healthPlanName, @healthPlanNumber, @insuranceCarrierID, @operationType
-- EXEC DeleteInsHealthPlans 38,  'DELETE'

-- =====================================================================================================
CREATE Procedure [dbo].[DeleteInsHealthPlans]
	-- Add the parameters for the stored procedure here	             
				
				 @insuranceHealthPlanID bigint = 0,				
				 @isActive BIT,								
				 @operationType Nvarchar(10)
				 				
AS
BEGIN
	-- SET NOCOUNT ON added to prevent extra result sets from
	-- interfering with SELECT statements.
	SET NOCOUNT ON;
    -- Insert statements for procedure here
		
	IF @operationType = 'DELETE'
	BEGIN		
		UPDATE  [Insurance].[InsuranceHealthPlans] 
		SET		IsActive = 0		
		WHERE   InsuranceHealthPlanID = @insuranceHealthPlanID
	END
	
END
-- =====================================================================================================
-- Author:      BHANU PRAKASH INTURI
-- Create Date: 13-NOV-2017
-- Description: SCRIPTS FOR EXECUTE INSURANCE HEALTH PLAN CONTRACT DETAILS IN PRODUCTION
-- SELECT * FROM [Insurance].[HealthPlanContracts] 
-- EXEC DeleteInsHealthPlanContracts 55, 'DELETE'
-- =====================================================================================================
CREATE Procedure [dbo].[DeleteInsHealthPlanContracts]
	-- Add the parameters for the stored procedure here
				  @healthPlanContractID BIGINT = 0,	
				  @operationType Nvarchar(10)				 				
AS
BEGIN
	-- SET NOCOUNT ON added to prevent extra result sets from
	-- interfering with SELECT statements.
	SET NOCOUNT ON;
    -- Insert statements for procedure here
 IF @operationType = 'DELETE'
	BEGIN		
		UPDATE  [Insurance].[HealthPlanContracts] 
		SET		IsActive = 0							
		WHERE   HealthPlanContractID = @healthPlanContractID
	END
	
END
-- =====================================================================================================
-- Author:      BHANU PRAKASH INTURI
-- Create Date: 13-NOV-2017
-- Description: SCRIPTS FOR EXECUTE INSURANCE TOLL FREE NUMBER DETAILS IN PRODUCTION
--SELECT * FROM [Insurance].[HealthPlanTollFreeNumbers]
--  @healthPlanTollID  @operationType	
--EXEC DeleteInsHealthPlanTollFreeNumbers 38,  0, 'DELETE'
-- =====================================================================================================
CREATE Procedure [dbo].[DeleteInsHealthPlanTollFreeNumbers]
	-- Add the parameters for the stored procedure here
				 @healthPlanTollID bigint = 0,				
				 @operationType Nvarchar(10)				 				
AS
BEGIN
	-- SET NOCOUNT ON added to prevent extra result sets from
	-- interfering with SELECT statements.
	SET NOCOUNT ON;
    -- Insert statements for procedure here
	IF @operationType = 'DELETE'
	BEGIN		
		UPDATE  [Insurance].[HealthPlanTollFreeNumbers] 
		SET		IsActive = 0		
		WHERE   HealthPlanTollID = @healthPlanTollID
	END
	
END
-- =====================================================================================================
-- Author:      BHANU PRAKASH INTURI
-- Create Date: 13-NOV-2017
-- Description: SCRIPTS FOR EXECUTE INSURANCE HEALTH PLAN PRODUCT DETAILS IN PRODUCTION
-- 
--SELECT * FROM Insurance.ContractProducts
--@contractProductID,  @operationType


--EXEC DeleteInsHealthPlanContractProducts 20229,'DELETE'
-- =====================================================================================================
CREATE Procedure [dbo].[DeleteInsHealthPlanContractProducts]
	-- Add the parameters for the stored procedure here
				@contractProductID	BIGINT =0,
				@operationType NVARCHAR(10)			 				
AS
BEGIN
	-- SET NOCOUNT ON added to prevent extra result sets from
	-- interfering with SELECT statements.
	SET NOCOUNT ON;
    -- Insert statements for procedure here
	 IF @operationType = 'DELETE'
	BEGIN		
		UPDATE  [Insurance].[ContractProducts] 
		SET		   
			IsActive = 0							
		WHERE   ContractProductID	= @contractProductID
	END	
END
-- =============================================
-- Author:      <Author, , Name>
-- Create Date: <Create Date, , >
-- Description: <Description, , >
-- =============================================
CREATE Procedure [dbo].[DeleteScriptSectionTypes]
(
    -- Add the parameters for the stored procedure here
	  @scriptSectionTypeId	BIGINT,		 
	  @operationType NVARCHAR(10)
)
AS
BEGIN
    -- SET NOCOUNT ON added to prevent extra result sets from
    -- interfering with SELECT statements.
    SET NOCOUNT ON

    -- Insert statements for procedure here  
	IF @operationType = 'UPDATE'
	BEGIN
		UPDATE [CallCenter].[ScriptSectionTypes]
		SET 
		IsActive = 0	
		WHERE ScriptSectionTypeId = @scriptSectionTypeId
	END
END
-- =============================================
-- Author:      BHANU PRAKASH INTURI
-- Create Date: 15-NOV-2017
-- Description: INSERT CALL CENTER SECTION SCRIPTS
--select * from [CallCenter].[ScriptSections]
-- =============================================
CREATE Procedure [dbo].[DeleteScriptSections]
(
    -- Add the parameters for the stored procedure here
		@scriptSectionID BIGINT,			
		@operationType NVARCHAR(10)
)
AS
BEGIN
    -- SET NOCOUNT ON added to prevent extra result sets from
    -- interfering with SELECT statements.
    SET NOCOUNT ON

    -- Insert statements for procedure here
	 IF @operationType = 'DELETE'
	BEGIN
	UPDATE [CallCenter].[ScriptSections] 
	SET		
		isActive = 0		
	WHERE ScriptSectionID = @scriptSectionID
	END   
END
CREATE Procedure [dbo].[getModelDetailsByModelCode]
@modelCode varchar(30)

AS
BEGIN

	SET NOCOUNT ON;

	select pRules.BrandCode, pRules.BrandFamilyCode, pRules.EarmoldTypeCode, pRules.FamilyProductCode,
	pRules.ProductTypeCode, pRules.ShellCode, pRules.TechnologyLevelCode ,
	mContent.ModelOverview, mContent.ModelLongDescription
	from [Catalog].ProductModelRules pRules left join [Catalog].FeatureValueRules fRules
	on pRules.ProductModelCode = fRules.ProductModelCode
	inner join CMS.ModelContents mContent
	on mContent.ModelCode = pRules.ProductModelCode
	where pRules.ProductModelCode = @modelCode
	

	--	select pRules.BrandCode, pRules.BrandFamilyCode, pRules.EarmoldTypeCode, pRules.FamilyProductCode,
	--pRules.ProductTypeCode, pRules.ShellCode, pRules.TechnologyLevelCode ,pRules.ProductModelCode,
	--mContent.ModelOverview,
	--ISNULL(conProd.UnitPrice,0) as UnitProductPrice, ISNULL(conProd.PairPrice,0) as PairProductPrice, ISNULL(contBen.BenefitAmt,0) as Benefit
	--from [Catalog].ProductModelRules pRules left join [Catalog].FeatureValueRules fRules
	--on pRules.ProductModelCode = fRules.ProductModelCode
	--inner join CMS.ModelContents mContent
	--on mContent.ModelCode = pRules.ProductModelCode
	--inner join insurance.ContractProducts1 conProd
	--on conProd.FamilyProductCode = pRules.FamilyProductCode
	--or conProd.ProductTypeCode = pRules.ProductTypeCode
	--inner join insurance.ContractBenefits contBen
	--on contBen.HealthPlanContractID = conProd.HealthPlanContractID
	--inner join insurance.HealthPlanContracts healthPC
	--on healthPC.HealthPlanContractID = contBen.HealthPlanContractID
	--inner join insurance.InsuranceHealthPlans insHP
	--on healthPC.HealthPlanID = insHP.HealthPlanID		
	--where pRules.ProductModelCode = 'VOT988-DW'

END
-- Batch submitted through debugger: SQLQuery6.sql|7|0|C:\Users\sdaggubati\AppData\Local\Temp\~vs53FC.sql
CREATE PROCEDURE [dbo].[anthem_elig_file_load_ssis_sp_merge_stg_to_anthemelig]
AS


BEGIN

	BEGIN TRY
	BEGIN TRANSACTION AM_ELIG_MERGE_stg_to_AnthemElig

-- EXEC [dbo].[anthem_elig_file_load_ssis_sp_merge_stg_to_anthemelig]


		DECLARE @sys_usr CHAR(30)
		       ,@sys_date DATETIME;  

		SET @sys_usr = SYSTEM_USER
		SET @sys_date = CAST(GETDATE() AT TIME ZONE 'UTC' AT TIME ZONE 'Eastern Standard Time' AS DATETIME);  -- Time in EST

		DROP TABLE IF EXISTS anthemelig.DataViewAnthemMembers
		
        DROP TABLE IF EXISTS anthemelig.DataVAnthemMemNotRcvd

		DROP TABLE IF EXISTS anthemelig.DataVAnthemIns
		
        DROP TABLE IF EXISTS anthemelig.DataVAnthemInsNotRcvd

		
		SELECT * 
		INTO anthemelig.DataViewAnthemMembers 
		FROM anthemelig.ViewAnthemMembers

		CREATE INDEX DataViewAnthemMembers_idx ON anthemelig.DataViewAnthemMembers (newNHLinkID)

		SELECT * 
		INTO anthemelig.DataVAnthemMemNotRcvd 
		FROM anthemelig.ViewAnthemMemNotRcvd n 
        WHERE NOT EXISTS (SELECT 1 FROM anthemelig.DataViewAnthemMembers d WHERE d.newNHLinkID = n.newNHLinkID)

		CREATE INDEX DataVAnthemMemNotRcvd_idx ON anthemelig.DataVAnthemMemNotRcvd (newNHLinkID)

		SELECT * 
		INTO anthemelig.DataVAnthemIns 
		FROM anthemelig.ViewAnthemInsurance

		CREATE INDEX DataVAnthemIns_idx ON anthemelig.DataVAnthemIns (newNHLinkID)

		SELECT * 
		INTO anthemelig.DataVAnthemInsNotRcvd 
		FROM anthemelig.ViewAnthemInsNotRcvd n 
		WHERE NOT EXISTS (SELECT 1 FROM anthemelig.DataVAnthemIns d WHERE d.newNHLinkID = n.newNHLinkID and d.EligibilityEffectiveDate = n.EligibilityEffectiveDate)

		CREATE INDEX DataVAnthemInsNotRcvd_idx ON anthemelig.DataVAnthemInsNotRcvd (newNHLinkID,EligibilityEffectiveDate)

		-- Set all records not to be processed
		UPDATE 
		[anthemelig].[AnthemMembers]
		SET ToBeProcessed = 'N'

		UPDATE 
		[anthemelig].[AnthemInsurance]
		SET ToBeProcessed = 'N'

		-- Insert if there are any new members or update any changes to existing members
		MERGE [anthemelig].[AnthemMembers] m 
		USING [anthemelig].DataViewAnthemMembers d		-- [anthemelig].[DataViewAnthemMembers] 
		ON (m.newNHLinkID = d.newNHLinkID)

		WHEN MATCHED THEN

		UPDATE SET
		MemberIdentificationNumber = d.MemberIdentificationNumber,
		MembersDateOfBirth = d.MembersDateOfBirth,
		MedicaidNumber = d.MedicaidNumber,
		MedicareNumber = d.MedicareNumber,
		MemberLastName = d.MemberLastName,
		MemberFirstName = d.MemberFirstName,
		MemberMiddleName = d.MemberMiddleName,
		SocialSecurityNumber = d.SocialSecurityNumber,
		MemberPhoneNumber = d.MemberPhoneNumber,
		MemberAddressLine1 = d.MemberAddressLine1,
		MemberAddressLine2 = d.MemberAddressLine2,
		MemberCityName = d.MemberCityName,
		MemberStateName = d.MemberStateName,
		MemberZipCode = d.MemberZipCode,
		MemberDateOfDeath = d.MemberDateOfDeath,
		MemberSex = d.MemberSex,
		MemberRace = d.MemberRace,
		MemberLanguage = d.MemberLanguage,
		MemberMailingAddressLine1 = d.MemberMailingAddressLine1,
		MemberMailingAddressLine2 = d.MemberMailingAddressLine2,
		MemberMailingCityName = d.MemberMailingCityName,
		MemberMailingStateName = d.MemberMailingStateName,
		MemberMailingZipCode = d.MemberMailingZipCode,
		statusflag = 'U',
		tobeprocessed = 'Y',
		ModifyDate = @sys_date,
		ModifyUser = @sys_usr

		WHEN NOT MATCHED THEN

		INSERT (
		newNHLinkID,
		MemberIdentificationNumber,
		MembersDateOfBirth,
		MedicaidNumber,
		MedicareNumber,
		MemberLastName,
		MemberFirstName,
		MemberMiddleName,
		SocialSecurityNumber,
		MemberPhoneNumber,
		MemberAddressLine1,
		MemberAddressLine2,
		MemberCityName,
		MemberStateName,
		MemberZipCode,
		MemberDateOfDeath,
		MemberSex,
		MemberRace,
		MemberLanguage,
		MemberMailingAddressLine1,
		MemberMailingAddressLine2,
		MemberMailingCityName,
		MemberMailingStateName,
		MemberMailingZipCode,
		statusflag,
		tobeprocessed,
		CreateUser,
		ModifyDate,
		ModifyUser)
		VALUES 
		(d.newNHLinkID,
		d.MemberIdentificationNumber,
		d.MembersDateOfBirth,
		d.MedicaidNumber,
		d.MedicareNumber,
		d.MemberLastName,
		d.MemberFirstName,
		d.MemberMiddleName,
		d.SocialSecurityNumber,
		d.MemberPhoneNumber,
		d.MemberAddressLine1,
		d.MemberAddressLine2,
		d.MemberCityName,
		d.MemberStateName,
		d.MemberZipCode,
		d.MemberDateOfDeath,
		d.MemberSex,
		d.MemberRace,
		d.MemberLanguage,
		d.MemberMailingAddressLine1,
		d.MemberMailingAddressLine2,
		d.MemberMailingCityName,
		d.MemberMailingStateName,
		d.MemberMailingZipCode,
		'N',
		'Y',
		@sys_usr, 
		@sys_date, 
		@sys_usr); 

		-- Update status flag for records which we didn't received in new eligibility file 
		UPDATE a
		SET StatusFlag = 'D',
		ToBeProcessed = 'Y', 
		ModifyDate = @sys_date, 
		ModifyUser = @sys_usr
		FROM [anthemelig].[AnthemMembers] a
		WHERE EXISTS ( SELECT 1 FROM  [anthemelig].DataVAnthemMemNotRcvd d WHERE d.newNHLinkID = a.newNHLinkID )        --  [anthemelig].[DataVAnthemMemNotRcvd]
		AND a.StatusFlag <> 'D'


		-- Insert if there are any new members or update any changes to existing members
		MERGE [anthemelig].[AnthemInsurance] i 
		USING [anthemelig].[DataVAnthemIns] d									-- [anthemelig].[DataVAnthemIns] 
		ON (i.newNHLinkID = d.newNHLinkID and i.EligibilityEffectiveDate = d.EligibilityEffectiveDate)

		WHEN MATCHED THEN

		UPDATE SET
		ClassID = d.ClassID,
		PlanID = d.PlanID,
		ProductCode = d.ProductCode,
		EligibilityTerminationDate = d.EligibilityTerminationDate,
		GroupNumber = d.GroupNumber,
		ContractCode = null,
		PBPCode = null,
		SegmentCode = null,
		statusflag = 'U',
		tobeprocessed = 'Y',
		ModifyDate = @sys_date,
		ModifyUser = @sys_usr

		WHEN NOT MATCHED THEN

		INSERT (
		NHAnthemInsuranceID,				
		newNHLinkID,
		MemberIdentificationNumber,
		ClassID,
		PlanID,
		ProductCode,
		EligibilityEffectiveDate,
		EligibilityTerminationDate,
		GroupNumber,
		statusflag,
		tobeprocessed,
		CreateUser,
		ModifyDate,
		ModifyUser)
		VALUES (
		1,									
		d.newNHLinkID,
		d.MemberIdentificationNumber,
		d.classid, 
		d.planid, 
		d.productcode, 
		d.EligibilityEffectiveDate,
		d.EligibilityTerminationDate,
		d.GroupNumber,
		'N',
		'Y',
		@sys_usr, 
		@sys_date, 
		@sys_usr); 


		-- Update status flag in records for which we didn't received in new eligibility file 
		UPDATE a
		SET StatusFlag = 'D',
		ToBeProcessed = 'Y', 
		ModifyDate = @sys_date, 
		ModifyUser = @sys_usr
		FROM [anthemelig].[AnthemInsurance] a
		WHERE EXISTS ( SELECT 1 FROM  [anthemelig].[DataVAnthemInsNotRcvd] d WHERE d.newNHLinkID = a.newNHLinkID and d.EligibilityEffectiveDate = a.EligibilityEffectiveDate )        --  [anthemelig].[DataVAnthemInsNotRcvd]
		AND a.StatusFlag <> 'D'
		



		-- Update contract, pbp & segment for new records inserted based on anthemlink
		UPDATE i																		
		SET 
		i.ContractCode = a.contract,
		i.SegmentCode = a.seg,
		i.PBPCode = a.pbp
		--,modifyuser = a.servicecontractflag
		FROM
		[anthemelig].[AnthemInsurance] i
		INNER JOIN [anthemelig].[anthemlink] a
		ON (a.class = i.classid and a.plan_ID  = i.planid and a.product = i.productcode)
		WHERE ToBeProcessed = 'Y'
		AND StatusFlag = 'N'

		-- Update Health plan based on contract, pbp & segment					
		UPDATE i
		SET healthplanid = ( SELECT insurancehealthplanid FROM [Insurance].[InsuranceHealthPlans] hp 
							 WHERE hp.insurancecarrierid = 24 AND hp.healthplannumber IS NOT NULL
							 AND hp.healthplannumber = i.contractcode + i.pbpcode + i.segmentcode )
		FROM  [anthemelig].[AnthemInsurance] i
		WHERE tobeprocessed = 'Y'
		--AND i.healthplanid IS NOT NULL	


	COMMIT TRANSACTION AM_ELIG_MERGE_stg_to_AnthemElig
	PRINT 'SUCCESS'
	END TRY

	BEGIN CATCH
	DECLARE @ErrorMessage NVARCHAR(4000);  
    DECLARE @ErrorSeverity INT;  
    DECLARE @ErrorState INT;  

    SELECT   
        @ErrorMessage = ERROR_MESSAGE(),  
        @ErrorSeverity = ERROR_SEVERITY(),  
        @ErrorState = ERROR_STATE();  

	IF (@@TRANCOUNT > 0)
	BEGIN
		ROLLBACK TRANSACTION AM_ELIG_MERGE_stg_to_AnthemElig
		RAISERROR(@ErrorMessage,@ErrorSeverity,@ErrorState);
		PRINT 'FAILED'
	END

	END CATCH

END
CREATE Procedure [dbo].[getModelDetailsByModelCodeMediaName]
@modelCode varchar(30),
@mediaName varchar(20)
AS
BEGIN

	SET NOCOUNT ON;

	if(@mediaName = 'Videos' or @mediaName = 'Downloads')
		begin
			select ModelCode,null as [Description],Media,MediaURL,null as ModelOverview from CMS.ModelMedias where ModelCode = @modelCode  and MediaType = @mediaName
		end
	else if(@mediaName = 'Reviews')
		begin
			select ModelCode,ModelReviewDescription as [Description],null as Media, null as MediaURL,null as ModelOverview from CMS.ModelReviews where ModelCode = @modelCode 
		end
	else if(@mediaName = 'Mobile Apps')
		begin
			select ModelCode,ModelMobileAppsDescription as [Description],null as Media, null as MediaURL,null as ModelOverview from CMS.ModelContents where ModelCode = @modelCode 
		end
	else if(@mediaName = 'Overview')
		begin
			select ModelCode,null as [Description],null as Media, null as MediaURL,ModelOverview from CMS.ModelContents where ModelCode = @modelCode 
		end
	else 
		begin
			select ModelCode,[Description],null as Media, null as MediaURL,null as ModelOverview from CMS.ModelAccessories where ModelCode = @modelCode and ModelAccessoryName = @mediaName
		end
END
CREATE procedure [dbo].[anthem_elig_file_load_ssis_sp_merge_anthemelig_to_masters]
as

-- Also includes Address & Phone Numbers

-- EXEC [dbo].[anthem_elig_file_load_ssis_sp_merge_anthemelig_to_masters]

BEGIN

	BEGIN TRY
	BEGIN TRANSACTION AM_ELIG_MERGE_AnthElig_to_Master

		DECLARE @sys_usr CHAR(30)
				,@sys_date DATETIME;  

		SET @sys_usr = SYSTEM_USER
		SET @sys_date = CAST(GETDATE() AT TIME ZONE 'UTC' AT TIME ZONE 'Eastern Standard Time' AS DATETIME);  -- Time in EST


		-- drop not null record insert constraint (unique index) on NHMemberID in master.members before inserting new members or updating NHMemberID for new records inserted

		ALTER TABLE [Master].[Members] DROP CONSTRAINT [IX_Members_NHMemberID_U]



		MERGE Master.Members d
		USING ( SELECT * FROM [anthemelig].[AnthemMembers] WHERE ToBeProcessed = 'Y' ) s
		ON (d.memberid = s.mastermemberid )

		WHEN MATCHED THEN
											
		UPDATE SET
		d.EligFile = 'ELIG_AM',
		d.eligFileID = s.ID,
		d.DateOfBirth = s.MembersDateOfBirth,
		d.FirstName = s.MemberFirstName,
		d.Gender = s.MemberSex,
		d.IsActive = 1,
		d.LastName = s.MemberLastName,
		d.MiddleInitial = s.MemberMiddleName,
		d.ModifyDate = @sys_date,
		d.ModifyUser = @sys_usr

		WHEN NOT MATCHED THEN

		INSERT ( 
		CreateDate,
			CreateUser,
			DataSource,
			DateOfBirth,
			FirstName,
			Gender,
			IsActive,
			LastName,
			MiddleInitial,
			ModifyDate,
			ModifyUser,
			EligFile,
			EligFileID)  
			VALUES 
			(
			@sys_date
		,@sys_usr
		,'ELIG_AM'
		,MembersDateOfBirth
		,MemberFirstName
		,MemberSex
		,1
		,MemberLastName
		,MemberMiddleName
		,@sys_date
		,@sys_usr
		,'ELIG_AM'
		,ID
		);


		-- Assign mastermemberid in AnthemMembers after inserting new records into master.members
		UPDATE a 
		SET mastermemberid = (SELECT memberid FROM [Master].[Members] m where m.EligFileID = a.id and m.EligFile = 'ELIG_AM')
		FROM anthemelig.anthemmembers a
		WHERE tobeprocessed = 'Y'								
		AND mastermemberid IS NULL


		-- Update NHMemberID for newly inserted members
		UPDATE [Master].[Members]
		SET nhmemberid = 'NH'+RIGHT(YEAR(GETDATE()),4)+ FORMAT(memberid,'00000000')							 --    'NH2018'+ FORMAT(memberid,'00000000')
		WHERE EligFile = 'ELIG_AM'
		AND nhmemberid IS NULL

		-- Re create the unique NHMemberID index
		ALTER TABLE [Master].[Members] ADD  CONSTRAINT [IX_Members_NHMemberID_U] UNIQUE NONCLUSTERED 
		(
			[NHMemberID] ASC
		)


		-- Assign mastermemberid to AnthemInsurance records from AnthemMembers joining on newNHLinkID			
		UPDATE i
		SET mastermemberid = ( SELECT mastermemberid FROM [anthemelig].[AnthemMembers] m WHERE m.newNHLinkID = i.newNHLinkID )
		FROM [anthemelig].[AnthemInsurance] i
		WHERE EXISTS (SELECT 1 FROM [anthemelig].[AnthemMembers] m1 WHERE m1.newNHLinkID = i.newNHLinkID)
		AND i.mastermemberid IS NULL


		-- Update address
		MERGE Master.addresses d
		USING (SELECT * FROM anthemelig.anthemmembers WHERE tobeprocessed = 'Y' AND MemberAddressLine1 <> '') s
		ON (d.memberid = s.mastermemberid AND d.AddressTypeCode = 'PERM')
		WHEN MATCHED THEN
		UPDATE SET
		Address1 = s.MemberAddressLine1
		,Address2 = s.MemberAddressLine2
		,City = s.MemberCityName
		,State = s.MemberStateName
		,ZipCode = s.MemberZipCode
		,IsActive = 1
		,IsPreferredAddress = 1
		,MemberID = s.mastermemberid
		,ModifyDate = @sys_date
		, ModifyUser = @sys_usr
		WHEN NOT MATCHED THEN
		INSERT (
			Address1
		,Address2
		,AddressTypeCode
		,City
		,State
		,ZipCode
		,EffectiveFromDate
		,EffectiveToDate
		,IsActive
		,IsPreferredAddress
		,MemberID
		,CreateDate
		,CreateUser
		,ModifyDate
		, ModifyUser
		)
		VALUES(
			s.[MemberAddressLine1]
		,s.[MemberAddressLine2]
		,'PERM'
		,s.[MemberCityName]
		,s.[MemberStateName]
		,s.[MemberZipCode]
		,CAST(DATEADD(MONTH, DATEDIFF(MONTH, 0, GETDATE()), 0) AS DATE) 
		,CAST('20991231' AS DATE) 
		,1 
		,1 
		,s.[mastermemberid]
		,@sys_date
		,@sys_usr
		,@sys_date
		,@sys_usr);


		MERGE Master.addresses d
		USING (SELECT * FROM anthemelig.anthemmembers WHERE tobeprocessed = 'Y' AND MemberMailingAddressLine1 <> '') s
		ON (d.memberid = s.mastermemberid AND d.AddressTypeCode = 'MAIL')
		WHEN MATCHED THEN
		UPDATE SET
		Address1 = s.MemberMailingAddressLine1
		,Address2 = s.MemberMailingAddressLine2
		,City = s.MemberMailingCityName
		,State = s.MemberMailingStateName
		,ZipCode = s.MemberMailingZipCode
		,IsActive = 1
		,MemberID = s.mastermemberid
		,ModifyDate = @sys_date
		, ModifyUser = @sys_usr
		WHEN NOT MATCHED THEN
		INSERT (
			Address1
		,Address2
		,AddressTypeCode
		,City
		,State
		,ZipCode
		,EffectiveFromDate
		,EffectiveToDate
		,IsActive
		,IsPreferredAddress
		,MemberID
		,CreateDate
		,CreateUser
		,ModifyDate
		, ModifyUser
		)
		VALUES(
			s.MemberMailingAddressLine1
		,s.MemberMailingAddressLine2
		,'MAIL'
		,s.MemberMailingCityName
		,s.MemberMailingStateName
		,s.MemberMailingZipCode
		,CAST(DATEADD(MONTH, DATEDIFF(MONTH, 0, GETDATE()), 0) AS DATE)
		,CAST('20991231' AS DATE) 
		,1 
		,0 
		,s.[mastermemberid]
		,@sys_date
		,@sys_usr
		,@sys_date
		,@sys_usr);

		MERGE Master.PhoneNumbers d
		USING (SELECT * FROM anthemelig.anthemmembers WHERE tobeprocessed = 'Y' AND MemberPhoneNumber <> 0) s
		ON (d.memberid = s.mastermemberid AND d.PhoneTypeCode = 'HOME')
		WHEN MATCHED THEN
		UPDATE SET
		CountryCode = '001'
		,PhoneNbr = s.MemberPhoneNumber
		, IsActive = 1
		,MemberID = s.mastermemberid
		, ModifyDate = @sys_date
		, ModifyUser = @sys_usr
		WHEN NOT MATCHED THEN
		INSERT (
		CountryCode
		,PhoneNbr
		, PhoneTypeCode
		, EffectiveFromDate
		,EffectiveToDate
		, IsActive
		,IsPreferredPhoneNumber
		,MemberID
		,CreateDate
		, CreateUser
		, ModifyDate
		, ModifyUser
		)
		VALUES ( 
		'001' 
		,s.[MemberPhoneNumber] 
		,'HOME' 
		,CAST(DATEADD(MONTH, DATEDIFF(MONTH, 0, GETDATE()), 0) AS DATE)
		,CAST('20991231' AS DATE) 
		,1 
		,0 
		,s.[mastermemberid] 
		,@sys_date 
		,@sys_usr
		,@sys_date 
		,@sys_usr );




		MERGE [master].[MemberInsurances] d
		USING (SELECT * FROM anthemelig.antheminsurance WHERE tobeprocessed = 'Y' AND healthplanid IS NOT NULL) s
		ON (s.masterMemberId = d.MemberID and s.EligibilityEffectiveDate = d.InsuranceEffectiveDate)

		WHEN MATCHED THEN

		UPDATE SET
		--InsuranceEndDate = case statusflag when 'D' then cast(getdate()-1 as date) else EligibilityTerminationDate end, this will be statement for all but now exception
		InsuranceEndDate = CASE statusflag WHEN 'D' THEN (CASE WHEN DATEDIFF(dd, cast(d.InsuranceEndDate AS DATE), CAST(GETDATE()-1 AS DATE)) < 0 THEN CAST(GETDATE()-1 AS DATE) ELSE cast(d.InsuranceEndDate AS DATE) END  )  ELSE EligibilityTerminationDate END,
		InsuranceHealthPlanID = s.healthplanid,
		--IsActive = CASE statusflag WHEN 'D' THEN 0 ELSE 1 END,
		IsActive = 1,
		ModifyDate = @sys_date,
		ModifyUser = @sys_usr,
		eligFileID = s.ID,
		eligFile = 'ELIG_AM'

		WHEN NOT MATCHED THEN

		INSERT (
		CreateDate,
		CreateUser,
		InsuranceCarrierID,
		InsuranceEffectiveDate,
		InsuranceEndDate,
		InsuranceHealthPlanID,
		IsActive,
		MemberID,
		ModifyDate,
		ModifyUser,
		eligFileID,
		eligFile)
		VALUES (
		@sys_date
		,@sys_usr
		,24 
		,EligibilityEffectiveDate 
		,EligibilityTerminationDate 
		,[healthplanid] 
		,1 
		,mastermemberid 
		,@sys_date
		,@sys_usr,s.ID , 'ELIG_AM');


		-- Update insuranceid in antheminsurance after inserting new records in master.memberinsurance
		UPDATE i
		SET memberinsuranceid = (SELECT m.id FROM [Master].[MemberInsurances] m 
									WHERE m.memberid = i.mastermemberid AND m.eligFileID = i.ID AND m.insurancecarrierid = 24)
		FROM [anthemelig].[AnthemInsurance] i
		WHERE tobeprocessed = 'Y'
		AND memberinsuranceid IS NULL

		-- Update MemberInsuranceDetails

		MERGE Master.MemberInsuranceDetails d
		USING (SELECT    ID
						,NHAnthemMemberID
						,NHAnthemInsuranceID
						,MemberIdentificationNumber
						,ClassID
						,PlanID
						,ProductCode
						,EligibilityEffectiveDate
						,EligibilityTerminationDate
						,ContractCode
						,SegmentCode
						,PBPCode
						,GroupNumber
						,ToBeProcessed
						,ProcessedDate
						,CreateDate
						,CreateUser
						,ModifyDate
						,ModifyUser
						,StatusFlag
						,mastermemberid
						,healthplanid
						,memberinsuranceid
						,newNHLinkID
						,CASE WHEN EligibilityTerminationDate < GETDATE() THEN 0 ELSE 1 END IsInsuranceEligibilityVerified 
							FROM anthemelig.antheminsurance WHERE tobeprocessed = 'Y') s
		ON (d.MemberInsuranceID = s.memberinsuranceid)

		WHEN MATCHED THEN 

		UPDATE SET
		GroupNbr = s.GroupNumber,
		InsuranceNbr = s.MemberIdentificationNumber,
		IsInsuranceEligibilityVerified = s.IsInsuranceEligibilityVerified,
		--MemberInsuranceID = s.MemberInsuranceID,
		ModifyDate = @sys_date,
		ModifyUser = @sys_usr,
		ISActive = 1

		WHEN NOT MATCHED THEN

		INSERT (
		CreateDate
		, CreateUser
		,GroupNbr
		,InsuranceNbr
		,IsActive
		,IsInsuranceEligibilityVerified
		,MemberInsuranceID
		,ModifyDate
		,ModifyUser
		)
		VALUES ( 
		@sys_date
		,@sys_usr
		,s.GroupNumber 
		,s.MemberIdentificationNumber
		,1 
		,s.IsInsuranceEligibilityVerified
		,s.MemberInsuranceID
		,@sys_date
		,@sys_usr
		);

	COMMIT TRANSACTION AM_ELIG_MERGE_AnthElig_to_Master
	PRINT 'SUCCESS'
	END TRY

	BEGIN CATCH
	DECLARE @ErrorMessage NVARCHAR(4000);  
    DECLARE @ErrorSeverity INT;  
    DECLARE @ErrorState INT;  

    SELECT   
        @ErrorMessage = ERROR_MESSAGE(),  
        @ErrorSeverity = ERROR_SEVERITY(),  
        @ErrorState = ERROR_STATE();  

	IF (@@TRANCOUNT > 0)
	BEGIN
		ROLLBACK TRANSACTION AM_ELIG_MERGE_AnthElig_to_Master
		RAISERROR(@ErrorMessage,@ErrorSeverity,@ErrorState);
		PRINT 'FAILED'
	END

	END CATCH

END

CREATE Procedure [dbo].[InsertorUpdateAgentLogins]
	-- Add the parameters for the stored procedure here				
				@userProfileId bigint = 0,
				@userName nvarchar(50) = null, 
				@temproryKeyCode nvarchar(30) = null, 
				@isActive bit, 
				@isEnabled bit, 
				@isRegister bit, 
				@isBlocked bit, 
				@firstName nvarchar(50) = null, 
				@lastName nvarchar(50) = null, 
				@middleName nvarchar(50) = null,	 
				@designation nvarchar(30) = null, 				
				@createUser nvarchar(50) = null, 				 
				@modifyUser nvarchar(50) = null, 
				@passwordHash nvarchar(2000) = null, 
				@passwordSalt nvarchar(2000) = null
					 				
AS
BEGIN
	-- SET NOCOUNT ON added to prevent extra result sets from
	-- interfering with SELECT statements.
	SET NOCOUNT ON;
    -- Insert statements for procedure here
	if not exists (SELECT 1 FROM [auth].[UserProfiles])
	BEGIN
		DBCC CHECKIDENT ('[auth].[UserProfiles]', RESEED, 1) 
	END
	if exists (SELECT 1 FROM [auth].[UserProfiles]	WHERE UserProfileId = @userProfileId AND USERNAME = @userName)
 BEGIN
  UPDATE  [auth].[UserProfiles]
		SET		[UserName] = @userName , 
				[TemproryKeyCode] = @temproryKeyCode, 
				[IsActive] = @isActive, 
				[IsEnabled] = @isEnabled, 
				[IsRegister] = @isRegister, 
				[IsBlocked] = @isBlocked, 
				[FirstName] = @firstName, 
				[LastName] = @lastName, 
				[MiddleName] = @middleName,			  
				[Designation] = @designation, 				
				[ModifyDate] = getdate(), 
				[ModifyUser] = @modifyUser, 
				[PasswordHash] = @passwordHash, 
				[PasswordSalt] = @passwordSalt
		WHERE   UserProfileId = @userProfileId
 
 END
 BEGIN
  INSERT INTO [auth].[UserProfiles]				
				([UserName], 
				[TemproryKeyCode], 
				[IsActive], 
				[IsEnabled], 
				[IsRegister], 
				[IsBlocked], 
				[FirstName], 
				[LastName], 
				[MiddleName],			  
				[Designation], 
				[CreateDate], 
				[CreateUser], 
				[ModifyDate], 
				[ModifyUser], 
				[PasswordHash], 
				[PasswordSalt]
				) 
     VALUES		(@userName , 
				@temproryKeyCode, 
				@isActive, 
				@isEnabled, 
				@isRegister, 
				@isBlocked, 
				@firstName, 
				@lastName, 
				@middleName,	 
				@designation, 
				getdate(),				
				@createUser,
				getdate(),								 
				@modifyUser, 
				@passwordHash, 
				@passwordSalt				
			)
 END
END
-- =============================================

--select * from [CallCenter].[AgentScripts]
--EXEC InsertorUpdateAgentScripts  @scriptID [VALUE BE 0 WHEN INSERTING], @createUser, @isActive, @modifyUser, @scriptDescription, @scriptName,
--EXEC InsertorUpdateAgentScripts 1, 'Scripts', 1, 'Scripts', 'NULL', 'DefaultScriptS', 'static'
--@scriptType, @operationType [INSERT / UPDATE]
-- =============================================
CREATE Procedure [dbo].[InsertorUpdateAgentScripts]
(
    -- Add the parameters for the stored procedure here
   @scriptID BIGINT = 0,   
   @createUser NVARCHAR(150),
   @isActive BIT,  
   @modifyUser NVARCHAR(150) = null,
   @scriptDescription NVARCHAR(50) = null,
   @scriptName NVARCHAR(50) =  null,
   @scriptType NVARCHAR(20) = null
   
)
AS
BEGIN
    -- SET NOCOUNT ON added to prevent extra result sets from
    -- interfering with SELECT statements.
    SET NOCOUNT ON
	    -- Insert statements for procedure here
if not exists (SELECT 1 FROM [CallCenter].[AgentScripts])
BEGIN
 DBCC CHECKIDENT ('[CallCenter].[AgentScripts]', RESEED, 1) 
END
if exists (SELECT 1 FROM [CallCenter].[AgentScripts] WHERE ScriptName = @scriptName)
 BEGIN
 UPDATE [CallCenter].[AgentScripts] 
	SET 
	IsActive = @isActive,
	ModifyDate = getdate(),
	ModifyUser = @modifyUser,
	ScriptDescription = @scriptDescription,
	ScriptName = @scriptName,
	ScriptType = @scriptType
	WHERE ScriptID = @scriptID
 END
 ELSE
 BEGIN
	INSERT INTO [CallCenter].[AgentScripts] 
	( 
		CreateDate,
		CreateUser,
		IsActive,
		ModifyDate,
		ModifyUser,
		ScriptDescription,
		ScriptName,
		ScriptType		
	) 
	VALUES 
	(
		getdate(),
		@createUser,
		@isActive,
		getdate(),
		@modifyUser,
		@scriptDescription,
		@scriptName,
		@scriptType)  
END
END
-- =====================================================================================================
--SELECT * FROM [Insurance].[InsuranceCarriers]   
--EXEC InsertorUpdateInsCarriers 7, 'Scripts', 'GEHA_FEHBP', 1, 0, 'Scripts', 0
-- =====================================================================================================
CREATE Procedure [dbo].[InsertorUpdateInsCarriers]  
 -- Add the parameters for the stored procedure here  
      @insuranceCarrierID BIGINT = 0,      
     @createSource NVARCHAR(150),       
     @insuranceCarrierName NVARCHAR(50),   
     @isActive BIT,   
     @memberDataFileProvided BIT,      
     @modifySource NVARCHAR(150),  
     @isDiscountProgram bit,
	 @custServiceAddress1 nvarchar(200),
	 @custServiceAddress2  nvarchar(200),
	 @custServiceCity  nvarchar(100),
	 @custServiceState  nvarchar(100),
	 @custServiceZipCode  nvarchar(10),
	 @custServicePhoneNbr bigint,
	 @custServiceEmailAddress  nvarchar(100),
	 @claimsAddress1  nvarchar(200),
	 @claimsAddress2  nvarchar(200),
	 @claimsCity  nvarchar(100),
	 @claimsState  nvarchar(100),
	 @claimsZipCode  nvarchar(10),
	 @claimsPhoneNbr bigint,
	 @claimsEmailAddress  nvarchar(100),
	 @isContracted bit
	 
AS  
BEGIN  
 -- SET NOCOUNT ON added to prevent extra result sets from  
 -- interfering with SELECT statements.  
 SET NOCOUNT ON;  
 --reseeded the identity column in the table  
 --end
    -- Insert statements for procedure here  
if not exists (SELECT 1 FROM [Insurance].[InsuranceCarriers])
BEGIN
 DBCC CHECKIDENT ('[Insurance].[InsuranceCarriers]', RESEED, 1) 
END
if exists (SELECT 1 FROM [Insurance].[InsuranceCarriers] WHERE INSURANCECARRIERNAME = @insuranceCarrierName)
 BEGIN
  UPDATE  [Insurance].[InsuranceCarriers]   
	  SET  InsuranceCarrierName = @insuranceCarrierName,  
		   IsActive = @isActive,   
		   MemberDataFileProvided= @memberDataFileProvided,   
		   ModifyDate = getdate(),   
		   ModifyUser = @modifySource,
		   IsDiscountProgram = @isDiscountProgram,
		    CustServiceAddress1 = @custServiceAddress1,
			CustServiceAddress2 = @custServiceAddress2,
			CustServiceCity = @custServiceCity,
			CustServiceState = @custServiceState,
			CustServiceZipCode = @custServiceZipCode,
			CustServicePhoneNbr = @custServicePhoneNbr,
			CustServiceEmailAddress = @custServiceEmailAddress,
			ClaimsAddress1 = @claimsAddress1,
			ClaimsAddress2 = @claimsAddress2,
			ClaimsCity = @claimsCity,
			ClaimsState = @claimsState,
			ClaimsZipCode = @claimsZipCode,
			ClaimsPhoneNbr = @claimsPhoneNbr,
			ClaimsEmailAddress =  @claimsEmailAddress,
			IsContracted =  @isContracted
  WHERE   InsuranceCarrierID = @insuranceCarrierID  
 END
 ELSE 
 BEGIN
	INSERT INTO [Insurance].[InsuranceCarriers]   
    (Createdate,   
     CreateUser,   
     InsuranceCarrierName,   
     IsActive,   
     MemberDataFileProvided,   
     ModifyDate,   
     ModifyUser,
	 IsDiscountProgram,
	 CustServiceAddress1,
	 CustServiceAddress2,
	 CustServiceCity,
	 CustServiceState,
	 CustServiceZipCode,
	 CustServicePhoneNbr,
	 CustServiceEmailAddress,
	 ClaimsAddress1,
	 ClaimsAddress2,
	 ClaimsCity,
	 ClaimsState,
	 ClaimsZipCode,
	 ClaimsPhoneNbr,
	 ClaimsEmailAddress,
	 IsContracted
	 )   
     VALUES  (getdate(),  
     @createSource,   
     @insuranceCarrierName,   
     @isActive,   
     @memberDataFileProvided,   
     getdate(),   
     @modifySource,
	 @isDiscountProgram,
	 @custServiceAddress1,
	 @custServiceAddress2,
	 @custServiceCity,
	 @custServiceState,
	 @custServiceZipCode,
	 @custServicePhoneNbr,
	 @custServiceEmailAddress,
	 @claimsAddress1,
	 @claimsAddress2,
	 @claimsCity,
	 @claimsState,
	 @claimsZipCode,
	 @claimsPhoneNbr,
	 @claimsEmailAddress,
	 @isContracted
	 )  
 END   
END  
-- =====================================================================================================
-- select * from [Insurance].[HealthPlanContracts] 
-- EXEC InsertorUpdateInsHealthPlanContracts 55, 1, 'NULL', '2017 TESTING INSURANCE CONTRACTS',  'Scripts', 'NULL', '11/12/2017',
--                                        '11/30/2018'   8, 38, 1,  'Scripts'
-- =====================================================================================================
CREATE PROCEDURE [dbo].[InsertorUpdateInsHealthPlanContracts]
	-- Add the parameters for the stored procedure here
				  @healthPlanContractID BIGINT = 0,
				  @brandID BIGINT, 
				  @brandName NVARCHAR(MAX) = null, 
				  @contractName NVARCHAR(100), 				 
				  @createUser NVARCHAR(MAX) = NULL, 
				  @description NVARCHAR(200) = NULL, 
				  @effectiveFromDate DATETIME, 
				  @effectiveToDate DATETIME, 
				  @insuranceCarrierID BIGINT, 
				  @insuranceHealthPlanID BIGINT, 
				  @isActive BIT,				  
				  @modifyUser NVARCHAR(MAX) = NULL
				 
				 				
AS
BEGIN
	-- SET NOCOUNT ON added to prevent extra result sets from
	-- interfering with SELECT statements.
	SET NOCOUNT ON;
    -- Insert statements for procedure here
	if not exists (SELECT 1 FROM [Insurance].[HealthPlanContracts])
	BEGIN
		DBCC CHECKIDENT ('[Insurance].[HealthPlanContracts]', RESEED, 1) 
	END
	if exists (SELECT 1 FROM [Insurance].[HealthPlanContracts]  WHERE HealthPlanContractID = @healthPlanContractID and InsuranceCarrierID = @insuranceCarrierID and InsuranceHealthPlanID = @insuranceHealthPlanID)
 BEGIN
 UPDATE  [Insurance].[HealthPlanContracts] 
		SET		BrandID = @brandID,
				BrandName = @brandName,				 
				ContractName= @contractName,				
				[Description] = @description,
				EffectiveFromDate = @effectiveFromDate,
				EffectiveToDate = @effectiveToDate,
				InsuranceCarrierID = @insuranceCarrierID,
				InsuranceHealthPlanID = @insuranceHealthPlanID,
				IsActive = @isActive,
				ModifyDate = getdate(), 
				ModifyUser = @modifyUser				
		WHERE   HealthPlanContractID = @healthPlanContractID
 END
 ELSE
 BEGIN
 INSERT INTO  [Insurance].[HealthPlanContracts]  
				 (BrandID, 
				  BrandName, 
				  ContractName, 
				  CreateDate, 
				  CreateUser, 
				  [Description], 
				  EffectiveFromDate, 
				  EffectiveToDate, 
				  InsuranceCarrierID, 
				  InsuranceHealthPlanID, 
				  IsActive,
				  ModifyDate, 
				  ModifyUser)
	Values		(@brandID, 
				 @brandName, 
				 @contractName, 
				 getdate(), 
				 @createUser, 
				 @description, 
				 @effectiveFromDate, 
				 @effectiveToDate, 
				 @insuranceCarrierID, 
				 @insuranceHealthPlanID, 
				 @isActive, 
				 getdate(), 
				 @modifyUser) 
 END
END
-- =====================================================================================================
--SELECT * FROM [Insurance].[ContractProducts] 
--EXEC InsertorUpdateInsHealthPlanContractProducts 1, 'GNR',  'Scripts', 'Prem', null, 'RS Trust 17', 53, null, 1,  'Scripts', 1008, 600, 2250
-- =====================================================================================================
CREATE Procedure [dbo].[InsertorUpdateInsHealthPlanContractProducts]
	-- Add the parameters for the stored procedure here
				@contractProductID	BIGINT =0,
				@brandCode	NVARCHAR(MAX) = NULL,				
				@CreateUser	NVARCHAR(MAX) = NULL,
				@familyProductCatCode	NVARCHAR(MAX)= NULL,
				@familyProductCategoryFamilyProductID	BIGINT = NULL,
				@familyProductCode	NVARCHAR(MAX) = NULL,
				@healthPlanContractID	INT,
				@healthPlanContractID1	BIGINT,
				@isActive	BIT,				
				@modifyUser	NVARCHAR(MAX) = NULL,
				@perDeviceCOGSPrice	FLOAT,
				@perDeviceDispensingFee	FLOAT,
				@perDeviceMemberPrice	FLOAT
					 				
AS
BEGIN
	-- SET NOCOUNT ON added to prevent extra result sets from
	-- interfering with SELECT statements.
	SET NOCOUNT ON;
    -- Insert statements for procedure here
	if exists (SELECT 1 FROM [Insurance].[ContractProducts]  WHERE ContractProductID = @contractProductID and FamilyProductCatCode = @familyProductCatCode and FamilyProductCode = @familyProductCode and HealthPlanContractID = @healthPlanContractID)
	BEGIN
		UPDATE  [Insurance].[ContractProducts] 
		SET		    BrandCode = @brandCode,		
					FamilyProductCatCode = @familyProductCatCode,
					FamilyProductCategoryFamilyProductID = @familyProductCategoryFamilyProductID,
					FamilyProductCode = UPPER(@familyProductCode),
					HealthPlanContractID = @healthPlanContractID,
					HealthPlanContractID1 = @healthPlanContractID1,
					IsActive = @isActive,
					ModifyDate = getdate(),
					ModifyUser = @modifyUser,
					PerDeviceCOGSPrice =@perDeviceCOGSPrice ,
					PerDeviceDispensingFee = @perDeviceDispensingFee,
					PerDeviceMemberPrice = @perDeviceMemberPrice			
		WHERE   ContractProductID	= @contractProductID
	END
	ELSE 
	BEGIN
		INSERT INTO  [Insurance].[ContractProducts]  
				 (					
					BrandCode,
					CreateDate,
					CreateUser,
					FamilyProductCatCode,
					FamilyProductCategoryFamilyProductID,
					FamilyProductCode,
					HealthPlanContractID,
					HealthPlanContractID1,
					IsActive,
					ModifyDate,
					ModifyUser,
					PerDeviceCOGSPrice,
					PerDeviceDispensingFee,
					PerDeviceMemberPrice
				)
	Values		(
				@brandCode,
				getdate(),
				@CreateUser,
				@familyProductCatCode,
				@familyProductCategoryFamilyProductID,
				UPPER(@familyProductCode),
				@healthPlanContractID,
				@healthPlanContractID1,
				@isActive,
				getdate(),
				@modifyUser,
				@perDeviceCOGSPrice,
				@perDeviceDispensingFee,
				@perDeviceMemberPrice
				) 
	END	
END
CREATE Procedure [dbo].[InsertorUpdateInsHealthPlanBenefits]
	-- Add the parameters for the stored procedure here
				@ContractBenefitID	bigint = 0,
				@BenefitAmt	float = 0.0,
				@BenefitAmtPer	nvarchar(50) = null,
				@BenefitFrequencyYears	nvarchar(MAX) = null,
				@BenefitFrequencyYearsBy	nvarchar(50) = null,				
				@CreateUser	nvarchar(MAX) = null,
				@FittingCoPay float = 0.0,
				@HealthPlanContractID int,
				@HealthPlanContractInsuranceHealthPlanID bigint = null,
				@HearingAidCoPay float,
				@HearingAidCoPayPer	nvarchar(50)= null,
				@HearingExamCoPay	float,
				@InsurancePayerID	nvarchar(MAX) = null,
				@IsAbilityToBalanceBillMember bit,
				@IsActive	bit,
				@IsClaimEqualToProductListPricePerDevice	bit,
				@IsClaimPayToPatient	bit,
				@IsDefaultBenefit	bit,
				@IsFileClaim	bit,
				@IsHearingAidBenefitVerificationRequired	bit,
				@IsMedicaidIsSecondaryCoverage	bit,
				@IsPMNPM	bit,
				@IsPriorAuth	bit,
				@IsRebate	bit,				
				@ModifyUser	nvarchar(MAX) = NULL,
				@PMPMAmount	float,
				@RebatePercentage	int
				
				 				
AS
BEGIN
	-- SET NOCOUNT ON added to prevent extra result sets from
	-- interfering with SELECT statements.
	SET NOCOUNT ON;
    -- Insert statements for procedure here
	if exists (SELECT 1 FROM [Insurance].[ContractBenefits]  WHERE ContractBenefitID = @ContractBenefitID and HealthPlanContractID = @HealthPlanContractID)
	BEGIN
	
	UPDATE  [Insurance].[ContractBenefits] 
		SET		    BenefitAmt = @BenefitAmt,
					BenefitAmtPer = @BenefitAmtPer,
					BenefitFrequencyYears = @BenefitFrequencyYears,
					BenefitFrequencyYearsBy = @BenefitFrequencyYearsBy,					
					FittingCoPay = @FittingCoPay,
					HealthPlanContractID = @HealthPlanContractID ,
					HealthPlanContractInsuranceHealthPlanID = @HealthPlanContractInsuranceHealthPlanID,
					HearingAidCoPay = @HearingAidCoPay,
					HearingAidCoPayPer = @HearingAidCoPayPer,
					HearingExamCoPay = @HearingExamCoPay,
					InsurancePayerID = @InsurancePayerID,
					IsAbilityToBalanceBillMember = @IsAbilityToBalanceBillMember,
					IsActive = @IsActive,
					IsClaimEqualToProductListPricePerDevice = @IsClaimEqualToProductListPricePerDevice,
					IsClaimPayToPatient = @IsClaimPayToPatient,
					IsDefaultBenefit = @IsDefaultBenefit,
					IsFileClaim = @IsFileClaim,
					IsHearingAidBenefitVerificationRequired = @IsHearingAidBenefitVerificationRequired,
					IsMedicaidIsSecondaryCoverage = @IsMedicaidIsSecondaryCoverage,
					IsPMNPM = @IsPMNPM,
					IsPriorAuth = @IsPriorAuth,
					IsRebate = @IsRebate,
					ModifyDate = getdate(),
					ModifyUser = @ModifyUser,
					PMPMAmount = @PMPMAmount,
					RebatePercentage = @RebatePercentage				
		WHERE   ContractBenefitID = @ContractBenefitID
	END
	ELSE
	BEGIN		
		INSERT INTO  [Insurance].[ContractBenefits]  
				 (
					BenefitAmt,
					BenefitAmtPer,
					BenefitFrequencyYears,
					BenefitFrequencyYearsBy,
					CreateDate,
					CreateUser,
					FittingCoPay,
					HealthPlanContractID,
					HealthPlanContractInsuranceHealthPlanID,
					HearingAidCoPay,
					HearingAidCoPayPer,
					HearingExamCoPay,
					InsurancePayerID,
					IsAbilityToBalanceBillMember,
					IsActive,
					IsClaimEqualToProductListPricePerDevice,
					IsClaimPayToPatient,
					IsDefaultBenefit,
					IsFileClaim,
					IsHearingAidBenefitVerificationRequired,
					IsMedicaidIsSecondaryCoverage,
					IsPMNPM,
					IsPriorAuth,
					IsRebate,
					ModifyDate,
					ModifyUser,
					PMPMAmount,
					RebatePercentage
				)
	Values		(
				@BenefitAmt,
				@BenefitAmtPer,
				@BenefitFrequencyYears,
				@BenefitFrequencyYearsBy,
				getdate(),
				@CreateUser,
				@FittingCoPay,
				@HealthPlanContractID,
				@HealthPlanContractInsuranceHealthPlanID,
				@HearingAidCoPay,
				@HearingAidCoPayPer,
				@HearingExamCoPay,
				@InsurancePayerID,
				@IsAbilityToBalanceBillMember,
				@IsActive,
				@IsClaimEqualToProductListPricePerDevice,
				@IsClaimPayToPatient,
				@IsDefaultBenefit,
				@IsFileClaim,
				@IsHearingAidBenefitVerificationRequired,
				@IsMedicaidIsSecondaryCoverage,
				@IsPMNPM,
				@IsPriorAuth,
				@IsRebate,
				getdate(),
				@ModifyUser,
				@PMPMAmount,
				@RebatePercentage
				) 
	END	
END
create PROCEDURE [dbo].[anthem_elig_file_load_ssis_sp_merge] 
@Client_Name varchar(20)
AS

-- Anthem
IF @Client_Name = 'ELIG_AM'

BEGIN

	--BEGIN TRY
	--BEGIN TRANSACTION ELIG_MERGE_MEMBERS_AM

		EXEC [dbo].[anthem_elig_file_load_ssis_sp_merge_stg_to_anthemelig]

		EXEC [dbo].[anthem_elig_file_load_ssis_sp_merge_anthemelig_to_masters]

--	COMMIT TRANSACTION ELIG_MERGE_MEMBERS_AM
--	PRINT 'SUCCESS'
--	END TRY

--	BEGIN CATCH

--	IF (@@TRANCOUNT > 0)
--	BEGIN
--		ROLLBACK TRANSACTION ELIG_MERGE_MEMBERS_AM
--		PRINT 'FAILED'
--	END

--	END CATCH

END

-- Ultimate

--IF @Client_Name = 'ELIG_UT'

--BEGIN

--	BEGIN TRY
--	BEGIN TRANSACTION ELIG_MERGE_MEMBERS_UT

--		EXEC [dbo].[anthem_elig_file_load_ssis_sp_merge_amembers] 
		
--		EXEC [dbo].[anthem_elig_file_load_ssis_sp_merge_ainsurance] 

--		EXEC [dbo].[anthem_elig_file_load_ssis_sp_merge_mmembers] 

--		EXEC [dbo].[anthem_elig_file_load_ssis_sp_merge_minsurance] 

--	COMMIT TRANSACTION ELIG_MERGE_MEMBERS_UT
--	PRINT 'SUCCESS'
--	END TRY

--	BEGIN CATCH

--	IF (@@TRANCOUNT > 0)
--	BEGIN
--		ROLLBACK TRANSACTION ELIG_MERGE_MEMBERS_UT
--		PRINT 'FAILED'
--	END

--	END CATCH

--END

  CREATE Procedure [dbo].[proc_FilterModels] 
  @BrandID int,
  @EarmoldID int,
  @BrandFamilyID int,
  @FamilyProductID int,
  @ProductTypeID int,
  @TechnologyLevelID int   
   as
   begin
     
      declare @query varchar(max)

	  -- Brands (Start)
	--  begin
	  select * from Brands
	-- end
	 -- Brands (End)


	 -- EarmoldTypes (Start)
	BEGIN

	   set @query = ''
	   set @query  = 'select EarmoldID from Rule_EarmoldTypes where '

      if (@BrandID > 0)
	    set @query  = @query + ' BrandID = '+ CAST (@BrandID as varchar)+''
      else
	    set @query  = @query + '1 = 1'

		set @query = 'Select * from EarmoldTypes where EarmoldID in (' + @query + ')'

		-- print @query
		exec (@query)
	END
	 -- EarmoldTypes (End)


	 -- BrandFamilies (Start)
	  BEGIN

	  set @query = ''
	   set @query  = 'select BrandFamilyID from Rule_BrandFamilies where '

      if (@BrandID > 0)
	    set @query  = @query + ' BrandID = '+ CAST (@BrandID as varchar)+''
      else
	    set @query  = @query + '1 = 1'

		set @query = @query + ' And '

		 if (@EarmoldID > 0)
	    set @query  = @query + ' EarmoldID = '+ CAST (@EarmoldID as varchar)+''
      else
	    set @query  = @query + '1 = 1'

		set @query = 'Select * from BrandFamilies where BrandFamilyID in (' + @query + ')'

		--print @query
		exec (@query)

	 END
	 -- BrandFamilies (End)

	 -- Family Products (Start)
	 BEGIN

	  set @query = ''
	   set @query  = 'select FamilyProductID from Rule_FamilyProducts where '

      if (@BrandFamilyID > 0)
	    set @query  = @query + ' BrandFamilyID = '+ CAST (@BrandFamilyID as varchar)+''
      else
	    set @query  = @query + '1 = 1'

		set @query = @query + ' And '

		 if (@TechnologyLevelID > 0)
	    set @query  = @query + ' TechnologyLevelID = '+ CAST (@TechnologyLevelID as varchar)+''
      else
	    set @query  = @query + '1 = 1'

		set @query = 'Select * from FamilyProducts where FamilyProductID in (' + @query + ')'

		--print @query
		exec (@query)

	 END
	 -- Family Products (End)


	 -- Product Type (Start)
	 BEGIN

	  set @query = ''
	   set @query  = 'select ProductTypeID from Rule_ProductTypes where '

      if (@BrandFamilyID > 0)
	    set @query  = @query + ' BrandFamilyID = '+ CAST (@BrandFamilyID as varchar)+''
      else
	    set @query  = @query + '1 = 1'

		set @query = @query + ' And '

		 if (@FamilyProductID > 0)
	    set @query  = @query + ' FamilyProductID = '+ CAST (@FamilyProductID as varchar)+''
      else
	    set @query  = @query + '1 = 1'

		set @query = 'Select * from ProductTypes where ProductTypeID in (' + @query + ')'

		--print @query
	 exec (@query)

	 END
	 -- Product Type (End)

	 -- Technology Levels (Start)
	 BEGIN

	   set @query = ''
	   set @query  = 'select TechnologyLevelID from Rule_TechnologyLevels where '

      if (@BrandFamilyID > 0)
	    set @query  = @query + ' BrandFamilyID = '+ CAST (@BrandFamilyID as varchar)+''
      else
	    set @query  = @query + '1 = 1'

		set @query = @query + ' And '

		 if (@ProductTypeID > 0)
	    set @query  = @query + ' ProductTypeID = '+ CAST (@ProductTypeID as varchar)+''
      else
	    set @query  = @query + '1 = 1'

		set @query = 'Select * from TechnologyLevels where TechnologyLevelID in (' + @query + ')'

		--print @query
		exec (@query)

	 END
	 -- Technology Levels (End)

	 -- Product Models (Start)
	  BEGIN
	  
	   set @query = ''
	   set @query  = 'select ProductModelID from Rule_ProductModels where '

      if (@BrandID > 0 and @EarmoldID = 0)
	    set @query  =  @query + ' BrandID = '+ CAST (@BrandID as varchar)+''
	  else
	    set @query  = @query + '1 = 1'

		set @query = @query + ' And '

		if (@EarmoldID > 0)
	    set @query  = @query + ' EarmoldID = '+ CAST (@EarmoldID as varchar)+''
      else
	    set @query  = @query + '1 = 1'
		
		set @query = @query + ' And '

		if (@BrandFamilyID > 0)
	    set @query  = @query + ' BrandFamilyID = '+ CAST (@BrandFamilyID as varchar)+''
      else
	    set @query  = @query + '1 = 1'

		set @query = @query + ' And '

		if (@ProductTypeID > 0)
	    set @query  = @query + ' ProductTypeID = '+ CAST (@ProductTypeID as varchar)+''
      else
	    set @query  = @query + '1 = 1'

		set @query = @query + ' And '

		if (@TechnologyLevelID > 0)
	    set @query  = @query + ' TechnologyLevelID = '+ CAST (@TechnologyLevelID as varchar)+''
      else
	    set @query  = @query + '1 = 1'

        set @query = 'select * from ProductModels where ProductModelID in (' + @query + ')' 

     	-- print @query
		 exec (@query)

		End  
		-- Product Models (End)
		 
   end




 --EXEC proc_FilterModels @BrandID = 1, @EarmoldID = 2, @BrandFamilyID = 0, @FamilyProductID = 0, @ProductTypeID = 0, @TechnologyLevelID = 0;

  
-- =============================================
--EXEC InsertOrUpdateScriptSectionTypes 11, 'Scripts', 1, 'Scripts','Introduction100'
--SELECT * FROM [CallCenter].[ScriptSectionTypes]
-- =============================================
CREATE Procedure [dbo].[InsertOrUpdateScriptSectionTypes]
(
    -- Add the parameters for the stored procedure here
	  @scriptSectionTypeId	BIGINT = 0,		 
	  @createUser	NVARCHAR(150)= null,
	  @isActive	BIT,	 
	  @modifyUser	NVARCHAR(150) = null,
	  @scriptSectionTypeName NVARCHAR(50) = null
	 
)
AS
BEGIN
    -- SET NOCOUNT ON added to prevent extra result sets from
    -- interfering with SELECT statements.
    SET NOCOUNT ON

    -- Insert statements for procedure here
  if not exists (SELECT 1 FROM [CallCenter].[ScriptSectionTypes])
	BEGIN
		DBCC CHECKIDENT ('[CallCenter].[ScriptSectionTypes]', RESEED, 1) 
	END
	if exists (SELECT 1 FROM [CallCenter].[ScriptSectionTypes]  WHERE ScriptSectionTypeName = @scriptSectionTypeName)
 BEGIN
 UPDATE [CallCenter].[ScriptSectionTypes]
		SET 
		IsActive = @isActive,	
		ModifyDate = getdate(),	
		ModifyUser = @modifyUser,	
		ScriptSectionTypeName = @scriptSectionTypeName
		WHERE ScriptSectionTypeId = @scriptSectionTypeId
 END
 ELSE
 BEGIN
	INSERT INTO  [CallCenter].[ScriptSectionTypes]
	(
	CreateDate,	
	CreateUser,	
	IsActive,	
	ModifyDate,	
	ModifyUser,	
	ScriptSectionTypeName	
	)
	VALUES
	(
		getdate(),	
		@createUser,	
		@isActive,	
		getdate(),	
		@modifyUser,	
		@scriptSectionTypeName	
	)
	END	
END
-- =====================================================================================================
-- select * from [Insurance].[HealthPlanTollFreeNumbers]
--EXEC InsertorUpdateInsHealthPlanTollFreeNumbers 0,  'Scripts', '11/12/2017', '11/30/2018', 8, 38, 1,  'Scripts', 'www.test100.com', 0, 'Training', 1234567890
-- =====================================================================================================
CREATE Procedure [dbo].[InsertorUpdateInsHealthPlanTollFreeNumbers]
	-- Add the parameters for the stored procedure here
				 @healthPlanTollID bigint = 0,				
				 @createSource NVARCHAR(150), 
				 @effectiveFromDate DATETIME,
				 @effectiveToDate DATETIME,
				 @insuranceCarrierID BIGINT,
				 @insuranceHealthPlanID bigint,
				 @isActive BIT,				
				 @modifySource NVARCHAR(150) = null,
				 @screenPopUpUrl NVARCHAR(2000) = NULL,
				 @scriptID bigint,
				 @tollFreeCategory nvarchar(50) = NULL,
				 @tollFreeNbr bigint
				 				
AS
BEGIN
	-- SET NOCOUNT ON added to prevent extra result sets from
	-- interfering with SELECT statements.
	SET NOCOUNT ON;
    -- Insert statements for procedure here
	if exists (SELECT 1 FROM [Insurance].[HealthPlanTollFreeNumbers]  WHERE HealthPlanTollID = @healthPlanTollID and InsuranceCarrierID = @insuranceCarrierID and InsuranceHealthPlanID = @insuranceHealthPlanID and ScriptID = @scriptID)
	BEGIN
	UPDATE  [Insurance].[HealthPlanTollFreeNumbers] 
		SET		EffectiveFromDate = @effectiveFromDate,
				EffectiveToDate = @effectiveToDate,				 
				InsuranceCarrierID= @insuranceCarrierID,
				InsuranceHealthPlanID = @insuranceHealthPlanID,
				IsActive = @isActive,
				ModifyDate = getdate(), 
				ModifyUser = @modifySource,
				ScreenPopUpUrl = @screenPopUpUrl,
				ScriptID = @scriptID,
				TollFreeCategory = @tollFreeCategory,
				TollFreeNbr = @tollFreeNbr
		WHERE   HealthPlanTollID = @healthPlanTollID
	END
	ELSE
	BEGIN		
	INSERT INTO [Insurance].[HealthPlanTollFreeNumbers] 
				(CreateDate, 
				CreateUser, 
				EffectiveFromDate, 
				EffectiveToDate, 
				InsuranceCarrierID, 
				InsuranceHealthPlanID, 
				IsActive, 
				ModifyDate,
				ModifyUser, 
				ScreenPopUpUrl, 
				ScriptID, 
				TollFreeCategory, 
				TollFreeNbr)
	  VALUES	(getdate(), 
				 @createSource, 
				 @effectiveFromDate, 
				 @effectiveToDate, 
				 @insuranceCarrierId, 
				 @insuranceHealthPlanID, 
				 @isActive, 
				 getdate(), 
				 @modifySource, 
				 @screenPopupUrl, 
				 @scriptId, 
				 @tollFreeCategory, 
				 @tollFreeNbr)
		
	END
	
END

-- =============================================
--SELECT * FROM [CallCenter].[ScriptSections] 
--EXEC InsertorUpdateScriptSections @scriptSectionID, @createUser, @isActive, @modifyUser, @scriptID, @scriptSectionTypeId, @sectionScriptDescription
--EXEC InsertorUpdateScriptSections 2, 'Scripts', 1,  'Scripts', 1, 2,	'<h5>Collecting the Member Information</h5><p>script not available</p>'
-- =============================================
CREATE Procedure [dbo].[InsertorUpdateScriptSections]
(
    -- Add the parameters for the stored procedure here
		@scriptSectionID	BIGINT = 0,			
		@createUser	NVARCHAR(150) = null,
		@isActive	BIT,		
		@modifyUser	NVARCHAR(150) = null,
		@scriptID BIGINT,	
		@scriptSectionTypeId BIGINT,	
		@sectionScriptDescription NVARCHAR(MAX)	= null
		
)
AS
BEGIN
    -- SET NOCOUNT ON added to prevent extra result sets from
    -- interfering with SELECT statements.
    SET NOCOUNT ON

    -- Insert statements for procedure here
	if exists (SELECT 1 FROM [CallCenter].[ScriptSections]  WHERE ScriptSectionID = @scriptSectionID)
 BEGIN
 UPDATE [CallCenter].[ScriptSections] 
	SET		
		isActive = @isActive,
		modifyDate =  getdate(),
		modifyUser = @modifyUser,
		scriptID = @scriptID,	
		scriptSectionTypeId = scriptSectionTypeId,	
		sectionScriptDescription = 	@sectionScriptDescription
	WHERE ScriptSectionID = @scriptSectionID and scriptID = @scriptID	
	END
	ELSE 
	BEGIN
		INSERT INTO [CallCenter].[ScriptSections] 
	(		
		createDate,	
		createUser,
		isActive,
		modifyDate ,
		modifyUser,
		scriptID,	
		scriptSectionTypeId,	
		sectionScriptDescription		
	)
	VALUES
	(			
		getdate(),	
		@createUser,
		@isActive,
		getdate(),
		@modifyUser,
		@scriptID,	
		@scriptSectionTypeId,	
		@sectionScriptDescription
	)
	END
   
END
-- =====================================================================================================
-- SELECT * FROM [Insurance].[InsuranceHealthPlans]
-- EXEC InsertorUpdateInsHealthPlans 20, 'Scripts', 'Anthem MediBlue Access (PPO', 'NULL', 6, 1, 'Scripts', 0
-- =====================================================================================================
CREATE PROCEDURE [dbo].[InsertorUpdateInsHealthPlans]
	-- Add the parameters for the stored procedure here	 
				@insuranceHealthPlanID bigint = 0,				
				 @createSource NVARCHAR(150), 				 
				 @healthPlanName NVARCHAR(50), 
				 @healthPlanNumber NVARCHAR(max) = null, 
				 @insuranceCarrierID BIGINT,
				 @isActive BIT,
				 @modifySource NVARCHAR(150) = null,
				 @isDiscountProgram Nvarchar(10)
				 				
AS
BEGIN
	-- SET NOCOUNT ON added to prevent extra result sets from
	-- interfering with SELECT statements.
	SET NOCOUNT ON;
    -- Insert statements for procedure here
	if not exists (SELECT 1 FROM [Insurance].[InsuranceHealthPlans])
	BEGIN
		DBCC CHECKIDENT ('[Insurance].[InsuranceHealthPlans]', RESEED, 1) 
	END
	if exists (SELECT 1 FROM [Insurance].[InsuranceHealthPlans]  WHERE HealthPlanName = @healthPlanName and InsuranceCarrierID = @insuranceCarrierID)
 BEGIN
	UPDATE  [Insurance].[InsuranceHealthPlans] 
		SET		HealthPlanName = @healthPlanName,
				HealthPlanNumber = @healthPlanNumber,				 
				InsuranceCarrierID= @insuranceCarrierID,
				IsActive = @isActive,
				ModifyDate = getdate(), 
				ModifyUser = @modifySource,
				IsDiscountProgram = @isDiscountProgram
		WHERE   InsuranceHealthPlanID = @insuranceHealthPlanID
 END
 ELSE
 BEGIN
  INSERT INTO [Insurance].[InsuranceHealthPlans] 
				 (CreateDate, 
				  CreateUser, 
				  HealthPlanName, 
				  HealthPlanNumber, 
				  InsuranceCarrierID, 
				  IsActive, 
				  ModifyDate, 
				  ModifyUser,
				  IsDiscountProgram) 
	 VALUES		 (getdate(),
				  @createSource, 
				  @healthPlanName, 
				  @healthPlanNumber, 
				  @insuranceCarrierID, 
				  @isActive, 
				  getdate(),			
				  @modifySource,
				  @isDiscountProgram) 
 END
	
END
CREATE PROCEDURE [dbo].[sp_SearchMemberCall](      
       @MemberID           BIGINT = NULL,       
       @NHMemberID         NVARCHAR(50) = NULL,       
       @FirstName          NVARCHAR(250) = NULL,      
       @LastName           NVARCHAR(50) = NULL,      
       @DateOfBirth        DATETIME = NULL,      
       @Gender             NVARCHAR(10) = NULL,      
       @MaritalStatus      NVARCHAR(25) = NULL,      
       @Address1           NVARCHAR(500) = NULL,      
       @Address2           NVARCHAR(500) = NULL,      
       @City               NVARCHAR(50) = NULL,      
       @State              NVARCHAR(10) = NULL,      
       @Country            NVARCHAR(50) = NULL,      
       @ZipCode            NVARCHAR(10) = NULL,       
       @EmailAddress       NVARCHAR(50) = NULL,       
       @Phone               NVARCHAR(50) = NULL,      
       @InsuranceHealthPlanNumber NVARCHAR(250) = NULL,      
       @InsuranceHealthPlanName NVARCHAR(250) = NULL,      
       @InsuranceCarrierName NVARCHAR(250) = NULL,     
	   @SearchFilterCarrierId  NVARCHAR(250) = NULL,
       @OrderID BIGINT = 0)      
AS      
BEGIN      
       SET NOCOUNT ON;      
      SET ANSI_WARNINGS OFF;    
       DECLARE @SQLQueryRes AS NVARCHAR(4000)      
       DECLARE @SQLQuery AS NVARCHAR(4000)      
       DECLARE @SQLQueryM AS NVARCHAR(2000)      
       DECLARE @SQLQueryA AS NVARCHAR(2000)      
       DECLARE @SQLQueryP AS NVARCHAR(2000)      
       DECLARE @SQLQueryI AS NVARCHAR(2000)      
       DECLARE @tables AS VARCHAR(50)      
       DECLARE @Where AS VARCHAR(500)      
       DECLARE @DateOfBirth1  AS VARCHAR(20) = NULL      
      
       set @LastName = REPLACE(@LastName,'''','''''')      
      
       set @FirstName = REPLACE(@FirstName,'''','''''')      
      
       SET @DateOfBirth1 = cast(@DateOfBirth as datetime)      
      
      
       SET @SQLQuery = 'SELECT DISTINCT TOP 100 M.MemberID, m.NHMEMBERID from '      
      
       SET @SQLQueryM = 'Master.Members m where  1 = 1 '      
      
       SET @SQLQueryP = 'Master.Members m , Master.PhoneNumbers p where 1 = 1 and m.memberid = p.memberid '      
      
       SET @SQLQueryA = 'Master.Members m , Master.Addresses a where 1 = 1 and m.memberid = a.memberid '      
      
       SET @SQLQueryI = 'master.members m where exists (select 1 from (      
       select mi.memberid from master.MemberInsurances mi      
       where exists (select 1 from Master.MemberInsuranceDetails mid where       
                                                       mid.memberinsuranceid = mi.id and mid.InsuranceNbr  = '      
      
       if (@FirstName is not null )      
              Begin      
              set @tables = 'MEMBER'      
              set @Where = ' and m.firstname like '''+@FirstName+'%'''      
                     if @ZipCode is not null       
                           Begin      
                                  set @tables = 'MEMBERADDRESS'      
                                  set @Where = @Where + ' and a.ZipCode like '''+@ZipCode+'%'''      
                         End      
                     else      
                           Begin      
                                  if @LastName is not null      
                                         set @Where = @Where + ' and m.lastname like '''+@LastName+'%'''      
                                  if @DateOfBirth1 is not null      
                                         set @Where = @Where + ' and m.DateOfBirth = cast('''+@DateOfBirth1+''''+' as datetime)'      
                           End      
           End      
       else      
      
if (@LastName is not null )      
              Begin      
              set @tables = 'MEMBER'      
              set @Where = ' and m.lastname like '''+@LastName+'%'''      
                     if @ZipCode is not null       
                           Begin      
                                  set @tables = 'MEMBERADDRESS'      
                                  set @Where = @Where + ' and a.ZipCode like '''+@ZipCode+'%'''      
                         End      
                     else      
                           Begin      
                                  if @FirstName is not null      
                                         set @Where = @Where + ' and m.firstname like '''+@FirstName+'%'''      
                                  if @DateOfBirth1 is not null      
               set @Where = @Where + ' and m.DateOfBirth = cast('''+@DateOfBirth1+''''+' as datetime)'      
                           End      
           End      
       else if (@DateOfBirth1 is not null)      
              Begin      
                     set @tables = 'MEMBER'      
                     set @Where = ' and m.DateOfBirth = cast('''+@DateOfBirth1+''''+' as datetime)'      
              End      
       else if (@Phone is not null)      
              Begin      
                     set @tables = 'PHONE'      
                     set @Where = ' and p.PhoneNbr = '+@Phone      
              End      
       else if (@Address1 is not null)      
              Begin      
                     set @tables = 'ADDRESS'      
                     set @Where = ' and a.Address1 like '''+@Address1+'%'''      
                     if @ZipCode is not null      
                           set @Where = @Where + ' and a.ZipCode like '''+@ZipCode+'%'''     
         set @ZipCode = NULL   
              End    
      else if (@Address2 is not null)      
              Begin      
                     set @tables = 'ADDRESS'      
                     set @Where = ' and a.Address2 like '''+@Address2+'%'''      
                     if @ZipCode is not null      
                           set @Where = @Where + ' and a.ZipCode like '''+@ZipCode+'%'''   
         set @ZipCode = NULL     
              End   
      else if (@City is not null)      
              Begin      
                     set @tables = 'ADDRESS'      
                     set @Where = ' and a.City like '''+@City+'%'''      
                     if @ZipCode is not null      
                           set @Where = @Where + ' and a.ZipCode like '''+@ZipCode+'%'''      
         set @ZipCode = NULL  
              End    
      else if (@State is not null)      
              Begin      
                     set @tables = 'ADDRESS'      
                     set @Where = ' and a.State like '''+@State+'%'''      
                     if @ZipCode is not null      
                           set @Where = @Where + ' and a.ZipCode like '''+@ZipCode+'%'''    
         set @ZipCode = NULL    
              End              
    
        
            
      
       IF @tables = 'MEMBER'      
              set @SQLQUERY = @SQLQUERY + @SQLQUERYM + @Where      
       else if @tables = 'ADDRESS'      
              set @SQLQUERY = @SQLQUERY + @SQLQUERYA + @Where      
       else if @tables = 'PHONE'      
              set @SQLQUERY = @SQLQUERY + @SQLQUERYP + @Where      
       else if @tables = 'MEMBERADDRESS'      
              set @SQLQUERY = @SQLQUERY + @SQLQUERYA + @Where      
       else if @tables = 'INSURANCE'      
              set @SQLQUERY = @SQLQUERY + @SQLQUERYI + @Where + ')) a where a.memberid = m.memberid)'      
       else      
              set @SQLQUERY = @SQLQUERY + '  master.members m'      
      
     --- Added BY MOIN (Code to Search By NHMemberID)    
  IF @NHMemberID IS NOT NULL    
  BEGIN    
   IF @Where IS NOT NULL    
   BEGIN    
   SET @SQLQUERY = @SQLQUERY + ' ' + 'AND m.NHMemberID = '''+@NHMemberID+''''    
   END    
   ELSE    
   BEGIN    
    SET @SQLQUERY = @SQLQUERY + ' ' + 'where m.NHMemberID = '''+@NHMemberID+''''    
   END    
  END    
  --- END Added by MOIN    
 IF @InsuranceHealthPlanNumber IS NOT NULL
 BEGIN
  print @SQLQUERY
  print @SQLQueryRes
  SET @SQLQUERY = @SQLQUERY + ' '  + 'where md.InsuranceNbr like ''%'+@InsuranceHealthPlanNumber+'%''' 
  SET @SQLQUERY = (SELECT REPLACE(@SQLQuery,'TOP 100',''))      
 END

 IF @ZipCode IS NOT NULL  
   BEGIN  
    SET @SQLQUERY = (SELECT REPLACE(@SQLQuery,'TOP 100','')) 
    SET @SQLQUERY = @SQLQUERY + ' ' + 'where a.ZipCode LIKE '''+@ZipCode+'%'''   
   END
  
  ---Newly Added - Ramu 
    IF @SearchFilterCarrierId IS NOT NULL
   BEGIN 
	IF @NHMemberID IS NULL AND @FirstName IS NULL AND @LastName IS NULL AND @DateOfBirth1 IS NULL AND @Address1 IS NULL AND @Address2 IS NULL 
	AND @City IS NULL AND @State IS NULL AND @ZipCode IS NULL AND @Phone IS NULL AND @InsuranceHealthPlanNumber IS NULL AND @OrderID = 0
		BEGIN
		SET @SQLQUERY = (SELECT REPLACE(@SQLQuery,'TOP 100','')) 
		SET @SQLQUERY = @SQLQUERY + ' ' + 'WHERE mi.InsuranceCarrierID = '+@SearchFilterCarrierId
		END
	ELSE IF @OrderID IS NOT NULL
	BEGIN
		SET @SQLQUERY = (SELECT REPLACE(@SQLQuery,'TOP 100','')) 
		SET @SQLQUERY = @SQLQUERY + ' ' + 'WHERE mi.InsuranceCarrierID = '+@SearchFilterCarrierId
	END
	ELSE
	BEGIN
		SET @SQLQUERY = (SELECT REPLACE(@SQLQuery,'TOP 100','')) 
		SET @SQLQUERY = @SQLQUERY + ' ' + 'AND mi.InsuranceCarrierID = '+@SearchFilterCarrierId
	END
   END  
                    
    IF (@OrderID > 0)      
       BEGIN      
       DECLARE @Order VARCHAR(10);      
       SET @Order = CAST(@OrderID AS VARCHAR(10))      
    IF(@SQLQuery = 'SELECT DISTINCT TOP 100 M.MemberID, m.NHMEMBERID from   master.members m')      
    BEGIN      
      SET @SQLQueryRes = 'SELECT TOP 1 M.MemberID,CAST(1 AS BIGINT) AS RowID,  
   M.NHMemberID NhMemberNbr,M.FirstName,M.LastName,convert(varchar,(M.DateOfBirth),101) DOB,      
              A.Address1 Address,A.Address2,A.City,A.State,A.Country,A.ZipCode zip,A.AddressTypeCode,      
                 MD.InsuranceNbr PlanProgramID, IC.InsuranceCarrierName,IH.HealthPlanName,ISNULL(O.OrderID,0) AS OrderNumber      
       FROM [Master].Members M      
       LEFT JOIN (select * from Orders.Orders WITH (NOLOCK) where IsActive = 1) O ON O.NHMemberId = M.NHMemberID         
       LEFT JOIN (select * from [Master].Addresses WITH (NOLOCK) where IsActive = 1) A  on (M.MemberID=A.MemberID and a.IsPreferredAddress=1)      
       LEFT JOIN (select * from [Master].MemberInsurances WITH (NOLOCK) where IsActive = 1) MI  on M.MemberID=MI.MemberID      
       LEFT JOIN (select * from [Master].MemberInsuranceDetails WITH (NOLOCK) where IsActive = 1) MD  on MI.ID=MD.MemberInsuranceID     
       LEFT JOIN Insurance.InsuranceCarriers IC	WITH (NOLOCK)  on MI.InsuranceCarrierID=IC.InsuranceCarrierID      
       LEFT JOIN Insurance.InsuranceHealthPlans IH	WITH (NOLOCK)  on MI.InsuranceHealthPlanID=IH.InsuranceHealthPlanID      
       WHERE m.IsActive=1 AND O.OrderID ='+@Order+' order  by LastName,FirstName'      
    END      
    ELSE      
    BEGIN      
       SET @SQLQueryRes = 'SELECT DISTINCT TOP 1 M.MemberID,ROW_NUMBER() OVER (ORDER BY MD.InsuranceNbr) RowID,M.NHMemberID NhMemberNbr,M.FirstName,M.LastName,convert(varchar,(M.DateOfBirth),101) DOB,      
              A.Address1 Address,A.Address2,A.City,A.State,A.Country,A.ZipCode zip,A.AddressTypeCode,      
                 MD.InsuranceNbr PlanProgramID, IC.InsuranceCarrierName,IH.HealthPlanName,ISNULL(O.OrderID,0) AS OrderNumber      
       FROM [Master].Members M      
       LEFT JOIN (select * from Orders.Orders WITH (NOLOCK) where IsActive = 1) O ON O.NHMemberId = M.NHMemberID         
       LEFT JOIN (select * from [Master].Addresses WITH (NOLOCK) where IsActive = 1) A  on (M.MemberID=A.MemberID and a.IsPreferredAddress=1)      
       LEFT JOIN (select * from [Master].MemberInsurances WITH (NOLOCK) where IsActive = 1) MI  on M.MemberID=MI.MemberID      
       LEFT JOIN (select * from [Master].MemberInsuranceDetails WITH (NOLOCK) where IsActive = 1) MD  on MI.ID=MD.MemberInsuranceID       
       LEFT JOIN Insurance.InsuranceCarriers IC	WITH (NOLOCK)  on MI.InsuranceCarrierID=IC.InsuranceCarrierID      
       LEFT JOIN Insurance.InsuranceHealthPlans IH	WITH (NOLOCK)  on MI.InsuranceHealthPlanID=IH.InsuranceHealthPlanID      
       WHERE m.IsActive=1 AND O.OrderID ='+@Order+'  AND m.memberid in ( select memberid from (' + @SQLQuery + ')sq ) order  by LastName,FirstName'      
    END      
       END      
       ELSE      
       BEGIN      
       SET @SQLQueryRes = 'SELECT DISTINCT  TOP 50 M.MemberID,ROW_NUMBER() OVER (ORDER BY MD.InsuranceNbr) RowID,M.NHMemberID NhMemberNbr,M.FirstName,M.LastName,convert(varchar,(M.DateOfBirth),101) DOB,      
              A.Address1 Address,A.Address2,A.City,A.State,A.Country,A.ZipCode zip,A.AddressTypeCode,      
                 MD.InsuranceNbr PlanProgramID, IC.InsuranceCarrierName,IH.HealthPlanName,ISNULL(MAX(O.OrderID),0) AS OrderNumber      
       FROM [Master].Members M      
       LEFT JOIN (select * from Orders.Orders WITH (NOLOCK) where IsActive = 1) O ON O.NHMemberId = M.NHMemberID         
       LEFT JOIN (select * from [Master].Addresses WITH (NOLOCK) where IsActive = 1) A  on (M.MemberID=A.MemberID and a.IsPreferredAddress=1)      
       LEFT JOIN (select * from [Master].MemberInsurances WITH (NOLOCK) where IsActive = 1) MI  on M.MemberID=MI.MemberID      
       LEFT JOIN (select * from [Master].MemberInsuranceDetails WITH (NOLOCK) where IsActive = 1) MD  on MI.ID=MD.MemberInsuranceID    
       LEFT JOIN Insurance.InsuranceCarriers IC	WITH (NOLOCK)  on MI.InsuranceCarrierID=IC.InsuranceCarrierID      
       LEFT JOIN Insurance.InsuranceHealthPlans IH	WITH (NOLOCK)  on MI.InsuranceHealthPlanID=IH.InsuranceHealthPlanID      
       WHERE m.IsActive=1 AND m.memberid in ( select memberid from (' + @SQLQuery + ')sq )       
       group by M.MemberID,M.NHMemberID,M.FirstName,M.LastName,A.Address1,A.Address2,A.City,A.State,A.Country,A.ZipCode,A.AddressTypeCode,      
       MD.InsuranceNbr, IC.InsuranceCarrierName,IH.HealthPlanName,M.DateOfBirth order by LastName,FirstName'      
       END      
      
  IF @NHMemberID IS NOT NULL    
  BEGIN  
  SET @SQLQueryRes = (SELECT REPLACE(@SQLQueryRes,'TOP 50','TOP 1'))  
  --SET @SQLQueryRes = (SELECT REPLACE(@SQLQueryRes,'where a.ZipCode','and a.ZipCode'))
  END  
  
  PRINT @SQLQueryRes      
             
   EXECUTE sp_ExecuteSQL @SQLQueryRes      
             
      
    IF @@ERROR <> 0 GoTo ErrorHandler      
    Set NoCount OFF      
    Return(0)      
        
ErrorHandler:      
    Return(@@ERROR)      
END 
-- =============================================
-- Author:		<Author,,Name>
-- Create date: <Create Date,,>
-- Description:	<Description,,>
-- =============================================
CREATE Procedure [dbo].[SP_Update_TimeZone_ByStates]
	@StateColumnName nvarchar(50), 
	@TimeZoneColumnName nvarchar(50)
AS
BEGIN
update [dbo].[MasterProviderList]
set [Timezone] = 
case 
when FacilityState in ('WA','OR','NE','CO','CA','NV') then 'Pacific Time'
when FacilityState in ('NY','NJ','VT','ME','NH','MA','RI','CT','PA','DE','MD','DC','VA','WV','MI','IN','OH','KY','NC','GA','FL','SC') then 'Eastern Time' 
when FacilityState in ('MT','ID','WY','UT', 'CO','AZ','NM')  then 'Mountain Time'
when FacilityState in ('ND','SD','NE','KS','OK','TX','MN','IA','MO','AR','LA','WI','IL','TN','MS','AL')  then 'Central Time'
when FacilityState in ('AK') then 'Alaska Time'
when FacilityState in ('HA') then 'Hawaii-Aleutian Time' end

END

-- =============================================
-- Author:		KALYANA GOBBURI
-- Create date: 4-Nov-2017
-- Description:	PROCEDURE for Member Search Results
-- =============================================
CREATE Procedure [dbo].[sp_SearchMember_OLD](
	-- Add the parameters for the stored procedure here
	@MemberID           BIGINT = NULL, 
    @NHMemberID         NVARCHAR(50) = NULL, 
	@FirstName          NVARCHAR(250) = NULL,
    @LastName           NVARCHAR(50) = NULL,
	@DateOfBirth        DATETIME = NULL,
	@Gender             NVARCHAR(10) = NULL,
	@MaritalStatus      NVARCHAR(25) = NULL,
	@Address1           NVARCHAR(500) = NULL,
	@Address2           NVARCHAR(500) = NULL,
	@City               NVARCHAR(50) = NULL,
	@State              NVARCHAR(10) = NULL,
	@Country            NVARCHAR(50) = NULL,
	@ZipCode            NVARCHAR(10) = NULL, 
    @EmailAddress       NVARCHAR(50) = NULL, 
    @Phone              BIGINT = NULL,
	@InsuranceHealthPlanNumber NVARCHAR(250) = NULL,
	@InsuranceHealthPlanName NVARCHAR(250) = NULL,
	@InsuranceCarrierName NVARCHAR(250) = NULL)
AS
BEGIN
	-- SET NOCOUNT ON added to prevent extra result sets from
	-- interfering with SELECT statements.
	SET NOCOUNT ON;

    SELECT DISTINCT M.MemberID,M.NHMemberID,M.FirstName,M.LastName,M.DateOfBirth,M.Gender,M.MiddleInitial,M.IsActive,
	       A.Address1,A.Address2,A.City,A.State,A.Country,A.ZipCode,A.AddressTypeCode,
	       P.PhoneNbr,P.CountryCode,P.IsPreferredPhoneNumber,P.PhoneExtension,
		   EM.EmailAddress,
		   MA.AttributeTypeCode,MA.AttributeValue,
		   MI.InsuranceCarrierID,MI.InsuranceEffectiveDate,MI.InsuranceHealthPlanID,MI.InsuranceType,
		   MD.InsuranceNbr,
		   IC.InsuranceCarrierName,IC.MemberDataFileProvided,
		   IH.HealthPlanName,IH.HealthPlanNumber
	FROM Master.Members M
	LEFT JOIN Master.Addresses A on M.MemberID=A.MemberID
	LEFT JOIN Master.PhoneNumbers P on M.MemberID=P.MemberID
	LEFT JOIN Master.Emails EM on M.MemberID = EM.MemberID
	LEFT JOIN Master.MemberAttributes MA on M.MemberID=MA.MemberID
	LEFT JOIN Master.MemberInsurances MI on M.MemberID=MI.MemberID
	LEFT JOIN Master.MemberInsuranceDetails MD on MI.ID=MD.MemberInsuranceID
	LEFT JOIN Insurance.InsuranceCarriers IC on MI.InsuranceCarrierID=IC.InsuranceCarrierID
	LEFT JOIN Insurance.InsuranceHealthPlans IH on MI.InsuranceHealthPlanID=IH.InsuranceHealthPlanID
	WHERE M.MemberID=@MemberID
	OR M.NHMemberID=@NHMemberID
	OR LOWER(M.FirstName) LIKE LOWER('%'+@FirstName+'%')
	OR LOWER(M.LastName) LIKE LOWER('%'+@LastName+'%')
	OR M.DateOfBirth=@DateOfBirth
	OR LOWER(M.Gender) LIKE LOWER(@Gender)
	OR LOWER(M.MaritalStatus) LIKE LOWER(@MaritalStatus)
	OR LOWER(A.Address1) LIKE LOWER('%'+@Address1+'%')
	OR LOWER(A.Address2) LIKE LOWER('%'+@Address2+'%')
	OR LOWER(A.City) LIKE LOWER('%'+@City+'%')
	OR LOWER(A.State) LIKE LOWER(@State)
	OR LOWER(A.Country) LIKE LOWER(@Country)
	OR A.ZipCode LIKE @ZipCode
	OR LOWER(EM.EmailAddress) LIKE LOWER(@EmailAddress)
	OR P.PhoneNbr=@Phone
	OR LOWER(IH.HealthPlanNumber) LIKE LOWER(@InsuranceHealthPlanNumber)
	OR LOWER(IH.HealthPlanName) LIKE LOWER(@InsuranceHealthPlanName)
	OR LOWER(IC.InsuranceCarrierName) LIKE LOWER(@InsuranceCarrierName)
END



--EXEC [dbo].[sp_SearchMember] @MemberID = NULL , 
--    @NHMemberID  = NULL, 
--	@FirstName = 'David',
--    @LastName = NULL,
--	@DateOfBirth= NULL,
--	@Gender = NULL,
--	@MaritalStatus = NULL,
--	@Address1 = NULL,
--	@Address2 = NULL,
--	@City = NULL,
--	@State = NULL,
--	@Country = NULL,
--	@ZipCode = NULL, 
--    @EmailAddress = NULL, 
--    @Phone  = NULL,
--	@InsuranceHealthPlanNumber = NULL,
--	@InsuranceHealthPlanName = NULL,
--	@InsuranceCarrierName = NULL
 CREATE Procedure [dbo].[proc_ProductModels]
  @BrandCode varchar(50),
  @EarmoldCode varchar(50),
  @BrandFamilyCode varchar(50),
  @FamilyProductCode varchar(50),
  @ProductTypeCode varchar(50),
  @TechnologyLevelCode varchar(50),
  @ShellCode varchar(50),
  @ReturnTable varchar(50)   
   as
   begin
     
      declare @query varchar(max)
	  declare @Schema varchar(50)
	  set @Schema='[Catalog]'

	  	declare @ProductTypeResult varchar(max)
		declare @EarmoldTypeResult varchar(max)
		declare @TechnologyLevelResult varchar(max)
		declare @FamilyProductResult varchar(max)
		declare @ShellResult varchar(max)		
		declare @result varchar(max)

	  -- Brands (Start)
	--  begin
	--select 'brand' as Brand,'CatalogType' as CatalogType,'Connectivity' as Connectivity,'EarmoldTypes' as EarmoldTypes,'Families' as Families,'ProductLines' as ProductLines,'ProductTypes' as ProductTypes,'Shells' as Shells 
	  --select * from Brands
	-- end
	 -- Brands (End)


	 -- EarmoldTypes (Start)
	 if(@ReturnTable ='EarmoldType')
	BEGIN
	
	   set @query = ''
	   set @query  = 'select EarmoldTypeCode from '+@Schema+'.EarMoldTypeRules where '

      if (@BrandCode is not null)
	    set @query  = @query + ' BrandCode = '''+@BrandCode +''''
      else
	    set @query  = @query + '1 = 1'

		if (@EarmoldCode is not null)
		begin
			SELECT @result = COALESCE(@result + ',', '') +  CAST('''' + EarmoldTypeCode + ''''  AS VARCHAR(200)) + ''  FROM [Catalog].BrandFamilyRules  WHERE EarmoldTypeCode in (select * from  [Catalog].splitstring(@EarmoldCode)) group by EarmoldTypeCode
		end

		 if (@result is not null)
			set @query = 'Select * from '+@Schema+'.EarMoldTypes where EarmoldTypeCode in (' + @query + ') and EarmoldTypeCode in (' + @result + ')' 
		  else
		    set @query = 'Select * from '+@Schema+'.EarMoldTypes where EarmoldTypeCode in (' + @query + ')'

		--set @query = 'Select * from '+@Schema+'.EarMoldTypes where EarmoldTypeCode in (' + @query + ')'

		 --print @query
		exec (@query)
	END
	 -- EarmoldTypes (End)

	 else if(@ReturnTable ='BrandFamily')
	 -- BrandFamilies (Start)
	  BEGIN

	  set @query = ''
	   set @query  = 'select BrandFamilyCode from '+@Schema+'.BrandFamilyRules where '

      if (@BrandCode is not null)
	    set @query  = @query + ' BrandCode = '''+@BrandCode+''''
      else
	    set @query  = @query + '1 = 1'

		set @query = @query + ' And '

	   if (@EarmoldCode is not null)
	    set @query  = @query + ' EarmoldTypeCode in (select * from [Catalog].splitstring('''+@EarmoldCode+'''))' 
      else
	    set @query  = @query + '1 = 1'

		if (@ProductTypeCode is not null)
		begin
			SELECT @ProductTypeResult = COALESCE(@ProductTypeResult + ',', '') +  CAST('''' + BrandFamilyCode + ''''  AS VARCHAR(200)) + ''  FROM [Catalog].ProductTypeRules  WHERE ProductTypeCode in (select * from  [Catalog].splitstring(@ProductTypeCode)) group by BrandFamilyCode
			set @result = @ProductTypeResult;
		end
	  
		if (@TechnologyLevelCode is not null)
		begin				
			SELECT @TechnologyLevelResult = COALESCE(@TechnologyLevelResult + ',', '') +  CAST('''' + BrandFamilyCode + ''''  AS VARCHAR(200)) + ''  from [Catalog].TechnologyLevelRules where TechnologyLevelCode in (select * from  [Catalog].splitstring(@TechnologyLevelCode)) group by BrandFamilyCode
			if(@result is not null)
				set @result = @result + @TechnologyLevelResult;
			else
				set @result = @TechnologyLevelResult;
		end

		if (@FamilyProductCode is not null)
		begin				
			SELECT @FamilyProductResult = COALESCE(@FamilyProductResult + ',', '') +  CAST('''' + BrandFamilyCode + ''''  AS VARCHAR(200)) + ''  from [Catalog].FamilyProductRules where FamilyProductCode in (select * from  [Catalog].splitstring(@FamilyProductCode)) group by BrandFamilyCode
			if(@result is not null)
				set @result = @result + @FamilyProductResult;
			else
				set @result = @FamilyProductResult;
		end

		if (@ShellCode is not null)
		begin				
			SELECT @ShellResult = COALESCE(@ShellResult + ',', '') +  CAST('''' + BrandFamilyCode + ''''  AS VARCHAR(200)) + ''  from [Catalog].ShellRules where ShellCode in (select * from  [Catalog].splitstring(@ShellCode)) group by BrandFamilyCode
			if(@result is not null)
				set @result = @result + @ShellResult;
			else
				set @result = @ShellResult;
		end

		 if (@result is not null)
			set @query = 'Select * from '+@Schema+'.BrandFamilies where BrandFamilyCode in (' + @query + ') and BrandFamilyCode in (' + @result + ')' 
		  else
		    set @query = 'Select * from '+@Schema+'.BrandFamilies where BrandFamilyCode in (' + @query + ')' 


		--set @query = 'Select * from '+@Schema+'.BrandFamilies where BrandFamilyCode in (' + @query + ')' 
		

	    print @query
		exec (@query) 

	 END
	 -- BrandFamilies (End)
	 else if(@ReturnTable ='Shell')
	  -- Shells (Start)
	BEGIN

	   set @query = ''
	   set @query  = 'select ShellCode from '+@Schema+'.ShellRules where '

      if (@BrandFamilyCode is not null)
	    set @query  = @query + ' BrandFamilyCode in  (select * from [Catalog].splitstring('''+@BrandFamilyCode +'''))'
	  else if (@BrandCode is not null)
	   set @query  = @query + ' BrandFamilyCode in (select BrandFamilyCode from Catalog.BrandFamilyRules where BrandCode in ('''+@BrandCode+'''))'
	  else
	    set @query  = @query + '1 = 1'
	   
		 set @query  = @query + ' AND '

	  if (@FamilyProductCode is not null)
	    set @query  = @query + ' FamilyProductCode in (select * from [Catalog].splitstring('''+@FamilyProductCode +'''))' 
      else
	    set @query  = @query + '1 = 1'

		set @query = 'Select * from '+@Schema+'.Shells where ShellCode in (' + @query + ')'

		--print @query
		exec (@query)
	END
	 -- Shells (End)
	 else if(@ReturnTable ='FamilyProduct')
	 -- Family Products (Start)
	 BEGIN

	  set @query = ''
	   set @query  = 'select FamilyProductCode from '+@Schema+'.FamilyProductRules where '

      if (@BrandFamilyCode is not null)
	    set @query  = @query + ' BrandFamilyCode in (select * from [Catalog].splitstring('''+@BrandFamilyCode+'''))'
      else if (@BrandCode is not null)
	   set @query  = @query + ' BrandFamilyCode in (select BrandFamilyCode from Catalog.BrandFamilyRules where BrandCode in ('''+@BrandCode+'''))'
	  else
	    set @query  = @query + '1 = 1'

		set @query = @query + ' And '

		 if (@TechnologyLevelCode is not null)
	    set @query  = @query + ' TechnologyLevelCode  in (select * from [Catalog].splitstring('''+ @TechnologyLevelCode+'''))'  
      else
	    set @query  = @query + '1 = 1'

		if (@ShellCode is not null)
		begin
			SELECT @ShellResult = COALESCE(@ShellResult + ',', '') +  CAST('''' + FamilyProductCode + ''''  AS VARCHAR(200)) + ''  FROM [Catalog].ShellRules  WHERE ShellCode in (select * from  [Catalog].splitstring(@ShellCode)) group by FamilyProductCode
			set @result = @ShellResult;
		end
	  
		if (@ProductTypeCode is not null)
		begin				
			SELECT @ProductTypeResult = COALESCE(@ProductTypeResult + ',', '') +  CAST('''' + FamilyProductCode + ''''  AS VARCHAR(200)) + ''  from [Catalog].ProductTypeRules where ProductTypeCode in (select * from  [Catalog].splitstring(@ProductTypeCode)) group by FamilyProductCode
			if(@result is not null)
				set @result = @result + @ProductTypeResult;
			else
				set @result = @ProductTypeResult;
		end
		
		 if (@result is not null)
			set @query = 'Select * from '+@Schema+'.FamilyProducts where FamilyProductCode in (' + @query + ') and FamilyProductCode in (' + @result + ')' 
		  else
		    set @query = 'Select * from '+@Schema+'.FamilyProducts where FamilyProductCode in (' + @query + ')'


		--set @query = 'Select * from '+@Schema+'.FamilyProducts where FamilyProductCode in (' + @query + ')'

		print @query
		exec (@query)

	 END
	 -- Family Products (End)

	 else if(@ReturnTable ='ProductType')
	 -- Product Type (Start)
	 BEGIN

	  set @query = ''
	   set @query  = 'select ProductTypeCode from '+@Schema+'.ProductTypeRules where '

      if (@BrandFamilyCode is not null)
	    set @query  = @query + ' BrandFamilyCode  in (select * from [Catalog].splitstring('''+@BrandFamilyCode+'''))'  
      else if (@BrandCode is not null)
	   set @query  = @query + ' BrandFamilyCode in (select BrandFamilyCode from Catalog.BrandFamilyRules where BrandCode in ('''+@BrandCode+'''))'
	  else
	    set @query  = @query + '1 = 1'

		set @query = @query + ' And '

		 if (@FamilyProductCode is not null)
	    set @query  = @query + ' FamilyProductCode  in (select * from [Catalog].splitstring('''+@FamilyProductCode+'''))' 
      else
	    set @query  = @query + '1 = 1'

		--set @query = 'Select * from '+@Schema+'.ProductTypes where ProductTypeCode in (' + @query + ')'

		if (@TechnologyLevelCode is not null)
		begin
			SELECT @result = COALESCE(@result + ',', '') +  CAST('''' + ProductTypeCode + ''''  AS VARCHAR(200)) + ''  FROM [Catalog].TechnologyLevelRules  WHERE TechnologyLevelCode in (select * from  [Catalog].splitstring(@TechnologyLevelCode)) group by ProductTypeCode
		end

		 if (@result is not null)
			set @query = 'Select * from '+@Schema+'.ProductTypes where ProductTypeCode in (' + @query + ') and ProductTypeCode in (' + @result + ')' 
		  else
		    set @query = 'Select * from '+@Schema+'.ProductTypes where ProductTypeCode in (' + @query + ')'

		--print @query
	 exec (@query)

	 END
	 -- Product Type (End)
	 else if(@ReturnTable ='TechnologyLevel')
	 -- Technology Levels (Start)
	 BEGIN

	   set @query = ''
	   set @query  = 'select TechnologyLevelCode from '+@Schema+'.TechnologyLevelRules where '

      if (@BrandFamilyCode is not null)
	    set @query  = @query + ' BrandFamilyCode  in (select * from [Catalog].splitstring('''+@BrandFamilyCode+'''))'  
      else if (@BrandCode is not null)
	   set @query  = @query + ' BrandFamilyCode in (select BrandFamilyCode from Catalog.BrandFamilyRules where BrandCode in ('''+@BrandCode+'''))'
	  else
	    set @query  = @query + '1 = 1'

		set @query = @query + ' And '

		 if (@ProductTypeCode is not null)
	    set @query  = @query + ' ProductTypeCode in (select * from [Catalog].splitstring('''+@ProductTypeCode+'''))'   
      else
	    set @query  = @query + '1 = 1'

		--set @query = 'Select * from '+@Schema+'.TechnologyLevel where TechnologyLevelCode in (' + @query + ')'

		if (@FamilyProductCode is not null)
		begin
			SELECT @result = COALESCE(@result + ',', '') +  CAST('''' + TechnologyLevelCode + ''''  AS VARCHAR(200)) + ''  FROM [Catalog].FamilyProductRules  WHERE FamilyProductCode in (select * from  [Catalog].splitstring(@FamilyProductCode)) group by TechnologyLevelCode
		end
	  
		 if (@result is not null)
			set @query = 'Select * from '+@Schema+'.TechnologyLevel where TechnologyLevelCode in (' + @query + ') and TechnologyLevelCode in (' + @result + ')' 
		  else
		    set @query = 'Select * from '+@Schema+'.TechnologyLevel where TechnologyLevelCode in (' + @query + ')'

		--print @query
		exec (@query)

	 END
	 -- Technology Levels (End)
	  else if(@ReturnTable ='ProductModel')
	 -- Product Models (Start)
	  BEGIN
	  
	   set @query = ''
	   --set @query  = 'select ProductModelCode from '+@Schema+'.ProductModelRules where '
	   set @query  = ' where '
      if (@BrandCode is not null)
	    set @query  =  @query + ' BrandCode = '''+@BrandCode+''''
	  else
	    set @query  = @query + '1 = 1'

		set @query = @query + ' And '

		if (@EarmoldCode is not null)
	    set @query  = @query + ' EarmoldTypeCode in (select * from [Catalog].splitstring('''+@EarmoldCode+'''))'    
      else
	    set @query  = @query + '1 = 1'
		
		set @query = @query + ' And '

		if (@BrandFamilyCode is not null)
	    set @query  = @query + ' BrandFamilyCode in (select * from [Catalog].splitstring('''+@BrandFamilyCode+'''))' 
      else
	    set @query  = @query + '1 = 1'

		set @query = @query + ' And '

		if (@ProductTypeCode is not null)
	    set @query  = @query + ' ProductTypeCode in (select * from [Catalog].splitstring('''+@ProductTypeCode+'''))' 
      else
	    set @query  = @query + '1 = 1'

		set @query = @query + ' And '

		if (@TechnologyLevelCode is not null)
	    set @query  = @query + ' TechnologyLevelCode  in (select * from [Catalog].splitstring('''+@TechnologyLevelCode+'''))'
      else
	    set @query  = @query + '1 = 1'

		set @query = @query + ' And '

		if (@FamilyProductCode is not null)
	    set @query  = @query + ' FamilyProductCode  in (select * from [Catalog].splitstring('''+@FamilyProductCode+'''))'
      else
	    set @query  = @query + '1 = 1'

		set @query = @query + ' And '

		if (@ShellCode is not null)
	    set @query  = @query + ' ShellCode  in (select * from [Catalog].splitstring('''+@ShellCode+'''))'
      else
	    set @query  = @query + '1 = 1'
		
       -- set @query = 'select * from '+@Schema+'.ProductModels where ProductModelCode in (' + @query + ')' 
	   --set @query = 'select distinct prod.*,prodr.* from '+@Schema+'.ProductModels prod join '+@Schema+'.ProductModelRules prodr on prod.ProductModelCode = prodr.ProductModelCode where prod.ProductModelCode in (' + @query + ')'
     	 --set @query = 'select distinct prod.ProductModelCode,prod.ProductModelID,prod.ProductModelName,prod.Description,prod.CreateDate,prod.ModifyDate,prod.CreateUser,prod.Modifyuser,prod.ImageURL,
		     --          prodr.BrandCode,prodr.BrandFamilyCode,prodr.EarmoldTypeCode,prodr.FamilyProductCode,prodr.ProductTypeCode,prodr.ShellCode,prodr.TechnologyLevelCode,prod.IsActive
					  --  from '+@Schema+'.ProductModels prod join '+@Schema+'.ProductModelRules prodr 
					  -- on prod.ProductModelCode = prodr.ProductModelCode where prod.ProductModelCode in (' + @query + ')'
	   set @query = 'select prod.ProductModelID,prod.ProductModelCode,prod.ProductModelName,prod.Description,prod.CreateDate,prod.ModifyDate,prod.CreateUser,prod.Modifyuser,prod.ImageURL,
		               prodr.BrandCode,prodr.BrandFamilyCode,prodr.EarmoldTypeCode,prodr.FamilyProductCode,prodr.ProductTypeCode,prodr.ShellCode,prodr.TechnologyLevelCode,prod.IsActive,prod.StyleID,
					   CAST(''2700'' AS DECIMAL)  as ProductPrice,CAST(''2200'' AS DECIMAL) as NationsHearingPrice,CAST(''300'' AS DECIMAL) as Benefit
					    from '+@Schema+'.ProductModels prod join '+@Schema+'.ProductModelRules prodr 
					   on prod.ProductModelCode = prodr.ProductModelCode ' + @query + ''  
		 
		 print @query
		 exec (@query)

		End  
		-- Product Models (End)
		 
   end

   --exec [Catalog].[proc_ProductModels] 'GNR',null,null,'RS VERSO 9','MINI BTE',null,null,'ProductModel'
   --select * from [Catalog].BrandFamilies
   

-- =============================================
-- Author:		RAMU KUNJA
-- Create date: 11-dEC-2017
-- Description:	PROCEDURE for Member Search Results
-- =============================================
CREATE Procedure [dbo].[sp_SearchMember](
	-- Add the parameters for the stored procedure here
	@MemberID           BIGINT = NULL, 
    @NHMemberID         NVARCHAR(50) = NULL, 
	@FirstName          NVARCHAR(250) = NULL,
    @LastName           NVARCHAR(50) = NULL,
	@DateOfBirth        DATETIME = NULL,
	@Gender             NVARCHAR(10) = NULL,
	@MaritalStatus      NVARCHAR(25) = NULL,
	@Address1           NVARCHAR(500) = NULL,
	@Address2           NVARCHAR(500) = NULL,
	@City               NVARCHAR(50) = NULL,
	@State              NVARCHAR(10) = NULL,
	@Country            NVARCHAR(50) = NULL,
	@ZipCode            NVARCHAR(10) = NULL, 
    @EmailAddress       NVARCHAR(50) = NULL, 
    @Phone               NVARCHAR(50) = NULL,
	@InsuranceHealthPlanNumber NVARCHAR(250) = NULL,
	@InsuranceHealthPlanName NVARCHAR(250) = NULL,
	@InsuranceCarrierName NVARCHAR(250) = NULL)
AS
BEGIN
	-- SET NOCOUNT ON added to prevent extra result sets from
	-- interfering with SELECT statements.
	SET NOCOUNT ON;
	DECLARE @SQLQuery AS NVARCHAR(4000)

   SET @SQLQuery = 'SELECT DISTINCT M.MemberID,M.NHMemberID,M.FirstName,M.LastName,M.DateOfBirth,M.Gender,M.MiddleInitial,M.IsActive,
	       A.Address1,A.Address2,A.City,A.State,A.Country,A.ZipCode,A.AddressTypeCode,
	       P.PhoneNbr,P.CountryCode,P.IsPreferredPhoneNumber,P.PhoneExtension,
		   EM.EmailAddress,
		   MA.AttributeTypeCode,MA.AttributeValue,
		   MI.InsuranceCarrierID,MI.InsuranceEffectiveDate,MI.InsuranceHealthPlanID,MI.InsuranceType,
		   MD.InsuranceNbr,
		   IC.InsuranceCarrierName,IC.MemberDataFileProvided,
		   IH.HealthPlanName,IH.HealthPlanNumber
	FROM [Master].Members M
	LEFT JOIN [Master].Addresses A on M.MemberID=A.MemberID
	LEFT JOIN [Master].PhoneNumbers P on M.MemberID=P.MemberID
	LEFT JOIN [Master].Emails EM on M.MemberID = EM.MemberID
	LEFT JOIN [Master].MemberAttributes MA on M.MemberID=MA.MemberID
	LEFT JOIN [Master].MemberInsurances MI on M.MemberID=MI.MemberID
	LEFT JOIN [Master].MemberInsuranceDetails MD on MI.ID=MD.MemberInsuranceID
	LEFT JOIN Insurance.InsuranceCarriers IC on MI.InsuranceCarrierID=IC.InsuranceCarrierID
	LEFT JOIN Insurance.InsuranceHealthPlans IH on MI.InsuranceHealthPlanID=IH.InsuranceHealthPlanID
	 '
	--If any Single Value ---
	if(@FirstName IS NOT NULL)
	SET @SQLQuery = @SQLQuery + 'WHERE M.FirstName LIKE ''%' + @FirstName+'%'''
	if (@FirstName IS NOT NULL AND @LastName IS NOT NULL)
	SET @SQLQuery = @SQLQuery + ' AND M.LastName LIKE ''%' + @LastName+'%'''
	else if (@LastName IS NOT NULL)
	SET @SQLQuery = @SQLQuery + ' WHERE M.LastName LIKE ''%' + @LastName+'%'''

	if (@FirstName IS NOT NULL AND @LastName IS NOT NULL AND @DateOfBirth IS NOT NULL)
	SET @SQLQuery = @SQLQuery + ' AND M.DateOfBirth =''' + @DateOfBirth +''
	else IF (@DateOfBirth IS NOT NULL)
	SET @SQLQuery = @SQLQuery + ' WHERE M.DateOfBirth =''' + @DateOfBirth +''


	if (@FirstName IS NOT NULL AND @LastName IS NOT NULL AND @DateOfBirth IS NOT NULL AND @Gender IS NOT NULL)
	SET @SQLQuery = @SQLQuery + ' AND M.Gender =''' + @Gender +''
	else if (@Gender IS NOT NULL)
	SET @SQLQuery = @SQLQuery + ' WHERE M.Gender =''' + @Gender + ''''
	
	if (@FirstName IS NOT NULL AND @LastName IS NOT NULL AND @DateOfBirth IS NOT NULL AND @Gender IS NOT NULL AND @MaritalStatus IS NOT NULL)
	SET @SQLQuery = @SQLQuery + ' AND M.MaritalStatus =''' + @MaritalStatus +''''
	else if (@MaritalStatus IS NOT NULL)
	SET @SQLQuery = @SQLQuery + ' WHERE M.MaritalStatus =''' + @MaritalStatus +''''
	
	if (@FirstName IS NOT NULL AND @LastName IS NOT NULL AND @DateOfBirth IS NOT NULL AND @Gender IS NOT NULL AND @MaritalStatus IS NOT NULL AND @Address1 IS NOT NULL)
	SET @SQLQuery = @SQLQuery + ' AND A.Address1 LIKE ''%'+@Address1+'%'''
	else if (@Address1 IS NOT NULL)
	SET @SQLQuery = @SQLQuery + ' WHERE A.Address1 LIKE ''%'+@Address1+'%'''
	
	if (@FirstName IS NOT NULL AND @LastName IS NOT NULL AND @DateOfBirth IS NOT NULL AND @Gender IS NOT NULL AND @MaritalStatus IS NOT NULL AND @Address1 IS NOT NULL AND @Address2 IS NOT NULL)
	SET @SQLQuery = @SQLQuery + ' AND A.Address2 LIKE ''%'+@Address2+'%'''
	else if (@Address2 IS NOT NULL)
	SET @SQLQuery = @SQLQuery + ' WHERE A.Address2 LIKE ''%'+@Address2+'%'''
	
	if (@FirstName IS NOT NULL AND @LastName IS NOT NULL AND @DateOfBirth IS NOT NULL AND @Gender IS NOT NULL AND @MaritalStatus IS NOT NULL AND @Address1 IS NOT NULL AND @Address2 IS NOT NULL AND @City IS NOT NULL)
	SET @SQLQuery = @SQLQuery + ' AND A.City =''' +@City + ''''
	else if (@City IS NOT NULL)
	SET @SQLQuery = @SQLQuery + ' WHERE A.City =''' +@City + ''''
	
	if (@FirstName IS NOT NULL AND @LastName IS NOT NULL AND @DateOfBirth IS NOT NULL AND @Gender IS NOT NULL AND @MaritalStatus IS NOT NULL AND @Address1 IS NOT NULL AND @Address2 IS NOT NULL AND @City IS NOT NULL AND @State IS NOT NULL)
	SET @SQLQuery = @SQLQuery + ' AND A.[State] LIKE ''%'+@State+'%'''
	else if (@State IS NOT NULL)
	SET @SQLQuery = @SQLQuery + ' WHERE A.[State] LIKE ''%'+@State+'%'''
	
	if (@FirstName IS NOT NULL AND @LastName IS NOT NULL AND @DateOfBirth IS NOT NULL AND @Gender IS NOT NULL AND @MaritalStatus IS NOT NULL AND @Address1 IS NOT NULL AND @Address2 IS NOT NULL AND @City IS NOT NULL AND @State IS NOT NULL AND @Country IS NOT NULL)
	SET @SQLQuery = @SQLQuery + ' AND A.Country LIKE ''%'+@Country+'%'''
	else if (@Country IS NOT NULL)
	SET @SQLQuery = @SQLQuery + ' WHERE A.Country LIKE ''%'+@Country+'%'''
	
	if (@FirstName IS NOT NULL AND @LastName IS NOT NULL AND @DateOfBirth IS NOT NULL AND @Gender IS NOT NULL AND @MaritalStatus IS NOT NULL AND @Address1 IS NOT NULL AND @Address2 IS NOT NULL AND @City IS NOT NULL AND @State IS NOT NULL AND @Country IS NOT NULL AND @ZipCode IS NOT NULL)
	SET @SQLQuery = @SQLQuery + ' AND A.ZipCode =''' +@ZipCode + ''''
	else if (@ZipCode IS NOT NULL)	 
	SET @SQLQuery = @SQLQuery + ' WHERE A.ZipCode =''' +@ZipCode + ''''
	
	if (@FirstName IS NOT NULL AND @LastName IS NOT NULL AND @DateOfBirth IS NOT NULL AND @Gender IS NOT NULL AND @MaritalStatus IS NOT NULL AND @Address1 IS NOT NULL AND @Address2 IS NOT NULL AND @City IS NOT NULL AND @State IS NOT NULL AND @Country IS NOT NULL AND @ZipCode IS NOT NULL AND @EmailAddress IS NOT NULL)
	SET @SQLQuery = @SQLQuery + ' AND EM.EmailAddress =''' + @EmailAddress +''''
	if (@EmailAddress IS NOT NULL)	 
	SET @SQLQuery = @SQLQuery + ' WHERE EM.EmailAddress =''' + @EmailAddress +''''
	
	if (@FirstName IS NOT NULL AND @LastName IS NOT NULL AND @DateOfBirth IS NOT NULL AND @Gender IS NOT NULL AND @MaritalStatus IS NOT NULL AND @Address1 IS NOT NULL AND @Address2 IS NOT NULL AND @City IS NOT NULL AND @State IS NOT NULL AND @Country IS NOT NULL AND @ZipCode IS NOT NULL AND @EmailAddress IS NOT NULL AND @Phone IS NOT NULL)
	SET @SQLQuery = @SQLQuery + ' AND P.PhoneNbr = ''' +@Phone + ''''
	else if (@Phone IS NOT NULL)	 
	SET @SQLQuery = @SQLQuery + ' WHERE P.PhoneNbr = ''' +@Phone + ''''
	
	if (@FirstName IS NOT NULL AND @LastName IS NOT NULL AND @DateOfBirth IS NOT NULL AND @Gender IS NOT NULL AND @MaritalStatus IS NOT NULL AND @Address1 IS NOT NULL AND @Address2 IS NOT NULL AND @City IS NOT NULL AND @State IS NOT NULL AND @Country IS NOT NULL AND @ZipCode IS NOT NULL AND @EmailAddress IS NOT NULL AND @Phone IS NOT NULL AND @InsuranceHealthPlanNumber IS NOT NULL)
	SET @SQLQuery = @SQLQuery + ' AND MD.InsuranceNbr LIKE ''%'+@InsuranceHealthPlanNumber+'%'''
	else if (@InsuranceHealthPlanNumber IS NOT NULL)	 
	SET @SQLQuery = @SQLQuery + ' WHERE MD.InsuranceNbr LIKE ''%'+@InsuranceHealthPlanNumber+'%'''
	--If any Single Value ---

	SET @SQLQuery = @SQLQuery + ' Order by M.FirstName, M.LastName'
	--PRINT @SQLQuery
	EXECUTE sp_executesql @SQLQuery

	 If @@ERROR <> 0 GoTo ErrorHandler
    Set NoCount OFF
    Return(0)
  
ErrorHandler:
    Return(@@ERROR)
END


--EXEC [dbo].[sp_SearchMember] @MemberID = NULL , 
--    @NHMemberID  = NULL, 
--	@FirstName = NULL,
--    @LastName = NULL,
--	@DateOfBirth= NULL,
--	@Gender = NULL,
--	@MaritalStatus = NULL,
--	@Address1 = null,
--	@Address2 = NULL,
--	@City = NULL,
--	@State = NULL,
--	@Country = NULL,
--	@ZipCode = NULL, 
--    @EmailAddress = NULL, 
--    @Phone  = NULL,
--	@InsuranceHealthPlanNumber = 'GA00001561',
--	@InsuranceHealthPlanName = NULL,
--	@InsuranceCarrierName = NULL
CREATE Procedure [dbo].[sp_InsertProgramDetails]

AS
BEGIN
    
    SET NOCOUNT ON
	 
	Begin try  	
		      
			Begin transaction

			  select ic.InsuranceCarrierName,insdtl.InsuranceNbr,hp.HealthPlanName,insdtl.PrimaryInsuredName,ins.InsuranceEffectiveDate,ins.InsuranceEndDate,ins.InsuranceCarrierID,ins.InsuranceHealthPlanID, mp.MemberProfileId
			    into #tmpPrgDtl from [Master].[MemberInsurances] ins 
				left join [Master].[MemberInsuranceDetails] insdtl on ins.ID = insdtl.MemberInsuranceID 
				join [Insurance].[InsuranceCarriers] ic on ins.InsuranceCarrierID = ic.InsuranceCarrierID
				join [Insurance].[InsuranceHealthPlans] hp on ins.InsuranceHealthPlanID = hp.InsuranceHealthPlanID
				join [Master].[Members] m on m.MemberID= ins.MemberID
				join [provider].[MemberProfiles] mp on mp.NHMemberId = m.NHMemberID
				where m.DataSource = 'VanilaSoft' and ic.IsDiscountProgram = 1 and hp.IsDiscountProgram=1
       
			--select * from #tmpPrgDtl	

INSERT INTO [provider].[MemberProgramDetails]
           (
            [DiscountProgramCarrier]
           ,[DiscountProgramMemberID]
           ,[DiscountProgramName]
           ,[DiscountProgramPrimaryMemberName]
           ,[EffectiveFromDate]
           ,[EffectiveToDate]
           ,[InsuranceCarrierID]
           ,[InsuranceHealthPlanID]
           ,[IsActive]
           ,[MemberProfileId]           
           ,[UseForBenefits]
		   ,CreateUser
		   ,CreateDate
		   ,ModifyUser
		   ,ModifyDate)
    select 
		     InsuranceCarrierName,
			 InsuranceNbr,
			 HealthPlanName,
			 PrimaryInsuredName,
			 InsuranceEffectiveDate,
			 InsuranceEndDate,
			 InsuranceCarrierID,
			 InsuranceHealthPlanID,
			 1,
			 MemberProfileId,
			 1,
			 'System',
			 GETDATE(),
			  'System',
			 GETDATE()
          from #tmpPrgDtl

	  Commit transaction           
   end try
   Begin catch
		declare @error int, @message varchar(4000), @xstate int;
        select @error = ERROR_NUMBER(),
                 @message = ERROR_MESSAGE(), @xstate = XACT_STATE();
        if @xstate = -1
            rollback transaction;
        if @xstate = 1 
            rollback transaction       
			return;
   End catch

END
-- =============================================  
-- Author:  KALYANA GOBBURI  
-- Create date: 4-Nov-2017  
-- Description: PROCEDURE to Fetch the ANI Search Results  
-- =============================================  
CREATE PROCEDURE [dbo].[sp_ANISearchMember](  
 -- Add the parameters for the stored procedure here  
 @Phone              BIGINT = NULL)   
AS  
BEGIN  
 -- SET NOCOUNT ON added to prevent extra result sets from  
 -- interfering with SELECT statements.  
 SET NOCOUNT ON;  
  
 --   SELECT DISTINCT M.MemberID,M.NHMemberID,M.FirstName,M.LastName,M.DateOfBirth,M.Gender,M.MiddleInitial,M.IsActive,  
 --       A.Address1,A.Address2,A.City,A.State,A.Country,A.ZipCode,A.AddressTypeCode,  
 --       P.PhoneNbr,P.CountryCode,P.IsPreferredPhoneNumber,P.PhoneExtension,  
 --    EM.EmailAddress,  
 --    MA.AttributeTypeCode,MA.AttributeValue,  
 --    MI.InsuranceCarrierID,MI.InsuranceEffectiveDate,MI.InsuranceHealthPlanID,MI.InsuranceType,  
 --    MD.InsuranceNbr,  
 --    IC.InsuranceCarrierName,IC.MemberDataFileProvided,  
 --    IH.HealthPlanName,IH.HealthPlanNumber  
 --FROM Master.Members M  
 --LEFT JOIN Master.Addresses A on M.MemberID=A.MemberID  
 --LEFT JOIN Master.PhoneNumbers P on M.MemberID=P.MemberID  
 --LEFT JOIN Master.Emails EM on M.MemberID = EM.MemberID  
 --LEFT JOIN Master.MemberAttributes MA on M.MemberID=MA.MemberID  
 --LEFT JOIN Master.MemberInsurances MI on M.MemberID=MI.MemberID  
 --LEFT JOIN Master.MemberInsuranceDetails MD on MI.ID=MD.MemberInsuranceID  
 --LEFT JOIN Insurance.InsuranceCarriers IC on MI.InsuranceCarrierID=IC.InsuranceCarrierID  
 --LEFT JOIN Insurance.InsuranceHealthPlans IH on MI.InsuranceHealthPlanID=IH.InsuranceHealthPlanID  
 --WHERE P.PhoneNbr=@Phone   
 
 /*
 SELECT DISTINCT M.MemberID,M.NHMemberID,M.FirstName,M.LastName,M.DateOfBirth,M.IsActive,
        A.Address1,ISNULL(A.Address2,'') AS Address2,A.City,A.State,A.Country,A.ZipCode, A.AddressTypeCode, A.Country AS 'CountryCode', EM.EmailAddress,  
     IH.HealthPlanNumber,MI.InsuranceType,MI.InsuranceEffectiveDate,  
     MD.InsuranceNbr,  
     IC.InsuranceCarrierName, IH.HealthPlanName,  
     P.IsPreferredPhoneNumber, P.PhoneExtension, P.PhoneNbr ,ISNULL(MAX(OrderID),0) AS OrderNumber
 FROM Master.Members M  
 LEFT JOIN Orders.Orders O ON O.NHMemberId = M.NHMemberID  AND O.IsActive = 1 
 LEFT JOIN Master.Addresses A on M.MemberID=A.MemberID  AND A.IsActive = 1
 LEFT JOIN Master.PhoneNumbers P on M.MemberID=P.MemberID  AND P.IsActive = 1
 LEFT JOIN Master.Emails EM on M.MemberID = EM.MemberID  AND EM.IsActive = 1
 LEFT JOIN Master.MemberAttributes MA on M.MemberID=MA.MemberID AND MA.IsActive = 1 
 LEFT JOIN Master.MemberInsurances MI on M.MemberID=MI.MemberID  AND MI.IsActive = 1
 LEFT JOIN Master.MemberInsuranceDetails MD on MI.ID=MD.MemberInsuranceID  AND MD.IsActive = 1
 LEFT JOIN Insurance.InsuranceCarriers IC on MI.InsuranceCarrierID=IC.InsuranceCarrierID  AND IC.IsActive = 1
 LEFT JOIN Insurance.InsuranceHealthPlans IH on MI.InsuranceHealthPlanID=IH.InsuranceHealthPlanID  AND IH.IsActive = 1
 WHERE P.PhoneNbr=@Phone GROUP BY M.MemberID,M.NHMemberID,M.FirstName,M.LastName,A.Address1,A.Address2,A.City,A.State,A.Country,A.ZipCode,A.AddressTypeCode,  
 MD.InsuranceNbr, IC.InsuranceCarrierName,IH.HealthPlanName,M.DateOfBirth,M.IsActive, EM.EmailAddress,IH.HealthPlanNumber,MI.InsuranceType,MI.InsuranceEffectiveDate,
  P.IsPreferredPhoneNumber,P.PhoneExtension, P.PhoneNbr
  */


  -- This has to be modified, front end need to be co-ordinated
SELECT DISTINCT
  M.MemberID,
  M.NHMemberID,
  M.FirstName,
  M.LastName,
  M.DateOfBirth,
  M.IsActive,
  A.Address1,
  ISNULL(A.Address2, '') AS Address2,
  A.City,
  A.State,
  A.Country,
  A.ZipCode,
  A.AddressTypeCode,
  A.Country AS 'CountryCode',
  EM.EmailAddress,
  IH.HealthPlanNumber,
  MI.InsuranceType,
  MI.InsuranceEffectiveDate,
  MD.InsuranceNbr,
  IC.InsuranceCarrierName,
  IH.HealthPlanName,
  P.IsPreferredPhoneNumber,
  P.PhoneExtension,
  CAST(@Phone AS bigint) PhoneNbr,
  ISNULL(MAX(OrderID), 0) AS OrderNumber
FROM Master.Members M
LEFT JOIN Orders.Orders O ON (O.NHMemberId = M.NHMemberID AND O.IsActive = 1)
LEFT JOIN Master.Addresses A ON (M.MemberID = A.MemberID AND A.IsActive = 1 AND IsPreferredAddress = 1)
LEFT JOIN Master.PhoneNumbers P ON (M.MemberID = P.MemberID AND P.IsActive = 1 AND 1 = 2)
LEFT JOIN Master.Emails EM ON (M.MemberID = EM.MemberID AND EM.IsActive = 1 AND 1 = 2)
LEFT JOIN Master.MemberAttributes MA ON (M.MemberID = MA.MemberID AND MA.IsActive = 1)
LEFT JOIN Master.MemberInsurances MI ON (M.MemberID = MI.MemberID AND MI.IsActive = 1)
LEFT JOIN Master.MemberInsuranceDetails MD ON (MI.ID = MD.MemberInsuranceID AND MD.IsActive = 1)
LEFT JOIN Insurance.InsuranceCarriers IC ON (MI.InsuranceCarrierID = IC.InsuranceCarrierID AND IC.IsActive = 1)
LEFT JOIN Insurance.InsuranceHealthPlans IH ON (MI.InsuranceHealthPlanID = IH.InsuranceHealthPlanID AND IH.IsActive = 1 )
WHERE 1 = 1
AND m.memberid IN (SELECT DISTINCT MemberID FROM Master.PhoneNumbers WHERE phoneNbr = @Phone)
GROUP BY M.MemberID,
         M.NHMemberID,
         M.FirstName,
         M.LastName,
         A.Address1,
         A.Address2,
         A.City,
         A.State,
         A.Country,
         A.ZipCode,
         A.AddressTypeCode,
         MD.InsuranceNbr,
         IC.InsuranceCarrierName,
         IH.HealthPlanName,
         M.DateOfBirth,
         M.IsActive,
         EM.EmailAddress,
         IH.HealthPlanNumber,
         MI.InsuranceType,
         MI.InsuranceEffectiveDate,
         P.IsPreferredPhoneNumber,
         P.PhoneExtension,
         P.PhoneNbr
END  
CREATE Procedure [dbo].[proc_GetFeatures]
    @brand nvarchar(max) = null,
    @family nvarchar(max) = null,
    @familyProduct nvarchar(max) = null,
    @productType nvarchar(max) = null,
    @connectivity nvarchar(max) = null,
    @shell nvarchar(max) = null,
    @productModel nvarchar(max) = null,
    @earmold nvarchar(max) = null,
    @powerLevel nvarchar(max) = null,
    @pushButton nvarchar(max) = null,
    @teleCoil nvarchar(max) = null,
    @sendReceiver nvarchar(max) = null,
    @material nvarchar(max) = null,
    @coupling nvarchar(max)= null 
	as

	select * from featurevalues where featurevalueid in 
  (select FeatureValueID from Rules_FeatureValues where
  (Brand =  @brand or Brand is null) and
  (Family =  @family or Family is null) and
  (FamilyProduct =  @familyProduct or FamilyProduct is null) and
  (ProductType =  @productType or ProductType is null) and
  (Connectivity =  @connectivity or Connectivity is null) and
  (Shell =  @shell or Shell is null) and
  (ProductModel =  @productModel or ProductModel is null) and
  (Earmold =  @earmold or Earmold is null) and
  (PowerLevel =  @powerLevel or PowerLevel is null) and
  (PushButton =  @pushButton or PushButton is null) and
  (TeleCoil =  @teleCoil or TeleCoil is null) and
  (SendReceiver =  @sendReceiver or SendReceiver is null) and
  (Material =  @material or Material is null) and
  (Coupling =  @coupling or Coupling is null)) or IsDefault = 'Y'


  /*

  select * from Rules_FeatureValues where
  (Brand =  @brand or Brand is null) and
  (Family =  @family or Family is null) and
  (FamilyProduct =  @familyProduct or FamilyProduct is null) and
  (ProductType =  @productType or ProductType is null) and
  (Connectivity =  @connectivity or Connectivity is null) and
  (Shell =  @shell or Shell is null) and
  (ProductModel =  @productModel or ProductModel is null) and
  (Earmold =  @earmold or Earmold is null) and
  (PowerLevel =  @powerLevel or PowerLevel is null) and
  (PushButton =  @pushButton or PushButton is null) and
  (TeleCoil =  @teleCoil or TeleCoil is null) and
  (SendReceiver =  @sendReceiver or SendReceiver is null) and
  (Material =  @material or Material is null) and
  (Coupling =  @coupling or Coupling is null)

  */
--------------------------------
CREATE PROCEDURE [dbo].[sp_SearchMemberCall](      
       @MemberID           BIGINT = NULL,       
       @NHMemberID         NVARCHAR(50) = NULL,       
       @FirstName          NVARCHAR(250) = NULL,      
       @LastName           NVARCHAR(50) = NULL,      
       @DateOfBirth        DATETIME = NULL,      
       @Gender             NVARCHAR(10) = NULL,      
       @MaritalStatus      NVARCHAR(25) = NULL,      
       @Address1           NVARCHAR(500) = NULL,      
       @Address2           NVARCHAR(500) = NULL,      
       @City               NVARCHAR(50) = NULL,      
       @State              NVARCHAR(10) = NULL,      
       @Country            NVARCHAR(50) = NULL,      
       @ZipCode            NVARCHAR(10) = NULL,       
       @EmailAddress       NVARCHAR(50) = NULL,       
       @Phone               NVARCHAR(50) = NULL,      
       @InsuranceHealthPlanNumber NVARCHAR(250) = NULL,      
       @InsuranceHealthPlanName NVARCHAR(250) = NULL,      
       @InsuranceCarrierName NVARCHAR(250) = NULL,     
	   @SearchFilterCarrierId  NVARCHAR(250) = NULL,
       @OrderID BIGINT = 0)      
AS      
BEGIN      
       SET NOCOUNT ON;      
      SET ANSI_WARNINGS OFF;    
       DECLARE @SQLQueryRes AS NVARCHAR(4000)      
       DECLARE @SQLQuery AS NVARCHAR(4000)      
       DECLARE @SQLQueryM AS NVARCHAR(2000)      
       DECLARE @SQLQueryA AS NVARCHAR(2000)      
       DECLARE @SQLQueryP AS NVARCHAR(2000)      
       DECLARE @SQLQueryI AS NVARCHAR(2000)      
       DECLARE @tables AS VARCHAR(50)      
       DECLARE @Where AS VARCHAR(500)      
       DECLARE @DateOfBirth1  AS VARCHAR(20) = NULL      
      
       set @LastName = REPLACE(@LastName,'''','''''')      
      
       set @FirstName = REPLACE(@FirstName,'''','''''')      
      
       SET @DateOfBirth1 = cast(@DateOfBirth as datetime)      
      
      
       SET @SQLQuery = 'SELECT DISTINCT TOP 100 M.MemberID, m.NHMEMBERID from '      
      
       SET @SQLQueryM = 'Master.Members m where  1 = 1 '      
      
       SET @SQLQueryP = 'Master.Members m , Master.PhoneNumbers p where 1 = 1 and m.memberid = p.memberid '      
      
       SET @SQLQueryA = 'Master.Members m , Master.Addresses a where 1 = 1 and m.memberid = a.memberid '      
      
       SET @SQLQueryI = 'master.members m where exists (select 1 from (      
       select mi.memberid from master.MemberInsurances mi      
       where exists (select 1 from Master.MemberInsuranceDetails mid where       
                                                       mid.memberinsuranceid = mi.id and mid.InsuranceNbr  = '      
      
       if (@FirstName is not null )      
              Begin      
              set @tables = 'MEMBER'      
              set @Where = ' and m.firstname like '''+@FirstName+'%'''      
                     if @ZipCode is not null       
                           Begin      
                                  set @tables = 'MEMBERADDRESS'      
                                  set @Where = @Where + ' and a.ZipCode like '''+@ZipCode+'%'''      
                         End      
                     else      
                           Begin      
                                  if @LastName is not null      
                                         set @Where = @Where + ' and m.lastname like '''+@LastName+'%'''      
                                  if @DateOfBirth1 is not null      
                                         set @Where = @Where + ' and m.DateOfBirth = cast('''+@DateOfBirth1+''''+' as datetime)'      
                           End      
           End      
       else      
      
if (@LastName is not null )      
              Begin      
              set @tables = 'MEMBER'      
              set @Where = ' and m.lastname like '''+@LastName+'%'''      
                     if @ZipCode is not null       
                           Begin      
                                  set @tables = 'MEMBERADDRESS'      
                                  set @Where = @Where + ' and a.ZipCode like '''+@ZipCode+'%'''      
                         End      
                     else      
                           Begin      
                                  if @FirstName is not null      
                                         set @Where = @Where + ' and m.firstname like '''+@FirstName+'%'''      
                                  if @DateOfBirth1 is not null      
               set @Where = @Where + ' and m.DateOfBirth = cast('''+@DateOfBirth1+''''+' as datetime)'      
                           End      
           End      
       else if (@DateOfBirth1 is not null)      
              Begin      
                     set @tables = 'MEMBER'      
                     set @Where = ' and m.DateOfBirth = cast('''+@DateOfBirth1+''''+' as datetime)'      
              End      
       else if (@Phone is not null)      
              Begin      
                     set @tables = 'PHONE'      
                     set @Where = ' and p.PhoneNbr = '+@Phone      
              End      
       else if (@Address1 is not null)      
              Begin      
                     set @tables = 'ADDRESS'      
                     set @Where = ' and a.Address1 like '''+@Address1+'%'''      
                     if @ZipCode is not null      
                           set @Where = @Where + ' and a.ZipCode like '''+@ZipCode+'%'''     
         set @ZipCode = NULL   
              End    
      else if (@Address2 is not null)      
              Begin      
                     set @tables = 'ADDRESS'      
                     set @Where = ' and a.Address2 like '''+@Address2+'%'''      
                     if @ZipCode is not null      
                           set @Where = @Where + ' and a.ZipCode like '''+@ZipCode+'%'''   
         set @ZipCode = NULL     
              End   
      else if (@City is not null)      
              Begin      
                     set @tables = 'ADDRESS'      
                     set @Where = ' and a.City like '''+@City+'%'''      
                     if @ZipCode is not null      
                           set @Where = @Where + ' and a.ZipCode like '''+@ZipCode+'%'''      
         set @ZipCode = NULL  
              End    
      else if (@State is not null)      
              Begin      
                     set @tables = 'ADDRESS'      
                     set @Where = ' and a.State like '''+@State+'%'''      
                     if @ZipCode is not null      
                           set @Where = @Where + ' and a.ZipCode like '''+@ZipCode+'%'''    
         set @ZipCode = NULL    
              End              
    
        
            
      
       IF @tables = 'MEMBER'      
              set @SQLQUERY = @SQLQUERY + @SQLQUERYM + @Where      
       else if @tables = 'ADDRESS'      
              set @SQLQUERY = @SQLQUERY + @SQLQUERYA + @Where      
       else if @tables = 'PHONE'      
              set @SQLQUERY = @SQLQUERY + @SQLQUERYP + @Where      
       else if @tables = 'MEMBERADDRESS'      
              set @SQLQUERY = @SQLQUERY + @SQLQUERYA + @Where      
       else if @tables = 'INSURANCE'      
              set @SQLQUERY = @SQLQUERY + @SQLQUERYI + @Where + ')) a where a.memberid = m.memberid)'      
       else      
              set @SQLQUERY = @SQLQUERY + '  master.members m'      
      
     --- Added BY MOIN (Code to Search By NHMemberID)    
  IF @NHMemberID IS NOT NULL    
  BEGIN    
   IF @Where IS NOT NULL    
   BEGIN    
   SET @SQLQUERY = @SQLQUERY + ' ' + 'AND m.NHMemberID = '''+@NHMemberID+''''    
   END    
   ELSE    
   BEGIN    
    SET @SQLQUERY = @SQLQUERY + ' ' + 'where m.NHMemberID = '''+@NHMemberID+''''    
   END    
  END    
  --- END Added by MOIN    
 IF @InsuranceHealthPlanNumber IS NOT NULL
 BEGIN
  print @SQLQUERY
  print @SQLQueryRes
  SET @SQLQUERY = @SQLQUERY + ' '  + 'where md.InsuranceNbr like ''%'+@InsuranceHealthPlanNumber+'%''' 
  SET @SQLQUERY = (SELECT REPLACE(@SQLQuery,'TOP 100',''))      
 END

 IF @ZipCode IS NOT NULL  
   BEGIN  
    SET @SQLQUERY = (SELECT REPLACE(@SQLQuery,'TOP 100','')) 
    SET @SQLQUERY = @SQLQUERY + ' ' + 'where a.ZipCode LIKE '''+@ZipCode+'%'''   
   END
  
  ---Newly Added - Ramu 
    IF @SearchFilterCarrierId IS NOT NULL AND CAST(@SearchFilterCarrierId AS BIGINT) > 0
   BEGIN 
	IF @NHMemberID IS NULL AND @FirstName IS NULL AND @LastName IS NULL AND @DateOfBirth1 IS NULL AND @Address1 IS NULL AND @Address2 IS NULL AND @City IS NULL AND @State IS NULL AND @ZipCode IS NULL AND @Phone IS NULL AND @InsuranceHealthPlanNumber IS NULL AND @OrderID = 0
		BEGIN
		SET @SQLQUERY = (SELECT REPLACE(@SQLQuery,'TOP 100','')) 
		SET @SQLQUERY = @SQLQUERY + ' ' + 'WHERE mi.InsuranceCarrierID = '+@SearchFilterCarrierId
		END
	ELSE
	BEGIN
		SET @SQLQUERY = (SELECT REPLACE(@SQLQuery,'TOP 100','')) 
		SET @SQLQUERY = @SQLQUERY + ' ' + 'AND mi.InsuranceCarrierID = '+@SearchFilterCarrierId
	END
   END  
                    
    IF (@OrderID > 0)      
       BEGIN      
       DECLARE @Order VARCHAR(10);      
       SET @Order = CAST(@OrderID AS VARCHAR(10))      
    IF(@SQLQuery = 'SELECT DISTINCT TOP 100 M.MemberID, m.NHMEMBERID from   master.members m')      
    BEGIN      
      SET @SQLQueryRes = 'SELECT TOP 1 M.MemberID,CAST(1 AS BIGINT) AS RowID,  
   M.NHMemberID NhMemberNbr,M.FirstName,M.LastName,convert(varchar,(M.DateOfBirth),101) DOB,      
              A.Address1 Address,A.Address2,A.City,A.State,A.Country,A.ZipCode zip,A.AddressTypeCode,      
                 MD.InsuranceNbr PlanProgramID, IC.InsuranceCarrierName,IH.HealthPlanName,ISNULL(O.OrderID,0) AS OrderNumber      
       FROM [Master].Members M      
       LEFT JOIN (select * from Orders.Orders WITH (NOLOCK) where IsActive = 1) O ON O.NHMemberId = M.NHMemberID         
       LEFT JOIN (select * from [Master].Addresses WITH (NOLOCK) where IsActive = 1) A  on (M.MemberID=A.MemberID and a.IsPreferredAddress=1)      
       LEFT JOIN (select * from [Master].MemberInsurances WITH (NOLOCK) where IsActive = 1) MI  on M.MemberID=MI.MemberID      
       LEFT JOIN (select * from [Master].MemberInsuranceDetails WITH (NOLOCK) where IsActive = 1) MD  on MI.ID=MD.MemberInsuranceID     
       LEFT JOIN Insurance.InsuranceCarriers IC	WITH (NOLOCK)  on MI.InsuranceCarrierID=IC.InsuranceCarrierID      
       LEFT JOIN Insurance.InsuranceHealthPlans IH	WITH (NOLOCK)  on MI.InsuranceHealthPlanID=IH.InsuranceHealthPlanID      
       WHERE m.IsActive=1 AND O.OrderID ='+@Order+' order  by LastName,FirstName'      
    END      
    ELSE      
    BEGIN      
       SET @SQLQueryRes = 'SELECT DISTINCT TOP 1 M.MemberID,ROW_NUMBER() OVER (ORDER BY MD.InsuranceNbr) RowID,M.NHMemberID NhMemberNbr,M.FirstName,M.LastName,convert(varchar,(M.DateOfBirth),101) DOB,      
              A.Address1 Address,A.Address2,A.City,A.State,A.Country,A.ZipCode zip,A.AddressTypeCode,      
                 MD.InsuranceNbr PlanProgramID, IC.InsuranceCarrierName,IH.HealthPlanName,ISNULL(O.OrderID,0) AS OrderNumber      
       FROM [Master].Members M      
       LEFT JOIN (select * from Orders.Orders WITH (NOLOCK) where IsActive = 1) O ON O.NHMemberId = M.NHMemberID         
       LEFT JOIN (select * from [Master].Addresses WITH (NOLOCK) where IsActive = 1) A  on (M.MemberID=A.MemberID and a.IsPreferredAddress=1)      
       LEFT JOIN (select * from [Master].MemberInsurances WITH (NOLOCK) where IsActive = 1) MI  on M.MemberID=MI.MemberID      
       LEFT JOIN (select * from [Master].MemberInsuranceDetails WITH (NOLOCK) where IsActive = 1) MD  on MI.ID=MD.MemberInsuranceID       
       LEFT JOIN Insurance.InsuranceCarriers IC	WITH (NOLOCK)  on MI.InsuranceCarrierID=IC.InsuranceCarrierID      
       LEFT JOIN Insurance.InsuranceHealthPlans IH	WITH (NOLOCK)  on MI.InsuranceHealthPlanID=IH.InsuranceHealthPlanID      
       WHERE m.IsActive=1 AND O.OrderID ='+@Order+'  AND m.memberid in ( select memberid from (' + @SQLQuery + ')sq ) order  by LastName,FirstName'      
    END      
       END      
       ELSE      
       BEGIN      
       SET @SQLQueryRes = 'SELECT DISTINCT  TOP 50 M.MemberID,ROW_NUMBER() OVER (ORDER BY MD.InsuranceNbr) RowID,M.NHMemberID NhMemberNbr,M.FirstName,M.LastName,convert(varchar,(M.DateOfBirth),101) DOB,      
              A.Address1 Address,A.Address2,A.City,A.State,A.Country,A.ZipCode zip,A.AddressTypeCode,      
                 MD.InsuranceNbr PlanProgramID, IC.InsuranceCarrierName,IH.HealthPlanName,ISNULL(MAX(O.OrderID),0) AS OrderNumber      
       FROM [Master].Members M      
       LEFT JOIN (select * from Orders.Orders WITH (NOLOCK) where IsActive = 1) O ON O.NHMemberId = M.NHMemberID         
       LEFT JOIN (select * from [Master].Addresses WITH (NOLOCK) where IsActive = 1) A  on (M.MemberID=A.MemberID and a.IsPreferredAddress=1)      
       LEFT JOIN (select * from [Master].MemberInsurances WITH (NOLOCK) where IsActive = 1) MI  on M.MemberID=MI.MemberID      
       LEFT JOIN (select * from [Master].MemberInsuranceDetails WITH (NOLOCK) where IsActive = 1) MD  on MI.ID=MD.MemberInsuranceID    
       LEFT JOIN Insurance.InsuranceCarriers IC	WITH (NOLOCK)  on MI.InsuranceCarrierID=IC.InsuranceCarrierID      
       LEFT JOIN Insurance.InsuranceHealthPlans IH	WITH (NOLOCK)  on MI.InsuranceHealthPlanID=IH.InsuranceHealthPlanID      
       WHERE m.IsActive=1 AND m.memberid in ( select memberid from (' + @SQLQuery + ')sq )       
       group by M.MemberID,M.NHMemberID,M.FirstName,M.LastName,A.Address1,A.Address2,A.City,A.State,A.Country,A.ZipCode,A.AddressTypeCode,      
       MD.InsuranceNbr, IC.InsuranceCarrierName,IH.HealthPlanName,M.DateOfBirth order by LastName,FirstName'      
       END      
      
  IF @NHMemberID IS NOT NULL    
  BEGIN  
  SET @SQLQueryRes = (SELECT REPLACE(@SQLQueryRes,'TOP 50','TOP 1'))  
  --SET @SQLQueryRes = (SELECT REPLACE(@SQLQueryRes,'where a.ZipCode','and a.ZipCode'))
  END  
  
 -- PRINT @SQLQueryRes      
             
   EXECUTE sp_ExecuteSQL @SQLQueryRes      
             
      
    IF @@ERROR <> 0 GoTo ErrorHandler      
    Set NoCount OFF      
    Return(0)      
        
ErrorHandler:      
    Return(@@ERROR)      
END 


-- =============================================
-- Author:		RAMU KUNJA
-- Create date: 11-dEC-2017
-- Description:	PROCEDURE for Member Search Results
-- =============================================
CREATE Procedure [dbo].[sp_SearchMember2](
	-- Add the parameters for the stored procedure here
	@MemberID           BIGINT = NULL, 
    @NHMemberID         NVARCHAR(50) = NULL, 
	@FirstName          NVARCHAR(250) = NULL,
    @LastName           NVARCHAR(50) = NULL,
	@DateOfBirth        DATETIME = NULL,
	@Gender             NVARCHAR(10) = NULL,
	@MaritalStatus      NVARCHAR(25) = NULL,
	@Address1           NVARCHAR(500) = NULL,
	@Address2           NVARCHAR(500) = NULL,
	@City               NVARCHAR(50) = NULL,
	@State              NVARCHAR(10) = NULL,
	@Country            NVARCHAR(50) = NULL,
	@ZipCode            NVARCHAR(10) = NULL, 
    @EmailAddress       NVARCHAR(50) = NULL, 
    @Phone               NVARCHAR(50) = NULL,
	@InsuranceHealthPlanNumber NVARCHAR(250) = NULL,
	@InsuranceHealthPlanName NVARCHAR(250) = NULL,
	@InsuranceCarrierName NVARCHAR(250) = NULL)
AS
BEGIN
	-- SET NOCOUNT ON added to prevent extra result sets from
	-- interfering with SELECT statements.
	SET NOCOUNT ON;
	DECLARE @SQLQuery AS NVARCHAR(4000)

   SET @SQLQuery = 'SELECT DISTINCT M.MemberID,M.NHMemberID,M.FirstName,M.LastName,M.DateOfBirth,M.Gender,M.MiddleInitial,M.IsActive,
	       A.Address1,A.Address2,A.City,A.State,A.Country,A.ZipCode,A.AddressTypeCode,
	       P.PhoneNbr,P.CountryCode,P.IsPreferredPhoneNumber,P.PhoneExtension,
		   EM.EmailAddress,
		   MA.AttributeTypeCode,MA.AttributeValue,
		   MI.InsuranceCarrierID,MI.InsuranceEffectiveDate,MI.InsuranceHealthPlanID,MI.InsuranceType,
		   MD.InsuranceNbr,
		   IC.InsuranceCarrierName,IC.MemberDataFileProvided,
		   IH.HealthPlanName,IH.HealthPlanNumber
	FROM [Master].Members M
	LEFT JOIN [Master].Addresses A on M.MemberID=A.MemberID
	LEFT JOIN [Master].PhoneNumbers P on M.MemberID=P.MemberID
	LEFT JOIN [Master].Emails EM on M.MemberID = EM.MemberID
	LEFT JOIN [Master].MemberAttributes MA on M.MemberID=MA.MemberID
	LEFT JOIN [Master].MemberInsurances MI on M.MemberID=MI.MemberID
	LEFT JOIN [Master].MemberInsuranceDetails MD on MI.ID=MD.MemberInsuranceID
	LEFT JOIN Insurance.InsuranceCarriers IC on MI.InsuranceCarrierID=IC.InsuranceCarrierID
	LEFT JOIN Insurance.InsuranceHealthPlans IH on MI.InsuranceHealthPlanID=IH.InsuranceHealthPlanID
	 '
	--If any Single Value ---
	if(@FirstName IS NOT NULL)
	SET @SQLQuery = @SQLQuery + 'WHERE M.FirstName LIKE ''%' + @FirstName+'%'''
	if (@FirstName IS NOT NULL AND @LastName IS NOT NULL)
	SET @SQLQuery = @SQLQuery + ' AND M.LastName LIKE ''%' + @LastName+'%'''
	else if (@LastName IS NOT NULL)
	SET @SQLQuery = @SQLQuery + ' WHERE M.LastName LIKE ''%' + @LastName+'%'''

	if (@FirstName IS NOT NULL AND @LastName IS NOT NULL AND @DateOfBirth IS NOT NULL)
	SET @SQLQuery = @SQLQuery + ' AND M.DateOfBirth =''' + @DateOfBirth +''
	else IF (@DateOfBirth IS NOT NULL)
	SET @SQLQuery = @SQLQuery + ' WHERE M.DateOfBirth =''' + @DateOfBirth +''


	if (@FirstName IS NOT NULL AND @LastName IS NOT NULL AND @DateOfBirth IS NOT NULL AND @Gender IS NOT NULL)
	SET @SQLQuery = @SQLQuery + ' AND M.Gender =''' + @Gender +''
	else if (@Gender IS NOT NULL)
	SET @SQLQuery = @SQLQuery + ' WHERE M.Gender =''' + @Gender + ''''
	
	if (@FirstName IS NOT NULL AND @LastName IS NOT NULL AND @DateOfBirth IS NOT NULL AND @Gender IS NOT NULL AND @MaritalStatus IS NOT NULL)
	SET @SQLQuery = @SQLQuery + ' AND M.MaritalStatus =''' + @MaritalStatus +''''
	else if (@MaritalStatus IS NOT NULL)
	SET @SQLQuery = @SQLQuery + ' WHERE M.MaritalStatus =''' + @MaritalStatus +''''
	
	if (@FirstName IS NOT NULL AND @LastName IS NOT NULL AND @DateOfBirth IS NOT NULL AND @Gender IS NOT NULL AND @MaritalStatus IS NOT NULL AND @Address1 IS NOT NULL)
	SET @SQLQuery = @SQLQuery + ' AND A.Address1 LIKE ''%'+@Address1+'%'''
	else if (@Address1 IS NOT NULL)
	SET @SQLQuery = @SQLQuery + ' WHERE A.Address1 LIKE ''%'+@Address1+'%'''
	
	if (@FirstName IS NOT NULL AND @LastName IS NOT NULL AND @DateOfBirth IS NOT NULL AND @Gender IS NOT NULL AND @MaritalStatus IS NOT NULL AND @Address1 IS NOT NULL AND @Address2 IS NOT NULL)
	SET @SQLQuery = @SQLQuery + ' AND A.Address2 LIKE ''%'+@Address2+'%'''
	else if (@Address2 IS NOT NULL)
	SET @SQLQuery = @SQLQuery + ' WHERE A.Address2 LIKE ''%'+@Address2+'%'''
	
	if (@FirstName IS NOT NULL AND @LastName IS NOT NULL AND @DateOfBirth IS NOT NULL AND @Gender IS NOT NULL AND @MaritalStatus IS NOT NULL AND @Address1 IS NOT NULL AND @Address2 IS NOT NULL AND @City IS NOT NULL)
	SET @SQLQuery = @SQLQuery + ' AND A.City =''' +@City + ''''
	else if (@City IS NOT NULL)
	SET @SQLQuery = @SQLQuery + ' WHERE A.City =''' +@City + ''''
	
	if (@FirstName IS NOT NULL AND @LastName IS NOT NULL AND @DateOfBirth IS NOT NULL AND @Gender IS NOT NULL AND @MaritalStatus IS NOT NULL AND @Address1 IS NOT NULL AND @Address2 IS NOT NULL AND @City IS NOT NULL AND @State IS NOT NULL)
	SET @SQLQuery = @SQLQuery + ' AND A.[State] LIKE ''%'+@State+'%'''
	else if (@State IS NOT NULL)
	SET @SQLQuery = @SQLQuery + ' WHERE A.[State] LIKE ''%'+@State+'%'''
	
	if (@FirstName IS NOT NULL AND @LastName IS NOT NULL AND @DateOfBirth IS NOT NULL AND @Gender IS NOT NULL AND @MaritalStatus IS NOT NULL AND @Address1 IS NOT NULL AND @Address2 IS NOT NULL AND @City IS NOT NULL AND @State IS NOT NULL AND @Country IS NOT NULL)
	SET @SQLQuery = @SQLQuery + ' AND A.Country LIKE ''%'+@Country+'%'''
	else if (@Country IS NOT NULL)
	SET @SQLQuery = @SQLQuery + ' WHERE A.Country LIKE ''%'+@Country+'%'''
	
	if (@FirstName IS NOT NULL AND @LastName IS NOT NULL AND @DateOfBirth IS NOT NULL AND @Gender IS NOT NULL AND @MaritalStatus IS NOT NULL AND @Address1 IS NOT NULL AND @Address2 IS NOT NULL AND @City IS NOT NULL AND @State IS NOT NULL AND @Country IS NOT NULL AND @ZipCode IS NOT NULL)
	SET @SQLQuery = @SQLQuery + ' AND A.ZipCode =''' +@ZipCode + ''''
	else if (@ZipCode IS NOT NULL)	 
	SET @SQLQuery = @SQLQuery + ' WHERE A.ZipCode =''' +@ZipCode + ''''
	
	if (@FirstName IS NOT NULL AND @LastName IS NOT NULL AND @DateOfBirth IS NOT NULL AND @Gender IS NOT NULL AND @MaritalStatus IS NOT NULL AND @Address1 IS NOT NULL AND @Address2 IS NOT NULL AND @City IS NOT NULL AND @State IS NOT NULL AND @Country IS NOT NULL AND @ZipCode IS NOT NULL AND @EmailAddress IS NOT NULL)
	SET @SQLQuery = @SQLQuery + ' AND EM.EmailAddress =''' + @EmailAddress +''''
	if (@EmailAddress IS NOT NULL)	 
	SET @SQLQuery = @SQLQuery + ' WHERE EM.EmailAddress =''' + @EmailAddress +''''
	
	if (@FirstName IS NOT NULL AND @LastName IS NOT NULL AND @DateOfBirth IS NOT NULL AND @Gender IS NOT NULL AND @MaritalStatus IS NOT NULL AND @Address1 IS NOT NULL AND @Address2 IS NOT NULL AND @City IS NOT NULL AND @State IS NOT NULL AND @Country IS NOT NULL AND @ZipCode IS NOT NULL AND @EmailAddress IS NOT NULL AND @Phone IS NOT NULL)
	SET @SQLQuery = @SQLQuery + ' AND P.PhoneNbr = ''' +@Phone + ''''
	else if (@Phone IS NOT NULL)	 
	SET @SQLQuery = @SQLQuery + ' WHERE P.PhoneNbr = ''' +@Phone + ''''
	
	if (@FirstName IS NOT NULL AND @LastName IS NOT NULL AND @DateOfBirth IS NOT NULL AND @Gender IS NOT NULL AND @MaritalStatus IS NOT NULL AND @Address1 IS NOT NULL AND @Address2 IS NOT NULL AND @City IS NOT NULL AND @State IS NOT NULL AND @Country IS NOT NULL AND @ZipCode IS NOT NULL AND @EmailAddress IS NOT NULL AND @Phone IS NOT NULL AND @InsuranceHealthPlanNumber IS NOT NULL)
	SET @SQLQuery = @SQLQuery + ' AND MD.InsuranceNbr LIKE ''%'+@InsuranceHealthPlanNumber+'%'''
	else if (@InsuranceHealthPlanNumber IS NOT NULL)	 
	SET @SQLQuery = @SQLQuery + ' WHERE MD.InsuranceNbr LIKE ''%'+@InsuranceHealthPlanNumber+'%'''
	--If any Single Value ---


	PRINT @SQLQuery
	EXECUTE sp_executesql @SQLQuery

	 If @@ERROR <> 0 GoTo ErrorHandler
    Set NoCount OFF
    Return(0)
  
ErrorHandler:
    Return(@@ERROR)
END


--EXEC [dbo].[sp_SearchMember2] @MemberID = NULL , 
--    @NHMemberID  = NULL, 
--	@FirstName = NULL,
--    @LastName = NULL,
--	@DateOfBirth= NULL,
--	@Gender = NULL,
--	@MaritalStatus = NULL,
--	@Address1 = null,
--	@Address2 = NULL,
--	@City = NULL,
--	@State = NULL,
--	@Country = NULL,
--	@ZipCode = NULL, 
--    @EmailAddress = NULL, 
--    @Phone  = NULL,
--	@InsuranceHealthPlanNumber = 'JR1992M82570',
--	@InsuranceHealthPlanName = NULL,
--	@InsuranceCarrierName = NULL
CREATE PROCEDURE [dbo].[sp_GetActiveInsurances]    
(    
 @MemberProfileID          BIGINT = 0    
)    
AS    
BEGIN    
	SET NOCOUNT ON;
	SELECT ROW_NUMBER() OVER (ORDER BY InsuranceCarrierName) RowID,
	[Status],
	InsuranceCarrierName,
	HealthPlanName,
	NHMemberId,
	InsuranceEffectiveDate,
	InsuranceEndDate 
		FROM  (SELECT 
					CASE WHEN mi.InsuranceEndDate  >= GETDATE() THEN 'Active' 
					ELSE 'Inactive' END AS[Status],
	ic.InsuranceCarrierName,
	hp.HealthPlanName,
	mp.NHMemberId,
	mi.InsuranceEffectiveDate,
	mi.InsuranceEndDate   
 FROM [provider].[MemberInsurances] mi 
 INNER JOIN [provider].[MemberProfiles] mp ON mp.MemberProfileID = mi.MemberProfileId  AND mi.IsActive = 1    
 INNER JOIN [Insurance].[InsuranceCarriers] ic ON mi.InsuranceCarrierID = ic.InsuranceCarrierID AND ic.IsActive =1     
 INNER JOIN [Insurance].[InsuranceHealthPlans] hp ON mi.InsuranceHealthPlanID = hp.InsuranceHealthPlanID AND hp.IsActive = 1
 WHERE mi.MemberProfileID = @MemberProfileID) tmp

END


CREATE  PROCEDURE [dbo].[DataSync_Sync_LocationHCPsMapping_4PVN]
AS
BEGIN

--Insert into ProviderUsers
  insert into [provider].[ProviderUsers] ( userprofileid,providerid, createdate, createuser, isactive, modifydate, modifyuser)
  select userprofileid, providerid, getdate(), 'SyncProc',1 ,getdate(), 'SyncProc' from(
select distinct(select userprofileid from [provider].[HCPProviderProfile] 
where hcpid = pp.hcpid) userprofileid,(select providerid from [provider].[ProviderProfiles] where taxid = pp.taxid) providerid from [dbo].[ProviderDataHCPMapping] pp
where exists (select 1 from [auth].[UserProfiles] up where pp.npinumber = up.username or pp.nhnpi = up.username) 
and not exists 
(select 1 from provider.providerusers p 
where p.providerid = pp.providerid 
and p.userprofileid in (select userprofileid from [provider].[HCPProviderProfile] 
where hcpid = pp.hcpid))
)a where providerid is not null and userprofileid is not null


----Insert into ProviderUsersLocations
merge [provider].[ProviderUserLocations] pul
using [dbo].[ProviderDataHCPMapping] hm
on (pul.locationId = hm.locationId and pul.userProfileId = (select top 1 userprofileid from provider.hcpproviderprofile where hcpid = hm.hcpid and userprofileid is not null))
when matched and hm.Action = 'U' then
update set pul.ProviderId = hm.ProviderId,pul.locationId = hm.locationId, pul.IsActive = hm.IsActive, 
pul.modifyDate = getdate(), pul.modifyUser = 'SyncProc'
when not matched and hm.Action = 'N' then
insert ([ProviderId], [LocationId], [UserProfileId], [CreateDate], [CreateUser], [IsActive], [ModifyDate], [ModifyUser])
values (hm.providerId, hm.locationId, (select top 1 userprofileid from provider.hcpproviderprofile where hcpid = hm.hcpid), getdate(), 'SyncProc', 1, getdate(), 'SyncProc');


/*
insert into [provider].[ProviderUserLocations] (userprofileid,providerid, locationid, createdate, createuser, isactive, modifydate, modifyuser)
select distinct(select userprofileid from [provider].[HCPProviderProfile] 
where hcpid = pp.hcpid) userprofileid, providerid, locationid, getdate(),'SyncProc',1 ,getdate(), 'SyncProc' 
from [dbo].[ProviderDataHCPMapping] pp
where exists (select 1 from [auth].[UserProfiles] up where pp.npinumber = up.username or pp.nhnpi = up.username) 
and locationid <>''
 and not exists (select 1 from [provider].[ProviderUserLocations] upl where pp.providerid = upl.providerid and pp.locationid = upl.locationid and 
(select userprofileid from [provider].[HCPProviderProfile] where hcpid = pp.hcpid) = upl.userprofileid) 

*/
--update [dbo].[ProviderDataHCPMapping] set [Action] = ''

END

--------

-- EXEC [dbo].[sp_rpt_qb_ff_payment_checks]

CREATE procedure [dbo].[sp_rpt_qb_ff_payment_checks]
as
select IP.*,  cp.PONumber, cp.paymentMethod,cp.paymentDate,cp.checkNum
from (

select 
d.InvoiceBatchId
,p.providerid
,p.vendorName
,p.paymentAmount
--,CAST(p.paymentDate AS DATE) paymentDate
,i.invoiceId
,CAST(i.date AS DATE) FittingDate
,i.reference
,i.originalAmount
,i.payment
,NULL as BalanceDue
,NULL as Discount
,'Bill' Type
from paymentgateway.invoicedata d
outer apply openjson(d.invoicecheckdata) with (
       checks nvarchar(max) as json
) f
outer apply openjson(f.checks) with(
       providerId bigint,
       vendorName varchar(200),
       paymentAmount decimal(10,2),
       paymentDate varchar(50),
       invoices nvarchar(max) as json
) p
outer apply openjson(p.invoices) with(
       invoiceId bigint,
       date varchar(50),
       reference varchar(100),
       originalAmount decimal(10,2),
       payment decimal(10,2)
) i
) IP

left JOIN
(
select 
i.InvoiceId, 
i.PONumber
--, i.InvoiceAmount
--, JSON_VALUE(i.PaymentData,'$.invoicePayment') invoicePayment
, JSON_VALUE(i.PaymentData,'$.paymentMethod') paymentMethod
, i.BatchId
, JSON_VALUE(i.PaymentData,'$.payData.paymentDate') paymentDate,
cast(JSON_VALUE(i.PaymentData,'$.payData.checkNum') as bigint) checkNum
from accounts.Invoices i
where 1=1
and i.Status='Paid'
and BatchId is not null
) CP ON (CP.InvoiceId=IP.invoiceId AND CP.BatchId=IP.InvoiceBatchId)
CREATE PROCEDURE [dbo].[DataSync_Get_HCPS_4PVN]
AS
BEGIN
SELECT 
    '' AS Action,    
    [HCP].[HCPId] AS 'HCPId',
	isnull([HCP].[FirstName], '') AS 'FirstName',
	isnull([HCP].[LastName], '') AS 'LastName',
	isnull([HCP].[NPINumber], '') AS 'NPINumber',
	isnull([HCP].[NHNPI], '') AS 'NHNPI',
	[HCP].[ISActive] AS 'IsActive',   
    isnull(JSON_VALUE([HCP].[LicenseData],'$.licenseNumber1'), '') AS 'LicenseNumber1',
    isnull(JSON_VALUE([HCP].[LicenseData],'$.licenseStates1'),'') AS 'LicenseState1',
	 isnull(JSON_VALUE([HCP].[LicenseData],'$.licenseNumber2'), '') AS 'LicenseNumber2',
    isnull(JSON_VALUE([HCP].[LicenseData],'$.licenseStates2'),'') AS 'LicenseState2',
	 isnull(JSON_VALUE([HCP].[LicenseData],'$.licenseNumber3'), '') AS 'LicenseNumber3',
    isnull(JSON_VALUE([HCP].[LicenseData],'$.licenseStates3'),'') AS 'LicenseState3',
	isnull(JSON_VALUE([HCP].[LicenseData],'$.boardCertified'), '') AS 'BoardCertified',
    isnull(JSON_VALUE([HCP].[LicenseData],'$.credentialDate'),'') AS 'CredentialDate'
FROM [provider].[HCPProviderProfile] HCP
END
CREATE Procedure [dbo].[Get_HearingService_Testing_Item]
AS
BEGIN
	-- SET NOCOUNT ON added to prevent extra result sets from
	-- interfering with SELECT statements.
	SET NOCOUNT ON;

    -- Insert statements for procedure here
	SELECT	GETDATE()					as 'Nations_Date_Modified',
			'NH_TESTING'				as 'Nations_ITM_ID',
			'Hearing Test Completed'	as 'ITM_DESCRIPTION',
			0							as 'ITEM_PRICE',
			'992591'					as 'Nations_PRO_CODE'

END

CREATE PROCEDURE [dbo].[DataSync_Sync_Providers_4PVN]
AS
BEGIN
merge [provider].[ProviderProfiles] pp
using [dbo].[ProviderDataProviders] sp
on (sp.providerid = pp.providerid)
when matched and sp.Action = 'U' and sp.[TaxId] is not null then
update set 
pp.[TaxId] = sp.[TaxId],
pp.[ProviderName] = (case sp.[ProviderName] when '' then null else sp.[ProviderName] end),
pp.[IsActive]= cast(case sp.[IsActive] when '1' then 1 when '0' then 0 when '' then 1 else sp.[IsActive] end as bit),
pp.[Brands]= (case sp.[Brands] when '' then null else sp.[Brands] end),
pp.[PracticeTypeId]= sp.[PracticeTypeId],
pp.[PrimaryEmailAddress]= (case sp.[PrimaryEmailAddress] when '' then null else sp.[PrimaryEmailAddress] end),
pp.[AdditionalData] = (concat('{"billingAddress":{"address1":"',isnull(sp.[BillingAddress],''),'","address2":"","city":"',isnull(sp.[BillingCity],''),'","state":"',isnull(sp.[BillingState],''),
 '","zip":"',cast(sp.[BillingZip] as nvarchar(10)),'","county":"',isnull(sp.[BillingCounty],''),'","phoneNumber":"',isnull(sp.[BillingPhoneNumber],''),'","email":""},"shippingAddress":{"address1":"',isnull(sp.[ShippingAddress],''),'","address2":"',isnull(sp.[ShippingAddress2],''),'","city":"',isnull(sp.[ShippingCity],''),
 '","state":"',isnull(sp.[ShippingState],''),'","zip":"',isnull(sp.[ShippingZip],''),'","county":"","phoneNumber":"","email":""},"owner":{"firstName":"',isnull(sp.[OwnerFirstName],''),'","lastName":"',isnull(sp.[OwnerLastName],''),'"},"contractInfo":{"contractType":"',isnull(sp.[ContractType],''),'","initialContractDate":"',isnull(sp.[InitialContract],''),
'","recentContractDate":"',isnull(sp.[RecentContract],''),'","contractTerminationDate":"',isnull(sp.[ContractTermination],''),'","anthemAmendmentDate":"',isnull(sp.[AnthemAmendment],''),'"},"adaAttestationReceivedDate":"',isnull(sp.[ADAAttestationReceivedDate],''),'","medicareAttestationReceivedDate":"',isnull(sp.[MedicareAttestationReceivedDate],''),'"}') 
)

when not matched and sp.Action = 'N' then 
insert ([Brands],[IsActive],[PracticeTypeId],[PrimaryEmailAddress],[ProviderName],[TaxId],[CreateDate],[CreateUser],[ModifyDate],[ModifyUser],[Prospect],[AdditionalData])
values (
(case sp.[Brands] when '' then null else sp.[Brands] end),
1,1,(case sp.[PrimaryEmailAddress] when '' then null else sp.[PrimaryEmailAddress] end)
,(case sp.[ProviderName] when '' then null else sp.[ProviderName] end),
sp.[TaxId],getdate(), 'SyncProc',getdate(),'SyncProc',0,
(concat('{"billingAddress":{"address1":"',isnull(sp.[BillingAddress],''),'","address2":"","city":"',isnull(sp.[BillingCity],''),'","state":"',isnull(sp.[BillingState],''),
 '","zip":"',cast(sp.[BillingZip] as nvarchar(10)),'","county":"',isnull(sp.[BillingCounty],''),'","phoneNumber":"',isnull(sp.[BillingPhoneNumber],''),'","email":""},"shippingAddress":{"address1":"',isnull(sp.[ShippingAddress],''),'","address2":"',isnull(sp.[ShippingAddress2],''),'","city":"',isnull(sp.[ShippingCity],''),
 '","state":"',isnull(sp.[ShippingState],''),'","zip":"',isnull(sp.[ShippingZip],''),'","county":"","phoneNumber":"","email":""},"owner":{"firstName":"',isnull(sp.[OwnerFirstName],''),'","lastName":"',isnull(sp.[OwnerLastName],''),'"},"contractInfo":{"contractType":"',isnull(sp.[ContractType],''),'","initialContractDate":"',isnull(sp.[InitialContract],''),
'","recentContractDate":"',isnull(sp.[RecentContract],''),'","contractTerminationDate":"',isnull(sp.[ContractTermination],''),'","anthemAmendmentDate":"',isnull(sp.[AnthemAmendment],''),'"},"adaAttestationReceivedDate":"',isnull(sp.[ADAAttestationReceivedDate],''),'","medicareAttestationReceivedDate":"',isnull(sp.[MedicareAttestationReceivedDate],''),'"}') 
));

--Step 2
update provider.providerprofiles
 set brands = 'INDEPENDENT' where brands = 'Independent'
update provider.providerprofiles
 set brands = 'BELTONE' where brands = 'Beltone Franchise'

--INSERT USER PROFILE FOR PROVIDER OWNER
merge [auth].[UserProfiles] up
using [dbo].[ProviderDataProviders] sp
on (up.username = sp.taxid)
when matched and sp.Action = 'U' then 
update set
 up.Designation = sp.taxid
,up.FirstName = (case sp.ownerfirstname when '' then null else sp.ownerfirstname end)
,up.IsActive = 1
,up.IsBlocked = 0
,up.IsEnabled = 1
,up.IsRegister = 1
,up.LastName = (case sp.ownerlastname when '' then null else sp.ownerlastname end)
,up.ModifyDate = getdate()
,up.ModifyUser = 'SyncProc' 
when not matched and sp.Action = 'N' then 
insert (
 CreateDate
,CreateUser
,Designation
,FirstName
,IsActive
,IsBlocked
,IsEnabled
,IsRegister
,LastName
,ModifyDate
,ModifyUser
,TemproryKeyCode
,UserName
) values (getdate(),'SyncProc',sp.taxid,(case sp.ownerfirstname when '' then null else sp.ownerfirstname end),1,0,1,1,(case sp.ownerlastname when '' then null else sp.ownerlastname end),getdate(),'SyncProc',sp.taxid,sp.taxid);

--Insert into UserProfileGroups one record for owner
insert into [auth].[UserProfileGroups]  (usergroupid, userprofileid, createdate, createuser, isactive, modifydate, modifyuser) 
select 7900, userprofileid, getdate(),'SyncProc',1 IsActive,getdate(), 'SyncProc' From auth.userprofiles up
where exists (select 1 from [provider].[ProviderProfiles] pp where pp.taxid = up.username)
and not exists (select 1 from [auth].[UserProfileGroups]  upg where upg.userprofileid = up.userprofileid and usergroupid = 7900)

insert into [auth].[UserProfileSettings] ([CreateDate],[CreateUser],[IsActive],[ModifyDate],[ModifyUser],[SettingName],[SettingValue],[UserProfileId])
select getdate(), 'SyncProc',1 IsActive, getdate(), 'SyncProc', 'Roles' SettingName,  '["3"]' SettingValue , UserProfileID From [auth].[UserProfileGroups] upg
where upg.usergroupid = 7900
and not exists (select 1 from [auth].[UserProfileSettings] ups where ups.userprofileid = upg.userprofileid and ups.settingValue = '["3"]')


--Insert into UserProfileGroups one record for HCP
insert into [auth].[UserProfileGroups]  (usergroupid, userprofileid, createdate, createuser, isactive, modifydate, modifyuser) 
select 7600, userprofileid, getdate(),'SyncProc',1 IsActive,getdate(), 'SyncProc' From auth.userprofiles up
where exists (select 1 from [provider].[ProviderProfiles] pp where pp.taxid = up.username)
and not exists (select 1 from [auth].[UserProfileGroups]  upg where upg.userprofileid = up.userprofileid and usergroupid = 7600)

insert into [auth].[UserProfileSettings] ([CreateDate],[CreateUser],[IsActive],[ModifyDate],[ModifyUser],[SettingName],[SettingValue],[UserProfileId])
select getdate(), 'SyncProc',1 IsActive, getdate(), 'SyncProc', 'Roles' SettingName,  '["2"]' SettingValue , UserProfileID From [auth].[UserProfileGroups] upg
where upg.usergroupid = 7600
and not exists (select 1 from [auth].[UserProfileSettings] ups where ups.userprofileid = upg.userprofileid and ups.settingValue = '["2"]')


--Insert into ProviderUsers
insert into [provider].[ProviderUsers] (providerid, userprofileid, createdate, createuser, isactive, modifydate, modifyuser)
select providerid, userprofileid, getdate(), 'SyncProc',1 isactive, getdate(), 'SyncProc' from (
	select (select top 1 up.userprofileid from auth.userprofiles up where up.designation = sp.taxid) userprofileid, (select top 1 pp.providerid from provider.providerprofiles pp where pp.taxid = sp.taxid) providerid from [dbo].[ProviderDataProviders] sp) a
	where
	a.providerid is not null and a.userprofileid is not null and
	not exists (select 1 from provider.providerusers p where p.providerid = a.providerid and p.userprofileid = a.userprofileid)



 update sp
 set sp.providerid = (select cast(pp.providerid as varchar) from [provider].[providerprofiles] pp where pp.taxid = sp.taxid)
 from [dbo].[ProviderDataProviders] sp
 where cast(case sp.providerid when '' then '0' when null then '0' when 'NULL' then '0' else sp.providerid end as int) = 0
 
 update sp
 set sp.providerid = (select cast(pp.providerid as varchar) from [provider].[providerprofiles] pp where pp.taxid = sp.taxid)
 from [dbo].[ProviderDataLocations] sp
 where sp.providerid =''

--update [dbo].[ProviderDataProviders] set [Action] = ''

END


CREATE PROCEDURE [dbo].[DataSync_Sync_Locations_4PVN]
AS
BEGIN
update provider.locations set officesecodary = null
delete from [dbo].[ProviderDataLocations] where taxid is null

Alter table [dbo].[ProviderDataLocations] add id INT IDENTITY(1,1) NOT NULL

merge [provider].[Locations] l
using [dbo].[ProviderDataLocations] sl
on (cast(case sl.locationid when '' then 0 when null then 0 when 'NULL' then 0 else sl.locationid end as int) = l.locationid)
when matched and sl.Action = 'U' and sl.address1 <> ''and sl.address1 <> 'NULL' then 
update set
l.Address1 = sl.Address1
,l.Address2 = sl.Address2
,l.BusinessName = sl.BusinessName
,l.City = sl.City
,l.Dispenser = sl.Dispenser
,l.IsActive = sl.IsActive
,l.IsVerified = 1
,l.IsWheelChair = case when sl.WheelChair = 'Yes' then 1 else 0 end
,l.Langauges = sl.Languages
,l.LocationTypeId = 1
,l.ModifyDate = getdate()
,l.ModifyUser = 'SyncProc'
,l.NPINumber = sl.NPINumber
,l.OfficeSecodary = sl.ID
,l.State = sl.State
,l.[LocationEmailAddress] = sl.[LocationEmailAddress]
,l.Zip = format(cast(sl.Zip as int),'00000')
,l.[LocationServicesData] = (concat('{"mobileServices":',case when sl.WheelChair = 'Yes' then 1 else 0 end,',','"wheelChair":',case when sl.WheelChair = 'Yes' then 1 else 0 end, ',',
 '"peditatricServices":',case when sl.WheelChair = 'Yes' then 1 else 0 end, '}'))
when not matched and sl.Action = 'N' and sl.address1 <> '' and sl.address1 <> 'NULL' then 
insert 
(
Address1,Address2,BusinessName,City,CreateDate
,CreateUser,Dispenser,IsActive,IsVerified
,IsWheelChair,Langauges
,LocationTypeId
,ModifyDate,ModifyUser,NPINumber,OfficeSecodary
,State,LocationEmailAddress,Zip
,[LocationServicesData]
)
 values
(
sl.Address1,sl.Address2,sl.BusinessName,sl.City
,getdate(),'SyncProc',sl.Dispenser
,sl.IsActive
,1,case when sl.WheelChair = 'Yes' then 1 else 0 end
,Languages
,1,getdate(),'SyncProc',NPINumber
,sl.ID,State,sl.[LocationEmailAddress],format(cast(Zip as int),'00000'),
(concat('{"mobileServices":',case when sl.WheelChair = 'Yes' then 1 else 0 end,',','"wheelChair":',case when sl.WheelChair = 'Yes' then 1 else 0 end, ',',
 '"peditatricServices":',case when sl.WheelChair = 'Yes' then 1 else 0 end, '}'))
 );

--Step 4

--Updating LocationID  & Provider ID in .csv created file for future inserts
 update sl
 set sl.locationid = (select cast(pl.locationid as varchar) from [provider].[Locations] pl where pl.OfficeSecodary = sl.ID)
 from [dbo].[ProviderDataLocations] sl
 where  sl.locationid =''


--UPDATE/INSERT LOCATION PHONE NUMBERS
merge provider.locationphonenumbers lpn
using [dbo].[ProviderDataLocations] pl
on (cast(case pl.locationid when '' then 0 when null then 0 when 'NULL' then 0 else pl.locationid end as int) = lpn.locationid 
		and lpn.phoneTypeid=1 and pl.[LocationPhoneNumber] <> '' and pl.[LocationPhoneNumber] <> 'NULL')
when matched and pl.[LocationPhoneNumber] <> '' and pl.[LocationPhoneNumber] <> 'NULL' then update set
lpn.IsVerified=0,
lpn.ModifyUser='SyncProc',
lpn.ModifyDate=getdate(),
lpn.phonenumber=SUBSTRING(pl.locationPhoneNumber,0,12) ,
lpn.phoneserviceareatypeid=1
when not matched and pl.[LocationPhoneNumber] <> '' and pl.[LocationPhoneNumber] <> 'NULL' and pl.locationid != '' and pl.locationid != 'NULL' and pl.locationid is not null then 
insert(
[CreateDate],[CreateUser],[IsActive],[IsVerified],
[LocationId]
,[ModifyDate],[ModifyUser],
[PhoneNumber],
[PhoneServiceAreaTypeId],
[PhoneTypeId])
values(
getdate(),'SyncProc',1,0,
pl.locationid,
getdate(),'SyncProc',
SUBSTRING(pl.locationPhoneNumber,0,12) ,
1,1
);

merge provider.locationphonenumbers lpn
using [dbo].[ProviderDataLocations] pl
on (cast(case pl.locationid when '' then 0 when null then 0 when 'NULL' then 0 else pl.locationid end as int) = lpn.locationid
		 and lpn.phoneTypeid=3 and pl.[LocationFaxNumber] <> '' and pl.[LocationFaxNumber] <> 'NULL')
when matched then update set
lpn.IsVerified=0,
lpn.ModifyUser='SyncProc',
lpn.ModifyDate=getdate(),
lpn.phonenumber=pl.[LocationFaxNumber],
lpn.phoneserviceareatypeid=1
when not matched  and pl.[LocationFaxNumber] <> '' and pl.[LocationFaxNumber] <> 'NULL' and pl.locationid != '' and pl.locationid != 'NULL' and pl.locationid is not null then
insert(
[CreateDate],[CreateUser],[IsActive],[IsVerified],
[LocationId]
,[ModifyDate],[ModifyUser],
[PhoneNumber],
[PhoneServiceAreaTypeId],
[PhoneTypeId])
values(
getdate(),'SyncProc',1,0,
pl.locationid,
getdate(),'SyncProc',
pl.[LocationFaxNumber],
1,3);

--UPDATE/INSERT LOCATION ACCOUNT NUMBERS
merge [provider].[LocationsAccountNbrs] la
using [dbo].[ProviderDataLocations] pl
on (pl.locationid = la.locationid)
when matched and pl.Action = 'U' and pl.[Dispenser] is not null and pl.[Dispenser] like 'G%' then 
update set
la.[Dispenser] = pl.[Dispenser]
when not matched and pl.Action = 'N' and pl.locationId <> 'NULL' and pl.[Dispenser] is not null then
insert
([LocationId], [Dispenser], [BrandCode], [CreateUser], [CreateDate], [ModifyUser], [ModifyDate])
values
(pl.[LocationId], pl.[Dispenser], 'GNR', 'SyncProc', getdate(), 'SyncProc', getdate());

merge [provider].[LocationsAccountNbrs] la
using [dbo].[ProviderDataLocations] pl
on (pl.locationid = la.locationid)
when matched and pl.Action = 'U' and pl.[Dispenser] is not null and pl.[Dispenser] not like 'G%' then update set
la.[Dispenser] = pl.[Dispenser]
when not matched and pl.Action = 'N' and pl.locationId <> 'NULL' and pl.[Dispenser] is not null then
insert
([LocationId], [Dispenser], [BrandCode], [CreateUser], [CreateDate], [ModifyUser], [ModifyDate])
values
(pl.[LocationId], pl.[Dispenser], 'BELTONE', 'SyncProc', getdate(), 'SyncProc', getdate());


merge [provider].[LocationsAccountNbrs] la
using [dbo].[ProviderDataLocations] pl
on (pl.locationid = la.locationid and la.[BrandCode] = 'STARKEY')
when matched and pl.Action = 'U' and pl.[StarkeyAccountNumber] is not null then update set
la.[Dispenser] = pl.[StarkeyAccountNumber]
when not matched and pl.Action = 'N' and pl.locationId <> 'NULL' and pl.[StarkeyAccountNumber] is not null then
insert
([LocationId], [Dispenser], [BrandCode], [CreateUser], [CreateDate], [ModifyUser], [ModifyDate])
values
(pl.[LocationId], pl.[StarkeyAccountNumber], 'STARKEY', 'SyncProc', getdate(), 'SyncProc', getdate());

merge [provider].[LocationsAccountNbrs] la
using [dbo].[ProviderDataLocations] pl
on (pl.locationid = la.locationid and la.[BrandCode] = 'PHONAK')
when matched and pl.Action = 'U' and pl.[PhonakAccountNumber] is not null then update set
la.[Dispenser] = pl.[PhonakAccountNumber]
when not matched and pl.Action = 'N' and pl.locationId <> 'NULL'  and pl.[PhonakAccountNumber] is not null then
insert
([LocationId], [Dispenser], [BrandCode], [CreateUser], [CreateDate], [ModifyUser], [ModifyDate])
values
(pl.[LocationId], pl.[PhonakAccountNumber], 'PHONAK', 'SyncProc', getdate(), 'SyncProc', getdate());

merge [provider].[LocationsAccountNbrs] la
using [dbo].[ProviderDataLocations] pl
on (pl.locationid = la.locationid and la.[BrandCode] = 'WIDEX')
when matched and pl.Action = 'U' and pl.[WidexAccountNumber] is not null then update set
la.[Dispenser] = pl.[WidexAccountNumber]
when not matched and pl.Action = 'N' and pl.locationId <> 'NULL' and pl.[WidexAccountNumber] is not null then
insert
([LocationId], [Dispenser], [BrandCode], [CreateUser], [CreateDate], [ModifyUser], [ModifyDate])
values
(pl.[LocationId], pl.[WidexAccountNumber], 'WIDEX', 'SyncProc', getdate(), 'SyncProc', getdate());

merge [provider].[LocationsAccountNbrs] la
using [dbo].[ProviderDataLocations] pl
on (pl.locationid = la.locationid and la.[BrandCode] = 'SIGNIA')
when matched and pl.Action = 'U' and pl.[SigniaAccountNumber] is not null then update set
la.[Dispenser] = pl.[SigniaAccountNumber]
when not matched and pl.Action = 'N' and pl.locationId <> 'NULL' and pl.[SigniaAccountNumber] is not null then
insert
([LocationId], [Dispenser], [BrandCode], [CreateUser], [CreateDate], [ModifyUser], [ModifyDate])
values
(pl.[LocationId], pl.[SigniaAccountNumber], 'SIGNIA', 'SyncProc', getdate(), 'SyncProc', getdate());

merge [provider].[LocationsAccountNbrs] la
using [dbo].[ProviderDataLocations] pl
on (pl.locationid = la.locationid and la.[BrandCode] = 'UNITRON')
when matched and pl.Action = 'U' and pl.[UnitronAccountNumber] is not null then update set
la.[Dispenser] = pl.[UnitronAccountNumber]
when not matched and pl.Action = 'N' and pl.locationId <> 'NULL' and pl.[UnitronAccountNumber] is not null then
insert
([LocationId], [Dispenser], [BrandCode], [CreateUser], [CreateDate], [ModifyUser], [ModifyDate])
values
(pl.[LocationId], pl.[UnitronAccountNumber], 'UNITRON', 'SyncProc', getdate(), 'SyncProc', getdate());

merge [provider].[LocationsAccountNbrs] la
using [dbo].[ProviderDataLocations] pl
on (pl.locationid = la.locationid and la.[BrandCode] = 'OTICON')
when matched and pl.Action = 'U' and pl.[OticonAccountNumber] is not null then update set
la.[Dispenser] = pl.[OticonAccountNumber]
when not matched and pl.Action = 'N' and pl.locationId <> 'NULL' and pl.[OticonAccountNumber] is not null then
insert
([LocationId], [Dispenser], [BrandCode], [CreateUser], [CreateDate], [ModifyUser], [ModifyDate])
values
(pl.[LocationId], pl.[OticonAccountNumber], 'OTICON', 'SyncProc', getdate(), 'SyncProc', getdate());

--Insert into Providerlocations 
insert into [provider].[ProviderLocations] (providerid, locationid, createdate, createuser, isactive, modifydate, modifyuser)
select providerid, locationid, getdate(), 'SyncProc',1 isactive, getdate(), 'SyncProc' from (
	select locationid, providerid = (select providerid from provider.providerprofiles pp where pp.taxid = sl.taxid and providerid is not null) from [dbo].[ProviderDataLocations] sl) a
	where a.locationid is not null and providerid is not null and not exists (select 1 from provider.providerlocations p where p.providerid = a.providerid and p.locationid = a.locationid)
	
	
--Insert into ProviderUserlocations 
merge [provider].[ProviderUserLocations] pul
using [dbo].[ProviderdataLocations] hm
on (pul.providerId = hm.providerId and pul.locationId = hm.locationId and pul.userProfileId = (select top 1 userprofileid from auth.userprofiles where taxid = hm.taxid))
when matched and hm.IsActive <> pul.IsActive then
update set pul.IsActive = hm.IsActive, pul.modifyDate = getdate(), pul.modifyUser = 'SyncProc'
when not matched and hm.Action = 'N' then
insert ([ProviderId], [LocationId], [UserProfileId], [CreateDate], [CreateUser], [IsActive], [ModifyDate], [ModifyUser])
values (hm.providerId, hm.locationId, (select top 1 userprofileid from  auth.userprofiles  where taxid = hm.taxid), getdate(), 'SyncProc', 1, getdate(), 'SyncProc');

  
  --Need to update brand in provider.locations table
  select 'update provider.locations set brands = '''+brands+''' where locationid = '+ cast(locationid as varchar) from (
select locationid, brands = (select brands from provider.providerprofiles p where p.providerid = a.providerid)
from (
select providerid, locationid from provider.providerlocations
where locationid in (select locationid From provider.locations where brands is null)
) a
) b

/*
insert into [provider].[ProviderUserLocations] ([ProviderId],[LocationId],[UserProfileId],[CreateDate],[CreateUser],[IsActive],[ModifyDate],[ModifyUser])
 select providerid, locationid, userprofileid, getdate(), 'rmaram',1 IsActive, getdate(), 'rmaram' from (
  select pp.providerid, up.userprofileid, pl.locationid from provider.providerprofiles pp, auth.userprofiles up, provider.[ProviderLocations] pl
  where pp.taxid = up.username
  and pl.providerid  = pp.providerid ) a
  where not exists (select 1 from [provider].[ProviderUserLocations] pul
  where pul.providerid = a.providerid and pul.locationid = a.locationid and pul.userprofileid = a.userprofileid)
*/


--Update Timezone names
update [provider].[Locations]
set [Timezone] = 
case 
when [State] in ('WA','OR','NE','CO','CA','NV') then 'Pacific Standard Time'
when [State] in ('NY','NJ','VT','ME','NH','MA','RI','CT','PA','DE','MD','DC','VA','WV','MI','IN','OH','KY','NC','GA','FL','SC') then 'Eastern Standard Time' 
when [State] in ('MT','ID','WY','UT', 'CO','AZ','NM')  then 'Mountain Standard Time'
when [State] in ('ND','SD','NE','KS','OK','TX','MN','IA','MO','AR','LA','WI','IL','TN','MS','AL')  then 'Central Standard Time'
when [State] in ('AK') then 'Alaskan Standard Time'
when [State] in ('HA','HI') then 'Hawaiian Standard Time' 
end
where timezone is null

update provider.locations
set latitude = 0, longitude = 0
where latitude = 0 or latitude is null or longitude = 0 or longitude is null


select locationid,address1,address2,city,state,zip, latitude,longitude,timezone
 From provider.locations where  latitude = 0  and isactive =1
 

--update [dbo].[ProviderDataLocations] set [Action] = ''

END




CREATE PROCEDURE [dbo].[DataSync_Sync_HCPs_4PVN]
AS
BEGIN
--ADD/UPDATE USERPROFILE FOR HCP
merge [auth].[UserProfiles] up
using [dbo].[ProviderDataHCPs] sp
on (sp.hcpid is not null and up.userprofileid = (select top 1 userprofileid from provider.hcpproviderprofile where hcpid = sp.hcpid))
when matched and sp.Action = 'U' and ((sp.npinumber is not null and sp.npinumber != '') or (sp.nhnpi is not null and sp.nhnpi != '')) then 
update set
up.FirstName = (case sp.FirstName when '' then null else sp.FirstName end)
,up.IsActive = 1
,up.IsBlocked = 0
,up.IsEnabled = 1
,up.IsRegister = 1
,up.LastName = (case sp.LastName when '' then null else sp.LastName end)
,up.ModifyDate = getdate()
,up.ModifyUser = 'SyncProc' 
when not matched and sp.Action = 'N' and ((sp.npinumber is not null and sp.npinumber != '') or (sp.nhnpi is not null and sp.nhnpi != '')) 
and (select count(*) userprofileid from provider.hcpproviderprofile where hcpid = sp.hcpid) = 0 then 
insert (
 CreateDate
,CreateUser
,FirstName
,IsActive
,IsBlocked
,IsEnabled
,IsRegister
,LastName
,ModifyDate
,ModifyUser
,TemproryKeyCode
,UserName
) values (getdate(),'SyncProc',(case sp.FirstName when '' then null else sp.FirstName end),1,0,1,1,(case sp.LastName when '' then null else sp.LastName end),getdate(),'SyncProc',
(case when sp.npinumber is null or sp.npinumber = '' then sp.nhnpi else sp.npinumber end),
(case when sp.npinumber is null or sp.npinumber = '' then sp.nhnpi else sp.npinumber end));

--ADD/UPDATE HCP PROFILES
merge [provider].[HcpProviderProfile] HPP
using [dbo].[ProviderDataHCPs] PLH
on (PLH.hcpid = HPP.hcpid)
when matched and PLH.Action = 'U' and plh.hcpid is not null and ((plh.npinumber is not null and plh.npinumber != '') or (plh.nhnpi is not null and plh.nhnpi != '')) then 
update set
HPP.FirstName = (case PLH.FirstName when '' then null else PLH.FirstName end)
,HPP.LastName = (case PLH.LastName when '' then null else PLH.LastName end)
,HPP.NPINumber = PLH.NPINumber
,HPP.NHNPI = PLH.NHNPI
,HPP.IsActive = PLH.IsActive
,HPP.LicenseData = concat('{"licenseNumber1":"',(case [PLH].[LicenseNumber1] when null then '' else [PLH].[LicenseNumber1] end),'",','"licenseStates1":"',
(case [PLH].[LicenseState1] when null then '' else [PLH].[LicenseState1] end),'",','
"licenseNumber2":"',(case [PLH].[LicenseNumber2] when null then '' else [PLH].[LicenseNumber2] end),'",','"licenseStates2":"',
(case [PLH].[LicenseState1] when null then '' else [PLH].[LicenseState1] end),'",','
"licenseNumber3":"',(case [PLH].[LicenseNumber3] when null then '' else [PLH].[LicenseNumber3] end),'",','"licenseStates3":"',
(case [PLH].[LicenseState3] when null then '' else [PLH].[LicenseState3] end)
,'",','"boardCertified":"',(case [PLH].[BoardCertified] when null then '' else [PLH].[BoardCertified] end),'",','"credentialDate":"', (case [PLH].[CredentialDate] when null then '' else [PLH].[CredentialDate] end),'"}')
,HPP.ModifyDate = getdate()
,HPP.ModifyUser = 'SyncProc'
when not matched and PLH.Action = 'N' and ((plh.npinumber is not null and plh.npinumber != '') or (plh.nhnpi is not null and plh.nhnpi != '')) 
and (select count(*) from auth.userprofiles where username in (plh.npinumber, plh.nhnpi, concat(substring(plh.firstname, 0, 1), plh.lastname))) > 0 then 
insert (FirstName, LastName, NPINumber, IsActive,LicenseData, NHNPI,CreateDate,CreateUser, ModifyDate, ModifyUser, UserProfileId)
 values(
(case PLH.FirstName when '' then null else PLH.FirstName end), (case PLH.LastName when '' then null else PLH.LastName end), PLH.NPINumber, PLH.IsActive,
concat('{"licenseNumber1":"',(case [PLH].[LicenseNumber1] when null then '' else [PLH].[LicenseNumber1] end),'",','"licenseStates1":"',
(case [PLH].[LicenseState1] when null then '' else [PLH].[LicenseState1] end),'",','
"licenseNumber2":"',(case [PLH].[LicenseNumber2] when null then '' else [PLH].[LicenseNumber2] end),'",','"licenseStates2":"',
(case [PLH].[LicenseState1] when null then '' else [PLH].[LicenseState1] end),'",','
"licenseNumber3":"',(case [PLH].[LicenseNumber3] when null then '' else [PLH].[LicenseNumber3] end),'",','"licenseStates3":"',
(case [PLH].[LicenseState3] when null then '' else [PLH].[LicenseState3] end)
,'",','"boardCertified":"',(case [PLH].[BoardCertified] when null then '' else [PLH].[BoardCertified] end),'",','"credentialDate":"', (case [PLH].[CredentialDate] when null then '' else [PLH].[CredentialDate] end),'"}')
,PLH.NHNPI,getdate(), 'SyncProc', getdate(), 'SyncProc', 
(select top 1 userprofileid from auth.userprofiles where username in (plh.npinumber, plh.nhnpi, concat(substring(plh.firstname, 0, 1), 
plh.lastname))));


update p
set userprofileid = (select userprofileid from auth.userprofiles u where p.nhnpi=u.username)
from  provider.hcpproviderprofile p
where p.userprofileid=1792



update p
set userprofileid = (select userprofileid from auth.userprofiles u where p.npinumber=u.username)
from  provider.hcpproviderprofile p
where p.userprofileid=1792


--USERPROFILEGROUP FOR HCPS
insert into [auth].[UserProfileGroups]  (usergroupid, userprofileid, createdate, createuser, isactive, modifydate, modifyuser) 
select 7600, userprofileid, getdate(),'SyncProc',1 ,getdate(), 'SyncProc' from auth.userprofiles up
where exists (select 1 from [provider].[HCPProviderProfile] pp where pp.npinumber = up.username or pp.nhnpi = up.username or concat(substring(pp.firstname, 0, 1), pp.lastname) = up.username)
and not exists (select 1 from [auth].[UserProfileGroups]  upg where upg.userprofileid = up.userprofileid and usergroupid = 7600)


insert into [auth].[UserProfileSettings] ([CreateDate],[CreateUser],[IsActive],[ModifyDate],[ModifyUser],[SettingName],[SettingValue],[UserProfileId])
select getdate(), 'SyncProc',1 IsActive, getdate(), 'SyncProc', 'Roles' SettingName,  '["2"]' SettingValue , UserProfileID From [auth].[UserProfileGroups] upg
where upg.usergroupid = 7600
and not exists (select 1 from [auth].[UserProfileSettings] ups where ups.userprofileid = upg.userprofileid and ups.settingValue = '["2"]')

update p set p.hcpid = (select h.hcpid from provider.hcpproviderprofile h where h.npinumber=p.npinumber)
from  [dbo].[ProviderDataHCPs] p
where hcpid=''


update p set p.hcpid = (select h.hcpid from provider.hcpproviderprofile h where h.npinumber=p.npinumber)
from  [dbo].[ProviderDataHCPmapping] p
where hcpid='' and npinumber <>''

update p set p.hcpid = (select h.hcpid from provider.hcpproviderprofile h where h.nhnpi=p.nhnpi)
from  [dbo].[ProviderDataHCPmapping] p
where hcpid='' and nhnpi <>''

--update [dbo].[ProviderDataHCPs] set [Action] = ''

END

-- =============================================
-- Author:		KALYANA GOBBURI
-- Create date: 16-Nov-2017
-- Description:	<Description,,>
-- =============================================
CREATE Procedure [dbo].[sp_MoveOrderData]	
AS
BEGIN
	-- SET NOCOUNT ON added to prevent extra result sets from
	-- interfering with SELECT statements.
	SET NOCOUNT ON;
	SET ANSI_WARNINGS OFF;
    -- Insert statements for procedure here
	INSERT INTO temp_MemberOrders(
	NHMemberID
      ,[MemberFirstName]
      ,[MemberLastName]
      ,[DispenserOrGN]
      ,[OrderDate]
      ,[LegalBusinessName]
      ,[DBA]
      ,[HCPEmail]
      ,[ProviderAddress]
      ,[ProviderCity]
      ,[ProviderState]
      ,[ProviderZipCode]
      ,[ShipToName]
      ,[ShiptoAddress]
      ,[ShiptoCity]
      ,[ShiptoState]
      ,[ShiptoZipcode]
      ,[MemberInsuranceCarrier]
      ,[HearingTestCoPay]
      ,[HearingAidCoPay]
      ,[HAFittingCoPay]
      ,[Comments]
      ,[PaymentMethod]
      ,[Price]
      ,[AmountPaid]
      ,[Last4CreditCard]
      ,[CheckNo]
      ,[CheckRoutingNo]
      ,[CheckAccountNo]
      ,[FinancingOption]
      ,[PaymentComments]
      ,[PONumber]
      ,[PODate]
      ,[FittingOrDeliveryDate]
		,[IsOrderCancelled]
		,[CancelledDate]
		,[CancelledReason]
		,[IsProductReturned]
		,[ReturnDate]
		,[ReturnReason]
		,[PaidViaCard]
		,[PaidViaCheck]
		,[FinanceAmount]
		,[Brand]
		,[LeftTechnologyLevel]
		,[LeftQuantity]
		,[LeftProductLine]
		,[LeftModelFamily]
		,[RightTechnologyLevel]
		,[RightQuantity]
		,[RightProductLine]
		,[RightModelFamily]
		,[ReturnReasonCode]
		,[MemberAddress]
		,[MemberCity]
		,[MemberState]
		,[MemberZipcode]
		,[IsProcessed]
	  )
      --,[MemberResponsibility]
	SELECT
		VSO_M.NHMemberID,
		O.[Member First Name],
		O.[Member Last Name],
		O.[Disp #],
		O.[DateOrder Initiated],
		O.[Legal Business Name],
		O.[DBA],
		O.[Email],
		O.[Ship to Address],
		O.[City],
		O.[State],
		O.[Zip],
		O.[Legal Business Name],
		O.[Ship to Address],
		O.[City],
		O.[State],
		O.[Zip],
		case 
			when O.[Program] like '%CVS%' or O.[Program] like '%Silverscript%' then 'Silverscript' 
			when O.[Program] like '%Central Health%' then 'Central Health Premier Plan'
			when O.[Program] like '%BCBS%' then 'BCBSFEP'
			else O.[Program]
			end as [Program],
		S.[TEST            CO-PAY],
		S.[HA             CO-PAY],
		S.[HA FITTING CO-PAY],
		O.[Notes],
		O.[ Payment Type],
		O.[Purchase Price],
		S.[Member Pymt Amt],
		O.[Last 4 digits Check #],
		O.[Last 4 digits Check #],
		O.[ABA/Transit #],
		O.[Bank Acct number],
		O.[ Payment Type],
		S.[Notes],
		O.[PO Number],
		O.[PO/Order Sent],
		VSO.FittingDate
		,T2.[IsOrderCancelled]
		,T2.[CancelledDate]
		,T2.[CancelledReason]
		,T3.[IsProductReturned]
		,T3.[ReturnDate]
		,T3.[ReturnReason]
		,T4.[Paid Via Card]
		,T4.[Paid Via Check]
		,T4.[Finance Amount]
		,VSO.Brand
		,T1.LeftTechnologyLevel
		,T1.LeftQuantity
		,VSO.LeftProductLine
		,VSO.LeftModelFamily
		,T1.RightTechnologyLevel
		,T1.RightQuantity
		,VSO.RightProductLine
		,VSO.RightModelFamily
		,SR.[Reason code]
		,VSO_M.MemberAddress
		,VSO_M.MemberCity
		,VSO_M.MemberState
		,VSO_M.MemberZipCode
		,0
	FROM ['2017 HA Order Log$'] O
	LEFT JOIN ['2017 HA Sales Receipts$'] S ON O.[PO Number]=S.[PO Number]
	LEFT JOIN ['Fitting & Delivery Log$'] F ON O.[PO Number]=F.[PO Number]
	LEFT JOIN ['Not Approved Log$'] NA ON O.[DateOrder Initiated]=NA.[Order Date]
	LEFT JOIN ['Refund of Deposit$'] RD ON O.[PO Number]=RD.[PO]
	LEFT JOIN ['Sales Returns$'] SR ON O.[PO Number]=SR.[PO]
	LEFT JOIN 
	(
		select [PO Number], [Product Family/Model], [Qty],
			case when [Qty] > 0
				then 1
				else 0
				end as [LeftQuantity],
			case when [Qty] > 0 then [Technology Level] else NULL end as [LeftTechnologyLevel],
			case when [Qty] = 2 then [Technology Level] else NULL end as [RightTechnologyLevel], 
			case when [Qty] = 2
				then  1
				else  0
				end as [RightQuantity] --[Product Family/Model], [Qty]
			from ['2017 HA Order Log$'] O
			where [Product Family/Model] is not null and [Qty] is not null
	) T1 ON O.[PO Number]=T1.[PO Number]
	LEFT JOIN
	(
		select [PO],
			case when [Date of Cancellation] is not null then 1 else 0 end as [IsOrderCancelled],
			case when [Date of Cancellation] is not null then [Date of Cancellation] else NULL end as [CancelledDate],
			case when [Date of Cancellation] is not null then [Details] else NULL end as [CancelledReason]
		from ['Refund of Deposit$']
		where [Date of Cancellation] is not null
	) T2 ON O.[PO Number]=T2.[PO]
	LEFT JOIN
	(
		select [PO],
			case when [Date of Returnto Provider] is not null then 1 else 0 end as [IsProductReturned],
			case when [Date of Returnto Provider] is not null then [Date of Returnto Provider] else NULL end as [ReturnDate],
			case when [Date of Returnto Provider] is not null then [Detailed Reason for Return] else NULL end as [ReturnReason]
		from ['Sales Returns$']
		where [Date of Returnto Provider] is not null
	) T3 ON O.[PO Number]=T3.[PO]
	LEFT JOIN
	(
		select [PO Number],
			case when [ Payment Type] like '%Credit Card%' then 1 else 0 end as [Paid Via Card],
			case when [ Payment Type] like '%Check%' then 1 else 0 end as [Paid Via Check],
			case when [ Payment Type] not like '%Credit Card%' and [ Payment Type] not like '%Check%' then [Purchase Price] else NULL end as [Finance Amount]
		from ['2017 HA Order Log$']
	) T4 ON O.[PO Number]=T4.[PO Number]
	LEFT JOIN 
	(
		select [PO_Nbr], [ContactID],
			[Manufacturer] as [Brand],
			[Fitted_Date] as [FittingDate],
			case when [Qty_Ordered] > 0 then [Product_Model] else NULL end as [LeftProductLine],
			case when [Qty_Ordered] = 2 then [Product_Model] else NULL end as [RightProductLine],
			case when [Qty_Ordered] > 0 then [Product_Family] else NULL end as [LeftModelFamily],
			case when [Qty_Ordered] = 2 then [Product_Family] else NULL end as [RightModelFamily]
		from [vsdatamig].[DMOrders]
	) VSO ON O.[PO Number]=VSO.[PO_Nbr]
	LEFT JOIN
	(
		select ContactID, ([Address1] + ' ' + [Address2]) as MemberAddress,
			[NHMemberID] as NHMemberID,
			[City] as MemberCity,
			[State] as MemberState,
			[ZipCode] as MemberZipCode,
			[Email] as MemberEmail
		from [vsdatamig].[DMContacts]
	) VSO_M ON VSO.[ContactID]=VSO_M.[ContactID]
END

-- =============================================
-- Author:      bhanu prakash Inturi
-- Create Date: 25-Feb-2019
-- Description: <Description, , >
--exec [Document].[GetProcessDataDocumentList] 18997, 57, 0
-- =============================================
CREATE PROCEDURE [Document].[GetProcessDataDocumentList]
(
    -- Add the parameters for the stored procedure here
     @EngagementID bigint,
     @ProviderID bigint,
     @MemberProfileID bigint
)
AS
BEGIN
    -- SET NOCOUNT ON added to prevent extra result sets from
    -- interfering with SELECT statements.
    SET NOCOUNT ON
	
    -- Insert statements for procedure here
    SELECT mcd.MemberChartDataId, ProcessData
	FROM [Provider].[MemberChartData] MCD 
	where MCD.MemberChartId = @EngagementID AND PROCESSDATA != 'NULL'
	AND minorprocessid in (18,19,21,33) AND     PROVIDERID = @ProviderID 
END
CREATE PROCEDURE  [Document].[SP_GETENGAGEMENTDOCUMENTS]
(
   --EngagementId is nothing but MemberChartID   
   @EngagementID bigint,
   @ProviderID bigint,
   @MemberProfileID bigint
)
AS
BEGIN
    -- SET NOCOUNT ON added to prevent extra result sets from
    -- interfering with SELECT statements.
    SET NOCOUNT ON	
	 SELECT			distinct		 (case when DT.DocumentExtension in ('.pdf','pdf','.docx','docx','doc','doc') then null else DO.DocumentObject end) as																	DocumentObject,
								  MC.MemberChartId as EngagementId, 
                                  MCD.MemberChartDataId, 
                                  DT.DocumentID, 
                                  isnull(DM.DocumentMasterID, 0) as DocumentMasterID, 
                                  DT.DocumentName as    TransactionDocumentName, 								  
                                  DT.DocumentName as MasterDocumentName,                                  
                                  DT.IsActive As DocStatus,                                   
                                  MCD.IsDocumentComplete, 
                                  MC.MemberProfileID, 
                                  MCD.ProviderID,
                                  MCD.MajorProcessID,
                                  MCD.MinorProcessID,
                                  MA.MemberAppointmentID,                               
                                  MA.HCPUserProfileId,
                                  MA.StartDate, 
                                  MA.StartTime, 
                                  MA.EndDate, 
                                  MA.EndTime,
                                  MA.AppointmentStatus,
                                  MAP.MajorProcessName,
                                  MIP.MinorProcessName,
								  DT.CreateUser as DocumentUploadedby,
                                  DT.CreateUser as CreateUser,
								  DT.CreateDate as CreateDate,
								  null as ModifyUser,
								  getdate() as ModifyDate,
                                  DT.DocumentStatus,
                                  DT.DocumentComments,
                                  DT.DocumentVersion,
                                  DL.DocumentLookUpName,
								  DT.DocumentTypecode,
								  MC.MemberChartId,								  
								  DocProcessID
FROM							  DOCUMENT.DOCUMENTTRANSACTION DT
INNER JOIN DOCUMENT.DOCUMENTOBJECT DO ON DO.DOCUMENTOBJECTID = DT.DOCUMENTOBJECTID
INNER JOIN PROVIDER.MEMBERCHARTS MC ON MC.MEMBERCHARTID = DT.MEMBERCHARTID
LEFT JOIN PROVIDER.MEMBERCHARTDATA MCD ON MCD.MEMBERCHARTDATAID = DT.MEMBERCHARTDATAID
LEFT JOIN DOCUMENT.DOCUMENTMASTER DM ON DM.DOCUMENTMASTERID = DT.DOCUMENTMASTERID
LEFT JOIN [Provider].[MajorProcess] MAP on MAP.MajorProcessID =  MCD.MajorProcessID
LEFT JOIN [Provider].[MinorProcess] MIP on MIP.MinorProcessID = MCD.MinorProcessID 
LEFT JOIN [document].[DocumentLookUp] DL on DL.DocumentLookUpCode = DT.DocumentTypeCode
LEFT JOIN [Provider].[MemberAppointments] MA on MA.MemberChartDataID= MCD.MemberChartDataID
where MC.MemberChartId = @EngagementID  and MCD.ProviderId = @ProviderID and DT.DocumentExtension not in ('html', '.html')
END
CREATE PROCEDURE [Document].[SP_GetHippaTemplateDetails]
(
    -- Add the parameters for the stored procedure here
  @NHMemberId nvarchar(20)
)
AS
BEGIN
    -- SET NOCOUNT ON added to prevent extra result sets from
    -- interfering with SELECT statements.
    SET NOCOUNT ON
	Declare @DocumentId bigint = 0
	Declare @IRTS bit = 0
	Declare @CBA bit = 0
	Declare @Others bit = 0
   SELECT 
		   @DocumentId as DocumentId,
		   'dn' as DocumentName,
           'code' as DocumentTypeCode,
			getdate() as AckDate, 
			FirstName + ' '+ LastName as MemberNamePrinted, 
			null as MemberSignature,   
			null as MemberRepresentativeSignature,
			CaregiverFirstName + '' + CaregiverLastName as MemberRepresentativeName,
			CaregiverRelationship as RelationShipToMember,
			@IRTS as IndividualRefusedToSign,
			@CBA as CommunicationBarriersAcknowledgement,
			@Others as Others,
			null as OthersReason
   FROM PROVIDER.MEMBERPROFILES
   WHERE NHMemberId = @NHMemberId
    
END
CREATE PROCEDURE [Document].[GetHAPurchaseAgreement]
(
    -- Add the parameters for the stored procedure here
    @NHMemberId nvarchar(20),
	@OrderId bigint	
)
AS
BEGIN
    -- SET NOCOUNT ON added to prevent extra result sets from
    -- interfering with SELECT statements.
    SET NOCOUNT ON	   
	Declare @DocumentName nvarchar(100) = null
	Declare @DocTypeCode nvarchar(100) = null
	Declare @InsuranceOrPlanBenefit int = 0
				 

  IF(@OrderId > 0)
  BEGIN
   SELECT	
				JSON_VALUE(OO.ShippingData, '$.providerBusinessName') AS LegalBusinessName,
				JSON_VALUE(OO.ShippingData, '$.dispenser') AS DispenserOrAccountNo,
				OO.NHMemberId,	
				OI.OrderItemId as DocumentId,
				@DocumentName as DocumentName,
				@DocTypeCode as DocumentTypeCode,								
				getdate() as PurchaseDate,
				isnull(JSON_VALUE(MemberData, '$.firstName'),'') +' '+ isnull(JSON_VALUE(MemberData, '$.middleName'), '') +' '+ isnull(JSON_VALUE(MemberData, '$.lastName'),'') as ByerName,
				cast(JSON_VALUE(OO.MemberData, '$.phoneNumber') as bigint) as InsuredPhone,
				(JSON_VALUE(OO.MemberData, '$.address.address')) as StreetAddress,
				(JSON_VALUE(OO.MemberData, '$.address.city')) as City,
				(JSON_VALUE(OO.MemberData, '$.address.state')) as [State],
				(JSON_VALUE(OO.MemberData, '$.address.zip')) as Zip,	
				CB.BrandName as Manufacturer,
				OI.ProductModelCode as Model,
				null as Circuit,								
				(JSON_VALUE(OI.ItemData, '$.color')) as Color,				
				null as SerialNo,	
				(JSON_VALUE(OI.ItemData, '$.batterySize')) as Battery,
				(JSON_VALUE(OI.ItemData, '$.receiverSize')) as Receiver,	
				cast((JSON_VALUE(OO.OrderAmountData, '$.unitPrice')) as decimal) as Price,
				cast((JSON_VALUE(OO.OrderAmountData, '$.pairPrice')) as decimal) as PurchasePrice,	
				cast(isnull(JSON_VALUE(OO.OrderAmountData, '$.insuranceBenefit'), 0) as decimal) as InsuranceOrPlanBenefit,			    
				null as PatientSignature,				
				getdate() as PurchaseSignatureDate,				
				getdate() as HCPSignatureMedicalWaiverDate,
				JSON_VALUE(OO.ProviderData, '$.hcp.firstName') + ' ' + JSON_VALUE(OO.ProviderData, '$.hcp.lastName')   AS MedicalHCPName,
			    JSON_VALUE(OO.ShippingData, '$.dispenser') as MedicalHCPLicenceNo,				
				--json_value(Ordertransactiondata, '$.receivedDate') as ExecutedOrDelivered,	-- fitting date
				json_value(Ordertransactiondata, '$.fittingDate') as ExecutedOrDelivered,	-- fitting date
				isnull(JSON_VALUE(OO.MemberData, '$.firstName'),'') +' '+ isnull(JSON_VALUE(OO.MemberData, '$.middleName'), '') +' '+ isnull(JSON_VALUE(OO.MemberData, '$.lastName'),'') as BuyersFullName,	
				isnull(CAST((JSON_VALUE(MemberData, '$.phoneNumber')) AS BIGINT), 0) as BuyersTelephone,				
				(JSON_VALUE(OO.MemberData, '$.address.address')) as BuyerStreetAddressOne,				
				(JSON_VALUE(OO.MemberData, '$.address.city')) as BuyerCity,
				(JSON_VALUE(OO.MemberData, '$.address.state')) as BuyerState,
				(JSON_VALUE(OO.MemberData, '$.address.zip')) as BuyerZip,	
				isnull(JSON_VALUE(OO.ProviderData, '$.hcp.firstName'),'') + ' ' + isnull(JSON_VALUE(OO.ProviderData, '$.hcp.lastName'),'')   AS DeliveryHcpName,				
				getdate() as HCPDRSignatureDate,
				JSON_VALUE(OO.ShippingData, '$.dispenser') as HCPDRLicenceNo,
				isnull(JSON_VALUE(OO.ShippingData, '$.address.address1'),'') + ' ' + isnull(JSON_VALUE(OO.ShippingData, '$.address.address2'),'') + ',' + isnull(JSON_VALUE(OO.ShippingData, '$.address.city'),'') + ',' + isnull(JSON_VALUE(OO.ShippingData, '$.address.state'),'') + ',' + isnull(JSON_VALUE(OO.ShippingData, '$.address.zip'),'') + ',' + isnull(JSON_VALUE(OO.ShippingData, '$.address.county'),'')+ ',' + isnull(JSON_VALUE(OO.ShippingData, '$.address.country'),'')  AS DeliveryHCPAddress,		
				getdate() as WarrantyMemberSignatureDate,				
				getdate() as WarrantyHCPSignatureDate,			    
				JSON_VALUE(OO.ShippingData, '$.dispenser') as WarrantyHCPLincenseNo,
				OI.Modifier, 
				OO.OrderId, 
				OO.MemberChartDataId,			
				null as BuyerStreetAddressTwo				 				
   from			[Orders].[Orders] OO 
   left join	[Orders].[OrderTransactionDetails] OTD on OTD.OrderId = OO.OrderId and OTD.OrderStatusCode in ('SHI', 'CLM') and OTD.IsActive = 1
   Inner Join	[Orders].[OrderItems] OI On OO.OrderId = OI.OrderId and OI.IsActive = 1
   inner join   [Catalog].[Brands] CB on CB.BrandCode = OI.BrandCode and CB.IsActive = 1
   inner join   [Provider].[MemberProfiles] MP on MP.NHMemberId = OO.NHMemberId and MP.IsActive = 1  
   left join	[Accounts].[Invoices] I on I.OrderId = OI.OrderId and I.IsActive =1
   left join    [Accounts].[InvoiceItems] II on II.InvoiceId = I.invoiceId and II.IsActive =1
   Where		OO.NHMemberId = @NHMemberId and OO.OrderId = @OrderId and OO.IsActive = 1  
   And			OI.ItemType = 'HA' 
   And			OO.OrderStatusCode not in ('INI', 'CAN', 'RET')
   --And			OI.PONumber > 0   
   END
   ELSE IF (@OrderId <= 0)
   BEGIN
        Declare @OrderNumber bigint = 0
		Set @OrderNumber = (SELECT TOP 1 ORDERID FROM ORDERS.ORDERS 
							WHERE ORDERSTATUSCODE NOT IN ('INI', 'CAN', 'RET') AND NHMEMBERID =  @NHMemberId 
							 ORDER BY MODIFYDATE DESC)
		 
		IF (@OrderNumber >= 0)		
		BEGIN			
				Select	
						JSON_VALUE(OO.ShippingData, '$.providerBusinessName') AS LegalBusinessName,
				JSON_VALUE(OO.ShippingData, '$.dispenser') AS DispenserOrAccountNo,
				OO.NHMemberId,	
				OI.OrderItemId as DocumentId,
				@DocumentName as DocumentName,
				@DocTypeCode as DocumentTypeCode,								
				getdate() as PurchaseDate,
				isnull(JSON_VALUE(MemberData, '$.firstName'),'') +' '+ isnull(JSON_VALUE(MemberData, '$.middleName'), '') +' '+ isnull(JSON_VALUE(MemberData, '$.lastName'),'') as ByerName,
				cast(JSON_VALUE(OO.MemberData, '$.phoneNumber') as bigint) as InsuredPhone,
				(JSON_VALUE(OO.MemberData, '$.address.address')) as StreetAddress,
				(JSON_VALUE(OO.MemberData, '$.address.city')) as City,
				(JSON_VALUE(OO.MemberData, '$.address.state')) as [State],
				(JSON_VALUE(OO.MemberData, '$.address.zip')) as Zip,	
				CB.BrandName as Manufacturer,
				OI.ProductModelCode as Model,
				null as Circuit,								
				(JSON_VALUE(OI.ItemData, '$.color')) as Color,				
				null as SerialNo,	
				(JSON_VALUE(OI.ItemData, '$.batterySize')) as Battery,
				(JSON_VALUE(OI.ItemData, '$.receiverSize')) as Receiver,	
				cast((JSON_VALUE(OO.OrderAmountData, '$.unitPrice')) as decimal) as Price,
				cast((JSON_VALUE(OO.OrderAmountData, '$.pairPrice')) as decimal) as PurchasePrice,	
				cast(isnull(JSON_VALUE(OO.OrderAmountData, '$.insuranceBenefit'), 0) as decimal) as InsuranceOrPlanBenefit,			    
				null as PatientSignature,				
				getdate() as PurchaseSignatureDate,				
				getdate() as HCPSignatureMedicalWaiverDate,
				JSON_VALUE(OO.ProviderData, '$.hcp.firstName') + ' ' + JSON_VALUE(OO.ProviderData, '$.hcp.lastName')   AS MedicalHCPName,
			    JSON_VALUE(OO.ShippingData, '$.dispenser') as MedicalHCPLicenceNo,				
				--json_value(Ordertransactiondata, '$.receivedDate') as ExecutedOrDelivered,	-- fitting date
				json_value(Ordertransactiondata, '$.fittingDate') as ExecutedOrDelivered,	-- fitting date
				isnull(JSON_VALUE(OO.MemberData, '$.firstName'),'') +' '+ isnull(JSON_VALUE(OO.MemberData, '$.middleName'), '') +' '+ isnull(JSON_VALUE(OO.MemberData, '$.lastName'),'') as BuyersFullName,	
				isnull(CAST((JSON_VALUE(MemberData, '$.phoneNumber')) AS BIGINT), 0) as BuyersTelephone,				
				(JSON_VALUE(OO.MemberData, '$.address.address')) as BuyerStreetAddressOne,				
				(JSON_VALUE(OO.MemberData, '$.address.city')) as BuyerCity,
				(JSON_VALUE(OO.MemberData, '$.address.state')) as BuyerState,
				(JSON_VALUE(OO.MemberData, '$.address.zip')) as BuyerZip,	
				isnull(JSON_VALUE(OO.ProviderData, '$.hcp.firstName'),'') + ' ' + isnull(JSON_VALUE(OO.ProviderData, '$.hcp.lastName'),'')   AS DeliveryHcpName,				
				getdate() as HCPDRSignatureDate,
				JSON_VALUE(OO.ShippingData, '$.dispenser') as HCPDRLicenceNo,
				isnull(JSON_VALUE(OO.ShippingData, '$.address.address1'),'') + ' ' + isnull(JSON_VALUE(OO.ShippingData, '$.address.address2'),'') + ',' + isnull(JSON_VALUE(OO.ShippingData, '$.address.city'),'') + ',' + isnull(JSON_VALUE(OO.ShippingData, '$.address.state'),'') + ',' + isnull(JSON_VALUE(OO.ShippingData, '$.address.zip'),'') + ',' + isnull(JSON_VALUE(OO.ShippingData, '$.address.county'),'')+ ',' + isnull(JSON_VALUE(OO.ShippingData, '$.address.country'),'')  AS DeliveryHCPAddress,		
				getdate() as WarrantyMemberSignatureDate,				
				getdate() as WarrantyHCPSignatureDate,			    
				JSON_VALUE(OO.ShippingData, '$.dispenser') as WarrantyHCPLincenseNo,
				OI.Modifier, 
				OO.OrderId, 
				OO.MemberChartDataId,			
				null as BuyerStreetAddressTwo					 			 				
		   from			[Orders].[Orders] OO 
		   left join	[Orders].[OrderTransactionDetails] OTD on OTD.OrderId = OO.OrderId and OTD.OrderStatusCode = 'SHI' and OTD.IsActive = 1
		   Inner Join	[Orders].[OrderItems] OI On OO.OrderId = OI.OrderId and OI.IsActive = 1
		   inner join   [Catalog].[Brands] CB on CB.BrandCode = OI.BrandCode and CB.IsActive = 1
		   inner join   [Provider].[MemberProfiles] MP on MP.NHMemberId = OO.NHMemberId and MP.IsActive = 1  
		   left join	[Accounts].[Invoices] I on I.OrderId = OI.OrderId and I.IsActive =1
		   left join    [Accounts].[InvoiceItems] II on II.InvoiceId = I.invoiceId and II.IsActive =1
		   Where		OO.NHMemberId = @NHMemberId and OO.OrderId = @OrderNumber and OO.IsActive = 1  
		   And			OI.ItemType = 'HA' 
		   And			OO.OrderStatusCode not in ('INI', 'CAN', 'RET')
   --And			OI.PONumber > 0   
   END
   END
END
CREATE PROCEDURE [Document].[GetDocumentOrdersList]
(
    -- Add the parameters for the stored procedure here
    @EngagementID bigint,
    @ProviderID bigint,
	@MemberProfileID bigint
)
AS
BEGIN
    -- SET NOCOUNT ON added to prevent extra result sets from
    -- interfering with SELECT statements.
    SET NOCOUNT ON

    -- Insert statements for procedure here
    SELECT cast(json_value(ProcessData, '$.orderId') as bigint) as OrderId, Status as OrderStatus, 
	(case when OO.OrderStatusCode not in ('INI', 'PAY', 'APQ', 'CAN', 'RET', 'REI') THEN 'APP' else OO.OrderStatusCode END ) as OrderStatusCode,
	NHMemberId, MemberChartId
	FROM [Provider].[MemberChartData] MCD 
	inner join Orders.Orders OO on OO.MemberChartDataId = MCD.MemberChartDataid 	
	 where MCD.MemberChartId = @EngagementID AND PROCESSDATA != 'NULL'
	AND minorprocessid in (23) AND     PROVIDERID = @ProviderID  
	
END
CREATE PROCEDURE [Document].[SP_GetProviderAndLocationDetails]
(
    -- Add the parameters for the stored procedure here
   @NHMemberId varchar(20)
)
AS
BEGIN
    -- SET NOCOUNT ON added to prevent extra result sets from
    -- interfering with SELECT statements.
    SET NOCOUNT ON
    -- Insert statements for procedure here
	Declare @OrderId bigint = 0;
	select  MP.MemberProfileId, 
					MCD.ProviderId, 
					PP.ProviderName, 
					MCD.LocationId,
					MCD.Createdate,
					@OrderId as OrderId
	from			provider.memberprofiles MP
	inner join		provider.membercharts MC on MC.MemberProfileId = MP.MemberProfileId
	inner join		provider.memberchartdata MCD on MCD.MemberChartId = MC.MemberChartId
	inner join		provider.ProviderProfiles PP on PP.ProviderId = MCD.ProviderId
	where			nhmemberid = @NHMemberId  AND PP.IsActive=1 AND MCD.IsActive=1 AND MC.IsActive=1 AND MP.IsActive=1 order by MCD.CreateDate desc  
END
CREATE PROCEDURE [Document].[SP_GetDocListBasedOnOrder]
(
    -- Add the parameters for the stored procedure here
    @MemberChartId bigint,
	@OrderId bigint
)
AS
BEGIN
    -- SET NOCOUNT ON added to prevent extra result sets from
    -- interfering with SELECT statements.
    SET NOCOUNT ON

    -- Insert statements for procedure here
  Select cast(a.DocumentId as bigint) as DocumentId, cast(a.OrderId as bigint) as OrderId into #Temp4 from(select json_value(ProcessData,'$[0].documentId') as DocumentId, json_value(ProcessData,'$[0].orderId') as OrderId  from Provider.MemberChartData where MemberChartId = @MemberChartId 
and json_value(ProcessData,'$[0].documentId') is not null and json_value(ProcessData,'$[0].orderId') != 0
union
select json_value(ProcessData,'$[1].documentId') as DocId, json_value(ProcessData,'$[1].orderId') as OrderId from Provider.MemberChartData where MemberChartId = @MemberChartId
and json_value(ProcessData,'$[1].documentId') is not null and json_value(ProcessData,'$[1].orderId') != 0
union
select json_value(ProcessData,'$[2].documentId') as DocId, json_value(ProcessData,'$[2].orderId') as OrderId from Provider.MemberChartData where MemberChartId = @MemberChartId
and json_value(ProcessData,'$[2].documentId') is not null and json_value(ProcessData,'$[2].orderId') != 0
union
select json_value(ProcessData,'$[3].documentId') as DocId, json_value(ProcessData,'$[3].orderId') as OrderId from Provider.MemberChartData where MemberChartId = @MemberChartId
and json_value(ProcessData,'$[3].documentId') is not null and json_value(ProcessData,'$[3].orderId') != 0
union
select json_value(ProcessData,'$[4].documentId') as DocId, json_value(ProcessData,'$[4].orderId') as OrderId from Provider.MemberChartData where MemberChartId = @MemberChartId
and json_value(ProcessData,'$[4].documentId') is not null and json_value(ProcessData,'$[4].orderId') != 0
union
select json_value(ProcessData,'$[5].documentId') as DocId, json_value(ProcessData,'$[5].orderId') as OrderId from Provider.MemberChartData where MemberChartId = @MemberChartId
and json_value(ProcessData,'$[5].documentId') is not null and json_value(ProcessData,'$[5].orderId') != 0
union
select json_value(ProcessData,'$[6].documentId') as DocId, json_value(ProcessData,'$[6].orderId') as OrderId from Provider.MemberChartData where MemberChartId = @MemberChartId
and json_value(ProcessData,'$[6].documentId') is not null and json_value(ProcessData,'$[6].orderId') != 0
union
select json_value(ProcessData,'$[7].documentId') as DocId, json_value(ProcessData,'$[7].orderId') as OrderId from Provider.MemberChartData where MemberChartId = @MemberChartId
and json_value(ProcessData,'$[7].documentId') is not null and json_value(ProcessData,'$[7].orderId') != 0
union
select json_value(ProcessData,'$[8].documentId') as DocId, json_value(ProcessData,'$[8].orderId') as OrderId from Provider.MemberChartData where MemberChartId = @MemberChartId
and json_value(ProcessData,'$[8].documentId') is not null and json_value(ProcessData,'$[8].orderId') != 0
union
select json_value(ProcessData,'$[9].documentId') as DocId, json_value(ProcessData,'$[9].orderId') as OrderId from Provider.MemberChartData where MemberChartId = @MemberChartId
and json_value(ProcessData,'$[9].documentId') is not null and json_value(ProcessData,'$[9].orderId') != 0
union
select json_value(ProcessData,'$[10].documentId') as DocId, json_value(ProcessData,'$[10].orderId') as OrderId from Provider.MemberChartData where MemberChartId = @MemberChartId
and json_value(ProcessData,'$[10].documentId') is not null and json_value(ProcessData,'$[10].orderId') != 0
union
select json_value(ProcessData,'$[11].documentId') as DocId, json_value(ProcessData,'$[11].orderId') as OrderId from Provider.MemberChartData where MemberChartId = @MemberChartId
and json_value(ProcessData,'$[11].documentId') is not null and json_value(ProcessData,'$[11].orderId') != 0
union
select json_value(ProcessData,'$[12].documentId') as DocId, json_value(ProcessData,'$[12].orderId') as OrderId from Provider.MemberChartData where MemberChartId = @MemberChartId
and json_value(ProcessData,'$[12].documentId') is not null and json_value(ProcessData,'$[12].orderId') != 0
union
select json_value(ProcessData,'$[13].documentId') as DocId, json_value(ProcessData,'$[13].orderId') as OrderId from Provider.MemberChartData where MemberChartId = @MemberChartId
and json_value(ProcessData,'$[13].documentId') is not null and json_value(ProcessData,'$[13].orderId') != 0
union
select json_value(ProcessData,'$[14].documentId') as DocId, json_value(ProcessData,'$[14].orderId') as OrderId from Provider.MemberChartData where MemberChartId = @MemberChartId
and json_value(ProcessData,'$[14].documentId') is not null and json_value(ProcessData,'$[14].orderId') != 0
union
select json_value(ProcessData,'$[15].documentId') as DocId, json_value(ProcessData,'$[15].orderId') as OrderId from Provider.MemberChartData where MemberChartId = @MemberChartId
and json_value(ProcessData,'$[15].documentId') is not null and json_value(ProcessData,'$[15].orderId') != 0
union
select json_value(ProcessData,'$[16].documentId') as DocId, json_value(ProcessData,'$[16].orderId') as OrderId from Provider.MemberChartData where MemberChartId = @MemberChartId
and json_value(ProcessData,'$[16].documentId') is not null and json_value(ProcessData,'$[16].orderId') != 0
union
select json_value(ProcessData,'$[17].documentId') as DocId, json_value(ProcessData,'$[17].orderId') as OrderId from Provider.MemberChartData where MemberChartId = @MemberChartId
and json_value(ProcessData,'$[17].documentId') is not null and json_value(ProcessData,'$[17].orderId') != 0
union
select json_value(ProcessData,'$[18].documentId') as DocId, json_value(ProcessData,'$[18].orderId') as OrderId from Provider.MemberChartData where MemberChartId = @MemberChartId
and json_value(ProcessData,'$[18].documentId') is not null and json_value(ProcessData,'$[18].orderId') != 0
union
select json_value(ProcessData,'$[19].documentId') as DocId, json_value(ProcessData,'$[19].orderId') as OrderId from Provider.MemberChartData where MemberChartId = @MemberChartId
and json_value(ProcessData,'$[19].documentId') is not null and json_value(ProcessData,'$[19].orderId') != 0
union
select json_value(ProcessData,'$[20].documentId') as DocId, json_value(ProcessData,'$[20].orderId') as OrderId from Provider.MemberChartData where MemberChartId = @MemberChartId
and json_value(ProcessData,'$[20].documentId') is not null and json_value(ProcessData,'$[20].orderId') != 0
union
select json_value(ProcessData,'$[21].documentId') as DocId, json_value(ProcessData,'$[21].orderId') as OrderId from Provider.MemberChartData where MemberChartId = @MemberChartId
and json_value(ProcessData,'$[21].documentId') is not null and json_value(ProcessData,'$[21].orderId') != 0
union
select json_value(ProcessData,'$[22].documentId') as DocId, json_value(ProcessData,'$[22].orderId') as OrderId from Provider.MemberChartData where MemberChartId = @MemberChartId
and json_value(ProcessData,'$[22].documentId') is not null and json_value(ProcessData,'$[22].orderId') != 0
union
select json_value(ProcessData,'$[23].documentId') as DocId, json_value(ProcessData,'$[23].orderId') as OrderId from Provider.MemberChartData where MemberChartId = @MemberChartId
and json_value(ProcessData,'$[23].documentId') is not null and json_value(ProcessData,'$[23].orderId') != 0
union
select json_value(ProcessData,'$[24].documentId') as DocId, json_value(ProcessData,'$[24].orderId') as OrderId from Provider.MemberChartData where MemberChartId = @MemberChartId
and json_value(ProcessData,'$[24].documentId') is not null and json_value(ProcessData,'$[24].orderId') != 0
union
select json_value(ProcessData,'$[25].documentId') as DocId, json_value(ProcessData,'$[25].orderId') as OrderId from Provider.MemberChartData where MemberChartId = @MemberChartId
and json_value(ProcessData,'$[25].documentId') is not null and json_value(ProcessData,'$[25].orderId') != 0
union
select json_value(ProcessData,'$[26].documentId') as DocId, json_value(ProcessData,'$[26].orderId') as OrderId from Provider.MemberChartData where MemberChartId = @MemberChartId
and json_value(ProcessData,'$[26].documentId') is not null and json_value(ProcessData,'$[26].orderId') != 0
union
select json_value(ProcessData,'$[27].documentId') as DocId, json_value(ProcessData,'$[27].orderId') as OrderId from Provider.MemberChartData where MemberChartId = @MemberChartId
and json_value(ProcessData,'$[27].documentId') is not null and json_value(ProcessData,'$[27].orderId') != 0
union
select json_value(ProcessData,'$[28].documentId') as DocId, json_value(ProcessData,'$[28].orderId') as OrderId from Provider.MemberChartData where MemberChartId = @MemberChartId
and json_value(ProcessData,'$[28].documentId') is not null and json_value(ProcessData,'$[28].orderId') != 0
union
select json_value(ProcessData,'$[29].documentId') as DocId, json_value(ProcessData,'$[29].orderId') as OrderId from Provider.MemberChartData where MemberChartId = @MemberChartId
and json_value(ProcessData,'$[29].documentId') is not null and json_value(ProcessData,'$[29].orderId') != 0
union
select json_value(ProcessData,'$[30].documentId') as DocId, json_value(ProcessData,'$[30].orderId') as OrderId from Provider.MemberChartData where MemberChartId = @MemberChartId
and json_value(ProcessData,'$[30].documentId') is not null and json_value(ProcessData,'$[30].orderId') != 0
union
select json_value(ProcessData,'$[31].documentId') as DocId, json_value(ProcessData,'$[31].orderId') as OrderId from Provider.MemberChartData where MemberChartId = @MemberChartId
and json_value(ProcessData,'$[31].documentId') is not null and json_value(ProcessData,'$[31].orderId') != 0
union
select json_value(ProcessData,'$[32].documentId') as DocId, json_value(ProcessData,'$[32].orderId') as OrderId from Provider.MemberChartData where MemberChartId = @MemberChartId
and json_value(ProcessData,'$[32].documentId') is not null and json_value(ProcessData,'$[32].orderId') != 0
union
select json_value(ProcessData,'$[33].documentId') as DocId, json_value(ProcessData,'$[33].orderId') as OrderId from Provider.MemberChartData where MemberChartId = @MemberChartId
and json_value(ProcessData,'$[33].documentId') is not null and json_value(ProcessData,'$[33].orderId') != 0
union
select json_value(ProcessData,'$[34].documentId') as DocId, json_value(ProcessData,'$[34].orderId') as OrderId from Provider.MemberChartData where MemberChartId = @MemberChartId
and json_value(ProcessData,'$[34].documentId') is not null and json_value(ProcessData,'$[34].orderId') != 0 )a 
Select * from #Temp4 where OrderId = @OrderId
END
CREATE PROCEDURE [Document].[SP_GetAOBTemplateDetails]
    -- Add the parameters for the stored procedure here
       @NHMemberId nvarchar(20)
AS
BEGIN
    -- SET NOCOUNT ON added to prevent extra result sets from
    -- interfering with SELECT statements.
    SET NOCOUNT ON
       Declare @DocumentId bigint = 0    
   -- Insert statements for procedure here
     SELECT PMP.FirstName + ' '+ PMP.LastName AS NameOfInsured, MP.PhoneNumber as Phone,   
  PMP.DateOfBirth  as DOB, 
 @DocumentId  AS DocumentId, 'dn' as DocumentName,  'code' as DocumentTypeCode, null as SignatureOfInsured, PMP.FirstName + ' '+ PMP.LastName AS PrintNameOfInsured, getdate() as SignatureDate  FROM [provider].[MemberProfiles] PMP
       LEFT JOIN [provider].[MemberPhoneNumbers] MP ON MP.MemberProfileId = PMP.MemberProfileId
       WHERE PMP.NHMemberid = @NHMemberId
END


-- EXEC [ELIG].[elig_file_load_ssis_sp_merge_elig_HAP_to_master] 

CREATE PROCEDURE [elig].[elig_file_load_ssis_sp_merge_elig_HAP_to_master]


AS

BEGIN


	--BEGIN TRY
	--BEGIN TRANSACTION member_load_elig_to_master_HAP

DECLARE @sys_user CHAR(30)
	   ,@sys_date DATETIME;  

SET @sys_user = SYSTEM_USER
--SET @sys_date = CAST(GETDATE() AS DATE);  
SET @sys_date = CAST(GETDATE() AT TIME ZONE 'UTC' AT TIME ZONE 'Eastern Standard Time' AS DATETIME);  -- Time in EST



	-- drop not null record insert constraint (unique index) on NHMemberID in master.members before inserting new members or updating NHMemberID for new records inserted

		ALTER TABLE [otc].[Cards] DROP CONSTRAINT [FK_Cards_NHMemberId]

		ALTER TABLE [Master].[Members] DROP CONSTRAINT [IX_Members_NHMemberID_U]


		MERGE Master.Members d
              USING ( SELECT distinct * FROM [ELIG].[Members] WHERE  DataSource='ELIG_HAP' AND ToBeProcessed = 'Y' and isActive=1 AND StatusFlag in ('N','U')) s
              ON (d.memberid = s.mastermemberid and d.datasource='ELIG_HAP')

              WHEN MATCHED THEN
                                                                               
              UPDATE SET
              d.EligFile = 'ELIG_HAP',
              d.eligFileID = s.ID,
              d.DateOfBirth = s.[DOB],
              d.FirstName = s.FirstName,
              d.Gender = s.Gender,
              d.IsActive = 1,
              d.LastName = s.LastName,
              d.MiddleInitial = s.MiddleName,
              d.ModifyDate = @sys_date,
              d.ModifyUser = @sys_user

              WHEN NOT MATCHED THEN

              INSERT ( 
					  CreateDate,
                      CreateUser,
                      DataSource,
                      DateOfBirth,
                      FirstName,
                      Gender,
                      IsActive,
                      LastName,
                      MiddleInitial,
                      ModifyDate,
                      ModifyUser,
                      EligFile,
                      EligFileID)  
                      VALUES 
                      (
                      @sys_date
              ,@sys_user
              ,'ELIG_HAP'
              ,DOB
              ,FirstName
              ,Gender
              ,1
              ,LastName
              ,MiddleName
              ,@sys_date
              ,@sys_user
              ,'ELIG_HAP'
              ,ID
              );



		-- Assign mastermemberid in elig.members after inserting new records into master.members
		UPDATE a 
        SET a.MasterMemberID = (SELECT distinct memberid FROM [Master].[Members] m where m.EligFileID = a.id and m.EligFile = 'ELIG_HAP' and m.IsActive=1)
        FROM [ELIG].[Members] a
        WHERE 1=1
		AND a.isActive = 1
		AND a.tobeprocessed = 'Y'                                                     
        AND a.mastermemberid IS NULL
		and a.Datasource = 'ELIG_HAP'



		-- Update NHMemberID for newly inserted members
		UPDATE [Master].[Members]
		SET nhmemberid = 'NH'+RIGHT(YEAR(GETDATE()),4)+ FORMAT(memberid,'00000000')							 --    'NH2018'+ FORMAT(memberid,'00000000')
		WHERE EligFile = 'ELIG_HAP'
		AND nhmemberid IS NULL

		-- Re create the unique NHMemberID index
		ALTER TABLE [Master].[Members] ADD  CONSTRAINT [IX_Members_NHMemberID_U] UNIQUE NONCLUSTERED 
		(
			[NHMemberID] ASC
		)


		ALTER TABLE [otc].[Cards]  ADD  CONSTRAINT [FK_Cards_NHMemberId] FOREIGN KEY
		(
			[NHMemberId]
		)
		REFERENCES [Master].[Members] ([NHMemberID])
		

		update a 
		set a.mastermemberid  =  m.mastermemberid 
		-- select a.mastermemberid  ,  m.mastermemberid 
		from ELIG.insurances a
		join ELIG.members m on (m.NHLinkID=a.NHLinkID and m.DataSource='ELIG_HAP'  and m.IsActive=1)
		where 1=1
		and a.DataSource='ELIG_HAP'
		and a.IsActive=1

		update a 
		set a.mastermemberid  =  m.mastermemberid 
		-- select a.mastermemberid  ,  m.mastermemberid 
		from ELIG.AddressInfo a
		join elig.members m on (m.NHLinkID=a.NHLinkID and m.DataSource='ELIG_HAP'  and m.IsActive=1)
		where 1=1
		and a.DataSource='ELIG_HAP'
		and a.IsActive=1


	 
		-- 
		MERGE Master.addresses d
              USING (select * FROM (
									SELECT distinct id,AddressLine1,AddressLine2,City,State,ZipCode,RecordEffectiveDate,RecordEndDate,mastermemberid,RANK() over (partition by mastermemberid order by id desc) as addrank
									FROM ELIG.AddressInfo 
									WHERE tobeprocessed = 'Y' 
									AND StatusFlag in ('N','U') 
									and IsActive=1 
									and mastermemberid is not null
									and mastermemberid in (select memberid from master.Members where DataSource='ELIG_HAP')
									and DataSource='ELIG_HAP'
									) a
									where a.addrank=1) s
              ON (d.memberid = s.mastermemberid AND d.AddressTypeCode = 'PERM')
              WHEN MATCHED THEN
              UPDATE SET
              Address1 = s.[AddressLine1]
              ,Address2 = s.[AddressLine2]
              ,City = s.[City]
              ,State = s.[State]
              ,ZipCode = s.[ZipCode]
              ,EffectiveFromDate = [RecordEffectiveDate]
              ,EffectiveToDate = [RecordEndDate]
              ,IsActive = 1
              ,IsPreferredAddress = 1
              ,MemberID = s.mastermemberid
              ,ModifyDate = @sys_date
              , ModifyUser = @sys_user
              WHEN NOT MATCHED THEN
              INSERT (
              Address1
              ,Address2
              ,AddressTypeCode
              ,City
              ,State
              ,ZipCode
              ,EffectiveFromDate
              ,EffectiveToDate
              ,IsActive
              ,IsPreferredAddress
              ,MemberID
              ,CreateDate
              ,CreateUser
              ,ModifyDate
              , ModifyUser
              )
              VALUES(
              s.[AddressLine1]
              ,s.[AddressLine2]
              ,'PERM'
              ,s.[City]
              ,s.[State]
              ,s.[ZipCode]
              , [RecordEffectiveDate]
              , [RecordEndDate]
              ,1 
              ,1 
              ,s.[mastermemberid]
              ,@sys_date
              ,@sys_user
              ,@sys_date
              ,@sys_user);
		
		  
	
              MERGE Master.PhoneNumbers d
              USING (select * FROM
								(
								SELECT distinct PrimaryPhoneNbr,RecordEffectiveDate,RecordEndDate,mastermemberid,id,RANK() over (partition by mastermemberid order by id desc) as phrank
								FROM ELIG.AddressInfo 
								WHERE tobeprocessed = 'Y' 
								AND StatusFlag in ('N','U') 
								and IsActive=1 
								and mastermemberid is not null
								and mastermemberid in (select memberid from master.Members where DataSource='ELIG_HAP')
								and DataSource='ELIG_HAP'
								) a
								where a.phrank=1) s
              ON (d.memberid = s.mastermemberid) --AND d.PhoneTypeCode = 'HOME')
              WHEN MATCHED THEN
              UPDATE SET
              CountryCode = '001'
              ,PhoneNbr = s.PrimaryPhoneNbr
              ,EffectiveFromDate = [RecordEffectiveDate]
              ,EffectiveToDate = [RecordEndDate]
              , IsActive = 1
              ,MemberID = s.mastermemberid
              , ModifyDate = @sys_date
              , ModifyUser = @sys_user
              WHEN NOT MATCHED THEN
              INSERT (
              CountryCode
              ,PhoneNbr
              , PhoneTypeCode
              , EffectiveFromDate
              ,EffectiveToDate
              , IsActive
              ,IsPreferredPhoneNumber
              ,MemberID
              ,CreateDate
              , CreateUser
              , ModifyDate
              , ModifyUser
              )
              VALUES ( 
              '001' 
              ,s.PrimaryPhoneNbr
              ,'HOME' 
              ,[RecordEffectiveDate]
              , [RecordEndDate]
              ,1 
              ,0 
              ,s.[mastermemberid] 
              ,@sys_date 
              ,@sys_user
              ,@sys_date 
              ,@sys_user );
			  


			  --
			  MERGE [master].[MemberInsurances] d
              USING (select * FROM
							(
							SELECT DISTINCT id,StatusFlag,EligTerminationDate,EligEffectiveDate,mastermemberid,HealthPlanID,CarrierID,IsActive ,RANK() over (partition by mastermemberid,CarrierID,EligEffectiveDate order by id desc) as insrank
							FROM ELIG.Insurances 
							WHERE tobeprocessed = 'Y' and mastermemberid is not null
							and mastermemberid in (select memberid from master.Members where DataSource='ELIG_HAP')
							and DataSource='ELIG_HAP'
							) a
							where a.insrank=1
							) s --AND StatusFlag in ('N','U')) s
              ON (s.masterMemberId = d.MemberID and cast(s.CarrierID as bigint)=d.InsuranceCarrierID  and s.[EligEffectiveDate] = cast(d.InsuranceEffectiveDate as date))
              WHEN MATCHED THEN
              UPDATE SET
              --InsuranceEndDate = case statusflag when 'D' then cast(getdate()-1 as date) else EligibilityTerminationDate end, this will be statement for all but now exception
              InsuranceEndDate = CASE s.statusflag WHEN 'T' THEN (CASE WHEN DATEDIFF(dd, cast(d.InsuranceEndDate AS DATE), CAST(GETDATE()-1 AS DATE)) < 0 THEN CAST(GETDATE()-1 AS DATE) ELSE s.[EligTerminationDate] END  )  ELSE s.[EligTerminationDate] END,
              InsuranceHealthPlanID = s.healthplanid,
			  InsuranceCarrierID = s.CarrierID,
              --IsActive = CASE statusflag WHEN 'D' THEN 0 ELSE 1 END,
              IsActive = s.IsActive,
              ModifyDate = @sys_date,
              ModifyUser = @sys_user,
              eligFileID = s.ID,
              eligFile = 'ELIG_HAP'
              WHEN NOT MATCHED THEN
              INSERT (
              CreateDate,
              CreateUser,
              InsuranceCarrierID,
              InsuranceEffectiveDate,
              InsuranceEndDate,
              InsuranceHealthPlanID,
              IsActive,
              MemberID,
              ModifyDate,
              ModifyUser,
              eligFileID,
              eligFile)
              VALUES (
              @sys_date
              ,@sys_user
              ,s.CarrierID  -- change the value
              ,s.EligEffectiveDate 
              ,s.EligTerminationDate 
              ,s.[healthplanid] 
              ,s.IsActive 
              ,s.mastermemberid 
              ,@sys_date
              ,@sys_user,s.ID , 'ELIG_HAP');


 


 			update i
			set i.memberinsuranceid = (select max(m.id) from master.memberinsurances m 
										where m.memberid = i.mastermemberid and m.eligFileID = i.ID and m.insurancecarrierid in (212,222,223) and m.eligfile = 'ELIG_HAP')
			from ELIG.Insurances i
			where i.tobeprocessed = 'Y'
			--and memberinsuranceid is null



             --
              MERGE Master.MemberInsuranceDetails d
              USING (select * FROM
							(
							SELECT DISTINCT id,memberinsuranceid,GroupNbr,SubscriberID,IsActive ,RANK() over (partition by mastermemberid,CarrierID,EligEffectiveDate order by id desc) as insdrank
							FROM ELIG.Insurances 
							WHERE tobeprocessed = 'Y' and mastermemberid is not null
							and mastermemberid in (select memberid from master.Members where DataSource='ELIG_HAP')
							and memberinsuranceid in (select memberinsuranceid from master.MemberInsurances where DataSource='ELIG_HAP')
							and DataSource='ELIG_HAP'
							) a
							where a.insdrank=1
					) s  ON (d.MemberInsuranceID = s.memberinsuranceid )  --AND s.SubscriberID=d.InsuranceNbr)

              WHEN MATCHED THEN 

              UPDATE SET
              GroupNbr = s.GroupNbr,
              InsuranceNbr = s.subscriberID,
              IsInsuranceEligibilityVerified = 1,
              ModifyDate = @sys_date,
              ModifyUser = @sys_user,
              ISActive = s.IsActive
              WHEN NOT MATCHED THEN
              INSERT (
              CreateDate
              , CreateUser
              ,GroupNbr
              ,InsuranceNbr
              ,IsActive
              ,IsInsuranceEligibilityVerified
              ,MemberInsuranceID
              ,ModifyDate
              ,ModifyUser
              )
              VALUES ( 
              @sys_date
              ,@sys_user
              ,s.GroupNbr
              , s.subscriberID
              ,s.IsActive
              ,1
              ,s.MemberInsuranceID
              ,@sys_date
              ,@sys_user
              );




	--COMMIT TRANSACTION member_load_elig_to_master_HAP
	--PRINT 'SUCCESS'
	
	----DROP TABLE #HAP_Elig_StgExistingMembers

	--END TRY
	

	--BEGIN CATCH

	--DECLARE @ErrorMessage NVARCHAR(4000);  
 --   DECLARE @ErrorSeverity INT;  
 --   DECLARE @ErrorState INT;  

 --   SELECT   
 --       @ErrorMessage = ERROR_MESSAGE(),  
 --       @ErrorSeverity = ERROR_SEVERITY(),  
 --       @ErrorState = ERROR_STATE();  

	--	IF (@@TRANCOUNT > 0)
	--	BEGIN
	--		ROLLBACK TRANSACTION member_load_elig_to_master_HAP
	--		RAISERROR(@ErrorMessage,@ErrorSeverity,@ErrorState);
	--		PRINT 'FAILED'
	--	END

	--END CATCH;



END


-- EXEC [ELIG].[elig_file_load_ssis_sp_merge_stg_to_elig_HAP] 

CREATE PROCEDURE [elig].[elig_file_load_ssis_sp_merge_stg_to_elig_HAP]


AS

BEGIN

	--BEGIN TRY
	--BEGIN TRANSACTION member_load_stg_to_elig_HAP

	DECLARE @sys_user CHAR(30)
		   ,@sys_date DATETIME;  

	SET @sys_user = SYSTEM_USER
	--SET @sys_date = CAST(GETDATE() AS DATE);  
	SET @sys_date = CAST(GETDATE() AT TIME ZONE 'UTC' AT TIME ZONE 'Eastern Standard Time' AS DATETIME);  -- Time in EST



	UPDATE ELIG.Members SET ToBeProcessed = 'N' WHERE DataSource='ELIG_HAP' AND ToBeProcessed = 'Y' --and IsActive=1
	UPDATE ELIG.Insurances SET ToBeProcessed = 'N' WHERE DataSource='ELIG_HAP' AND ToBeProcessed = 'Y' --and IsActive=1
	UPDATE ELIG.AddressInfo SET ToBeProcessed = 'N' WHERE DataSource='ELIG_HAP' AND ToBeProcessed = 'Y' --and IsActive=1
	UPDATE ELIG.PCP SET ToBeProcessed = 'N' WHERE DataSource='ELIG_HAP' AND ToBeProcessed = 'Y' --and IsActive=1
	UPDATE ELIG.OtherInfo SET ToBeProcessed = 'N' WHERE DataSource='ELIG_HAP' AND ToBeProcessed = 'Y'
	
	TRUNCATE table elig.temp_hap_elig_member
	   

		-- Find New, Update and Terminate members		
			
			-- New - We don't have these members in CRM but received them in the latest eligibility file
			insert into elig.temp_hap_elig_member
			SELECT a.NHLinkID,a.DOB
			,'N' AS MemberStatus
			
			FROM
			(
				SELECT DISTINCT 
				HAP_NUMBER AS NHLinkID
				,cast(DATE_OF_BIRTH as date) as DOB 
				FROM [ELIG].[StgELGHAP]

				EXCEPT

				SELECT 
				NHLinkID,DOB
				FROM ELIG.Members
				WHERE DataSource = 'ELIG_HAP'
				and IsActive=1
			) a

			-- Update - All members who are already available both in CRM and latest eligibility file.
			insert into elig.temp_hap_elig_member
			SELECT a.NHLinkID,a.DOB
			,'U' AS MemberStatus
			FROM
			(
				SELECT DISTINCT 
				HAP_NUMBER AS NHLinkID
				,cast(DATE_OF_BIRTH as date) as DOB 
				FROM [ELIG].[StgELGHAP]

				INTERSECT

				SELECT 
				NHLinkID,DOB
				FROM ELIG.Members
				WHERE DataSource = 'ELIG_HAP'
				and IsActive=1
			) a

			-- Terminate - Members who are already in CRM but missing in latest eligibility file
			insert into elig.temp_hap_elig_member
			SELECT a.NHLinkID,a.DOB
			,'T' AS MemberStatus
			FROM
			(
				SELECT 
				NHLinkID,DOB
				FROM ELIG.Members
				WHERE DataSource = 'ELIG_HAP'
				and IsActive=1
				AND StatusFlag != 'T'

				EXCEPT

				SELECT DISTINCT 
				HAP_NUMBER AS NHLinkID
				,cast(DATE_OF_BIRTH as date) as DOB 
				FROM [ELIG].[StgELGHAP]
			) a





			 -- New Member Updates - Start


			--SELECT * FROM elig.temp_hap_elig_member
			-- drop table elig.temp_hap_elig_member

			-- New Members
			INSERT INTO ELIG.Members (
			DataSource, 
			--CarrierMemberID, 
			FirstName, 
			LastName,
			Title,
			[MedicaidNbr],
			[MedicareNbr],
			[SSN],
			[DOB],
			[DateOfDeath],
			[Gender],
			[Race],
			[Language],
			[NHMemberID],
			[MasterMemberID],
			[ToBeProcessed],
			[StatusFlag],
			[ProcessedDate],
			[CreateDate],
			[CreateUser],
			[ModifyDate],
			[ModifyUser],
			[NHLinkID],
			[MiddleName],
			[IsActive]
			)
			SELECT DISTINCT
			'ELIG_HAP',
			--s.HAP_NUMBER,
			s.FIRST_NAME,
			s.LAST_NAME,
			s.CONTACT_TITLE,
			s.MEDICAID_RECIPIENT_ID,
			s.MEDICARE_NUMBER,
			NULL,
			s.DATE_OF_BIRTH,
			NULL,
			s.GENDER,
			NULL,
			NULL, --s.LANGUAGE_CODE, -- excluded to eliminate inserting duplicate member with & without language code
			NULL,
			NULL,
			'Y',
			'N',
			@sys_date,
			@sys_date,
			@sys_user,
			@sys_date,
			@sys_user,
			s.HAP_NUMBER,
			s.MIDDLE_INITIAL, 
			1
			FROM elig.temp_hap_elig_member t
			JOIN [ELIG].[StgELGHAP] s ON (s.HAP_NUMBER = t.NHLinkID and cast(s.DATE_OF_BIRTH AS DATE)=cast(t.DOB as date) and t.MemberStatus = 'N')
			--order by s.HAP_NUMBER,s.DATE_OF_BIRTH

			--New Insurances
			INSERT INTO ELIG.Insurances (
			--NHInsuranceID,
			DataSource, 
			InsMemberNbr, 
			GroupNbr,
			SubGroupNbr,
			Relationship,
			PlanID,
			PlanCode,
			EligEffectiveDate,
			EligTerminationDate,
			SubscriberID,
			--MemberSuffix,
			[HealthPlanNumber],
            [CarrierID],
			[ToBeProcessed],
			[StatusFlag],
			[ProcessedDate],
			[CreateDate],
			[CreateUser],
			[ModifyDate],
			[ModifyUser],
			[HealthPlanID],
			mastermemberid,
			memberinsuranceid,
			[NHLinkID],
			IsActive,
			PRODUCT_ID,
			PRODUCT_BUSINESS_CATEGORY,
			PRODUCT_VALUE_CODE_1,
			PRODUCT_VALUE_CODE_2,
			LINE_OF_BUSINESS
			)
			SELECT DISTINCT
			--NULL,
			'ELIG_HAP',
			s.HAP_NUMBER,
			s.GROUP_ID,
			s.SUBGROUP_ID,
			s.RELATIONSHIP_CODE,
			s.PLAN_ID,
			s.PLAN_CODE,
			CAST(s.EFFECTIVE_DATE AS DATE),
			CAST(s.TERMINATION_DATE AS DATE),
			s.SUBSCRIBER_ID+s.MEMBER_SUFFIX,
			--s.MEMBER_SUFFIX,
			NULL,
			NULL,
			'Y',
			'N',
			@sys_date,
			@sys_date,
			@sys_user,
			@sys_date,
			@sys_user,
			NULL,
			NULL,
			NULL,
			s.HAP_NUMBER,
			1,
			s.PRODUCT_ID,
			s.PRODUCT_BUSINESS_CATEGORY,
			s.PRODUCT_VALUE_CODE_1,
			s.PRODUCT_VALUE_CODE_2,
			s.LINE_OF_BUSINESS
			FROM elig.temp_hap_elig_member t
			JOIN [ELIG].[StgELGHAP] s ON (s.HAP_NUMBER = t.NHLinkID and t.MemberStatus = 'N')




			-- New Address
			INSERT INTO ELIG.AddressInfo (
			 [DataSource]
			--,[CarrierMemberID]
			,[RecordEffectiveDate]
			,[RecordEndDate]
			,[PrimaryPhoneNbr]
			,[SecondaryPhoneNbr]
			,[AddressLine1]
			,[AddressLine2]
			,[City]
			,[State]
			,[ZipCode]
			,[County]
			,[Country]
			,[SecondaryAddressLine1]
			,[SecondaryAddressLine2]
			,[SecondaryCityName]
			,[SecondaryStateName]
			,[SecondaryZipCode]
			,[ScecondaryCountry]
			,[ToBeProcessed]
			,[StatusFlag]
			--,[ProcessedDate]
			,[CreateDate]
			,[CreateUser]
			,[ModifyDate]
			,[ModifyUser]
			,[mastermemberid]
			,[NHLinkID]
			,[IsActive]
			)
			SELECT DISTINCT
			'ELIG_HAP',
			--s.HAP_NUMBER,
			@sys_date,
			CAST('21991231' AS DATE),
			s.HOME_PHONE_NUMBER,
			s.BUSINESS_PHONE_NUMBER,
			s.ADDRESS_LINE_1,
			s.ADDRESS_LINE_2,
			s.CITY,
			s.STATE,
			s.ZIP_CODE,
			NULL,
			s.COUNTRY,
			NULL,
			NULL,
			NULL,
			NULL,
			NULL,
			NULL,			
			'Y',
			'N',
			--@sys_date,
			@sys_date,
			@sys_user,
			@sys_date,
			@sys_user,
			NULL,
			s.HAP_NUMBER,
			1
			FROM elig.temp_hap_elig_member t
			JOIN [ELIG].[StgELGHAP] s ON (s.HAP_NUMBER = t.NHLinkID and t.MemberStatus = 'N')




			-- New PCP
			INSERT INTO ELIG.PCP (
			 [DataSource]
			--,[CarrierMemberID]
			,[RecordEffectiveDate]
			,[RecordEndDate]
			,[PCPNPID]
			,[PCPName]
			,[ToBeProcessed]
			,[StatusFlag]
			--,[ProcessedDate]
			,[CreateDate]
			,[CreateUser]
			,[ModifyDate]
			,[ModifyUser]
			,[mastermemberid]
			,[NHLinkID]
			,[IsActive]
			)
			SELECT DISTINCT
			'ELIG_HAP',
			--s.HAP_NUMBER,
			@sys_date,
			CAST('21991231' AS DATE),
			s.NATIONAL_PROVIDER_ID,
			s.PCP_NAME,
			'Y',
			'N',
			--@sys_date,
			@sys_date,
			@sys_user,
			@sys_date,
			@sys_user,
			NULL,
			s.HAP_NUMBER,
			1
			FROM elig.temp_hap_elig_member t
			JOIN [ELIG].[StgELGHAP] s ON (s.HAP_NUMBER = t.NHLinkID and t.MemberStatus = 'N')



			-- New OtherInfo
			INSERT INTO ELIG.OtherInfo (
			 [DataSource]
			--,[CarrierMemberID]
			,[vcField1]
			,[vcField2]
			,[vcField3]
			,[vcField4]
			,[vcField5]
			,[vcField6]
			,[vcField7]
			,[vcField8]
			,[vcField9]
			,[vcField10]
			,[vcField11]
			,[vcField12]
			,[vcField13]
			,[vcField14]
			,[vcField15]
			,[vcField16]
			,[vcField17]
			,[vcField18]
			,[vcField19]
			,[vcField20]
			,[vcField21]
			,[vcField22]
			,[vcField23]
			,[vcField24]
			,[vcField25]
			,[vcField26]
			,[vcField27]
			,[vcField28]
			,[vcField29]
			,[ToBeProcessed]
			,[StatusFlag]
			,[ProcessedDate]
			,[CreateDate]
			,[CreateUser]
			,[ModifyDate]
			,[ModifyUser]
			,[mastermemberid]
			,[NHLinkID]
			)
			SELECT DISTINCT
			'ELIG_HAP',
			--s.HAP_NUMBER,
			s.CASE_MANAGEMENT_FLAG,
			s.PRODUCT_BUSINESS_CATEGORY,
			s.PRODUCT_VALUE_CODE_1,
			s.PRODUCT_VALUE_CODE_2,
			s.LINE_OF_BUSINESS,
			s.COB_CARRIER_CODE_1,
			s.COB_CARRIER_NAME_1,
			s.COB_POLICY_NUMBER_1,
			s.COB_CODE_1,
			s.COB_EFFECTIVE_DATE_1,
			s.COB_TERM_DATE_1,
			s.ENTITLEMENT_CODE_1,
			s.COB_CARRIER_CODE_2,
		    s.COB_CARRIER_NAME_2,
			s.COB_POLICY_NUMBER_2,
			s.COB_CODE_2,
			s.COB_EFFECTIVE_DATE_2,
			s.COB_TERM_DATE_2,
			s.ENTITLEMENT_CODE_2,
			s.RECORD_TYPE,
			s.RELATIONSHIP_CODE,
			s.ELIGIBILITY_STATUS,
			s.GROUP_ID,
			s.GROUP_NAME,
			s.SUBGROUP_ID,
			s.SUBGROUP_NAME,
			s.PRODUCT_ID,
			s.NETWORK_ID,
			s.NETWORK_NAME,
			'Y',
			'N',
			@sys_date,
			@sys_date,
			@sys_user,
			@sys_date,
			@sys_user,
			NULL,
			s.HAP_NUMBER
			FROM elig.temp_hap_elig_member t
			JOIN [ELIG].[StgELGHAP] s ON (s.HAP_NUMBER = t.NHLinkID and t.MemberStatus = 'N')

		-- New Member Updates - End

	
	
		-- Existing Member - Start
		
			-- Update Members if there is a change in name, medicare or medicaid numbers
			UPDATE m
			SET m.FirstName = case when isnull(st.FIRST_NAME,'')='' then m.FirstName else st.FIRST_NAME end,
			m.LastName = case when isnull(st.LAST_NAME,'')='' then m.LastName else st.LAST_NAME end,
			m.MiddleName = case when isnull(st.MIDDLE_INITIAL,'')='' then m.MiddleName else st.MIDDLE_INITIAL end,
			m.DOB = case when isnull(st.DATE_OF_BIRTH,'')='' then cast(m.DOB as date) else cast(st.DATE_OF_BIRTH as date) end,
			m.ToBeProcessed = 'Y',
			m.StatusFlag = 'U',
			m.MedicaidNbr = case when isnull(st.MEDICAID_RECIPIENT_ID,'')='' then m.MedicaidNbr else st.MEDICAID_RECIPIENT_ID end,
			m.MedicareNbr = case when isnull(st.MEDICARE_NUMBER,'')='' then m.MedicareNbr else st.MEDICARE_NUMBER end,
			m.Gender = case when isnull(st.GENDER,'')='' then m.Gender else st.GENDER end,
			m.ModifyDate = @sys_date,
			m.ModifyUser = @sys_user
			FROM ELIG.Members m
			JOIN elig.temp_hap_elig_member t on (t.NHLinkID = m.NHLinkID and cast(m.DOB AS DATE) = CAST(t.dob as date) and t.MemberStatus = 'U')
			JOIN [ELIG].[StgELGHAP] st on ( st.HAP_NUMBER=m.NHLinkID and cast(st.DATE_OF_BIRTH AS DATE) = cast(m.DOB AS DATE) 
											AND (st.FIRST_NAME!=m.FirstName OR st.LAST_NAME!=m.LastName OR st.MIDDLE_INITIAL!=m.MiddleName OR st.MEDICAID_RECIPIENT_ID!=m.MedicaidNbr OR st.MEDICARE_NUMBER!=m.MedicareNbr OR st.GENDER!=m.Gender)    )
			WHERE 1=1
			AND m.DataSource='ELIG_HAP'
			AND m.IsActive=1


			-- Terminate Members
			UPDATE m
			SET m.ToBeProcessed = 'Y',
			m.StatusFlag = 'T',
			m.ModifyDate = @sys_date,
			m.ModifyUser = @sys_user
			FROM ELIG.Members m
			JOIN elig.temp_hap_elig_member t on (t.NHLinkID = m.NHLinkID and cast(m.DOB AS DATE) = CAST(t.dob as date) and t.MemberStatus = 'T')
			WHERE 1=1
			AND m.DataSource='ELIG_HAP'
			AND m.IsActive=1

		
			-- Update Insurance

			-- Case when there are changes in plan detials or Termiantion date (no change in effective date, group number or subscription)
			UPDATE i
			SET i.PlanID = st.PLAN_ID,
			i.PlanCode = st.PLAN_CODE,
			i.[EligTerminationDate] = CAST(st.TERMINATION_DATE AS DATE),
			i.PRODUCT_ID = st.PRODUCT_ID,
			i.PRODUCT_BUSINESS_CATEGORY = st.PRODUCT_BUSINESS_CATEGORY,
			i.PRODUCT_VALUE_CODE_1 = st.PRODUCT_VALUE_CODE_1,
			i.PRODUCT_VALUE_CODE_2 = st.PRODUCT_VALUE_CODE_2,
			i.LINE_OF_BUSINESS = st.LINE_OF_BUSINESS,
			i.ToBeProcessed = 'Y',
			i.StatusFlag = 'U',
			i.ModifyDate = @sys_date,
			i.ModifyUser = @sys_user
			FROM ELIG.Insurances i
			JOIN elig.temp_hap_elig_member t on (t.NHLinkID = i.NHLinkID and t.MemberStatus = 'U')
			JOIN ELIG.StgELGHAP st on (i.NHLinkID=st.HAP_NUMBER AND i.EligEffectiveDate=CAST(st.EFFECTIVE_DATE AS DATE) and st.GROUP_ID = i.GroupNbr and (st.SUBSCRIBER_ID+st.MEMBER_SUFFIX)=i.SubscriberID and i.SubGroupNbr = st.SUBGROUP_ID
			                           AND (i.PlanID != st.PLAN_ID OR i.PlanCode != st.PLAN_CODE OR i.[EligTerminationDate] != CAST(st.TERMINATION_DATE AS DATE) or i.PRODUCT_ID!=st.PRODUCT_ID or i.PRODUCT_BUSINESS_CATEGORY!=st.PRODUCT_BUSINESS_CATEGORY
									   or i.PRODUCT_VALUE_CODE_1!=st.PRODUCT_VALUE_CODE_1 or i.PRODUCT_VALUE_CODE_2!=st.PRODUCT_VALUE_CODE_2 or i.LINE_OF_BUSINESS!=st.LINE_OF_BUSINESS ) )
			WHERE 1=1
			AND i.DataSource='ELIG_HAP'
			AND i.IsActive=1 

			-- End date records which has change in Eligibility dates			

		
			-- Insert new records when there is change in Effective Date
			INSERT INTO ELIG.Insurances (
			--NHInsuranceID,
			DataSource, 
			InsMemberNbr, 
			GroupNbr,
			SubGroupNbr,
			Relationship,
			PlanID,
			PlanCode,
			EligEffectiveDate,
			EligTerminationDate,
			SubscriberID,
			--MemberSuffix,
			[HealthPlanNumber],
            [CarrierID],
			[ToBeProcessed],
			[StatusFlag],
			[ProcessedDate],
			[CreateDate],
			[CreateUser],
			[ModifyDate],
			[ModifyUser],
			[HealthPlanID],
			mastermemberid,
			memberinsuranceid,
			[NHLinkID],
			IsActive,
			PRODUCT_ID,
			PRODUCT_BUSINESS_CATEGORY,
			PRODUCT_VALUE_CODE_1,
			PRODUCT_VALUE_CODE_2,
			LINE_OF_BUSINESS
			)
			SELECT DISTINCT
			--NULL,
			'ELIG_HAP',
			st.HAP_NUMBER,
			st.GROUP_ID,
			st.SUBGROUP_ID,
			st.RELATIONSHIP_CODE,
			st.PLAN_ID,
			st.PLAN_CODE,
			CAST(st.EFFECTIVE_DATE AS DATE),
			CAST(st.TERMINATION_DATE AS DATE),
			st.SUBSCRIBER_ID+st.MEMBER_SUFFIX,
			--s.MEMBER_SUFFIX,
			NULL,
			NULL,
			'Y',
			'N',
			@sys_date,
			@sys_date,
			@sys_user,
			@sys_date,
			@sys_user,
			NULL,
			NULL,
			NULL,
			st.HAP_NUMBER,
			1,
			st.PRODUCT_ID,
			st.PRODUCT_BUSINESS_CATEGORY,
			st.PRODUCT_VALUE_CODE_1,
			st.PRODUCT_VALUE_CODE_2,
			st.LINE_OF_BUSINESS
			FROM ELIG.Insurances i
			JOIN elig.temp_hap_elig_member t on (t.NHLinkID = i.NHLinkID and t.MemberStatus = 'U')
			JOIN ELIG.StgELGHAP st on ( i.IsActive = 1 AND i.NHLinkID=st.HAP_NUMBER AND i.[EligEffectiveDate]!=CAST(st.EFFECTIVE_DATE AS DATE))
			WHERE 1=1
			AND i.DataSource='ELIG_HAP'



			-- update termination date for old record
			UPDATE i
			SET i.[EligTerminationDate] = CASE WHEN CAST(st.EFFECTIVE_DATE AS DATE)>i.[EligTerminationDate] THEN i.[EligTerminationDate] -- verify
											   WHEN CAST(st.EFFECTIVE_DATE AS DATE)<i.[EligTerminationDate] AND CAST(st.EFFECTIVE_DATE AS DATE)<i.[EligEffectiveDate] THEN DATEADD(dd,-1,i.[EligEffectiveDate])
											   --WHEN CAST(st.EFFECTIVE_DATE AS DATE)>i.[EligTerminationDate] AND CAST(st.EFFECTIVE_DATE AS DATE)>i.[EligEffectiveDate] THEN i.[EligTerminationDate]
			                                   WHEN CAST(st.EFFECTIVE_DATE AS DATE)<i.[EligTerminationDate] AND CAST(st.EFFECTIVE_DATE AS DATE)>i.[EligEffectiveDate] THEN DATEADD(dd,-1,CAST(st.EFFECTIVE_DATE AS DATE)) 
											   ELSE i.[EligTerminationDate] END,
			i.IsActive = 0,
			i.ToBeProcessed = 'Y',
			i.StatusFlag = 'U',
			i.ModifyDate = @sys_date,
			i.ModifyUser = @sys_user
			FROM ELIG.Insurances i
			JOIN elig.temp_hap_elig_member t on (t.NHLinkID = i.NHLinkID and t.MemberStatus = 'U')
			JOIN ELIG.StgELGHAP st on ( i.IsActive = 1 AND i.NHLinkID=st.HAP_NUMBER AND i.[EligEffectiveDate]!=CAST(st.EFFECTIVE_DATE AS DATE)) 
			WHERE 1=1
			AND i.DataSource='ELIG_HAP'


			-- End date insurance if members are terminated
			UPDATE i
			SET i.[EligTerminationDate] = DATEADD(dd,-1,@sys_date),
			i.ToBeProcessed = 'Y',
			i.StatusFlag = 'T',
			i.ModifyDate = @sys_date,
			i.ModifyUser = @sys_user
			FROM ELIG.Insurances i
			JOIN elig.temp_hap_elig_member t on (t.NHLinkID = i.NHLinkID and t.MemberStatus = 'T')
			WHERE 1=1
			AND i.DataSource='ELIG_HAP' 


	
	
			-- Insert there is change in PCP Info.
			INSERT INTO ELIG.PCP (
			[DataSource]
			--,[CarrierMemberID]
			,[RecordEffectiveDate]
			,[RecordEndDate]
			,[PCPNPID]
			,[PCPName],
			[ToBeProcessed],
			[StatusFlag],
			--[ProcessedDate],
			[CreateDate],
			[CreateUser],
			[ModifyDate],
			[ModifyUser],
			mastermemberid,
			[NHLinkID],
			[IsActive]
			)
			SELECT 
			'ELIG_HAP',
			--st.HAP_NUMBER,
			@sys_date,
			CAST('21991231' AS DATE),
			st.NATIONAL_PROVIDER_ID,
			st.PCP_NAME,		
			'Y',
			'N',
			--@sys_date,
			@sys_date,
			@sys_user,
			@sys_date,
			@sys_user,
			NULL,
			st.HAP_NUMBER
			,1
			FROM ELIG.PCP p
			JOIN elig.temp_hap_elig_member t on (t.NHLinkID = p.NHLinkID and t.MemberStatus = 'U')
			JOIN ELIG.StgELGHAP st on (p.IsActive=1 AND p.NHLinkID=st.HAP_NUMBER AND (p.PCPNPID!=st.NATIONAL_PROVIDER_ID OR p.PCPName!=st.PCP_NAME))
			WHERE 1=1
			AND p.DataSource='ELIG_HAP'

			-- End date prevoious record
			UPDATE p
			SET p.[RecordEndDate] = DATEADD(dd,-1,@sys_date),
			p.IsActive=0,
			P.ToBeProcessed = 'Y',
			p.StatusFlag = 'U',
			p.ModifyDate = @sys_date,
			p.ModifyUser = @sys_user
			FROM ELIG.PCP p
			JOIN elig.temp_hap_elig_member t on (t.NHLinkID = p.NHLinkID and t.MemberStatus = 'U')
			JOIN ELIG.StgELGHAP st on ( p.IsActive=1 AND p.NHLinkID=st.HAP_NUMBER AND (p.PCPNPID!=st.NATIONAL_PROVIDER_ID OR p.PCPName!=st.PCP_NAME)) 
			WHERE 1=1
			AND p.DataSource='ELIG_HAP'


			-- End date record if member is terminated
			UPDATE p
			SET p.RecordEndDate = DATEADD(dd,-1,@sys_date),
			p.ToBeProcessed = 'Y',
			p.StatusFlag = 'T',
			p.ModifyDate = @sys_date,
			p.ModifyUser = @sys_user
			FROM ELIG.PCP p
			JOIN elig.temp_hap_elig_member t on (t.NHLinkID = p.NHLinkID and t.MemberStatus = 'T')
			WHERE 1=1
			AND p.DataSource='ELIG_HAP' 


	
			-- Insert if there is change in Address.
			INSERT INTO ELIG.AddressInfo (
			[DataSource]
			--,[CarrierMemberID]
			,[RecordEffectiveDate]
			,[RecordEndDate]
			,[PrimaryPhoneNbr]
			,[SecondaryPhoneNbr]
			,[AddressLine1]
			,[AddressLine2]
			,[City]
			,[State]
			,[ZipCode]
			,[County]
			,[Country],
			[ToBeProcessed],
			[StatusFlag],
			--[ProcessedDate],
			[CreateDate],
			[CreateUser],
			[ModifyDate],
			[ModifyUser],
			mastermemberid,
			[NHLinkID],
			[IsActive]
			)
			SELECT 
			'ELIG_HAP',
			--st.HAP_NUMBER,
			@sys_date,
			CAST('21991231' AS DATE),
			st.HOME_PHONE_NUMBER,
			st.BUSINESS_PHONE_NUMBER,	
			st.ADDRESS_LINE_1,
			st.ADDRESS_LINE_2,
			st.CITY,
			st.STATE,
			st.ZIP_CODE,
			NULL,
			st.COUNTRY,	
			'Y',
			'N',
			--@sys_date,
			@sys_date,
			@sys_user,
			@sys_date,
			@sys_user,
			NULL,
			st.HAP_NUMBER
			,1
			FROM ELIG.AddressInfo a
			JOIN elig.temp_hap_elig_member t on (t.NHLinkID = a.NHLinkID and t.MemberStatus = 'U')
			JOIN ELIG.StgELGHAP st on ( a.IsActive=1 AND a.NHLinkID=st.HAP_NUMBER 
			AND (a.[PrimaryPhoneNbr]!=st.HOME_PHONE_NUMBER OR a.[SecondaryPhoneNbr]!=st.BUSINESS_PHONE_NUMBER OR a.AddressLine1!=st.ADDRESS_LINE_1 OR a.AddressLine2!=st.ADDRESS_LINE_2
			     OR a.City!=st.CITY OR a.State!=st.STATE OR a.ZipCode!=st.ZIP_CODE OR a.Country!=st.COUNTRY)  )
			WHERE 1=1
			AND a.DataSource='ELIG_HAP'

			-- End date prevoious record
			UPDATE a
			SET a.RecordEndDate = DATEADD(dd,-1,@sys_date),
			a.IsActive=0,
			a.ToBeProcessed = 'Y',
			a.StatusFlag = 'U',
			a.ModifyDate = @sys_date,
			a.ModifyUser = @sys_user
			FROM ELIG.AddressInfo a
			JOIN elig.temp_hap_elig_member t on (t.NHLinkID = a.NHLinkID and t.MemberStatus = 'U')
			JOIN ELIG.StgELGHAP st on ( a.IsActive=1 AND a.NHLinkID=st.HAP_NUMBER 
			AND (a.PrimaryPhoneNbr!=st.HOME_PHONE_NUMBER OR a.[SecondaryPhoneNbr]!=st.BUSINESS_PHONE_NUMBER OR a.AddressLine1!=st.ADDRESS_LINE_1 OR a.AddressLine2!=st.ADDRESS_LINE_2
			     OR a.City!=st.CITY OR a.State!=st.STATE OR a.ZipCode!=st.ZIP_CODE OR a.Country!=st.COUNTRY)  ) 
			WHERE 1=1
			AND a.DataSource='ELIG_HAP'


			-- End date record if members are terminated
			UPDATE a
			SET a.RecordEndDate = DATEADD(dd,-1,@sys_date),
			a.ToBeProcessed = 'Y',
			a.StatusFlag = 'T',
			a.ModifyDate = @sys_date,
			a.ModifyUser = @sys_user
			FROM ELIG.AddressInfo a
			JOIN elig.temp_hap_elig_member t on (t.NHLinkID = a.NHLinkID and t.MemberStatus = 'T')
			WHERE 1=1
			AND a.DataSource='ELIG_HAP' 


			-- Updates on OtherInfo
			SELECT HAP_NUMBER
			into #HAP_Elig_Member_OtherInfo
			FROM(			
						SELECT distinct
						s.HAP_NUMBER,
						s.CASE_MANAGEMENT_FLAG,
						s.PRODUCT_BUSINESS_CATEGORY,
						s.PRODUCT_VALUE_CODE_1,
						s.PRODUCT_VALUE_CODE_2,
						s.LINE_OF_BUSINESS,
						s.COB_CARRIER_CODE_1,
						s.COB_CARRIER_NAME_1,
						s.COB_POLICY_NUMBER_1,
						s.COB_CODE_1,
						s.COB_EFFECTIVE_DATE_1,
						s.COB_TERM_DATE_1,
						s.ENTITLEMENT_CODE_1,
						s.COB_CARRIER_CODE_2,
						s.COB_CARRIER_NAME_2,
						s.COB_POLICY_NUMBER_2,
						s.COB_CODE_2,
						s.COB_EFFECTIVE_DATE_2,
						s.COB_TERM_DATE_2,
						s.ENTITLEMENT_CODE_2,
						s.RECORD_TYPE,
						s.RELATIONSHIP_CODE,
						s.ELIGIBILITY_STATUS,
						s.GROUP_ID,
						s.GROUP_NAME,
						s.SUBGROUP_ID,
						s.SUBGROUP_NAME,
						s.PRODUCT_ID,
						s.NETWORK_ID,
						s.NETWORK_NAME
						FROM [ELIG].[StgELGHAP] s

						EXCEPT

						select distinct
						--[CarrierMemberID]
						NHLinkID
						,[vcField1]
						,[vcField2]
						,[vcField3]
						,[vcField4]
						,[vcField5]
						,[vcField6]
						,[vcField7]
						,[vcField8]
						,[vcField9]
						,[vcField10]
						,[vcField11]
						,[vcField12]
						,[vcField13]
						,[vcField14]
						,[vcField15]
						,[vcField16]
						,[vcField17]
						,[vcField18]
						,[vcField19]
						,[vcField20]
						,[vcField21]
						,[vcField22]
						,[vcField23]
						,[vcField24]
						,[vcField25]
						,[vcField26]
						,[vcField27]
						,[vcField28]
						,[vcField29]
						from elig.OtherInfo
						WHERE DataSource='ELIG_HAP'
			) a



			
			-- Update OtherInfo if there are any changes
			UPDATE o
			SET
			o.vcField1=st.CASE_MANAGEMENT_FLAG,
			o.vcField2=st.PRODUCT_BUSINESS_CATEGORY,
			o.vcField3=st.PRODUCT_VALUE_CODE_1,
			o.vcField4=st.PRODUCT_VALUE_CODE_2,
			o.vcField5=st.LINE_OF_BUSINESS,
			o.vcField6=st.COB_CARRIER_CODE_1,
			o.vcField7=st.COB_CARRIER_NAME_1,
			o.vcField8=st.COB_POLICY_NUMBER_1,
			o.vcField9=st.COB_CODE_1,
			o.vcField10=st.COB_EFFECTIVE_DATE_1,
			o.vcField11=st.COB_TERM_DATE_1,
			o.vcField12=st.ENTITLEMENT_CODE_1,
			o.vcField13=st.COB_CARRIER_CODE_2,
			o.vcField14=st.COB_CARRIER_NAME_2,
			o.vcField15=st.COB_POLICY_NUMBER_2,
			o.vcField16=st.COB_CODE_2,
			o.vcField17=st.COB_EFFECTIVE_DATE_2,
			o.vcField18=st.COB_TERM_DATE_2,
			o.vcField19=st.ENTITLEMENT_CODE_2,

			o.vcField20=st.RECORD_TYPE,
			o.vcField21=st.RELATIONSHIP_CODE,
			o.vcField22=st.ELIGIBILITY_STATUS,
			o.vcField23=st.GROUP_ID,
			o.vcField24=st.GROUP_NAME,
			o.vcField25=st.SUBGROUP_ID,
			o.vcField26=st.SUBGROUP_NAME,
			o.vcField27=st.PRODUCT_ID,
			o.vcField28=st.NETWORK_ID,
			o.vcField29=st.NETWORK_NAME,
			o.ToBeProcessed = 'Y',
			o.StatusFlag = 'U',
			o.ModifyDate = @sys_date,
			o.ModifyUser = @sys_user
			FROM ELIG.OtherInfo o
			JOIN #HAP_Elig_Member_OtherInfo t ON (t.HAP_NUMBER = o.NHLinkID)
			JOIN ELIG.StgELGHAP st ON  ( o.NHLinkID=st.HAP_NUMBER )
			WHERE 1=1
			AND o.DataSource='ELIG_HAP'


			

			-- Update healthplanID for only Medicaid members 
			UPDATE i
			set 
			i.CarrierID = l.insurancecarrierid,
			i.HealthPlanID = l.InsuranceHealthPlanID
			FROM ELIG.Insurances i
			JOIN [ELIG].[HAP_LINK] l ON (i.GroupNbr = l.GRGR_ID  and i.SubGroupNbr = l.SubgroupID and l.BatchNbr=1)
			WHERE 1=1
			AND i.DataSource='ELIG_HAP'
			AND i.GroupNbr in ('10005160','10005161')
			and i.ToBeProcessed='Y'
			

			-- Update healthplanID based on cross walk excluding medicaid groups
			UPDATE i
			set 
			i.CarrierID = l.insurancecarrierid,
			i.HealthPlanID = l.InsuranceHealthPlanID
			FROM ELIG.Insurances i
			JOIN [ELIG].[HAP_LINK] l ON (i.GroupNbr = l.GRGR_ID  and i.PRODUCT_ID=l.PDPD_ID and i.PRODUCT_BUSINESS_CATEGORY=l.PDDS_MCTR_BCAT and i.PRODUCT_VALUE_CODE_1=l.PDDS_MCTR_VAL1 and i.LINE_OF_BUSINESS=l.LOBD_ID and l.BatchNbr=2)
			WHERE 1=1
			AND i.DataSource='ELIG_HAP'
			AND i.GroupNbr not in ('10005160','10005161')
			and i.ToBeProcessed='Y'

			-- Update healthplanID for all members not matching with cross walk to 'HAP Commercial Discount' plan (222,2282)
			UPDATE i
			set 
			i.CarrierID = 222,
			i.HealthPlanID = 2282
			FROM ELIG.Insurances i
			WHERE 1=1
			AND i.DataSource='ELIG_HAP'
			AND i.GroupNbr not in ('10005160','10005161')
			and i.ToBeProcessed='Y'
			and i.HealthPlanID is null
		
		-- Existing Member - End
		
		-- DROP TABLE #HAP_Elig_Member_Status
	   DROP TABLE #HAP_Elig_Member_OtherInfo
	
	
	--COMMIT TRANSACTION member_load_stg_to_elig_HAP
	--PRINT 'SUCCESS'
	

	--END TRY
	

	--BEGIN CATCH

	--DECLARE @ErrorMessage NVARCHAR(4000);  
 --   DECLARE @ErrorSeverity INT;  
 --   DECLARE @ErrorState INT;  

 --   SELECT   
 --       @ErrorMessage = ERROR_MESSAGE(),  
 --       @ErrorSeverity = ERROR_SEVERITY(),  
 --       @ErrorState = ERROR_STATE();  

	--	IF (@@TRANCOUNT > 0)
	--	BEGIN
	--		ROLLBACK TRANSACTION member_load_stg_to_elig_HAP
	--		RAISERROR(@ErrorMessage,@ErrorSeverity,@ErrorState);
	--		PRINT 'FAILED'
	--	END

	--END CATCH

END	



-- EXEC [ELIG].[elig_file_load_ssis_sp_merge_stg_to_elig_HAP] 

CREATE PROCEDURE [elig].[elig_file_load_ssis_sp_merge_stg_to_elig_HAP]


AS

BEGIN

	BEGIN TRY
	BEGIN TRANSACTION member_load_stg_to_elig_HAP

DECLARE @sys_user CHAR(30)
	   ,@sys_date DATETIME;  

SET @sys_user = SYSTEM_USER
--SET @sys_date = CAST(GETDATE() AS DATE);  
SET @sys_date = CAST(GETDATE() AT TIME ZONE 'UTC' AT TIME ZONE 'Eastern Standard Time' AS DATETIME);  -- Time in EST




	UPDATE ELIG.Members SET ToBeProcessed = 'N' WHERE DataSource='ELIG_HAP' AND ToBeProcessed = 'Y'
	UPDATE ELIG.Insurances SET ToBeProcessed = 'N' WHERE DataSource='ELIG_HAP' AND ToBeProcessed = 'Y'
	UPDATE ELIG.AddressInfo SET ToBeProcessed = 'N' WHERE DataSource='ELIG_HAP' AND ToBeProcessed = 'Y'
	UPDATE ELIG.PCP SET ToBeProcessed = 'N' WHERE DataSource='ELIG_HAP' AND ToBeProcessed = 'Y'
	UPDATE ELIG.OtherInfo SET ToBeProcessed = 'N' WHERE DataSource='ELIG_HAP' AND ToBeProcessed = 'Y'
	

	    -- New Member - Start

		-- Find New, Updates and Terminate records			
			SELECT a.NHLinkID
			,'N' AS MemberStatus
			INTO #HAP_Elig_Member_Status
			FROM
			(
				SELECT DISTINCT 
				HAP_NUMBER AS NHLinkID			
				FROM [ELIG].[StgELGHAP]
				EXCEPT
				SELECT 
				NHLinkID
				FROM ELIG.Members
				WHERE DataSource = 'ELIG_HAP'
			) a


			INSERT INTO #HAP_Elig_Member_Status
			SELECT a.NHLinkID
			,'U' AS MemberStatus
			FROM
			(
				SELECT DISTINCT 
				HAP_NUMBER AS NHLinkID
				FROM [ELIG].[StgELGHAP]
				INTERSECT			
				SELECT 
				NHLinkID
				FROM ELIG.Members
				WHERE DataSource = 'ELIG_HAP'
			) a

			INSERT INTO #HAP_Elig_Member_Status
			SELECT a.NHLinkID
			,'T' AS MemberStatus
			FROM
				(
				SELECT 
				NHLinkID
				FROM ELIG.Members
				WHERE DataSource = 'ELIG_HAP'
				AND StatusFlag != 'T'			
				EXCEPT			
				SELECT DISTINCT 
				HAP_NUMBER AS NHLinkID			
				FROM [ELIG].[StgELGHAP]
			
			) a

			--SELECT * FROM #HAP_Elig_Member_Status
			-- drop table #HAP_Elig_Member_Status

			-- Members
			INSERT INTO ELIG.Members (
			DataSource, 
			--CarrierMemberID, 
			FirstName, 
			LastName,
			Title,
			[MedicaidNbr],
			[MedicareNbr],
			[SSN],
			[DOB],
			[DateOfDeath],
			[Gender],
			[Race],
			[Language],
			[NHMemberID],
			[MasterMemberID],
			[ToBeProcessed],
			[StatusFlag],
			[ProcessedDate],
			[CreateDate],
			[CreateUser],
			[ModifyDate],
			[ModifyUser],
			[NHLinkID],
			[MiddleName]
			)
			SELECT 
			'ELIG_HAP',
			--s.HAP_NUMBER,
			s.FIRST_NAME,
			s.LAST_NAME,
			s.CONTACT_TITLE,
			s.MEDICAID_RECIPIENT_ID,
			s.MEDICARE_NUMBER,
			NULL,
			s.DATE_OF_BIRTH,
			NULL,
			s.GENDER,
			NULL,
			s.LANGUAGE_CODE,
			NULL,
			NULL,
			'Y',
			'N',
			@sys_date,
			@sys_date,
			@sys_user,
			@sys_date,
			@sys_user,
			s.HAP_NUMBER,
			s.MIDDLE_INITIAL
			FROM #HAP_Elig_Member_Status t
			JOIN [ELIG].[StgELGHAP] s ON (s.HAP_NUMBER = t.NHLinkID and t.MemberStatus = 'N')

			--Insurances
			INSERT INTO ELIG.Insurances (
			--NHInsuranceID,
			DataSource, 
			InsMemberNbr, 
			GroupNbr,
			SubGroupNbr,
			Relationship,
			PlanID,
			PlanCode,
			EligEffectiveDate,
			EligTerminationDate,
			SubscriberID,
			--MemberSuffix,
			[HealthPlanNumber],
            [CarrierID],
			[ToBeProcessed],
			[StatusFlag],
			[ProcessedDate],
			[CreateDate],
			[CreateUser],
			[ModifyDate],
			[ModifyUser],
			[HealthPlanID],
			mastermemberid,
			memberinsuranceid,
			[NHLinkID],
			IsActive
			)
			SELECT 
			--NULL,
			'ELIG_HAP',
			s.HAP_NUMBER,
			s.GROUP_ID,
			s.SUBGROUP_ID,
			s.RELATIONSHIP_CODE,
			s.PLAN_ID,
			s.PLAN_CODE,
			CAST(s.EFFECTIVE_DATE AS DATE),
			CAST(s.TERMINATION_DATE AS DATE),
			s.SUBSCRIBER_ID+s.MEMBER_SUFFIX,
			--s.MEMBER_SUFFIX,
			NULL,
			NULL,
			'Y',
			'N',
			@sys_date,
			@sys_date,
			@sys_user,
			@sys_date,
			@sys_user,
			NULL,
			NULL,
			NULL,
			s.HAP_NUMBER,
			1
			FROM #HAP_Elig_Member_Status t
			JOIN [ELIG].[StgELGHAP] s ON (s.HAP_NUMBER = t.NHLinkID and t.MemberStatus = 'N')


			-- Address
			INSERT INTO ELIG.AddressInfo (
			 [DataSource]
			--,[CarrierMemberID]
			,[RecordEffectiveDate]
			,[RecordEndDate]
			,[PrimaryPhoneNbr]
			,[SecondaryPhoneNbr]
			,[AddressLine1]
			,[AddressLine2]
			,[City]
			,[State]
			,[ZipCode]
			,[County]
			,[Country]
			,[SecondaryAddressLine1]
			,[SecondaryAddressLine2]
			,[SecondaryCityName]
			,[SecondaryStateName]
			,[SecondaryZipCode]
			,[ScecondaryCountry]
			,[ToBeProcessed]
			,[StatusFlag]
			--,[ProcessedDate]
			,[CreateDate]
			,[CreateUser]
			,[ModifyDate]
			,[ModifyUser]
			,[mastermemberid]
			,[NHLinkID]
			,[IsActive]
			)
			SELECT 
			'ELIG_HAP',
			--s.HAP_NUMBER,
			@sys_date,
			CAST('21991231' AS DATE),
			s.HOME_PHONE_NUMBER,
			s.BUSINESS_PHONE_NUMBER,
			s.ADDRESS_LINE_1,
			s.ADDRESS_LINE_2,
			s.CITY,
			s.STATE,
			s.ZIP_CODE,
			NULL,
			s.COUNTRY,
			NULL,
			NULL,
			NULL,
			NULL,
			NULL,
			NULL,			
			'Y',
			'N',
			--@sys_date,
			@sys_date,
			@sys_user,
			@sys_date,
			@sys_user,
			NULL,
			s.HAP_NUMBER,
			1
			FROM #HAP_Elig_Member_Status t
			JOIN [ELIG].[StgELGHAP] s ON (s.HAP_NUMBER = t.NHLinkID and t.MemberStatus = 'N')

			-- PCP
			INSERT INTO ELIG.PCP (
			 [DataSource]
			--,[CarrierMemberID]
			,[RecordEffectiveDate]
			,[RecordEndDate]
			,[PCPNPID]
			,[PCPName]
			,[ToBeProcessed]
			,[StatusFlag]
			--,[ProcessedDate]
			,[CreateDate]
			,[CreateUser]
			,[ModifyDate]
			,[ModifyUser]
			,[mastermemberid]
			,[NHLinkID]
			,[IsActive]
			)
			SELECT 
			'ELIG_HAP',
			--s.HAP_NUMBER,
			@sys_date,
			CAST('21991231' AS DATE),
			s.NATIONAL_PROVIDER_ID,
			s.PCP_NAME,
			'Y',
			'N',
			--@sys_date,
			@sys_date,
			@sys_user,
			@sys_date,
			@sys_user,
			NULL,
			s.HAP_NUMBER,
			1
			FROM #HAP_Elig_Member_Status t
			JOIN [ELIG].[StgELGHAP] s ON (s.HAP_NUMBER = t.NHLinkID and t.MemberStatus = 'N')

			-- OtherInfo
			INSERT INTO ELIG.OtherInfo (
			 [DataSource]
			--,[CarrierMemberID]
			,[vcField1]
			,[vcField2]
			,[vcField3]
			,[vcField4]
			,[vcField5]
			,[vcField6]
			,[vcField7]
			,[vcField8]
			,[vcField9]
			,[vcField10]
			,[vcField11]
			,[vcField12]
			,[vcField13]
			,[vcField14]
			,[vcField15]
			,[vcField16]
			,[vcField17]
			,[vcField18]
			,[vcField19]
			,[vcField20]
			,[vcField21]
			,[vcField22]
			,[vcField23]
			,[vcField24]
			,[vcField25]
			,[vcField26]
			,[vcField27]
			,[vcField28]
			,[vcField29]
			,[ToBeProcessed]
			,[StatusFlag]
			,[ProcessedDate]
			,[CreateDate]
			,[CreateUser]
			,[ModifyDate]
			,[ModifyUser]
			,[mastermemberid]
			,[NHLinkID]
			)
			SELECT 
			'ELIG_HAP',
			--s.HAP_NUMBER,
			s.CASE_MANAGEMENT_FLAG,
			s.PRODUCT_BUSINESS_CATEGORY,
			s.PRODUCT_VALUE_CODE_1,
			s.PRODUCT_VALUE_CODE_2,
			s.LINE_OF_BUSINESS,
			s.COB_CARRIER_CODE_1,
			s.COB_CARRIER_NAME_1,
			s.COB_POLICY_NUMBER_1,
			s.COB_CODE_1,
			s.COB_EFFECTIVE_DATE_1,
			s.COB_TERM_DATE_1,
			s.ENTITLEMENT_CODE_1,
			s.COB_CARRIER_CODE_2,
		    s.COB_CARRIER_NAME_2,
			s.COB_POLICY_NUMBER_2,
			s.COB_CODE_2,
			s.COB_EFFECTIVE_DATE_2,
			s.COB_TERM_DATE_2,
			s.ENTITLEMENT_CODE_2,
			s.RECORD_TYPE,
			s.RELATIONSHIP_CODE,
			s.ELIGIBILITY_STATUS,
			s.GROUP_ID,
			s.GROUP_NAME,
			s.SUBGROUP_ID,
			s.SUBGROUP_NAME,
			s.PRODUCT_ID,
			s.NETWORK_ID,
			s.NETWORK_NAME,
			'Y',
			'N',
			@sys_date,
			@sys_date,
			@sys_user,
			@sys_date,
			@sys_user,
			NULL,
			s.HAP_NUMBER
			FROM #HAP_Elig_Member_Status t
			JOIN [ELIG].[StgELGHAP] s ON (s.HAP_NUMBER = t.NHLinkID and t.MemberStatus = 'N')

		-- New Member - End
		
		
		-- Existing Member - Start
		
			-- Update Members
			UPDATE m
			SET m.FirstName = st.FIRST_NAME,
			m.LastName = st.LAST_NAME,
			m.MiddleName = st.MIDDLE_INITIAL,
			m.DOB = CAST(st.DATE_OF_BIRTH AS DATE),
			m.ToBeProcessed = 'Y',
			m.StatusFlag = 'U',
			m.ModifyDate = @sys_date,
			m.ModifyUser = @sys_user
			FROM ELIG.Members m
			JOIN #HAP_Elig_Member_Status t on (t.NHLinkID = m.NHLinkID and t.MemberStatus = 'U')
			JOIN [ELIG].[StgELGHAP] st on ( st.HAP_NUMBER=m.NHLinkID AND (st.FIRST_NAME!=m.FirstName OR st.LAST_NAME!=m.LastName OR CAST(st.DATE_OF_BIRTH AS DATE)!=m.DOB))
			WHERE 1=1
			AND m.DataSource='ELIG_HAP' 

			-- Terminate Members
			UPDATE m
			SET m.ToBeProcessed = 'Y',
			m.StatusFlag = 'T',
			m.ModifyDate = @sys_date,
			m.ModifyUser = @sys_user
			FROM ELIG.Members m
			JOIN #HAP_Elig_Member_Status t on (t.NHLinkID = m.NHLinkID and t.MemberStatus = 'T')
			WHERE 1=1
			AND m.DataSource='ELIG_HAP' 

			
			-- Update Insurance

			-- Case when there are changes in plan detials or Termiantion date (no change in effective date)
			UPDATE i
			SET i.PlanID = st.PLAN_ID,
			i.PlanCode = st.PLAN_CODE,
			i.[EligTerminationDate] = CAST(st.TERMINATION_DATE AS DATE),
			i.SubscriberID = st.SUBSCRIBER_ID+st.MEMBER_SUFFIX,
			i.GroupNbr = st.GROUP_ID,
			i.SubGroupNbr = st.SUBGROUP_ID,
			--i.MemberSuffix = st.MEMBER_SUFFIX,
			i.ToBeProcessed = 'Y',
			i.StatusFlag = 'U',
			i.ModifyDate = @sys_date,
			i.ModifyUser = @sys_user
			FROM ELIG.Insurances i
			JOIN #HAP_Elig_Member_Status t on (t.NHLinkID = i.NHLinkID and t.MemberStatus = 'U')
			JOIN ELIG.StgELGHAP st on (i.IsActive = 1 AND i.NHLinkID=st.HAP_NUMBER AND i.EligEffectiveDate=CAST(st.EFFECTIVE_DATE AS DATE)
			                           AND (i.PlanID != st.PLAN_ID OR i.PlanCode != st.PLAN_CODE OR i.[EligTerminationDate] != CAST(st.TERMINATION_DATE AS DATE) OR i.SubscriberID != (st.SUBSCRIBER_ID+st.MEMBER_SUFFIX)
									          OR i.GroupNbr != st.GROUP_ID OR i.SubGroupNbr != st.SUBGROUP_ID ) )
			WHERE 1=1
			AND i.DataSource='ELIG_HAP'  

			-- End date records which has change in Eligibility dates			

		
			-- Insert new records when there is change in Effective Date
			INSERT INTO ELIG.Insurances (
			--NHInsuranceID,
			DataSource, 
			[InsMemberNbr], 
			PlanID,
			PlanCode,
			[EligEffectiveDate],
			[EligTerminationDate],
			SubscriberID,
			GroupNbr,
			SubGroupNbr,
			--MemberSuffix,
			[ToBeProcessed],
			[StatusFlag],
			[ProcessedDate],
			[CreateDate],
			[CreateUser],
			[ModifyDate],
			[ModifyUser],
			healthplanid,
			mastermemberid,
			memberinsuranceid,
			[NHLinkID],
			IsActive
			)
			SELECT 
			--NULL,
			'ELIG_HAP',
			st.HAP_NUMBER,
			st.PLAN_ID,
			st.PLAN_CODE,
			CAST(st.EFFECTIVE_DATE AS DATE),
			CAST(st.TERMINATION_DATE AS DATE),
			st.SUBSCRIBER_ID+st.MEMBER_SUFFIX,
			st.GROUP_ID,
			st.SUBGROUP_ID,
			--st.MEMBER_SUFFIX,
			'Y',
			'N',
			@sys_date,
			@sys_date,
			@sys_user,
			@sys_date,
			@sys_user,
			NULL,
			NULL,
			NULL,
			st.HAP_NUMBER,
			1
			FROM ELIG.Insurances i
			JOIN #HAP_Elig_Member_Status t on (t.NHLinkID = i.NHLinkID and t.MemberStatus = 'U')
			JOIN ELIG.StgELGHAP st on ( i.IsActive = 1 AND i.NHLinkID=st.HAP_NUMBER AND i.[EligEffectiveDate]!=CAST(st.EFFECTIVE_DATE AS DATE))
			WHERE 1=1
			AND i.DataSource='ELIG_HAP'

			-- update termination date for old record
			UPDATE i
			SET i.[EligTerminationDate] = CASE WHEN CAST(st.EFFECTIVE_DATE AS DATE)>i.[EligTerminationDate] THEN i.[EligTerminationDate] -- verify
											   WHEN CAST(st.EFFECTIVE_DATE AS DATE)<i.[EligTerminationDate] AND CAST(st.EFFECTIVE_DATE AS DATE)<i.[EligEffectiveDate] THEN DATEADD(dd,-1,i.[EligEffectiveDate])
											   --WHEN CAST(st.EFFECTIVE_DATE AS DATE)>i.[EligTerminationDate] AND CAST(st.EFFECTIVE_DATE AS DATE)>i.[EligEffectiveDate] THEN i.[EligTerminationDate]
			                                   WHEN CAST(st.EFFECTIVE_DATE AS DATE)<i.[EligTerminationDate] AND CAST(st.EFFECTIVE_DATE AS DATE)>i.[EligEffectiveDate] THEN DATEADD(dd,-1,CAST(st.EFFECTIVE_DATE AS DATE)) 
											   ELSE i.[EligTerminationDate] END,
			i.IsActive = 0,
			i.ToBeProcessed = 'Y',
			i.StatusFlag = 'U',
			i.ModifyDate = @sys_date,
			i.ModifyUser = @sys_user
			FROM ELIG.Insurances i
			JOIN #HAP_Elig_Member_Status t on (t.NHLinkID = i.NHLinkID and t.MemberStatus = 'U')
			JOIN ELIG.StgELGHAP st on ( i.IsActive = 1 AND i.NHLinkID=st.HAP_NUMBER AND i.[EligEffectiveDate]!=CAST(st.EFFECTIVE_DATE AS DATE)) 
			WHERE 1=1
			AND i.DataSource='ELIG_HAP'


			-- End date insurance if members are terminated
			UPDATE i
			SET i.[EligTerminationDate] = DATEADD(dd,-1,@sys_date),
			i.ToBeProcessed = 'Y',
			i.StatusFlag = 'T',
			i.ModifyDate = @sys_date,
			i.ModifyUser = @sys_user
			FROM ELIG.Insurances i
			JOIN #HAP_Elig_Member_Status t on (t.NHLinkID = i.NHLinkID and t.MemberStatus = 'T')
			WHERE 1=1
			AND i.DataSource='ELIG_HAP' 


	
		
			-- Insert there is change in PCP Info.
			INSERT INTO ELIG.PCP (
			[DataSource]
			--,[CarrierMemberID]
			,[RecordEffectiveDate]
			,[RecordEndDate]
			,[PCPNPID]
			,[PCPName],
			[ToBeProcessed],
			[StatusFlag],
			--[ProcessedDate],
			[CreateDate],
			[CreateUser],
			[ModifyDate],
			[ModifyUser],
			mastermemberid,
			[NHLinkID],
			[IsActive]
			)
			SELECT 
			'ELIG_HAP',
			--st.HAP_NUMBER,
			@sys_date,
			CAST('21991231' AS DATE),
			st.NATIONAL_PROVIDER_ID,
			st.PCP_NAME,		
			'Y',
			'N',
			--@sys_date,
			@sys_date,
			@sys_user,
			@sys_date,
			@sys_user,
			NULL,
			st.HAP_NUMBER
			,1
			FROM ELIG.PCP p
			JOIN #HAP_Elig_Member_Status t on (t.NHLinkID = p.NHLinkID and t.MemberStatus = 'U')
			JOIN ELIG.StgELGHAP st on (p.IsActive=1 AND p.NHLinkID=st.HAP_NUMBER AND (p.PCPNPID!=st.NATIONAL_PROVIDER_ID OR p.PCPName!=st.PCP_NAME))
			WHERE 1=1
			AND p.DataSource='ELIG_HAP'

			-- End date prevoious record
			UPDATE p
			SET p.[RecordEndDate] = DATEADD(dd,-1,@sys_date),
			p.IsActive=0,
			P.ToBeProcessed = 'Y',
			p.StatusFlag = 'U',
			p.ModifyDate = @sys_date,
			p.ModifyUser = @sys_user
			FROM ELIG.PCP p
			JOIN #HAP_Elig_Member_Status t on (t.NHLinkID = p.NHLinkID and t.MemberStatus = 'U')
			JOIN ELIG.StgELGHAP st on ( p.IsActive=1 AND p.NHLinkID=st.HAP_NUMBER AND (p.PCPNPID!=st.NATIONAL_PROVIDER_ID OR p.PCPName!=st.PCP_NAME)) 
			WHERE 1=1
			AND p.DataSource='ELIG_HAP'


			-- End date record if member is terminated
			UPDATE p
			SET p.RecordEndDate = DATEADD(dd,-1,@sys_date),
			p.ToBeProcessed = 'Y',
			p.StatusFlag = 'T',
			p.ModifyDate = @sys_date,
			p.ModifyUser = @sys_user
			FROM ELIG.PCP p
			JOIN #HAP_Elig_Member_Status t on (t.NHLinkID = p.NHLinkID and t.MemberStatus = 'T')
			WHERE 1=1
			AND p.DataSource='ELIG_HAP' 



			-- Insert if there is change in Address.
			INSERT INTO ELIG.AddressInfo (
			[DataSource]
			--,[CarrierMemberID]
			,[RecordEffectiveDate]
			,[RecordEndDate]
			,[PrimaryPhoneNbr]
			,[SecondaryPhoneNbr]
			,[AddressLine1]
			,[AddressLine2]
			,[City]
			,[State]
			,[ZipCode]
			,[County]
			,[Country],
			[ToBeProcessed],
			[StatusFlag],
			--[ProcessedDate],
			[CreateDate],
			[CreateUser],
			[ModifyDate],
			[ModifyUser],
			mastermemberid,
			[NHLinkID],
			[IsActive]
			)
			SELECT 
			'ELIG_HAP',
			--st.HAP_NUMBER,
			@sys_date,
			CAST('21991231' AS DATE),
			st.HOME_PHONE_NUMBER,
			st.BUSINESS_PHONE_NUMBER,	
			st.ADDRESS_LINE_1,
			st.ADDRESS_LINE_2,
			st.CITY,
			st.STATE,
			st.ZIP_CODE,
			NULL,
			st.COUNTRY,	
			'Y',
			'N',
			--@sys_date,
			@sys_date,
			@sys_user,
			@sys_date,
			@sys_user,
			NULL,
			st.HAP_NUMBER
			,1
			FROM ELIG.AddressInfo a
			JOIN #HAP_Elig_Member_Status t on (t.NHLinkID = a.NHLinkID and t.MemberStatus = 'U')
			JOIN ELIG.StgELGHAP st on ( a.IsActive=1 AND a.NHLinkID=st.HAP_NUMBER 
			AND (a.[PrimaryPhoneNbr]!=st.HOME_PHONE_NUMBER OR a.[SecondaryPhoneNbr]!=st.BUSINESS_PHONE_NUMBER OR a.AddressLine1!=st.ADDRESS_LINE_1 OR a.AddressLine2!=st.ADDRESS_LINE_2
			     OR a.City!=st.CITY OR a.State!=st.STATE OR a.ZipCode!=st.ZIP_CODE OR a.Country!=st.COUNTRY)  )
			WHERE 1=1
			AND a.DataSource='ELIG_HAP'

			-- End date prevoious record
			UPDATE a
			SET a.RecordEndDate = DATEADD(dd,-1,@sys_date),
			a.IsActive=0,
			a.ToBeProcessed = 'Y',
			a.StatusFlag = 'U',
			a.ModifyDate = @sys_date,
			a.ModifyUser = @sys_user
			FROM ELIG.AddressInfo a
			JOIN #HAP_Elig_Member_Status t on (t.NHLinkID = a.NHLinkID and t.MemberStatus = 'U')
			JOIN ELIG.StgELGHAP st on ( a.IsActive=1 AND a.NHLinkID=st.HAP_NUMBER 
			AND (a.PrimaryPhoneNbr!=st.HOME_PHONE_NUMBER OR a.[SecondaryPhoneNbr]!=st.BUSINESS_PHONE_NUMBER OR a.AddressLine1!=st.ADDRESS_LINE_1 OR a.AddressLine2!=st.ADDRESS_LINE_2
			     OR a.City!=st.CITY OR a.State!=st.STATE OR a.ZipCode!=st.ZIP_CODE OR a.Country!=st.COUNTRY)  ) 
			WHERE 1=1
			AND a.DataSource='ELIG_HAP'


			-- End date record if members are terminated
			UPDATE a
			SET a.RecordEndDate = DATEADD(dd,-1,@sys_date),
			a.ToBeProcessed = 'Y',
			a.StatusFlag = 'T',
			a.ModifyDate = @sys_date,
			a.ModifyUser = @sys_user
			FROM ELIG.AddressInfo a
			JOIN #HAP_Elig_Member_Status t on (t.NHLinkID = a.NHLinkID and t.MemberStatus = 'T')
			WHERE 1=1
			AND a.DataSource='ELIG_HAP' 


			-- Updates on OtherInfo
			SELECT HAP_NUMBER
			into #HAP_Elig_Member_OtherInfo
			FROM(			
						SELECT distinct
						s.HAP_NUMBER,
						s.CASE_MANAGEMENT_FLAG,
						s.PRODUCT_BUSINESS_CATEGORY,
						s.PRODUCT_VALUE_CODE_1,
						s.PRODUCT_VALUE_CODE_2,
						s.LINE_OF_BUSINESS,
						s.COB_CARRIER_CODE_1,
						s.COB_CARRIER_NAME_1,
						s.COB_POLICY_NUMBER_1,
						s.COB_CODE_1,
						s.COB_EFFECTIVE_DATE_1,
						s.COB_TERM_DATE_1,
						s.ENTITLEMENT_CODE_1,
						s.COB_CARRIER_CODE_2,
						s.COB_CARRIER_NAME_2,
						s.COB_POLICY_NUMBER_2,
						s.COB_CODE_2,
						s.COB_EFFECTIVE_DATE_2,
						s.COB_TERM_DATE_2,
						s.ENTITLEMENT_CODE_2,
						s.RECORD_TYPE,
						s.RELATIONSHIP_CODE,
						s.ELIGIBILITY_STATUS,
						s.GROUP_ID,
						s.GROUP_NAME,
						s.SUBGROUP_ID,
						s.SUBGROUP_NAME,
						s.PRODUCT_ID,
						s.NETWORK_ID,
						s.NETWORK_NAME
						FROM [ELIG].[StgELGHAP] s

						EXCEPT

						select distinct
						--[CarrierMemberID]
						NHLinkID
						,[vcField1]
						,[vcField2]
						,[vcField3]
						,[vcField4]
						,[vcField5]
						,[vcField6]
						,[vcField7]
						,[vcField8]
						,[vcField9]
						,[vcField10]
						,[vcField11]
						,[vcField12]
						,[vcField13]
						,[vcField14]
						,[vcField15]
						,[vcField16]
						,[vcField17]
						,[vcField18]
						,[vcField19]
						,[vcField20]
						,[vcField21]
						,[vcField22]
						,[vcField23]
						,[vcField24]
						,[vcField25]
						,[vcField26]
						,[vcField27]
						,[vcField28]
						,[vcField29]
						from elig.OtherInfo
						WHERE DataSource='ELIG_HAP'
			) a


			
			-- Update OtherInfo if there are any changes
			UPDATE o
			SET
			o.vcField1=st.CASE_MANAGEMENT_FLAG,
			o.vcField2=st.PRODUCT_BUSINESS_CATEGORY,
			o.vcField3=st.PRODUCT_VALUE_CODE_1,
			o.vcField4=st.PRODUCT_VALUE_CODE_2,
			o.vcField5=st.LINE_OF_BUSINESS,
			o.vcField6=st.COB_CARRIER_CODE_1,
			o.vcField7=st.COB_CARRIER_NAME_1,
			o.vcField8=st.COB_POLICY_NUMBER_1,
			o.vcField9=st.COB_CODE_1,
			o.vcField10=st.COB_EFFECTIVE_DATE_1,
			o.vcField11=st.COB_TERM_DATE_1,
			o.vcField12=st.ENTITLEMENT_CODE_1,
			o.vcField13=st.COB_CARRIER_CODE_2,
			o.vcField14=st.COB_CARRIER_NAME_2,
			o.vcField15=st.COB_POLICY_NUMBER_2,
			o.vcField16=st.COB_CODE_2,
			o.vcField17=st.COB_EFFECTIVE_DATE_2,
			o.vcField18=st.COB_TERM_DATE_2,
			o.vcField19=st.ENTITLEMENT_CODE_2,

			o.vcField20=st.RECORD_TYPE,
			o.vcField21=st.RELATIONSHIP_CODE,
			o.vcField22=st.ELIGIBILITY_STATUS,
			o.vcField23=st.GROUP_ID,
			o.vcField24=st.GROUP_NAME,
			o.vcField25=st.SUBGROUP_ID,
			o.vcField26=st.SUBGROUP_NAME,
			o.vcField27=st.PRODUCT_ID,
			o.vcField28=st.NETWORK_ID,
			o.vcField29=st.NETWORK_NAME,
			o.ToBeProcessed = 'Y',
			o.StatusFlag = 'U',
			o.ModifyDate = @sys_date,
			o.ModifyUser = @sys_user
			FROM ELIG.OtherInfo o
			JOIN #HAP_Elig_Member_OtherInfo t ON (t.HAP_NUMBER = o.NHLinkID)
			JOIN ELIG.StgELGHAP st ON  ( o.NHLinkID=st.HAP_NUMBER )
			WHERE 1=1
			AND o.DataSource='ELIG_HAP'


			-- Update healthplanID based on HAP_Link table
			UPDATE i
			SET i.HealthPlanID = l.InsuranceHealthPlanID
			FROM ELIG.Insurances i
			--JOIN #HAP_Elig_Member_Status t on (t.NHLinkID = i.NHLinkID and t.MemberStatus IN ('N','U'))
			LEFT JOIN [ELIG].[HAP_LINK] l ON (i.GroupNbr = l.GroupID AND i.SubGroupNbr = l.SubGroupID)
			WHERE 1=1
			AND i.DataSource='ELIG_HAP'

		
		-- Existing Member - End
		
		DROP TABLE #HAP_Elig_Member_Status
	   DROP TABLE #HAP_Elig_Member_OtherInfo
	--DROP TABLE #HAP_Elig_StgExistingMembers
	
	COMMIT TRANSACTION member_load_stg_to_elig_HAP
	PRINT 'SUCCESS'
	

	END TRY
	

	BEGIN CATCH

	DECLARE @ErrorMessage NVARCHAR(4000);  
    DECLARE @ErrorSeverity INT;  
    DECLARE @ErrorState INT;  

    SELECT   
        @ErrorMessage = ERROR_MESSAGE(),  
        @ErrorSeverity = ERROR_SEVERITY(),  
        @ErrorState = ERROR_STATE();  

		IF (@@TRANCOUNT > 0)
		BEGIN
			ROLLBACK TRANSACTION member_load_stg_to_elig_HAP
			RAISERROR(@ErrorMessage,@ErrorSeverity,@ErrorState);
			PRINT 'FAILED'
		END

	END CATCH

END	




-- EXEC [ELIG].[elig_file_load_ssis_sp_merge_elig_HAP_to_master] 

CREATE PROCEDURE [elig].[elig_file_load_ssis_sp_merge_elig_HAP_to_master]


AS

BEGIN
	BEGIN TRY
	BEGIN TRANSACTION member_load_elig_to_master_HAP

DECLARE @sys_user CHAR(30)
	   ,@sys_date DATETIME;  

SET @sys_user = SYSTEM_USER
--SET @sys_date = CAST(GETDATE() AS DATE);  
SET @sys_date = CAST(GETDATE() AT TIME ZONE 'UTC' AT TIME ZONE 'Eastern Standard Time' AS DATETIME);  -- Time in EST



	-- drop not null record insert constraint (unique index) on NHMemberID in master.members before inserting new members or updating NHMemberID for new records inserted

		ALTER TABLE [Master].[Members] DROP CONSTRAINT [IX_Members_NHMemberID_U]



		MERGE Master.Members d
              USING ( SELECT * FROM [ELIG].[Members] WHERE  DataSource='ELIG_HAP' AND ToBeProcessed = 'Y' AND StatusFlag in ('N','U')) s
              ON (d.memberid = s.mastermemberid )

              WHEN MATCHED THEN
                                                                               
              UPDATE SET
              d.EligFile = 'ELIG_HAP',
              d.eligFileID = s.ID,
              d.DateOfBirth = s.[DOB],
              d.FirstName = s.FirstName,
              d.Gender = s.Gender,
              d.IsActive = 1,
              d.LastName = s.LastName,
              d.MiddleInitial = s.MiddleName,
              d.ModifyDate = @sys_date,
              d.ModifyUser = @sys_user

              WHEN NOT MATCHED THEN

              INSERT ( 
					  CreateDate,
                      CreateUser,
                      DataSource,
                      DateOfBirth,
                      FirstName,
                      Gender,
                      IsActive,
                      LastName,
                      MiddleInitial,
                      ModifyDate,
                      ModifyUser,
                      EligFile,
                      EligFileID)  
                      VALUES 
                      (
                      @sys_date
              ,@sys_user
              ,'ELIG_HAP'
              ,DOB
              ,FirstName
              ,Gender
              ,1
              ,LastName
              ,MiddleName
              ,@sys_date
              ,@sys_user
              ,'ELIG_HAP'
              ,ID
              );


		
		-- Assign mastermemberid in AnthemMembers after inserting new records into master.members
		UPDATE a 
        SET a.MasterMemberID = (SELECT memberid FROM [Master].[Members] m where m.EligFileID = a.id and m.EligFile = 'ELIG_HAP')
        FROM [ELIG].[Members] a
        WHERE 1=1
		AND a.tobeprocessed = 'Y'                                                     
        AND a.mastermemberid IS NULL



		-- Update NHMemberID for newly inserted members
		UPDATE [Master].[Members]
		SET nhmemberid = 'NH'+RIGHT(YEAR(GETDATE()),4)+ FORMAT(memberid,'00000000')							 --    'NH2018'+ FORMAT(memberid,'00000000')
		WHERE EligFile = 'ELIG_HAP'
		AND nhmemberid IS NULL

		-- Re create the unique NHMemberID index
		ALTER TABLE [Master].[Members] ADD  CONSTRAINT [IX_Members_NHMemberID_U] UNIQUE NONCLUSTERED 
		(
			[NHMemberID] ASC
		)
	

		---- Assign mastermemberid to AnthemInsurance records from AnthemMembers joining on newNHLinkID			
		--UPDATE i
		--SET mastermemberid = ( SELECT mastermemberid FROM [anthemelig].[AnthemMembers] m WHERE m.newNHLinkID = i.newNHLinkID )
		--FROM [anthemelig].[AnthemInsurance] i
		--WHERE EXISTS (SELECT 1 FROM [anthemelig].[AnthemMembers] m1 WHERE m1.newNHLinkID = i.newNHLinkID)
		--AND i.mastermemberid IS NULL

		-- Assign mastermemberid to ELIG Insurance from Members
		--update a 
		--set a.mastermemberid  = (select m.mastermemberid from elig.members m where m.nhlinkid = a.nhlinkid)
		--from ELIG.insurances a

		update a 
		set a.mastermemberid  =  m.mastermemberid 
		-- select a.mastermemberid  ,  m.mastermemberid 
		from ELIG.insurances a
		join ELIG.members m on m.NHLinkID=a.NHLinkID

		-- Assign mastermemberid to ELIG AddressInfo from Members
		--update a 
		--set a.mastermemberid  = (select m.mastermemberid from elig.members m where m.nhlinkid = a.nhlinkid)
		--from ELIG.AddressInfo a

		update a 
		set a.mastermemberid  =  m.mastermemberid 
		-- select a.mastermemberid  ,  m.mastermemberid 
		from ELIG.AddressInfo a
		join elig.members m on m.NHLinkID=a.NHLinkID

	
		-- 
		MERGE Master.addresses d
              USING (SELECT * FROM ELIG.AddressInfo WHERE tobeprocessed = 'Y' AND StatusFlag in ('N','U') and IsActive=1 and mastermemberid is not null) s
              ON (d.memberid = s.mastermemberid AND d.AddressTypeCode = 'PERM')
              WHEN MATCHED THEN
              UPDATE SET
              Address1 = s.[AddressLine1]
              ,Address2 = s.[AddressLine2]
              ,City = s.[City]
              ,State = s.[State]
              ,ZipCode = s.[ZipCode]
              ,EffectiveFromDate = [RecordEffectiveDate]
              ,EffectiveToDate = [RecordEndDate]
              ,IsActive = 1
              ,IsPreferredAddress = 1
              ,MemberID = s.mastermemberid
              ,ModifyDate = @sys_date
              , ModifyUser = @sys_user
              WHEN NOT MATCHED THEN
              INSERT (
              Address1
              ,Address2
              ,AddressTypeCode
              ,City
              ,State
              ,ZipCode
              ,EffectiveFromDate
              ,EffectiveToDate
              ,IsActive
              ,IsPreferredAddress
              ,MemberID
              ,CreateDate
              ,CreateUser
              ,ModifyDate
              , ModifyUser
              )
              VALUES(
              s.[AddressLine1]
              ,s.[AddressLine2]
              ,'PERM'
              ,s.[City]
              ,s.[State]
              ,s.[ZipCode]
              , [RecordEffectiveDate]
              , [RecordEndDate]
              ,1 
              ,1 
              ,s.[mastermemberid]
              ,@sys_date
              ,@sys_user
              ,@sys_date
              ,@sys_user);
			
			  
              MERGE Master.PhoneNumbers d
              USING (SELECT * FROM ELIG.AddressInfo WHERE tobeprocessed = 'Y' AND StatusFlag in ('N','U') and IsActive=1 and mastermemberid is not null) s
              ON (d.memberid = s.mastermemberid) --AND d.PhoneTypeCode = 'HOME')
              WHEN MATCHED THEN
              UPDATE SET
              CountryCode = '001'
              ,PhoneNbr = s.PrimaryPhoneNbr
              ,EffectiveFromDate = [RecordEffectiveDate]
              ,EffectiveToDate = [RecordEndDate]
              , IsActive = 1
              ,MemberID = s.mastermemberid
              , ModifyDate = @sys_date
              , ModifyUser = @sys_user
              WHEN NOT MATCHED THEN
              INSERT (
              CountryCode
              ,PhoneNbr
              , PhoneTypeCode
              , EffectiveFromDate
              ,EffectiveToDate
              , IsActive
              ,IsPreferredPhoneNumber
              ,MemberID
              ,CreateDate
              , CreateUser
              , ModifyDate
              , ModifyUser
              )
              VALUES ( 
              '001' 
              ,s.PrimaryPhoneNbr
              ,'HOME' 
              ,[RecordEffectiveDate]
              , [RecordEndDate]
              ,1 
              ,0 
              ,s.[mastermemberid] 
              ,@sys_date 
              ,@sys_user
              ,@sys_date 
              ,@sys_user );
			  

			  --
			  MERGE [master].[MemberInsurances] d
              USING (SELECT * FROM ELIG.Insurances WHERE tobeprocessed = 'Y' and mastermemberid is not null) s --AND StatusFlag in ('N','U')) s
              ON (s.masterMemberId = d.MemberID and s.[EligEffectiveDate] = d.InsuranceEffectiveDate)
              WHEN MATCHED THEN
              UPDATE SET
              --InsuranceEndDate = case statusflag when 'D' then cast(getdate()-1 as date) else EligibilityTerminationDate end, this will be statement for all but now exception
              InsuranceEndDate = CASE statusflag WHEN 'T' THEN (CASE WHEN DATEDIFF(dd, cast(d.InsuranceEndDate AS DATE), CAST(GETDATE()-1 AS DATE)) < 0 THEN CAST(GETDATE()-1 AS DATE) ELSE s.[EligTerminationDate] END  )  ELSE s.[EligTerminationDate] END,
              InsuranceHealthPlanID = s.healthplanid,
              --IsActive = CASE statusflag WHEN 'D' THEN 0 ELSE 1 END,
              IsActive = s.IsActive,
              ModifyDate = @sys_date,
              ModifyUser = @sys_user,
              eligFileID = s.ID,
              eligFile = 'ELIG_HAP'
              WHEN NOT MATCHED THEN
              INSERT (
              CreateDate,
              CreateUser,
              InsuranceCarrierID,
              InsuranceEffectiveDate,
              InsuranceEndDate,
              InsuranceHealthPlanID,
              IsActive,
              MemberID,
              ModifyDate,
              ModifyUser,
              eligFileID,
              eligFile)
              VALUES (
              @sys_date
              ,@sys_user
              ,212  -- change the value
              ,s.EligEffectiveDate 
              ,s.EligTerminationDate 
              ,s.[healthplanid] 
              ,s.IsActive 
              ,mastermemberid 
              ,@sys_date
              ,@sys_user,s.ID , 'ELIG_HAP');

              --
              MERGE Master.MemberInsuranceDetails d
              USING (SELECT * FROM ELIG.Insurances WHERE tobeprocessed = 'Y' and mastermemberid is not null) s --and memberinsuranceid is not null
              ON (d.MemberInsuranceID = s.memberinsuranceid )
			  --AND s.SubscriberID=d.InsuranceNbr)

              WHEN MATCHED THEN 

              UPDATE SET
              GroupNbr = s.GroupNbr,
              InsuranceNbr = s.subscriberID,
              IsInsuranceEligibilityVerified = 1,
              ModifyDate = @sys_date,
              ModifyUser = @sys_user,
              ISActive = s.IsActive
              WHEN NOT MATCHED THEN
              INSERT (
              CreateDate
              , CreateUser
              ,GroupNbr
              ,InsuranceNbr
              ,IsActive
              ,IsInsuranceEligibilityVerified
              ,MemberInsuranceID
              ,ModifyDate
              ,ModifyUser
              )
              VALUES ( 
              @sys_date
              ,@sys_user
              ,s.GroupNbr
              , s.subscriberID
              ,s.IsActive
              ,1
              ,s.MemberInsuranceID
              ,@sys_date
              ,@sys_user
              );


			update i
			set memberinsuranceid = (select m.id from master.memberinsurances m where m.memberid = i.mastermemberid and m.eligFileID = i.ID and m.insurancecarrierid = 212 and eligfile = 'ELIG_HAP')
			from ELIG.Insurances i
			where tobeprocessed = 'Y'
			--and memberinsuranceid is null



	COMMIT TRANSACTION member_load_elig_to_master_HAP
	PRINT 'SUCCESS'
	
	--DROP TABLE #HAP_Elig_StgExistingMembers

	END TRY
	

	BEGIN CATCH

	DECLARE @ErrorMessage NVARCHAR(4000);  
    DECLARE @ErrorSeverity INT;  
    DECLARE @ErrorState INT;  

    SELECT   
        @ErrorMessage = ERROR_MESSAGE(),  
        @ErrorSeverity = ERROR_SEVERITY(),  
        @ErrorState = ERROR_STATE();  

		IF (@@TRANCOUNT > 0)
		BEGIN
			ROLLBACK TRANSACTION member_load_elig_to_master_HAP
			RAISERROR(@ErrorMessage,@ErrorSeverity,@ErrorState);
			PRINT 'FAILED'
		END

	END CATCH;



END

-- EXEC [elig].[elig_file_load_ssis_sp_merge_HAP] 'HAP'

CREATE PROCEDURE [elig].[elig_file_load_ssis_sp_merge_HAP] 
@Client_Name varchar(20)
AS

BEGIN

	BEGIN TRY
	BEGIN TRANSACTION member_load_elig_HAP


		EXEC [elig].[elig_file_load_ssis_sp_merge_stg_to_elig_HAP]

		EXEC [elig].[elig_file_load_ssis_sp_merge_elig_HAP_to_master]

	COMMIT TRANSACTION member_load_elig_HAP
	PRINT 'SUCCESS'
	

	END TRY
	

	BEGIN CATCH

	DECLARE @ErrorMessage NVARCHAR(4000);  
    DECLARE @ErrorSeverity INT;  
    DECLARE @ErrorState INT;  

    SELECT   
        @ErrorMessage = ERROR_MESSAGE(),  
        @ErrorSeverity = ERROR_SEVERITY(),  
        @ErrorState = ERROR_STATE();  

		IF (@@TRANCOUNT > 0)
		BEGIN
			ROLLBACK TRANSACTION member_load_elig_HAP
			RAISERROR(@ErrorMessage,@ErrorSeverity,@ErrorState);
			PRINT 'FAILED'
		END

	END CATCH
END

create view elig.ViewBSInsurance as
SELECT	
	 MemberIdentificationNumber NHLinkID,
	MemberIdentificationNumber,
	null EligPlanNbr,
    EligibilityEffectiveDate,
	EligibilityTerminationDate,
	GroupNumber,
	InsLine,
	PlanCoverage,
	CoverageLevel,
	Subscriber,
	RelationShipCode,
	BenefitStatusCode,
	MedicareStatusCode,
	EmploymentStatusCode,
	MaintenanceEffectiveDate
FROM elig.BSStgEligData 
--where EligibilityTerminationDate > getdate()  and MedicaidTerminationDate > MedicaidEffectiveDate
where (EligibilityTerminationDate > cast('20190430' as date)) or EligibilityTerminationDate =''
EXCEPT 
SELECT 
	NHLinkID,
	MemberIdentificationNumber,
	EligPlanNbr,
	EligibilityEffectiveDate,
	EligibilityTerminationDate,
	GroupNumber,
	InsLine,
	PlanCoverage,
	CoverageLevel,
	Subscriber,
	RelationShipCode,
	BenefitStatusCode,
	MedicareStatusCode,
	EmploymentStatusCode,
	MaintenanceEffectiveDate
FROM elig.BSInsurance
where statusflag not in ('D','O')


create view elig.ViewBSInsNotRcvd as
SELECT 
	 NHLinkID,
	MemberIdentificationNumber,
	EligPlanNbr,
	EligibilityEffectiveDate,
	EligibilityTerminationDate,
	GroupNumber
	InsLine,
	PlanCoverage,
	CoverageLevel,
	Subscriber,
	RelationShipCode,
	BenefitStatusCode,
	MedicareStatusCode,
	EmploymentStatusCode,
	MaintenanceEffectiveDate
FROM elig.BSInsurance
where statusflag not in ('D','O')
EXCEPT
SELECT	
	MemberIdentificationNumber NHLinkID,
	MemberIdentificationNumber,
	null EligPlanNbr,
	EligibilityEffectiveDate,
	EligibilityTerminationDate,
	GroupNumber
	InsLine,
	PlanCoverage,
	CoverageLevel,
	Subscriber,
	RelationShipCode,
	BenefitStatusCode,
	MedicareStatusCode,
	EmploymentStatusCode,
	MaintenanceEffectiveDate
FROM elig.BSStgEligData 

create view elig.ViewBSMembers as 
SELECT  DISTINCT MemberIdentificationNumber NHLinkID,
		MemberIdentificationNumber,
		MembersDateOfBirth,
		null ClientNumber,
		MemberLastName,
		MemberFirstName,
		MemberMiddleName,
		null SocialSecurityNumber,
		MemberPhoneNumber,
		MemberAddressLine1,
		MemberAddressLine2,
		MemberCityName,
		MemberStateName,
		MemberZipCode,
		MemberDateOfDeath,
		MemberSex,
		MemberRace,
		MemberMaritalStatus,
		MemberLanguage,
		MemberMailingAddressLine1,
		MemberMailingAddressLine2,
		MemberMailingCityName,
		MemberMailingStateName,
		MemberMailingZipCode
		from elig.bsStgEligData
EXCEPT
SELECT 
		NHLinkID,
		MemberIdentificationNumber,
		MembersDateOfBirth,
		ClientNumber,
		MemberLastName,
		MemberFirstName,
		MemberMiddleName,
		SocialSecurityNumber,
		cast(MemberPhoneNumber as varchar) MemberPhoneNumber,
		MemberAddressLine1,
		MemberAddressLine2,
		MemberCityName,
		MemberStateName,
		MemberZipCode,
		MemberDateOfDeath,
		MemberSex,
		MemberRace,
		MemberMaritalStatus,
		MemberLanguage,
		MemberMailingAddressLine1,
		MemberMailingAddressLine2,
		MemberMailingCityName,
		MemberMailingStateName,
		MemberMailingZipCode
from elig.bsMembers
where statusflag not in ('D','O')



create view elig.ViewBSMemNotRcvd as
SELECT  NHLinkID,
		MemberIdentificationNumber,
		MembersDateOfBirth,
		ClientNumber,
		MemberLastName,
		MemberFirstName,
		MemberMiddleName,
		SocialSecurityNumber,
		cast(MemberPhoneNumber as varchar) MemberPhoneNumber ,
		MemberAddressLine1,
		MemberAddressLine2,
		MemberCityName,
		MemberStateName,
		MemberZipCode,
		MemberDateOfDeath,
		MemberSex,
		MemberRace,
		MemberMaritalStatus,
		MemberLanguage,
		MemberMailingAddressLine1,
		MemberMailingAddressLine2,
		MemberMailingCityName,
		MemberMailingStateName,
		MemberMailingZipCode
from elig.BSMembers
where statusflag not in ('D','O')
EXCEPT
SELECT DISTINCT MemberIdentificationNumber NHLinkID,
		MemberIdentificationNumber,
		MembersDateOfBirth,
		null ClientNumber,
		MemberLastName,
		MemberFirstName,
		MemberMiddleName,
		null SocialSecurityNumber,
		MemberPhoneNumber,
		MemberAddressLine1,
		MemberAddressLine2,
		MemberCityName,
		MemberStateName,
		MemberZipCode,
		MemberDateOfDeath,
		MemberSex,
		MemberRace,
		MemberMaritalStatus,
		MemberLanguage,
		MemberMailingAddressLine1,
		MemberMailingAddressLine2,
		MemberMailingCityName,
		MemberMailingStateName,
		MemberMailingZipCode
from elig.BSStgEligData

		
CREATE view eon.ViewEonInsNotRcvd as
SELECT 
	 NHLinkID,
	[MemberIdentificationNumber],
	[Plan],
	[EligibilityEffectiveDate],
	[EligibilityTerminationDate],--[HICN],
	[ContractID],[PBP]
FROM eon.[EonInsurance] where statusflag <> 'D'
EXCEPT
SELECT	
	[MemberIdentificationNumber] NHLinkID,
	[MemberIdentificationNumber],
	[Plan],
	[EligibilityEffectiveDate],
	[EligibilityTerminationDate],--[HICN],
	[ContractID],[PBP]
FROM eon.EonStgEligData 

CREATE view eon.ViewEONInsNeworChanges as
SELECT	
	 [MemberIdentificationNumber] NHLinkID,
	[MemberIdentificationNumber],
	[Plan],
	[EligibilityEffectiveDate],
	[EligibilityTerminationDate],--[HICN],
	[ContractID],[PBP]
FROM eon.EonStgEligData 
EXCEPT 
SELECT 
	[NHLinkID],
	[MemberIdentificationNumber],
	[Plan],
	[EligibilityEffectiveDate],
	[EligibilityTerminationDate],--[HICN],
	[ContractID],[PBP]
FROM eon.[EonInsurance] where statusflag <> 'D'


CREATE view [eon].[ViewEonMemNotRcvd] as
SELECT  NHLinkID,
		[MemberIdentificationNumber],
		[MemberDateOfBirth],
		isnull([PlanNumber],'') PlanNumber,
		[MemberLastName],
		[MemberFirstName],
		[MemberMiddleName],
		[MemberPhoneNumber],
		[MemberAddressLine1],
		[MemberAddressLine2],
		[MemberCityName],
		[MemberStateName],
		[MemberZipCode],
		[MemberGender],
		[MemberLanguage],
		[MemberMailingAddressLine1],
		[MemberMailingAddressLine2],
		[MemberMailingCityName],
		[MemberMailingStateName],
		[MemberMailingZipCode]
from eon.[eonMembers] where statusflag <> 'D'
EXCEPT
SELECT DISTINCT [MemberIdentificationNumber] NHLinkID,
		[MemberIdentificationNumber],
		[MemberDateOfBirth],
		[Plan],
		[MemberLastName],
		[MemberFirstName],
		[MemberMiddleName],
		[MemberPhoneNumber],
		[MemberAddressLine1],
		[MemberAddressLine2],
		[MemberCityName],
		[MemberStateName],
		[MemberZipCode],
		[MemberGender],
		[Language],
		[MemberMailingAddressLine1],
		[MemberMailingAddressLine2],
		[MemberMailingCityName],
		[MemberMailingStateName],
		[MemberMailingZipCode]
from eon.[eonStgEligData]


CREATE VIEW [eon].[ViewEONMemNeworChanges] AS
SELECT  DISTINCT [MemberIdentificationNumber] NHLinkID,
		[MemberIdentificationNumber],
		[MemberDateOfBirth],
		[Plan],
		[MemberLastName],
		[MemberFirstName],
		[MemberMiddleName],
		[MemberPhoneNumber],
		[MemberAddressLine1],
		[MemberAddressLine2],
		[MemberCityName],
		[MemberStateName],
		[MemberZipCode],
		[MemberGender],
		[Language],
		[MemberMailingAddressLine1],
		[MemberMailingAddressLine2],
		[MemberMailingCityName],
		[MemberMailingStateName],
		[MemberMailingZipCode]
		FROM eon.[eonStgEligData]
EXCEPT
SELECT 
		[NHLinkID],
		[MemberIdentificationNumber],
		[MemberDateOfBirth],
		case when [PlanNumber] is null then '' else [PlanNumber] end [PlanNumber],
		[MemberLastName],
		[MemberFirstName],
		[MemberMiddleName],
		[MemberPhoneNumber],
		[MemberAddressLine1],
		[MemberAddressLine2],
		[MemberCityName],
		[MemberStateName],
		[MemberZipCode],
		[MemberGender],
		[MemberLanguage],
		[MemberMailingAddressLine1],
		[MemberMailingAddressLine2],
		[MemberMailingCityName],
		[MemberMailingStateName],
		[MemberMailingZipCode]
FROM eon.[EonMembers] WHERE statusflag <> 'D'

CREATE PROCEDURE [Insurance].[BMGetContractId]
(
    -- Add the parameters for the stored procedure here
    @InsuranceCarrierID BIGINT,
    @InsuranceHealthPlanID BIGINT
)
AS
BEGIN
BEGIN TRY
    -- SET NOCOUNT ON added to prevent extra result sets from
    -- interfering with SELECT statements.
    SET NOCOUNT ON

	DECLARE @ValidateCheck BIGINT;
	DECLARE @HealthPlanContractID BIGINT;
	DECLARE @CONTRACTNAME NVARCHAR(100);
	DECLARE @CONTRACTDESC NVARCHAR(100);
	

	IF @InsuranceCarrierID IS NOT NULL and 
	   @InsuranceHealthPlanID IS NOT NULL
	BEGIN
		IF @InsuranceHealthPlanID <> 99999
		BEGIN
		 --1. Check validiti of Input Params 
			  SELECT @ValidateCheck = (SELECT TOP 1 InsuranceCarrierID FROM [Insurance].[InsuranceHealthPlans]
				                       WHERE
					                        InsuranceCarrierID = @InsuranceCarrierID
					                        and InsuranceHealthPlanID = @InsuranceHealthPlanID
									   )
		      IF @ValidateCheck is NULL 
			     RAISERROR ('Invalid CarriedID or HealthPlanID  ', -- Message text.  
                              16, -- Severity.  
                              1 -- State.  
                             );  
	          --2. Check if system has ContractID
				SELECT  @HealthPlanContractID = (SELECT TOP 1
					HealthPlanContractID
				FROM
					[Insurance].[HealthPlanContracts]
				WHERE
					InsuranceCarrierID = @InsuranceCarrierID
					and InsuranceHealthPlanID = @InsuranceHealthPlanID)

			   IF (@HealthPlanContractID IS NULL)
			   -- Create New one if doesnt exist
			       BEGIN
				       			      
					  SELECT @CONTRACTNAME = ( CAST(year(getdate()) AS NVARCHAR)  + '-C' + CAST(@InsuranceCarrierID as NVARCHAR) + '-P' + CAST(@InsuranceHealthPlanID AS NVARCHAR) + '- ' +
				                              (SELECT TOP 1 [HealthPlanName] from [Insurance].[InsuranceHealthPlans] where InsuranceHealthPlanID = @InsuranceHealthPlanID)
										     );
					  SELECT @CONTRACTDESC = ( (SELECT TOP 1 [InsuranceCarrierName] from [Insurance].[InsuranceCarriers] where [InsuranceCarrierID] = @InsuranceCarrierID) + '- ' +
				                               (SELECT TOP 1 [HealthPlanName] from [Insurance].[InsuranceHealthPlans] where InsuranceHealthPlanID = @InsuranceHealthPlanID)
											  )
				       INSERT INTO [Insurance].[HealthPlanContracts]
							([ContractName], [CreateDate], [CreateUser], 
							[Description], [EffectiveFromDate], [EffectiveToDate], [InsuranceCarrierID], 
							[InsuranceHealthPlanID], [IsActive], [ModifyDate], [ModifyUser]) 
					   VALUES 
					        ( @CONTRACTNAME, getdate(), 'matrixUser',
							  @CONTRACTDESC, getdate(), getdate() + 2 * 365, @InsuranceCarrierID, @InsuranceHealthPlanID, 1, getdate(), 'matrixUser')

					  SET @HealthPlanContractID = SCOPE_IDENTITY();

				   END
			       select @HealthPlanContractID;
		END
		ELSE
		BEGIN
			DECLARE @InsuranceHealthPlanID_CRSR as BIGINT

			DECLARE @HealthPlanCursor as CURSOR

			SET @HealthPlanCursor = CURSOR FOR
				SELECT 
					InsuranceHealthPlanId as InsuranceHealthPlanID_CRSR
				FROM
					Insurance.InsuranceHealthPlans
				WHERE InsuranceCarrierID = @InsuranceCarrierID

			OPEN @HealthPlanCursor

			FETCH NEXT FROM @HealthPlanCursor INTO @InsuranceHealthPlanID_CRSR
			WHILE @@FETCH_STATUS = 0
			BEGIN
				EXECUTE [Insurance].[BMGetContractId] @InsuranceCarrierID, @InsuranceHealthPlanID_CRSR
				FETCH NEXT FROM @HealthPlanCursor INTO @InsuranceHealthPlanID_CRSR
			END

			CLOSE @HealthPlanCursor
			DEALLOCATE @HealthPlanCursor
		END
			
       	END
		ELSE
		BEGIN
		          RAISERROR ('CarriedID or HealthPlanID are missing ', -- Message text.  
                              16, -- Severity.  
                              1 -- State.  
                             );  
		END
		--IF ENDs
END TRY
BEGIN CATCH  
    DECLARE @ErrorMessage NVARCHAR(4000);  
    DECLARE @ErrorSeverity INT;  
    DECLARE @ErrorState INT;  

    SELECT   
        @ErrorMessage =  ERROR_MESSAGE(),  
        @ErrorSeverity = ERROR_SEVERITY(),  
        @ErrorState = ERROR_STATE();  

    -- Use RAISERROR inside the CATCH block to return error  
    -- information about the original error that caused  
    -- execution to jump to the CATCH block.  
    RAISERROR (@ErrorMessage, -- Message text.  
               @ErrorSeverity, -- Severity.  
               @ErrorState -- State.  
               );  
END CATCH;  
END
create Procedure [Insurance].[GetHealthPlanContracts]
	@InsID int,
	@PlanId int

AS
BEGIN
    -- SET NOCOUNT ON added to prevent extra result sets from
    -- interfering with SELECT statements.
    SET NOCOUNT ON 
		select * from [Insurance].[HealthPlanContracts]
		where insurancehealthplanid in 
		(select insurancehealthplanid from insurance.insurancehealthplans
		where insurancecarrierid =@Insid and InsuranceHealthPlanID=@PlanId)
		and Isactive=1
END
Create Procedure [Insurance].[GetInsuranceContactData]
	@InsID int,
	@PlanId int

AS
BEGIN
    -- SET NOCOUNT ON added to prevent extra result sets from
    -- interfering with SELECT statements.
    SET NOCOUNT ON 
	--declare @InsID int=4;
	--declare @PlanId int =10;
		select * from [Insurance].[ContractBenefits]
		where HealthPlanContractid in 
		(select HealthPlanContractid from [Insurance].[HealthPlanContracts]
		where InsuranceHealthPlanID=@PlanId and  insurancehealthplanid in 
		(select insurancehealthplanid from insurance.insurancehealthplans
		where insurancecarrierid =@InsID))
		and isactive=1
END
CREATE PROCEDURE [Insurance].[SendPaymentReceiptFlag]
(
  @orderid bigint
)
AS
BEGIN
    -- SET NOCOUNT ON added to prevent extra result sets from
    -- interfering with SELECT statements.
    SET NOCOUNT ON
	DECLARE @INSURANCECARRIERID BIGINT
   SET @INSURANCECARRIERID = (SELECT JSON_VALUE(Memberdata, '$."insCarrierId"') AS InsuranceCarrierId FROM [Orders].[Orders] WHERE orderid = @orderid)

   SELECT [IsAutoSendPaymentReceipt] FROM  [Insurance].[InsuranceCarriers] WHERE [InsuranceCarrierID] = @INSURANCECARRIERID

END

CREATE PROCEDURE [Insurance].[GetInsuranceTollFreeNumbers]
AS
BEGIN

SELECT ROW_NUMBER() OVER(ORDER BY a.CarrierName ASC) AS RowNo, a.*from
	(
	  SELECT  DISTINCT C.[InsuranceCarrierID] as CarrierId,C.[InsuranceCarrierName] CarrierName,T.[TollFreeNbr] as TollFreeNumber  FROM
	  [Insurance].[HealthPlanTollFreeNumbers] T
	   INNER JOIN [Insurance].[InsuranceCarriers] C ON T.[InsuranceCarrierID] = C.[InsuranceCarrierID]
	) a
ORDER BY a.CarrierName ASC

END


CREATE PROCEDURE [Insurance].[BMInsertContractProducts]
	            @HealthPlanContractID BIGINT, 
			    @CSVData nvarchar(1000)
AS
BEGIN

SET NOCOUNT ON;
-- 'Phonak','Audeo B90-Direct','Superior','Override',2075,650,800
DECLARE @sqlData NVARCHAR(1000);
DECLARE @sql NVARCHAR(2000);

set @sqlData = @CSVData + ',' +
               CAST(@HealthPlanContractID as NVARCHAR(10)) + ',' +
			   'getdate(),''matrixUser''' + ',' +
			   'getdate(),''matrixUser''' + ',' +
			   '1' + ',NULL,NULL';

               
set  @sql = 'INSERT INTO  [Insurance].[ContractProducts]  
				 (					
					BrandCode,
					FamilyProductCode,
					FamilyProductCatCode,
					ProductAvailType,
					PerDeviceMemberPrice,
					PerDeviceDispensingFee,
					PerDeviceCOGSPrice,
					PerPairMemberPrice,
					HealthPlanContractID,
					CreateDate,
					CreateUser,
					ModifyDate,
					ModifyUser,
					IsActive,
					FamilyProductCategoryFamilyProductID,
					HealthPlanContractID1
				) 	Values		( ' + @sqlData + ')';

EXEC sp_executesql @sql

SELECT @sql
END

CREATE PROCEDURE [Insurance].[BMInsertUpdateBenefits]
(
    -- Add the parameters for the stored procedure here
    @HealthPlanContractID bigint,
	@ContractBenefitID bigint,
	@CSVData nvarchar(1000)
)
AS
BEGIN
    SET NOCOUNT ON
	DECLARE @INSERTQUERY AS NVARCHAR(4000);
	DECLARE @UPDATEQRY AS NVARCHAR(4000);
	DECLARE @sqlData NVARCHAR(1000);
	DECLARE @sql NVARCHAR(2000);

	set @sqlData = @CSVData +
				   ',getdate(),''matrixUser''' +
				   ',getdate(),''matrixUser''' + 
				   ',1';

	IF (@ContractBenefitID IS NOT NULL)
	BEGIN

		SET @UPDATEQRY = 'UPDATE  [Insurance].[ContractBenefits]
		SET
		WHERE ContractBenefitID = @ContractBenefitID'

	END

	ELSE
	BEGIN

		IF(@CSVDATA IS NOT NULL)
		BEGIN

		SET @INSERTQUERY = 'INSERT INTO [Insurance].[ContractBenefits]
							(
			   [HealthPlanContractID]
			   ,[HealthPlanContractInsuranceHealthPlanID], [BenefitAmt],[BenefitAmtPer]
			   ,[IsMedicaidIsSecondaryCoverage],[IsPMNPM],[PMPMAmount], [InsurancePayerID]
			   ,[IsFileClaim],[IsClaimPayToPatient],[IsClaimEqualToProductListPricePerDevice]
			   ,[IsRebate],[RebatePercentage]
			   ,[HearingExamCoPay]
			   ,[IsPriorAuth]
			   ,[HearingAidCoPay],[HearingAidCoPayPer] ,[FittingCoPay]
			   ,[BenefitFrequencyYears] ,[BenefitFrequencyYearsBy]
			   ,[IsHearingAidBenefitVerificationRequired]
			   ,[IsAbilityToBalanceBillMember]
			   ,[IsDefaultBenefit]
			   	,CreateDate
				,CreateUser
				,ModifyDate
				,ModifyUser
				,IsActive) VALUES(' + @sqlData+')'
    
			
			PRINT @INSERTQUERY 
			
			EXECUTE SP_EXECUTESQL @INSERTQUERY

		END

	END
			
		
END

CREATE PROCEDURE [Insurance].[BMInsertUpdateProducts]
    @HealthPlanContractID BIGINT,
	@InsuranceCarrierID BIGINT,
    @InsuranceHealthPlanID BIGINT,
	@FamilyProductCode NVARCHAR(50),
	@CSVData nvarchar(1000)
	-- @Action nvarchar(1) -- I, Insert, U - Update
AS
BEGIN
BEGIN TRY 
   -- SET NOCOUNT ON added to prevent extra result sets from
    SET NOCOUNT ON;

   --1. Verify given @HealthPlanContractID belongs to same @InsuranceCarrierID and @InsuranceHealthPlanID
     DECLARE @ValidateCheck BIGINT;
	 IF @InsuranceHealthPlanID <> 99999
		 SELECT @ValidateCheck = (SELECT TOP 1 InsuranceCarrierID FROM [Insurance].[HealthPlanContracts]
								  WHERE  [HealthPlanContractID]  = @HealthPlanContractID and 
										 [InsuranceCarrierID]    = @InsuranceCarrierID and
										 [InsuranceHealthPlanID] = @InsuranceHealthPlanID )	    
	ELSE
		SET @ValidateCheck = 1
     IF @ValidateCheck is NULL 
	    RAISERROR ('Invalid CarriedID or HealthPlanID or  HealthPlanContractID  ', -- Message text.  
                              16, -- Severity.  
                              1 -- State.  
                             );  

   --2. If InsuranceHealthPlanID = 99999 then delete all [FamilyProductCode] of that @HealthPlanContractID   
   IF @InsuranceHealthPlanID = 99999
       BEGIN
	   -- 2a. Delete all existing records 
	   DELETE FROM [Insurance].[ContractProducts]
	          WHERE [FamilyProductCode]     = @FamilyProductCode and 
			        [HealthPlanContractID]  IN
					( SELECT [HealthPlanContractID] from  [Insurance].[HealthPlanContracts] 
					  WHERE [InsuranceCarrierID] = @InsuranceCarrierID )

       -- 2b. Insert the same for all Plans 
       EXECUTE [Insurance].[BMInsertContractProductsAllPlans]  @InsuranceCarrierID, @CSVData
	   END
   --3. Else Delete only that product @HealthPlanContractID ,  [FamilyProductCatCode]
   ELSE 
       BEGIN
	   -- 2a. Delete One existing product 
	   DELETE FROM [Insurance].[ContractProducts]
	          WHERE [FamilyProductCode]     = @FamilyProductCode and 
			        [HealthPlanContractID]  = @HealthPlanContractID 
                    
	   EXECUTE [Insurance].[BMInsertContractProducts]  @HealthPlanContractID, @CSVData
	   END




        -- and Insert New Product 


END TRY
BEGIN CATCH
    DECLARE @ErrorMessage NVARCHAR(4000);  
    DECLARE @ErrorSeverity INT;  
    DECLARE @ErrorState INT;  

    SELECT   
        @ErrorMessage =  ERROR_MESSAGE(),  
        @ErrorSeverity = ERROR_SEVERITY(),  
        @ErrorState = ERROR_STATE();  

    -- Use RAISERROR inside the CATCH block to return error  
    -- information about the original error that caused  
    -- execution to jump to the CATCH block.  
    RAISERROR (@ErrorMessage, -- Message text.  
               @ErrorSeverity, -- Severity.  
               @ErrorState -- State.  
               );  
END CATCH
END




CREATE PROCEDURE [Insurance].[BMInsertContractProductsAllPlans]
	            @InsuranceCarrierID BIGINT, 
			    @CSVData nvarchar(1000)
AS
BEGIN

SET NOCOUNT ON;
-- 'Phonak','Audeo B90-Direct','Superior','Override',2075,650,800
DECLARE @sqlData NVARCHAR(1000);
DECLARE @sql NVARCHAR(2000);

               
set  @sql = 'INSERT INTO  [Insurance].[ContractProducts]  
				 (					
					BrandCode,
					FamilyProductCode,
					FamilyProductCatCode,
					ProductAvailType,
					PerDeviceMemberPrice,
					PerDeviceDispensingFee,
					PerDeviceCOGSPrice,
					PerPairMemberPrice,
					HealthPlanContractID,
					CreateDate,
					CreateUser,
					ModifyDate,
					ModifyUser,
					IsActive,
					FamilyProductCategoryFamilyProductID,
					HealthPlanContractID1
				) '+ 'SELECT ' + @CSVData + ', CAST(HealthPlanContractID as NVARCHAR(10)), getdate(),''matrixUser'', getdate(),''matrixUser'', 1,NULL,NULL ' +
						'FROM
							Insurance.HealthPlanContracts
							WHERE Insurance.HealthPlanContracts.InsuranceCarrierID =' + cast(@InsuranceCarrierID as nvarchar(10));

			PRINT @sql

EXEC sp_executesql @sql

SELECT @sql
END
-- =============================================
-- Author:      <Author, , Name>
-- Create Date: <Create Date, , >
-- Description: <Description, , >
-- =============================================
CREATE Procedure [Insurance].[GetInsuranceData]
	@InsID int

AS
BEGIN
    -- SET NOCOUNT ON added to prevent extra result sets from
    -- interfering with SELECT statements.
    SET NOCOUNT ON

    -- Insert statements for procedure here
	


		select * from insurance.insurancecarriers 
		where insurancecarrierid =@Insid

		select * from insurance.insurancehealthplans
		where insurancecarrierid =@Insid

		select * from [Insurance].[HealthPlanContracts]
		where insurancehealthplanid in 
		(select insurancehealthplanid from insurance.insurancehealthplans
		where insurancecarrierid =@Insid)


		select * from [Insurance].[ContractProducts]
		where HealthPlanContractid in 
		(select HealthPlanContractid from [Insurance].[HealthPlanContracts]
		where insurancehealthplanid in 
		(select insurancehealthplanid from insurance.insurancehealthplans
		where insurancecarrierid =@Insid))


		select * from [Insurance].[ContractBenefits]
		where HealthPlanContractid in 
		(select HealthPlanContractid from [Insurance].[HealthPlanContracts]
		where insurancehealthplanid in 
		(select insurancehealthplanid from insurance.insurancehealthplans
		where insurancecarrierid =@Insid))
END

CREATE Procedure [NDSync].[MemberProc] (
@NHMemberID AS varchar(50) ,
@Jdata nvarchar(max) OUTPUT)
AS
BEGIN

      -- Insert statements for procedure here         
      DECLARE @Ret_Var       INT, 
              @Error_Code    INT, 
              @Tran_Count_In INT 
      DECLARE @Warning VARCHAR(8000) 

      SELECT @Ret_Var = 0, 
             @Error_Code = 0, 
             @Tran_Count_In = @@TranCount, 
             @Warning = '' 
			
BEGIN TRANSACTION 
  
  SELECT
    @Jdata = (SELECT
      m.NHMemberID 'Member.NHMemberID',
      m.FirstName 'Member.FirstName',
      m.LastName 'Member.LastName',
	  m.DateOfBirth 'Member.DateOfBirth',
      m.MiddleInitial 'Member.MiddleInitial',
      a.Address1 'Member.Address1',
      a.Address2 'Member.Address2',
      a.City 'Member.City',
      a.State 'Member.State',
      a.zipcode 'Member.zipcode',
	  p.phonenbr 'Member.PhoneNbr'
    FROM [Master].[Members] m
    LEFT OUTER JOIN [Master].[Addresses] a
      ON (m.memberid = a.memberid
      AND a.addresstypecode = 'PERM')
	   LEFT OUTER JOIN [Master].[PhoneNumbers] p
      ON (m.memberid = p.memberid
      AND p.phonetypecode = 'HOME')
    WHERE 1 = 1
    AND NHMemberID = @NHMemberID --'NH201700000003'
    FOR JSON PATH 
    )
	COMMIT TRANSACTION
	

	 -- check for errors                               
      SELECT @Error_Code = @@Error 

      IF @Error_Code <> 0 
        BEGIN 
            SET @Ret_Var = CASE @Ret_Var 
                             WHEN 0 THEN @Error_Code 
                             ELSE @Ret_Var 
                           END 
            SET @Warning = @Warning + Error_message() 

            GOTO __spreturn 
        END 

	   __SPRETURN: 

      RETURN @Ret_Var 


END;

CREATE Procedure [NDSync].[NHNDSyncDate]

@TableName AS varchar(250),
@NHID AS nvarchar(50),
@NDRefID AS bigint,
@SyncedDate AS DATETIME,
@Notes AS nvarchar(250) = NULL


AS
BEGIN

INSERT INTO NDSync.NHNDSync
(TableName, NHID, NDRefID, SyncedDate, Notes)
values
(@TableName, @NHID, @NDRefID, @SyncedDate, @Notes)

END
-- =============================================
-- Author:		Mohan
-- Create date: Feb 6th 2018
-- Description:	This method will Update Claim Number based on MemberChartDataID
-- =============================================
CREATE Procedure [Noble].[Update_ClaimNumbers] 
    @MemberChartDataId bigint,
	@NobleClaimNumber bigint, 
	@NobleClaimDetailNumber bigint = 0
AS
BEGIN
	-- SET NOCOUNT ON added to prevent extra result sets from
	-- interfering with SELECT statements.
	SET NOCOUNT ON;
	IF @NobleClaimNumber > 0 
	Begin
		UPDATE  [provider].[MemberChartData]
		SET [NobleClaimNumber] = @NobleClaimNumber
		WHERE [MemberChartDataId] = @MemberChartDataId
	End 
    IF @NobleClaimDetailNumber > 0 
	Begin
		UPDATE  [provider].[MemberChartData]
		SET @NobleClaimDetailNumber = @NobleClaimDetailNumber
		WHERE [MemberChartDataId] = @MemberChartDataId
	End 
END
-- =============================================
-- Author:		Mohan
-- Create date: Feb 6th 2018
-- Description:	This method will gets ClaimHeader Details to create new header  based on MemberChartDataID
-- TO BE WORKED ON
-- =============================================
CREATE Procedure [Noble].[Get_ClaimHeader]
	@MemberChartDataId bigint 
AS
BEGIN
	-- SET NOCOUNT ON added to prevent extra result sets from
	-- interfering with SELECT statements.
	SET NOCOUNT ON;

	--1. Validate if the MemberchartDataId is belogs to Testing, HA Order or Fitting transacctions 
	 SELECT [MinorProcessId] 
	 FROM [provider].[MemberChartData] WITH (NOLOCK)
	 WHERE [MemberChartDataId] = @MemberChartDataId
	       --[MinorProcessId] IN (

	SELECT [NobleClaimNumber], [NobleClaimDetailNumber] 
	FROM [provider].[MemberChartData] WITH (NOLOCK)
	WHERE [MemberChartDataId] = @MemberChartDataId

END
-- =============================================
-- Author:		Mohan
-- Create date: 5th Feb 2018
-- Description:	Return Tesing Item
-- =============================================
CREATE Procedure [Noble].[Get_HearingService_Fitting_Item]
AS
BEGIN
	-- SET NOCOUNT ON added to prevent extra result sets from
	-- interfering with SELECT statements.
	SET NOCOUNT ON;

    -- Insert statements for procedure here
	SELECT	GETDATE()					as 'Nations_Date_Modified',
			'FITTING'				as 'Nations_ITM_ID',
			'Hearing Aid Fitting Completed'	as 'ITM_DESCRIPTION',
			0							as 'ITEM_PRICE',
			'V5011'					as 'Nations_PRO_CODE'

END
-- =============================================
-- Author:		Mohan
-- Create date: Feb 6th 2018
-- Description:	This method will get Existing Claim Number based on MemberChartDataID
-- =============================================
CREATE Procedure [Noble].[Get_ClaimNumbers] 
	@MemberChartDataId bigint 
AS
BEGIN
	-- SET NOCOUNT ON added to prevent extra result sets from
	-- interfering with SELECT statements.
	SET NOCOUNT ON;

	SELECT [NobleClaimNumber], [NobleClaimDetailNumber] 
	FROM [provider].[MemberChartData] WITH (NOLOCK)
	WHERE [MemberChartDataId] = @MemberChartDataId

END
-- =============================================
-- Author:		Mohan
-- Create date: 5th Feb 2018
-- Description:	Gets Patient Details by MemberProfileID
-- =============================================
CREATE Procedure [Noble].[Get_patient] 
    @MemberProfileID bigint
AS
BEGIN
	-- SET NOCOUNT ON added to prevent extra result sets from
	-- interfering with SELECT statements.
	SET NOCOUNT ON;

    -- Insert statements for procedure here
	SELECT TOP 1
	a.[ModifyDate]				as Nations_Date_Modified,
	a.[MemberProfileId]			as Nations_PAT_ID,
	a.[FirstName]				as PAT_FIRST,
	a.[LastName]				as PAT_LAST,
	LEFT(b.[Address1],55)       as PAT_ADDRESS1,
	LEFT(b.[Address2],55)       as PAT_ADDRESS2,
	LEFT(b.[City],30)			as PAT_CITY,
	LEFT(b.[State],2)           as PAT_STATE,
	LEFT(b.[ZipCode],10)        as PAT_ZIPCODE,
	LEFT(c.[PhoneNumber],10)    as PAT_PHONE1

	FROM [provider].[MemberProfiles] a WITH (NOLOCK)
	INNER JOIN [provider].[MemberLocations] b		WITH (NOLOCK) ON b.[MemberProfileId]=a.[MemberProfileId] 
	INNER JOIN [provider].[MemberPhoneNumbers] c	WITH (NOLOCK) ON c.[MemberProfileId]=a.[MemberProfileId] 

	WHERE 
	a.[MemberProfileId] = @MemberProfileID 
END
-- =============================================
-- Author:		Mohan
-- Create date: 5th Feb 2018
-- Description:	Gets HCP Details by HCPUserProfileId
-- =============================================
CREATE Procedure [Noble].[Get_physician] 
    @HCPUserProfileID bigint,
	@ServiceLocationID bigint
AS
BEGIN
	-- SET NOCOUNT ON added to prevent extra result sets from
	-- interfering with SELECT statements.
	SET NOCOUNT ON;

    -- Insert statements for procedure here
	SELECT TOP 1
	a.[ModifyDate]				as Nations_Date_Modified,
	a.[UserProfileId]			as Nations_PHY_ID,
	d.[FirstName]				as PHY_FIRST,
	d.[LastName]				as PHY_LAST,
	LEFT(a.[Designation],10)	as PHY_CREDENTIALS,
	LEFT(f.[Address1],55)       as PHY_ADDRESS1,
	LEFT(f.[Address2],55)       as PHY_ADDRESS2,
	LEFT(f.[City],30)			as PHY_CITY,
	LEFT(f.[State],2)           as PHY_STATE,
	LEFT(f.[Zip],10)            as PHY_ZIPCODE,
	LEFT(g.[PhoneNumber],10)    as PHY_PHONE1,
	LEFT(d.[NPINumber],10)      as PHY_NPI

	FROM [auth].[UserProfiles] a WITH (NOLOCK)
	INNER JOIN [provider].[ProviderUsers] b			WITH (NOLOCK) ON b.[UserProfileId]=a.[UserProfileId] 
	INNER JOIN [provider].[ProviderProfiles] c		WITH (NOLOCK) ON c.[ProviderId] = b.[ProviderId]
	INNER JOIN [provider].[HCPProviderProfile] d	WITH (NOLOCK) ON d.[UserProfileId] = a.[UserProfileId]
	INNER JOIN [provider].[ProviderLocations] e		WITH (NOLOCK) ON e.[ProviderId] = b.[ProviderId]
	INNER JOIN [provider].[Locations] f				WITH (NOLOCK) ON f.[LocationId] = e.[LocationId]
	INNER JOIN [provider].[LocationPhoneNumbers] g	WITH (NOLOCK) ON g.[LocationId] =f.[LocationId]

	WHERE 
	a.[UserProfileId] = @HCPUserProfileID and 
	f.[LocationId] =    @ServiceLocationID

END
-- =============================================
-- Author:		Mohan
-- Create date: 5th Feb 2018
-- Description:	Gets Insurance Details by @InsuranceCarrierID
-- =============================================
CREATE Procedure [Noble].[Get_Insurance] 
    @InsuranceCarrierID bigint
AS
BEGIN
	-- SET NOCOUNT ON added to prevent extra result sets from
	-- interfering with SELECT statements.
	SET NOCOUNT ON;

    -- Insert statements for procedure here
	SELECT TOP 1
	a.[ModifyDate]						as Nations_Date_Modified,
	a.[InsuranceCarrierID]				as Nations_INS_ID,
	LEFT(a.[InsuranceCarrierName],55)	as INS_COMPANY,
	LEFT(a.[ClaimsAddress1],55)			as INS_ADDRESS1,
	LEFT(a.[ClaimsAddress2],55)			as INS_ADDRESS2,
	LEFT(a.[ClaimsCity],30)				as INS_CITY,
	LEFT(a.[ClaimsState],2)				as INS_STATE,
	LEFT(a.[ClaimsZipCode],10)			as INS_ZIPCODE,
	LEFT(a.[ClaimsPhoneNbr],10)			as INS_PHONE1,
	a.[ClaimsEmailAddress]				as INS_EMAIL

	FROM [Insurance].[InsuranceCarriers] a WITH (NOLOCK)

	WHERE 
	a.[InsuranceCarrierID] = @InsuranceCarrierID 
END

CREATE Procedure [Noble].[Get_HearingService_Testing_Item]
AS
BEGIN
	-- SET NOCOUNT ON added to prevent extra result sets from
	-- interfering with SELECT statements.
	SET NOCOUNT ON;

    -- Insert statements for procedure here
	SELECT	GETDATE()					as 'Nations_Date_Modified',
			'TESTING'				as 'Nations_ITM_ID',
			'Hearing Test Completed'	as 'ITM_DESCRIPTION',
			0							as 'ITEM_PRICE',
			'92591'					as 'Nations_PRO_CODE'

END
CREATE Procedure [Noble].[Get_HearingService_HA_Item]  
@ProductModelCode nvarchar(30),   
@DeviceCount int  
AS  
BEGIN  
 -- SET NOCOUNT ON added to prevent extra result sets from  
 -- interfering with SELECT statements.  
 SET NOCOUNT ON;  
  
If @DeviceCount = 1    
Begin  
 SELECT   
 GETDATE()             as 'Nations_Date_Modified',  
 (c.[FamilyProductCode] + '_' + c.[ProductModelCode] + '_1') as 'Nations_ITM_ID',  
 ('Monaural Device,Brand:' + [BrandCode] + ', Family:'+[BrandFamilyCode] + ',Shell:' +  
  case when c.[ShellCode]  in ('CIC','IIC','ITC','HS','MIH','ITE','LP') then c.[ShellCode]  
  else 'BTE'  
  end)              as 'Item_Description',  
  '0'              as 'ITEM_PRICE',  
 case when c.[ShellCode]  in ('CIC','IIC')                then 'V5254'   
   when c.[ShellCode]  in ('ITC','HS','MIH')           then 'V5255'   
   when c.[ShellCode]  in ('ITE','LP')                 then 'V5256'   
   when c.[ShellCode]  is null and e.[StyleCode] like '%BTE%' then 'V5257'  
   else '--'  
 end               as  'Nations_PRO_CODE'  
 FROM [catalog].[ProductModelRules]  c WITH (NOLOCK)  
 INNER JOIN [catalog].[Styles] e    WITH (NOLOCK) on c.[StyleID] = e.[StyleID]  
    WHERE c.[FamilyProductCode] is not null and  
 c.[ProductModelCode] = @ProductModelCode  
End  
  
If @DeviceCount = 2    
Begin  
 SELECT   
 GETDATE()             as 'Nations_Date_Modified',  
 (c.[FamilyProductCode] + '_' + c.[ProductModelCode] + '_2') as 'Nations_ITM_ID',  
 ('Binaural Device,Brand:' + [BrandCode] + ', Family:'+[BrandFamilyCode] + ',Shell:' +  
  case when c.[ShellCode]  in ('CIC','IIC','ITC','HS','MIH','ITE','LP') then c.[ShellCode]  
  else 'BTE'  
  end)              as 'Item_Description',  
  '0'              as 'ITEM_PRICE',  
 case when c.[ShellCode]  in ('CIC','IIC')                then 'V5258'   
   when c.[ShellCode]  in ('ITC','HS','MIH')           then 'V5259'   
   when c.[ShellCode]  in ('ITE','LP')                 then 'V5260'   
   when c.[ShellCode]  is null and e.[StyleCode] like '%BTE%' then 'V5261'  
   else '--'  
 end               as  'Nations_PRO_CODE'  
 FROM [catalog].[ProductModelRules]  c WITH (NOLOCK)  
 INNER JOIN [catalog].[Styles] e    WITH (NOLOCK) on c.[StyleID] = e.[StyleID]  
    WHERE c.[FamilyProductCode] is not null and  
 c.[ProductModelCode] = @ProductModelCode  
End  
END

-- =============================================
-- Author:		Mohan
-- Create date: 5th Feb 2018
-- Description:	Gets Insurance Details by @InsuranceCarrierID
-- =============================================
CREATE Procedure [Noble].[Get_MemberInsurance] 
    @MemberProfileID bigint
AS
BEGIN
	-- SET NOCOUNT ON added to prevent extra result sets from
	-- interfering with SELECT statements.
	SET NOCOUNT ON;

    -- Insert statements for procedure here
	SELECT 
	a.[ModifyDate]							as Nations_Date_Modified,
	a.[MemberProfileId]						as Nations_PAT_ID,
	a.[InsuranceCarrierID]					as Nations_INS_ID,
	a.[MemberInsuranceID]					as Nations_INH_ID,
	case a.[InsuranceType]	
	when 'PRI' then 'P'
	when 'SEC' then 'S'
	when 'TRI' then 'T' else 'P' END		as INH_TYPE,
	c.[InsuranceNbr]						as INH_POLICY,
	c.[GroupNbr]							as INH_GROUP,
	a.[InsuranceEffectiveDate]				as INH_DATE_EFFECTIVE,
	a.[InsuranceEndDate]					as INH_DATE_THRU,
	case c.[PrimaryInsuredRelationShip] 
	when  'SELF' then 'S' 					
	when 'SPOUSE' then 'P' when 'CHILD' then 'C'
	when 'OTHER' then 'O' else 'S' END			as INH_RELATIONSHIP
	

	
	FROM [provider].[MemberInsurances] a					WITH (NOLOCK)
	INNER JOIN [provider].[MemberInsuranceDetails] c		WITH (NOLOCK) ON c.[MemberInsuranceID]=a.[MemberInsuranceID]

	WHERE 
	a.[MemberProfileId] = @MemberProfileID 

END
CREATE PROCEDURE [npn].[SendAgreementTransactionDetails]
@LegalBusinessName NVARCHAR(250),
@Email NVARCHAR(250)
AS
BEGIN
SELECT TOP 1  pr.Email,pr.[IsActive],pr.LegalBusinessName,td.TransactionKey,td.ModifyDate,td.Status
FROM [npn].[ProviderPreRegistration] pr
INNER JOIN [npn].[TransactionDetails] td
ON pr.TransactionKey= td.TransactionKey WHERE @LegalBusinessName=pr.LegalBusinessName OR @Email=pr.Email
order by modifydate desc
END
CREATE PROCEDURE [npn].[GetDashBoardStatistics_Data]
AS
BEGIN
DECLARE @AGREEMENTSENT INT
DECLARE @NEWLEADS INT
DECLARE @AGREEMENTSENT_VIEWED INT
DECLARE @AGREEMENT_AUTHORIZED INT
DECLARE @SUBMITTED INT
DECLARE @REGISTRATION_AUTHORIZED INT
DECLARE @REGISTRATION_SUBMITTED INT
DECLARE @APPROVED_PROVIDERS INT
DECLARE @PROVIDERS_REJECTED INT
DECLARE @DECLINED INT

SET @AGREEMENTSENT = (SELECT COUNT([status]) FROM NPN.TRANSACTIONDETAILS WHERE [status]='AGREEMENTSENT' AND IsActive=1 GROUP BY [status])
SET @NEWLEADS =  (SELECT COUNT([status]) FROM NPN.TRANSACTIONDETAILS WHERE [status]='DRAFT' AND IsActive=1 GROUP BY [status])
SET @AGREEMENTSENT_VIEWED = (SELECT COUNT([status]) FROM NPN.TRANSACTIONDETAILS WHERE [status]='AGREEMENTSENT_VIEWED' AND IsActive=1 GROUP BY [status])
SET @AGREEMENT_AUTHORIZED = (SELECT COUNT([status]) FROM NPN.TRANSACTIONDETAILS WHERE [status]='REGISTRATION_AUTHORIZED' AND IsActive=1 GROUP BY [status])
SET @SUBMITTED = (SELECT COUNT([status]) FROM NPN.TRANSACTIONDETAILS WHERE [status]='SUBMITTED' AND IsActive=1 GROUP BY [status])
SET @REGISTRATION_AUTHORIZED = (SELECT COUNT([status]) FROM NPN.TRANSACTIONDETAILS WHERE [status]='REGISTRATION_AUTHORIZED' AND IsActive=1 GROUP BY [status])
SET @REGISTRATION_SUBMITTED = (SELECT COUNT([status]) FROM NPN.TRANSACTIONDETAILS WHERE [status]='SUBMITTED' AND IsActive=1 GROUP BY [status])
SET @APPROVED_PROVIDERS = (SELECT COUNT([status]) FROM NPN.TRANSACTIONDETAILS WHERE [status]='SUBMITTED' AND IsActive=1 GROUP BY [status])
SET @PROVIDERS_REJECTED = (SELECT COUNT([status]) FROM NPN.TRANSACTIONDETAILS WHERE [status]='REJECTED' AND IsActive=1 GROUP BY [status])
SET @DECLINED = (SELECT COUNT([status]) FROM NPN.TRANSACTIONDETAILS WHERE [status]='DECLINED' AND IsActive=1 GROUP BY [status])

   SELECT ROW_NUMBER() over (order by @AGREEMENTSENT) as rowId, @AGREEMENTSENT AS 'AgreementsSent', @NEWLEADS AS 'NewLeads', @AGREEMENTSENT_VIEWED AS 'AgreementsViewed', @AGREEMENT_AUTHORIZED AS 'AgreemenmtsAuthorized', @SUBMITTED AS 'AgreementsSubmitted',
   @REGISTRATION_AUTHORIZED AS 'RegistrationsAuthorized', @REGISTRATION_SUBMITTED AS 'RegistrationsSubmitted', @APPROVED_PROVIDERS AS 'ApprovedProviders', @PROVIDERS_REJECTED AS 'ProvidersRejected',
   @DECLINED AS 'AdminDeclined', GETDATE() AS 'analyticsFromDate', GETDATE() AS 'analyticsToDate'
END
CREATE PROCEDURE [npn].[GetAuthorizedRegisteredProviders]
(
    -- Add the parameters for the stored procedure here
    @TRANSACTIONKEY UNIQUEIDENTIFIER
)

-- =============================================
-- Author:      BHANU PRAKASH INTURI
-- Create Date: 13-AUG-2019
-- Description: FETCH AUTHORIZED REGISTERED PROVIDERS BASED ON THE TRANSACTION KEY
--              FROM NPN.PROVIDERPREREGISTRATION AND NPN.TRANSACTIONDETAILS
-- exec [npn].[GetAuthorizedRegisteredProviders]'7E9376C8-4AF6-4D06-B8A8-63B2D8D07C38' '24F482BC-23D5-48C3-9749-9F66C7D4841F' 'F04D9968-20FE-496D-9957-BF552B817A44'
-- =============================================
AS
BEGIN
    -- SET NOCOUNT ON added to prevent extra result sets from
    -- interfering with SELECT statements.
    SET NOCOUNT ON
	SELECT					
							TD.TRANSACTIONID,																		
							PPR.AGREEMENTDATA, 
							PPR.EMAIL,
							PPR.ISAGREEMENTCOMPLETED,
							PPR.ISREGISTRATIONCOMPLETED,
							PPR.LEGALBUSINESSNAME,
							PPR.NPINUMBER,
							PPR.PHONENUMBER,													
							PPR.PROVIDERREGISTRATIONDATA,							
							PPR.TRANSACTIONKEY,
							TD.TYPECODE,
							TD.STATUS,
							SUBMITTEDDATE,
							SUBMITTEDBY,
							AUTHORIZEDDATE,
							AUTHORIZEDBY,
							JSON_VALUE(PPR.AGREEMENTDATA, '$.federalTaxId') as TAXID
	FROM					NPN.PROVIDERPREREGISTRATION PPR 
	INNER JOIN				NPN.TRANSACTIONDETAILS TD
	ON						TD.TRANSACTIONKEY = PPR.TRANSACTIONKEY
	WHERE					TD.STATUS = 'AUTHORIZED'
	AND						PPR.ISAGREEMENTCOMPLETED = 1
	AND						PPR.ISACTIVE = 1
	AND						PPR.TRANSACTIONKEY = @TRANSACTIONKEY    
   
END
CREATE PROCEDURE [npn].[GetAllProvidersPre_Registration_List_Data](
	   @fromDate NVARCHAR(50) = null,
       @toDate NVARCHAR(50) = null,
       @selectOption NVARCHAR(50)=null
) AS 

-- =============================================
-- Author:      <Author, , Hussamuddin, Bhanu, Venkat>
-- Create Date: <07/04/2019, , >
-- Description: <To get list of all document details, , >
-- exec [npn].[GetAllProvidersPre_Registration_List_Data] '','',''
-- exec [npn].[GetAllProvidersPre_Registration_List_Data] '09/06/2019','09/10/2019','C'

BEGIN
WITH Tran_uniqueRecord (ModifyDate,transactionkey)
As(SELECT MAX(td.ModifyDate) as ModifyDate,  
td.transactionkey as transactionkey
FROM npn.transactiondetails TD  INNER JOIN [npn].[ProviderPreRegistration] PR on td.transactionkey = pr.transactionkey 
GROUP BY td.transactionkey)

SELECT (CASE WHEN (Status='NEWLEADEMAIL') THEN 'New Lead'
			 WHEN (Status='AGREEMENTSENT') THEN 'Contract Sent'
			 WHEN (Status='AGREEMENTSENT_VIEWED') THEN 'Agreement Viewed'
			 WHEN (Status='SUBMITTED') THEN 'Agreement Submitted'
			 WHEN (Status='AUTHORIZED') THEN 'Agreement Authorized'
			 WHEN (Status='DECLINED') THEN 'Provider Declined'
			 WHEN (Status='REJECTED') THEN 'Agreement Rejected'
			 WHEN (Status='REGISTRATION_SUBMITTED') THEN 'Registration Submitted'
			 WHEN (Status='REGISTRATION_AUTHORIZED') THEN 'Registration Authorized'
			 WHEN (Status='REGISTRATION_REJECTED') THEN 'Registration Rejected'
			 WHEN (Status='DRAFT') THEN 'Agreement In Progress'
	   end) AS prospectingStatus,
	   format(tu.ModifyDate,'MM/dd/yyyy hh:mm:ss') as ModifyDate,
	   (CASE WHEN ISNULL(CAST(tu.ModifyDate AS VARCHAR),'') != '' THEN CONVERT(VARCHAR,tu.ModifyDate,101)  ELSE '' END) as PModifyDate,
	   tu.Transactionkey INTO #TEMPTRANSACTIONS 
	   FROM npn.transactiondetails td inner join Tran_uniqueRecord tu on tu.Transactionkey=td.Transactionkey
	   WHERE td.modifyDate=tu.modifyDate
	 
SELECT	ROW_NUMBER() OVER (ORDER BY ppreg.AgreementTransactionId) AS rowId, 
			ISNULL(CAST(ppreg.LegalBusinessName AS VARCHAR),'') AS providerlegalBusinessName, 
			--ISNULL(CAST(JSON_VALUE(ppreg.[AgreementData], '$.owner.firstName') AS VARCHAR),'') + ' ' + ISNULL(CAST(JSON_VALUE(ppreg.[AgreementData], '$.owner.middleName') AS VARCHAR),'') + ' ' + ISNULL(CAST(json_value(ppreg.[AgreementData], '$.owner.lastName') AS VARCHAR),'') AS ownerName, 
			ISNULL(CAST(JSON_VALUE(ppreg.[ProviderRegistrationData], '$.ownerInfo.owner.firstName') AS VARCHAR),'') + ' ' + ISNULL(CAST(JSON_VALUE(ppreg.[ProviderRegistrationData], '$.ownerInfo.owner.middleName') AS VARCHAR),'') + ' ' + ISNULL(CAST(json_value(ppreg.[ProviderRegistrationData], '$.ownerInfo.owner.lastName') AS VARCHAR),'') AS ownerName, 
			ISNULL(CAST(ppreg.Email AS VARCHAR),'') AS ownerEmail, 
			ISNULL(ppreg.NPINumber ,'') AS NPINumber,
			CONVERT(VARCHAR,ppreg.ModifyDate,101) AS registrationSubmittedDate,
			(CASE WHEN (ppreg.[NPIData] IS NOT NULL AND ISNULL(CAST(JSON_VALUE(ppreg.[NPIData], '$.result_count') AS INT),0)=1) THEN 'Valid' WHEN ppreg.[NPIData] IS NULL and ISNULL(ppreg.NPINumber ,'')='' THEN '' WHEN ppreg.[NPIData] IS NULL and ISNULL(ppreg.NPINumber ,'')!='' THEN 'Invalid'  ELSE '' END) AS NPIStatus, 
			(CASE WHEN CAST(JSON_VALUE(ppreg.[DocumentVersions], '$.docStatus') AS VARCHAR) = 'Agreement Submitted' THEN CAST(JSON_VALUE(ppreg.[DocumentVersions], '$.updatedOn') AS VARCHAR) ELSE '' END) AS agreementSubmittedDate, 
			ISNULL(CAST(JSON_VALUE(ppreg.[AgreementData], '$.npiStatus') AS VARCHAR),'') AS agreementStatus, 
			ISNULL(CAST(JSON_VALUE(ppreg.[AgreementData], '$.npiStatus') AS VARCHAR),'') AS registrationStatus, 
			CAST((CASE WHEN (CAST(JSON_VALUE(ppreg.[DocumentVersions], '$.docStatus') AS VARCHAR)='Agreement Submitted' AND ppreg.DocumentData IS NOT NULL) THEN 1 ELSE 0 END) AS BIT) AS viewDocument, 
			ISNULL(ppreg.TransactionKey ,'') AS transactionKey, 
			LegalBusinessName as prospectingAction
			INTO #PREREGISTRATION FROM npn.providerpreregistration ppreg

SELECT pr.registrationSubmittedDate, 
			tt.prospectingStatus, 
			tt.transactionkey,
			pr.rowId, 
			pr.providerlegalBusinessName, 
			pr.ownerName, 
			pr.ownerEmail, 
			pr.NPINumber, 
			pr.NPIStatus, 
			pr.agreementSubmittedDate, 
			pr.agreementStatus, 
			pr.registrationStatus, 
			CAST((CASE WHEN (SELECT Count(*) FROM npn.transactiondetails WHERE Transactionkey=tt.transactionkey and status in('AUTHORIZED'))=1 THEN 1 
			           WHEN (SELECT Count(*) FROM npn.transactiondetails WHERE Transactionkey=tt.transactionkey and status in('AUTHORIZED','REGISTRATION_SUBMITTED','REGISTRATION_AUTHORIZED'))>=2 THEN 1 else 0 end) as bit) as viewDocument, 
			(CASE WHEN (tt.prospectingStatus='New Lead') THEN 'Send Contract' 
				  WHEN (tt.prospectingStatus='Contract Sent') THEN 'Upload Agreement' 
				  WHEN (tt.prospectingStatus='Agreement Viewed') THEN 'Upload Agreement'
				  WHEN (tt.prospectingStatus='Agreement In Progress')  THEN 'Upload Agreement' 
			      WHEN (tt.prospectingStatus='Agreement Submitted') THEN 'Authorize Agreement' 
				  WHEN (tt.prospectingStatus='Agreement Authorized') THEN 'Fill Registration' 
				  WHEN (tt.prospectingStatus='Provider Declined' OR tt.prospectingStatus='Agreement Rejected') THEN '' 
				  WHEN (tt.prospectingStatus='Registration Submitted') THEN (CASE WHEN (SELECT Count(*) FROM npn.transactiondetails WHERE Transactionkey=tt.transactionkey and status='AUTHORIZED')=0 THEN 'Authorize Agreement' else 'Authorize Registration'end)
				  WHEN (tt.prospectingStatus='Registration Authorized') THEN (CASE WHEN (SELECT Count(*) FROM npn.transactiondetails WHERE Transactionkey=tt.transactionkey and status in('AUTHORIZED'))=1 THEN 'Grant Provider Portal' end)  else '' end) as prospectingAction,
			tt.ModifyDate,
			tt.PModifyDate
INTO #PROSPECTINGACTIONdDATA
FROM #PREREGISTRATION pr INNER JOIN #TEMPTRANSACTIONS tt 
ON tt.transactionkey = pr.transactionkey

IF((@fromDate != 'NULL' AND @fromDate !='') AND (@toDate != 'NULL' AND @toDate !=''))
BEGIN
SELECT registrationSubmittedDate, 
	   prospectingStatus, 
	   transactionkey,
	   rowId, 
	   providerlegalBusinessName, 
	   ownerName, 
	   ownerEmail, 
	   NPINumber, 
	   NPIStatus, 
	   agreementSubmittedDate, 
	   agreementStatus, 
	   registrationStatus,viewDocument,prospectingAction,ModifyDate FROM #PROSPECTINGACTIONdDATA WHERE PModifyDate BETWEEN @fromDate AND @toDate
END
ELSE
BEGIN
SELECT registrationSubmittedDate, 
	   prospectingStatus, 
	   transactionkey,
	   rowId, 
	   providerlegalBusinessName, 
	   ownerName, 
	   ownerEmail, 
	   NPINumber, 
	   NPIStatus, 
	   agreementSubmittedDate, 
	   agreementStatus, 
	   registrationStatus,viewDocument,prospectingAction,ModifyDate FROM #PROSPECTINGACTIONdDATA ORDER BY ModifyDate DESC
END
END


CREATE PROCEDURE [Orders].[GetPOChannelsByOrderId]

          @OrderID bigint
AS
BEGIN

		SET NOCOUNT ON;
              SELECT DISTINCT
              a.[IsSinglePO],
             a.[ItemTypeCode],
              (
              CASE WHEN a.[CommunicationMode] IS null OR b.[StyleCode] is null THEN 'EMAIL'

                    -- ELSE JSON_VALUE(a.[CommunicationMode],'$."'+b.[StyleCode]+'"')
				WHEN JSON_VALUE(a.[CommunicationMode],'$."'+b.[StyleCode]+'"') IS NULL THEN 'EMAIL'
				ELSE JSON_VALUE(a.[CommunicationMode],'$."'+b.[StyleCode]+'"')
                      END

              ) AS [POChannel]

              FROM Orders.ItemTypeConfig a

              INNER JOIN  Orders.OrderItems b on

                     b.[ItemType] = a.[ItemTypeCode] and

                     b.BrandCode is not null and b.IsActive=1 and

                     b.BrandCode = a.BrandCode and

                     b.OrderId=@OrderID and

                     b.OrderId=@OrderID

END
CREATE PROCEDURE [Orders].[GetExchangeCredit](@NHMemberId NVARCHAR(20))
AS
BEGIN
  SELECT  1 AS ID, ISNULL(SUM(CONVERT(FLOAT,JSON_VALUE(OrderAmountData, '$.exchangeCredit'))),0) AS 'ExchangeCredit',ISNULL(SUM(CONVERT(FLOAT,JSON_VALUE(OrderAmountData, '$.cancelCredit'))),0) AS 'CancelCredit' FROM [Orders].[Orders] WHERE NHMemberId = @NHMemberId
END


create PROCEDURE [Orders].[GetPOChannelsByponumber]
          @poNumber bigint
AS
BEGIN
       
       SET NOCOUNT ON;
 
              SELECT DISTINCT
              a.[IsSinglePO],
              a.[ItemTypeCode],
              (
              CASE WHEN a.[CommunicationMode] IS null OR b.[StyleCode] is null THEN 'EMAIL'
                     ELSE JSON_VALUE(a.[CommunicationMode],'$.'+b.[StyleCode])
                      END
              ) AS [POChannel]
              FROM Orders.ItemTypeConfig a
              INNER JOIN  Orders.OrderItems b on
                     b.[ItemType] = a.[ItemTypeCode] and
                     b.BrandCode is not null and
                     b.BrandCode = a.BrandCode and
                     b.poNumber=@poNumber --and b.OrderId=@OrderID
END

--STEP 1 Orders.GetHearingAidOrderItemDetails

CREATE PROCEDURE Orders.GetHearingAidOrderItemDetails
@OrderId bigint

AS
SELECT	[Modifier]
		,OrderItemId
		,JSON_VALUE(ItemData,'$."color"') AS Color
		,JSON_VALUE(ItemData,'$."batterySize"') AS BatterySize
		,JSON_VALUE(ItemData,'$."receiverSize"') AS ReceiverSize
		,JSON_VALUE(ItemData,'$."receiverPower"') AS ReceiverPower
		,JSON_VALUE(ItemData,'$."sendingImpression"') AS  SendingImpression,OrderId,[CreateDate] AS ServiceDate
		,[ItemCode]
FROM  [Orders].[OrderItems] 
WHERE orderid=@OrderId  AND itemtype='HA' AND isactive=1 --180024683

----STEP 3 Orders.GetMemberCopayDetails

CREATE PROCEDURE Orders.GetMemberCopayDetails
@mcdId BIGINT
AS
DECLARE @grpId varchar(50);
SET @grpId = (SELECT TOP 1 JSON_VALUE(ProcessData, '$.transactionGroupID') FROM [provider].[MemberChartData] WHERE MemberChartDataId=@mcdId)

SELECT
	 MemberChartDataId
	,MinorProcessId
	,CONVERT(BIGINT,ISNULL(JSON_VALUE(ProcessData, '$.orderID'),0)) AS OrderId
	,CONVERT(DECIMAL(10,2),ISNULL(JSON_VALUE(ProcessData, '$.copayAmount'),0)) AS CopayAmount
	,CONVERT(DECIMAL(10,2),ISNULL(JSON_VALUE(ProcessData, '$.amountPaid'),0)) AS AmountPaid
	,d.CreateDate AS ServiceDate
FROM provider.MemberChartData d WHERE MinorProcessId IN (20, 29, 34, 38) AND JSON_VALUE(ProcessData, '$.transactionGroupID')=@grpId


----STEP 4 Orders.GetMemberCopayTransactionDetails

CREATE PROCEDURE Orders.GetMemberCopayTransactionDetails
@mcdId BIGINT
AS
SELECT * FROM OPENJSON((SELECT TOP 1 ProcessData FROM provider.MemberChartData WHERE MemberChartDataId=@mcdId))
		WITH (
			TotalAmount  VARCHAR(20) '$.totalAmount',
			TransactionGroupId VARCHAR(100) '$.transactionGroupID',
			Transactions NVARCHAR(MAX) '$.transaction' AS JSON
			)
	OUTER APPLY OPENJSON (transactions)
WITH (
	TransactionId VARCHAR(100) '$.transactionId',
	PaymentType VARCHAR(10) '$.paymentType',
	CardOrBank VARCHAR(10) '$.cardOrBank',
	PaymentDate varchar(20) '$.paymentDate',
	AmountPaid VARCHAR(10) '$.amountPaid',
	FinanceCompany VARCHAR(30) '$.financeCompany',
	RoutingNumber VARCHAR(30) '$.routingNumber',
	CheckNumber VARCHAR(30) '$.checkNbr',
			AccountNumber VARCHAR(30) '$.accountNumber',
			ReceiptNumber VARCHAR(20) '$.receiptNo'
		)
CREATE PROCEDURE [Orders].[GetHearingOrderPaymentDetails]
@OrderId BIGINT
AS
	SELECT * FROM OPENJSON((SELECT OrderTransactionData 
							FROM [Orders].[OrderTransactionDetails] 
							WHERE orderstatuscode='pay' AND orderid=@OrderId )) --180024683
		WITH(
			TotalAmount  VARCHAR(20) '$.totalAmount',
			TransactionGroupId VARCHAR(100) '$.transactionGroupId',
			Transactions NVARCHAR(MAX) '$.transactions' as json
			)
		OUTER APPLY OPENJSON (transactions)
		WITH (
			TransactionId VARCHAR(100) '$.transactionId',
			PaymentType VARCHAR(10) '$.paymentType',
			CardOrBank VARCHAR(10) '$.cardOrBank',
			PaymentDate VARCHAR(20) '$.paymentDate',
			AmountPaid VARCHAR(10) '$.amountPaid',
			FinanceCompany VARCHAR(30) '$.financeCompany',
			RoutingNumber VARCHAR(30) '$.routingNumber',
			CheckNumber VARCHAR(30) '$.checkNbr',
			AccountNumber VARCHAR(30) '$.accountNumber',
			ReceiptNumber VARCHAR(20) '$.receiptNo'
			)



CREATE PROCEDURE [Orders].[ReturnOrder]
(
	@OrderID INT,
	@ReturnDt  nvarchar(50),
	@returnRequestedBy nvarchar(50),
	@returnReason nvarchar(300),
	@NumberOfUnitsReturned int,
	@ReturnSide varchar(10),
	@CreditInvoiceDt  nvarchar(50),
	@CreditInvoiceNbr varchar(20),
	@CreditInvoiceAmount decimal
)

AS
BEGIN
	SET NOCOUNT ON;
	DECLARE @TotalUnits int;

	SET @TotalUnits = (SELECT sum(Quantity) from orders.orderItems where ItemType in ('HA','CROS') and OrderID = @OrderID)

	if(@TotalUnits = @NumberOfUnitsReturned)
		BEGIN

				Insert into orders.ordertransactiondetails
				(			[OrderID] ,[OrderStatusCode] ,[OrderTransactionData]
						   ,[IsComplete] ,[CreateDate] ,[CreateUser] ,[ModifyDate] ,[ModifyUser] ,[IsActive]
				)
				values
				(
						 @OrderID, 'RET',  '{"returnDt":"'+cast(@ReturnDt as varchar)+'","returnReason":"'+@returnReason+'","returnRequestedBy":"'+@returnRequestedBy
						 +'","ReturnSide":"'+@ReturnSide +'","NumberOfUnitsReturned":"'+cast(@NumberOfUnitsReturned as varchar)+'"}'
						 ,1 ,getDate(), @returnRequestedBy, getdate(), @returnRequestedBy, 1
				)

				if(@CreditInvoiceAmount is not NULL)
				BEGIN
					Insert into orders.ordertransactiondetails
					(			[OrderID] ,[OrderStatusCode] ,[OrderTransactionData]
							   ,[IsComplete] ,[CreateDate] ,[CreateUser] ,[ModifyDate] ,[ModifyUser] ,[IsActive]
					)
					values
					(
							 @OrderID, 'REF',  '{"transactionGroupId":"","transactions":[{"transactionId":"","accountNumber":"","cardOrBank":"","paymentType":"","paymentDate":"'+cast(@CreditInvoiceDt as varchar)+
							 '","amountPaid":'+cast(@CreditInvoiceAmount as varchar)+',"responseDescription":"","transactionOrderRef":"'+@CreditInvoiceNbr+
							 '","transactionStatus":true,"last4digits":""}],"totalAmount":'+cast(@CreditInvoiceAmount as varchar)+'}'
							 ,1 ,getDate(), @returnRequestedBy, getdate(), @returnRequestedBy, 1
					)
				END


				if(SCOPE_IDENTITY() is not null)
					BEGIN

							update ORDERS.ORDERS
							set status='RETURNED',
							OrderStatusCode = 'RET',
							[ModifyDate]=getdate() ,
							[ModifyUser]=@returnRequestedBy
							where orderid = @OrderID

							--update OrderItems 
							update ORDERS.ORDERITEMS
							set status='RETURNED',
							[ModifyDate]=getdate() ,
							[ModifyUser]=@returnRequestedBy
							where orderid = @OrderID

				END


				
		END

	ELSE if(@TotalUnits > @NumberOfUnitsReturned)
		BEGIN
			
			Insert into orders.ordertransactiondetails
				(			[OrderID] ,[OrderStatusCode] ,[OrderTransactionData]
						   ,[IsComplete] ,[CreateDate] ,[CreateUser] ,[ModifyDate] ,[ModifyUser] ,[IsActive]
				)
				values
				(
						 @OrderID, 'RET',  '{"returnDt":"'+cast(@ReturnDt as varchar)+'","returnReason":"'+@returnReason+'","returnRequestedBy":"'+@returnRequestedBy
						 +'","ReturnSide":"'+@ReturnSide +'","NumberOfUnitsReturned":"'+cast(@NumberOfUnitsReturned as varchar)+'"}'
						 ,1 ,getDate(), @returnRequestedBy, getdate(), @returnRequestedBy, 1
				)

				if(@CreditInvoiceAmount is not NULL)
				BEGIN
					Insert into orders.ordertransactiondetails
					(			[OrderID] ,[OrderStatusCode] ,[OrderTransactionData]
							   ,[IsComplete] ,[CreateDate] ,[CreateUser] ,[ModifyDate] ,[ModifyUser] ,[IsActive]
					)
					values
					(
							 @OrderID, 'REF',  '{"transactionGroupId":"","transactions":[{"transactionId":"","accountNumber":"","cardOrBank":"","paymentType":"","paymentDate":"'+cast(@CreditInvoiceDt as varchar)+
							 '","amountPaid":'+cast(@CreditInvoiceAmount as varchar)+',"responseDescription":"","transactionOrderRef":"'+@CreditInvoiceNbr+
							 '","transactionStatus":true,"last4digits":""}],"totalAmount":'+cast(@CreditInvoiceAmount as varchar)+'}'
							 ,1 ,getDate(), @returnRequestedBy, getdate(), @returnRequestedBy, 1
					)
				END


				if(SCOPE_IDENTITY() is not null)
					BEGIN

							--update ORDERS.ORDERS
							--set status='RETURNED',
							--OrderStatusCode = 'RET',
							--[ModifyDate]=getdate() ,
							--[ModifyUser]=@returnRequestedBy
							--where orderid = @OrderID

							--update OrderItems 
							update ORDERS.ORDERITEMS
							set status='RETURNED',
							[ModifyDate]=getdate() ,
							[ModifyUser]=@returnRequestedBy
							where orderid = @OrderID 
							and modifier=@ReturnSide

					END



		END

END
CREATE PROCEDURE [Orders].[GetDocumentcheckDetails]
(
   @orderId bigint
)
AS
BEGIN
    -- declare @orderId bigint =190001722
	select distinct DL.[DocumentLookUpName],DL.[DocumentLookUpCode],DT.[DocumentTypeCode] 
	from orders.orders O 
		inner join [provider].[MemberChartData] MCD on MCD.[MemberChartDataId]=O.[MemberChartDataId]
		inner join [provider].[MemberCharts] MC on MC.[MemberChartId]=MCD.[MemberChartId]
		inner join [Document].[DocumentTransaction] DT on DT.[MemberChartId]=MCD.[MemberChartId] and DT.[MemberChartDataId]=O.[MemberChartDataId]
		right join [Document].[DocumentLookup] DL on DL.[DocumentLookUpCode]=DT.[DocumentTypeCode]
		and MC.Isactive=1 and MCD.isactive=1 and o.isactive=1 and Dt.isactive=1 and DL.isactive=1
		and [DocumentTypeCode] In ('DOC_AOB','DOC_HIPA','DOC_AGM')
		and  o.orderid=@orderId 
	 where DL.[DocumentLookUpCode] In ('DOC_AOB','DOC_HIPA','DOC_AGM') 

END
CREATE PROCEDURE [Orders].[sp_GetPoDateByplanid]
   @orderid bigint 
AS
BEGIN
    -- SET NOCOUNT ON added to prevent extra result sets from
    -- interfering with SELECT statements.
    SET NOCOUNT ON

     -- declare @orderid int =180025074

 select top  1 1 AS ID, case when P.ProviderId is null then convert(datetime,po.PODate)+60 else  convert(datetime,po.PODate)+60 end as PODate  from orders.orders o 
 left join
 (select ProviderId,LocationId from [provider].[ProviderUserLocations] where 
 UserProfileId in(select userProfileid from [provider].[HCPProviderProfile] where IsMedicaid=1 and IsActive=1)
  ) P on P.ProviderId=JSON_VALUE(MemberData, '$.insCarrierId') and p.LocationId = JSON_VALUE(MemberData, '$.insPlanId')
 left join 
 (
 select it.[OrderId],(select res.PODate from (select *  from openjson(tr.ordertransactiondata)
		with (PODate date '$.poDate', PONumber nvarchar(50) '$.poNumber')) res
		where res.PONumber=cast(it.PONumber as nvarchar)) as PODate
 from [Orders].[OrderItems] it 
 inner join [catalog].[Brands] br
 on br.[BrandCode]=it.[BrandCode]
 inner join [Orders].[OrderTransactionDetails] tr  
 on tr.[OrderId] = it.[OrderId] and tr.[OrderStatusCode]='PO' 
 )po on po.OrderId =o.orderid
 where o.orderId=@orderid
END
CREATE PROCEDURE [Orders].[sp_GetFittingDateByplanid]
   @orderid bigint 
AS
BEGIN
    SET NOCOUNT ON
--Fitting Date from CLM transaction
declare @fitDate date = (select top 1 cast(JSON_VALUE(OrderTransactionData, '$.fittingDate') as date) from [Orders].[OrderTransactionDetails] 
 where orderstatuscode='CLM' and orderid=@orderid and isactive=1);
if (@fitDate is null or @fitDate='')
begin
--Fitting Date = Order Date + 21 (Same logic in GetBenefitsUsed)
	set @fitDate = (select top 1 dateadd(day, 21, cast(JSON_VALUE(OrderTransactionData, '$.orderDate') as date)) from [Orders].[OrderTransactionDetails] 
 where orderstatuscode='INI' and orderid=@orderid and isactive=1);
end
select top  1
1 as ID,
case when hpl.IsMedicaid=1
	then dateadd(day, 90, @fitDate)
	else dateadd(day, 60, @fitDate)
end as WarrantyEndDate 
from orders.orders o
inner join Insurance.InsuranceHealthPlans hpl
on hpl.[InsuranceHealthPlanID] = json_value(o.MemberData, '$.insPlanId') and hpl.IsActive=1
 where o.orderId=@orderid
END

CREATE PROCEDURE [Orders].[CreateOrderMemberChartData] 
(
    -- Add the parameters for the stored procedure here
	@MemberChartId BIGINT,
	@Date NVARCHAR(200),
	@ProviderId BIGINT,
	@LocationId BIGINT
)
AS
BEGIN
BEGIN TRY
    -- SET NOCOUNT ON added to prevent extra result sets from
    -- interfering with SELECT statements.
    SET NOCOUNT ON

	DECLARE @MemberChartIdCheck BIGINT;
	DECLARE @MemberChartDataId TABLE (ID BIGINT);

	IF @Date IS NOT NULL
		BEGIN
			SELECT @MemberChartIdCheck = (
				SELECT TOP 1 MemberChartId FROM provider.MemberCharts
				WHERE MemberChartId = @MemberChartId
			)

			IF @MemberChartIdCheck is NULL 
				RAISERROR (
					'Member Chart not found in DB', -- Message text.  
					16, -- Severity.  
					1 -- State.  
				);

			INSERT INTO provider.MemberChartData (
				MemberChartId,
				DocumentID,
				IsDocumentComplete,
				MajorProcessId,
				MinorProcessId,
				ProviderId,
				LocationId,
				ProcessData,
				CreateUser,
				CreateDate,
				ModifyUser,
				ModifyDate,
				IsActive
			) OUTPUT INSERTED.MemberChartDataId INTO @MemberChartDataId
			VALUES (
				@MemberChartId,
				0,
				1,
				5,
				23,
				@ProviderId,
				@LocationId,
				'{ "orderId":"XXXXX","orderDate":"'+@Date+'","status":"Complete" }',
				CURRENT_USER,
				GETDATE(),
				CURRENT_USER,
				GETDATE(),
				1
			)

			SELECT TOP 1 ID from @MemberChartDataId
       	END
		ELSE
		BEGIN
		          RAISERROR ('Date missing', -- Message text.  
                              16, -- Severity.  
                              1 -- State.  
                             );  
		END
		--IF ENDs
END TRY
BEGIN CATCH  
    DECLARE @ErrorMessage NVARCHAR(4000);  
    DECLARE @ErrorSeverity INT;  
    DECLARE @ErrorState INT;  

    SELECT   
        @ErrorMessage =  ERROR_MESSAGE(),  
        @ErrorSeverity = ERROR_SEVERITY(),  
        @ErrorState = ERROR_STATE();  

    -- Use RAISERROR inside the CATCH block to return error  
    -- information about the original error that caused  
    -- execution to jump to the CATCH block.  
    RAISERROR (@ErrorMessage, -- Message text.  
               @ErrorSeverity, -- Severity.  
               @ErrorState -- State.  
               );  
END CATCH;  
END
/****** Object:  StoredProcedure [Orders].[ExchangeOrder]    Script Date: 9/28/2018 5:06:20 PM ******/



CREATE PROCEDURE [Orders].[ExchangeOrder]
(
@OldOrderID INT,
@exchangeRequestedBy nvarchar(50),
@NewOrderID INT
)
AS
BEGIN



	update ORDERS.ORDERS
	set status='RETURNED',orderstatuscode='RET',
	[ModifyDate]=getdate() ,
	[ModifyUser]=@exchangeRequestedBy
	where orderid = @OldOrderID

	update ORDERS.ORDERS
	set [RefOrderId]=@OldOrderID,
	status='ACTIVE',
	Ordertype='EXCHANGE',
	[ModifyDate]=getdate() ,
	[ModifyUser]=@exchangeRequestedBy
	where orderid = @NewOrderID

	update orders.orderitems 
	set modifydate=getdate()
	,modifyuser=@exchangeRequestedBy
	,status='RETURNED'
	where orderid =@OldOrderID

	--update orders.orderitems 
	--set modifydate=getdate()
	--,modifyuser=@exchangeRequestedBy
	--,status='EXCHANGE'
	--where orderid =@NewOrderID


END


CREATE PROCEDURE [Orders].[GetMemberChartId] 
(
    -- Add the parameters for the stored procedure here
    @NHMemberId NVARCHAR(50)
)
AS
BEGIN
BEGIN TRY
    -- SET NOCOUNT ON added to prevent extra result sets from
    -- interfering with SELECT statements.
    SET NOCOUNT ON

	DECLARE @NHMemberIdCheck BIGINT;
	DECLARE @MemberChartIdCheck BIGINT;
	DECLARE @NewMemberChartId table (MemberChartId bigint);

	IF @NHMemberId IS NOT NULL
		BEGIN
			--1. Check validity of Input Params 
			SELECT @NHMemberIdCheck = (
				SELECT TOP 1 MemberProfileId FROM provider.MemberProfiles
				WHERE NHMemberId = @NHMemberId
			)

			IF @NHMemberIdCheck is NULL 
				RAISERROR (
					'NHMemberId not found in DB', -- Message text.  
					16, -- Severity.  
					1 -- State.  
				); 
			
			SELECT @MemberChartIdCheck = (
				SELECT TOP 1 MemberChartId FROM provider.MemberCharts
				WHERE MemberProfileId = @NHMemberIdCheck
				Order by memberchartid desc
			)

			IF @MemberChartIdCheck is NULL 
			BEGIN
				INSERT INTO provider.MemberCharts
				(
					MemberProfileId
					,VisitNumber
					,IsChartClosed
					,CreateDate
					,CreateUser
					,ModifyDate
					,ModifyUser
					,IsActive
				) OUTPUT INSERTED.MemberChartId INTO @NewMemberChartId
				VALUES (
					@NHMemberIdCheck
					,1
					,0
					,GETDATE()
					,'VanillaSoftOrderLoader'
					,GETDATE()
					,'VanillaSoftOrderLoader'
					,1
				)
				SELECT MemberChartId from @NewMemberChartId;
			END
			ELSE
			BEGIN
				SELECT @MemberChartIdCheck;
			END
       	END
		ELSE
		BEGIN
		          RAISERROR ('NHMemberId missing', -- Message text.  
                              16, -- Severity.  
                              1 -- State.  
                             );  
		END
		--IF ENDs
END TRY
BEGIN CATCH  
    DECLARE @ErrorMessage NVARCHAR(4000);  
    DECLARE @ErrorSeverity INT;  
    DECLARE @ErrorState INT;  

    SELECT   
        @ErrorMessage =  ERROR_MESSAGE(),  
        @ErrorSeverity = ERROR_SEVERITY(),  
        @ErrorState = ERROR_STATE();  

    -- Use RAISERROR inside the CATCH block to return error  
    -- information about the original error that caused  
    -- execution to jump to the CATCH block.  
    RAISERROR (@ErrorMessage, -- Message text.  
               @ErrorSeverity, -- Severity.  
               @ErrorState -- State.  
               );  
END CATCH;  
END
CREATE PROCEDURE [Orders].[GetMemberJSONFromNHMemberId]
(
    -- Add the parameters for the stored procedure here
	@NHMemberId NVARCHAR(50),
	@FirstName NVARCHAR(100),
	@LastName NVARCHAR(100),
	@PONumber NVARCHAR(100)
	--{"firstName":"","lastName":"","phoneNumber":null,"dob":"1950-07-14","address":{},"insurance":{"carrierName":"","planName":"","programeName":"","insuranceMemberId":"","nhMemberId":"","insuranceBenefit":0,"benefitUsed":"","lastBenefitUsedDate":""},"insuranceBenefit":0,"insCarrierId":14,"insPlanId":33}
)
AS
BEGIN
BEGIN TRY
    -- SET NOCOUNT ON added to prevent extra result sets from
    -- interfering with SELECT statements.
    SET NOCOUNT ON

	DECLARE @NHMemberIdCheck BIGINT;
	DECLARE @FirstLastCheck BIGINT;

	IF @NHMemberId IS NOT NULL AND
	@FirstName IS NOT NULL AND
	@LastName IS NOT NULL AND
	@PONumber IS NOT NULL
		BEGIN
			--1. Check validity of Input Params 
			SELECT @NHMemberIdCheck = (
				SELECT TOP 1 
					MemberProfileId
				FROM provider.MemberProfiles
				WHERE NHMemberId = @NHMemberId
			)

			IF @NHMemberIdCheck is NULL 
				RAISERROR (
					'NH MemberID not found in DB ', -- Message text.  
					16, -- Severity.  
					1 -- State.  
				);

			SELECT @FirstLastCheck = (
				SELECT TOP 1
					MemberProfileId
				FROM provider.MemberProfiles
				WHERE LOWER(FirstName) = @FirstName AND LOWER(LastName) = @LastName AND NHMemberID = @NhMemberId
			)

			IF @FirstLastCheck is NULL 
				RAISERROR (
					'Member First Name + Last Name is mis-matched with NHMemberID in DB ', -- Message text.  
					16, -- Severity.  
					1 -- State.  
				);


			SELECT TOP (1)
				'{'+
				'"firstName":"'+ISNULL(a.FirstName,'')+'",'+
				'"lastName":"'+ISNULL(a.LastName,'')+'",'+
				'"phoneNumber":null,' +
				'"dob":"'+ISNULL(FORMAT(memberprofiles.DateOfBirth, 'd', 'en-US' ), '01-01-0001')+'",'+
				'"address":{'+
				'"address":"'+ISNULL(provider.MemberLocations.Address1, '') + ' ' + ISNULL(provider.MemberLocations.Address2, '')+'",'+
				'"city":"'+ISNULL(provider.MemberLocations.City, '')+'",'+
				'"state":"'+ISNULL(provider.MemberLocations.State, '')+'",'+
				'"zip":"'+ISNULL(provider.memberLocations.ZipCode, '')+'"},'+
				'"insurance":{'+
				'"carrierName":"'+ISNULL(carr.InsuranceCarrierName, '')+'",'+
				'"planName":"'+ISNULL(plans.HealthPlanName, '')+'",'+
				'"programeName":"'+case when insurances.InsuranceCarrierID = 207 then ISNULL(prog.DiscountProgramName,'') else '' end+'",'+
				'"insuranceMemberId":"'+case when insurances.InsuranceCarrierID = 207 then ISNULL(prog.DiscountProgramMemberID,'') else ISNULL(provider.MemberInsuranceDetails.InsuranceNbr,'') end +'",'+
				'"nhMemberId":"'+ISNULL(a.NHMemberId, '')+'",'+
				'"insuranceBenefit":'+ case when insurances.InsuranceCarrierID = 207 then cast(0 as nvarchar) else cast(ISNULL(benefit.BenefitAmt,'') as nvarchar) end +','+
				'"benefitUsed":"'+''+'",'+
				'"lastBenefitUsedDate":"'+''+'"},'+
				'"insCarrierId":'+case when insurances.InsuranceCarrierID = 207 then ISNULL(cast(prog.InsuranceCarrierID as nvarchar), '') else ISNULL(cast(insurances.InsuranceCarrierID as nvarchar), '') end +','+
				'"insPlanId":'+case when insurances.InsuranceCarrierID = 207 then ISNULL(cast(prog.InsuranceHealthPlanID as nvarchar), '') else ISNULL(cast(insurances.InsuranceHealthPlanID as nvarchar), '') end +'}'
				FROM [Orders].[MemberOrdersVStoCRM] a
				LEFT OUTER JOIN [vsdatamig].[vsCRMClaimsNew] e ON e.ContactID = a.ContactID
				LEFT OUTER JOIN (select memberprofileId, nhmemberid, DateOfBirth from provider.memberprofiles) memberprofiles ON memberprofiles.nhmemberid = SUBSTRING(a.Nhmemberid, 0, 15) 
				LEFT OUTER JOIN provider.MemberLocations ON memberprofiles.memberprofileid = provider.MemberLocations.MemberProfileID
				LEFT OUTER JOIN (select * from provider.MemberInsurances where IsActive = 1) insurances ON insurances.MemberProfileId = memberprofiles.MemberProfileId
				LEFT OUTER JOIN provider.MemberInsuranceDetails ON insurances.MemberInsuranceID = provider.MemberInsuranceDetails.MemberInsuranceID
				LEFT OUTER JOIN provider.MemberProgramDetails prog on prog.MemberProfileId = memberprofiles.MemberProfileId
				LEFT OUTER JOIN Insurance.InsuranceCarriers carr on carr.InsuranceCarrierID = insurances.InsuranceCarrierID
				LEFT OUTER JOIN Insurance.InsuranceHealthPlans plans on plans.InsuranceHealthPlanID = insurances.InsuranceHealthPlanID
				LEFT OUTER JOIN Insurance.HealthPlanContracts b on insurances.insurancehealthplanid = b.InsuranceHealthPlanID
				LEFT OUTER JOIN insurance.ContractBenefits benefit on b.HealthPlanContractID = benefit.HealthPlanContractID
				WHERE a.PONumber = @PONumber;

       	END
		ELSE
		BEGIN
		          RAISERROR ('NHMemberId/Firstname/Lastname missing', -- Message text.  
                              16, -- Severity.  
                              1 -- State.  
                             );  
		END
		--IF ENDs
END TRY
BEGIN CATCH  
    DECLARE @ErrorMessage NVARCHAR(4000);  
    DECLARE @ErrorSeverity INT;  
    DECLARE @ErrorState INT;  

    SELECT   
        @ErrorMessage =  ERROR_MESSAGE(),  
        @ErrorSeverity = ERROR_SEVERITY(),  
        @ErrorState = ERROR_STATE();  

    -- Use RAISERROR inside the CATCH block to return error  
    -- information about the original error that caused  
    -- execution to jump to the CATCH block.  
    RAISERROR (@ErrorMessage, -- Message text.  
               @ErrorSeverity, -- Severity.  
               @ErrorState -- State.  
               );  
END CATCH;  
END

CREATE PROCEDURE [Orders].[GetOrderDetailsFromItemCode]  
(
    -- Add the parameters for the stored procedure here
	@ItemCode NVARCHAR(100)
)
AS
BEGIN
BEGIN TRY
    -- SET NOCOUNT ON added to prevent extra result sets from
    -- interfering with SELECT statements.
    SET NOCOUNT ON

	DECLARE @ItemCodeCheck NVARCHAR(100);

	IF @ItemCode IS NOT NULL
		BEGIN
			--1. Check validity of Input Params 
			SELECT @ItemCodeCheck = (
				SELECT TOP 1 ItemCode FROM [catalog].[viewModelList]
				WHERE REPLACE(ItemCode, ' ', '') = @ItemCode
			)

			IF @ItemCodeCheck is NULL 
				RAISERROR (
					'ItemCode not found in DB ', -- Message text.  
					16, -- Severity.  
					1 -- State.  
				);

			SELECT TOP 1 Brand, Family, Technology, Model, Style 
				FROM catalog.viewModelList
				WHERE REPLACE(ItemCode, ' ', '') = @ItemCode
       	END
		ELSE
		BEGIN
		          RAISERROR ('ItemCode missing', -- Message text.  
                              16, -- Severity.  
                              1 -- State.  
                             );  
		END
		--IF ENDs
END TRY
BEGIN CATCH  
    DECLARE @ErrorMessage NVARCHAR(4000);  
    DECLARE @ErrorSeverity INT;  
    DECLARE @ErrorState INT;  

    SELECT   
        @ErrorMessage =  ERROR_MESSAGE(),  
        @ErrorSeverity = ERROR_SEVERITY(),  
        @ErrorState = ERROR_STATE();  

    -- Use RAISERROR inside the CATCH block to return error  
    -- information about the original error that caused  
    -- execution to jump to the CATCH block.  
    RAISERROR (@ErrorMessage, -- Message text.  
               @ErrorSeverity, -- Severity.  
               @ErrorState -- State.  
               );  
END CATCH;  
END

CREATE PROCEDURE [Orders].[GetProviderJSONFromProviderId]
(
    -- Add the parameters for the stored procedure here
	@ProviderId BIGINT,
	@PONumber NVARCHAR(50)
	--{"providerLeagalBusinessName":"","dba":"","dispenser":"","emailId":"","address":{"address":"4155 S Suncoast Blvd","city":"Homosassa","state":"FL","zip":"34446","locationId":353},"hcp":{"firstName":"Roger","lastName":"Throneburg","npiNumber":"","phoneNumber":"","faxNumber":""},"providerId":133}
)
AS
BEGIN
BEGIN TRY
    -- SET NOCOUNT ON added to prevent extra result sets from
    -- interfering with SELECT statements.
    SET NOCOUNT ON

	DECLARE @ProviderIdCheck BIGINT;

	IF @ProviderId IS NOT NULL
	AND @PONumber IS NOT NULL
		BEGIN
			--1. Check validity of Input Params 
			SELECT @ProviderIdCheck = (
				SELECT TOP 1 
					ProviderId
					from [Orders].[MemberOrdersVStoCRM]
				WHERE ProviderId = @ProviderId
			)

			IF @ProviderIdCheck is NULL 
				RAISERROR (
					'Provider Id not found in DB ', -- Message text.  
					16, -- Severity.  
					1 -- State.  
				);

			 
			SELECT '{'+
				'"providerLeagalBusinessName":"'+ISNULL(ProviderName, '')+'",'+
				'"dba":"'+ISNULL(DBA,'')+'",'+
				'"dispenser":"'+ISNULL(SiteId,'')+'",'+
				'"emailId":"'+ISNULL(PrimaryEmailAddress,'')+'",'+
				'"address":{'+
				'"address":"'+ISNULL([ProviderShipToAddress],'')+'",'+
				'"address1":"'+ISNULL([ProviderShipToAddress],'')+'",'+
				'"city":"'+ISNULL([ProviderCity],'')+'",'+
				'"state":"'+ISNULL([ProviderState],'')+'",'+
				'"zip":"'+ISNULL([ProviderZipCode],'')+'",'+
				'"locationId":'+cast([LocationId] as nvarchar)+'},'+
				'"hcp":{'+
				'"firstName":"'+ISNULL(HCPName,'')+'",'+
				'"lastName":"'+''+'",'+
				'"npiNumber":"'+ISNULL(HCPNPINbr,'')+'",'+
				'"phoneNumber":"'+ISNULL(ProviderPhoneNbr,'')+'",' +
				'"hcpId":"'+''+'",'+
				'"faxNumber":"'+ISNULL(ProviderFaxNbr,'')+'"},'+
				'"providerId":'+cast(b.ProviderId as nvarchar)+'}'
				From Orders.MemberOrdersVStoCRM a
				LEFT OUTER JOIN provider.ProviderProfiles b on b.ProviderId = a.ProviderId
				WHERE a.ProviderId = @ProviderId
				AND PONumber = @PONumber
       	END
		ELSE
		BEGIN
		          RAISERROR ('ProviderId/PONumber missing', -- Message text.  
                              16, -- Severity.  
                              1 -- State.  
                             );  
		END
		--IF ENDs
END TRY
BEGIN CATCH  
    DECLARE @ErrorMessage NVARCHAR(4000);  
    DECLARE @ErrorSeverity INT;  
    DECLARE @ErrorState INT;  

    SELECT   
        @ErrorMessage =  ERROR_MESSAGE(),  
        @ErrorSeverity = ERROR_SEVERITY(),  
        @ErrorState = ERROR_STATE();  

    -- Use RAISERROR inside the CATCH block to return error  
    -- information about the original error that caused  
    -- execution to jump to the CATCH block.  
    RAISERROR (@ErrorMessage, -- Message text.  
               @ErrorSeverity, -- Severity.  
               @ErrorState -- State.  
               );  
END CATCH;  
END

CREATE PROCEDURE [Orders].[GetShippingJSONFromLocationId]
(
    -- Add the parameters for the stored procedure here
	@LocationId BIGINT,
	@PONumber NVARCHAR(100)
	--'{"providerBusinessName":"","fullName":"","address":{"address":"","city":"","state":"","zip":"","country":"USA"},"email":"","phoneNumber":"","shippingInstructions":""}'
)
AS
BEGIN
BEGIN TRY
    -- SET NOCOUNT ON added to prevent extra result sets from
    -- interfering with SELECT statements.
    SET NOCOUNT ON

	DECLARE @LocationIdCheck BIGINT;

	IF @LocationId IS NOT NULL
	AND @PONumber IS NOT NULL
		BEGIN
			--1. Check validity of Input Params 
			SELECT @LocationIdCheck = (
				SELECT TOP 1 
					LocationId
					from [Orders].[MemberOrdersVStoCRM]
				WHERE LocationId = @LocationId
			)

			IF @LocationIdCheck is NULL 
				RAISERROR (
					'Location Id not found in DB ', -- Message text.  
					16, -- Severity.  
					1 -- State.  
				);

			 
			SELECT '{'+
				'"providerBusinessName":"'+ISNULL(ProviderLegalName, '')+'",'+
				'"fullName":"'+ISNULL(ProviderLegalName, '')+'",'+
				'"address":{'+
				'"address":"'+ISNULL([ProviderShipToAddress], '')+'",'+
				'"address1":"'+ISNULL([ProviderShipToAddress], '')+'",'+
				'"city":"'+ISNULL([ProviderCity], '')+'",'+
				'"state":"'+ISNULL([ProviderState], '')+'",'+
				'"zip":"'+ISNULL([ProviderZipCode], '')+'",'+
				'"country":"USA"},'+
				'"email":"'+ISNULL(REPLACE(ProviderEmail, CHAR(13), ''), '')+'",'+
				'"phoneNumber":"'+ISNULL(ProviderPhoneNbr, '')+'",'+
				'"shippingInstructions":""}' [json]
				FROM Orders.MemberOrdersVStoCRM
				WHERE LocationId = @LocationId
				AND PONumber = @PONumber
       	END
		ELSE
		BEGIN
		          RAISERROR ('Shipping data missing', -- Message text.  
                              16, -- Severity.  
                              1 -- State.  
                             );  
		END
		--IF ENDs
END TRY
BEGIN CATCH  
    DECLARE @ErrorMessage NVARCHAR(4000);  
    DECLARE @ErrorSeverity INT;  
    DECLARE @ErrorState INT;  

    SELECT   
        @ErrorMessage =  ERROR_MESSAGE(),  
        @ErrorSeverity = ERROR_SEVERITY(),  
        @ErrorState = ERROR_STATE();  

    -- Use RAISERROR inside the CATCH block to return error  
    -- information about the original error that caused  
    -- execution to jump to the CATCH block.  
    RAISERROR (@ErrorMessage, -- Message text.  
               @ErrorSeverity, -- Severity.  
               @ErrorState -- State.  
               );  
END CATCH;  
END
CREATE PROCEDURE [Orders].[GetOrderDetailsByOrderId] --190002012
(
   @orderid bigInt
)
AS
BEGIN
    -- SET NOCOUNT ON added to prevent extra result sets from
    -- interfering with SELECT statements.
    SET NOCOUNT ON

	select  
	o.orderid,
	JSON_VALUE(ProviderData, '$.providerLeagalBusinessName')  ProviderBusinessName,
	JSON_VALUE(ProviderData, '$.dba')  ProviderdbaName,
	JSON_VALUE(ProviderData, '$.hcp.firstName')+JSON_VALUE(ProviderData, '$.hcp.lastName')  ProviderName,
	JSON_VALUE(ProviderData, '$.address.address')  ProviderAddress,
	JSON_VALUE(ProviderData, '$.address.city')  ProviderCity,
	JSON_VALUE(ProviderData, '$.address.state')  ProviderState,
	JSON_VALUE(ProviderData, '$.address.zip')  ProviderZipcode,
	JSON_VALUE(ProviderData, '$.address.country')  ProviderCountry,
	JSON_VALUE(ProviderData, '$.hcp.phoneNumber')  ProviderPhoneNumber,
	JSON_VALUE(ProviderData, '$.address.providerId') ProviderCode,
	JSON_VALUE(MemberData, '$.firstName')+ ' '+ JSON_VALUE(MemberData, '$.lastName') MemberName,
	JSON_VALUE(MemberData, '$.address.address') MemberAddress,
	JSON_VALUE(MemberData, '$.address.city') MemberCity,
	JSON_VALUE(MemberData, '$.address.state') MemberState,
	JSON_VALUE(MemberData, '$.address.zip')  MemberZipcode,
	JSON_VALUE(MemberData, '$.address') MemberCountry,
	JSON_VALUE(MemberData, '$.phoneNumber') MemberPhoneNumber,
	o.NhmemberId,
	ot.ordertransactiondata,
	o.OrderAmountData,
	o.ShippingData
	from orders.orders o
	join Orders.ordertransactionDetails ot on o.orderid=ot.orderid
	where o.orderid=@orderid and ot.orderstatuscode='PAY'
END




CREATE PROCEDURE [Orders].[PartialReturnOrder]
(
@OrderID INT,
@ReturnDt  nvarchar(50),
@returnRequestedBy nvarchar(50),
@returnReason nvarchar(300),
@NumberOfUnitsReturned int,
@ReturnSide varchar(10),
@CreditInvoiceDt  nvarchar(50),
@CreditInvoiceNbr varchar(20),
@CreditInvoiceAmount decimal
)

AS
BEGIN


Insert into orders.ordertransactiondetails
(			[OrderID] ,[OrderStatusCode] ,[OrderTransactionData]
           ,[IsComplete] ,[CreateDate] ,[CreateUser] ,[ModifyDate] ,[ModifyUser] ,[IsActive]
)
values
(
		 @OrderID, 'RET',  '{"returnDt":"'+cast(@ReturnDt as varchar)+'","returnReason":"'+@returnReason+'","returnRequestedBy":"'+@returnRequestedBy
		 +'","ReturnSide":"'+@ReturnSide +'","NumberOfUnitsReturned":"'+cast(@NumberOfUnitsReturned as varchar)+'"}'
		 ,1 ,getDate(), @returnRequestedBy, getdate(), @returnRequestedBy, 1
)

if(@CreditInvoiceAmount is not NULL)
BEGIN
	Insert into orders.ordertransactiondetails
	(			[OrderID] ,[OrderStatusCode] ,[OrderTransactionData]
			   ,[IsComplete] ,[CreateDate] ,[CreateUser] ,[ModifyDate] ,[ModifyUser] ,[IsActive]
	)
	values
	(
			 @OrderID, 'REF',  '{"transactionGroupId":"","transactions":[{"transactionId":"","accountNumber":"","cardOrBank":"","paymentType":"","paymentDate":"'+cast(@CreditInvoiceDt as varchar)+
			 '","amountPaid":'+cast(@CreditInvoiceAmount as varchar)+',"responseDescription":"","transactionOrderRef":"'+@CreditInvoiceNbr+
			 '","transactionStatus":true,"last4digits":""}],"totalAmount":'+cast(@CreditInvoiceAmount as varchar)+'}'
			 ,1 ,getDate(), @returnRequestedBy, getdate(), @returnRequestedBy, 1
	)
END


if(SCOPE_IDENTITY() is not null)
	BEGIN

			update ORDERS.ORDERS
			set status='PARTIALRET',devicecount=1,
			[ModifyDate]=getdate() ,
			[ModifyUser]=@returnRequestedBy
			where orderid = @OrderID
END


END
---{"CreditInvoiceDt":"'+cast(@CreditInvoiceDt as varchar)+'","CreditInvoiceNbr":"'+@CreditInvoiceNbr+'","CreditInvoiceAmount":"'+cast(@CreditInvoiceAmount as varchar)+'"}

CREATE PROCEDURE [Orders].[CancelOrder]
(
@OrderID INT,
@cancelReason nvarchar(300),
@cancelRequestedBy nvarchar(50)
)

AS
BEGIN

--SELECT ORDERID from ORDERS.ORDERTRANSACTIONDETAILS 
--WHERE [OrderStatusCode]= 'CAN' AND ORDERID = @OrdeID

Insert into orders.ordertransactiondetails
(			[OrderID] ,[OrderStatusCode] ,[OrderTransactionData]
           ,[IsComplete] ,[CreateDate] ,[CreateUser] ,[ModifyDate] ,[ModifyUser] ,[IsActive]
)
values
(
		 @OrderID, 'CAN', '{"cancelDate":"'+cast(getDate() as nvarchar)+'","cancelReason":"'+@cancelReason+'","cancelledBy":"'+@cancelRequestedBy+'"}'
		 ,1 ,getDate(), @cancelRequestedBy, getdate(), @cancelRequestedBy, 1
)



if(SCOPE_IDENTITY() is not null)
	BEGIN

			update ORDERS.ORDERS
			set status='CANCELLED',
			OrderStatusCode='CAN',
			[ModifyDate]=getdate() ,
			[ModifyUser]=@cancelRequestedBy
			where orderid = @OrderID

			
			update ORDERS.ORDERITEMS
			set status='CANCELLED',
			[ModifyDate]=getdate() ,
			[ModifyUser]=@cancelRequestedBy
			where orderid = @OrderID
	END


END

CREATE PROCEDURE [Orders].[UpdateMemberChartDataOrderId] 
(
    -- Add the parameters for the stored procedure here
	@MemberChartDataId BIGINT,
    @OrderId BIGINT
)
AS
BEGIN
BEGIN TRY
    -- SET NOCOUNT ON added to prevent extra result sets from
    -- interfering with SELECT statements.
    SET NOCOUNT ON

	DECLARE @OrderIdCheck BIGINT;
	DECLARE @MemberChartDataIdCheck BIGINT;

	IF @OrderId IS NOT NULL AND
	@MemberChartDataId IS NOT NULL
		BEGIN
			--1. Check validity of Input Params 
			SELECT @OrderIdCheck = (
				SELECT TOP 1 OrderId FROM Orders.Orders
				WHERE OrderId = @OrderId
			)

			IF @OrderIdCheck is NULL 
				RAISERROR (
					'Order not found in DB', -- Message text.  
					16, -- Severity.  
					1 -- State.  
				);

			SELECT @MemberChartDataIdCheck = (
				SELECT TOP 1 MemberChartDataId FROM provider.MemberChartData
				WHERE MemberChartDataId = @MemberChartDataId
			)

			IF @MemberChartDataIdCheck is NULL 
				RAISERROR (
					'Member Chart data not found in DB', -- Message text.  
					16, -- Severity.  
					1 -- State.  
				);

			UPDATE provider.MemberChartData
			SET ProcessData = REPLACE(ProcessData, 'XXXXX', @OrderId)
			WHERE MemberChartDataId = @MemberChartDataIdCheck

       	END
		ELSE
		BEGIN
		          RAISERROR ('OrderId or MemberChartDataId missing', -- Message text.  
                              16, -- Severity.  
                              1 -- State.  
                             );  
		END
		--IF ENDs
END TRY
BEGIN CATCH  
    DECLARE @ErrorMessage NVARCHAR(4000);  
    DECLARE @ErrorSeverity INT;  
    DECLARE @ErrorState INT;  

    SELECT   
        @ErrorMessage =  ERROR_MESSAGE(),  
        @ErrorSeverity = ERROR_SEVERITY(),  
        @ErrorState = ERROR_STATE();  

    -- Use RAISERROR inside the CATCH block to return error  
    -- information about the original error that caused  
    -- execution to jump to the CATCH block.  
    RAISERROR (@ErrorMessage, -- Message text.  
               @ErrorSeverity, -- Severity.  
               @ErrorState -- State.  
               );  
END CATCH;  
END

Create PROCEDURE [Orders].[LSDOrder]
(
	@OrderID INT,
	@RequestedBy nvarchar(50)
)

	  
AS
BEGIN
	-- SET NOCOUNT ON added to prevent extra result sets from
	-- interfering with SELECT statements.
	SET NOCOUNT ON;


			update ORDERS.ORDERS 
			set ordertype='LSandD',
			[ModifyDate]=getdate() ,
			[ModifyUser]=@RequestedBy
			where orderid =	@OrderID
			

	

END
CREATE FUNCTION [orders].[fnSplitString]
(
    @string NVARCHAR(MAX),
    @delimiter CHAR(1)
)
RETURNS @output TABLE(splitdata NVARCHAR(MAX)
)
BEGIN
    DECLARE @start INT, @end INT
    SELECT @start = 1, @end = CHARINDEX(@delimiter, @string)
    WHILE @start < LEN(@string) + 1 BEGIN
        IF @end = 0
            SET @end = LEN(@string) + 1
      
        INSERT INTO @output (splitdata)
        VALUES(SUBSTRING(@string, @start, @end - @start))
        SET @start = @end + 1
        SET @end = CHARINDEX(@delimiter, @string, @start)
       
    END
    RETURN
END

CREATE VIEW [Orders].[MemberOrdersVStoCRM] AS
select
	a.[ContactID], 
	a.[NHMemberID],
	a.ProviderLegalName,
	a.ProviderDBAName,
	a.[ProviderShipToAddress],
	a.[ProviderCity],
	a.[ProviderState],
	a.[ProviderZipCode],
	a.[ProviderPhoneNbr],
	a.[ProviderFaxNbr],
	a.[ProviderEmail], 
	a.HCPName,
	a.HCPNPINbr,
	REPLACE(REPLACE(a.ProviderId,CHAR(13),''),CHAR(10),'') as 'ProviderId', 
	REPLACE(REPLACE(a.LocationId,CHAR(13),''),CHAR(10),'') as 'LocationId',
	b.[FirstName],
	b.[LastName],
	a.Program,
	a.Company,
	b.[DateOrderReceived],
	b.[DateOrderInitiated],
	b.[DatePOSent],
	b.[PODate],
	case b.[PONbr] 
		 when '' then b.[PONbrAuto] 
			else b.[PONbr] 
	end  PONumber, 
	b.[FittingDt],
	b.[DateRecvdFittingDocs],
	b.[OrderStatus],
	b.[PurchasePrice],
	b.[Manufacturer],
	b.[ProductFamily],
	b.[ProductModel],
	b.[Style],
	b.[TechLevel],
	b.[BatterySize],
	b.[QtyOrdered],
	b.[Color],
	b.[Ear],
	b.[SpecialInstructions],
	b.[ReceiverSizeLeft],
	b.[ReceiverSizeRight],
	b.[ReceiverPowerLeft],
	b.[ReceiverPowerRight],
	b.[HALeftSerialNbr],  
	b.[HARightSerialNbr],
	b.[EarmoldLeftSerialNbr],
	b.[ManufacturerInvoiceNbr],
	b.[ManufacturerInvoiceDt],
	b.[OrderConfirmationNbr],  
	b.[CleanOrder],
	b.ReturnDt,
	b.NumberOfUnitsReturned,
	b.ReturnSide,
	b.CreditInvoiceDt,
	b.CreditInvoiceNbr,
	e.HIPAAReceived,
	e.AudiogramReceived,
	e.AOBReceived,
	b.[ProductFamily] + ' ' + b.[ProductModel] vsitemcode,
	c.CRMName as itemcode,
	e.BenefitAmount,
	e.ClaimAmount,
	e.ClaimRequired,
	b.ProcessStatus,
	b.[CustomTableDataID] as 'BOrdersCustomTableDataID',
	b.[CustomTableDataID] as 'DOrdersCustomTableDataID',
	e.[CustomTableDataID] as 'EClaimsCustomTableDataID'
from [vsdatamig].[vsCRMDataNew] a
inner join [vsdatamig].[vsCRMOrdersNew] b on b.[ContactID] = a.[ContactID]
inner join [vsdatamig].[tmpItemMap2] c on c.Sno = b.ProductID
left outer join (
	select a.*
	from [vsdatamig].[vsCRMClaimsNew] a
	left outer join [vsdatamig].[vsCRMClaimsNew] b
		on a.ID = b.ID and a.ID < b.ID
) e on a.ContactID = e.ContactID
CREATE procedure [otc].[GetProductDetails]
	@insuranceCarrierID int = 0 ,
	@healthPlanID int = 0,
	@itemCode	varchar(100) = ''
	AS
	BEGIN
	SELECT DISTINCT
			 cast(row_number() over (order by conProd.ItemCode asc) as varchar) AS ProductModelCode,
			 vm.BrandCode AS BrandCode,
			 vm.FamilyCode AS BrandFamilyCode,
			 NULL AS EarmoldTypeCode,
			 vm.TechnologyCode AS FamilyProductCode,
			 NULL AS ProductTypeCode,
			 vm.StyleCode as ShellCode,
			 vm.TechnologyCode AS TechnologyLevelCode,
			 mContent.ModelOverview AS ModelOverview,
			 mContent.ModelLongDescription AS ModelLongDescription,
			 ISNULL(conProd.[PerDeviceMemberPrice],0) AS UnitProductPrice,
			 ISNULL([PerPairMemberPrice],0) AS PairProductPrice,
			 ISNULL(contBen.BenefitAmt,0) AS Benefit,
			 mContent.ModelShortDescription AS [Description],
			 mContent.DefaultImage AS MediaURL,
			 mContent.FamilyLogoImage AS FamilyLogoImage,
			 mContent.FamilyBannerImage AS FamilyBannerImage,
			 vm.StyleCode AS StyleName,
			 0 AS StyleID,
			 vm.StyleCode AS StyleCode,
			 vm.ItemCode AS ItemCode	 
			 FROM [catalog].[ItemMasterList] vm
			
			 LEFT JOIN insurance.ContractProducts conProd ON conProd.ItemCode =  vm.ItemCode 
						

			 --LEFT JOIN insurance.ContractProducts conProd ON conProd.FamilyProductCode = CASE
				--	WHEN vm.BrandCode not in ('BELTONE', 'GNR','PHONAK')
				--		THEN TRIM(CONCAT(LEFT(vm.BrandCode, 2), ' ', vm.FamilyCode, ' ', CASE WHEN vm.TechnologyCode = 'NA' THEN '' ELSE vm.TechnologyCode END))
				--		ELSE vm.TechnologyCode
				--	END


			 LEFT JOIN CMS.ItemMasterContent mContent ON vm.ItemCode = mContent.ItemCode
			 LEFT JOIN insurance.ContractBenefits contBen ON contBen.HealthPlanContractID = conProd.HealthPlanContractID
			 LEFT JOIN insurance.HealthPlanContracts healthPC ON healthPC.HealthPlanContractID = contBen.HealthPlanContractID
			 LEFT JOIN insurance.InsuranceHealthPlans insHP ON healthPC.[InsuranceHealthPlanID] = insHP.[InsuranceHealthPlanID]
			 WHERE  vm.ItemCode =  @itemCode and vm.IsActive=1
END
CREATE procedure [otc].[GetProductCategories]
as
begin
	select distinct
	 av.[ModelAttributeValueID]
	,av.[Itemcode] as ItemCode
	,av.[IsActive]
	,av.[ModelAttributeValue] as CategoryCode
	,av.[ModelAttributeValue] as CategoryName
	from [catalog].[ItemMasterAttributeValues] av
	inner join [catalog].[ItemMasterList] it
	on it.[ItemCode] = av.[ItemCode]
	where av.[AttributeCode]='OTC_CATEGORY' and it.[ItemType]='OTC'
	and av.[IsActive]=1 and it.[IsActive]=1
end
CREATE procedure [otc].[GetProductCatalogs]
as
begin
	select
	 pc.[ProductCatalogId]
	,pc.[ItemCode]
	,c.[CatalogId] as CatalogId
	,c.[CatalogName] as  CatalogCode
	,c.[CatalogName] as CatalogName
	,pc.[IsActive]
	from [otc].[Catalogs] c
	inner join  [otc].[ProductCatalogs] pc
	on pc.[CatalogId]=c.[CatalogId]
	inner join [catalog].[ItemMasterList] it
	on it.[ItemCode] = pc.[ItemCode]
	where pc.[IsActive]=1 and c.[IsActive]=1 and it.[IsActive]=1 and it.[ItemType]='OTC'
end
create proc [otc].[GetOrdersbyNHMemberId]
	@NHMemberId varchar(20)
as
begin
	select o.* from [Orders].[Orders] o join
	[provider].[MemberChartData] mcd on  o.[MemberChartDataId] = mcd.[MemberChartDataId]
	join [provider].[MemberCharts] mc on mcd.[MemberChartId] = mc.[MemberChartId]
	where o.nhmemberid=@NHMemberId order by o.orderid desc
end
CREATE procedure [otc].[GetStoreFrontProducts]
as
begin
	select * from [otc].[ViewGetMasterList]
end       
CREATE procedure [otc].[InsertOTCProduct](
	 @userName varchar(200)
	
	,@umiNo varchar(20)
	,@upc11 varchar(100)
	,@group varchar(100)
	,@categoryID int
	,@upc12 varchar(100)=null
	,@gtin varchar(200)=null
	,@descr12 varchar(2000)
	,@descr29 varchar(4000)

	,@quantity decimal
	--,@measurement varchar(5)

	,@basePrice decimal
	,@totalPrice decimal

	--,@brand varchar(100)=null
	,@mfg varchar(100)=null
	,@isPvtLabel bit
	--,@isPLU bit
	
	,@catalogs varchar(500)
	,@img varchar(300)=null
	
	,@category varchar(100)=null
	,@sub_category varchar(100)=null
	,@sub_cat_code varchar(10)=null
	,@fin_category varchar(100)=null
	,@fin_cat_code varchar(10)=null
	,@isActive bit
)
as
begin
		declare @hpcId bigint=(select top 1 [HealthPlanContractID] from [Insurance].[HealthPlanContracts]
		where [ContractName]='Nations OTC Contract')

		--[catalog].[ItemMasterList] #Master table
		
		insert into [catalog].[ItemMasterList]
		([ItemCode],[ItemType],[BrandCode],[FamilyCode],[TechnologyCode],[ModelCode],[StyleCode],[IsActive],[CreateDate],[CreateUser],[ModifyDate],[ModifyUser],[MonauralHCPCSCode],[BinauralHCPCSCode]) values
		(@upc11,'OTC','OTC',null,null,null,null,@isActive,getdate(),@userName,getdate(),@userName,null,null);


		--[otc].[ProductCatalogs] #List of Catalogs
		--Insert into Catalogs if there is new Catalog in Excel?
		--If InActive, make active
		if(@isActive=1)
			begin
				update ct
				set ct.[IsActive]=1
				from [otc].[Catalogs] ct
				where ct.[CatalogName] in (select trim(value) from string_split(@catalogs, ';'))
			end

		insert into [otc].[Catalogs]
		select trim(value),@userName,@userName,getdate(),getdate(),@isActive from string_split(@catalogs, ';')
		where trim(value) not in (
			select CatalogName from [otc].[Catalogs]
		);

		--If InActive, make active
		if(@isActive=1)
			begin
				update pc
				set pc.[IsActive]=1
				from [otc].[ProductCatalogs] pc
				where pc.[ItemCode]=@upc11
				and pc.[CatalogId] in
				(select [CatalogId] from [otc].[Catalogs] where [CatalogName] in
				(select trim(value) as value from string_split(@catalogs, ';')))
			end
	
		update pc
		set pc.[IsActive]=0
		from [otc].[ProductCatalogs] pc
		where pc.[ItemCode]=@upc11
		and pc.[CatalogId] not in
		(select [CatalogId] from [otc].[Catalogs] where [CatalogName] in
		(select trim(value) as value from string_split(@catalogs, ';')))

		insert into [otc].[ProductCatalogs]
		([ItemCode],[CatalogId],[CreateDate],[CreateUser],[ModifyDate],[ModifyUser],[IsActive])
		select @upc11,ct.[CatalogId],getdate(),@userName,getdate(),@userName,@isActive
		from (select trim(value) as value from string_split(@catalogs, ';')) c
		inner join [otc].[Catalogs] ct on ct.[CatalogName]=c.value
		where [CatalogId] not in
		(select distinct [CatalogId] from [otc].[ProductCatalogs] where [ItemCode] = @upc11);


		--[cms].[ItemmasterContent] #Product Info
		declare @contentData varchar(4000)='{}';
		set @contentData = json_modify(@contentData, '$.upc11', @upc11);
		set @contentData = json_modify(@contentData, '$.upc12', @upc12);
		set @contentData = json_modify(@contentData, '$.gtin', @gtin);
		set @contentData = json_modify(@contentData, '$.group', @group);
		set @contentData = json_modify(@contentData, '$.categoryID', @categoryID);
		set @contentData = json_modify(@contentData, '$.mfg', @mfg);
		set @contentData = json_modify(@contentData, '$.isPvtLabel', @isPvtLabel);
		
		set @contentData = json_modify(@contentData, '$.umiNo', @umiNo);
		set @contentData = json_modify(@contentData, '$.quantity', @quantity);
		
		insert into [cms].[ItemmasterContent]
		([ItemCode],[BrandFamilyCode],[DefaultImage],[FamilyBannerImage],[FamilyLogoImage],[FamilyProductCode],[IsActive],[ModelCode],[ModelLongDescription],[ModelMobileAppsDescription],[ModelName],[ModelOverview],[ModelRatings],[ModelShortDescription],[ModelTitle],[CreateDate],[CreateUser],[ModifyDate],[ModifyUser],[ContentData]) values
		(@upc11,null,@img,null,null,null,@isActive,null,@descr29,null,null,null,0,@descr12,null,getdate(),@userName,getdate(),@userName
		,@contentData);

		--[catalog].[ItemMasterAttributeValues] #Category, Sub Category and Fin Category
		if(@category is not null)
			begin
				insert into [catalog].[ItemMasterAttributeValues]
				([AttributeCode],[Itemcode],[ModelAttributeValue],[IsActive],[VendorCode],[Modifier],[CreateDate],[CreateUser],[ModifyDate],[ModifyUser],[ModelAttributeValueDescription]) values
				('OTC_CATEGORY',@upc11,@category,@isActive,null,'NA',getdate(),@userName,getdate(),@userName,null)
			end

		if(@sub_cat_code is not null)
			begin
				insert into [catalog].[ItemMasterAttributeValues]
			([AttributeCode],[Itemcode],[ModelAttributeValue],[IsActive],[VendorCode],[Modifier],[CreateDate],[CreateUser],[ModifyDate],[ModifyUser],[ModelAttributeValueDescription]) values
			('OTC_SUB_CATEGORY',@upc11,@sub_category,@isActive,null,'NA',getdate(),@userName,getdate(),@userName,@sub_cat_code)
			end

		if(@fin_cat_code is not null)
			begin
				insert into [catalog].[ItemMasterAttributeValues]
			([AttributeCode],[Itemcode],[ModelAttributeValue],[IsActive],[VendorCode],[Modifier],[CreateDate],[CreateUser],[ModifyDate],[ModifyUser],[ModelAttributeValueDescription]) values
			('OTC_FIN_CATEGORY',@upc11,@fin_category,@isActive,null,'NA',getdate(),@userName,getdate(),@userName,@fin_cat_code)
			end

		--[Insurance].[ContractProducts] #Map product to OTC Dummy Health Plan Contract
		insert into [Insurance].[ContractProducts]
		([BrandCode],[CreateDate],[CreateUser],[FamilyProductCatCode],[FamilyProductCategoryFamilyProductID],[FamilyProductCode],[HealthPlanContractID],[HealthPlanContractID1],[IsActive],[ModifyDate],[ModifyUser],[PerDeviceCOGSPrice],[PerDeviceDispensingFee],[PerDeviceMemberPrice],[ProductAvailType],[PerPairMemberPrice],[ItemCode],[PerPairDispensingFee]) VALUES
		(null,getdate(),@userName,null,null,null,@hpcId,null,@isActive,getdate(),@userName,@basePrice,0,@totalPrice,'Available',2*@totalPrice,@upc11,0)

end
CREATE PROCEDURE [otc].[GetOrderItemsbyNHMemberId]
@NHMemberId VARCHAR(20),
@orderId BIGINT=0
AS
IF(@orderId=0)
SELECT oi.*,
imc.[DefaultImage] AS DefaultImage
,imc.[ModelShortDescription] AS Title FROM Orders.orderitems oi JOIN
[Orders].[Orders] o ON oi.OrderId = o.orderid JOIN
CMS.ItemMasterContent imc ON oi.itemcode = imc.itemcode WHERE o.nhmemberid=@NHMemberId AND oi.[IsActive]=1
ELSE
SELECT oi.*,
imc.[DefaultImage] AS DefaultImage,
imc.[ModelShortDescription] AS Title

FROM Orders.orderitems oi JOIN
[Orders].[Orders] o ON oi.OrderId = o.orderid JOIN
CMS.ItemMasterContent imc ON oi.itemcode = imc.itemcode
WHERE o.nhmemberid=@NHMemberId AND oi.orderid=@orderId AND oi.[IsActive]=1
CREATE VIEW [otc].[ViewGetMasterList]
AS
	SELECT
	row_number() OVER (ORDER BY it.[ItemCode] ASC) RowID
	,modelcontent.[ModelShortDescription] AS Title
	,modelcontent.[ModelLongDescription] AS Description
	,modelcontent.[DefaultImage] AS MediaURL
	,json_value(modelcontent.[ContentData], '$.brand') AS BrandCode
	,json_value(modelcontent.[ContentData], '$.brand') AS BrandName
	,it.[ItemCode] AS ItemCode
	,modelcontent.ModelRatings AS ModelRatings
	,CAST(0 AS numeric(10,2)) AS Quantity
	,NULL AS QuantityUnits
	,CAST(cpr.[PerDeviceMemberPrice] AS numeric(10,2)) Price
	,'$' AS Currency
	,CAST(1 AS numeric(10,2)) AS PricePerQuantity
	,CAST(1 AS DECIMAL(10,2)) AS CartQty
	FROM
	[catalog].[ItemMasterList] it
	INNER JOIN [Insurance].[ContractProducts] cpr ON cpr.[ItemCode]=it.[ItemCode]
	INNER JOIN [Insurance].[HealthPlanContracts] hpc ON hpc.[HealthPlanContractID]=cpr.[HealthPlanContractID]
	LEFT JOIN CMS.ItemMasterContent modelcontent ON it.[ItemCode] = modelcontent.[ItemCode]
	WHERE 1=1
	AND hpc.[InsuranceCarrierID]=(SELECT TOP 1 [InsuranceCarrierId] FROM [Insurance].[InsuranceCarriers] WHERE [InsuranceCarrierName]='NationsOTC Program' AND IsActive=1)
	AND hpc.[InsuranceHealthPlanID]=(SELECT TOP 1 [InsuranceHealthPlanID] FROM [Insurance].[InsuranceHealthPlans] WHERE [HealthPlanName]='OTC Benefits') AND it.[ItemType]='OTC'
	AND it.isactive=1
CREATE PROCEDURE [provider].[GetInsuranceDetails] 
(
    -- Add the parameters for the stored procedure here
 @nhmemberid varchar(50),
 @insCarrierId bigint,
 @planId bigint
)
AS
BEGIN
    -- SET NOCOUNT ON added to prevent extra result sets from
    -- interfering with SELECT statements.
    SET NOCOUNT ON

		select 
		Convert(int,ROW_NUMBER() OVER(ORDER BY Ins.InsuranceCarrierID ASC)) AS RowId
		,Ins.InsuranceCarrierID
		,C.[InsuranceCarrierName] as InsuranceCarrierName
		,HealthPlanName as PlanName
		,GroupNbr as PlanGroup
		,InsuranceNbr  as InsurancePlan
		,InsurerInsuranceNbr as MemberId
		,ClaimAddress1 as InsuranceClaimAddress1
		,ClaimAddress2 as InsuranceClaimAddress2
		,ClaimCity as  InsuranceClaimCity
		,ClaimState as InsuranceClaimState
		,ClaimZip as InsuranceClaimZip
		from [provider].[MemberInsurances] Ins
		left Join [provider].[MemberProfiles] Mp on Mp.[MemberProfileId]=Ins.[MemberProfileId] 
		left join [provider].[MemberInsuranceDetails] Mi on Mi.MemberInsuranceID=Ins. MemberInsuranceID
		left join [Insurance].[InsuranceHealthPlans] hp on hp.InsuranceCarrierID=ins.InsuranceCarrierID 
		left Join [Insurance].[InsuranceCarriers] c On c.InsuranceCarrierID=Ins.InsuranceCarrierID
		where   Mp.Nhmemberid=@nhmemberid and  Ins.InsuranceCarrierID=@insCarrierId and hp.InsuranceHealthPlanID=@planId
END
CREATE Procedure [provider].[GetMemberOrderDetails1]
 @nhMemberId [nvarchar](50)

AS
BEGIN
    SET NOCOUNT ON      
         SELECT  distinct o.[OrderID] 
			,o.[BrandCode]
            ,[MemberChartDataId]
            ,NhMemberID               
            ,o.CreateDate as OrderDate
            ,os.OrderStatusName
			,ot.OrderStatusCode  
            ,[FamilyCode]
            ,[TechnologyLevelCode]
			,ModelCode
            ,[DeviceCount]
                ,JSON_VALUE(OrderAmountData,'$."productPrice"') as ProductPrice
                ,JSON_VALUE(OrderAmountData,'$."insuranceBenefit"') as BenefitPrice     
                ,JSON_VALUE(OrderAmountData,'$."benefitAvailable"') as AvailableBenefitPrice
                ,Convert(varchar(20),isnull(cast(JSON_VALUE(ISNULL(LTRIM(RTRIM(OrderAmountData)), 0),'$."adjustments"') as int),0)) as AdjustedPrice
                ,Convert(varchar(20),[OrderAmount]) as MemberPrice       
               -- ,sum(cast(JSON_VALUE(ISNULL(ot.OrderTransactionData,0),'$.totalAmount')as int)) as AmountPaid--- $500
			   ,Convert(varchar(20),(select isnull(sum(cast(JSON_VALUE(ISNULL(OrderTransactionData,0),'$.totalAmount')as int)),0) from Orders.OrderTransactionDetails where OrderId = o.OrderId Group by OrderId)) as AmountPaid
                ,Convert(varchar(20),([OrderAmount]-(select isnull(sum(cast(JSON_VALUE(ISNULL(OrderTransactionData,0),'$.totalAmount')as int)),0) from Orders.OrderTransactionDetails where OrderId = o.OrderId Group by OrderId))) as BalanceDue --$0
                ,isnull(JSON_VALUE(o.OrderAmountData,'$.benefitUsed'),0) as BenefitUsed
                ,JSON_VALUE(ProviderData,'$."providerLeagalBusinessName"') as ProviderName 
				 ,cast(JSON_VALUE(ProviderData,'$."providerId"') as bigint) as ProviderId
				 ,cast(JSON_VALUE(ProviderData,'$.address."locationId"') as bigint) as locationId 
				 ,cast(JSON_VALUE(o.MemberData,'$."insCarrierId"') as bigint) as InsuranceCarrierId 
				 ,cast(JSON_VALUE(o.MemberData,'$."insPlanId"') as bigint) as HealthPlanId
                    from [Orders].[Orders] o
                    join Orders.OrderStatusTypes os on o.OrderStatusCode = os.OrderStatusCode  
                    join Orders.OrderTransactionDetails ot on ot.OrderID=o.OrderID and ot.OrderStatusCode=o.OrderStatusCode
                    where (ISJSON(o.MemberData) > 0) and (ISJSON(o.OrderAmountData) > 0) and (ISJSON(o.ProviderData) > 0) and (ISJSON(ot.OrderTransactionData) > 0)
					 				and 
					NhMemberID = 'NH201700007735'
               group by  o.[OrderID],o.[BrandCode],[MemberChartDataId],NhMemberID,o.CreateDate,os.OrderStatusName,ot.OrderStatusCode,[FamilyCode],[TechnologyLevelCode],ModelCode,
					[DeviceCount],OrderAmountData,[OrderAmount],ProviderData,o.MemberData,ot.OrderTransactionData
                order by o.CreateDate desc

END

 
CREATE PROCEDURE [provider].[GetProviderStatisticsData]
(
  
   @ProviderId bigInt
  ,@LocationId bigInt

)
AS
BEGIN
DECLARE @providerCode VARCHAR(50);
SET @providerCode = (SELECT PROVIDERCODE FROM [provider].[ProviderProfiles] WHERE PROVIDERID = @ProviderId)
print @providerCode
IF(@providerCode='180000')
BEGIN
    -- SET NOCOUNT ON added to prevent extra result sets from
    -- interfering with SELECT statements.
    SET NOCOUNT ON
SELECT CAST(ROW_NUMBER() OVER(ORDER BY Y.TotalUnitsSold ASC)AS INT) AS RowId,x.*, y.* 
FROM (select  COUNT(*) AS FutureAppointments
	,ISNULL((CAST(SUM(CASE WHEN APT.AppointmentTypeName='Testing' THEN 1 ELSE 0 END)AS INT)),0) AS FutureTestAppointments  
	,ISNULL((select count(*)
	from [provider].[MemberAppointments] app
	JOIN [provider].[MemberChartData] Mc on Mc.MemberChartDataId=app.MemberChartDataId
	JOIN [provider].[AppointmentTypes] APT  on APT.[AppointmentTypeId]=app.[AppointmentTypeId]
	where app.isactive=1 and Mc.isactive=1 and [EndTime] < getdate() and (MONTH(startTime) = MONTH(getdate()) and year(startTime) = year(getdate()))),0) AS MembersTestedByMonth
	from [provider].[MemberAppointments] app
	JOIN [provider].[MemberChartData] Mc on Mc.MemberChartDataId=app.MemberChartDataId
	JOIN [provider].[AppointmentTypes] APT  on APT.[AppointmentTypeId]=app.[AppointmentTypeId]where app.isactive=1 and Mc.isactive=1
	  and Mc.LocationId =@locationId
	and startTime >= getdate()) as x, 
(	SELECT TOP 1 COUNT(*) AS TotalUnitsSold
			,ISNULL((SUM(CASE WHEN technologyLevel='Entry' THEN 1 ELSE 0 END)), 0) AS  'Entry' 
			,ISNULL((SUM(CASE WHEN technologyLevel='Basic' THEN 1 ELSE 0 END)), 0) AS  'Basic'
			,ISNULL((SUM(CASE WHEN technologyLevel='Prime' THEN 1 ELSE 0 END)), 0) AS  'Prime'
			,ISNULL((SUM(CASE WHEN technologyLevel='Advanced' THEN 1 ELSE 0 END)), 0) AS  'Advanced'
			,ISNULL((SUM(CASE WHEN technologyLevel='Premium' THEN 1 ELSE 0 END)), 0) AS  'Premium'
			,ISNULL((SUM(CASE WHEN technologyLevel='Superior' THEN 1 ELSE 0 END)), 0) AS  'Superior'
			FROM(
			select  ot.OrderItemId
			,(Select top 1 FamilyProductCatCode from [Insurance].[ContractProducts] 
					where familyproductcode = ot.TechnologyLevelCode and brandcode = ot.brandcode) technologyLevel
			from [Orders].[OrderItems] ot 
			where ot.isactive=1 and ot.status='Active'
			and itemType in ('HA','CROS'))S) as y
END
ELSE 
BEGIN

SELECT CAST(ROW_NUMBER() OVER(ORDER BY Y.TotalUnitsSold ASC)AS INT) AS RowId,x.*, y.* 
FROM (select  COUNT(*) AS FutureAppointments
	,ISNULL((CAST(SUM(CASE WHEN APT.AppointmentTypeName='Testing' THEN 1 ELSE 0 END)AS INT)), 0) AS FutureTestAppointments  
	,ISNULL((CAST(SUM(CASE WHEN ([EndTime] < getdate() and MONTH(startTime) = MONTH(getdate()) and year(startTime) = year(getdate())) THEN 1 ELSE 0 END)AS INT)), 0) AS MembersTestedByMonth
	
	from [provider].[MemberAppointments] app
	JOIN [provider].[MemberChartData] Mc on Mc.MemberChartDataId=app.MemberChartDataId
	JOIN [provider].[AppointmentTypes] APT  on APT.[AppointmentTypeId]=app.[AppointmentTypeId]where app.isactive=1 and Mc.isactive=1
	and Mc.ProviderId=@ProviderId and Mc.LocationId =@locationId
	and startTime >= getdate()) as x, 
(SELECT TOP 1 COUNT(*) AS TotalUnitsSold
			,ISNULL((SUM(CASE WHEN technologyLevel='Entry' THEN 1 ELSE 0 END)), 0) AS  'Entry' 
			,ISNULL((SUM(CASE WHEN technologyLevel='Basic' THEN 1 ELSE 0 END)), 0) AS  'Basic'
			,ISNULL((SUM(CASE WHEN technologyLevel='Prime' THEN 1 ELSE 0 END)), 0) AS  'Prime'
			,ISNULL((SUM(CASE WHEN technologyLevel='Advanced' THEN 1 ELSE 0 END)), 0) AS  'Advanced'
			,ISNULL((SUM(CASE WHEN technologyLevel='Premium' THEN 1 ELSE 0 END)), 0) AS  'Premium'
			,ISNULL((SUM(CASE WHEN technologyLevel='Superior' THEN 1 ELSE 0 END)), 0) AS  'Superior'
			FROM(
			select  ot.OrderItemId,JSON_VALUE(ProviderData, '$.providerId') providerId,JSON_VALUE(ProviderData, '$.address.locationId') locationId
			,(Select top 1 FamilyProductCatCode from [Insurance].[ContractProducts] where familyproductcode = ot.TechnologyLevelCode and brandcode = ot.brandcode) technologyLevel
			from orders.orders o
			inner join [Orders].[OrderItems] ot on ot.orderid=o.orderid
			where o.isactive=1 and ot.isactive=1 and ot.status='Active'
			and JSON_VALUE(ProviderData, '$.providerId') = @ProviderId
			--and JSON_VALUE(ProviderData, '$.address.locationId') = @locationId
			and itemType in ('HA','CROS'))S) as y
END
END
CREATE PROCEDURE [provider].[GetPreServiceAuthRequestHistoryUpdtes] --'NH201901912884' 
(  
    -- Add the parameters for the stored procedure here  
   @nhMemberId Varchar(50)  
)  
AS  
BEGIN  
    -- SET NOCOUNT ON added to prevent extra result sets from  
    -- interfering with SELECT statements.  
    SET NOCOUNT ON  
  
    -- Insert statements for procedure here  
      select   
    cast((select count(*) from [provider].[PreServiceAuthRequests] where NhMemberid=@nhMemberId)+ROW_NUMBER() OVER(ORDER BY ModifyUser) as int)  AS RowID   
	,cast(CaseNumber as bigint) as CaseNumber
  ,JSON_VALUE(PreServiceAuthRequestDetails, '$.requestSource') 'RequestSource'  
  ,JSON_VALUE(PreServiceAuthRequestDetails, '$.requestedBy') 'RequestedBy'  
  ,cast(JSON_VALUE(PreServiceAuthRequestDetails, '$.requestReceivedDate') as DateTime) 'RequestDate'  
  ,JSON_VALUE(PreServiceAuthRequestDetails, '$.caseDisposition') 'CaseDisposition'  
  ,cast(JSON_VALUE(PreServiceAuthRequestDetails, '$.finalDecisionDateTime') as DateTime)'CaseDispositionDateTime'  
  ,cast(JSON_VALUE(PreServiceAuthRequestTimeliness, '$.hearingTestDate') as DateTime)  as 'HearingTestDate'  
  ,ModifyUser as 'LastUpdatedBy'  
  ,ModifyDate as 'LastUpdatedOn',IsApproved 
 from [provider].[PreServiceAuthRequestHistory] where NhMemberid= @nhMemberId and isactive=1
 order by  [PreServiceAuthQueueHistoryId] desc
END 

CREATE PROCEDURE [provider].[GetPreServiceAuthorizationQueue]
AS
BEGIN
    -- SET NOCOUNT ON added to prevent extra result sets from
    -- interfering with SELECT statements.
    SET NOCOUNT ON
	select convert(int,CaseNumber) as CaseNumber
	,(FirstName+ ''+LastName) as MemberName
	,PR.NHMemberId
	--,convert(Date,getdate(),120)
	--,dateadd(dd,14,isnull(Convert(Date ,JSON_VALUE(PreServiceAuthRequestDetails, '$.requestReceivedDate'),120),Convert(Date ,PR.CreateDate,120)))
	,case when JSON_VALUE(PreServiceAuthRequestDetails, '$.requestReceivedDate')  IS NULL then convert(Date ,PR.CreateDate,120) else convert(date ,JSON_VALUE(PreServiceAuthRequestDetails, '$.requestReceivedDate')) end as RequestDate
	,JSON_VALUE(PreServiceAuthRequestDetails, '$.requestedByFirstName') + ' ' +JSON_VALUE(PreServiceAuthRequestDetails, '$.requestedByLastName') as RequestedBy
	,JSON_VALUE(PreServiceAuthRequestDetails, '$.priority') as Priority,
	Json_value(PreServiceAuthRequestDetails,'$.caseDisposition') as CaseDisposition
	from [provider].[PreServiceAuthRequests] PR 
	left join [provider].[MemberProfiles] MP on MP.NHMemberId=PR.NHMemberId  
	where PR.Isactive=1  and PR.IsApproved=0 and PR.IsVerified=0 
	and convert(Date,getdate(),120)<dateadd(dd,14,isnull(Convert(Date ,JSON_VALUE(PreServiceAuthRequestDetails, '$.requestReceivedDate'),120),Convert(Date ,PR.CreateDate,120)))
	 
	order by casenumber asc
END

CREATE procedure [provider].[GetProviderUserPermissions](
	@providerId [bigint] = 0,
	@userProfileId [bigint] = 0
)
as
begin
	select
		af.[AppFeatureId]
		,af.IsSystemFeature
		,af.IsDefault
      ,af.[ParentFeatureId]
      ,af.[FeatureName]
      ,af.[FeatureCode]
      ,(case
			when pf.[ProviderFeatureId] > 0 then null
			when af.IsSystemFeature = 1 then null else cast((case when (puf.[IsCreate] is null or puf.[IsCreate] = 1) then af.[IsCreate] else 0 end) as bit)
		end) as 'IsCreate'
		,(case when af.IsSystemFeature = 1 then null else af.[IsCreate] end) as 'IsCreateDefault'
      ,(case
			when pf.[ProviderFeatureId] > 0 then null
			when af.IsSystemFeature = 1 then null else cast((case when (puf.[IsRead] is null or puf.[IsRead] = 1) then af.[IsRead] else 0 end) as bit)
		end) as 'IsRead'
		,(case when af.IsSystemFeature = 1 then null else af.[IsRead] end) as 'IsReadDefault'
      ,(case
			when pf.[ProviderFeatureId] > 0 then null
			when af.IsSystemFeature = 1 then null else cast((case when (puf.[IsUpdate] is null or puf.[IsUpdate] = 1) then af.[IsUpdate] else 0 end) as bit)
		end) as 'IsUpdate'
		,(case when af.IsSystemFeature = 1 then null else af.[IsUpdate] end) as 'IsUpdateDefault'
      ,(case
			when pf.[ProviderFeatureId] > 0 then null
			when af.IsSystemFeature = 1 then null else cast((case when (puf.[IsDelete] is null or puf.[IsDelete] = 1) then af.[IsDelete] else 0 end) as bit)
		end) as 'IsCancel'
		,(case when af.IsSystemFeature = 1 then null else af.[IsDelete] end) as 'IsCancelDefault'
	from [auth].[ApplicationFeatures] af
	left join [auth].[ProviderFeatures] pf
	on af.[FeatureCode] = pf.[AppFeatureCode] and pf.[ProviderId] = @providerId and (pf.[IsActive] = 1 or pf.[IsActive] is null)
	left join [auth].[ProviderUserFeatures] puf
	on af.[FeatureCode]=puf.[AppFeatureCode] and puf.[ProviderId] = @providerId and puf.[UserProfileId] = @userProfileId and (puf.[IsActive] = 1 or puf.[IsActive] is null)
	where --af.[IsDefault]=1 and 
	af.[IsActive] = 1 and (pf.[IsActive] = 1 or pf.[IsActive] is null) and (puf.[IsActive] = 1 or puf.[IsActive] is null) and af.[isDefault] = 1
end
CREATE Procedure [provider].[GetOrderManagementDetails]
@nhMemberId [nvarchar](50),
@providerCode [varchar](10),
@engagementId [bigint]
AS
BEGIN
SET NOCOUNT ON 

IF (@providerCode = '180000')
BEGIN
	IF(@engagementId = 0 )
		BEGIN   
				SELECT  distinct Me.MemberChartId as EngagementId
				,cast(o.DateOrderReceived as date) as OrderDate
				,o.[OrderID] as OrderId
				,NhMemberID 
				,[OrderType] 
				,Convert(varchar(50),(select STRING_AGG(PONUMBER, ', ') 
				   from [Orders].[OrderPOs] where OrderId = o.OrderId Group by OrderId)) as PoNumber
				,(case t.ordertransactiondata when null then null else (select string_agg(convert(varchar, PODate, 110), ',') from (select PODate from openjson(t.ordertransactiondata) with (PODate date '$.poDate')) c) end) as PODATE
				,Convert(varchar(50),(SELECT CASE WHEN OrderStatusCode = 'INI'  THEN 'Initiated' WHEN  OrderStatusCode = 'REV'  THEN 'Reviewed' WHEN OrderStatusCode = 'APP'  THEN 'Approved' 
				 WHEN OrderStatusCode = 'PO' THEN 'PO' WHEN OrderStatusCode = 'ACK' THEN 'Acknowledge' WHEN OrderStatusCode = 'CAN' THEN 'Cancelled' 
				 WHEN OrderStatusCode = 'RET' THEN 'Returned' WHEN OrderStatusCode = 'REI' THEN 'Re-Initiated' WHEN OrderStatusCode = 'SHI' THEN 'Shipped' WHEN OrderStatusCode = 'DEL' THEN 'Delivered'
				 WHEN OrderStatusCode = 'PAY' THEN 'Payment' WHEN OrderStatusCode = 'CLM' THEN 'Claim Submitted' WHEN OrderStatusCode = 'DOC' THEN 'Documents Verified' WHEN OrderStatusCode = 'APQ' THEN 'Pending Approval' END FROM Orders.OrderStatusTypes WHERE OrderStatusCode = o.OrderStatusCode)) as OrderStatus
				,(select top 1 B.BrandName from orders.orderITems OT inner join [catalog].[Brands] B on B.BrandCode=OT.BrandCode where orderid = o.orderid  and B.Isactive =1) as BrandCode
				,(select top 1 ProductModelCode from orders.orderITems where orderid = o.orderid and itemtype = 'HA') as ModelCode
				,(select top 1 JSON_VALUE(OrderTransactionData,'$.approvedBy')
			  from Orders.OrderTransactionDetails where OrderId = o.OrderId and orderstatuscode='APP'  and isactive=1) as ApprovedBy
	  			,convert(Datetime,(select top 1 JSON_VALUE(OrderTransactionData,'$.approvedDate')
			  from Orders.OrderTransactionDetails where OrderId = o.OrderId and orderstatuscode='APP' and isactive=1)) as ApprovedDate
				,cast((select count(*) from orders.orderITems where orderid = o.orderid and itemtype = 'HA' and isactive=1 and status='active')as int) [HAItemsCount]
				,cast((select count(*) from orders.orderITems where orderid = o.orderid and itemtype = 'EM' and isactive=1 and status='active')as int) [EMItemsCount]
				,convert(decimal(10,2),Isnull(JSON_VALUE(OrderAmountData,'$.productPrice'),0)) as OrderPrice      
				,cast(JSON_VALUE(o.OrderAmountData,'$.memberResponsibility') as decimal(10,2))
				--isnull((case JSON_VALUE(o.OrderAmountData,'$.memberResponsibility') when null then Convert(decimal(10,2),cast(JSON_VALUE(o.OrderAmountData,'$.memberResponsibility') as decimal(10,2))) 
				--when (charindex(JSON_VALUE(o.OrderAmountData,'$.adjustments'), '-')) > 0 then (Convert(decimal(10,2),cast(JSON_VALUE(o.OrderAmountData,'$.memberResponsibility') as decimal) + cast(JSON_VALUE(o.OrderAmountData,'$.adjustments') as decimal)))
				--else Convert(decimal(10,2),cast(JSON_VALUE(o.OrderAmountData,'$.memberResponsibility') as decimal(10,2)) + cast(JSON_VALUE(o.OrderAmountData,'$.adjustments') as decimal(10,2)))
				--end), 0)
				as MemberResponsibility         
				,Convert(decimal(10,2), isnull((select top 1 JSON_VALUE(OrderTransactionData,'$.totalAmount')
			  from Orders.OrderTransactionDetails where OrderId = o.OrderId and orderstatuscode='PAY' and isactive=1), 0)) as AmountPaid
				,convert(decimal(10,2),isnull(JSON_VALUE(OrderAmountData, '$.memberResponsibility'),0))-
			   convert(decimal(10,2),isnull(JSON_VALUE(OrderAmountData, '$.appliedCredit.value'),0))-
			   Convert(decimal(10,2), isnull((select top 1 JSON_VALUE(OrderTransactionData,'$.totalAmount')
			  from Orders.OrderTransactionDetails where OrderId = o.OrderId and orderstatuscode='PAY' and isactive=1), 0)) + 
			 convert(decimal(10,2),isnull(JSON_VALUE(OrderAmountData, '$.refundDetails.refundedAmount') ,0)) 
			 + convert(decimal(10,2),isnull(cast(JSON_VALUE(OrderAmountData, '$.forwardCredits.creditForwarded') as decimal(10,2)),0) ) as Balance 
				,cast(Isnull(JSON_VALUE(ProviderData,'$."providerId"'),0) as bigint) as ProviderId
				,cast(Isnull(JSON_VALUE(ProviderData,'$.address."locationId"'),0) as bigint) as locationId
				,cast(Isnull(JSON_VALUE(o.MemberData,'$."insCarrierId"'),0) as bigint) as InsuranceCarrierId
				,cast(Isnull(JSON_VALUE(o.MemberData,'$."insPlanId"'),0) as bigint) as HealthPlanId
				 ,cast(Isnull(JSON_VALUE(ProviderData,'$.address."locationId"'),0) as bigint) as ProviderLocationId
				,o.[MemberChartDataId]
				,cast((case when exists (select * from [Insurance].[InsuranceCarriers] c where (c.[IsContracted]=1 or c.[IsDiscountProgram]=1) and c.[InsuranceCarrierID]=cast(Isnull(JSON_VALUE(o.MemberData,'$."insCarrierId"'),0) as bigint)) then 0 else 1 end) as bit) as UsingNHDiscount
				from [provider].[MemberCharts] Me
				inner Join [provider].[MemberChartData] Mc On Mc.MemberChartId =Me.MemberChartId
				inner join [provider].[ProviderProfiles] pp on pp.[ProviderId]=Mc.[ProviderId] --and (@providerCode = '180000' or pp.[ProviderCode]=@providerCode)
				inner join  [Orders].[Orders] o on o.[MemberChartDataId] =Mc.MemberChartDataId
				left join [Orders].[Ordertransactiondetails] t on t.orderid = o.orderid and t.orderstatuscode='PO' and t.isactive=1 and t.iscomplete=1
				--left join(select orderid,iscomplete from [Orders].[OrderTransactionDetails] where IsActive=1  and OrderStatusCode='APQ' )u ON o.orderid =u.orderid
				where (ISJSON(o.MemberData) > 0) and (ISJSON(o.OrderAmountData) > 0) and (ISJSON(o.ProviderData) > 0) 
				and O.OrderType IN ('NEW','LSND','LSandD', 'EXCHANGE') and NhMemberID = @nhMemberId
				group by  o.[OrderID],Me.MemberChartId,NhMemberID,o.DateOrderReceived,o.OrderStatusCode,
				[OrderType],OrderAmountData,ProviderData,o.MemberData,o.[MemberChartDataId],t.ordertransactiondata
				order by o.[OrderID] desc  

		END
		ELSE 
		BEGIN

				SELECT  distinct Me.MemberChartId as EngagementId
				,cast(o.DateOrderReceived as date) as OrderDate 
				,o.[OrderID] as OrderId
				,NhMemberID          
				,[OrderType] 
				,Convert(varchar(50),(select STRING_AGG(PONUMBER, ', ') 
				   from [Orders].[OrderPOs] where OrderId = o.OrderId Group by OrderId)) as PoNumber
		  ,(case t.ordertransactiondata when null then null else (select string_agg(convert(varchar, PODate, 110), ',') from (select PODate from openjson(t.ordertransactiondata) with (PODate date '$.poDate')) c) end) as PODATE
				,Convert(varchar(50),(SELECT CASE WHEN OrderStatusCode = 'INI'  THEN 'Initiated' WHEN  OrderStatusCode = 'REV'  THEN 'Reviewed' WHEN OrderStatusCode = 'APP'  THEN 'Approved' 
				 WHEN OrderStatusCode = 'PO' THEN 'PO' WHEN OrderStatusCode = 'ACK' THEN 'Acknowledge' WHEN OrderStatusCode = 'CAN' THEN 'Cancelled' 
				 WHEN OrderStatusCode = 'RET' THEN 'Returned' WHEN OrderStatusCode = 'REI' THEN 'Re-Initiated' WHEN OrderStatusCode = 'SHI' THEN 'Shipped' WHEN OrderStatusCode = 'DEL' THEN 'Delivered'
				 WHEN OrderStatusCode = 'PAY' THEN 'Payment' WHEN OrderStatusCode = 'CLM' THEN 'Claim Submitted' WHEN OrderStatusCode = 'DOC' THEN 'Documents Verified' WHEN OrderStatusCode = 'APQ' THEN 'Pending Approval' END FROM Orders.OrderStatusTypes WHERE OrderStatusCode = o.OrderStatusCode)) as OrderStatus
				,(select top 1 B.BrandName from orders.orderITems OT inner join [catalog].[Brands] B on B.BrandCode=OT.BrandCode where orderid = o.orderid  and B.Isactive =1) as BrandCode
				,(select top 1 ProductModelCode from orders.orderITems where orderid = o.orderid and itemtype='HA' ) as ModelCode
				,(select top 1 JSON_VALUE(OrderTransactionData,'$.approvedBy')
			  from Orders.OrderTransactionDetails where OrderId = o.OrderId and orderstatuscode='APP'  and isactive=1) as ApprovedBy
	  			,convert(Datetime,(select top 1 JSON_VALUE(OrderTransactionData,'$.approvedDate')
			  from Orders.OrderTransactionDetails where OrderId = o.OrderId and orderstatuscode='APP' and isactive=1)) as ApprovedDate
				,cast((select count(*) from orders.orderITems where orderid = o.orderid and itemtype = 'HA' and isactive=1 and status='active')as int) [HAItemsCount]
				,cast((select count(*) from orders.orderITems where orderid = o.orderid and itemtype = 'EM' and isactive=1 and status='active')as int) [EMItemsCount]
				,convert(decimal(10,2),Isnull(JSON_VALUE(OrderAmountData,'$.productPrice'),0)) as OrderPrice   
				--,Convert(decimal(10,2),cast(JSON_VALUE(o.OrderAmountData,'$.memberResponsibility') as decimal)) as MemberResponsibility   
				,cast(JSON_VALUE(o.OrderAmountData,'$.memberResponsibility') as decimal(10,2))
				--isnull((case JSON_VALUE(o.OrderAmountData,'$.memberResponsibility') when null then Convert(decimal(10,2),cast(JSON_VALUE(o.OrderAmountData,'$.memberResponsibility') as decimal(10,2))) 
				--when (charindex(JSON_VALUE(o.OrderAmountData,'$.adjustments'), '-')) > 0 then (Convert(decimal(10,2),cast(JSON_VALUE(o.OrderAmountData,'$.memberResponsibility') as decimal) + cast(JSON_VALUE(o.OrderAmountData,'$.adjustments') as decimal)))
				--else Convert(decimal(10,2),cast(JSON_VALUE(o.OrderAmountData,'$.memberResponsibility') as decimal(10,2)) + cast(JSON_VALUE(o.OrderAmountData,'$.adjustments') as decimal(10,2)))
				--end), 0)
				as MemberResponsibility        
				,Convert(decimal(10,2), isnull((select top 1 JSON_VALUE(OrderTransactionData,'$.totalAmount')
			  from Orders.OrderTransactionDetails where OrderId = o.OrderId and orderstatuscode='PAY' and isactive=1), 0)) as AmountPaid
				,convert(decimal(10,2),isnull(JSON_VALUE(OrderAmountData, '$.memberResponsibility'),0))-
			   convert(decimal(10,2),isnull(JSON_VALUE(OrderAmountData, '$.appliedCredit.value'),0))-
			   Convert(decimal(10,2), isnull((select top 1 JSON_VALUE(OrderTransactionData,'$.totalAmount')
			   from Orders.OrderTransactionDetails where OrderId = o.OrderId and orderstatuscode='PAY' and isactive=1), 0)) + 
			  convert(decimal(10,2),isnull(JSON_VALUE(OrderAmountData, '$.refundDetails.refundedAmount') ,0)) 
			  + convert(decimal(10,2),isnull(cast(JSON_VALUE(OrderAmountData, '$.forwardCredits.creditForwarded') as decimal(10,2)),0)) as Balance 
			,cast(Isnull(JSON_VALUE(ProviderData,'$."providerId"'),0) as bigint) as ProviderId
				,cast(Isnull(JSON_VALUE(ProviderData,'$.address."locationId"'),0) as bigint) as locationId
				,cast(Isnull(JSON_VALUE(o.MemberData,'$."insCarrierId"'),0) as bigint) as InsuranceCarrierId
				,cast(Isnull(JSON_VALUE(o.MemberData,'$."insPlanId"'),0) as bigint) as HealthPlanId
				 ,cast(Isnull(JSON_VALUE(ProviderData,'$.address."locationId"'),0) as bigint) as ProviderLocationId
				,o.[MemberChartDataId]
				,cast((case when exists (select * from [Insurance].[InsuranceCarriers] c where (c.[IsContracted]=1 or c.[IsDiscountProgram]=1) and c.[InsuranceCarrierID]=cast(Isnull(JSON_VALUE(o.MemberData,'$."insCarrierId"'),0) as bigint)) then 0 else 1 end) as bit) as UsingNHDiscount
				from [provider].[MemberCharts] Me
				inner Join [provider].[MemberChartData] Mc On Mc.MemberChartId =Me.MemberChartId
				inner join [provider].[ProviderProfiles] pp on pp.[ProviderId]=Mc.[ProviderId] --and (@providerCode = '180000' or pp.[ProviderCode]=@providerCode)
				inner join  [Orders].[Orders] o on o.[MemberChartDataId] =Mc.MemberChartDataId		
				left join [Orders].[Ordertransactiondetails] t on t.orderid = o.orderid and t.orderstatuscode='PO' and t.isactive=1 and t.iscomplete=1
				where (ISJSON(o.MemberData) > 0) and (ISJSON(o.OrderAmountData) > 0) and (ISJSON(o.ProviderData) > 0)  and Me.MemberChartId =@engagementId
				and O.OrderType In ('NEW','LSND','LSandD', 'EXCHANGE') and NhMemberID = @nhMemberId
				group by  o.[OrderID],Me.MemberChartId,NhMemberID,o.DateOrderReceived,o.OrderStatusCode,
				[OrderType],OrderAmountData,ProviderData,o.MemberData,o.[MemberChartDataId],t.ordertransactiondata
				order by o.[OrderID] desc  

			END	
END
ELSE
BEGIN
IF(@engagementId = 0 )
		BEGIN   
				SELECT  distinct Me.MemberChartId as EngagementId
				,cast(o.DateOrderReceived as date) as OrderDate
				,o.[OrderID] as OrderId
				,NhMemberID 
				,[OrderType] 
				,Convert(varchar(50),(select STRING_AGG(PONUMBER, ', ') 
				   from [Orders].[OrderPOs] where OrderId = o.OrderId Group by OrderId)) as PoNumber
				,(case t.ordertransactiondata when null then null else (select string_agg(convert(varchar, PODate, 110), ',') from (select PODate from openjson(t.ordertransactiondata) with (PODate date '$.poDate')) c) end) as PODATE
				,Convert(varchar(50),(SELECT CASE WHEN OrderStatusCode = 'INI'  THEN 'Initiated' WHEN  OrderStatusCode = 'REV'  THEN 'Order Submitted' WHEN OrderStatusCode = 'APP'  THEN 'Order Submitted' 
				 WHEN OrderStatusCode = 'PO' THEN 'Order Submitted' WHEN OrderStatusCode = 'ACK' THEN 'Order Submitted' WHEN OrderStatusCode = 'CAN' THEN 'Cancelled' 
				 WHEN OrderStatusCode = 'RET' THEN 'Returned' WHEN OrderStatusCode = 'REI' THEN 'Re-Initiated' WHEN OrderStatusCode = 'SHI' THEN 'Shipped' WHEN OrderStatusCode = 'DEL' THEN 'Delivered'
				 WHEN OrderStatusCode = 'PAY' THEN 'Payment' WHEN OrderStatusCode = 'CLM' THEN 'Delivered' WHEN OrderStatusCode = 'DOC' THEN 'Docs Submitted' WHEN OrderStatusCode = 'APQ' THEN 'Order Submitted' END FROM Orders.OrderStatusTypes WHERE OrderStatusCode = o.OrderStatusCode)) as OrderStatus
				,(select top 1 B.BrandName from orders.orderITems OT inner join [catalog].[Brands] B on B.BrandCode=OT.BrandCode where orderid = o.orderid  and B.Isactive =1) as BrandCode
				,(select top 1 ProductModelCode from orders.orderITems where orderid = o.orderid and itemtype = 'HA') as ModelCode
				,(select top 1 JSON_VALUE(OrderTransactionData,'$.approvedBy')
			  from Orders.OrderTransactionDetails where OrderId = o.OrderId and orderstatuscode='APP'  and isactive=1) as ApprovedBy
	  			,convert(Datetime,(select top 1 JSON_VALUE(OrderTransactionData,'$.approvedDate')
			  from Orders.OrderTransactionDetails where OrderId = o.OrderId and orderstatuscode='APP' and isactive=1)) as ApprovedDate
				,cast((select count(*) from orders.orderITems where orderid = o.orderid and itemtype = 'HA' and isactive=1 and status='active')as int) [HAItemsCount]
				,cast((select count(*) from orders.orderITems where orderid = o.orderid and itemtype = 'EM' and isactive=1 and status='active')as int) [EMItemsCount]
				,convert(decimal(10,2),Isnull(JSON_VALUE(OrderAmountData,'$.productPrice'),0)) as OrderPrice      
				--,Convert(decimal(10,2),cast(JSON_VALUE(o.OrderAmountData,'$.memberResponsibility') as decimal)) as MemberResponsibility     
				,cast(JSON_VALUE(o.OrderAmountData,'$.memberResponsibility') as decimal(10,2))
				--isnull((case JSON_VALUE(o.OrderAmountData,'$.memberResponsibility') when null then Convert(decimal(10,2),cast(JSON_VALUE(o.OrderAmountData,'$.memberResponsibility') as decimal(10,2))) 
				--when (charindex(JSON_VALUE(o.OrderAmountData,'$.adjustments'), '-')) > 0 then (Convert(decimal(10,2),cast(JSON_VALUE(o.OrderAmountData,'$.memberResponsibility') as decimal) + cast(JSON_VALUE(o.OrderAmountData,'$.adjustments') as decimal)))
				--else Convert(decimal(10,2),cast(JSON_VALUE(o.OrderAmountData,'$.memberResponsibility') as decimal(10,2)) + cast(JSON_VALUE(o.OrderAmountData,'$.adjustments') as decimal(10,2)))
				--end), 0)
				as MemberResponsibility
				,Convert(decimal(10,2), isnull((select top 1 JSON_VALUE(OrderTransactionData,'$.totalAmount')
			  from Orders.OrderTransactionDetails where OrderId = o.OrderId and orderstatuscode='PAY' and isactive=1), 0)) as AmountPaid
				,convert(decimal(10,2),isnull(JSON_VALUE(OrderAmountData, '$.memberResponsibility'),0))-
			   convert(decimal(10,2),isnull(JSON_VALUE(OrderAmountData, '$.appliedCredit.value'),0))-
			   Convert(decimal(10,2), isnull((select top 1 JSON_VALUE(OrderTransactionData,'$.totalAmount')
			  from Orders.OrderTransactionDetails where OrderId = o.OrderId and orderstatuscode='PAY' and isactive=1), 0)) + 
			 convert(decimal(10,2),isnull(JSON_VALUE(OrderAmountData, '$.refundDetails.refundedAmount') ,0)) 
			 + convert(decimal(10,2),isnull(cast(JSON_VALUE(OrderAmountData, '$.forwardCredits.creditForwarded') as decimal(10,2)),0)) as Balance 
				,cast(Isnull(JSON_VALUE(ProviderData,'$."providerId"'),0) as bigint) as ProviderId
				,cast(Isnull(JSON_VALUE(ProviderData,'$.address."locationId"'),0) as bigint) as locationId
				,cast(Isnull(JSON_VALUE(o.MemberData,'$."insCarrierId"'),0) as bigint) as InsuranceCarrierId
				,cast(Isnull(JSON_VALUE(o.MemberData,'$."insPlanId"'),0) as bigint) as HealthPlanId
				 ,cast(Isnull(JSON_VALUE(ProviderData,'$.address."locationId"'),0) as bigint) as ProviderLocationId
				,o.[MemberChartDataId]
				,cast((case when exists (select * from [Insurance].[InsuranceCarriers] c where (c.[IsContracted]=1 or c.[IsDiscountProgram]=1) and c.[InsuranceCarrierID]=cast(Isnull(JSON_VALUE(o.MemberData,'$."insCarrierId"'),0) as bigint)) then 0 else 1 end) as bit) as UsingNHDiscount
				from [provider].[MemberCharts] Me
				inner Join [provider].[MemberChartData] Mc On Mc.MemberChartId =Me.MemberChartId
				inner join [provider].[ProviderProfiles] pp on pp.[ProviderId]=Mc.[ProviderId] --and (@providerCode = '180000')-- or pp.[ProviderCode]=@providerCode)
				inner join  [Orders].[Orders] o on o.[MemberChartDataId] =Mc.MemberChartDataId
				left join [Orders].[Ordertransactiondetails] t on t.orderid = o.orderid and t.orderstatuscode='PO' and t.isactive=1 and t.iscomplete=1
				--left join(select orderid,iscomplete from [Orders].[OrderTransactionDetails] where IsActive=1  and OrderStatusCode='APQ' )u ON o.orderid =u.orderid
				where (ISJSON(o.MemberData) > 0) and (ISJSON(o.OrderAmountData) > 0) and (ISJSON(o.ProviderData) > 0) and pp.[ProviderCode]=@providerCode
				and O.OrderType IN ('NEW','LSND','LSandD', 'EXCHANGE') and NhMemberID = @nhMemberId
				group by  o.[OrderID],Me.MemberChartId,NhMemberID,o.DateOrderReceived,o.OrderStatusCode,
				[OrderType],OrderAmountData,ProviderData,o.MemberData,o.[MemberChartDataId],t.ordertransactiondata
				order by o.[OrderID] desc  

		END
		ELSE 
		BEGIN

				SELECT  distinct Me.MemberChartId as EngagementId
				,cast(o.DateOrderReceived as date) as OrderDate 
				,o.[OrderID] as OrderId
				,NhMemberID          
				,[OrderType] 
				,Convert(varchar(50),(select STRING_AGG(PONUMBER, ', ') 
				   from [Orders].[OrderPOs] where OrderId = o.OrderId Group by OrderId)) as PoNumber
		  ,(case t.ordertransactiondata when null then null else (select string_agg(convert(varchar, PODate, 110), ',') from (select PODate from openjson(t.ordertransactiondata) with (PODate date '$.poDate')) c) end) as PODATE
				 ,Convert(varchar(50),(SELECT CASE WHEN OrderStatusCode = 'INI'  THEN 'Initiated' WHEN  OrderStatusCode = 'REV'  THEN 'Order Submitted' WHEN OrderStatusCode = 'APP'  THEN 'Order Submitted' 
				 WHEN OrderStatusCode = 'PO' THEN 'Order Submitted' WHEN OrderStatusCode = 'ACK' THEN 'Order Submitted' WHEN OrderStatusCode = 'CAN' THEN 'Cancelled' 
				 WHEN OrderStatusCode = 'RET' THEN 'Returned' WHEN OrderStatusCode = 'REI' THEN 'Re-Initiated' WHEN OrderStatusCode = 'SHI' THEN 'Shipped' WHEN OrderStatusCode = 'DEL' THEN 'Delivered'
				 WHEN OrderStatusCode = 'PAY' THEN 'Payment' WHEN OrderStatusCode = 'CLM' THEN 'Delivered' WHEN OrderStatusCode = 'DOC' THEN 'Docs Submitted' WHEN OrderStatusCode = 'APQ' THEN 'Order Submitted' END FROM Orders.OrderStatusTypes WHERE OrderStatusCode = o.OrderStatusCode)) as OrderStatus
				,(select top 1 B.BrandName from orders.orderITems OT inner join [catalog].[Brands] B on B.BrandCode=OT.BrandCode where orderid = o.orderid  and B.Isactive =1) as BrandCode
				,(select top 1 ProductModelCode from orders.orderITems where orderid = o.orderid and itemtype='HA' ) as ModelCode
				,(select top 1 JSON_VALUE(OrderTransactionData,'$.approvedBy')
			  from Orders.OrderTransactionDetails where OrderId = o.OrderId and orderstatuscode='APP'  and isactive=1) as ApprovedBy
	  			,convert(Datetime,(select top 1 JSON_VALUE(OrderTransactionData,'$.approvedDate')
			  from Orders.OrderTransactionDetails where OrderId = o.OrderId and orderstatuscode='APP' and isactive=1)) as ApprovedDate
				,cast((select count(*) from orders.orderITems where orderid = o.orderid and itemtype = 'HA' and isactive=1 and status='active')as int) [HAItemsCount]
				,cast((select count(*) from orders.orderITems where orderid = o.orderid and itemtype = 'EM' and isactive=1 and status='active')as int) [EMItemsCount]
				,convert(decimal(10,2),Isnull(JSON_VALUE(OrderAmountData,'$.productPrice'),0)) as OrderPrice   
				,Convert(decimal(10,2),cast(JSON_VALUE(o.OrderAmountData,'$.memberResponsibility') as decimal(10,2))) as MemberResponsibility         
				,Convert(decimal(10,2), isnull((select top 1 JSON_VALUE(OrderTransactionData,'$.totalAmount')
			  from Orders.OrderTransactionDetails where OrderId = o.OrderId and orderstatuscode='PAY' and isactive=1), 0)) as AmountPaid
				,convert(decimal(10,2),isnull(JSON_VALUE(OrderAmountData, '$.memberResponsibility'),0))-
			   convert(decimal(10,2),isnull(JSON_VALUE(OrderAmountData, '$.appliedCredit.value'),0))-
			   Convert(decimal(10,2), isnull((select top 1 JSON_VALUE(OrderTransactionData,'$.totalAmount')
			   from Orders.OrderTransactionDetails where OrderId = o.OrderId and orderstatuscode='PAY' and isactive=1), 0)) + 
			  convert(decimal(10,2),isnull(JSON_VALUE(OrderAmountData, '$.refundDetails.refundedAmount') ,0)) 
			  + convert(decimal(10,2),isnull(cast(JSON_VALUE(OrderAmountData, '$.forwardCredits.creditForwarded') as decimal(10,2)),0)) as Balance 
			,cast(Isnull(JSON_VALUE(ProviderData,'$."providerId"'),0) as bigint) as ProviderId
				,cast(Isnull(JSON_VALUE(ProviderData,'$.address."locationId"'),0) as bigint) as locationId
				,cast(Isnull(JSON_VALUE(o.MemberData,'$."insCarrierId"'),0) as bigint) as InsuranceCarrierId
				,cast(Isnull(JSON_VALUE(o.MemberData,'$."insPlanId"'),0) as bigint) as HealthPlanId
				 ,cast(Isnull(JSON_VALUE(ProviderData,'$.address."locationId"'),0) as bigint) as ProviderLocationId
				,o.[MemberChartDataId]
				,cast((case when exists (select * from [Insurance].[InsuranceCarriers] c where (c.[IsContracted]=1 or c.[IsDiscountProgram]=1) and c.[InsuranceCarrierID]=cast(Isnull(JSON_VALUE(o.MemberData,'$."insCarrierId"'),0) as bigint)) then 0 else 1 end) as bit) as UsingNHDiscount
				from [provider].[MemberCharts] Me
				inner Join [provider].[MemberChartData] Mc On Mc.MemberChartId =Me.MemberChartId
				inner join [provider].[ProviderProfiles] pp on pp.[ProviderId]=Mc.[ProviderId] --and (@providerCode = '180000')-- or pp.[ProviderCode]=@providerCode)
				inner join  [Orders].[Orders] o on o.[MemberChartDataId] =Mc.MemberChartDataId		
				left join [Orders].[Ordertransactiondetails] t on t.orderid = o.orderid and t.orderstatuscode='PO' and t.isactive=1 and t.iscomplete=1
				where (ISJSON(o.MemberData) > 0) and (ISJSON(o.OrderAmountData) > 0) and (ISJSON(o.ProviderData) > 0) and pp.[ProviderCode]=@providerCode and Me.MemberChartId =@engagementId
				and O.OrderType In ('NEW','LSND','LSandD', 'EXCHANGE') and NhMemberID = @nhMemberId
				group by  o.[OrderID],Me.MemberChartId,NhMemberID,o.DateOrderReceived,o.OrderStatusCode,
				[OrderType],OrderAmountData,ProviderData,o.MemberData,o.[MemberChartDataId],t.ordertransactiondata
				order by o.[OrderID] desc  

			END	
END
END

CREATE proc [provider].[OTCMemberOrders] --'OTC201901912885'
@NHMemberId varchar(20)
as 
begin
select distinct [OrderID],[OrderType],[DateOrderReceived],o.[CreateDate],[DateOrderInitiated],
(case [OrderStatusCode]
	when 'INI' then 'Submitted'
	when 'ACK' then 'Confirmed'
	when 'SHI' then 'Shipped' end) as OrderStatusCode
,convert(decimal,[Amount]) as TotalAmount
,convert(decimal,Json_value([OrderAmountData],'$.amountCovered')) as BenefitApplied
,convert(decimal,([Amount]-convert(decimal,Json_value([OrderAmountData],'$.amountCovered')))) as MemberResponsibilty,
[OrderAmountData],[ShippingData],o.[NHMemberId],[MemberData],convert(bigint,[MemberChartDataId]) as MemberChartDataId
,[Status],me.[EmailAddress] as MemberEmailId
 from orders.orders o
 left join [provider].[MemberProfiles] mp on mp.[NHMemberId]=o.[NHMemberId] and mp.[IsActive]=1
 left join [provider].[MemberEmails] me on me.[MemberProfileId]=mp.[MemberProfileId] and me.Isactive=1
 where o.[NHMemberId]= @NHMemberId and [OrderType]='OTC' 
 and o.[IsActive]=1    
 order by orderid desc
end
CREATE PROCEDURE [provider].[GetAllProviders](@ProviderName Nvarchar(100))
AS
BEGIN
    -- SET NOCOUNT ON added to prevent extra result sets from
    -- interfering with SELECT statements.
    SET NOCOUNT ON
    -- Insert statements for procedure here
    If( @ProviderName is null or @ProviderName='')
		Begin
			SELECT distinct ProviderName from [provider].[ProviderProfiles]
		End
	Else
		Begin
			SELECT distinct ProviderName from [provider].[ProviderProfiles]  where ProviderName like @ProviderName + '%'
		End
END
CREATE PROCEDURE [provider].[GetPreServiceAuthRequestHistory]  
(  
    -- Add the parameters for the stored procedure here  
   @nhMemberId Varchar(50)  
)  
AS  
BEGIN  
    -- SET NOCOUNT ON added to prevent extra result sets from  
    -- interfering with SELECT statements.  
    SET NOCOUNT ON  
  
    -- Insert statements for procedure here  
      select  
	cast(ROW_NUMBER() OVER(ORDER BY CaseNumber) as int)  AS RowID   
 ,cast(CaseNumber as bigint) as CaseNumber 
  ,JSON_VALUE(PreServiceAuthRequestDetails, '$.requestSource') 'RequestSource'  
  ,JSON_VALUE(PreServiceAuthRequestDetails, '$.requestedBy') 'RequestedBy'  
  ,cast(JSON_VALUE(PreServiceAuthRequestDetails, '$.requestReceivedDate') as DateTime) 'RequestDate'  
  ,JSON_VALUE(PreServiceAuthRequestDetails, '$.caseDisposition') 'CaseDisposition'  
  ,cast(JSON_VALUE(PreServiceAuthRequestDetails, '$.finalDecisionDateTime') as DateTime)'CaseDispositionDateTime'  
  ,cast(JSON_VALUE(PreServiceAuthRequestTimeliness, '$.hearingTestDate') as DateTime)  as 'HearingTestDate'  
  ,ModifyUser as 'LastUpdatedBy'  
  ,ModifyDate as 'LastUpdatedOn',IsApproved  
   
 from [provider].[PreServiceAuthRequests] where NhMemberid= @nhMemberId  and isactive=1
END 

-- exec [provider].[GetMemberOrderDetails] ''
CREATE Procedure [provider].[GetMemberOrderDetails]
	@nhMemberId [nvarchar](50)
AS
BEGIN
SET NOCOUNT ON
      SELECT  distinct o.[OrderID]
        ,isnull([BrandCode],'') as [BrandCode]
        ,[MemberChartDataId]
        ,NhMemberID  
		,o.CreateDate AS OrderDate
        ,Convert(varchar(20)
        ,(SELECT OrderStatusName FROM Orders.OrderStatusTypes WHERE OrderStatusCode = o.OrderStatusCode)) AS OrderStatusName                   
        ,[FamilyCode]
        ,[TechnologyLevelCode]
        ,ModelCode
        ,[OrderType]
        ,CONVERT(date,[DateOrderReceived]) DateOrderReceived
        ,case when o.OrderStatusCode in('CAN','RET') then (select count(*) from orders.orderITems where orderid = o.orderid and itemtype <> 'EM')else (select count(*) from orders.orderITems where orderid = o.orderid and itemtype <> 'EM' and Status='ACTIVE') end as [DeviceCount]
        ,Convert(varchar(20),cast(ISNULL(JSON_VALUE(OrderAmountData,'$."productPrice"'),0) as decimal(10,2))) as ProductPrice
        ,Convert(varchar(20),cast(ISNULL(JSON_VALUE(OrderAmountData,'$."insuranceBenefit"'),0) as decimal(10,2))) as BenefitPrice
        ,Convert(varchar(20),(case when (cast(JSON_VALUE(OrderAmountData,'$."productPrice"') as decimal(10,2))) <= ((cast(JSON_VALUE(OrderAmountData,'$."insuranceBenefit"')as decimal(10,2))-(cast(JSON_VALUE(o.OrderAmountData,'$.benefitUsed')as decimal(10,2)))))
        then cast(ISNULL(JSON_VALUE(OrderAmountData,'$."productPrice"'),0) as decimal(10,2)) else ((cast(ISNULL(JSON_VALUE(OrderAmountData,'$."insuranceBenefit"'),0)as decimal(18,2))-(cast(ISNULL(JSON_VALUE(o.OrderAmountData,'$.benefitUsed'),0)as decimal(18,2)))))  end)) BenefitApplied
	
		,CASE 
			WHEN JSON_VALUE(OrderAmountData,'$."medicaidBenefit"') IS NULL THEN NULL 
			ELSE 
			Convert(varchar(20),cast(JSON_VALUE(OrderAmountData,'$."medicaidBenefit"') as decimal(10,2)))
			END AS MedicaidBenefit
        ,Convert(varchar(20),(case when (cast(JSON_VALUE(OrderAmountData,'$."insuranceBenefit"')as decimal(10,2))-(cast(JSON_VALUE(o.OrderAmountData,'$.benefitUsed')as decimal(10,2))))=cast(JSON_VALUE(OrderAmountData,'$."productPrice"') as decimal(10,2))
        then ( case when (cast(JSON_VALUE(o.OrderAmountData,'$.benefitUsed')as decimal(10,2)))=0 then cast(JSON_VALUE(o.OrderAmountData,'$.productPrice')as decimal(10,2))-(cast(JSON_VALUE(OrderAmountData,'$."insuranceBenefit"')as decimal(10,2))-cast(JSON_VALUE(OrderAmountData,'$."benefitUsed"')as decimal(10,2))) else 0 end)
        else (case when (cast(JSON_VALUE(OrderAmountData,'$."insuranceBenefit"')as decimal(10,2))-cast(JSON_VALUE(OrderAmountData,'$."benefitUsed"')as decimal(10,2)))> cast(JSON_VALUE(OrderAmountData,'$."productPrice"')as decimal(10,2))
        then (cast(JSON_VALUE(OrderAmountData,'$."insuranceBenefit"')as decimal(10,2))-cast(JSON_VALUE(OrderAmountData,'$."benefitUsed"')as decimal(10,2)))-cast(JSON_VALUE(OrderAmountData,'$."productPrice"')as decimal(10,2))else 0 end)end)) RemainingBenefit 
		,Convert(varchar(20),cast(ISNULL(JSON_VALUE(OrderAmountData,'$."benefitAvailable"'),0) as decimal(10,2))) as AvailableBenefitPrice
        ,Convert(varchar(20),isnull(cast(JSON_VALUE(ISNULL(LTRIM(RTRIM(OrderAmountData)), 0),'$."adjustments"') as decimal(10,2)),0)) as AdjustedPrice
        ,Convert(varchar(20),cast(JSON_VALUE(o.OrderAmountData,'$.memberResponsibility') as decimal(10,2))) as MemberPrice         
        ,Isnull(Convert(varchar(20),(select isnull(sum(cast(JSON_VALUE(ISNULL(OrderTransactionData,0),'$.totalAmount')as decimal(10,2))),0)
        from Orders.OrderTransactionDetails where OrderId = o.OrderId Group by OrderId)),0) as AmountPaid,
		Isnull(Convert(varchar(20),(cast(JSON_VALUE(o.OrderAmountData,'$.memberResponsibility') as decimal(10,2))-(select isnull(sum(cast(JSON_VALUE(ISNULL(OrderTransactionData,0),'$.totalAmount')as decimal(10,2))),0) from Orders.OrderTransactionDetails where OrderId = o.OrderId Group by OrderId))),0) as BalanceDue --$0
       ,Convert(varchar(20),cast(ISNULL(JSON_VALUE(OrderAmountData,'$."benefitUsed"'),0) as decimal(10,2))) as BenefitUsed
        ,JSON_VALUE(ProviderData,'$."providerLeagalBusinessName"') as ProviderName
        ,cast(JSON_VALUE(ProviderData,'$."providerId"') as bigint) as ProviderId
        ,cast(JSON_VALUE(ProviderData,'$.address."locationId"') as bigint) as locationId
        ,cast(JSON_VALUE(o.MemberData,'$."insCarrierId"') as bigint) as InsuranceCarrierId
        ,cast(JSON_VALUE(o.MemberData,'$."insPlanId"') as bigint) as HealthPlanId
		,(select TimeZone from [provider].[Locations] l where  cast(JSON_VALUE(ProviderData,'$.address."locationId"') as bigint) = l.locationId) as TimeZone
		,CASE 
			WHEN PoNumber IS NULL THEN NULL
			ELSE 
			cast(PoNumber as varchar)
			END AS PoNumber
		,PODate AS PODate
    from [Orders].[Orders] o
    inner join ( select orderitem.OrderId,BrandCode,FamilyCode,TechnologyLevelCode,[ProductModelCode] as ModelCode ,
    case when JSON_VALUE(OrderTransactionData, '$.poNumber') IS not NULL then JSON_VALUE(OrderTransactionData,'$.poNumber')
    when JSON_VALUE(OrderTransactionData,'$[1].poNumber') is null then JSON_VALUE(OrderTransactionData, '$[0].poNumber') else
    JSON_VALUE(OrderTransactionData, '$[0].poNumber') +','+ JSON_VALUE(OrderTransactionData,'$[1].poNumber') end  as poNumber
    ,case when JSON_VALUE(OrderTransactionData, '$.poDate') is not null then
    Convert(datetime, JSON_VALUE(OrderTransactionData, '$.poDate')) else Convert(datetime, JSON_VALUE(OrderTransactionData, '$[0].poDate')) end poDate
	, row_number() over (Partition by orderitem.OrderID Order by orderitem.orderid) as RN --added this line
    from orders.orderitems orderitem
    left join(select * from  [Orders].[OrderTransactionDetails] where orderstatuscode='PO' and Iscomplete=1)otd on  otd.OrderId=orderitem.OrderId
    where orderitem.IsActive=1   and  orderitem.ItemType not in('EM')--, 'CROS'             
    ) items
    on Items.OrderId=o.OrderId and RN=1
    where (ISJSON(o.MemberData) > 0) and (ISJSON(o.OrderAmountData) > 0) and (ISJSON(o.ProviderData) > 0) and O.OrderType Not IN ('TEST','FITTING','FOLLOWUP') 
	AND NhMemberID = @nhMemberId 
	and o.IsActive=1
	and o.ordertype!='OTC'
    group by  o.[OrderID],[BrandCode],[MemberChartDataId],NhMemberID,o.CreateDate,o.OrderStatusCode,[FamilyCode],[TechnologyLevelCode],ModelCode,
    [OrderType],[DateOrderReceived],OrderAmountData,[Amount],ProviderData,o.MemberData,PoNumber ,PODate
    order by 
	o.CreateDate DESC
 
END

CREATE PROCEDURE [provider].[GetEngagementDetails]
(
    -- Add the parameters for the stored procedure here
   @nhMemberId [nvarchar](50),
   @providerCode [varchar](10)
)
AS
BEGIN
    -- SET NOCOUNT ON added to prevent extra result sets from
    -- interfering with SELECT statements.
    SET NOCOUNT ON
		select 
			ROW_NUMBER() OVER(ORDER BY temp.startdate desc) AS RowId
			,mc.MemberChartId as EngagementId
			,temp.startdate as EngagementDate
			,temp.ProviderId as ProviderId
			,temp.ProviderCode as ProviderCode
		from [provider].[MemberCharts] mc 
		inner join [provider].[MemberProfiles] m ON mc.MemberProfileId = m.MemberProfileId 
		inner join (
			--select distinct pp.ProviderId, pp.ProviderCode, mcd.MemberChartId from [provider].[MemberChartData] mcd
			--inner join [provider].[ProviderProfiles] pp on pp.[ProviderId]=mcd.[ProviderId]
			--where (@providerCode = '180000' or pp.ProviderCode=@providerCode)
			--and exists (select * from [provider].[MemberAppointments] apt where apt.[MemberChartDataId]=mcd.[MemberChartDataId] and apt.[AppointmentStatus] not in ('Cancel', 'Cancelled') and apt.[IsActive]=1)
			select distinct pp.ProviderId, pp.ProviderCode, mcd.MemberChartId,apt.startdate from [provider].[MemberChartData] mcd
			inner join [provider].[ProviderProfiles] pp on pp.[ProviderId]=mcd.[ProviderId]
			inner join [provider].[MemberAppointments] apt on mcd.[MemberChartDataId]= apt.[MemberChartDataId]
			where (@providerCode = '180000' or pp.ProviderCode=@providerCode) and apt.[AppointmentStatus] not in ('Cancel', 'Cancelled') and apt.[IsActive]=1
			) temp
		on mc.MemberChartId=temp.MemberChartId
		where mc.[IsActive] = 1 and m.[IsActive] = 1 and  m.[NHMemberId] = @nhMemberId 
		order by  mc.MemberChartId desc 
END
CREATE PROCEDURE [provider].[Get_ProviderLocations]        
 (@providerid  NVARCHAR(50) = NULL,@profileId  NVARCHAR(50) = NULL)  
/*       
Author: Srinivas G       
Date: Feb 14 2019
Desription 1: This stored procedure returns Locations  which are IsActive=1       
*/       
AS       
BEGIN       
DECLARE @SQLSubQuery AS NVARCHAR(4000)   
set @SQLSubQuery ='select distinct LO.LocationId,LO.Address1,LO.Address2,LO.City,LO.State,LO.Zip
 from [provider].[ProviderProfiles] as PP
join [provider].[ProvideruserLocations] as PL on PL.providerid='+@providerid+' and PL.userprofileid='+@profileId+'
join [provider].[Locations] as LO on PL.locationid=LO.locationid
where PP.isActive=1 and PL.isActive=1 and LO.isActive=1 and PP.providerid='+@providerid+''
 
 SET @SQLSubQuery = 'select ROW_NUMBER() OVER (ORDER BY C.LocationId) as ''RowID'',*from ('+@SQLSubQuery+') C'         
 print @SQLSubQuery  
  EXECUTE sp_ExecuteSQL @SQLSubQuery       
END
CREATE PROCEDURE  [provider].[GetApprovalQueueOrders]

AS
BEGIN
    -- SET NOCOUNT ON added to prevent extra result sets from
    -- interfering with SELECT statements.
    SET NOCOUNT ON
	 -- declare @providerid int =591;
		select  ROW_NUMBER() OVER(ORDER BY OrderId ASC) AS RowId
		,PP.ProviderCode
		,JSON_VALUE(ProviderData, '$.dba') LocationName
		,NHMemberId
		,OrderId
		,DateOrderReceived as OrderDate
		,OrderType
		,OrderStatusCode
		,JSON_VALUE(ProviderData, '$.address.address1') Address1
		,JSON_VALUE(ProviderData, '$.address.address2') Address2
		,JSON_VALUE(ProviderData, '$.address.city') City
		,JSON_VALUE(ProviderData, '$.address.state') State
		,JSON_VALUE(ProviderData, '$.address.zip') Zip
		,JSON_VALUE(ProviderData, '$.address.country') Country
		--,(select top 1 JSON_VALUE(OrderTransactionData,'$.sumbit.comments')
		--	from Orders.OrderTransactionDetails where OrderId = o.OrderId and orderstatuscode='APP'  and isactive=1) as ApprovedComments
		,cast((Case when exists (select * from [Orders].[OrderTransactionDetails] 
			where  IsActive=1  and OrderStatusCode='APQ' and OrderId = o.OrderId) then 1 else 0 end) as Bit) SubmittedForApproval
		from orders.orders o 
		join [provider].[ProviderProfiles] PP on JSON_VALUE(o.ProviderData, '$.providerId')=PP.ProviderId
		where 
		    O.OrderType IN ('NEW','LSND','LSandD', 'EXCHANGE')
		and O.Isactive=1
		and Not exists (select * from Orders.OrderTransactionDetails where OrderId = o.OrderId and orderstatuscode='APP'  and isactive=1 and iscomplete=1)
		and o.Status='Active'

END
CREATE Procedure [provider].[GetMemberConsultationNotes]
(@nhMemberId NVARCHAR(50)=null,@providerCode NVARCHAR(50)=null)
 AS
 Begin
if(@providerCode is not null and @providerCode != '180000')
select CN.ConsultationNotesId, CN.Notes,CN.NhMemberId,CN.ProviderId,CN.CreateDate,CN.ModifyDate,CN.CreateUser,PP.ProviderCode,PP.ProviderName
from [provider].[ConsultationNotes] as CN
join [provider].[ProviderProfiles] as PP on PP.providerid=CN.providerid
where CN.nhmemberid=@nhMemberId and PP.ProviderCode=@providerCode and CN.isactive=1
else if(@providerCode is not null and @providerCode = '180000')
select CN.ConsultationNotesId,CN.Notes,CN.NhMemberId,CN.ProviderId,CN.CreateDate,CN.ModifyDate,CN.CreateUser,PP.ProviderCode,PP.ProviderName
from [provider].[ConsultationNotes] as CN
join [provider].[ProviderProfiles] as PP on PP.providerid=CN.providerid
where CN.nhmemberid=@nhMemberId and CN.isactive=1
End
CREATE PROCEDURE [provider].[GetNewProviderCode] 
@providerId BIGINT,
@userId BIGINT
AS
BEGIN

SET NOCOUNT ON; 

DECLARE @ProviderCode VARCHAR(6), @StaticNumber VARCHAR(6), @ProvDiff INT, @StaticDiff INT;
SET @StaticNumber  = '180000'
SELECT @ProviderCode = ProviderCode FROM [provider].[ProviderProfiles] WHERE providerid = @providerId AND LEN(ProviderCode) <= 6

IF(LEN(@ProviderCode) < 6)
	BEGIN    
		SET @ProvDiff = Len(@StaticNumber) - Len(@ProviderId);
		SET @StaticDiff = Substring(@StaticNumber, 1, @ProvDiff);
		SET @ProviderCode = CAST(@StaticDiff as VARCHAR(6)) + CAST(@ProviderId as VARCHAR(6))	
		
			UPDATE [provider].[ProviderProfiles] SET ProviderCode = @ProviderCode WHERE providerid = @providerId
			IF NOT EXISTS (SELECT UserProfileId FROM [auth].[UserProfiles] WHERE providercode = @ProviderCode AND UserProfileId = @userId)
			BEGIN
				UPDATE [auth].[UserProfiles] SET ProviderCode = @ProviderCode WHERE UserProfileId = @userId
			END
			SELECT * FROM [provider].[ProviderProfiles] WHERE providerid= @providerId
	END
ELSE
	BEGIN
			UPDATE [auth].[UserProfiles] SET ProviderCode = @ProviderCode WHERE UserProfileId = @userId
			SELECT * FROM [provider].[ProviderProfiles] WHERE providerid= @providerId
	END


END
create proc [provider].GetFittingLocationInfoByMemberChart
@MemberchartId bigint
as
select l.[LocationId],[ActiveDate],[Address1],[Address2],[Brands],[BusinessName],[BusinessType],[City],[Dispenser]
,[IsVerified],[IsWheelChair],[Langauges],[Latitude],[LocationTypeId],[Longitude],[NPINumber],[OfficeSecodary],[Officeprimary],[PatientTypes]
,[ProviderType],[State],[StateName],[StoreCategory],[TimeZone],[Zip],[LocationEmailAddress],[LocationServicesData],[IsMedicaid],[County],[InActiveDate],
[InActiveReason],[Country],[TaxId],[IsMedicare],[IsCredentialsMet],[IsMobileLocation],[IsHandicapSpecialNeedsAccess],[IsPediatricServices],[IsPublicTransport]
,[IsADAComplauints],[IsAcceptNewPatients],[PatientMinAge],[PatientMaxAge],l.[CreateDate],l.[CreateUser],l.[ModifyUser],l.[ModifyDate],l.[IsActive]
 from [provider].[Locations] l join [provider].[MemberChartData] mcd 
on l.locationid=mcd.[LocationId] where memberchartid=@MemberchartId and minorprocessid=25 and mcd.isactive=1 and l.isactive=1

CREATE Procedure [provider].[Get_ActiveMemberChart](
@MemberProfileId bigint,  
@ProviderId bigint,
@MemberChartDataId bigint,
@AppointmentId bigint
)
AS
BEGIN
  --DECLARE @MemberProfileId bigint --= 9961
  -- 1. Get Active MemberChart of the Member
  DECLARE @MemberChartId bigint = 0

-- OTC Member
IF (@MemberChartDataId = 0) 
 BEGIN

  SELECT @MemberChartId = (SELECT TOP 1 C.[MemberChartId] FROM [provider].[MemberCharts] C
       INNER JOIN [provider].[MemberChartData] D ON C.[MemberChartId]=D.[MemberChartId]
       --INNER JOIN [provider].[MemberAppointments] A ON A.[MemberChartDataId]=D.[MemberChartDataId]
       WHERE C.[MemberProfileId] = @MemberProfileId 
       --AND (@ProviderId=0 OR D.[ProviderId]=@ProviderId) AND (@MemberChartDataId=0 OR D.[MemberChartDataId]=@MemberChartDataId) AND (@AppointmentId=0 OR A.[MemberAppointmentId] = @AppointmentId) 
       ORDER BY C.[MemberChartId] DESC)
  
  SELECT *FROM [provider].[MemberCharts] WHERE [MemberChartId] = @MemberChartId
END
-- HA Member
ELSE
BEGIN
  SELECT @MemberChartId = (SELECT TOP 1 C.[MemberChartId] FROM [provider].[MemberCharts] C
       INNER JOIN [provider].[MemberChartData] D ON C.[MemberChartId]=D.[MemberChartId]
       INNER JOIN [provider].[MemberAppointments] A ON A.[MemberChartDataId]=D.[MemberChartDataId]
       WHERE C.[MemberProfileId] = @MemberProfileId AND (@ProviderId=0 OR D.[ProviderId]=@ProviderId) AND (@MemberChartDataId=0 OR D.[MemberChartDataId]=@MemberChartDataId) AND (@AppointmentId=0 OR A.[MemberAppointmentId] = @AppointmentId) ORDER BY C.[MemberChartId] DESC)
  
  SELECT *FROM [provider].[MemberCharts] WHERE [MemberChartId] = @MemberChartId

END 
END

--Exec [provider].[GetMembershipingItemDetails_b] 180024482,'26254,26252'
CREATE PROCEDURE [provider].[GetMembershipingItemDetails]
(
   @orderId [bigint],
   @OrderItemId varchar(100)

)
AS
BEGIN
    -- SET NOCOUNT ON added to prevent extra result sets from
    -- interfering with SELECT statements.
    SET NOCOUNT ON
  -- declare @orderId [bigint]='180024482'
 -- declare @OrderItemId varchar(100) ='26254,26252'
select O.OrderId
,O.NhMemberId
,(case when isnull((JSON_VALUE(MemberData, '$.firstName')+' '+JSON_VALUE(MemberData, '$.middleName')+' '+JSON_VALUE(MemberData, '$.lastName')),'')='' then 
(select isnull(FirstName,'') + ' ' + isnull(MiddleName,'') + '' + isnull(LastName,'') from provider.Memberprofiles where nhmemberid=O.NhMemberId) end)
 as MemberName
 ,isnull(JSON_VALUE(ProviderData, '$.dba'),'') + ', ' + isnull(JSON_VALUE(ProviderData, '$.address.address'),'') + ' ' + isnull(JSON_VALUE(ProviderData, '$.address.city'),'') + ' ' + isnull(JSON_VALUE(ProviderData, '$.address.state'),'') + ' ' + isnull(JSON_VALUE(ProviderData, '$.address.country'),'') + ' ' + isnull(JSON_VALUE(ProviderData, '$.address.zip'),'')  as ProviderDbaAddress
,cast(OrderItemId as bigint) OrderItemId
,ItemCode
,(case when ItemType='HA'then 'Hearing Aid'else'Earmold' end) as ItemType
,Quantity
,BrandCode
,StyleCode
,ProductModelCode
,JSON_VALUE(ItemData, '$.receiverPower') as ReceiverPower
,JSON_VALUE(ItemData, '$.receiverSize') as ReceiverSize
,FamilyCode
,TechnologyLevelCode 
, JSON_VALUE(ItemData, '$.color') as Color
,JSON_VALUE(ItemData, '$.batterySize') as BatterySize
,Modifier,PONumber,InvoiceNumber,O.CreateDate as OrderDate
,JSON_VALUE(ShippingData, '$.email') as ShippingEmail
,JSON_VALUE(ItemData, '$.sendingImpression') as SendingImpression
,isnull(JSON_VALUE(ShippingData, '$.dba'),'') + ', ' + isnull(JSON_VALUE(ShippingData, '$.address.address'),'') + ' ' + isnull(JSON_VALUE(ShippingData, '$.address.city'),'') + ' ' + isnull(JSON_VALUE(ShippingData, '$.address.state'),'') + ' ' + isnull(JSON_VALUE(ShippingData, '$.address.country'),'') + ' ' + isnull(JSON_VALUE(ShippingData, '$.address.zip'),'')  as ShippingAddress
from [orders].[orders] O 
Inner join [orders].[orderItems] I on O.orderid=I.orderid 
where O.orderid=@orderId and O.isactive=1 and I.Isactive=1 and OrderItemId 
in (SELECT *  FROM orders.fnSplitString(@OrderItemId,','))
order by OrderItemId desc
END

--- Changes in Order By Clause
CREATE  PROCEDURE [provider].[GetOrderManagementAppointments] 
	@nhMemberId [nvarchar](50),
	@providerCode [varchar](10),
	@engagementId [bigint]
AS
BEGIN
    -- SET NOCOUNT ON added to prevent extra result sets from
    -- interfering with SELECT statements.
    SET NOCOUNT ON
 IF(@engagementId = 0 )
 BEGIN
	   SELECT  ma.MemberAppointmentId as 'AppointmentID'
	        ,mcd.MemberChartId as EngagementId
			,t.[AppointmentTypeName] AppointmentType
			,m.[NHMemberId],
			cast(cast(ma.StartDate as date) as datetime)+cast(cast(ma.StartTime as time) as datetime) AppointmentDate
       	FROM [provider].[MemberAppointments] ma
				INNER JOIN [provider].[MemberChartData] mcd ON ma.MemberChartDataId = mcd.MemberChartDataId
				INNER JOIN [provider].[ProviderProfiles] pp on pp.[ProviderId]=mcd.[ProviderId] and (@providerCode='180000' or pp.[ProviderCode]=@providerCode)
				INNER JOIN [provider].[MemberCharts] mc ON mcd.MemberChartId = mc.MemberChartId
				INNER JOIN [provider].[MemberProfiles] m ON mc.MemberProfileId = m.MemberProfileId
				INNER JOIN [provider].[AppointmentTypes] t ON ma.[AppointmentTypeId] = t.[AppointmentTypeId]				
		where ma.[IsActive] = 1 and mcd.[IsActive] = 1 and mc.[IsActive] = 1 and  m.[NHMemberId] = @nhMemberId 
		and AppointmentStatus not in('Cancel','Cancelled') and t.[AppointmentTypeId] in (1,7)
		 order by 
--OLD
		 --CONVERT(datetime,dateadd(hour, -4, ma.[StartDate])) desc  
--Changes
		 ma.[StartDate] DESC

END

ELSE 
	BEGIN
		 SELECT ma.MemberAppointmentId as 'AppointmentID'
	        ,mcd.MemberChartId as EngagementId
			,t.[AppointmentTypeName] AppointmentType
			,m.[NHMemberId],
			cast(cast(ma.StartDate as date) as datetime)+cast(cast(ma.StartTime as time) as datetime) AppointmentDate
       	FROM [provider].[MemberAppointments] ma
				INNER JOIN [provider].[MemberChartData] mcd ON ma.MemberChartDataId = mcd.MemberChartDataId
				INNER JOIN [provider].[ProviderProfiles] pp on pp.[ProviderId]=mcd.[ProviderId] and (@providerCode='180000' or pp.[ProviderCode]=@providerCode)
				INNER JOIN [provider].[MemberCharts] mc ON mcd.MemberChartId = mc.MemberChartId
				INNER JOIN [provider].[MemberProfiles] m ON mc.MemberProfileId = m.MemberProfileId
				INNER JOIN [provider].[AppointmentTypes] t ON ma.[AppointmentTypeId] = t.[AppointmentTypeId]				
		where ma.[IsActive] = 1 and mcd.[IsActive] = 1 and mc.[IsActive] = 1 and  m.[NHMemberId] = @nhMemberId 
		and mcd.MemberChartId=@engagementId and AppointmentStatus not in('Cancel','Cancelled') and t.[AppointmentTypeId] in (1,7)
		 order by 
		--OLD
		--CONVERT(datetime,dateadd(hour, -4, ma.[StartDate])) desc  
		--Changes
		 ma.[StartDate] DESC
		
	END

END
CREATE procedure [provider].[GetProviderUserDefaultPermissions] 
(
	@providerId [bigint] = 0,
	@userGroupId [int] = 0
)
as
begin
	select
	 af.[AppFeatureId]
	,af.[ParentFeatureId]
	,af.[FeatureName]
	,af.[FeatureCode]
	,af.[IsCreate]
	,af.[IsCreate] as 'IsCreateDefault'
	,af.[IsRead]
	,af.[IsRead] as 'IsReadDefault'
	,af.[IsUpdate]
	,af.[IsUpdate] 'IsUpdateDefault'
	,af.[IsDelete] as 'IsCancel'
	,af.[IsDelete] as 'IsCancelDefault'
	from [auth].[ApplicationFeatures] af
	where af.[IsDefault]=1 and af.[IsActive] = 1
end

 CREATE PROCEDURE [provider].[Get_LocationAndHCPAvilability]            
 (@providerid  NVARCHAR(50) = NULL,           
 @locationid NVARCHAR(50) = NULL,     
 @userprofileid NVARCHAR(50) = NULL)         
/*           
Author: Srinivas G           
Date: Feb 01 2019     
Desription 1: This stored procedure returns Location and HCP Avilability which are IsActive=1           
*/           
AS           
BEGIN           
DECLARE @SQLSubQuery AS NVARCHAR(4000)       
set @SQLSubQuery ='select distinct PUL.locationid,PUL.userprofileid,PS.DayName as LocationDayName,LS.Opentime as LocationOpenTime,LS.CloseTime as LocationCloseTime,     
LS.BreakStartTime as LocationBreakStartTime,LS.BreakEndtime as LocationBreakEndTime,LS.IsByappointmentonly as LocationIsByappointmentonly,     
PS.Opentime as HCPOpenTime,PS.CloseTime as HCPCloseTime,PS.BreakStartTime as HCPBreakStartTime, PS.BreakEndTime as HCPBreakEndTime,     
PS.Isclosed as HCPIsClosed,PS.IsByappointmentonly as HCPIsByappointmentonly     
from [provider].[ProviderUserLocations] as PUL     
join [provider].[LocationSchedules] as LS on LS.locationid=PUL.locationid     
join [provider].[HCPSchedules] as PS on PS.locationid=PUL.locationid and PUL.userprofileid=PS.userprofileid    
where LS.isactive=1 and PUL.isactive=1 and PS.IsActive=1 and  PUL.providerid='+@providerid +'and PUL.locationid='+@locationid +'and PUL.userprofileid='+@userprofileid +''     
 SET @SQLSubQuery = 'select ROW_NUMBER() OVER (ORDER BY C.locationid) as ''RowID'',*from ('+@SQLSubQuery+') C'             
 print @SQLSubQuery      
  EXECUTE sp_ExecuteSQL @SQLSubQuery           
END
CREATE PROCEDURE [provider].[Get_LocationAvilability]         
(@locationid NVARCHAR(50) = NULL,
@providerid  NVARCHAR(50) = NULL)      
/*        
Author: Srinivas G        
Date: Feb 01 2019  
Desription 1: This stored procedure returns Location Avilability which are IsActive=1        
*/        
AS        
BEGIN        
DECLARE @SQLSubQuery AS NVARCHAR(4000)    
set @SQLSubQuery ='select distinct PL.Providerid,PL.Locationid,LS.opentime,LS.closetime,LS.dayname,LS.Breakstarttime,LS.BreakEndtime,
LS.isclosed,ls.isbyappointmentonly from 
[provider].[ProviderLocations] as PL
join [provider].[LocationSchedules] as LS on LS.locationid=PL.locationid
where PL.isactive=1 and LS.isactive=1 and PL.locationid='+@locationid +' and PL.providerid='+@providerid +'' 

 SET @SQLSubQuery = 'select ROW_NUMBER() OVER (ORDER BY C.locationid) as ''RowID'',*from ('+@SQLSubQuery+') C' 
  EXECUTE sp_ExecuteSQL @SQLSubQuery        
END   
CREATE procedure [provider].[ReceiptDataByMemberChart]
( @chartId bigint=0)
as
begin
declare @results table (
	Type varchar(30),
	Description varchar(50),
	PaymentDate date,
	OrderID bigint,
	CopayAmount decimal,
	AmountPaid decimal,
	TransactionGroupID varchar(40)
);
insert into @results
select 'Co Payment' as Type
,(case d.minorprocessid when 20 then 'Testing Co Payment' when 38 then 'Device Co Payment' when 29 then 'Fitting Co Payment' end) as Description
,a.PaymentDate, a.OrderID, a.CopayAmount, a.AmountPaid, a.TransactionGroupID
from provider.memberchartdata d
cross apply openjson(d.processdata) with (PaymentDate date '$.paymentDate', OrderID bigint '$.orderID', CopayAmount decimal '$.copayAmount', AmountPaid decimal '$.amountPaid', TransactionGroupID varchar(40) '$.transactionGroupID') a
where d.minorprocessid in (20, 29, 38)
and d.memberchartid=@chartId;


select * from @results;

select
 AccountHolderName
,PaymentTypeCode
,CardTypeCode
,BankName
,AccountNumber
,Amount
,a.TransactionGroupID
from [PaymentGateway].[AuthorizedTransactions] a
inner join @results r on a.TransactionGroupID=r.TransactionGroupID
end
CREATE procedure [provider].[GetProviderOwnerUserProfile]
( @ProviderCode [varchar](10) )
as
begin
select up.* from [auth].[UserProfiles] up
inner join [provider].[ProviderUsers] pu on up.[UserProfileId]=pu.[UserProfileId]
inner join [auth].[UserProfileGroups] upg on upg.[UserProfileId]=up.[UserProfileId]
inner join [provider].[ProviderProfiles] pp on pp.[ProviderId]=pu.[ProviderId]
where pp.[ProviderCode]=@ProviderCode and upg.[UserGroupId]=7790--Owner
end
CREATE PROCEDURE [provider].[GetPricingSummaryDetails] 
(
    -- Add the parameters for the stored procedure here
    @orderId bigint
)
AS
BEGIN
    -- SET NOCOUNT ON added to prevent extra result sets from
    -- interfering with SELECT statements.
    SET NOCOUNT ON
	-- declare @orderId bigint =190002458
	SELECT O.OrderID,OrderAmountData,MemberData,convert(decimal(10,2),isnull((select top 1 JSON_VALUE(orderTransactionData, '$.totalAmount') from [Orders].[OrderTransactionDetails] OT where OT.Orderid = O.Orderid and OT.Orderstatuscode='PAY' and OT.IsActive=1),0)) AS MemberPaid FROM  orders.orders O
   where O.orderid=@orderId and O.IsActive=1

END
CREATE Procedure [provider].[GetOrderManagementDetails]
@nhMemberId [nvarchar](50),
@providerCode [varchar](10),
@engagementId [bigint]
AS
BEGIN
SET NOCOUNT ON 

IF (@providerCode = '180000')
BEGIN
	IF(@engagementId = 0 )
		BEGIN   
				SELECT  distinct Me.MemberChartId as EngagementId
				,cast(o.DateOrderReceived as date) as OrderDate
				,o.[OrderID] as OrderId
				,NhMemberID 
				,[OrderType] 
				,Convert(varchar(50),(select STRING_AGG(PONUMBER, ', ') 
				   from [Orders].[OrderPOs] where OrderId = o.OrderId Group by OrderId)) as PoNumber
				,(case t.ordertransactiondata when null then null else (select string_agg(convert(varchar, PODate, 110), ',') from (select PODate from openjson(t.ordertransactiondata) with (PODate date '$.poDate')) c) end) as PODATE
				,Convert(varchar(50),(SELECT CASE WHEN OrderStatusCode = 'INI'  THEN 'Initiated' WHEN  OrderStatusCode = 'REV'  THEN 'Reviewed' WHEN OrderStatusCode = 'APP'  THEN 'Approved' 
				 WHEN OrderStatusCode = 'PO' THEN 'PO' WHEN OrderStatusCode = 'ACK' THEN 'Acknowledge' WHEN OrderStatusCode = 'CAN' THEN 'Cancelled' 
				 WHEN OrderStatusCode = 'RET' THEN 'Returned' WHEN OrderStatusCode = 'REI' THEN 'Re-Initiated' WHEN OrderStatusCode = 'SHI' THEN 'Shipped' WHEN OrderStatusCode = 'DEL' THEN 'Delivered'
				 WHEN OrderStatusCode = 'PAY' THEN 'Payment' WHEN OrderStatusCode = 'CLM' THEN 'Claim Submitted' WHEN OrderStatusCode = 'DOC' THEN 'Documents Verified' WHEN OrderStatusCode = 'APQ' THEN 'Pending Approval' END FROM Orders.OrderStatusTypes WHERE OrderStatusCode = o.OrderStatusCode)) as OrderStatus
				,(select top 1 B.BrandName from orders.orderITems OT inner join [catalog].[Brands] B on B.BrandCode=OT.BrandCode where orderid = o.orderid  and B.Isactive =1) as BrandCode
				,(select top 1 ProductModelCode from orders.orderITems where orderid = o.orderid and itemtype = 'HA') as ModelCode
				,(select top 1 JSON_VALUE(OrderTransactionData,'$.approvedBy')
			  from Orders.OrderTransactionDetails where OrderId = o.OrderId and orderstatuscode='APP'  and isactive=1) as ApprovedBy
	  			,convert(Datetime,(select top 1 JSON_VALUE(OrderTransactionData,'$.approvedDate')
			  from Orders.OrderTransactionDetails where OrderId = o.OrderId and orderstatuscode='APP' and isactive=1)) as ApprovedDate
				,cast((select count(*) from orders.orderITems where orderid = o.orderid and itemtype = 'HA' and isactive=1 and status='active')as int) [HAItemsCount]
				,cast((select count(*) from orders.orderITems where orderid = o.orderid and itemtype = 'EM' and isactive=1 and status='active')as int) [EMItemsCount]
				,convert(decimal(10,2),Isnull(JSON_VALUE(OrderAmountData,'$.productPrice'),0)) as OrderPrice      
				,cast(JSON_VALUE(o.OrderAmountData,'$.memberResponsibility') as decimal(10,2))
				--isnull((case JSON_VALUE(o.OrderAmountData,'$.memberResponsibility') when null then Convert(decimal(10,2),cast(JSON_VALUE(o.OrderAmountData,'$.memberResponsibility') as decimal(10,2))) 
				--when (charindex(JSON_VALUE(o.OrderAmountData,'$.adjustments'), '-')) > 0 then (Convert(decimal(10,2),cast(JSON_VALUE(o.OrderAmountData,'$.memberResponsibility') as decimal) + cast(JSON_VALUE(o.OrderAmountData,'$.adjustments') as decimal)))
				--else Convert(decimal(10,2),cast(JSON_VALUE(o.OrderAmountData,'$.memberResponsibility') as decimal(10,2)) + cast(JSON_VALUE(o.OrderAmountData,'$.adjustments') as decimal(10,2)))
				--end), 0)
				as MemberResponsibility         
				,Convert(decimal(10,2), isnull((select top 1 JSON_VALUE(OrderTransactionData,'$.totalAmount')
			  from Orders.OrderTransactionDetails where OrderId = o.OrderId and orderstatuscode='PAY' and isactive=1), 0)) as AmountPaid
				,convert(decimal(10,2),isnull(JSON_VALUE(OrderAmountData, '$.memberResponsibility'),0))-
			   convert(decimal(10,2),isnull(JSON_VALUE(OrderAmountData, '$.appliedCredit.value'),0))-
			   Convert(decimal(10,2), isnull((select top 1 JSON_VALUE(OrderTransactionData,'$.totalAmount')
			  from Orders.OrderTransactionDetails where OrderId = o.OrderId and orderstatuscode='PAY' and isactive=1), 0)) + 
			 convert(decimal(10,2),isnull(JSON_VALUE(OrderAmountData, '$.refundDetails.refundedAmount') ,0)) 
			 + convert(decimal(10,2),isnull(cast(JSON_VALUE(OrderAmountData, '$.forwardCredits.creditForwarded') as decimal(10,2)),0) ) as Balance 
				,cast(Isnull(JSON_VALUE(ProviderData,'$."providerId"'),0) as bigint) as ProviderId
				,cast(Isnull(JSON_VALUE(ProviderData,'$.address."locationId"'),0) as bigint) as locationId
				,cast(Isnull(JSON_VALUE(o.MemberData,'$."insCarrierId"'),0) as bigint) as InsuranceCarrierId
				,cast(Isnull(JSON_VALUE(o.MemberData,'$."insPlanId"'),0) as bigint) as HealthPlanId
				 ,cast(Isnull(JSON_VALUE(ProviderData,'$.address."locationId"'),0) as bigint) as ProviderLocationId
				,o.[MemberChartDataId]
				,cast((case when exists (select * from [Insurance].[InsuranceCarriers] c where (c.[IsContracted]=1 or c.[IsDiscountProgram]=1) and c.[InsuranceCarrierID]=cast(Isnull(JSON_VALUE(o.MemberData,'$."insCarrierId"'),0) as bigint)) then 0 else 1 end) as bit) as UsingNHDiscount
				from [provider].[MemberCharts] Me
				inner Join [provider].[MemberChartData] Mc On Mc.MemberChartId =Me.MemberChartId
				inner join [provider].[ProviderProfiles] pp on pp.[ProviderId]=Mc.[ProviderId] --and (@providerCode = '180000' or pp.[ProviderCode]=@providerCode)
				inner join  [Orders].[Orders] o on o.[MemberChartDataId] =Mc.MemberChartDataId
				left join [Orders].[Ordertransactiondetails] t on t.orderid = o.orderid and t.orderstatuscode='PO' and t.isactive=1 and t.iscomplete=1
				--left join(select orderid,iscomplete from [Orders].[OrderTransactionDetails] where IsActive=1  and OrderStatusCode='APQ' )u ON o.orderid =u.orderid
				where (ISJSON(o.MemberData) > 0) and (ISJSON(o.OrderAmountData) > 0) and (ISJSON(o.ProviderData) > 0) 
				and O.OrderType IN ('NEW','LSND','LSandD', 'EXCHANGE') and NhMemberID = @nhMemberId
				group by  o.[OrderID],Me.MemberChartId,NhMemberID,o.DateOrderReceived,o.OrderStatusCode,
				[OrderType],OrderAmountData,ProviderData,o.MemberData,o.[MemberChartDataId],t.ordertransactiondata
				order by o.[OrderID] desc  

		END
		ELSE 
		BEGIN

				SELECT  distinct Me.MemberChartId as EngagementId
				,cast(o.DateOrderReceived as date) as OrderDate 
				,o.[OrderID] as OrderId
				,NhMemberID          
				,[OrderType] 
				,Convert(varchar(50),(select STRING_AGG(PONUMBER, ', ') 
				   from [Orders].[OrderPOs] where OrderId = o.OrderId Group by OrderId)) as PoNumber
		  ,(case t.ordertransactiondata when null then null else (select string_agg(convert(varchar, PODate, 110), ',') from (select PODate from openjson(t.ordertransactiondata) with (PODate date '$.poDate')) c) end) as PODATE
				,Convert(varchar(50),(SELECT CASE WHEN OrderStatusCode = 'INI'  THEN 'Initiated' WHEN  OrderStatusCode = 'REV'  THEN 'Reviewed' WHEN OrderStatusCode = 'APP'  THEN 'Approved' 
				 WHEN OrderStatusCode = 'PO' THEN 'PO' WHEN OrderStatusCode = 'ACK' THEN 'Acknowledge' WHEN OrderStatusCode = 'CAN' THEN 'Cancelled' 
				 WHEN OrderStatusCode = 'RET' THEN 'Returned' WHEN OrderStatusCode = 'REI' THEN 'Re-Initiated' WHEN OrderStatusCode = 'SHI' THEN 'Shipped' WHEN OrderStatusCode = 'DEL' THEN 'Delivered'
				 WHEN OrderStatusCode = 'PAY' THEN 'Payment' WHEN OrderStatusCode = 'CLM' THEN 'Claim Submitted' WHEN OrderStatusCode = 'DOC' THEN 'Documents Verified' WHEN OrderStatusCode = 'APQ' THEN 'Pending Approval' END FROM Orders.OrderStatusTypes WHERE OrderStatusCode = o.OrderStatusCode)) as OrderStatus
				,(select top 1 B.BrandName from orders.orderITems OT inner join [catalog].[Brands] B on B.BrandCode=OT.BrandCode where orderid = o.orderid  and B.Isactive =1) as BrandCode
				,(select top 1 ProductModelCode from orders.orderITems where orderid = o.orderid and itemtype='HA' ) as ModelCode
				,(select top 1 JSON_VALUE(OrderTransactionData,'$.approvedBy')
			  from Orders.OrderTransactionDetails where OrderId = o.OrderId and orderstatuscode='APP'  and isactive=1) as ApprovedBy
	  			,convert(Datetime,(select top 1 JSON_VALUE(OrderTransactionData,'$.approvedDate')
			  from Orders.OrderTransactionDetails where OrderId = o.OrderId and orderstatuscode='APP' and isactive=1)) as ApprovedDate
				,cast((select count(*) from orders.orderITems where orderid = o.orderid and itemtype = 'HA' and isactive=1 and status='active')as int) [HAItemsCount]
				,cast((select count(*) from orders.orderITems where orderid = o.orderid and itemtype = 'EM' and isactive=1 and status='active')as int) [EMItemsCount]
				,convert(decimal(10,2),Isnull(JSON_VALUE(OrderAmountData,'$.productPrice'),0)) as OrderPrice   
				--,Convert(decimal(10,2),cast(JSON_VALUE(o.OrderAmountData,'$.memberResponsibility') as decimal)) as MemberResponsibility   
				,cast(JSON_VALUE(o.OrderAmountData,'$.memberResponsibility') as decimal(10,2))
				--isnull((case JSON_VALUE(o.OrderAmountData,'$.memberResponsibility') when null then Convert(decimal(10,2),cast(JSON_VALUE(o.OrderAmountData,'$.memberResponsibility') as decimal(10,2))) 
				--when (charindex(JSON_VALUE(o.OrderAmountData,'$.adjustments'), '-')) > 0 then (Convert(decimal(10,2),cast(JSON_VALUE(o.OrderAmountData,'$.memberResponsibility') as decimal) + cast(JSON_VALUE(o.OrderAmountData,'$.adjustments') as decimal)))
				--else Convert(decimal(10,2),cast(JSON_VALUE(o.OrderAmountData,'$.memberResponsibility') as decimal(10,2)) + cast(JSON_VALUE(o.OrderAmountData,'$.adjustments') as decimal(10,2)))
				--end), 0)
				as MemberResponsibility        
				,Convert(decimal(10,2), isnull((select top 1 JSON_VALUE(OrderTransactionData,'$.totalAmount')
			  from Orders.OrderTransactionDetails where OrderId = o.OrderId and orderstatuscode='PAY' and isactive=1), 0)) as AmountPaid
				,convert(decimal(10,2),isnull(JSON_VALUE(OrderAmountData, '$.memberResponsibility'),0))-
			   convert(decimal(10,2),isnull(JSON_VALUE(OrderAmountData, '$.appliedCredit.value'),0))-
			   Convert(decimal(10,2), isnull((select top 1 JSON_VALUE(OrderTransactionData,'$.totalAmount')
			   from Orders.OrderTransactionDetails where OrderId = o.OrderId and orderstatuscode='PAY' and isactive=1), 0)) + 
			  convert(decimal(10,2),isnull(JSON_VALUE(OrderAmountData, '$.refundDetails.refundedAmount') ,0)) 
			  + convert(decimal(10,2),isnull(cast(JSON_VALUE(OrderAmountData, '$.forwardCredits.creditForwarded') as decimal(10,2)),0)) as Balance 
			,cast(Isnull(JSON_VALUE(ProviderData,'$."providerId"'),0) as bigint) as ProviderId
				,cast(Isnull(JSON_VALUE(ProviderData,'$.address."locationId"'),0) as bigint) as locationId
				,cast(Isnull(JSON_VALUE(o.MemberData,'$."insCarrierId"'),0) as bigint) as InsuranceCarrierId
				,cast(Isnull(JSON_VALUE(o.MemberData,'$."insPlanId"'),0) as bigint) as HealthPlanId
				 ,cast(Isnull(JSON_VALUE(ProviderData,'$.address."locationId"'),0) as bigint) as ProviderLocationId
				,o.[MemberChartDataId]
				,cast((case when exists (select * from [Insurance].[InsuranceCarriers] c where (c.[IsContracted]=1 or c.[IsDiscountProgram]=1) and c.[InsuranceCarrierID]=cast(Isnull(JSON_VALUE(o.MemberData,'$."insCarrierId"'),0) as bigint)) then 0 else 1 end) as bit) as UsingNHDiscount
				from [provider].[MemberCharts] Me
				inner Join [provider].[MemberChartData] Mc On Mc.MemberChartId =Me.MemberChartId
				inner join [provider].[ProviderProfiles] pp on pp.[ProviderId]=Mc.[ProviderId] --and (@providerCode = '180000' or pp.[ProviderCode]=@providerCode)
				inner join  [Orders].[Orders] o on o.[MemberChartDataId] =Mc.MemberChartDataId		
				left join [Orders].[Ordertransactiondetails] t on t.orderid = o.orderid and t.orderstatuscode='PO' and t.isactive=1 and t.iscomplete=1
				where (ISJSON(o.MemberData) > 0) and (ISJSON(o.OrderAmountData) > 0) and (ISJSON(o.ProviderData) > 0)  and Me.MemberChartId =@engagementId
				and O.OrderType In ('NEW','LSND','LSandD', 'EXCHANGE') and NhMemberID = @nhMemberId
				group by  o.[OrderID],Me.MemberChartId,NhMemberID,o.DateOrderReceived,o.OrderStatusCode,
				[OrderType],OrderAmountData,ProviderData,o.MemberData,o.[MemberChartDataId],t.ordertransactiondata
				order by o.[OrderID] desc  

			END	
END
ELSE
BEGIN
IF(@engagementId = 0 )
		BEGIN   
				SELECT  distinct Me.MemberChartId as EngagementId
				,cast(o.DateOrderReceived as date) as OrderDate
				,o.[OrderID] as OrderId
				,NhMemberID 
				,[OrderType] 
				,Convert(varchar(50),(select STRING_AGG(PONUMBER, ', ') 
				   from [Orders].[OrderPOs] where OrderId = o.OrderId Group by OrderId)) as PoNumber
				,(case t.ordertransactiondata when null then null else (select string_agg(convert(varchar, PODate, 110), ',') from (select PODate from openjson(t.ordertransactiondata) with (PODate date '$.poDate')) c) end) as PODATE
				,Convert(varchar(50),(SELECT CASE WHEN OrderStatusCode = 'INI'  THEN 'Initiated' WHEN  OrderStatusCode = 'REV'  THEN 'Order Submitted' WHEN OrderStatusCode = 'APP'  THEN 'Order Submitted' 
				 WHEN OrderStatusCode = 'PO' THEN 'Order Submitted' WHEN OrderStatusCode = 'ACK' THEN 'Order Submitted' WHEN OrderStatusCode = 'CAN' THEN 'Cancelled' 
				 WHEN OrderStatusCode = 'RET' THEN 'Returned' WHEN OrderStatusCode = 'REI' THEN 'Re-Initiated' WHEN OrderStatusCode = 'SHI' THEN 'Shipped' WHEN OrderStatusCode = 'DEL' THEN 'Delivered'
				 WHEN OrderStatusCode = 'PAY' THEN 'Payment' WHEN OrderStatusCode = 'CLM' THEN 'Delivered' WHEN OrderStatusCode = 'DOC' THEN 'Docs Submitted' WHEN OrderStatusCode = 'APQ' THEN 'Order Submitted' END FROM Orders.OrderStatusTypes WHERE OrderStatusCode = o.OrderStatusCode)) as OrderStatus
				,(select top 1 B.BrandName from orders.orderITems OT inner join [catalog].[Brands] B on B.BrandCode=OT.BrandCode where orderid = o.orderid  and B.Isactive =1) as BrandCode
				,(select top 1 ProductModelCode from orders.orderITems where orderid = o.orderid and itemtype = 'HA') as ModelCode
				,(select top 1 JSON_VALUE(OrderTransactionData,'$.approvedBy')
			  from Orders.OrderTransactionDetails where OrderId = o.OrderId and orderstatuscode='APP'  and isactive=1) as ApprovedBy
	  			,convert(Datetime,(select top 1 JSON_VALUE(OrderTransactionData,'$.approvedDate')
			  from Orders.OrderTransactionDetails where OrderId = o.OrderId and orderstatuscode='APP' and isactive=1)) as ApprovedDate
				,cast((select count(*) from orders.orderITems where orderid = o.orderid and itemtype = 'HA' and isactive=1 and status='active')as int) [HAItemsCount]
				,cast((select count(*) from orders.orderITems where orderid = o.orderid and itemtype = 'EM' and isactive=1 and status='active')as int) [EMItemsCount]
				,convert(decimal(10,2),Isnull(JSON_VALUE(OrderAmountData,'$.productPrice'),0)) as OrderPrice      
				--,Convert(decimal(10,2),cast(JSON_VALUE(o.OrderAmountData,'$.memberResponsibility') as decimal)) as MemberResponsibility     
				,cast(JSON_VALUE(o.OrderAmountData,'$.memberResponsibility') as decimal(10,2))
				--isnull((case JSON_VALUE(o.OrderAmountData,'$.memberResponsibility') when null then Convert(decimal(10,2),cast(JSON_VALUE(o.OrderAmountData,'$.memberResponsibility') as decimal(10,2))) 
				--when (charindex(JSON_VALUE(o.OrderAmountData,'$.adjustments'), '-')) > 0 then (Convert(decimal(10,2),cast(JSON_VALUE(o.OrderAmountData,'$.memberResponsibility') as decimal) + cast(JSON_VALUE(o.OrderAmountData,'$.adjustments') as decimal)))
				--else Convert(decimal(10,2),cast(JSON_VALUE(o.OrderAmountData,'$.memberResponsibility') as decimal(10,2)) + cast(JSON_VALUE(o.OrderAmountData,'$.adjustments') as decimal(10,2)))
				--end), 0)
				as MemberResponsibility
				,Convert(decimal(10,2), isnull((select top 1 JSON_VALUE(OrderTransactionData,'$.totalAmount')
			  from Orders.OrderTransactionDetails where OrderId = o.OrderId and orderstatuscode='PAY' and isactive=1), 0)) as AmountPaid
				,convert(decimal(10,2),isnull(JSON_VALUE(OrderAmountData, '$.memberResponsibility'),0))-
			   convert(decimal(10,2),isnull(JSON_VALUE(OrderAmountData, '$.appliedCredit.value'),0))-
			   Convert(decimal(10,2), isnull((select top 1 JSON_VALUE(OrderTransactionData,'$.totalAmount')
			  from Orders.OrderTransactionDetails where OrderId = o.OrderId and orderstatuscode='PAY' and isactive=1), 0)) + 
			 convert(decimal(10,2),isnull(JSON_VALUE(OrderAmountData, '$.refundDetails.refundedAmount') ,0)) 
			 + convert(decimal(10,2),isnull(cast(JSON_VALUE(OrderAmountData, '$.forwardCredits.creditForwarded') as decimal(10,2)),0)) as Balance 
				,cast(Isnull(JSON_VALUE(ProviderData,'$."providerId"'),0) as bigint) as ProviderId
				,cast(Isnull(JSON_VALUE(ProviderData,'$.address."locationId"'),0) as bigint) as locationId
				,cast(Isnull(JSON_VALUE(o.MemberData,'$."insCarrierId"'),0) as bigint) as InsuranceCarrierId
				,cast(Isnull(JSON_VALUE(o.MemberData,'$."insPlanId"'),0) as bigint) as HealthPlanId
				 ,cast(Isnull(JSON_VALUE(ProviderData,'$.address."locationId"'),0) as bigint) as ProviderLocationId
				,o.[MemberChartDataId]
				,cast((case when exists (select * from [Insurance].[InsuranceCarriers] c where (c.[IsContracted]=1 or c.[IsDiscountProgram]=1) and c.[InsuranceCarrierID]=cast(Isnull(JSON_VALUE(o.MemberData,'$."insCarrierId"'),0) as bigint)) then 0 else 1 end) as bit) as UsingNHDiscount
				from [provider].[MemberCharts] Me
				inner Join [provider].[MemberChartData] Mc On Mc.MemberChartId =Me.MemberChartId
				inner join [provider].[ProviderProfiles] pp on pp.[ProviderId]=Mc.[ProviderId] --and (@providerCode = '180000')-- or pp.[ProviderCode]=@providerCode)
				inner join  [Orders].[Orders] o on o.[MemberChartDataId] =Mc.MemberChartDataId
				left join [Orders].[Ordertransactiondetails] t on t.orderid = o.orderid and t.orderstatuscode='PO' and t.isactive=1 and t.iscomplete=1
				--left join(select orderid,iscomplete from [Orders].[OrderTransactionDetails] where IsActive=1  and OrderStatusCode='APQ' )u ON o.orderid =u.orderid
				where (ISJSON(o.MemberData) > 0) and (ISJSON(o.OrderAmountData) > 0) and (ISJSON(o.ProviderData) > 0) and pp.[ProviderCode]=@providerCode
				and O.OrderType IN ('NEW','LSND','LSandD', 'EXCHANGE') and NhMemberID = @nhMemberId
				group by  o.[OrderID],Me.MemberChartId,NhMemberID,o.DateOrderReceived,o.OrderStatusCode,
				[OrderType],OrderAmountData,ProviderData,o.MemberData,o.[MemberChartDataId],t.ordertransactiondata
				order by o.[OrderID] desc  

		END
		ELSE 
		BEGIN

				SELECT  distinct Me.MemberChartId as EngagementId
				,cast(o.DateOrderReceived as date) as OrderDate 
				,o.[OrderID] as OrderId
				,NhMemberID          
				,[OrderType] 
				,Convert(varchar(50),(select STRING_AGG(PONUMBER, ', ') 
				   from [Orders].[OrderPOs] where OrderId = o.OrderId Group by OrderId)) as PoNumber
		  ,(case t.ordertransactiondata when null then null else (select string_agg(convert(varchar, PODate, 110), ',') from (select PODate from openjson(t.ordertransactiondata) with (PODate date '$.poDate')) c) end) as PODATE
				 ,Convert(varchar(50),(SELECT CASE WHEN OrderStatusCode = 'INI'  THEN 'Initiated' WHEN  OrderStatusCode = 'REV'  THEN 'Order Submitted' WHEN OrderStatusCode = 'APP'  THEN 'Order Submitted' 
				 WHEN OrderStatusCode = 'PO' THEN 'Order Submitted' WHEN OrderStatusCode = 'ACK' THEN 'Order Submitted' WHEN OrderStatusCode = 'CAN' THEN 'Cancelled' 
				 WHEN OrderStatusCode = 'RET' THEN 'Returned' WHEN OrderStatusCode = 'REI' THEN 'Re-Initiated' WHEN OrderStatusCode = 'SHI' THEN 'Shipped' WHEN OrderStatusCode = 'DEL' THEN 'Delivered'
				 WHEN OrderStatusCode = 'PAY' THEN 'Payment' WHEN OrderStatusCode = 'CLM' THEN 'Delivered' WHEN OrderStatusCode = 'DOC' THEN 'Docs Submitted' WHEN OrderStatusCode = 'APQ' THEN 'Order Submitted' END FROM Orders.OrderStatusTypes WHERE OrderStatusCode = o.OrderStatusCode)) as OrderStatus
				,(select top 1 B.BrandName from orders.orderITems OT inner join [catalog].[Brands] B on B.BrandCode=OT.BrandCode where orderid = o.orderid  and B.Isactive =1) as BrandCode
				,(select top 1 ProductModelCode from orders.orderITems where orderid = o.orderid and itemtype='HA' ) as ModelCode
				,(select top 1 JSON_VALUE(OrderTransactionData,'$.approvedBy')
			  from Orders.OrderTransactionDetails where OrderId = o.OrderId and orderstatuscode='APP'  and isactive=1) as ApprovedBy
	  			,convert(Datetime,(select top 1 JSON_VALUE(OrderTransactionData,'$.approvedDate')
			  from Orders.OrderTransactionDetails where OrderId = o.OrderId and orderstatuscode='APP' and isactive=1)) as ApprovedDate
				,cast((select count(*) from orders.orderITems where orderid = o.orderid and itemtype = 'HA' and isactive=1 and status='active')as int) [HAItemsCount]
				,cast((select count(*) from orders.orderITems where orderid = o.orderid and itemtype = 'EM' and isactive=1 and status='active')as int) [EMItemsCount]
				,convert(decimal(10,2),Isnull(JSON_VALUE(OrderAmountData,'$.productPrice'),0)) as OrderPrice   
				,Convert(decimal(10,2),cast(JSON_VALUE(o.OrderAmountData,'$.memberResponsibility') as decimal(10,2))) as MemberResponsibility         
				,Convert(decimal(10,2), isnull((select top 1 JSON_VALUE(OrderTransactionData,'$.totalAmount')
			  from Orders.OrderTransactionDetails where OrderId = o.OrderId and orderstatuscode='PAY' and isactive=1), 0)) as AmountPaid
				,convert(decimal(10,2),isnull(JSON_VALUE(OrderAmountData, '$.memberResponsibility'),0))-
			   convert(decimal(10,2),isnull(JSON_VALUE(OrderAmountData, '$.appliedCredit.value'),0))-
			   Convert(decimal(10,2), isnull((select top 1 JSON_VALUE(OrderTransactionData,'$.totalAmount')
			   from Orders.OrderTransactionDetails where OrderId = o.OrderId and orderstatuscode='PAY' and isactive=1), 0)) + 
			  convert(decimal(10,2),isnull(JSON_VALUE(OrderAmountData, '$.refundDetails.refundedAmount') ,0)) 
			  + convert(decimal(10,2),isnull(cast(JSON_VALUE(OrderAmountData, '$.forwardCredits.creditForwarded') as decimal(10,2)),0)) as Balance 
			,cast(Isnull(JSON_VALUE(ProviderData,'$."providerId"'),0) as bigint) as ProviderId
				,cast(Isnull(JSON_VALUE(ProviderData,'$.address."locationId"'),0) as bigint) as locationId
				,cast(Isnull(JSON_VALUE(o.MemberData,'$."insCarrierId"'),0) as bigint) as InsuranceCarrierId
				,cast(Isnull(JSON_VALUE(o.MemberData,'$."insPlanId"'),0) as bigint) as HealthPlanId
				 ,cast(Isnull(JSON_VALUE(ProviderData,'$.address."locationId"'),0) as bigint) as ProviderLocationId
				,o.[MemberChartDataId]
				,cast((case when exists (select * from [Insurance].[InsuranceCarriers] c where (c.[IsContracted]=1 or c.[IsDiscountProgram]=1) and c.[InsuranceCarrierID]=cast(Isnull(JSON_VALUE(o.MemberData,'$."insCarrierId"'),0) as bigint)) then 0 else 1 end) as bit) as UsingNHDiscount
				from [provider].[MemberCharts] Me
				inner Join [provider].[MemberChartData] Mc On Mc.MemberChartId =Me.MemberChartId
				inner join [provider].[ProviderProfiles] pp on pp.[ProviderId]=Mc.[ProviderId] --and (@providerCode = '180000')-- or pp.[ProviderCode]=@providerCode)
				inner join  [Orders].[Orders] o on o.[MemberChartDataId] =Mc.MemberChartDataId		
				left join [Orders].[Ordertransactiondetails] t on t.orderid = o.orderid and t.orderstatuscode='PO' and t.isactive=1 and t.iscomplete=1
				where (ISJSON(o.MemberData) > 0) and (ISJSON(o.OrderAmountData) > 0) and (ISJSON(o.ProviderData) > 0) and pp.[ProviderCode]=@providerCode and Me.MemberChartId =@engagementId
				and O.OrderType In ('NEW','LSND','LSandD', 'EXCHANGE') and NhMemberID = @nhMemberId
				group by  o.[OrderID],Me.MemberChartId,NhMemberID,o.DateOrderReceived,o.OrderStatusCode,
				[OrderType],OrderAmountData,ProviderData,o.MemberData,o.[MemberChartDataId],t.ordertransactiondata
				order by o.[OrderID] desc  

			END	
END
END
CREATE PROCEDURE [provider].[GetOrderManagementPaymentDetails] 
(
  @nhMemberId [nvarchar](50),
  @providerCode [nvarchar](10),
  @engagementId [bigint]
)
AS
BEGIN
    -- SET NOCOUNT ON added to prevent extra result sets from
    -- interfering with SELECT statements.
    SET NOCOUNT ON
       declare @activeIns table (
              InsCarrierId bigint,
              InsPlanId bigint,
              MemberProfileId bigint
       );
       
       insert into @activeIns
       select top 1 i.InsuranceCarrierId, i.InsuranceHealthPlanId, p.MemberProfileId from [provider].[MemberInsurances] i
       inner join [provider].[MemberProfiles] p on p.MemberProfileId = i.MemberProfileId
       inner join [Insurance].[InsuranceCarriers] c on c.[InsuranceCarrierID]=i.[InsuranceCarrierID] and c.[IsDiscountProgram]=1
       where p.NHMemberId = @nhMemberId and p.IsActive=1 and i.IsActive=1 and
       i.UseForBenefits=1;
       
       if((select count(*) from @activeIns)=0)
              insert into @activeIns
              select top 1 i.InsuranceCarrierId, i.InsuranceHealthPlanId, p.MemberProfileId from [provider].[MemberInsurances] i
              inner join [provider].[MemberProfiles] p on p.MemberProfileId = i.MemberProfileId
              inner join [Insurance].[InsuranceCarriers] c on c.[InsuranceCarrierID]=i.[InsuranceCarrierID] and c.[IsDiscountProgram]=0
              where p.NHMemberId = @nhMemberId and p.IsActive=1 and i.IsActive=1 and
              i.[InsuranceEffectiveDate] <= getdate() and (i.[InsuranceEndDate] is null or i.[InsuranceEndDate] >= getdate())
              order by i.[MemberInsuranceID] desc;

       select convert(int,ROW_NUMBER() OVER(ORDER BY Ordernumber desc)) AS  RowID,*,'' as PaymentDate from 
       (
       SELECT   
        null as CoPayType
       ,o.[OrderID] as Ordernumber
       ,o.OrderType as OrderType
       ,NhMemberID
       ,Isnull(Convert(decimal(10,2),JSON_VALUE(o.OrderAmountData,'$.memberResponsibility')),0) as MemberResponsibility         
       ,Convert(decimal(10,2), isnull((select top 1 JSON_VALUE(OrderTransactionData,'$.totalAmount')
      from Orders.OrderTransactionDetails where OrderId = o.OrderId and orderstatuscode='PAY' and isactive=1), 0)) as AmountPaid
       ,convert(decimal(10,2),isnull(JSON_VALUE(OrderAmountData, '$.memberResponsibility'),0))-
          convert(decimal(10,2),isnull(JSON_VALUE(OrderAmountData, '$.appliedCredit.value'),0))-
          Convert(decimal(10,2), isnull((select top 1 JSON_VALUE(OrderTransactionData,'$.totalAmount')
      from Orders.OrderTransactionDetails where OrderId = o.OrderId and orderstatuscode='PAY' and isactive=1), 0)) + 
        convert(decimal(10,2),isnull(JSON_VALUE(OrderAmountData, '$.refundDetails.refundedAmount') ,0)) 
        + convert(decimal(10,2),isnull(JSON_VALUE(OrderAmountData, '$.forwardCredits.creditForwarded'),0)) as Balance
       ,0 as HPCId
       ,Cast((case when Exists(select * from [Orders].[OrderTransactionDetails] where orderid = o.OrderId
        and Iscomplete=1 and  OrderStatusCode='PAY') then 1 else 0 end) as bit) as PayComplete
       ,Convert(varchar(50),(select STRING_AGG(PONUMBER, ', ') from [Orders].[OrderPOs] where OrderId = o.OrderId Group by OrderId)) as PoNumber
       ,(case t.ordertransactiondata when null then null else (select string_agg(convert(varchar, PODate, 110), ',') from (select PODate from openjson(t.ordertransactiondata) with (PODate date '$.poDate')) c) end) as PODATE
       ,(select top 1 B.BrandName from orders.orderITems OT inner join [catalog].[Brands] B on B.BrandCode=OT.BrandCode where orderid = o.orderid  and B.Isactive =1) as BrandCode
       ,cast(Isnull(JSON_VALUE(ProviderData,'$."providerId"'),0) as bigint) as ProviderId
    ,cast(Isnull(JSON_VALUE(ProviderData,'$.address."locationId"'),0) as bigint) as locationId
    ,cast(Isnull(JSON_VALUE(o.MemberData,'$."insCarrierId"'),0) as bigint) as InsuranceCarrierId
    ,cast(Isnull(JSON_VALUE(o.MemberData,'$."insPlanId"'),0) as bigint) as HealthPlanId
       ,cast(Isnull(JSON_VALUE(ProviderData,'$.address."locationId"'),0) as bigint) as ProviderLocationId
       ,o.[MemberChartDataId]
       ,Me.MemberChartId
	   ,cast((SELECT top 1 [IsAutoSendPaymentReceipt] FROM  [Insurance].[InsuranceCarriers] WHERE [InsuranceCarrierID] = Isnull(JSON_VALUE(o.MemberData,'$."insCarrierId"'),0) )as bit) as IsAutoSendPaymentReceipt
       from [provider].[MemberCharts] Me
       inner Join [provider].[MemberChartData] Mc On Mc.MemberChartId =Me.MemberChartId
       inner join [provider].[ProviderProfiles] pp on pp.[ProviderId]=Mc.[ProviderId] and (@providerCode='180000' or @providerCode=pp.[ProviderCode])
       inner join  [Orders].[Orders] o on o.[MemberChartDataId] =Mc.MemberChartDataId
       left join [Orders].[Ordertransactiondetails] t on t.orderid = o.orderid and t.orderstatuscode='PO' and t.isactive=1 and t.iscomplete=1
       where (ISJSON(o.MemberData) > 0) and (ISJSON(o.OrderAmountData) > 0) and (ISJSON(o.ProviderData) > 0) 
       and (@engagementId=0 or Me.MemberChartId = @engagementId)--19555 
       --and O.[Status]='ACTIVE'
       and O.OrderType IN ('NEW','EXCHANGE','LSND', 'LSandD') and O.IsActive=1 and NhMemberID = @nhMemberId--'NH201800573858'
       --order by OrderId desc 
       Union All   
       select 'FITTING'
       ,o.OrderId
       ,o.OrderType
       ,NHMemberid
       ,Isnull(Convert(decimal(10,2),cb.FittingCoPay)*(select count(*) from orders.orderitems where orderid=o.orderid and isactive=1 and itemtype='ha' and status='active'),0)
       ,0 as AmountPaid
       ,Isnull(Convert(decimal(10,2),cb.FittingCoPay)*(select count(*) from orders.orderitems where orderid=o.orderid and isactive=1 and itemtype='ha' and status='active'),0)
       ,hp.[HealthPlanContractID] as HPCId
       ,cast(0 as bit)
       ,Convert(varchar(50),(select STRING_AGG(PONUMBER, ', ') from [Orders].[OrderPOs] where OrderId = o.OrderId Group by OrderId)) as PoNumber
       ,(case t.ordertransactiondata when null then null else (select string_agg(convert(varchar, PODate, 110), ',') from (select PODate from openjson(t.ordertransactiondata) with (PODate date '$.poDate')) c) end) as PODATE
       ,(select top 1 B.BrandName from orders.orderITems OT inner join [catalog].[Brands] B on B.BrandCode=OT.BrandCode where orderid = o.orderid  and B.Isactive =1) as BrandCode
       ,cast(Isnull(JSON_VALUE(ProviderData,'$."providerId"'),0) as bigint) as ProviderId
    ,cast(Isnull(JSON_VALUE(ProviderData,'$.address."locationId"'),0) as bigint) as locationId
    ,cast(Isnull(JSON_VALUE(o.MemberData,'$."insCarrierId"'),0) as bigint) as InsuranceCarrierId
    ,cast(Isnull(JSON_VALUE(o.MemberData,'$."insPlanId"'),0) as bigint) as HealthPlanId
       ,cast(Isnull(JSON_VALUE(ProviderData,'$.address."locationId"'),0) as bigint) as ProviderLocationId
       ,o.[MemberChartDataId]
       ,Me.MemberChartId
	   ,cast((SELECT top 1 [IsAutoSendPaymentReceipt] FROM  [Insurance].[InsuranceCarriers] WHERE [InsuranceCarrierID] = Isnull(JSON_VALUE(o.MemberData,'$."insCarrierId"'),0))as bit) as IsAutoSendPaymentReceipt
       from [provider].[MemberCharts] Me
       inner Join [provider].[MemberChartData] Mc On Mc.MemberChartId =Me.MemberChartId
              inner join [provider].[ProviderProfiles] pp on pp.[ProviderId]=Mc.[ProviderId] and (@providerCode='180000' or @providerCode=pp.[ProviderCode])
       inner join  [Orders].[Orders] o on o.[MemberChartDataId] =Mc.MemberChartDataId
       left join [Orders].[Ordertransactiondetails] t on t.orderid = o.orderid and t.orderstatuscode='PO' and t.isactive=1 and t.iscomplete=1
       left join [Insurance].[HealthPlanContracts] hp
       on JSON_VALUE(MemberData, '$.insCarrierId')=hp.[InsuranceCarrierID] and JSON_VALUE(MemberData, '$.insCarrierId') = hp.[InsuranceHealthPlanID] and hp.IsActive=1
       left join [Insurance].[ContractBenefits] cb
       on cb.[HealthPlanContractID] = hp.[HealthPlanContractID] and cb.isActive=1
       where (ISJSON(o.MemberData) > 0) and (ISJSON(o.OrderAmountData) > 0) and (ISJSON(o.ProviderData) > 0) 
       and (@engagementId=0 or Me.MemberChartId = @engagementId)--19555
       and O.OrderType IN ('NEW','EXCHANGE','LSND', 'LSandD') and O.IsActive=1 and NhMemberID = @nhMemberId--'NH201800573858'

       Union all
       select 'DEVICE' as PaymentType
       ,OrderId
       ,o.OrderType
       ,NHMemberid
       ,Isnull(Convert(decimal(10,2),cb.HearingAidCoPay)*(select count(*) from orders.orderitems where orderid=o.orderid and isactive=1 and itemtype='ha' and status='active'),0)
       ,0 as AmountPaid
       ,Isnull(Convert(decimal(10,2),cb.HearingAidCoPay)*(select count(*) from orders.orderitems where orderid=o.orderid and isactive=1 and itemtype='ha' and status='active'),0)
       ,hp.[HealthPlanContractID] as HPCId
       ,cast(0 as bit) 
       ,'',''
       ,''
       ,''
              ,''
              ,''
              ,''
       ,''
       ,Mc.MemberChartDataId
       ,Me.MemberChartId
	   ,cast(0 as bit)
       from [provider].[MemberCharts] Me
       inner Join [provider].[MemberChartData] Mc On Mc.MemberChartId =Me.MemberChartId
       inner join [provider].[ProviderProfiles] pp on pp.[ProviderId]=Mc.[ProviderId] and (@providerCode='180000' or @providerCode=pp.[ProviderCode])
       inner join  [Orders].[Orders] o on o.[MemberChartDataId] =Mc.MemberChartDataId
       left join [Insurance].[HealthPlanContracts] hp
       on JSON_VALUE(MemberData, '$.insCarrierId')=hp.[InsuranceCarrierID] and JSON_VALUE(MemberData, '$.insPlanId') = hp.[InsuranceHealthPlanID] and hp.IsActive=1
       left join [Insurance].[ContractBenefits] cb
       on cb.[HealthPlanContractID] = hp.[HealthPlanContractID] and cb.isActive=1
       where (ISJSON(o.MemberData) > 0) and (ISJSON(o.OrderAmountData) > 0) and (ISJSON(o.ProviderData) > 0) 
       and (@engagementId=0 or Me.MemberChartId = @engagementId)--19555
       and O.OrderType IN ('NEW','EXCHANGE','LSND', 'LSandD') and O.IsActive=1 and NhMemberID = @nhMemberId--'NH201800573858'
       Union All
       
       select 
              'TESTING'
              ,null
              ,null
              ,NhMemberID
              ,Isnull(Convert(decimal(10,2),cb.HearingExamCoPay),0)
              ,0 as AmountPaid
              ,Isnull(Convert(decimal(10,2),cb.HearingExamCoPay),0)
              ,Isnull(hp.[HealthPlanContractID],0) as HPCId
              ,cast(0 as bit)
              ,'' as PoNumber
              ,'' as PODATE
              ,''
              ,Mc.[ProviderId]
              ,Mc.LocationId
              ,Isnull(hp.[InsuranceCarrierID],0)
              ,Isnull(hp.[InsuranceHealthPlanID],0)
              ,Mc.LocationId
              ,Mc.MemberChartDataId
              ,Me.MemberChartId
			  ,cast((SELECT top 1 [IsAutoSendPaymentReceipt] FROM  [Insurance].[InsuranceCarriers] WHERE [InsuranceCarrierID] = Isnull(hp.[InsuranceCarrierID],0))as bit) as IsAutoSendPaymentReceipt
       from [provider].[MemberAppointments] ap
       inner join [provider].[AppointmentTypes] apt On apt.AppointmentTypeId=ap.AppointmentTypeId
       inner join [provider].[MemberChartData] Mc on MC.MemberChartDataId=ap.MemberChartDataId 
       inner join [provider].[MemberCharts] Me On Me.MemberChartId =Mc.MemberChartId
       inner join [provider].[MemberProfiles] Mp on Mp.MemberProfileId=Me.MemberProfileId
       inner join @activeIns a on a.MemberProfileId = Mp.MemberProfileId
       inner join [provider].[ProviderProfiles] pp on pp.[ProviderId]=Mc.[ProviderId] and (@providerCode='180000' or @providerCode=pp.[ProviderCode])
       left join [Insurance].[HealthPlanContracts] hp
       on a.InsCarrierId=hp.[InsuranceCarrierID] and a.InsPlanId = hp.[InsuranceHealthPlanID] and hp.IsActive=1
       left join [Insurance].[ContractBenefits] cb
       on cb.[HealthPlanContractID] = hp.[HealthPlanContractID] and cb.isActive=1
       where (@engagementId=0 or Me.MemberChartId = @engagementId)--19555
       and Mp.NhMemberID = @nhMemberId--'NH201800573858'
    and Mc.Isactive=1 and ap.Isactive=1 and apt.isactive=1 and apt.AppointmentTypeName='Testing' 

       )Od  --where  (Od.MemberResponsibility>0 and Od.CoPayType !=null)
END

--EXEC [provider].[GetPendingApprovalOrders] 'APQ', '180010'
CREATE PROCEDURE  [provider].[GetPendingApprovalOrders]
@orderStatusCode Varchar(5),
@providercode varchar(10)

AS
BEGIN
-- Get Penging approval orders
IF(@providercode='180000')
BEGIN
-- Get Pending Approval orders
if(@orderStatusCode='APQ')
BEGIN
		select  distinct TOP 100
	     PP.ProviderCode
		,JSON_VALUE(o.MemberData, '$.firstName') MemberFirstName
		,JSON_VALUE(o.MemberData, '$.lastName') MemberLastName
		,cast(isnull(JSON_VALUE(o.ProviderData, '$.providerId'),0) as bigint) ProviderId
		,cast(isnull(JSON_VALUE(o.ProviderData, '$.address.locationId'),0) as bigint) LocationId
		,JSON_VALUE(o.ProviderData, '$.dba') LocationName
		,o.MemberChartDataId 
		,(select top 1 it.BrandCode from Orders.OrderItems it where it.orderid=o.orderid) BrandCode
		,case WHEN (ISJSON(o.MemberData) > 0) THEN 
		 cast(isnull(JSON_VALUE(o.MemberData, '$.insCarrierId'),0) as bigint) 
		 ELSE 0 END InsuranceCarrierId
		,case WHEN (ISJSON(o.MemberData) > 0) THEN 
		 cast(isnull(JSON_VALUE(o.MemberData, '$.insPlanId'),0) as bigint) 
		 ELSE 0 END HealthPlanId
		,o.NHMemberId
		,o.OrderId
		,o.DateOrderReceived as OrderDate
		,o.OrderType
		,o.OrderStatusCode
		,ty.[OrderStatusName] as OrderStatus
		,MC.MemberChartId
		,JSON_VALUE(o.ProviderData, '$.address.address1') Address1
		,JSON_VALUE(o.ProviderData, '$.address.address2') Address2
		,JSON_VALUE(o.ProviderData, '$.address.city') City
		,JSON_VALUE(o.ProviderData, '$.address.state') State
		,JSON_VALUE(o.ProviderData, '$.address.zip') Zip
		,JSON_VALUE(o.ProviderData, '$.address.country') Country
		,JSON_VALUE(o.ProviderData, '$.hcp.firstName')+' '+JSON_VALUE(o.ProviderData, '$.hcp.lastName') as HCPName
		,cast((case when exists (select * from [Orders].[OrderTransactionDetails] where (OrderStatusCode='APQ' OR OrderStatusCode='APP' OR OrderStatusCode='CAN')  and orderid=o.orderid) then 1 else 0 end)as bit )  AS SubmittedForApproval
		,cast((select top 1 cast((case when [OrderTransactionID] is null then null else (case  when iscomplete=1 then 1 else 0 end) end ) as bit) from [Orders].[OrderTransactionDetails] where OrderStatusCode='DOC' and orderid=o.orderid) as bit ) AS IsDocComplete
		,cast((case when exists (select * from [Orders].[OrderTransactionDetails] where (OrderStatusCode='APP' OR OrderStatusCode='RET' OR OrderStatusCode='CAN' )  and orderid=o.orderid) then 1 else 0 end)as bit )   AS IsApproved
	   ,Convert(varchar(50),(select STRING_AGG(PONUMBER, ', ') from [Orders].[OrderPOs] where OrderId = o.OrderId Group by OrderId)) as PoNumber
	   , case when t.OrderStatusCode='PO' then  (case t.ordertransactiondata when null then null else (select string_agg(convert(varchar, PODate, 110), ',') 
	      from (select PODate from openjson(t.ordertransactiondata) with (PODate date '$.poDate')) c) end)end as PODATE
		from orders.orders o 
		inner join [provider].[ProviderProfiles] PP on cast(JSON_VALUE(o.ProviderData, '$.providerId') as bigint)=PP.ProviderId
		inner join [Orders].[OrderStatusTypes] ty on ty.[OrderStatusCode]=o.[OrderStatusCode]
		left join(select * from [Orders].[OrderTransactionDetails] where IsActive=1  and OrderStatusCode ='PO') t ON o.orderid =t.orderid
		left join [provider].[MemberChartData] MD on MD.MemberChartDataId=O.MemberChartDataId and MD.Isactive=1
		join [provider].[MemberCharts] MC on MC.MemberChartId=MD.MemberChartId and MD.Isactive=1
		where O.Isactive=1  and O.OrderType IN ('NEW','LSND','LSandD', 'EXCHANGE')
	   and (select count(*) from Orders.OrderTransactionDetails  where OrderId = o.orderid and orderstatuscode in('APQ')  and isactive=1)>0
	   and (select count(*) from Orders.OrderTransactionDetails  where OrderId = o.orderid and (orderstatuscode ='APP' or orderstatuscode = 'CAN')  and isactive=1)=0
	   order by o.orderid asc
end
-- Order Approved 
if(@orderStatusCode='APP')
BEGIN
		select  distinct 
	     PP.ProviderCode
		,JSON_VALUE(o.MemberData, '$.firstName') MemberFirstName
		,JSON_VALUE(o.MemberData, '$.lastName') MemberLastName
		,cast(isnull(JSON_VALUE(o.ProviderData, '$.providerId'),0) as bigint) ProviderId
		,cast(isnull(JSON_VALUE(o.ProviderData, '$.address.locationId'),0) as bigint) LocationId
		,JSON_VALUE(o.ProviderData, '$.dba') LocationName
		,o.MemberChartDataId 
		,(select top 1 it.BrandCode from Orders.OrderItems it where it.orderid=o.orderid) BrandCode
		,case WHEN (ISJSON(o.MemberData) > 0) THEN 
		 cast(isnull(JSON_VALUE(o.MemberData, '$.insCarrierId'),0) as bigint) 
		 ELSE 0 END InsuranceCarrierId
		,case WHEN (ISJSON(o.MemberData) > 0) THEN 
		 cast(isnull(JSON_VALUE(o.MemberData, '$.insPlanId'),0) as bigint) 
		 ELSE 0 END HealthPlanId
		,o.NHMemberId
		,o.OrderId
		,o.DateOrderReceived as OrderDate
		,o.OrderType
		,o.OrderStatusCode
		,ty.[OrderStatusName] as OrderStatus
		,MC.MemberChartId
		,JSON_VALUE(o.ProviderData, '$.address.address1') Address1
		,JSON_VALUE(o.ProviderData, '$.address.address2') Address2
		,JSON_VALUE(o.ProviderData, '$.address.city') City
		,JSON_VALUE(o.ProviderData, '$.address.state') State
		,JSON_VALUE(o.ProviderData, '$.address.zip') Zip
		,JSON_VALUE(o.ProviderData, '$.address.country') Country
		,JSON_VALUE(o.ProviderData, '$.hcp.firstName')+' '+JSON_VALUE(o.ProviderData, '$.hcp.lastName') as HCPName
		,cast((case when exists (select * from [Orders].[OrderTransactionDetails] where (OrderStatusCode='APQ' OR OrderStatusCode='APP' OR OrderStatusCode='CAN')  and orderid=o.orderid) then 1 else 0 end)as bit )  AS SubmittedForApproval
		,cast((select top 1 cast((case when [OrderTransactionID] is null then null else (case  when iscomplete=1 then 1 else 0 end) end ) as bit) from [Orders].[OrderTransactionDetails] where OrderStatusCode='DOC' and orderid=o.orderid) as bit ) AS IsDocComplete
		,cast((case when exists (select * from [Orders].[OrderTransactionDetails] where (OrderStatusCode='APP' OR OrderStatusCode='RET' OR OrderStatusCode='CAN' )  and orderid=o.orderid) then 1 else 0 end)as bit )   AS IsApproved
	   ,Convert(varchar(50),(select STRING_AGG(PONUMBER, ', ') from [Orders].[OrderPOs] where OrderId = o.OrderId Group by OrderId)) as PoNumber
	   , case when t.OrderStatusCode='PO' then  (case t.ordertransactiondata when null then null else (select string_agg(convert(varchar, PODate, 110), ',') 
	      from (select PODate from openjson(t.ordertransactiondata) with (PODate date '$.poDate')) c) end)end as PODATE
		from orders.orders o 
		inner join [provider].[ProviderProfiles] PP on cast(JSON_VALUE(o.ProviderData, '$.providerId') as bigint)=PP.ProviderId
		inner join [Orders].[OrderStatusTypes] ty on ty.[OrderStatusCode]=o.[OrderStatusCode]
		left join(select * from [Orders].[OrderTransactionDetails] where IsActive=1  and OrderStatusCode ='PO') t ON o.orderid =t.orderid
		left join [provider].[MemberChartData] MD on MD.MemberChartDataId=O.MemberChartDataId and MD.Isactive=1
		join [provider].[MemberCharts] MC on MC.MemberChartId=MD.MemberChartId and MD.Isactive=1
		where O.Isactive=1  and O.OrderType IN ('NEW','LSND','LSandD', 'EXCHANGE')
	   and (select count(*) from Orders.OrderTransactionDetails  where OrderId = o.orderid and orderstatuscode in('APP')  and isactive=1)>0
	   order by o.orderid desc
end 
-- Document Pending
if(@orderStatusCode='DOC')
BEGIN
		select  distinct
	     PP.ProviderCode
		,JSON_VALUE(o.MemberData, '$.firstName') MemberFirstName
		,JSON_VALUE(o.MemberData, '$.lastName') MemberLastName
		,cast(isnull(JSON_VALUE(o.ProviderData, '$.providerId'),0) as bigint) ProviderId
		,cast(isnull(JSON_VALUE(o.ProviderData, '$.address.locationId'),0) as bigint) LocationId
		,JSON_VALUE(o.ProviderData, '$.dba') LocationName
		,o.MemberChartDataId 
		,(select top 1 it.BrandCode from Orders.OrderItems it where it.orderid=o.orderid) BrandCode
		,case WHEN (ISJSON(o.MemberData) > 0) THEN 
		 cast(isnull(JSON_VALUE(o.MemberData, '$.insCarrierId'),0) as bigint) 
		 ELSE 0 END InsuranceCarrierId
		,case WHEN (ISJSON(o.MemberData) > 0) THEN 
		 cast(isnull(JSON_VALUE(o.MemberData, '$.insPlanId'),0) as bigint) 
		 ELSE 0 END HealthPlanId
		,o.NHMemberId
		,o.OrderId
		,o.DateOrderReceived as OrderDate
		,o.OrderType
		,o.OrderStatusCode
		,ty.[OrderStatusName] as OrderStatus
		,MC.MemberChartId
		,JSON_VALUE(o.ProviderData, '$.address.address1') Address1
		,JSON_VALUE(o.ProviderData, '$.address.address2') Address2
		,JSON_VALUE(o.ProviderData, '$.address.city') City
		,JSON_VALUE(o.ProviderData, '$.address.state') State
		,JSON_VALUE(o.ProviderData, '$.address.zip') Zip
		,JSON_VALUE(o.ProviderData, '$.address.country') Country
		,JSON_VALUE(o.ProviderData, '$.hcp.firstName')+' '+JSON_VALUE(o.ProviderData, '$.hcp.lastName') as HCPName
		,cast((case when exists (select * from [Orders].[OrderTransactionDetails] where (OrderStatusCode='APQ' OR OrderStatusCode='APP' OR OrderStatusCode='CAN')  and orderid=o.orderid) then 1 else 0 end)as bit )  AS SubmittedForApproval
		,cast((select top 1 cast((case when [OrderTransactionID] is null then null else (case  when iscomplete=1 then 1 else 0 end) end ) as bit) from [Orders].[OrderTransactionDetails] where OrderStatusCode='DOC' and orderid=o.orderid) as bit ) AS IsDocComplete
		,cast((case when exists (select * from [Orders].[OrderTransactionDetails] where (OrderStatusCode='APP' OR OrderStatusCode='RET' OR OrderStatusCode='CAN' )  and orderid=o.orderid) then 1 else 0 end)as bit )   AS IsApproved
	   ,Convert(varchar(50),(select STRING_AGG(PONUMBER, ', ') from [Orders].[OrderPOs] where OrderId = o.OrderId Group by OrderId)) as PoNumber
	   , case when t.OrderStatusCode='PO' then  (case t.ordertransactiondata when null then null else (select string_agg(convert(varchar, PODate, 110), ',') 
	      from (select PODate from openjson(t.ordertransactiondata) with (PODate date '$.poDate')) c) end)end as PODATE
		from orders.orders o 
		inner join [provider].[ProviderProfiles] PP on cast(JSON_VALUE(o.ProviderData, '$.providerId') as bigint)=PP.ProviderId
		inner join [Orders].[OrderStatusTypes] ty on ty.[OrderStatusCode]=o.[OrderStatusCode]
		left join(select * from [Orders].[OrderTransactionDetails] where IsActive=1  and OrderStatusCode ='PO') t ON o.orderid =t.orderid
		left join [provider].[MemberChartData] MD on MD.MemberChartDataId=O.MemberChartDataId and MD.Isactive=1
		join [provider].[MemberCharts] MC on MC.MemberChartId=MD.MemberChartId and MD.Isactive=1
		where O.Isactive=1  and O.OrderType IN ('NEW','LSND','LSandD', 'EXCHANGE')
	   --and (select count(*) from Orders.OrderTransactionDetails  where OrderId = o.orderid and orderstatuscode in('DOC')  and isactive=1 and iscomplete=0)>0
	   and Not exists(select * from Orders.OrderTransactionDetails  where OrderId = o.orderid and orderstatuscode in('DOC','CAN')and isactive=1 and iscomplete=1)
	   order by o.orderid desc
end
-- Get All records
if(@orderStatusCode='ALL')
BEGIN
		select  distinct
	     PP.ProviderCode
		,JSON_VALUE(o.MemberData, '$.firstName') MemberFirstName
		,JSON_VALUE(o.MemberData, '$.lastName') MemberLastName
		,cast(isnull(JSON_VALUE(o.ProviderData, '$.providerId'),0) as bigint) ProviderId
		,cast(isnull(JSON_VALUE(o.ProviderData, '$.address.locationId'),0) as bigint) LocationId
		,JSON_VALUE(o.ProviderData, '$.dba') LocationName
		,o.MemberChartDataId 
		,(select top 1 it.BrandCode from Orders.OrderItems it where it.orderid=o.orderid) BrandCode
		,case WHEN (ISJSON(o.MemberData) > 0) THEN 
		 cast(isnull(JSON_VALUE(o.MemberData, '$.insCarrierId'),0) as bigint) 
		 ELSE 0 END InsuranceCarrierId
		,case WHEN (ISJSON(o.MemberData) > 0) THEN 
		 cast(isnull(JSON_VALUE(o.MemberData, '$.insPlanId'),0) as bigint) 
		 ELSE 0 END HealthPlanId
		,o.NHMemberId
		,o.OrderId
		,o.DateOrderReceived as OrderDate
		,o.OrderType
		,o.OrderStatusCode
		,ty.[OrderStatusName] as OrderStatus
		,MC.MemberChartId
		,JSON_VALUE(o.ProviderData, '$.address.address1') Address1
		,JSON_VALUE(o.ProviderData, '$.address.address2') Address2
		,JSON_VALUE(o.ProviderData, '$.address.city') City
		,JSON_VALUE(o.ProviderData, '$.address.state') State
		,JSON_VALUE(o.ProviderData, '$.address.zip') Zip
		,JSON_VALUE(o.ProviderData, '$.address.country') Country
		,JSON_VALUE(o.ProviderData, '$.hcp.firstName')+' '+JSON_VALUE(o.ProviderData, '$.hcp.lastName') as HCPName
		,cast((case when exists (select * from [Orders].[OrderTransactionDetails] where (OrderStatusCode='APQ' OR OrderStatusCode='APP' OR OrderStatusCode='CAN')  and orderid=o.orderid) then 1 else 0 end)as bit )  AS SubmittedForApproval
		,cast((select top 1 cast((case when [OrderTransactionID] is null then null else (case  when iscomplete=1 then 1 else 0 end) end ) as bit) from [Orders].[OrderTransactionDetails] where OrderStatusCode='DOC' and orderid=o.orderid) as bit ) AS IsDocComplete
		,cast((case when exists (select * from [Orders].[OrderTransactionDetails] where (OrderStatusCode='APP' OR OrderStatusCode='RET' OR OrderStatusCode='CAN' )  and orderid=o.orderid) then 1 else 0 end)as bit )   AS IsApproved
	   ,Convert(varchar(50),(select STRING_AGG(PONUMBER, ', ') from [Orders].[OrderPOs] where OrderId = o.OrderId Group by OrderId)) as PoNumber
	   , case when t.OrderStatusCode='PO' then  (case t.ordertransactiondata when null then null else (select string_agg(convert(varchar, PODate, 110), ',') 
	      from (select PODate from openjson(t.ordertransactiondata) with (PODate date '$.poDate')) c) end)end as PODATE
		from orders.orders o 
		inner join [provider].[ProviderProfiles] PP on cast(JSON_VALUE(o.ProviderData, '$.providerId') as bigint)=PP.ProviderId
		inner join [Orders].[OrderStatusTypes] ty on ty.[OrderStatusCode]=o.[OrderStatusCode]
		left join(select * from [Orders].[OrderTransactionDetails] where IsActive=1  and OrderStatusCode ='PO') t ON o.orderid =t.orderid
		left join [provider].[MemberChartData] MD on MD.MemberChartDataId=O.MemberChartDataId and MD.Isactive=1
		join [provider].[MemberCharts] MC on MC.MemberChartId=MD.MemberChartId and MD.Isactive=1
		where O.Isactive=1  and O.OrderType IN ('NEW','LSND','LSandD', 'EXCHANGE')
	   and (select count(*) from Orders.OrderTransactionDetails  where OrderId = o.orderid and orderstatuscode in ('PAY')  and isactive=1 and iscomplete=1 )>0
	   order by o.orderid desc
end
END
ELSE 
BEGIN
			select 
		PP.ProviderCode
		,JSON_VALUE(o.MemberData, '$.firstName') MemberFirstName
		,JSON_VALUE(o.MemberData, '$.lastName') MemberLastName
		,cast(isnull(JSON_VALUE(o.ProviderData, '$.providerId'),0) as bigint) ProviderId
		,cast(isnull(JSON_VALUE(o.ProviderData, '$.address.locationId'),0) as bigint) LocationId
		,JSON_VALUE(o.ProviderData, '$.dba') LocationName
		,o.MemberChartDataId MemberChartDataId
		,(select top 1 it.BrandCode from Orders.OrderItems it where it.orderid=o.orderid) BrandCode
		,cast(isnull(JSON_VALUE(o.MemberData, '$.insCarrierId'),0) as bigint) InsuranceCarrierId
		,cast(isnull(JSON_VALUE(o.MemberData, '$.insPlanId'),0) as bigint) HealthPlanId
		,o.NHMemberId
		,o.OrderId
		,o.DateOrderReceived as OrderDate
		,o.OrderType
		,o.OrderStatusCode
		,CASE WHEN ty.OrderStatusCode = 'INI'  THEN 'Initiated' WHEN  ty.OrderStatusCode = 'REV'  THEN 'Order Submitted' WHEN ty.OrderStatusCode = 'APP'  THEN 'Order Submitted' 
		 WHEN ty.OrderStatusCode = 'PO' THEN 'Order Submitted' WHEN ty.OrderStatusCode = 'ACK' THEN 'Order Submitted' WHEN ty.OrderStatusCode = 'CAN' THEN 'Cancelled' 
		 WHEN ty.OrderStatusCode = 'RET' THEN 'Returned' WHEN ty.OrderStatusCode = 'REI' THEN 'Re-Initiated' WHEN ty.OrderStatusCode = 'SHI' THEN 'Shipped' WHEN ty.OrderStatusCode = 'DEL' THEN 'Delivered'
		 WHEN ty.OrderStatusCode = 'PAY' THEN 'Payment' WHEN ty.OrderStatusCode = 'CLM' THEN 'Delivered' WHEN ty.OrderStatusCode = 'DOC' THEN 'Docs Submitted' WHEN ty.OrderStatusCode = 'APQ' THEN 'Order Submitted' END AS OrderStatus
		,MC.MemberChartId
		,JSON_VALUE(o.ProviderData, '$.address.address1') Address1
		,JSON_VALUE(o.ProviderData, '$.address.address2') Address2
		,JSON_VALUE(o.ProviderData, '$.address.city') City
		,JSON_VALUE(o.ProviderData, '$.address.state') State
		,JSON_VALUE(o.ProviderData, '$.address.zip') Zip
		,JSON_VALUE(o.ProviderData, '$.address.country') Country
		,JSON_VALUE(o.ProviderData, '$.hcp.firstName')+' '+JSON_VALUE(o.ProviderData, '$.hcp.lastName') as HCPName
		,cast((case when exists (select * from [Orders].[OrderTransactionDetails] where (OrderStatusCode='APQ' OR OrderStatusCode='APP' OR OrderStatusCode='CAN')  and orderid=o.orderid) then 1 else 0 end)as bit )  AS SubmittedForApproval
		,cast((select top 1 cast((case when [OrderTransactionID] is null then null else (case  when iscomplete=1 then 1 else 0 end) end ) as bit) from [Orders].[OrderTransactionDetails] where OrderStatusCode='DOC' and orderid=o.orderid) as bit ) AS IsDocComplete
		,cast((case when exists (select * from [Orders].[OrderTransactionDetails] where (OrderStatusCode='APP' OR OrderStatusCode='RET' OR OrderStatusCode='CAN' )  and orderid=o.orderid) then 1 else 0 end)as bit )   AS IsApproved
		,Convert(varchar(50),(select STRING_AGG(PONUMBER, ', ') from [Orders].[OrderPOs] where OrderId = o.OrderId Group by OrderId)) as PoNumber
		,(case t1.ordertransactiondata when null then null else (select string_agg(convert(varchar, PODate, 110), ',') from (select PODate from openjson(t1.ordertransactiondata) with (PODate date '$.poDate')) c) end) as PODATE
		from orders.orders o 
		inner join [provider].[ProviderProfiles] PP
		on cast(JSON_VALUE(o.ProviderData, '$.providerId') as bigint)=PP.ProviderId
		inner join [Orders].[OrderStatusTypes] ty on ty.[OrderStatusCode]=o.[OrderStatusCode]
		left join [Orders].[Ordertransactiondetails] t1 on t1.orderid = o.orderid and t1.orderstatuscode='PO' and t1.isactive=1 and t1.iscomplete=1
		left join [provider].[MemberChartData] MD on MD.MemberChartDataId=O.MemberChartDataId and pp.[ProviderId]=MD.[ProviderId] and MD.Isactive=1
		join [provider].[MemberCharts] MC on MC.MemberChartId=MD.MemberChartId and MD.Isactive=1
		where
		O.OrderType IN ('NEW','LSND','LSandD', 'EXCHANGE')
		and O.Isactive=1 
		and PP.providerCode=@providercode
		order by orderid desc
		END

END

CREATE Procedure [provider].[GetMemberAppointmentHistoryUpdates]
@memberProfileId [bigint]

AS
BEGIN
    /*
Author: Sunnetha 
Description : change BusinessName to alias as ProviderName  13-11-18
CHANGES : UTC Formats removed 10-04-2019
*/
SET NOCOUNT ON

-- declare @memberProfileId INT=24

   select ROW_NUMBER() OVER (ORDER BY c.MemberAppointmentId) as 'RowID',*from (Select  
          --ma.Hist_ID,
          mc.MemberProfileId,
          ma.MemberAppointmentId,
          mcd.LocationId,
          t.AppointmentTypeName,
----OLD 
          --CONVERT(datetime, ma.[StartDate] AT TIME ZONE 'UTC' AT TIME ZONE l.[TimeZone]) [StartDate],
          --CONVERT(datetime, ma.[StartTime]AT TIME ZONE 'UTC' AT TIME ZONE l.[TimeZone]) [StartTime],
---Changes 10-04-2019
		  ma.[StartDate] StartDate,
		  ma.[StartTime] StartTime,
          l.BusinessName as ProviderName,
          up.FirstName ,
          up.LastName,
          ma.Confirmed,
          ma.AppointmentStatus,
          a.CancelReason,                                             
          l.Address1,
          l.Address2,
          l.City ,
          l.State,
          l.Zip,
          ma.ModifyDate,
          ma.WalkIn,
          ma.MissingDate,
		  mcd.ProviderId,
          CASE WHEN l.TimeZone ='Mountain Standard Time' THEN 'MST' WHEN l.TimeZone ='Hawaiian Standard Time' THEN 'HST' 
          WHEN l.TimeZone = 'Pacific Standard Time' THEN 'PST' WHEN l.TimeZone = 'Central Standard Time' 
          THEN 'CST' WHEN l.TimeZone = 'Eastern Standard Time' THEN 'EST' END AS TimeZone                                                                         
          FROM [provider].[MemberAppointments_History] ma
                 join [provider].[MemberChartData] mcd on mcd.MemberChartDataId = ma.MemberChartDataId
                 join [provider].[MemberCharts] mc on mc.MemberChartId= mcd.MemberChartId                
                 join [provider].[ProviderProfiles] p on p.ProviderId = mcd.ProviderId
                 join [auth].[UserProfiles] up on up.UserProfileId = ma.HCPUserProfileId
                 join [provider].[MemberAppointments] a on a.MemberAppointmentId = ma.MemberAppointmentId
                 join [provider].[AppointmentTypes] t on t.AppointmentTypeId = ma.AppointmentTypeId
                 join [provider].[Locations] l on l.LocationId = mcd.LocationId
             where mc.MemberProfileId  = @memberProfileId 
 ) c order by c.ModifyDate desc
END
CREATE PROCEDURE [provider].[Update_AppointmentStatus]        
 (@memberAppointmentId  NVARCHAR(50) = NULL,@appointmentStatus  NVARCHAR(50) = NULL)  
/*       
Author: Srinivas G       
Date: March 1 2019
Desription 1: This stored procedure updates appointment status       
*/       
AS       
BEGIN   
update [provider].[MemberAppointments] set appointmentStatus=@appointmentStatus where MemberAppointmentId=@memberAppointmentId
END
CREATE procedure [provider].[ReceiptDataByTransactionGroupId]
( @trId nvarchar(50)='')
as
begin
select 'Co Payment' as Type
,(case d.minorprocessid when 20 then 'Testing Co Payment' when 38 then 'Device Co Payment' when 29 then 'Fitting Co Payment' end) as Description
,a.PaymentDate, a.OrderID, a.CopayAmount, a.AmountPaid, a.TransactionGroupID
from provider.memberchartdata d
cross apply openjson(d.processdata) with (PaymentDate date '$.paymentDate', OrderID bigint '$.orderID', CopayAmount decimal '$.copayAmount', AmountPaid decimal '$.amountPaid', TransactionGroupID varchar(40) '$.transactionGroupID') a
where d.minorprocessid in (20, 29, 38)
and a.TransactionGroupID=@trId


select
 AccountHolderName
,PaymentTypeCode
,CardTypeCode
,BankName
,AccountNumber
,Amount
,TransactionGroupID
from [PaymentGateway].[AuthorizedTransactions]
where TransactionGroupID = @trId;
end
CREATE procedure [provider].[GetAllUserForAdmin]
as
begin

select a.*,(select UserGroupName from [auth].[UserGroups] where Usergroupid = (select top 1 Usergroupid from [auth].[UserProfileGroups] where UserProfileId=a.UserProfileId)) as UserGroupName
	from (select distinct UP.UserProfileId,UP.UserName,UP.ProviderCode,UP.CreateDate,isnull(UP.ModifyDate,UP.CreateDate) ModifyDate,UP.FirstName,UP.LastName,UP.IsActive,UP.IsRegister,UP.TemproryKeyCode,UP.PrimaryPhoneNumber as PhoneNumber
	--,UG.UserGroupName
	,case
		when (select count(*) from [provider].[HCPProviderProfile] where Userprofileid=UP.Userprofileid and IsActive=1)>0 then 'Yes'
		else 'No'
	end as IsHCP
	 from [provider].[ProviderUsers] as PU
	join [auth].[UserProfiles] as UP on UP.Userprofileid=PU.Userprofileid
	join [auth].[UserProfileGroups] as UPG on UPG.Userprofileid=PU.Userprofileid
	join [auth].[UserGroups] as UG on UG.Usergroupid=UPG.Usergroupid
	where PU.isActive=1 and UP.isActive=1 and UPG.IsActive=1 and UG.IsActive=1)a 
	order by a.ModifyDate desc

end
CREATE procedure [provider].[GetAllLocationsForAdmin]
as
begin
select distinct LocationId,Businessname,Address1,City,State,Zip,IsActive from [provider].[Locations] where IsActive=1
end
CREATE PROCEDURE [provider].[Get_HCPAvilability]            
 (@providerid  NVARCHAR(50) = NULL,           
 @locationid NVARCHAR(50) = NULL)         
/*           
Author: Srinivas G           
Date: Feb 01 2019     
Desription 1: This stored procedure returns HCP Avilability which are IsActive=1           
*/           
AS           
BEGIN           
DECLARE @SQLSubQuery AS NVARCHAR(4000)       
set @SQLSubQuery ='select distinct PUL.locationid,PUL.userprofileid,PS.DayName as LocationDayName,LS.Opentime as LocationOpenTime,LS.CloseTime as LocationCloseTime,     
LS.BreakStartTime as LocationBreakStartTime,LS.BreakEndtime as LocationBreakEndTime,LS.IsByappointmentonly as LocationIsByappointmentonly,     
PS.Opentime as HCPOpenTime,PS.CloseTime as HCPCloseTime,PS.BreakStartTime as HCPBreakStartTime, PS.BreakEndTime as HCPBreakEndTime,     
PS.Isclosed as HCPIsClosed,PS.IsByappointmentonly as HCPIsByappointmentonly     
from [provider].[ProviderUserLocations] as PUL     
join [provider].[LocationSchedules] as LS on LS.locationid=PUL.locationid     
join [provider].[HCPSchedules] as PS on PS.locationid=PUL.locationid and PUL.userprofileid=PS.userprofileid    
where LS.isactive=1 and PUL.isactive=1 and PS.IsActive=1 and  PUL.providerid='+@providerid +'and PUL.locationid='+@locationid +''     
 SET @SQLSubQuery = 'select ROW_NUMBER() OVER (ORDER BY C.locationid) as ''RowID'',*from ('+@SQLSubQuery+') C'             
 print @SQLSubQuery      
  EXECUTE sp_ExecuteSQL @SQLSubQuery           
END
CREATE PROCEDURE [provider].[Get_AppointmentsByUserProfileId]        
 (@userprofileid NVARCHAR(50) = NULL,
 @starttime VARCHAR(50) = NULL)
/*       
Author: Srinivas G       
Date: Feb 01 2019
Desription 1: This stored procedure returns appointments       
*/       
AS       
BEGIN       
DECLARE @SQLSubQuery AS NVARCHAR(4000)   
DECLARE @appointmentstatus as varchar(20)
set @appointmentstatus='Complete'
set @SQLSubQuery ='select appointmentstatus,appointmenttypeid,hcpuserprofileid,startdate,starttime,enddate,endtime
 from [provider].[MemberAppointments]  where isactive=1 and appointmentstatus!='''+@appointmentstatus+''' and hcpuserprofileid='+@userprofileid +' and starttime like ''%'+@starttime+'%'''
 
 SET @SQLSubQuery = 'select ROW_NUMBER() OVER (ORDER BY C.appointmentstatus) as ''RowID'',*from ('+@SQLSubQuery+') C'         
 print @SQLSubQuery  
  EXECUTE sp_ExecuteSQL @SQLSubQuery       
END  
CREATE PROCEDURE [provider].[GetIVPendingRecords]
AS
BEGIN
/*
Author: Tharun 
Date: Nov 02 2018
Description : Fetches IVPendingRecords
Description : Added orderby condition 13-11-18
*/
    SELECT
	q.[IVQueueId] as IVQueueId,
	q.[NHMemberId] as NHMemberId,
	q.[CreateDate] as RequestDate,
	q.[InitiatedBy] as InitiatedBy,
	icarr.[InsuranceCarrierName] as InsuranceCarrier,
	hplan.[HealthPlanName] as InsurancePlan,
	concat(p.[FirstName], ' ', p.[LastName]) as MemberName
	from [provider].[IVQueue] q
	inner join [provider].[MemberProfiles] p
	on p.[NHMemberId] = q.[NHMemberId]
	inner join [Insurance].[InsuranceCarriers] icarr
	on icarr.[InsuranceCarrierID] = q.[InsuranceCarrierID]
	inner join [Insurance].[InsuranceHealthPlans] hplan
	on hplan.[InsuranceHealthPlanID] = q.[InsuranceHealthPlanID]
	where q.IsActive = 1 and p.IsActive = 1 and icarr.IsActive = 1 and hplan.IsActive = 1
	order by q.[IVQueueId] asc
END
CREATE PROCEDURE [provider].[GetMemberAppointments] 
    @MemberProfileId [bigint]
AS
BEGIN
      /*
Author: Sunnetha 
Description : change BusinessName to alias as ProviderName  13-11-18
CHANGES : UTC Formats removed 10-04-2019
*/
    SET NOCOUNT ON

	   SELECT ROW_NUMBER() OVER (ORDER BY ma.MemberAppointmentId) as 'RowID',
			m.MemberProfileId,ma.[MemberAppointmentId],t.[AppointmentTypeName] AppointmentType,
----OLD 
			--CONVERT(datetime, ma.[StartDate] AT TIME ZONE 'UTC' AT TIME ZONE l.[TimeZone]) AppointmentDate,
			--CONVERT(datetime, ma.[StartTime]AT TIME ZONE 'UTC' AT TIME ZONE l.[TimeZone]) AppointmentTime,
---Changes 10-04-2019
			ma.[StartDate] AppointmentDate,
			ma.[StartTime] AppointmentTime,
			CASE 
					WHEN l.TimeZone ='Mountain Standard Time' THEN 'MST' 
					WHEN l.TimeZone ='Hawaiian Standard Time' THEN 'HST' 
					WHEN l.TimeZone = 'Pacific Standard Time' THEN 'PST' 
					WHEN l.TimeZone = 'Central Standard Time' THEN 'CST' 
					WHEN l.TimeZone = 'Eastern Standard Time' THEN 'EST' 
			END AS TimeZone,
			l.BusinessName as ProviderName,
			(h.[FirstName] + ' ' + h.[LastName]) HCPName,
			ma.[Confirmed],
			ma.[AppointmentStatus],
			(CASE 
					WHEN ma.[Confirmed] = 1 THEN 'Confirmed' 
					ELSE 'UnConfirmed' END
			) ConfirmationStatus, 
			(l.[Address1]+' '+l.[Address2]+','+l.[City]+','+l.[State]+','+l.[Zip]) ProviderLocation, 
			m.[NHMemberId],
			mcd.ProviderId,
			mcd.LocationId,
			ma.[WalkIn],
			ma.[MissingDate]
		FROM [provider].[MemberAppointments] ma
				INNER JOIN [provider].[MemberChartData] mcd ON ma.MemberChartDataId = mcd.MemberChartDataId
				INNER JOIN [provider].[MemberCharts] mc ON mcd.MemberChartId = mc.MemberChartId
				INNER JOIN [provider].[MemberProfiles] m ON mc.MemberProfileId = m.MemberProfileId
				INNER JOIN [provider].[AppointmentTypes] t ON ma.[AppointmentTypeId] = t.[AppointmentTypeId]
				INNER JOIN [provider].[Locations] l ON mcd.locationId = l.locationId
				INNER JOIN [provider].[ProviderProfiles] p ON mcd.providerid = p.providerid
				INNER JOIN [auth].[UserProfiles] h ON ma.[HCPUserProfileId] = h.[UserProfileId]
		WHERE ma.[IsActive] = 1 AND mcd.[IsActive] = 1 AND mc.[IsActive] = 1 and  mc.MemberProfileId = @MemberProfileId
		ORDER BY ma.[MemberAppointmentId] desc

END

CREATE PROCEDURE [provider].[GetPriorAuthRequestHistoryUpdtes] --'NH201901912884'   
(    
    -- Add the parameters for the stored procedure here    
   @nhMemberId Varchar(50)    
)    
AS    
BEGIN    
    -- SET NOCOUNT ON added to prevent extra result sets from    
    -- interfering with SELECT statements.    
    SET NOCOUNT ON    
    
    -- Insert statements for procedure here    
      select     
    cast((select count(*) from [provider].[PriorAuthRequests] where NhMemberid=@nhMemberId)+ROW_NUMBER() OVER(ORDER BY ModifyUser) as int)  AS RowID     
 ,cast(CaseNumber as bigint) as CaseNumber  
  ,JSON_VALUE(PriorAuthRequestData, '$.requestSource') 'RequestSource'    
  ,JSON_VALUE(PriorAuthRequestData, '$.requestedBy') 'RequestedBy'    
  ,cast(JSON_VALUE(PriorAuthRequestData, '$.requestReceivedDate') as DateTime) 'RequestDate'    
  ,JSON_VALUE(PriorAuthRequestData, '$.caseDisposition') 'CaseDisposition'    
  ,cast(JSON_VALUE(PriorAuthRequestData, '$.finalDecisionDateTime') as DateTime)'CaseDispositionDateTime'    
  ,cast(JSON_VALUE(PriorAuthRequestTimelinessData, '$.hearingTestDate') as DateTime)  as 'HearingTestDate'    
  ,ModifyUser as 'LastUpdatedBy'    
  ,ModifyDate as 'LastUpdatedOn',IsApproved   
 from [provider].[PriorAuthRequestHistory] where NhMemberid= @nhMemberId and isactive=1  
 order by  [PriorServiceAuthQueueHistoryId] desc  
END   

CREATE PROCEDURE [provider].[GetPriorAuthRequestHistory]    
(    
    -- Add the parameters for the stored procedure here    
   @nhMemberId Varchar(50)    
)    
AS    
BEGIN    
    -- SET NOCOUNT ON added to prevent extra result sets from    
    -- interfering with SELECT statements.    
    SET NOCOUNT ON    
    
    -- Insert statements for procedure here    
      select    
 cast(ROW_NUMBER() OVER(ORDER BY CaseNumber) as int)  AS RowID     
 ,cast(CaseNumber as bigint) as CaseNumber   
  ,JSON_VALUE(PriorAuthRequestData, '$.requestSource') 'RequestSource'    
  ,JSON_VALUE(PriorAuthRequestData, '$.requestedBy') 'RequestedBy'    
  ,cast(JSON_VALUE(PriorAuthRequestData, '$.requestReceivedDate') as DateTime) 'RequestDate'    
  ,JSON_VALUE(PriorAuthRequestData, '$.caseDisposition') 'CaseDisposition'    
  ,cast(JSON_VALUE(PriorAuthRequestData, '$.finalDecisionDateTime') as DateTime)'CaseDispositionDateTime'    
  ,cast(JSON_VALUE(PriorAuthRequestTimelinessData, '$.hearingTestDate') as DateTime)  as 'HearingTestDate'    
  ,ModifyUser as 'LastUpdatedBy'    
  ,ModifyDate as 'LastUpdatedOn',IsApproved    
     
 from [provider].[PriorAuthRequests] where NhMemberid= @nhMemberId  and isactive=1  
END 

CREATE PROCEDURE [provider].[GetMemberShippingDetails] -- 'QA201800572294',6,26629
(
    -- Add the parameters for the stored procedure here
	@nhMemberId nvarchar(50),
	@providerId bigint,
	@engagementId bigint
)
AS
BEGIN
    -- SET NOCOUNT ON added to prevent extra result sets from
    -- interfering with SELECT statements.
    SET NOCOUNT ON
	  SELECT  distinct  
	    ROW_NUMBER() OVER(ORDER BY o.OrderID ASC) AS RowId
	    ,Me.MemberChartId as EngagementId
		,cast(o.DateOrderReceived as date) as OrderDate 
		,o.[OrderID] as OrderId
		,NhMemberID          
		,[OrderType] 
		,isnull((select top 1 ItemTypeDescription from [Orders].[ItemTypes] It where It.itemTypeCode=OI.ItemType),OI.ItemType) as ItemType
		,Convert(varchar(30),(SELECT OrderStatusName FROM Orders.OrderStatusTypes WHERE OrderStatusCode = o.OrderStatusCode)) as OrderStatus
		,cast([PONumber] as varchar(50)) as PONumber
		,OI.OrderItems
		,(case t.ordertransactiondata when null then null else (select top 1 PODate from openjson(t.ordertransactiondata) with (PODate date '$.poDate')) end) as PODATE
		,BrandCode 
		,cast(isnull(JSON_VALUE(ProviderData,'$."providerId"'),0) as bigint) as ProviderId
        ,cast(isnull(JSON_VALUE(ProviderData,'$.address."locationId"'),0) as bigint) as locationId
        ,cast(isnull(JSON_VALUE(o.MemberData,'$."insCarrierId"'),0) as bigint) as InsuranceCarrierId
        ,cast(isnull(JSON_VALUE(o.MemberData,'$."insPlanId"'),0) as bigint) as HealthPlanId
		 ,cast(isnull(JSON_VALUE(ProviderData,'$.address."locationId"'),0) as bigint) as ProviderLocationId
		,o.[MemberChartDataId]
		,CAST (0 AS Bigint) as TrackingId
		from [provider].[MemberCharts] Me
		inner Join [provider].[MemberChartData] Mc On Mc.MemberChartId =Me.MemberChartId and Mc.[ProviderId]=@providerId
		inner join  [Orders].[Orders] o on o.[MemberChartDataId] =Mc.MemberChartDataId	
		Inner join (select distinct OrderId,ItemType,PONumber,BrandCode,case when ItemType='HA' then STRING_AGG(OrderItemId, ', ') else STRING_AGG(OrderItemId, ', ')  end as OrderItems
		   from [Orders].[OrderItems] where Status='Active' and Isactive=1 group by OrderId,ItemType,ItemType,PONumber,BrandCode )OI  On o.OrderId=OI.OrderId 
		left join [Orders].[Ordertransactiondetails] t on t.orderid = o.orderid and t.orderstatuscode='PO' and t.isactive=1 and t.iscomplete=1
		where (ISJSON(o.MemberData) > 0)  and (ISJSON(o.ProviderData) > 0)  and Me.MemberChartId =@engagementId
		and O.OrderType In ('NEW','LSND','LSandD', 'EXCHANGE') and NhMemberID = @nhMemberId
		and (select count(*) from Orders.OrderTransactionDetails t where t.OrderId = o.OrderId and t.orderstatuscode='APP' 
		and t.isactive=1 and t.iscomplete=1)>0
END
CREATE TRIGGER [provider].[utrg_Update_IVQueue] ON [provider].[IVQueue]
AFTER UPDATE
AS 
BEGIN
/*
Author: Rajeshwar 
Date: Nov 06 2018
Desription 1: Trigger will get fires when ever IVQueue table gets updated and inserts old data into IVQueueHist table
*/
INSERT INTO  [provider].[IVQueueHist] 
(
	IVQueueId,
	InsuranceCarrierId,
	InsuranceHealthPlanId,
	OtherCarrierName,
	OtherPlanName,
	ContactName ,
	ContactNbr,
	IVRefNbr,
	IVBenefitAmt,
	IVBenefitFrequencyType,
	IVBenefitFrequency,
	IVBenefitAvailableAmt,
	IVBenefitLastUsedDate,
	OutOfNetwork,
	OutOfNetworkBenefitAmt,
	PriorAuthorizationRequired,
	PreServiceAuthorizationRequired,
	PlanDeductableAmt,
	DeductableDetails,
	HearingTestCoPayAmt,
	HearingAidCoPayAmt,
	FittingCoPayAmt,
	DateVerified,
	TimeVerified,
	ToUseDiscountProgram,
	IVNotes,
	IsVerified,
	IsApproved,
	InitiatedBy,
	VerifiedBy,
	CreateUser,
	CreateDate,
	ModifyUser,
	ModifyDate,
	IsActive
)

SELECT	IVQueueId,
		InsuranceCarrierId,
		InsuranceHealthPlanId,
		OtherCarrierName,
		OtherPlanName,
		ContactName ,
		ContactNbr,
		IVRefNbr,
		IVBenefitAmt,
		IVBenefitFrequencyType,
		IVBenefitFrequency,
		IVBenefitAvailableAmt,
		IVBenefitLastUsedDate,
		OutOfNetwork,
		OutOfNetworkBenefitAmt,
		PriorAuthorizationRequired,
		PreServiceAuthorizationRequired,
		PlanDeductableAmt,
		DeductableDetails,
		HearingTestCoPayAmt,
		HearingAidCoPayAmt,
		FittingCoPayAmt,
		DateVerified,
		TimeVerified,
		ToUseDiscountProgram,
		IVNotes,
		IsVerified,
	    IsApproved,
		InitiatedBy,
		VerifiedBy,
		CreateUser,
		CreateDate,
		ModifyUser,
		ModifyDate,
		IsActive

	 FROM DELETED  

END


CREATE TRIGGER [provider].[utrg_PMemberInsurance] ON [provider].[MemberInsurances]
FOR UPDATE
AS 
BEGIN  
/*
Author: Rajeshwar 
Date: Nov 06 2018
Desription 1: Added Status in existing Trigger.Trigger will get fires when IVQStatus is not 'Pending'
*/

----Added Status condition in the existing trigger
----Removed Status condition in the existing trigger -14-11-18
--------------------------------------------------------------------
DECLARE @Status VARCHAR(20)
SET @Status=   (SELECT IVQStatus 
							FROM INSERTED MI
							INNER JOIN [provider].[MemberInsuranceDetails] MID ON MID.MemberInsuranceId=MI.MemberInsuranceId
							)
-------------------------

DECLARE @OldInsuranceEffectiveDate DATETIME2, @NewInsuranceEffectiveDate DATETIME2, @OldInsuranceEndDate DATETIME2, @NewInsuranceEndDate DATETIME2, @OldInsuranceCarrierID BIGINT, @NewInsuranceCarrierID BIGINT, @OldInsuranceHealthPlanID BIGINT, @NewInsuranceHealthPlanID BIGINT
SELECT @OldInsuranceEffectiveDate = b.InsuranceEffectiveDate, @NewInsuranceEffectiveDate = a.InsuranceEffectiveDate, 
	   @OldInsuranceEndDate = b.InsuranceEndDate, @NewInsuranceEndDate = a.InsuranceEndDate, @OldInsuranceCarrierID = b.InsuranceCarrierID,
	   @NewInsuranceCarrierID = a.InsuranceCarrierID, @OldInsuranceHealthPlanID = b.InsuranceHealthPlanID, @NewInsuranceHealthPlanID = a.InsuranceHealthPlanID
FROM   inserted a, deleted b
----------Checked the Condition, If status is not Pending then trigger will fire 
--IF(@Status<>'Pending')
--BEGIN
	if((@OldInsuranceEffectiveDate <> @NewInsuranceEffectiveDate) or (@OldInsuranceEndDate <> @NewInsuranceEndDate) or (@OldInsuranceCarrierID <> @NewInsuranceCarrierID) or (@OldInsuranceHealthPlanID <>@NewInsuranceHealthPlanID ))
	   begin
	   IF UPDATE (InsuranceEffectiveDate) OR UPDATE(InsuranceEndDate) OR UPDATE(InsuranceCarrierID) OR UPDATE(InsuranceHealthPlanID) 
		begin
			INSERT INTO [provider].[MemberInsurances_History]
				   ([MemberInsuranceID]
				   ,[CreateDate]
				   ,[CreateUser]
				   ,[InsuranceCarrierID]
				   ,[InsuranceEffectiveDate]
				   ,[InsuranceEndDate]
				   ,[InsuranceHealthPlanID]
				   ,[InsuranceType]
				   ,[IsActive]
				   ,[MemberProfileId]
				   ,[ModifyDate]
				   ,[ModifyUser])
			SELECT  [MemberInsuranceID]
				   ,[CreateDate]
				   ,[CreateUser]
				   ,[InsuranceCarrierID]
				   ,[InsuranceEffectiveDate]
				   ,[InsuranceEndDate]
				   ,[InsuranceHealthPlanID]
				   ,[InsuranceType]
				   ,[IsActive]           
				   ,[MemberProfileId]
				   ,[ModifyDate]
				   ,[ModifyUser]          
			FROM deleted
		end
	end
END
CREATE TRIGGER [provider].[ProviderUsers_dss_insert_trigger] ON [provider].[ProviderUsers] FOR INSERT AS
SET NOCOUNT ON
DECLARE @marker_create_scope_local_id INT
DECLARE @marker_scope_create_peer_timestamp BIGINT
DECLARE @marker_scope_create_peer_key INT
DECLARE @marker_local_create_peer_timestamp BIGINT
DECLARE @marker_local_create_peer_key INT
DECLARE @marker_state INT
SELECT TOP 1 @marker_create_scope_local_id = [provision_scope_local_id], @marker_local_create_peer_timestamp = [provision_timestamp], @marker_local_create_peer_key = [provision_local_peer_key], @marker_scope_create_peer_timestamp = [provision_scope_peer_timestamp], @marker_scope_create_peer_key = [provision_scope_peer_key], @marker_state = [state]
FROM [DataSync].[provision_marker_dss]
WHERE [object_id] = 1598628738 
 AND [owner_scope_local_id] = 0

MERGE [DataSync].[ProviderUsers_dss_tracking] AS [target] 
USING (SELECT [i].[ProviderId], [i].[UserProfileId] FROM INSERTED AS [i]) AS source([ProviderId], [UserProfileId]) 
ON ([target].[ProviderId] = [source].[ProviderId] AND [target].[UserProfileId] = [source].[UserProfileId])
WHEN MATCHED THEN
UPDATE SET [sync_row_is_tombstone] = 0, 
[local_update_peer_key] = 0, 
[update_scope_local_id] = NULL, [last_change_datetime] = GETDATE()
WHEN NOT MATCHED THEN
INSERT (
[ProviderId], [UserProfileId] ,
[create_scope_local_id], [scope_create_peer_key], [scope_create_peer_timestamp], [local_create_peer_key], [local_create_peer_timestamp], [update_scope_local_id], [local_update_peer_key], [sync_row_is_tombstone], [last_change_datetime]) 
VALUES (
[source].[ProviderId], [source].[UserProfileId],NULL, NULL, NULL, 0, CAST(@@DBTS AS BIGINT) + 1, NULL, 0, 0, GETDATE() );
CREATE TRIGGER [provider].[ProviderUsers_dss_delete_trigger] ON [provider].[ProviderUsers] FOR DELETE AS
SET NOCOUNT ON
DECLARE @marker_create_scope_local_id INT
DECLARE @marker_scope_create_peer_timestamp BIGINT
DECLARE @marker_scope_create_peer_key INT
DECLARE @marker_local_create_peer_timestamp BIGINT
DECLARE @marker_local_create_peer_key INT
DECLARE @marker_state INT
SELECT TOP 1 @marker_create_scope_local_id = [provision_scope_local_id], @marker_local_create_peer_timestamp = [provision_timestamp], @marker_local_create_peer_key = [provision_local_peer_key], @marker_scope_create_peer_timestamp = [provision_scope_peer_timestamp], @marker_scope_create_peer_key = [provision_scope_peer_key], @marker_state = [state]
FROM [DataSync].[provision_marker_dss]
WHERE [object_id] = 1598628738 
 AND [owner_scope_local_id] = 0

MERGE [DataSync].[ProviderUsers_dss_tracking] AS [target] 
USING (SELECT [i].[ProviderId], [i].[UserProfileId] FROM DELETED AS [i]) AS source([ProviderId], [UserProfileId]) 
ON ([target].[ProviderId] = [source].[ProviderId] AND [target].[UserProfileId] = [source].[UserProfileId])
WHEN MATCHED THEN
UPDATE SET [sync_row_is_tombstone] = 1, 
[local_update_peer_key] = 0, 
[update_scope_local_id] = NULL, [last_change_datetime] = GETDATE()
WHEN NOT MATCHED THEN
INSERT (
[ProviderId], [UserProfileId] ,
[create_scope_local_id], [scope_create_peer_key], [scope_create_peer_timestamp], [local_create_peer_key], [local_create_peer_timestamp], [update_scope_local_id], [local_update_peer_key], [sync_row_is_tombstone], [last_change_datetime]) 
VALUES (
[source].[ProviderId], [source].[UserProfileId],@marker_create_scope_local_id, @marker_scope_create_peer_key, @marker_scope_create_peer_timestamp, 0, @marker_local_create_peer_timestamp , NULL, 0, 1, GETDATE() );
CREATE TRIGGER [provider].[ProviderUsers_dss_update_trigger] ON [provider].[ProviderUsers] FOR UPDATE AS
SET NOCOUNT ON
DECLARE @marker_create_scope_local_id INT
DECLARE @marker_scope_create_peer_timestamp BIGINT
DECLARE @marker_scope_create_peer_key INT
DECLARE @marker_local_create_peer_timestamp BIGINT
DECLARE @marker_local_create_peer_key INT
DECLARE @marker_state INT
SELECT TOP 1 @marker_create_scope_local_id = [provision_scope_local_id], @marker_local_create_peer_timestamp = [provision_timestamp], @marker_local_create_peer_key = [provision_local_peer_key], @marker_scope_create_peer_timestamp = [provision_scope_peer_timestamp], @marker_scope_create_peer_key = [provision_scope_peer_key], @marker_state = [state]
FROM [DataSync].[provision_marker_dss]
WHERE [object_id] = 1598628738 
 AND [owner_scope_local_id] = 0

MERGE [DataSync].[ProviderUsers_dss_tracking] AS [target] 
USING (SELECT [i].[ProviderId], [i].[UserProfileId] FROM INSERTED AS [i]) AS source([ProviderId], [UserProfileId]) 
ON ([target].[ProviderId] = [source].[ProviderId] AND [target].[UserProfileId] = [source].[UserProfileId])
WHEN MATCHED THEN
UPDATE SET [sync_row_is_tombstone] = 0, 
[local_update_peer_key] = 0, 
[update_scope_local_id] = NULL, [last_change_datetime] = GETDATE()
WHEN NOT MATCHED THEN
INSERT (
[ProviderId], [UserProfileId] ,
[create_scope_local_id], [scope_create_peer_key], [scope_create_peer_timestamp], [local_create_peer_key], [local_create_peer_timestamp], [update_scope_local_id], [local_update_peer_key], [sync_row_is_tombstone], [last_change_datetime]) 
VALUES (
[source].[ProviderId], [source].[UserProfileId],@marker_create_scope_local_id, @marker_scope_create_peer_key, @marker_scope_create_peer_timestamp, 0, @marker_local_create_peer_timestamp , NULL, 0, 0, GETDATE() );

CREATE TRIGGER [provider].[utrg_MemberAppointments] ON [provider].[MemberAppointments]
FOR INSERT
AS 
BEGIN
   
  -- IF UPDATE (ModifyDate) --OR UPDATE(LocationId)  OR UPDATE(ProviderId)  OR UPDATE(AppointmentStatus) OR UPDATE(IsActive) or UPDATE(UserProfileId)
	--	begin

		INSERT INTO [provider].[MemberAppointments_History]
			   ([MemberAppointmentId],[AccompaniedBy],[AppointmentStatus],[AppointmentTypeId],[Confirmed],[MemberChartDataId],
			   [CreateDate],[CreateUser],[EmailAddress],[EmailReminder],[MobileNumber] ,[IsActive],[IsItOverlap],
			   [ModifyDate],[ModifyUser],[Relationship],[SmsReminder],[HCPUserProfileId],[StartDate],[StartTime],[EndDate],[EndTime],[WalkIn],[MissingDate])
		SELECT apmt.[MemberAppointmentId] ,apmt.[AccompaniedBy],apmt.[AppointmentStatus],apmt.[AppointmentTypeId],
				apmt.[Confirmed],apmt.[MemberChartDataId],apmt.[CreateDate] ,apmt.[CreateUser],apmt.[EmailAddress],apmt.[EmailReminder],apmt.[MobileNumber],
				apmt.[IsActive],apmt.[IsItOverlap],apmt.[ModifyDate],apmt.[ModifyUser],apmt.[Relationship],apmt.[SmsReminder],
				apmt.[HCPUserProfileId],apmt.StartDate,apmt.StartTime,apmt.EndDate,apmt.EndTIme,apmt.[WalkIn],apmt.[MissingDate]
				FROM inserted apmt

	 -- end

END
CREATE TRIGGER [provider].[ProviderEmails_dss_insert_trigger] ON [provider].[ProviderEmails] FOR INSERT AS
SET NOCOUNT ON
DECLARE @marker_create_scope_local_id INT
DECLARE @marker_scope_create_peer_timestamp BIGINT
DECLARE @marker_scope_create_peer_key INT
DECLARE @marker_local_create_peer_timestamp BIGINT
DECLARE @marker_local_create_peer_key INT
DECLARE @marker_state INT
SELECT TOP 1 @marker_create_scope_local_id = [provision_scope_local_id], @marker_local_create_peer_timestamp = [provision_timestamp], @marker_local_create_peer_key = [provision_local_peer_key], @marker_scope_create_peer_timestamp = [provision_scope_peer_timestamp], @marker_scope_create_peer_key = [provision_scope_peer_key], @marker_state = [state]
FROM [DataSync].[provision_marker_dss]
WHERE [object_id] = 1454628225 
 AND [owner_scope_local_id] = 0

MERGE [DataSync].[ProviderEmails_dss_tracking] AS [target] 
USING (SELECT [i].[ProviderEmailId] FROM INSERTED AS [i]) AS source([ProviderEmailId]) 
ON ([target].[ProviderEmailId] = [source].[ProviderEmailId])
WHEN MATCHED THEN
UPDATE SET [sync_row_is_tombstone] = 0, 
[local_update_peer_key] = 0, 
[update_scope_local_id] = NULL, [last_change_datetime] = GETDATE()
WHEN NOT MATCHED THEN
INSERT (
[ProviderEmailId] ,
[create_scope_local_id], [scope_create_peer_key], [scope_create_peer_timestamp], [local_create_peer_key], [local_create_peer_timestamp], [update_scope_local_id], [local_update_peer_key], [sync_row_is_tombstone], [last_change_datetime]) 
VALUES (
[source].[ProviderEmailId],NULL, NULL, NULL, 0, CAST(@@DBTS AS BIGINT) + 1, NULL, 0, 0, GETDATE() );
CREATE TRIGGER [provider].[ProviderEmails_dss_update_trigger] ON [provider].[ProviderEmails] FOR UPDATE AS
SET NOCOUNT ON
DECLARE @marker_create_scope_local_id INT
DECLARE @marker_scope_create_peer_timestamp BIGINT
DECLARE @marker_scope_create_peer_key INT
DECLARE @marker_local_create_peer_timestamp BIGINT
DECLARE @marker_local_create_peer_key INT
DECLARE @marker_state INT
SELECT TOP 1 @marker_create_scope_local_id = [provision_scope_local_id], @marker_local_create_peer_timestamp = [provision_timestamp], @marker_local_create_peer_key = [provision_local_peer_key], @marker_scope_create_peer_timestamp = [provision_scope_peer_timestamp], @marker_scope_create_peer_key = [provision_scope_peer_key], @marker_state = [state]
FROM [DataSync].[provision_marker_dss]
WHERE [object_id] = 1454628225 
 AND [owner_scope_local_id] = 0

MERGE [DataSync].[ProviderEmails_dss_tracking] AS [target] 
USING (SELECT [i].[ProviderEmailId] FROM INSERTED AS [i]) AS source([ProviderEmailId]) 
ON ([target].[ProviderEmailId] = [source].[ProviderEmailId])
WHEN MATCHED THEN
UPDATE SET [sync_row_is_tombstone] = 0, 
[local_update_peer_key] = 0, 
[update_scope_local_id] = NULL, [last_change_datetime] = GETDATE()
WHEN NOT MATCHED THEN
INSERT (
[ProviderEmailId] ,
[create_scope_local_id], [scope_create_peer_key], [scope_create_peer_timestamp], [local_create_peer_key], [local_create_peer_timestamp], [update_scope_local_id], [local_update_peer_key], [sync_row_is_tombstone], [last_change_datetime]) 
VALUES (
[source].[ProviderEmailId],@marker_create_scope_local_id, @marker_scope_create_peer_key, @marker_scope_create_peer_timestamp, 0, @marker_local_create_peer_timestamp , NULL, 0, 0, GETDATE() );
CREATE TRIGGER [provider].[ProviderEmails_dss_delete_trigger] ON [provider].[ProviderEmails] FOR DELETE AS
SET NOCOUNT ON
DECLARE @marker_create_scope_local_id INT
DECLARE @marker_scope_create_peer_timestamp BIGINT
DECLARE @marker_scope_create_peer_key INT
DECLARE @marker_local_create_peer_timestamp BIGINT
DECLARE @marker_local_create_peer_key INT
DECLARE @marker_state INT
SELECT TOP 1 @marker_create_scope_local_id = [provision_scope_local_id], @marker_local_create_peer_timestamp = [provision_timestamp], @marker_local_create_peer_key = [provision_local_peer_key], @marker_scope_create_peer_timestamp = [provision_scope_peer_timestamp], @marker_scope_create_peer_key = [provision_scope_peer_key], @marker_state = [state]
FROM [DataSync].[provision_marker_dss]
WHERE [object_id] = 1454628225 
 AND [owner_scope_local_id] = 0

MERGE [DataSync].[ProviderEmails_dss_tracking] AS [target] 
USING (SELECT [i].[ProviderEmailId] FROM DELETED AS [i]) AS source([ProviderEmailId]) 
ON ([target].[ProviderEmailId] = [source].[ProviderEmailId])
WHEN MATCHED THEN
UPDATE SET [sync_row_is_tombstone] = 1, 
[local_update_peer_key] = 0, 
[update_scope_local_id] = NULL, [last_change_datetime] = GETDATE()
WHEN NOT MATCHED THEN
INSERT (
[ProviderEmailId] ,
[create_scope_local_id], [scope_create_peer_key], [scope_create_peer_timestamp], [local_create_peer_key], [local_create_peer_timestamp], [update_scope_local_id], [local_update_peer_key], [sync_row_is_tombstone], [last_change_datetime]) 
VALUES (
[source].[ProviderEmailId],@marker_create_scope_local_id, @marker_scope_create_peer_key, @marker_scope_create_peer_timestamp, 0, @marker_local_create_peer_timestamp , NULL, 0, 1, GETDATE() );

CREATE TRIGGER [provider].[utrg_Update_MemberAppointments] ON [provider].[MemberAppointments]
AFTER UPDATE
AS 
BEGIN
   
  -- IF UPDATE (ModifyDate) --OR UPDATE(LocationId)  OR UPDATE(ProviderId)  OR UPDATE(AppointmentStatus) OR UPDATE(IsActive) or UPDATE(UserProfileId)
	--	begin

		INSERT INTO [provider].[MemberAppointments_History]
			   ([MemberAppointmentId],[AccompaniedBy],[AppointmentStatus],[AppointmentTypeId],[Confirmed],[MemberChartDataId],
			   [CreateDate],[CreateUser],[EmailAddress],[EmailReminder],[MobileNumber] ,[IsActive],[IsItOverlap],
			   [ModifyDate],[ModifyUser],[Relationship],[SmsReminder],[HCPUserProfileId],[StartDate],[StartTime],[EndDate],[EndTime],[WalkIn],[MissingDate])
		SELECT apmt.[MemberAppointmentId] ,apmt.[AccompaniedBy],apmt.[AppointmentStatus],apmt.[AppointmentTypeId],
				apmt.[Confirmed],apmt.[MemberChartDataId],apmt.[CreateDate] ,apmt.[CreateUser],apmt.[EmailAddress],apmt.[EmailReminder],apmt.[MobileNumber],
				apmt.[IsActive],apmt.[IsItOverlap],apmt.[ModifyDate],apmt.[ModifyUser],apmt.[Relationship],apmt.[SmsReminder],
				apmt.[HCPUserProfileId],apmt.StartDate,apmt.StartTime,apmt.EndDate,apmt.EndTIme,apmt.[WalkIn],apmt.[MissingDate]
				FROM  INSERTED apmt

END
CREATE TRIGGER [provider].[ProviderUserLocations_dss_delete_trigger] ON [provider].[ProviderUserLocations] FOR DELETE AS
SET NOCOUNT ON
DECLARE @marker_create_scope_local_id INT
DECLARE @marker_scope_create_peer_timestamp BIGINT
DECLARE @marker_scope_create_peer_key INT
DECLARE @marker_local_create_peer_timestamp BIGINT
DECLARE @marker_local_create_peer_key INT
DECLARE @marker_state INT
SELECT TOP 1 @marker_create_scope_local_id = [provision_scope_local_id], @marker_local_create_peer_timestamp = [provision_timestamp], @marker_local_create_peer_key = [provision_local_peer_key], @marker_scope_create_peer_timestamp = [provision_scope_peer_timestamp], @marker_scope_create_peer_key = [provision_scope_peer_key], @marker_state = [state]
FROM [DataSync].[provision_marker_dss]
WHERE [object_id] = 1566628624 
 AND [owner_scope_local_id] = 0

MERGE [DataSync].[ProviderUserLocations_dss_tracking] AS [target] 
USING (SELECT [i].[ProviderId], [i].[LocationId], [i].[UserProfileId] FROM DELETED AS [i]) AS source([ProviderId], [LocationId], [UserProfileId]) 
ON ([target].[ProviderId] = [source].[ProviderId] AND [target].[LocationId] = [source].[LocationId] AND [target].[UserProfileId] = [source].[UserProfileId])
WHEN MATCHED THEN
UPDATE SET [sync_row_is_tombstone] = 1, 
[local_update_peer_key] = 0, 
[update_scope_local_id] = NULL, [last_change_datetime] = GETDATE()
WHEN NOT MATCHED THEN
INSERT (
[ProviderId], [LocationId], [UserProfileId] ,
[create_scope_local_id], [scope_create_peer_key], [scope_create_peer_timestamp], [local_create_peer_key], [local_create_peer_timestamp], [update_scope_local_id], [local_update_peer_key], [sync_row_is_tombstone], [last_change_datetime]) 
VALUES (
[source].[ProviderId], [source].[LocationId], [source].[UserProfileId],@marker_create_scope_local_id, @marker_scope_create_peer_key, @marker_scope_create_peer_timestamp, 0, @marker_local_create_peer_timestamp , NULL, 0, 1, GETDATE() );
CREATE TRIGGER [provider].[ProviderUserLocations_dss_insert_trigger] ON [provider].[ProviderUserLocations] FOR INSERT AS
SET NOCOUNT ON
DECLARE @marker_create_scope_local_id INT
DECLARE @marker_scope_create_peer_timestamp BIGINT
DECLARE @marker_scope_create_peer_key INT
DECLARE @marker_local_create_peer_timestamp BIGINT
DECLARE @marker_local_create_peer_key INT
DECLARE @marker_state INT
SELECT TOP 1 @marker_create_scope_local_id = [provision_scope_local_id], @marker_local_create_peer_timestamp = [provision_timestamp], @marker_local_create_peer_key = [provision_local_peer_key], @marker_scope_create_peer_timestamp = [provision_scope_peer_timestamp], @marker_scope_create_peer_key = [provision_scope_peer_key], @marker_state = [state]
FROM [DataSync].[provision_marker_dss]
WHERE [object_id] = 1566628624 
 AND [owner_scope_local_id] = 0

MERGE [DataSync].[ProviderUserLocations_dss_tracking] AS [target] 
USING (SELECT [i].[ProviderId], [i].[LocationId], [i].[UserProfileId] FROM INSERTED AS [i]) AS source([ProviderId], [LocationId], [UserProfileId]) 
ON ([target].[ProviderId] = [source].[ProviderId] AND [target].[LocationId] = [source].[LocationId] AND [target].[UserProfileId] = [source].[UserProfileId])
WHEN MATCHED THEN
UPDATE SET [sync_row_is_tombstone] = 0, 
[local_update_peer_key] = 0, 
[update_scope_local_id] = NULL, [last_change_datetime] = GETDATE()
WHEN NOT MATCHED THEN
INSERT (
[ProviderId], [LocationId], [UserProfileId] ,
[create_scope_local_id], [scope_create_peer_key], [scope_create_peer_timestamp], [local_create_peer_key], [local_create_peer_timestamp], [update_scope_local_id], [local_update_peer_key], [sync_row_is_tombstone], [last_change_datetime]) 
VALUES (
[source].[ProviderId], [source].[LocationId], [source].[UserProfileId],NULL, NULL, NULL, 0, CAST(@@DBTS AS BIGINT) + 1, NULL, 0, 0, GETDATE() );
CREATE TRIGGER [provider].[ProviderUserLocations_dss_update_trigger] ON [provider].[ProviderUserLocations] FOR UPDATE AS
SET NOCOUNT ON
DECLARE @marker_create_scope_local_id INT
DECLARE @marker_scope_create_peer_timestamp BIGINT
DECLARE @marker_scope_create_peer_key INT
DECLARE @marker_local_create_peer_timestamp BIGINT
DECLARE @marker_local_create_peer_key INT
DECLARE @marker_state INT
SELECT TOP 1 @marker_create_scope_local_id = [provision_scope_local_id], @marker_local_create_peer_timestamp = [provision_timestamp], @marker_local_create_peer_key = [provision_local_peer_key], @marker_scope_create_peer_timestamp = [provision_scope_peer_timestamp], @marker_scope_create_peer_key = [provision_scope_peer_key], @marker_state = [state]
FROM [DataSync].[provision_marker_dss]
WHERE [object_id] = 1566628624 
 AND [owner_scope_local_id] = 0

MERGE [DataSync].[ProviderUserLocations_dss_tracking] AS [target] 
USING (SELECT [i].[ProviderId], [i].[LocationId], [i].[UserProfileId] FROM INSERTED AS [i]) AS source([ProviderId], [LocationId], [UserProfileId]) 
ON ([target].[ProviderId] = [source].[ProviderId] AND [target].[LocationId] = [source].[LocationId] AND [target].[UserProfileId] = [source].[UserProfileId])
WHEN MATCHED THEN
UPDATE SET [sync_row_is_tombstone] = 0, 
[local_update_peer_key] = 0, 
[update_scope_local_id] = NULL, [last_change_datetime] = GETDATE()
WHEN NOT MATCHED THEN
INSERT (
[ProviderId], [LocationId], [UserProfileId] ,
[create_scope_local_id], [scope_create_peer_key], [scope_create_peer_timestamp], [local_create_peer_key], [local_create_peer_timestamp], [update_scope_local_id], [local_update_peer_key], [sync_row_is_tombstone], [last_change_datetime]) 
VALUES (
[source].[ProviderId], [source].[LocationId], [source].[UserProfileId],@marker_create_scope_local_id, @marker_scope_create_peer_key, @marker_scope_create_peer_timestamp, 0, @marker_local_create_peer_timestamp , NULL, 0, 0, GETDATE() );
CREATE TRIGGER [provider].[ProviderLocations_dss_insert_trigger] ON [provider].[ProviderLocations] FOR INSERT AS
SET NOCOUNT ON
DECLARE @marker_create_scope_local_id INT
DECLARE @marker_scope_create_peer_timestamp BIGINT
DECLARE @marker_scope_create_peer_key INT
DECLARE @marker_local_create_peer_timestamp BIGINT
DECLARE @marker_local_create_peer_key INT
DECLARE @marker_state INT
SELECT TOP 1 @marker_create_scope_local_id = [provision_scope_local_id], @marker_local_create_peer_timestamp = [provision_timestamp], @marker_local_create_peer_key = [provision_local_peer_key], @marker_scope_create_peer_timestamp = [provision_scope_peer_timestamp], @marker_scope_create_peer_key = [provision_scope_peer_key], @marker_state = [state]
FROM [DataSync].[provision_marker_dss]
WHERE [object_id] = 1486628339 
 AND [owner_scope_local_id] = 0

MERGE [DataSync].[ProviderLocations_dss_tracking] AS [target] 
USING (SELECT [i].[ProviderId], [i].[LocationId] FROM INSERTED AS [i]) AS source([ProviderId], [LocationId]) 
ON ([target].[ProviderId] = [source].[ProviderId] AND [target].[LocationId] = [source].[LocationId])
WHEN MATCHED THEN
UPDATE SET [sync_row_is_tombstone] = 0, 
[local_update_peer_key] = 0, 
[update_scope_local_id] = NULL, [last_change_datetime] = GETDATE()
WHEN NOT MATCHED THEN
INSERT (
[ProviderId], [LocationId] ,
[create_scope_local_id], [scope_create_peer_key], [scope_create_peer_timestamp], [local_create_peer_key], [local_create_peer_timestamp], [update_scope_local_id], [local_update_peer_key], [sync_row_is_tombstone], [last_change_datetime]) 
VALUES (
[source].[ProviderId], [source].[LocationId],NULL, NULL, NULL, 0, CAST(@@DBTS AS BIGINT) + 1, NULL, 0, 0, GETDATE() );
CREATE TRIGGER [provider].[ProviderProfiles_dss_update_trigger] ON [provider].[ProviderProfiles] FOR UPDATE AS
SET NOCOUNT ON
DECLARE @marker_create_scope_local_id INT
DECLARE @marker_scope_create_peer_timestamp BIGINT
DECLARE @marker_scope_create_peer_key INT
DECLARE @marker_local_create_peer_timestamp BIGINT
DECLARE @marker_local_create_peer_key INT
DECLARE @marker_state INT
SELECT TOP 1 @marker_create_scope_local_id = [provision_scope_local_id], @marker_local_create_peer_timestamp = [provision_timestamp], @marker_local_create_peer_key = [provision_local_peer_key], @marker_scope_create_peer_timestamp = [provision_scope_peer_timestamp], @marker_scope_create_peer_key = [provision_scope_peer_key], @marker_state = [state]
FROM [DataSync].[provision_marker_dss]
WHERE [object_id] = 1518628453 
 AND [owner_scope_local_id] = 0

MERGE [DataSync].[ProviderProfiles_dss_tracking] AS [target] 
USING (SELECT [i].[ProviderId] FROM INSERTED AS [i]) AS source([ProviderId]) 
ON ([target].[ProviderId] = [source].[ProviderId])
WHEN MATCHED THEN
UPDATE SET [sync_row_is_tombstone] = 0, 
[local_update_peer_key] = 0, 
[update_scope_local_id] = NULL, [last_change_datetime] = GETDATE()
WHEN NOT MATCHED THEN
INSERT (
[ProviderId] ,
[create_scope_local_id], [scope_create_peer_key], [scope_create_peer_timestamp], [local_create_peer_key], [local_create_peer_timestamp], [update_scope_local_id], [local_update_peer_key], [sync_row_is_tombstone], [last_change_datetime]) 
VALUES (
[source].[ProviderId],@marker_create_scope_local_id, @marker_scope_create_peer_key, @marker_scope_create_peer_timestamp, 0, @marker_local_create_peer_timestamp , NULL, 0, 0, GETDATE() );
CREATE TRIGGER [provider].[ProviderProfiles_dss_insert_trigger] ON [provider].[ProviderProfiles] FOR INSERT AS
SET NOCOUNT ON
DECLARE @marker_create_scope_local_id INT
DECLARE @marker_scope_create_peer_timestamp BIGINT
DECLARE @marker_scope_create_peer_key INT
DECLARE @marker_local_create_peer_timestamp BIGINT
DECLARE @marker_local_create_peer_key INT
DECLARE @marker_state INT
SELECT TOP 1 @marker_create_scope_local_id = [provision_scope_local_id], @marker_local_create_peer_timestamp = [provision_timestamp], @marker_local_create_peer_key = [provision_local_peer_key], @marker_scope_create_peer_timestamp = [provision_scope_peer_timestamp], @marker_scope_create_peer_key = [provision_scope_peer_key], @marker_state = [state]
FROM [DataSync].[provision_marker_dss]
WHERE [object_id] = 1518628453 
 AND [owner_scope_local_id] = 0

MERGE [DataSync].[ProviderProfiles_dss_tracking] AS [target] 
USING (SELECT [i].[ProviderId] FROM INSERTED AS [i]) AS source([ProviderId]) 
ON ([target].[ProviderId] = [source].[ProviderId])
WHEN MATCHED THEN
UPDATE SET [sync_row_is_tombstone] = 0, 
[local_update_peer_key] = 0, 
[update_scope_local_id] = NULL, [last_change_datetime] = GETDATE()
WHEN NOT MATCHED THEN
INSERT (
[ProviderId] ,
[create_scope_local_id], [scope_create_peer_key], [scope_create_peer_timestamp], [local_create_peer_key], [local_create_peer_timestamp], [update_scope_local_id], [local_update_peer_key], [sync_row_is_tombstone], [last_change_datetime]) 
VALUES (
[source].[ProviderId],NULL, NULL, NULL, 0, CAST(@@DBTS AS BIGINT) + 1, NULL, 0, 0, GETDATE() );
CREATE TRIGGER [provider].[ProviderLocations_dss_delete_trigger] ON [provider].[ProviderLocations] FOR DELETE AS
SET NOCOUNT ON
DECLARE @marker_create_scope_local_id INT
DECLARE @marker_scope_create_peer_timestamp BIGINT
DECLARE @marker_scope_create_peer_key INT
DECLARE @marker_local_create_peer_timestamp BIGINT
DECLARE @marker_local_create_peer_key INT
DECLARE @marker_state INT
SELECT TOP 1 @marker_create_scope_local_id = [provision_scope_local_id], @marker_local_create_peer_timestamp = [provision_timestamp], @marker_local_create_peer_key = [provision_local_peer_key], @marker_scope_create_peer_timestamp = [provision_scope_peer_timestamp], @marker_scope_create_peer_key = [provision_scope_peer_key], @marker_state = [state]
FROM [DataSync].[provision_marker_dss]
WHERE [object_id] = 1486628339 
 AND [owner_scope_local_id] = 0

MERGE [DataSync].[ProviderLocations_dss_tracking] AS [target] 
USING (SELECT [i].[ProviderId], [i].[LocationId] FROM DELETED AS [i]) AS source([ProviderId], [LocationId]) 
ON ([target].[ProviderId] = [source].[ProviderId] AND [target].[LocationId] = [source].[LocationId])
WHEN MATCHED THEN
UPDATE SET [sync_row_is_tombstone] = 1, 
[local_update_peer_key] = 0, 
[update_scope_local_id] = NULL, [last_change_datetime] = GETDATE()
WHEN NOT MATCHED THEN
INSERT (
[ProviderId], [LocationId] ,
[create_scope_local_id], [scope_create_peer_key], [scope_create_peer_timestamp], [local_create_peer_key], [local_create_peer_timestamp], [update_scope_local_id], [local_update_peer_key], [sync_row_is_tombstone], [last_change_datetime]) 
VALUES (
[source].[ProviderId], [source].[LocationId],@marker_create_scope_local_id, @marker_scope_create_peer_key, @marker_scope_create_peer_timestamp, 0, @marker_local_create_peer_timestamp , NULL, 0, 1, GETDATE() );
CREATE TRIGGER [provider].[ProviderLocations_dss_update_trigger] ON [provider].[ProviderLocations] FOR UPDATE AS
SET NOCOUNT ON
DECLARE @marker_create_scope_local_id INT
DECLARE @marker_scope_create_peer_timestamp BIGINT
DECLARE @marker_scope_create_peer_key INT
DECLARE @marker_local_create_peer_timestamp BIGINT
DECLARE @marker_local_create_peer_key INT
DECLARE @marker_state INT
SELECT TOP 1 @marker_create_scope_local_id = [provision_scope_local_id], @marker_local_create_peer_timestamp = [provision_timestamp], @marker_local_create_peer_key = [provision_local_peer_key], @marker_scope_create_peer_timestamp = [provision_scope_peer_timestamp], @marker_scope_create_peer_key = [provision_scope_peer_key], @marker_state = [state]
FROM [DataSync].[provision_marker_dss]
WHERE [object_id] = 1486628339 
 AND [owner_scope_local_id] = 0

MERGE [DataSync].[ProviderLocations_dss_tracking] AS [target] 
USING (SELECT [i].[ProviderId], [i].[LocationId] FROM INSERTED AS [i]) AS source([ProviderId], [LocationId]) 
ON ([target].[ProviderId] = [source].[ProviderId] AND [target].[LocationId] = [source].[LocationId])
WHEN MATCHED THEN
UPDATE SET [sync_row_is_tombstone] = 0, 
[local_update_peer_key] = 0, 
[update_scope_local_id] = NULL, [last_change_datetime] = GETDATE()
WHEN NOT MATCHED THEN
INSERT (
[ProviderId], [LocationId] ,
[create_scope_local_id], [scope_create_peer_key], [scope_create_peer_timestamp], [local_create_peer_key], [local_create_peer_timestamp], [update_scope_local_id], [local_update_peer_key], [sync_row_is_tombstone], [last_change_datetime]) 
VALUES (
[source].[ProviderId], [source].[LocationId],@marker_create_scope_local_id, @marker_scope_create_peer_key, @marker_scope_create_peer_timestamp, 0, @marker_local_create_peer_timestamp , NULL, 0, 0, GETDATE() );
CREATE TRIGGER [provider].[ProviderProfiles_dss_delete_trigger] ON [provider].[ProviderProfiles] FOR DELETE AS
SET NOCOUNT ON
DECLARE @marker_create_scope_local_id INT
DECLARE @marker_scope_create_peer_timestamp BIGINT
DECLARE @marker_scope_create_peer_key INT
DECLARE @marker_local_create_peer_timestamp BIGINT
DECLARE @marker_local_create_peer_key INT
DECLARE @marker_state INT
SELECT TOP 1 @marker_create_scope_local_id = [provision_scope_local_id], @marker_local_create_peer_timestamp = [provision_timestamp], @marker_local_create_peer_key = [provision_local_peer_key], @marker_scope_create_peer_timestamp = [provision_scope_peer_timestamp], @marker_scope_create_peer_key = [provision_scope_peer_key], @marker_state = [state]
FROM [DataSync].[provision_marker_dss]
WHERE [object_id] = 1518628453 
 AND [owner_scope_local_id] = 0

MERGE [DataSync].[ProviderProfiles_dss_tracking] AS [target] 
USING (SELECT [i].[ProviderId] FROM DELETED AS [i]) AS source([ProviderId]) 
ON ([target].[ProviderId] = [source].[ProviderId])
WHEN MATCHED THEN
UPDATE SET [sync_row_is_tombstone] = 1, 
[local_update_peer_key] = 0, 
[update_scope_local_id] = NULL, [last_change_datetime] = GETDATE()
WHEN NOT MATCHED THEN
INSERT (
[ProviderId] ,
[create_scope_local_id], [scope_create_peer_key], [scope_create_peer_timestamp], [local_create_peer_key], [local_create_peer_timestamp], [update_scope_local_id], [local_update_peer_key], [sync_row_is_tombstone], [last_change_datetime]) 
VALUES (
[source].[ProviderId],@marker_create_scope_local_id, @marker_scope_create_peer_key, @marker_scope_create_peer_timestamp, 0, @marker_local_create_peer_timestamp , NULL, 0, 1, GETDATE() );

CREATE TRIGGER [provider].[PriorAuthRequestsUpdates] ON  [provider].[PriorAuthRequests]
For Insert ,Update 
AS  
BEGIN
	INSERT INTO [provider].[PriorAuthRequestHistory](
	CaseNumber,
	NHMemberId,
	ServiceType,
	PriorAuthRequestData,
    PriorAuthPOCData,
    PriorAuthDiagnosysData,
    PriorAuthAudiometricData,
    PriorAuthDocumentationData,
    PriorAuthRequestTimelinessData,
	VerifiedBy ,
	CreateUser,
	CreateDate ,
	ModifyUser ,
	ModifyDate ,
	IsActive ,
	IsVerified ,
	IsApproved ,
	IsSubmitted )
	
	SELECT  [CaseNumber]
      ,[NHMemberId]
      ,[ServiceType]
      ,[PriorAuthRequestData]
      ,[PriorAuthPOCData]
      ,[PriorAuthDiagnosysData]
      ,[PriorAuthAudiometricData]
      ,[PriorAuthDocumentationData]
      ,[PriorAuthRequestTimelinessData]
      ,[VerifiedBy]
      ,[CreateUser]
      ,[CreateDate]
      ,[ModifyUser]
      ,[ModifyDate]
      ,[IsActive]
      ,[IsVerified]
      ,[IsApproved]
      ,[IsSubmitted]
  FROM INSERTED 
 
END
CREATE TRIGGER [provider].[PreServiceAuthRequestsUpdates] ON  [provider].[PreServiceAuthRequests]
For Insert ,Update 
AS  
BEGIN
	INSERT INTO [provider].[PreServiceAuthRequestHistory](
	CaseNumber,
	NHMemberId,
	ServiceType,
	PreServiceAuthRequestDetails,
	PreServiceAuthPOCData,
	PreServiceAuthDiagnosysData,
	PreServiceAuthRequestTimeliness ,
	PreServiceAuthDocumentData ,
	PriorAuthAudiometryData ,
	VerifiedBy ,
	CreateUser,
	CreateDate ,
	ModifyUser ,
	ModifyDate ,
	IsActive ,
	IsVerified ,
	IsApproved ,
	IsSubmitted )
	
	SELECT  [CaseNumber]
      ,[NHMemberId]
      ,[ServiceType]
      ,[PreServiceAuthRequestDetails]
      ,[PreServiceAuthPOCData]
      ,[PreServiceAuthDiagnosysData]
      ,[PreServiceAuthRequestTimeliness]
      ,[PreServiceAuthDocumentData]
      ,[PriorAuthAudiometryData]
      ,[VerifiedBy]
      ,[CreateUser]
      ,[CreateDate]
      ,[ModifyUser]
      ,[ModifyDate]
      ,[IsActive]
      ,[IsVerified]
      ,[IsApproved]
      ,[IsSubmitted]
  FROM INSERTED 
 
END








/****** Object:  StoredProcedure [provider].[GetProviderUserPermissions]    Script Date: 6/7/2019 2:31:13 PM ******/
SET ANSI_NULLS ON


CREATE VIEW [Reports].[Exchanges]
AS
SELECT   [Date]						= DT.xDate
		,[Member Name]				= a.[MemberName]
		,[Provider Name]			= a.[LegalBusinessName]
		,[Product Family]			= a.[LeftModelFamily]
		,[Product Line]				= a.[LeftProductLine]
		,[Model]					= a.[LeftModel]
		,[Style]					= a.[LeftModelStyle]
		,[Technology]				= a.[LeftTechnologyLevel]
		,[Quantity Returned]		= a.[LeftQuantity]+a.[RightQuantity]
		,[Return Reason Code]		= a.[ReturnReasonCode]
		,[Return Comments]			= a.[ReturnReason]
FROM (
    SELECT TOP (DATEDIFF(DAY,'20170101','20180331') + 1) 
            DATEADD(DD, ROW_NUMBER() OVER (ORDER BY (SELECT NULL))-1, '20170101') as [xDate]
    FROM syscolumns T1
    --CROSS                 Uncomment if you need more dates
    --JOIN syscolumns T2
)    DT
left
join 
(
	-- Get the min starttime for each nhmemberid
	select cast(OrderDate as date) as [date], 
		[MemberFirstName] + ' ' + [MemberLastName] as [MemberName], 
		[LegalBusinessName],
		[LeftModelFamily],
		[LeftProductLine],
		[LeftModel],
		[LeftModelStyle],
		[LeftTechnologyLevel],
		[LeftQuantity],
		[RightQuantity],
		[ReturnReasonCode],
		[ReturnReason]
	from [provider].[MemberOrderDetails]
	where IsProductReturned = 1
)   a on DT.xDate=a.date     


CREATE VIEW [Reports].[OutstandingCopay]
AS
SELECT   [Date]						= DT.xDate
		,[Member Name]				= a.[MemberName]
		,[Provider Name]			= a.[LegalBusinessName]
		,[Plan]						= a.[MemberInsuranceCarrier]
		,[Fitting Copay Outstanding]		= a.[FittingCopayOutstanding]
		,[Test Copay Outstanding]			= a.[HearingTestCopayOutstanding]
		,[Hearing Aid Copay Outstanding]	= a.[FittingCopayOutstanding]
FROM (
    SELECT TOP (DATEDIFF(DAY,'20170101','20180331') + 1) 
            DATEADD(DD, ROW_NUMBER() OVER (ORDER BY (SELECT NULL))-1, '20170101') as [xDate]
    FROM syscolumns T1
    --CROSS                 Uncomment if you need more dates
    --JOIN syscolumns T2
)    DT
left
join 
(
	-- Get the min starttime for each nhmemberid
	select cast(OrderDate as date) as [date], 
		[MemberFirstName] + ' ' + [MemberLastName] as [MemberName], 
		[LegalBusinessName],
		[MemberInsuranceCarrier],
		[HearingTestCopayOutstanding],
		[HearingAidCopayOutstanding],
		[FittingCopayOutstanding]
	from [provider].[MemberOrderDetails]
	where cast(OrderDate as date) is not null and ([HearingTestCopayOutstanding] != 0 or [HearingAidCopayOutstanding] != 0 or [FittingCopayOutstanding] != 0)
)   a on DT.xDate=a.date     


CREATE VIEW [Reports].[MonthlySales]
AS
SELECT   DT.xDate
		,[Total Members Ordered]		= ISNULL(MA.[Members Ordered], 0)
		,[Total Members Fitted]			= ISNULL(MB.[Members Fitted], 0)
		,[Total Members Returned]		= ISNULL(MC.[Members Returned], 0)
		,[Total Units Ordered]			= ISNULL(DA.[Units Ordered], 0)
		,[Total Units Fitted]			= ISNULL(DD.[Units Fitted], 0)
		,[Total Units Returned]			= ISNULL(DG.[Units Returned], 0)
		,[Beltone Units Ordered]		= ISNULL(DB.[Beltone Ordered], 0)
		,[Resound Units Ordered]		= ISNULL(DC.[Resound Ordered], 0)
		,[Beltone Units Fitted]			= ISNULL(DE.[Beltone Units Fitted], 0)
		,[Resound Units Fitted]			= ISNULL(DF.[Resound Units Fitted], 0)
		,[Beltone Units Returned]		= ISNULL(DH.[Beltone Units Returned], 0)
		,[Resound Units Returned]		= ISNULL(DI.[Resound Units Returned], 0)
		 --Members Ordered --
		,[CVS Beltone Members]					= ISNULL(c_bm.[CVS Beltone Members], 0)
		,[CVS Resound Members]					= ISNULL(c_rm.[CVS Resound Members], 0)
		,[Humana Beltone Members]				= ISNULL(h_bm.[Humana Beltone Members], 0)
		,[Humana Resound Members]				= ISNULL(h_rm.[Humana Resound Members], 0)
		,[Ultimate Beltone Members]				= ISNULL(u_bm.[Ultimate Beltone Members], 0)
		,[Ultimate Resound Members]				= ISNULL(u_rm.[Ultimate Resound Members], 0)
		,[Health Alliance Beltone Members]		= ISNULL(ha_bm.[Health Alliance Beltone Members], 0)
		,[Health Alliance Resound Members]		= ISNULL(ha_rm.[Health Alliance Resound Members], 0)
		,[Central Health Beltone Members]		= ISNULL(ch_bm.[Central Health Beltone Members], 0)
		,[Central Health Resound Members]		= ISNULL(ch_rm.[Central Health Resound Members], 0)
		,[Health Net Beltone Members]			= ISNULL(hn_bm.[Health Net Beltone Members], 0)
		,[Health Net Resound Members]			= ISNULL(hn_rm.[Health Net Resound Members], 0)
		--,[DTC Beltone Members]					= ISNULL()
		--,[DTC Resound Members]					= ISNULL()
		,[BCBS Beltone Members]					= ISNULL(bc_bm.[BCBS Beltone Members], 0)
		,[BCBS Resound Members]					= ISNULL(bc_rm.[BCBS Resound Members], 0)
		,[EON Beltone Members]					= ISNULL(e_bm.[EON Beltone Members], 0)
		,[EON Resound Members]					= ISNULL(e_rm.[EON Resound Members], 0)
		 --Units Ordered --
		,[CVS Beltone Ordered]					= ISNULL(c_bo.[CVS Beltone Ordered], 0)
		,[CVS Resound Ordered]					= ISNULL(c_ro.[CVS Resound Ordered], 0)
		,[Humana Beltone Ordered]				= ISNULL(h_bo.[Humana Beltone Ordered], 0)
		,[Humana Resound Ordered]				= ISNULL(h_ro.[Humana Resound Ordered], 0)
		,[Ultimate Beltone Ordered]				= ISNULL(u_bo.[Ultimate Beltone Ordered], 0)
		,[Ultimate Resound Ordered]				= ISNULL(u_ro.[Ultimate Resound Ordered], 0)
		,[Health Alliance Beltone Ordered]		= ISNULL(ha_bo.[Health Alliance Beltone Ordered], 0)
		,[Health Alliance Resound Ordered]		= ISNULL(ha_ro.[Health Alliance Resound Ordered], 0)
		,[Central Health Beltone Ordered]		= ISNULL(ch_bo.[Central Health Beltone Ordered], 0)
		,[Central Health Resound Ordered]		= ISNULL(ch_ro.[Central Health Resound Ordered], 0)
		,[Health Net Beltone Ordered]			= ISNULL(hn_bo.[Health Net Beltone Ordered], 0)
		,[Health Net Resound Ordered]			= ISNULL(hn_ro.[Health Net Resound Ordered], 0)
		--,[DTC Beltone Ordered]					= ISNULL()
		--,[DTC Resound Ordered]					= ISNULL()
		,[BCBS Beltone Ordered]					= ISNULL(bc_bo.[BCBS Beltone Ordered], 0)
		,[BCBS Resound Ordered]					= ISNULL(bc_ro.[BCBS Resound Ordered], 0)
		,[EON Beltone Ordered]					= ISNULL(e_bo.[EON Beltone Ordered], 0)
		,[EON Resound Ordered]					= ISNULL(e_ro.[EON Resound Ordered], 0)
		--,[CVS Units Ordered]						=
		--,[Humana Units Ordered]					=
		--,[Ultimate Units Ordered]					=
		--,[Health Alliance Units Ordered]			=
		--,[Central Health Units Ordered]			=
		--,[Health Net Units Ordered]				=
		--,[DTC Units Ordered]						=
		--,[BCBS Units Ordered]						=
		--,[CVS Units Fitted]						=
		--,[Humana Units Fitted]					=
		--,[Ultimate Units Fitted]					=
		--,[Health Alliance Units Fitted]			=
		--,[Central Health Units Fitted]			=
		--,[Health Net Units Fitted]				=
		--,[DTC Units Fitted]						=
		--,[BCBS FEP Units Fitted]					=
		--,[CVS Units Returned]						=
		--,[Humana Units Returned]					=
		--,[Ultimate Units Returned]				=
		--,[Health Alliance Units Returned]			=
		--,[Central Health Units Returned]			=
		--,[Health Net Units Returned]				=
		--,[DTC Units Returned]						=
		--,[BCBS Units Returned]					= 

FROM (
    SELECT TOP (DATEDIFF(DAY,'20170101','20180331') + 1) 
            DATEADD(DD, ROW_NUMBER() OVER (ORDER BY (SELECT NULL))-1, '20170101') as [xDate]
    FROM syscolumns T1
    --CROSS                 Uncomment if you need more dates
    --JOIN syscolumns T2
)    DT
left
join 
(
	select cast(OrderDate as date) as [orderdate], sum(LeftQuantity + RightQuantity) as [Units Ordered]
	from [provider].[MemberOrderDetails]
	where cast(OrderDate as date) is not null
	group by cast(OrderDate as date)
)               DA ON DT.xDate = DA.[orderdate]
left 
join 
(
	select cast(FittingOrDeliveryDate as date) as [fittingdate], sum(LeftQuantity + RightQuantity) as [Units Fitted]
	from [provider].[MemberOrderDetails]
	where cast(FittingOrDeliveryDate as date) is not null
	group by cast(FittingOrDeliveryDate as date)
)				DD ON DT.xDate = DD.[fittingdate]
left 
join 
(
	select cast(ReturnDate as date) as [returndate], sum(LeftQuantity + RightQuantity) as [Units Returned]
	from [provider].[MemberOrderDetails]
	where cast(ReturnDate as date) is not null
	group by cast(ReturnDate as date)
)				DG ON DT.xDate = DG.[returndate]
left 
join 
(
	select cast(OrderDate as date) as [orderdate], count(distinct MemberFirstName + MemberLastName) as [Members Ordered]
	from [provider].[MemberOrderDetails]
	where cast(OrderDate as date) is not null
	group by cast(OrderDate as date)
	having sum(LeftQuantity + RightQuantity) > 0
)				MA ON DT.xDate = MA.[orderdate]
left 
join 
(
	select cast(FittingOrDeliveryDate as date) as [fittingdate], count(distinct MemberFirstName + MemberLastName) as [Members Fitted]
	from [provider].[MemberOrderDetails]
	where cast(FittingOrDeliveryDate as date) is not null
	group by cast(FittingOrDeliveryDate as date)
	having sum(LeftQuantity + RightQuantity) > 0 and cast(FittingOrDeliveryDate as date) is not null
)				MB ON DT.xDate = MB.[fittingdate]
left 
join 
(
	select cast(ReturnDate as date) as [returndate], count(distinct MemberFirstName + MemberLastName) as [Members Returned]
	from [provider].[MemberOrderDetails]
	where cast(ReturnDate as date) is not null
	group by cast(ReturnDate as date)
	having sum(LeftQuantity + RightQuantity) > 0 and cast(ReturnDate as date) is not null
)				MC ON DT.xDate = MC.[returndate]
left 
join 
(
	select cast(OrderDate as date) as [orderdate], sum(LeftQuantity + RightQuantity) as [Beltone Ordered]
	from [provider].[MemberOrderDetails]
	where Brand = 'Beltone' and cast(OrderDate as date) is not null
	group by cast(OrderDate as date)
)				DB ON DT.xDate = DB.[orderdate]
left 
join 
(
	select cast(OrderDate as date) as [orderdate], sum(LeftQuantity + RightQuantity) as [Resound Ordered]
	from [provider].[MemberOrderDetails]
	where Brand = 'Resound' and cast(OrderDate as date) is not null
	group by cast(OrderDate as date)
)				DC ON DT.xDate = DC.[orderdate]
left 
join 
(
	select cast(FittingOrDeliveryDate as date) as [fittingdate], sum(LeftQuantity + RightQuantity) as [Beltone Units Fitted]
	from [provider].[MemberOrderDetails]
	where Brand = 'Beltone' and cast(FittingOrDeliveryDate as date) is not null
	group by cast(FittingOrDeliveryDate as date)
)				DE ON DT.xDate = DE.[fittingdate]
left 
join 
(
	select cast(FittingOrDeliveryDate as date) as [fittingdate], sum(LeftQuantity + RightQuantity) as [Resound Units Fitted]
	from [provider].[MemberOrderDetails]
	where Brand = 'Resound' and cast(FittingOrDeliveryDate as date) is not null
	group by cast(FittingOrDeliveryDate as date)
)				DF ON DT.xDate = DF.[fittingdate]
left 
join 
(
	select cast(ReturnDate as date) as [returndate], sum(LeftQuantity + RightQuantity) as [Beltone Units Returned]
	from [provider].[MemberOrderDetails]
	where Brand = 'Beltone' and ReturnDate is not null
	group by cast(ReturnDate as date)
)				DH ON DT.xDate = DH.[returndate]
left 
join 
(
	select cast(ReturnDate as date) as [returndate], sum(LeftQuantity + RightQuantity) as [Resound Units Returned]
	from [provider].[MemberOrderDetails]
	where Brand = 'Resound' and ReturnDate is not null
	group by cast(ReturnDate as date)
)				DI ON DT.xDate = DI.[returndate]

/**** CVS ****/
left
join 
(
	select cast(OrderDate as date) as [orderdate], sum(LeftQuantity + RightQuantity) as [CVS Units Ordered]
	from [provider].[MemberOrderDetails]
	where MemberInsuranceCarrier like '%Silverscript%' and cast(OrderDate as date) is not null
	group by cast(OrderDate as date)
)               c_uo ON DT.xDate = c_uo.[orderdate]
left 
join 
(
	select cast(OrderDate as date) as [orderdate], sum(LeftQuantity + RightQuantity) as [CVS Beltone Ordered]
	from [provider].[MemberOrderDetails]
	where Brand = 'Beltone' and MemberInsuranceCarrier like '%Silverscript%' and cast(OrderDate as date) is not null
	group by cast(OrderDate as date)
)				c_bo ON DT.xDate = c_bo.[orderdate]
left 
join 
(
	select cast(OrderDate as date) as [orderdate], sum(LeftQuantity + RightQuantity) as [CVS Resound Ordered]
	from [provider].[MemberOrderDetails]
	where Brand = 'Resound' and MemberInsuranceCarrier like '%Silverscript%' and cast(OrderDate as date) is not null
	group by cast(OrderDate as date)
)				c_ro ON DT.xDate = c_ro.[orderdate]
left 
join 
(
	select cast(OrderDate as date) as [orderdate], count(distinct MemberFirstName + MemberLastName) as [CVS Beltone Members]
	from [provider].[MemberOrderDetails]
	where Brand = 'Beltone' and MemberInsuranceCarrier like '%Silverscript%' and cast(OrderDate as date) is not null
	group by cast(OrderDate as date)
)				c_bm ON DT.xDate = c_bm.[orderdate]
left 
join 
(
	select cast(OrderDate as date) as [orderdate], count(distinct MemberFirstName + MemberLastName) as [CVS Resound Members]
	from [provider].[MemberOrderDetails]
	where Brand = 'Resound' and MemberInsuranceCarrier like '%Silverscript%' and cast(OrderDate as date) is not null
	group by cast(OrderDate as date)
)				c_rm ON DT.xDate = c_rm.[orderdate]
/**** ****/

/**** Humana ****/
left
join 
(
	select cast(OrderDate as date) as [orderdate], sum(LeftQuantity + RightQuantity) as [Humana Units Ordered]
	from [provider].[MemberOrderDetails]
	where MemberInsuranceCarrier like '%Humana%' and cast(OrderDate as date) is not null
	group by cast(OrderDate as date)
)               h_uo ON DT.xDate = h_uo.[orderdate]
left 
join 
(
	select cast(OrderDate as date) as [orderdate], sum(LeftQuantity + RightQuantity) as [Humana Beltone Ordered]
	from [provider].[MemberOrderDetails]
	where Brand = 'Beltone' and MemberInsuranceCarrier like '%Humana%' and cast(OrderDate as date) is not null
	group by cast(OrderDate as date)
)				h_bo ON DT.xDate = h_bo.[orderdate]
left 
join 
(
	select cast(OrderDate as date) as [orderdate], sum(LeftQuantity + RightQuantity) as [Humana Resound Ordered]
	from [provider].[MemberOrderDetails]
	where Brand = 'Resound' and MemberInsuranceCarrier like '%Humana%' and cast(OrderDate as date) is not null
	group by cast(OrderDate as date)
)				h_ro ON DT.xDate = h_ro.[orderdate]
left 
join 
(
	select cast(OrderDate as date) as [orderdate], count(distinct MemberFirstName + MemberLastName) as [Humana Beltone Members]
	from [provider].[MemberOrderDetails]
	where Brand = 'Beltone' and MemberInsuranceCarrier like '%Humana%' and cast(OrderDate as date) is not null
	group by cast(OrderDate as date)
)				h_bm ON DT.xDate = h_bm.[orderdate]
left 
join 
(
	select cast(OrderDate as date) as [orderdate], count(distinct MemberFirstName + MemberLastName) as [Humana Resound Members]
	from [provider].[MemberOrderDetails]
	where Brand = 'Resound' and MemberInsuranceCarrier like '%Humana%' and cast(OrderDate as date) is not null
	group by cast(OrderDate as date)
)				h_rm ON DT.xDate = h_rm.[orderdate]
/**** ****/

/**** Ultimate ****/
left
join 
(
	select cast(OrderDate as date) as [orderdate], sum(LeftQuantity + RightQuantity) as [Ultimate Units Ordered]
	from [provider].[MemberOrderDetails]
	where MemberInsuranceCarrier like '%Ultimate%' and cast(OrderDate as date) is not null
	group by cast(OrderDate as date)
)               u_uo ON DT.xDate = u_uo.[orderdate]
left 
join 
(
	select cast(OrderDate as date) as [orderdate], sum(LeftQuantity + RightQuantity) as [Ultimate Beltone Ordered]
	from [provider].[MemberOrderDetails]
	where Brand = 'Beltone' and MemberInsuranceCarrier like '%Ultimate%' and cast(OrderDate as date) is not null
	group by cast(OrderDate as date)
)				u_bo ON DT.xDate = u_bo.[orderdate]
left 
join 
(
	select cast(OrderDate as date) as [orderdate], sum(LeftQuantity + RightQuantity) as [Ultimate Resound Ordered]
	from [provider].[MemberOrderDetails]
	where Brand = 'Resound' and MemberInsuranceCarrier like '%Ultimate%' and cast(OrderDate as date) is not null
	group by cast(OrderDate as date)
)				u_ro ON DT.xDate = u_ro.[orderdate]
left 
join 
(
	select cast(OrderDate as date) as [orderdate], count(distinct MemberFirstName + MemberLastName) as [Ultimate Beltone Members]
	from [provider].[MemberOrderDetails]
	where Brand = 'Beltone' and MemberInsuranceCarrier like '%Ultimate%' and cast(OrderDate as date) is not null
	group by cast(OrderDate as date)
)				u_bm ON DT.xDate = u_bm.[orderdate]
left 
join 
(
	select cast(OrderDate as date) as [orderdate], count(distinct MemberFirstName + MemberLastName) as [Ultimate Resound Members]
	from [provider].[MemberOrderDetails]
	where Brand = 'Resound' and MemberInsuranceCarrier like '%Ultimate%' and cast(OrderDate as date) is not null
	group by cast(OrderDate as date)
)				u_rm ON DT.xDate = u_rm.[orderdate]
/**** ****/

/**** Health Alliance ****/
left
join 
(
	select cast(OrderDate as date) as [orderdate], sum(LeftQuantity + RightQuantity) as [Health Alliance Units Ordered]
	from [provider].[MemberOrderDetails]
	where MemberInsuranceCarrier like '%Health Alliance%' and cast(OrderDate as date) is not null
	group by cast(OrderDate as date)
)               ha_uo ON DT.xDate = ha_uo.[orderdate]
left 
join 
(
	select cast(OrderDate as date) as [orderdate], sum(LeftQuantity + RightQuantity) as [Health Alliance Beltone Ordered]
	from [provider].[MemberOrderDetails]
	where Brand = 'Beltone' and MemberInsuranceCarrier like '%Health Alliance%' and cast(OrderDate as date) is not null
	group by cast(OrderDate as date)
)				ha_bo ON DT.xDate = ha_bo.[orderdate]
left 
join 
(
	select cast(OrderDate as date) as [orderdate], sum(LeftQuantity + RightQuantity) as [Health Alliance Resound Ordered]
	from [provider].[MemberOrderDetails]
	where Brand = 'Resound' and MemberInsuranceCarrier like '%Health Alliance%' and cast(OrderDate as date) is not null
	group by cast(OrderDate as date)
)				ha_ro ON DT.xDate = ha_ro.[orderdate]
left 
join 
(
	select cast(OrderDate as date) as [orderdate], count(distinct MemberFirstName + MemberLastName) as [Health Alliance Beltone Members]
	from [provider].[MemberOrderDetails]
	where Brand = 'Beltone' and MemberInsuranceCarrier like '%Health Alliance%' and cast(OrderDate as date) is not null
	group by cast(OrderDate as date)
)				ha_bm ON DT.xDate = ha_bm.[orderdate]
left 
join 
(
	select cast(OrderDate as date) as [orderdate], count(distinct MemberFirstName + MemberLastName) as [Health Alliance Resound Members]
	from [provider].[MemberOrderDetails]
	where Brand = 'Resound' and MemberInsuranceCarrier like '%Health Alliance%' and cast(OrderDate as date) is not null
	group by cast(OrderDate as date)
)				ha_rm ON DT.xDate = ha_rm.[orderdate]
/**** ****/

/**** Central Health ****/
left
join 
(
	select cast(OrderDate as date) as [orderdate], sum(LeftQuantity + RightQuantity) as [Central Health Units Ordered]
	from [provider].[MemberOrderDetails]
	where MemberInsuranceCarrier like '%Central Health%' and cast(OrderDate as date) is not null
	group by cast(OrderDate as date)
)               ch_uo ON DT.xDate = ch_uo.[orderdate]
left 
join 
(
	select cast(OrderDate as date) as [orderdate], sum(LeftQuantity + RightQuantity) as [Central Health Beltone Ordered]
	from [provider].[MemberOrderDetails]
	where Brand = 'Beltone' and MemberInsuranceCarrier like '%Central Health%' and cast(OrderDate as date) is not null
	group by cast(OrderDate as date)
)				ch_bo ON DT.xDate = ch_bo.[orderdate]
left 
join 
(
	select cast(OrderDate as date) as [orderdate], sum(LeftQuantity + RightQuantity) as [Central Health Resound Ordered]
	from [provider].[MemberOrderDetails]
	where Brand = 'Resound' and MemberInsuranceCarrier like '%Central Health%' and cast(OrderDate as date) is not null
	group by cast(OrderDate as date)
)				ch_ro ON DT.xDate = ch_ro.[orderdate]
left 
join 
(
	select cast(OrderDate as date) as [orderdate], count(distinct MemberFirstName + MemberLastName) as [Central Health Beltone Members]
	from [provider].[MemberOrderDetails]
	where Brand = 'Beltone' and MemberInsuranceCarrier like '%Central Health%' and cast(OrderDate as date) is not null
	group by cast(OrderDate as date)
)				ch_bm ON DT.xDate = ch_bm.[orderdate]
left 
join 
(
	select cast(OrderDate as date) as [orderdate], count(distinct MemberFirstName + MemberLastName) as [Central Health Resound Members]
	from [provider].[MemberOrderDetails]
	where Brand = 'Resound' and MemberInsuranceCarrier like '%Central Health%' and cast(OrderDate as date) is not null
	group by cast(OrderDate as date)
)				ch_rm ON DT.xDate = ch_rm.[orderdate]
/**** ****/

/**** Health Net ****/
left
join 
(
	select cast(OrderDate as date) as [orderdate], sum(LeftQuantity + RightQuantity) as [Health Net Units Ordered]
	from [provider].[MemberOrderDetails]
	where MemberInsuranceCarrier like '%Health Net%' and cast(OrderDate as date) is not null
	group by cast(OrderDate as date)
)               hn_uo ON DT.xDate = hn_uo.[orderdate]
left 
join 
(
	select cast(OrderDate as date) as [orderdate], sum(LeftQuantity + RightQuantity) as [Health Net Beltone Ordered]
	from [provider].[MemberOrderDetails]
	where Brand = 'Beltone' and MemberInsuranceCarrier like '%Health Net%' and cast(OrderDate as date) is not null
	group by cast(OrderDate as date)
)				hn_bo ON DT.xDate = hn_bo.[orderdate]
left 
join 
(
	select cast(OrderDate as date) as [orderdate], sum(LeftQuantity + RightQuantity) as [Health Net Resound Ordered]
	from [provider].[MemberOrderDetails]
	where Brand = 'Resound' and MemberInsuranceCarrier like '%Health Net%' and cast(OrderDate as date) is not null
	group by cast(OrderDate as date)
)				hn_ro ON DT.xDate = hn_ro.[orderdate]
left 
join 
(
	select cast(OrderDate as date) as [orderdate], count(distinct MemberFirstName + MemberLastName) as [Health Net Beltone Members]
	from [provider].[MemberOrderDetails]
	where Brand = 'Beltone' and MemberInsuranceCarrier like '%Health Net%' and cast(OrderDate as date) is not null
	group by cast(OrderDate as date)
)				hn_bm ON DT.xDate = hn_bm.[orderdate]
left 
join 
(
	select cast(OrderDate as date) as [orderdate], count(distinct MemberFirstName + MemberLastName) as [Health Net Resound Members]
	from [provider].[MemberOrderDetails]
	where Brand = 'Resound' and MemberInsuranceCarrier like '%Health Net%' and cast(OrderDate as date) is not null
	group by cast(OrderDate as date)
)				hn_rm ON DT.xDate = hn_rm.[orderdate]
/**** ****/

/**** BCBS ****/
left
join 
(
	select cast(OrderDate as date) as [orderdate], sum(LeftQuantity + RightQuantity) as [BCBS Units Ordered]
	from [provider].[MemberOrderDetails]
	where MemberInsuranceCarrier like '%BCBS%' and cast(OrderDate as date) is not null
	group by cast(OrderDate as date)
)               bc_uo ON DT.xDate = bc_uo.[orderdate]
left 
join 
(
	select cast(OrderDate as date) as [orderdate], sum(LeftQuantity + RightQuantity) as [BCBS Beltone Ordered]
	from [provider].[MemberOrderDetails]
	where Brand = 'Beltone' and MemberInsuranceCarrier like '%BCBS%' and cast(OrderDate as date) is not null
	group by cast(OrderDate as date)
)				bc_bo ON DT.xDate = bc_bo.[orderdate]
left 
join 
(
	select cast(OrderDate as date) as [orderdate], sum(LeftQuantity + RightQuantity) as [BCBS Resound Ordered]
	from [provider].[MemberOrderDetails]
	where Brand = 'Resound' and MemberInsuranceCarrier like '%BCBS%' and cast(OrderDate as date) is not null
	group by cast(OrderDate as date)
)				bc_ro ON DT.xDate = bc_ro.[orderdate]
left 
join 
(
	select cast(OrderDate as date) as [orderdate], count(distinct MemberFirstName + MemberLastName) as [BCBS Beltone Members]
	from [provider].[MemberOrderDetails]
	where Brand = 'Beltone' and MemberInsuranceCarrier like '%BCBS%' and cast(OrderDate as date) is not null
	group by cast(OrderDate as date)
)				bc_bm ON DT.xDate = bc_bm.[orderdate]
left 
join 
(
	select cast(OrderDate as date) as [orderdate], count(distinct MemberFirstName + MemberLastName) as [BCBS Resound Members]
	from [provider].[MemberOrderDetails]
	where Brand = 'Resound' and MemberInsuranceCarrier like '%BCBS%' and cast(OrderDate as date) is not null
	group by cast(OrderDate as date)
)				bc_rm ON DT.xDate = bc_rm.[orderdate]
/**** ****/

/**** EON ****/
left
join 
(
	select cast(OrderDate as date) as [orderdate], sum(LeftQuantity + RightQuantity) as [EON Units Ordered]
	from [provider].[MemberOrderDetails]
	where MemberInsuranceCarrier like '%EON%' and cast(OrderDate as date) is not null
	group by cast(OrderDate as date)
)               e_uo ON DT.xDate = e_uo.[orderdate]
left 
join 
(
	select cast(OrderDate as date) as [orderdate], sum(LeftQuantity + RightQuantity) as [EON Beltone Ordered]
	from [provider].[MemberOrderDetails]
	where Brand = 'Beltone' and MemberInsuranceCarrier like '%EON%' and cast(OrderDate as date) is not null
	group by cast(OrderDate as date)
)				e_bo ON DT.xDate = e_bo.[orderdate]
left 
join 
(
	select cast(OrderDate as date) as [orderdate], sum(LeftQuantity + RightQuantity) as [EON Resound Ordered]
	from [provider].[MemberOrderDetails]
	where Brand = 'Resound' and MemberInsuranceCarrier like '%EON%' and cast(OrderDate as date) is not null
	group by cast(OrderDate as date)
)				e_ro ON DT.xDate = e_ro.[orderdate]
left 
join 
(
	select cast(OrderDate as date) as [orderdate], count(distinct MemberFirstName + MemberLastName) as [EON Beltone Members]
	from [provider].[MemberOrderDetails]
	where Brand = 'Beltone' and MemberInsuranceCarrier like '%EON%' and cast(OrderDate as date) is not null
	group by cast(OrderDate as date)
)				e_bm ON DT.xDate = e_bm.[orderdate]
left 
join 
(
	select cast(OrderDate as date) as [orderdate], count(distinct MemberFirstName + MemberLastName) as [EON Resound Members]
	from [provider].[MemberOrderDetails]
	where Brand = 'Resound' and MemberInsuranceCarrier like '%EON%' and cast(OrderDate as date) is not null
	group by cast(OrderDate as date)
)				e_rm ON DT.xDate = e_rm.[orderdate]
/**** ****/

CREATE VIEW [Reports].[PostSaleDocs]
AS
SELECT   [Date]						= DT.xDate
		,[Member Name]				= a.[MemberName]
		,[Provider Name]			= a.[LegalBusinessName]
		,[Insurance Plan]			= a.[MemberInsuranceCarrier]
		,[Provider Address]			= a.[ProviderLocation]
		,case when a.[HIPPAFlag] = 1 then 'Yes' else 'No' end as [HIPAA Received]
		,case when a.[AudiogramFlag] = 1 then 'Yes' else 'No' end as [Audiogram Received]
		,case when a.[DeliveryReceiptFlag] = 1 then 'Yes' else 'No' end as [Delivery Receipt Received]
		,case when a.[PaymentAuthorizationFlag] = 1 then 'Yes' else 'No' end as [Payment Authorization Received]
		,case when a.[PurchaseAgreementFlag] = 1 then 'Yes' else 'No' end as [Purchase Agreement Received]
FROM (
    SELECT TOP (DATEDIFF(DAY,'20170101','20180331') + 1) 
            DATEADD(DD, ROW_NUMBER() OVER (ORDER BY (SELECT NULL))-1, '20170101') as [xDate]
    FROM syscolumns T1
    --CROSS                 Uncomment if you need more dates
    --JOIN syscolumns T2
)    DT
left
join 
(
	-- Get the min starttime for each nhmemberid
	select cast(OrderDate as date) as [date], 
		[MemberFirstName] + ' ' + [MemberLastName] as [MemberName], 
		[LegalBusinessName],
		[MemberInsuranceCarrier],
		([ProviderAddress] + ' ' + [ProviderCity] + ', ' + [ProviderState] + ' ' + [ProviderZipCode]) as [ProviderLocation],
		[HIPPAFlag],
		[AudiogramFlag],
		[PaymentAuthorizationFlag],
		[PurchaseAgreementFlag],
		[DeliveryReceiptFlag]
	from [provider].[MemberOrderDetails]
)   a on DT.xDate=a.date     


CREATE VIEW [Reports].[CashCollected]
AS
SELECT   DT.xDate
		,[CVS Cash Collected]				= ISNULL(DA.[CVS Cash Collected], 0)
		,[Humana Cash Collected]			= ISNULL(DB.[Humana Cash Collected], 0)
		,[Ultimate Cash Collected]			= ISNULL(DC.[Ultimate Cash Collected], 0)
		,[EON Cash Collected]				= ISNULL(DD.[EON Cash Collected], 0)
		,[Health Alliance Cash Collected]	= ISNULL(DE.[Health Alliance Cash Collected], 0)
		,[Central Cash Collected]			= ISNULL(DF.[Central Cash Cash Collected], 0)
		,[Health Net Cash Collected]		= ISNULL(DG.[Health Net Cash Collected], 0)
		,[BCBS Cash Collected]				= ISNULL(DH.[BCBS Cash Collected], 0)
FROM (
    SELECT TOP (DATEDIFF(DAY,'20170101','20180331') + 1) 
            DATEADD(DD, ROW_NUMBER() OVER (ORDER BY (SELECT NULL))-1, '20170101') as [xDate]
    FROM syscolumns T1
    --CROSS                 Uncomment if you need more dates
    --JOIN syscolumns T2
)    DT
left
join 
(
	select cast(OrderDate as date) as [orderdate], sum(AmountPaid) as [CVS Cash Collected]
	from [provider].[MemberOrderDetails]
	where MemberInsuranceCarrier like '%Silverscript%'
	group by cast(OrderDate as date)
)               DA ON DT.xDate = DA.[orderdate]
left
join 
(
	select cast(OrderDate as date) as [orderdate], sum(AmountPaid) as [Humana Cash Collected]
	from [provider].[MemberOrderDetails]
	where MemberInsuranceCarrier like '%Humana%'
	group by cast(OrderDate as date)
)               DB ON DT.xDate = DB.[orderdate]
left
join 
(
	select cast(OrderDate as date) as [orderdate], sum(AmountPaid) as [Ultimate Cash Collected]
	from [provider].[MemberOrderDetails]
	where MemberInsuranceCarrier like '%Ultimate%'
	group by cast(OrderDate as date)
)               DC ON DT.xDate = DC.[orderdate]
left
join 
(
	select cast(OrderDate as date) as [orderdate], sum(AmountPaid) as [EON Cash Collected]
	from [provider].[MemberOrderDetails]
	where MemberInsuranceCarrier like '%EON%'
	group by cast(OrderDate as date)
)               DD ON DT.xDate = DD.[orderdate]
left
join 
(
	select cast(OrderDate as date) as [orderdate], sum(AmountPaid) as [Health Alliance Cash Collected]
	from [provider].[MemberOrderDetails]
	where MemberInsuranceCarrier like '%Health Alliance%'
	group by cast(OrderDate as date)
)               DE ON DT.xDate = DE.[orderdate]
left
join 
(
	select cast(OrderDate as date) as [orderdate], sum(AmountPaid) as [Central Cash Cash Collected]
	from [provider].[MemberOrderDetails]
	where MemberInsuranceCarrier like '%Central Health%'
	group by cast(OrderDate as date)
)               DF ON DT.xDate = DF.[orderdate]
left
join 
(
	select cast(OrderDate as date) as [orderdate], sum(AmountPaid) as [Health Net Cash Collected]
	from [provider].[MemberOrderDetails]
	where MemberInsuranceCarrier like '%Health Net%'
	group by cast(OrderDate as date)
)               DG ON DT.xDate = DG.[orderdate]
left
join 
(
	select cast(OrderDate as date) as [orderdate], sum(AmountPaid) as [BCBS Cash Collected]
	from [provider].[MemberOrderDetails]
	where MemberInsuranceCarrier like '%BCBS%'
	group by cast(OrderDate as date)
)               DH ON DT.xDate = DH.[orderdate]
create view Reports.EonEligData as
select 
MemberID
,MemberInsuranceID
,[Member ID] [InsuranceNbr]
,[HICN] HICN
,[Member Last Name] [LastName]
,[Member First Name] [FirstName]
,[DOB] [DateOfBirth]
,[Gender] [Gender]
,[Residence Address 1] [Address1]
,[Residence Address 2] [Address2]
,[Residence City] [City]
,[Residence State] [State]
,[Residence Zip Code] [ZipCode]
,[Residence County] [Country]
,[Correspodence Address1] [MailAddress1]
,[Correspodence Address2] [MailAddress2]
,[Correspondence City] [MailCity]
,[Correspondence State] [MailState]
,[Correspondence Zip Code] [MailZipCode]
,[Phone Number] [PhoneNbr]
,[Effective Date] [InsuranceEffectiveDate]
,case [Termination Date] when '' then '20991231' else  [Termination Date] end [InsuranceEndDate]
,[Contract ID]
,[PBP]
,[Primary language]
from [vsdatamig].[EON_ELIG_DATA1] e
LEFT OUTER JOIN  vsdatamig.EonCRMMembersRef r 
on (e.[Member ID] = r.insurancenbr)
Create procedure [ReportsData].[POReportByMonth]
AS
select Carrier, DATENAME(month,PODATE) + DATENAME(year,PODATE) as 'MonthYY', sum(qty) as 'DevicesQTY', count(*) as 'Orders'  from [ReportsData].[viewPOReport]
where Carrier is not null and PODATE is not null
group by Carrier, DATENAME(month,PODATE) + DATENAME(year,PODATE)
order by Carrier, DATENAME(month,PODATE) + DATENAME(year,PODATE)


CREATE VIEW [ReportsData].[viewPOReport]
AS
SELECT  
        o.NHMemberID,
		o.orderid as 'OrderNumber',
		CONVERT(varchar(10), o.[DateOrderReceived],101) as 'OrderRcvdDate',
		CONVERT(varchar(10), o.[DateOrderInitiated],101) as 'OrderCreatedDate',
        o.[OrderType],
		o.[Status],
--case  when UPPER(JSON_VALUE(O.MEMBERDATA, '$.insurance.programeName')) <>'' then  UPPER(JSON_VALUE(O.MEMBERDATA, '$.insurance.programeName'))
--	  else UPPER(JSON_VALUE(O.MEMBERDATA, '$.insurance.carrierName')) end REFERENCECARRIERNAME, 
	    JSON_VALUE(O.MEMBERDATA, '$.insurance.carrierName') as 'Carrier',
		JSON_VALUE(O.MEMBERDATA, '$.insurance.planName') as 'Plan',
		--JSON_VALUE([MemberData],'$.firstName') + ' ' +JSON_VALUE([MemberData],'$.lastName') AS [MemberName],
		----JSON_VALUE([MemberData],'$.address.state') AS [STATE],
		----JSON_VALUE([ProviderData],'$.dispenser') AS [DISPENSING NUMBER],
		--JSON_VALUE([ProviderData],'$.providerLeagalBusinessName') AS [ProviderLegalName],	
		--JSON_VALUE([ProviderData],'$.address.address') AS [ProviderAddress],
		--JSON_VALUE([ProviderData],'$.address.city') AS [ProviderCity], 
		--JSON_VALUE([ProviderData],'$.address.state') AS [ProviderState],
		--JSON_VALUE([ProviderData],'$.address.zip') AS [ProviderZip],
		--JSON_VALUE([ShippingData],'$.dba') AS [ShippingDBA],
		--JSON_VALUE([ShippingData],'$.dispenser') AS [ShippingDispenser],
		[BrandCode] As [Manufacturer] ,
		[FamilyCode] As [Family],
		[TechnologyLevelCode] [Product],
		--P.FAMILYPRODUCTCATCODE [TechnologyLevel],
		[DeviceCount] as 'Qty', 
		--P.[PerDeviceCOGSPrice] as 'COGS',
		--CAST(JSON_VALUE([OrderAmountData],'$.insuranceBenefit') as INT) [BenefitAmount],
		--CAST(JSON_VALUE([OrderAmountData],'$.productPrice') as INT)  AS [ProductPrice],
		----JSON_VALUE([OrderAmountData],'$.benefitUsed') AS [Benefit Used],
		--CAST(JSON_VALUE([OrderAmountData],'$.benefitAvailable') as INT) AS [BenefitAvailable],
		--CAST(JSON_VALUE([OrderAmountData],'$.memberResponsibility') as INT) AS [MemberResponsibleAmount],
		--CONVERT(varchar(10), PAY.[Transaction Date],101) as 'PaymentDate',
		--PAY.paymentType 'PaymentMode',
  --      (case  when PAY.cardOrBank is null and PAY.paymentType = 'ACH' then 'ACH' 
 	--           when PAY.cardOrBank is null and PAY.paymentType = 'Finance' then PAY.financeCompany
	 --          else PAY.cardOrBank
  --      end) 'PaymentType',
		--CAST(PAY.[Payment Amount] as INT) 'Payment',
		--(CAST(JSON_VALUE([OrderAmountData],'$.memberResponsibility') as INT) - CAST(PAY.[Payment Amount] as INT)) as 'MemberDue',
		CONVERT(varchar(10),PO.[PO DATE]) as 'PODate', 
		PO.PONumber as 'PONumber'
		--CLM.[Fitting Date] as 'FittingDate' ,
		--CLM.[Fitting Documents Received Date] as 'FittingDocRcvdDate', 
		--CLM.[Claim Required] as 'ClaimRequired',
		--P.[PerDeviceDispensingFee] [FittingFeePerDevice],
		--(P.[PerDeviceDispensingFee] * [DeviceCount]) as 'TotalFittingFee',
		--CLM.[Claim Amount],
		--JSON_VALUE(O.MEMBERDATA, '$.insurance.carrierName') + ':' + JSON_VALUE([MemberData],'$.firstName') + ' ' +JSON_VALUE([MemberData],'$.lastName') as 'QBJobName'
from
Orders.Orders O with (NOLOCK)

--LEFT OUTER JOIN
--(
--SELECT ORDERID,
--			JSON_VALUE([OrderTransactionData],'$.fitingDate') AS [Fitting Date],
--			JSON_VALUE([OrderTransactionData],'$.purchaseDate') AS [Fitting Documents Received Date],
--			JSON_VALUE([OrderTransactionData],'$.isClaimSubmitted') AS [Claim Required],JSON_VALUE([OrderTransactionData],'$.copayDues.hfCopayDue') AS [Fitting Fee],
--			JSON_VALUE([OrderTransactionData],'$.claimAmount') AS [Claim Amount]
--FROM 
--	[Orders].[OrderTransactionDetails] OD1 with (NOLOCK)
--	where OD1.OrderStatusCode='CLM' and IsActive=1
--)CLM ON (O.ORDERID = CLM.ORDERID)

--LEFT OUTER JOIN
--(
--SELECT  ORDERID,
--JSON_VALUE([OrderTransactionData],'$.transactions[0].paymentDate') [Transaction Date],
--JSON_VALUE([OrderTransactionData],'$.transactions[0].paymentType')[paymentType],
--JSON_VALUE([OrderTransactionData],'$.transactions[0].amountPaid') [Payment Amount],
--JSON_VALUE([OrderTransactionData],'$.transactions[0].cardOrBank') [cardOrBank],
--JSON_VALUE([OrderTransactionData],'$.transactions[0].formInputDetails.financeCompany') [financeCompany]
--from
--[Orders].[OrderTransactionDetails] OD3 with (NOLOCK)
--	 where OD3.OrderStatusCode='PAY' and IsActive=1
--)PAY ON (O.ORDERID = PAY.ORDERID) 
LEFT OUTER JOIN
(
SELECT ORDERID,
	JSON_VALUE(od4.[OrderTransactionData],'$.poDate') AS [PO DATE], JSON_VALUE(od4.[OrderTransactionData],'$.poNumber') AS PONumber
from	[Orders].[OrderTransactionDetails] OD4 with (NOLOCK)
 where OD4.OrderStatusCode='PO' and IsActive=1 
 )PO
 	ON (O.ORDERID = PO.ORDERID) 

--LEFT OUTER JOIN 
--(
--	SELECT X.* 
--	FROM 
--	(
--		SELECT FAMILYPRODUCTCATCODE, FAMILYPRODUCTCODE,[PerDeviceCOGSPrice],[PerDeviceDispensingFee],
--			ROW_NUMBER() OVER(PARTITION BY FAMILYPRODUCTCODE ORDER BY CONTRACTPRODUCTID DESC) RN
--		FROM INSURANCE.CONTRACTPRODUCTS) X 
--		WHERE X.RN = 1
--	) P 
--ON O.TECHNOLOGYLEVELCODE = P.FAMILYPRODUCTCODE
where 
--[MemberData] is not null and [MemberData] <>''
--and 
IsActive=1 
--and 
----and o.[CreateDate] > '03/23/2018' and o.[OrderId] > 180015000
--CONVERT(nvarchar(10), JSON_VALUE(od4.[OrderTransactionData],'$.poDate')) > '03/01/2018'



CREATE VIEW [ReportsData].GrievanceTracker
AS
	  select
	MemberName [Beneficiary Name]
	,cast(ComplaintReceivedDateTime as date) [Date Grievance Received]
	,MemberPhone [Beneficiary Phone]
	,InsurancePlanID [Card Holder ID]
	,MemberState [State]
	,case when MemberRepName = '' or MemberRepName is null then 'B' else 'BR' end as [Person who made the request: Beneficiary (B) or Beneficiary Representative (BR)]
	,'Oral' [Oral or Written]
	--,GrievanceCategory
	,ComplaintDescription [Grievance/Complaint Description]
	,GrievanceUpdateDescription [Research/Resolution Description]
  FROM [grievance].[MemberComplaints]


CREATE VIEW [ReportsData].[4_CRMOrders_Candice]
AS

select
	a.OrderID
	,a.NHMemberId
	,ins.insuranceCarrierName	'Insurance Carrier Name'
	,b.FirstName			'First Name'
	,b.LastName				'Last Name'
    ,case when a.ordersource = 'VS' then convert(varchar,approvals.approvedDate, 101) else approvals.createddate end	'Date Approved'
	,approvals.approvedBy	'Approved By'
	,a.OrderStatusCode		'Status Code'
	,a.OrderType			'Order Type'
	,a.Status				'Status'
	,pos.PONumber			'PONumber'
	,a.DeviceCount			'Device Count'
	,a.BrandCode			'Brand'
	,od.productPrice		'Product Price'
from orders.Orders a with (nolock) 
	outer apply openjson(case when ISJSON(a.MemberData) = 1 then a.MemberData else '{}' end) with (
		insuranceCarrierName	varchar(300)	'$.insurance.carrierName'
		,insurancePlanName		varchar(300)	'$.insurance.planName'
		,programName			varchar(300)	'$.insurance.programeName'
		,insCarrierId			int
	) as md
	outer apply openjson(a.OrderAmountData) with (
		productPrice			decimal
		,insuranceBenefit		int
		,benefitUsed			int
		,benefitAvailable		int
		,memberResponsibility	decimal
	) as od
	outer apply openjson(a.LeftEarOrderData) with (
		color			varchar(50)
		,batterySize	varchar(10)
		,receiverSize	varchar(10)
		,receiverPower	varchar(20)
		,earMold		bit
	) as leod
	outer apply openjson(a.RightEarOrderData) with (
		color			varchar(50)
		,batterySize	varchar(10)
		,receiverSize	varchar(10)
		,receiverPower	varchar(20)
		,earMold		bit
	) as reod
	outer apply openjson(a.ShippingData) with (
		providerBusinessName	varchar(200)
		,dba					varchar(200)
		,dispenser				varchar(50)
		,address1				varchar(200) '$.address.address1'
		,address2				varchar(50) '$.address.address2'
		,city					varchar(100) '$.address.city'
		,state					varchar(10)	'$.address.state'
		,zip					varchar(10) '$.address.zip'
		,email					varchar(100)
		,phoneNumber			varchar(15)
		,shippingInstructions	varchar(400)
	) as ship
	outer apply openjson(case when a.ProviderData = '' then '{}' else a.ProviderData end) with (
		providerLeagalBusinessName		varchar(200)
		,dba							varchar(200)
		,dispenser						varchar(50)
		,state							varchar(2)		'$.address.state'
		,zip							varchar(10)		'$.address.zip'
		,providerId						bigint
	) as prov 
left outer join Insurance.InsuranceCarriers ins with (nolock) on ins.InsuranceCarrierId = md.insCarrierId
left outer join provider.memberprofiles b with (nolock) on a.NHMemberId = b.NHMemberId
left outer join (
	select OrderId, d.hipaa, d.aob, d.audiogram, d.hipaaReceivedDate, d.aobReceivedDate, d.audiogramReceivedDate
	from Orders.OrderTransactionDetails a with (nolock) 
	outer apply OPENJSON(a.OrderTransactionData) with (   
              hipaa					varchar(10),  
              hipaaReceivedDate     datetime2,
              aob					varchar(10),  
              aobReceivedDate		datetime2,
              audiogram				varchar(10),  
              audiogramReceivedDate datetime2
	) as [d]
	where OrderStatusCode = 'DOC'
) docs on a.orderid = docs.OrderID
left outer join (
	select OrderId, d.orderConfirmationNo, d.receivedBy, d.receivedDate, d.leftHearingAidSerialNumber, d.rightHearingAidSerialNumber, d.hearingAidManufacturerInvoiceNumber, d.hearingAidInvoiceDate, d.manufacturerInvoiceNumber, d.invoiceDate
	from orders.OrderTransactionDetails a with (nolock)
	outer apply OpenJson(a.OrderTransactionData) with (
		orderConfirmationNo		varchar(20)
		,receivedBy					varchar(100)
		,receivedDate				datetime2
		,leftHearingAidSerialNumber	varchar(20)
		,rightHearingAidSerialNumber	varchar(20)
		,hearingAidManufacturerInvoiceNumber	varchar(20)
		,hearingAidInvoiceDate		datetime2
		,manufacturerInvoiceNumber	varchar(20)
		,invoiceDate				datetime2
	) as d
	where OrderStatusCode = 'SHI'
) shpdetails on a.orderid = shpdetails.orderid
left outer join (
	select orderid, d.hearingTestCopayDue, d.hearingAidCopayDue, d.fittingCopayDue, d.hearingTestHCPCSCodes, d.claimSubmitDate, d.claimSubmittedBy, d.deliveryReceipt, d.purchaseAgreementReceived, d.claimAmount, d.benefitAmount, d.fittingDate
	from orders.OrderTransactionDetails a with (nolock)
	outer apply openjson(a.OrderTransactionData) with (
		claimSubmitDate				datetime2
		,claimSubmittedBy			varchar(100)
		,isClaimSubmitted			bit
		,claimAmount				int
		,benefitAmount				int
		,isComplete					bit
		,deliveryReceipt			bit
		,purchaseAgreementReceived	bit
		,hearingTestCopayDue		decimal '$.copayDues.htCopayDue'
		,hearingAidCopayDue			decimal '$.copayDues.haCopayDue'
		,fittingCopayDue			decimal '$.copayDues.hfCopayDue'
		,hearingTestHCPCSCodes		nvarchar(max) '$.hcpcs.htHCPCS'
		,fittingDate				datetime2
	) as d
		--cross apply openjson(d.hearingTestHCPCSCodes) with (
			--hcpcs varchar(10) '$'
		--) as htHCPCS
	where OrderStatusCode = 'CLM'
) claims on a.orderid = claims.orderid 
left outer join (
	select orderid, d.approvedBy, d.approvedDate, convert(varchar, DATEADD(HH,-5,createdate) , 101) createddate
	from orders.OrderTransactionDetails a with (nolock)
	outer apply openjson(a.OrderTransactionData) with (
		approvedBy		varchar(100)
		,approvedDate	datetime
		,comments		varchar(200)
	) as d
	where OrderStatusCode = 'APP'
) approvals on a.orderid = approvals.orderid
left outer join (
	select orderid, d.poDate, d.poNumber
	from orders.OrderTransactionDetails a with (nolock)
	outer apply openjson(a.OrderTransactionData) with (
		poDate			datetime2
		,poSentDate		datetime2
		,poNumber		varchar(50)
	) as d
	where OrderStatusCode = 'PO'
) pos on a.orderid = pos.orderid
left outer join (
	select PONumber, OrderStatus from [Orders].[MemberOrdersVStoCRM] with (nolock)
) vanilla on pos.poNumber = vanilla.PONumber


--SELECT * FROM [ReportsData].[7_viewAccountingNEW2]

CREATE VIEW [ReportsData].[7_viewAccountingNEW2_R]
AS

SELECT  
   --     (case when O.Status = 'ALAN' then 'BAD'
		 --else 'GOOD'
		 --end) as 'Record',
        o.NHMemberID,
		o.orderid AS 'OrderNumber',
		--o.orderSource AS 'OrderSource', RAj
		o.Source AS 'OrderSource',
		DS.DataSource AS 'EligSource',
		CONVERT(VARCHAR(10), o.[DateOrderReceived],101) AS 'OrderRcvdDate',
		CONVERT(VARCHAR(10), o.[DateOrderInitiated],101) AS 'OrderCreatedDate',
		o.[OrderType],
        (CASE WHEN o.[OrderType] IN ('EXCHANGE','LSRD') THEN o.[OrderType] +'( of order:' +CAST(o.[RefOrderId] AS VARCHAR) + ')'
		 ELSE o.[OrderType]
		 END) 'OrderRef',
		o.[Status],
	    (CASE WHEN JSON_VALUE(O.MEMBERDATA, '$.insurance.carrierName') = 'None' OR 
		           JSON_VALUE(O.MEMBERDATA, '$.insurance.carrierName') = '' THEN 
		     JSON_VALUE(O.MEMBERDATA, '$.insurance.programeName')
			 ELSE JSON_VALUE(O.MEMBERDATA, '$.insurance.carrierName')
	    END) AS 'Carrier',
		JSON_VALUE(O.MEMBERDATA, '$.insurance.planName') AS 'Plan',
		JSON_VALUE([MemberData],'$.firstName') AS [MemberFirstName],
		JSON_VALUE([MemberData],'$.lastName') AS [MemberLastName],
		JSON_VALUE([ProviderData],'$.providerId') AS [ProviderID],
		JSON_VALUE([ProviderData],'$.providerLeagalBusinessName') AS [ProviderLegalName],	
		JSON_VALUE([ProviderData],'$.dba') AS [ProviderDBA],
		JSON_VALUE([ProviderData],'$.dispenser') AS [ProviderDispenser],
		JSON_VALUE([ProviderData],'$.address.address') AS [ProviderAddress],
		JSON_VALUE([ProviderData],'$.address.city') AS [ProviderCity], 
		JSON_VALUE([ProviderData],'$.address.state') AS [ProviderState],
		JSON_VALUE([ProviderData],'$.address.zip') AS [ProviderZip],
		JSON_VALUE([ShippingData],'$.dba') AS [ShippingDBA],
		JSON_VALUE([ShippingData],'$.dispenser') AS [ShippingDispenser],
		[BrandCode] AS [Manufacturer] ,
		[FamilyCode] AS [Family],
		[TechnologyLevelCode] [Product],
		P.FAMILYPRODUCTCATCODE [TechnologyLevel],
		[DeviceCount] AS 'Qty', 
		P.[PerDeviceCOGSPrice] AS 'COGS',
		P.[PerDeviceCOGSPrice] * [DeviceCount] AS 'TotalCOGS',
		(CASE WHEN CAST(JSON_VALUE([OrderAmountData],'$.insuranceBenefit') AS NVARCHAR(10)) IS NULL THEN 0 
		 ELSE CAST(JSON_VALUE([OrderAmountData],'$.insuranceBenefit') AS DECIMAL)
		 END) [BenefitAmount],
		(CASE WHEN CAST(JSON_VALUE([OrderAmountData],'$.productPrice') AS NVARCHAR(10)) IS NULL THEN 0 
		 ELSE CAST(JSON_VALUE([OrderAmountData],'$.productPrice') AS DECIMAL)
		 END) AS [ProductPrice],
		--JSON_VALUE([OrderAmountData],'$.benefitUsed') AS [Benefit Used],
		(CASE WHEN CAST(JSON_VALUE([OrderAmountData],'$.benefitAvailable') AS NVARCHAR(10)) IS NULL THEN 0
		 ELSE CAST(JSON_VALUE([OrderAmountData],'$.benefitAvailable') AS DECIMAL)
		 END) AS [BenefitAvailable],
		 (CASE WHEN CAST(JSON_VALUE([OrderAmountData],'$.adjustments') AS NVARCHAR(10)) IS NULL THEN 0 
		 ELSE CAST(JSON_VALUE([OrderAmountData],'$.adjustments') AS DECIMAL)
		 END) AS [AdjustmentAmount],
		 (CASE WHEN CAST(JSON_VALUE([OrderAmountData],'$.itemsTotal') AS NVARCHAR(10)) IS NULL THEN 0 
                    ELSE CAST(JSON_VALUE([OrderAmountData],'$.itemsTotal') AS DECIMAL)
        END) AS [ItemTotal],
		(CASE WHEN CAST(JSON_VALUE([OrderAmountData],'$.exchangeCredit') AS NVARCHAR(10)) IS NULL THEN 0 
                    ELSE CAST(JSON_VALUE([OrderAmountData],'$.exchangeCredit') AS DECIMAL)
        END) AS [exchangeCredit],
		  (CASE WHEN CAST(JSON_VALUE([OrderAmountData],'$.cancelCredit') AS NVARCHAR(10)) IS NULL THEN 0 
                                                       ELSE CAST(JSON_VALUE([OrderAmountData],'$.cancelCredit') AS DECIMAL)
                                         END) AS [cancelCredit],
		(CASE WHEN CAST(JSON_VALUE([OrderAmountData],'$.memberResponsibility') AS NVARCHAR(10)) IS NULL THEN 0 
		 ELSE CAST(JSON_VALUE([OrderAmountData],'$.memberResponsibility') AS DECIMAL)
		 END) AS [MemberResponsibleAmount],

		(CASE WHEN CAST(PAY.[PaymentAmount1] AS DECIMAL) + CAST(PAY.[PaymentAmount2] AS DECIMAL) + CAST(PAY.[PaymentAmount3] AS DECIMAL) IS NULL THEN 0 
		      ELSE CAST(PAY.[PaymentAmount1] AS DECIMAL) + CAST(PAY.[PaymentAmount2] AS DECIMAL) + CAST(PAY.[PaymentAmount3] AS DECIMAL)
		 END) 'MemberPayment',
		(CASE WHEN CONVERT(VARCHAR(10), PO.[PO DATE],101) IS NULL THEN '' 
		      ELSE CONVERT(VARCHAR(10), PO.[PO DATE],101) 
		 END) AS 'PODate',
		(CASE WHEN PO.PONumber IS NULL THEN ''
		  ELSE PO.PONumber
		 END) AS 'PONumber',
		(CASE WHEN CLM.[Fitting Date] IS NULL THEN '' 
		      ELSE CLM.[Fitting Date]
	     END) AS 'FittingDate' ,
		(CASE WHEN CLM.[PurchaseDate] IS NULL THEN '' 
		 ELSE CLM.[PurchaseDate]
		 END) AS 'PurchaseAgreementDate', 
		 (CASE WHEN CLM.[DeliveryDate] IS NULL THEN '' 
		 ELSE CLM.[DeliveryDate]
		 END) AS 'DeliveryRcptDate', 
		 (CASE WHEN   CONVERT(VARCHAR(10), RET.[Return Date],101) IS NULL THEN '' ELSE
		      CONVERT(VARCHAR(10), RET.[Return Date] ,101)
		  END) AS 'ReturnDate',
		(CASE WHEN CLM.[Claim Required] IS NULL THEN '' ELSE
		      CLM.[Claim Required]
		  END) AS 'ClaimRequired',
		P.[PerDeviceDispensingFee] [FittingFeePerDevice],
		(P.[PerDeviceDispensingFee] * [DeviceCount]) AS 'TotalFittingFee',
		(CASE WHEN CAST(CLM.[ClaimAmount] AS NVARCHAR(10)) IS NULL THEN '0' 
		      ELSE CAST(CLM.[ClaimAmount] AS NVARCHAR(10))
		 END) 'ClaimAmount',
		JSON_VALUE(O.MEMBERDATA, '$.insurance.carrierName') + ':' + JSON_VALUE([MemberData],'$.firstName') + ' ' +JSON_VALUE([MemberData],'$.lastName') AS 'QBJobName'
FROM
(
SELECT s.* , oi.BrandCode, oi.FamilyCode, oi.StyleCode, oi.TechnologyLevelCode, oi.ProductModelCode, oi.ItemCode, oq.DeviceCount
  FROM orders.orders s
INNER JOIN 
(
		SELECT DISTINCT orderid, BrandCode, FamilyCode, StyleCode, TechnologyLevelCode, ProductModelCode, ItemCode
		FROM orders.OrderItems
		WHERE 1 = 1
		AND ItemType IN ('HA') 
		AND IsActive = 1
		) oi ON (oi.orderid = s.orderid)
INNER JOIN 
(
		SELECT orderid, SUM(Quantity) DeviceCount
		FROM orders.OrderItems
		WHERE 1 = 1
		AND ItemType IN ('HA','CROS') 
		AND IsActive = 1
		--AND Status = 'ACTIVE'
		GROUP BY ORDERID
		) oq ON (oq.orderid = s.orderid)
		)  O
 LEFT OUTER JOIN
(
SELECT ORDERID,[OrderTransactionData],
			(CASE WHEN CONVERT(VARCHAR(10),JSON_VALUE([OrderTransactionData],'$.fittingDate'),101)  = '01/01/0001' THEN ''
			      WHEN CONVERT(VARCHAR(10),JSON_VALUE([OrderTransactionData],'$.fittingDate'),101) IS NULL THEN ''
			 ELSE CONVERT(VARCHAR(10),JSON_VALUE([OrderTransactionData],'$.fittingDate'),101)
			 END)  AS [Fitting Date],
            JSON_VALUE([OrderTransactionData],'$.purchaseAgreementReceived') AS [PurchaseAgreementRcvd],
			(CASE WHEN CONVERT(VARCHAR(10),JSON_VALUE([OrderTransactionData],'$.purchaseDate'),101) IS NULL THEN '' 
			 ELSE CONVERT(VARCHAR(10),JSON_VALUE([OrderTransactionData],'$.purchaseDate'),101) 
			 END) AS [PurchaseDate],
			 JSON_VALUE([OrderTransactionData],'$.deliveryReceipt') AS [DeliveryReceiptRcvd],
			(CASE WHEN CONVERT(VARCHAR(10),JSON_VALUE([OrderTransactionData],'$.deliveryDate'),101) IS NULL THEN '' 
			 ELSE CONVERT(VARCHAR(10),JSON_VALUE([OrderTransactionData],'$.deliveryDate'),101) 
			 END) AS [DeliveryDate],
			JSON_VALUE([OrderTransactionData],'$.isClaimSubmitted') AS [Claim Required],
			--JSON_VALUE([OrderTransactionData],'$.copayDues.hfCopayDue') AS [Fitting Fee],
			(CASE WHEN JSON_VALUE([OrderTransactionData],'$.claimAmount') IS NULL THEN '0'
			 ELSE JSON_VALUE([OrderTransactionData],'$.claimAmount') 
			 END) AS [ClaimAmount]
FROM 
	[Orders].[OrderTransactionDetails] OD1 WITH (NOLOCK)
	WHERE OD1.OrderStatusCode='CLM' AND IsActive=1
)CLM ON (O.ORDERID = CLM.ORDERID)
LEFT OUTER JOIN
(
SELECT CAST(JSON_VALUE(Ordertransactiondata,'$.returnDt') AS DATE) [Return Date],ORDERID
FROM 
	[Orders].[OrderTransactionDetails] OD1 WITH (NOLOCK)
	WHERE OD1.OrderStatusCode='RET' AND IsActive=1
)RET ON (O.ORDERID = RET.ORDERID)
LEFT OUTER JOIN
(
SELECT  ORDERID,
--JSON_VALUE([OrderTransactionData],'$.transactions[0].paymentDate') [Transaction Date],
--JSON_VALUE([OrderTransactionData],'$.transactions[0].paymentType')[paymentType],
(CASE 
     WHEN JSON_VALUE([OrderTransactionData],'$.transactions[0].amountPaid') IS NULL THEN 0
	 ELSE CAST(JSON_VALUE([OrderTransactionData],'$.transactions[0].amountPaid')  AS DECIMAL)
END) [PaymentAmount1],
(CASE 
     WHEN JSON_VALUE([OrderTransactionData],'$.transactions[1].amountPaid') IS NULL THEN 0
	 ELSE CAST(JSON_VALUE([OrderTransactionData],'$.transactions[1].amountPaid') AS DECIMAL)
END) [PaymentAmount2],
(CASE 
     WHEN JSON_VALUE([OrderTransactionData],'$.transactions[2].amountPaid') IS NULL THEN 0
	 ELSE CAST(JSON_VALUE([OrderTransactionData],'$.transactions[2].amountPaid') AS DECIMAL)
END) [PaymentAmount3],
(CASE 
     WHEN JSON_VALUE([OrderTransactionData],'$.transactions[3].amountPaid') IS NULL THEN 0
	 ELSE CAST(JSON_VALUE([OrderTransactionData],'$.transactions[3].amountPaid') AS DECIMAL)
END) [PaymentAmount4]
--JSON_VALUE([OrderTransactionData],'$.transactions[0].cardOrBank') [cardOrBank],
--JSON_VALUE([OrderTransactionData],'$.transactions[0].formInputDetails.financeCompany') [financeCompany]
FROM
[Orders].[OrderTransactionDetails] OD3 WITH (NOLOCK)
	 WHERE OD3.OrderStatusCode='PAY' AND IsActive=1
)PAY ON (O.ORDERID = PAY.ORDERID) 
LEFT OUTER JOIN
(
SELECT ORDERID,
	JSON_VALUE(od4.[OrderTransactionData],'$.poDate') AS [PO DATE], JSON_VALUE(od4.[OrderTransactionData],'$.poNumber') AS PONumber
FROM	[Orders].[OrderTransactionDetails] OD4 WITH (NOLOCK)
 WHERE OD4.OrderStatusCode='PO' AND IsActive=1
 )PO
 	ON (O.ORDERID = PO.ORDERID) 

LEFT OUTER JOIN Insurance.HealthPlanContracts B ON B.InsuranceHealthPlanID = JSON_VALUE(O.MEMBERDATA, '$.insPlanId')
LEFT OUTER JOIN (SELECT DISTINCT FAMILYPRODUCTCATCODE, FAMILYPRODUCTCODE, HealthPlanContractID, [PerDeviceCOGSPrice],[PerDeviceDispensingFee] 
     FROM INSURANCE.CONTRACTPRODUCTS) P ON O.TECHNOLOGYLEVELCODE = P.FAMILYPRODUCTCODE AND P.HealthPlanContractId = B.HealthPlanContractId

INNER JOIN [Master].[Members] DS WITH (NOLOCK) ON DS.[NHMemberID] = O.NHMemberID AND DS.IsActive=1

WHERE 
O.IsActive=1 
AND O.Status <> 'ALAN'



CREATE VIEW  [ReportsData].[viewMemberInfoRpt1]
 AS
    
select distinct 
		provider.MemberProfiles.NHMemberId  [NHMemberId]
		,case 
			when (Insurance.InsuranceCarriers.InsuranceCarrierName like '%none%' or Insurance.InsuranceCarriers.InsuranceCarrierName is null) then 'None'
			else Insurance.InsuranceCarriers.InsuranceCarrierName end as [Program Name]
		,callconversations.lastcalltime_est                                                         [Last Time Called]
		,callconversations.firstcalltime_est                                         [First Time Called]
		,callevents.eventname															[Latest Disposition]
		,callevents.ParentEventName															[Parent Disposition]
		,provider.MemberProfiles.FirstName                                                     [First Name]
		,provider.MemberProfiles.LastName                                                     [Last Name]
		,case when provider.MemberProfiles.DateOfBirth = CONVERT(datetime2, '0001-01-01 00:00:00.0000000') then NULL else cast(provider.MemberProfiles.DateOfBirth as date) end as DOB
		,case when Insurance.InsuranceCarriers.InsuranceCarrierName like '%none%' or Insurance.InsuranceCarriers.InsuranceCarrierName is null then '' else provider.MemberInsuranceDetails.InsuranceNbr end as [Member Insurance ID]
		,case when ContractBenefits.BenefitAmt is NULL then 0 else ContractBenefits.BenefitAmt end             [Benefit Amount]
		,COALESCE(memberlocations.Address1, ' ') + ' ' + COALESCE(memberlocations.Address2, ' ') Address
		,memberlocations.City                                                                                              [City]
		,memberlocations.State                                                                                           [State]
		,memberlocations.ZipCode                                                                                      [ZipCode]
		,[Member Phone Number] = (select top 1 phonenumber from provider.memberphonenumbers where provider.memberphonenumbers.memberprofileid = provider.memberprofiles.memberprofileid and isActive = 1 and (phonetypeid= 1 or phonetypeid = 4))
		,provider.AppointmentTypes.AppointmentTypeName      [Appointment Type Name]
		,cast(MemberAppointments.StartDate as Date)                 [Latest Appt Date]
		,cast(MemberAppointments.CreateDate as Date)              [Date Appt was Created]
		,MemberAppointments.AppointmentStatus                                        [Appt Status]
		,case when MemberAppointments.WalkIn = 1 then 'True' else 'False' end as [Walk-In]
		,provider.ProviderProfiles.ProviderId ProviderId
		,provider.ProviderProfiles.Brands                                                           [Manufacturer]
		,provider.ProviderProfiles.ProviderName                                             [Provider Name]
		,provider.Locations.BusinessName                                                         [Legal Business Name]
		,[provider].Locations.LocationEmailAddress            [Email Address]
		,provider.Locations.LocationId LocationId
		,provider.Locations.[Dispenser]                                                               [Dispenser #]
		,[Provider Phone Number] = (select top 1 phonenumber from  provider.locationphonenumbers where locationphonenumbers.locationid = provider.locations.locationid and phonetypeid = 1)
		,[Provider Fax Number] = (select top 1 phonenumber from  provider.locationphonenumbers where locationphonenumbers.locationid = provider.locations.locationid and phonetypeid = 3)
		,COALESCE(provider.Locations.Address1, ' ') + ' ' + COALESCE(provider.Locations.Address2, ' ') AS [Provider Address]
		,provider.Locations.City                                                                            [Provider City]
		,provider.Locations.State                                                                                         [Provider State]
		,provider.Locations.Zip as                                                                                       [Provider Zipcode]
		,provider.MemberProfiles.CreateUser                                                   [Add User]
		,provider.MemberProfiles.ModifyUser                                                  [Modify User]
		,[vsdatamig].[DMContacts].[AddUserNameLastFirst]         [VS Add User]
		,[vsdatamig].[DMContacts].Contactid                                                   [VS Contact Id]
    from 
		(
			select nhmemberid, max(id) id, max(lastcalltime_est) lastcalltime_est, min(firstcalltime_est) firstcalltime_est
			from
			(
				select nhmemberid
					,case when ModifyUser <> 'VanillaSoft' then dateadd(hour, -5, lastcalltime) else lastcalltime end as lastcalltime_est
					,case when ModifyUser <> 'VanillaSoft' then dateadd(hour, -5, firstCalltime) else firstCalltime end as firstcalltime_est
					,id
				from
				(
					select  
						MemberNHMemberId as NHmemberId
						,max(StartTime) lastCalltime
						,min(StartTime) firstCalltime
						,max(callconversationid) id
						,ModifyUser
					from callcenter.CallConversations
					where 
						IsActive = 1
					group by MemberNHMemberId, ModifyUser
				) sometable
			) sometable2
			group by nhmemberid
		) callconversations
		LEFT OUTER JOIN (
			select
				callconversationid,
				max(evnts.EventName) eventname,
				max(parentevnts.EventName) ParentEventName
			from callcenter.callpageevents cpe
			inner join (select * from jobs.events where EventTriggerBy = 'disposition') evnts on evnts.eventid = cpe.EventId
			left join (select * from jobs.events where EventTriggerBy = 'disposition') parentevnts on (parentevnts.eventid = evnts.ParentEventId and evnts.ParentEventId is not null)
			group by callconversationid
		) callevents on callevents.callconversationid = callconversations.id
		LEFT OUTER JOIN provider.MemberProfiles with (nolock) ON provider.MemberProfiles.NHmemberid = callconversations.nhmemberid
		LEFT OUTER JOIN 
		(
			select MemberProfileId, carrid as InsuranceCarrierId, planid as InsuranceHealthPlanId, insid as MemberInsuranceId
			from
			(
				select memberprofileid, max(memberinsuranceid) insid, max(insurancecarrierid) carrid, max(insurancehealthplanid) planid
				from provider.MemberInsurances
				where UseForBenefits = 1 and isactive = 1
				group by MemberProfileId
			union all
				select memberprofileid, max(memberinsuranceid) insid, max(insurancecarrierid) carrid, max(insurancehealthplanid) planid
				from provider.MemberInsurances
				where UseForBenefits = 0 and isactive = 1 and MemberProfileId not in
				(
					select memberprofileid
					from provider.MemberInsurances
					where UseForBenefits = 1 and isactive = 1
					group by MemberProfileId
				)
				group by MemberProfileId
			) ub
		) memberinsurances ON provider.MemberProfiles.MemberProfileId = memberinsurances.MemberProfileId
		LEFT OUTER JOIN provider.MemberInsuranceDetails with (nolock) ON provider.MemberInsuranceDetails.MemberInsuranceId = memberinsurances.MemberInsuranceId
		LEFT OUTER JOIN Insurance.InsuranceCarriers with (nolock) ON memberinsurances.InsuranceCarrierId = Insurance.InsuranceCarriers.InsuranceCarrierId
		LEFT OUTER JOIN (
			SELECT [HealthPlanContractID]
					,[InsuranceCarrierID]
					,[InsuranceHealthPlanID]
			FROM [Insurance].[HealthPlanContracts] with (nolock) 
		) HealthPlanContracts ON memberinsurances.InsuranceCarrierId = HealthPlanContracts.[InsuranceCarrierID]
			AND memberinsurances.InsuranceHealthPlanId = HealthPlanContracts.[InsuranceHealthPlanID]
		LEFT OUTER JOIN (
			SELECT  [BenefitAmt]
                    ,[HealthPlanContractID]
			FROM [Insurance].[ContractBenefits] with (nolock) 
		) ContractBenefits ON HealthPlanContracts.HealthPlanContractId = ContractBenefits.[HealthPlanContractID]
		LEFT OUTER JOIN
		(
			select MemberLocationId
					,Address1
					,Address2
					,AddressTypeId
					,City
					,IsActive
					,MemberProfileId
					,State
					,ZipCode
			from provider.MemberLocations a with (nolock) 
			where
				IsActive = 1
				--and AddressTypeId = 1
				and MemberLocationId = 
				(
					select min(memberlocationid) 
					from provider.MemberLocations 
					where 
						MemberProfileId = a.MemberProfileId
				)
		) memberlocations ON provider.MemberProfiles.MemberProfileId = memberlocations.MemberProfileId 
		LEFT OUTER JOIN provider.MemberCharts charts with (nolock) on charts.MemberProfileId = provider.MemberProfiles.MemberProfileId
		LEFT OUTER JOIN
		(
			select a.*, z.memberchartid, d.locationid, d.providerid
			from provider.MemberAppointments a with (nolock)
			inner join provider.memberchartdata d on a.memberchartdataid = d.memberchartdataid
			inner join provider.membercharts z on z.memberchartid = d.memberchartid
			where
				a.IsActive = 1
			and memberappointmentid = (
				select max(memberappointmentid)
				from provider.MemberAppointments b with (nolock)
				inner join provider.memberchartdata c on b.memberchartdataid = c.memberchartdataid
				where
					c.memberchartid = z.memberchartid and
					b.isactive = 1 and 
					b.AppointmentStatus <> 'Cancel'
			)
		) Memberappointments ON charts.MemberChartId = Memberappointments.MemberChartId
		LEFT OUTER JOIN provider.AppointmentTypes with (nolock) ON provider.AppointmentTypes.AppointmentTypeId = MemberAppointments.AppointmentTypeId
		LEFT OUTER JOIN provider.Locations with (nolock) ON Memberappointments.LocationId = provider.Locations.LocationId
		LEFT OUTER JOIN provider.ProviderProfiles with (nolock) ON Memberappointments.ProviderId = provider.ProviderProfiles.ProviderId
		LEFT OUTER JOIN [vsdatamig].[DMContacts] with (nolock) ON provider.memberprofiles.nhmemberid=[vsdatamig].[DMContacts].nhmemberid
		



-- =================================================================================
-- Create View template for Azure SQL Database and Azure SQL Data Warehouse Database
-- =================================================================================

CREATE VIEW [ReportsData].[7_viewAccountingNEW_TEST_R]
AS
SELECT  NHMemberID, OrderNumber,OrderSource, EligSource,OrderRcvdDate, OrderCreatedDate, OrderType,
OrderRef,
Status,
Carrier, [Plan], MemberFirstName,
                           MemberLastName,ProviderID,ProviderLegalName,ProviderDBA, ProviderDispenser, ProviderAddress, ProviderCity,
                           ProviderState, ProviderZip, ShippingDBA, ShippingDispenser, Manufacturer, Family,Product,TechnologyLevel,
                           Qty,
						   COGS, 
						   TotalCOGS ,
						   BenefitAmount,ProductPrice,BenefitAvailable,AdjustmentAmount, MemberResponsibleAmount,
						   [ItemTotal],[exchangeCredit],[cancelCredit],
                           MemberPayment, PODate, PONumber,FittingDate, PurchaseAgreementDate,DeliveryRcptDate, ReturnDate, ClaimRequired,
                           FittingFeePerDevice, 
						   TotalFittingFee, 
						   ClaimAmount,QBJobName
       FROM (
                     SELECT       o.NHMemberID,
                                         o.orderid AS 'OrderNumber',
                                  --     OI.ItemType,
                                         --OI.orderSource as 'OrderSource',(OLD) RR
                                         O.Source AS 'OrderSource',
                                         DS.DataSource AS 'EligSource',
                                         CONVERT(VARCHAR(10), o.[DateOrderReceived],101) AS 'OrderRcvdDate',
                                         CONVERT(VARCHAR(10), o.[DateOrderInitiated],101) AS 'OrderCreatedDate',
                                         o.[OrderType],
                                         (CASE WHEN o.[OrderType] IN ('EXCHANGE','LSRD') 
                                                       THEN o.[OrderType] +'( of order:' + CAST(o.[RefOrderId] AS NVARCHAR(10)) + ')' ------RR Converted RefOrderId to Nvarchar--------------------
                                                              ELSE o.[OrderType]
                                                              END) 'OrderRef',
                                         o.[Status],
                                         (CASE WHEN JSON_VALUE(O.MEMBERDATA, '$.insurance.carrierName') = 'None' OR JSON_VALUE(O.MEMBERDATA, '$.insurance.carrierName') = '' 
                                                       THEN 
                                                              JSON_VALUE(O.MEMBERDATA, '$.insurance.programeName')
                                                       ELSE JSON_VALUE(O.MEMBERDATA, '$.insurance.carrierName')
                                                       END) AS 'Carrier',
                                         JSON_VALUE(O.MEMBERDATA, '$.insurance.planName') AS 'Plan',
                                         JSON_VALUE([MemberData],'$.firstName') AS [MemberFirstName],
                                         JSON_VALUE([MemberData],'$.lastName') AS [MemberLastName],
                                         JSON_VALUE([ProviderData],'$.providerId') AS [ProviderID],
                                         JSON_VALUE([ProviderData],'$.providerLeagalBusinessName') AS [ProviderLegalName], 
                                         JSON_VALUE([ProviderData],'$.dba') AS [ProviderDBA],
                                         JSON_VALUE([ProviderData],'$.dispenser') AS [ProviderDispenser],
                                         JSON_VALUE([ProviderData],'$.address.address') AS [ProviderAddress],
                                         JSON_VALUE([ProviderData],'$.address.city') AS [ProviderCity], 
                                         JSON_VALUE([ProviderData],'$.address.state') AS [ProviderState],
                                         JSON_VALUE([ProviderData],'$.address.zip') AS [ProviderZip],
                                         JSON_VALUE([ShippingData],'$.dba') AS [ShippingDBA],
                                         JSON_VALUE([ShippingData],'$.dispenser') AS [ShippingDispenser],
                                         OI.BrandCode AS [Manufacturer] ,
                                         OI.FamilyCode AS [Family],
                                         OI.TechnologyLevelCode [Product],
                                         P.FAMILYPRODUCTCATCODE [TechnologyLevel],
                                         --[DeviceCount] as 'Qty', (old) RR
                                         --(SELECT SUM(Quantity) FROM Orders.OrderItems OI1 WHERE  OI1.OrderID=OI.OrderID
                                         --GROUP BY Quantity) AS 'Qty',
                                         nn.Quantity AS 'Qty',
                                         P.[PerDeviceCOGSPrice] AS 'COGS',
                                         --P.[PerDeviceCOGSPrice] * [DeviceCount] as 'TotalCOGS', (OLD) RR
                                         (P.[PerDeviceCOGSPrice] * nn.[Quantity]) AS 'TotalCOGS',
                                         (CASE WHEN CAST(JSON_VALUE([OrderAmountData],'$.insuranceBenefit') AS NVARCHAR(10)) IS NULL THEN 0 
                                                              WHEN CAST(JSON_VALUE([OrderAmountData],'$.insuranceBenefit') AS NVARCHAR(10)) ='NA' THEN 0 ---RR A NEW Condition added.
                                                              ELSE CAST(JSON_VALUE([OrderAmountData],'$.insuranceBenefit') AS DECIMAL)
                                         END) [BenefitAmount],
                                         (CASE WHEN CAST(JSON_VALUE([OrderAmountData],'$.productPrice') AS NVARCHAR(10)) IS NULL THEN 0 
                                          ELSE CAST(JSON_VALUE([OrderAmountData],'$.productPrice') AS DECIMAL)
                                         END) AS [ProductPrice],
                                         (CASE WHEN CAST(JSON_VALUE([OrderAmountData],'$.benefitAvailable') AS NVARCHAR(10)) IS NULL THEN 0
                                                  WHEN CAST(JSON_VALUE([OrderAmountData],'$.benefitAvailable') AS NVARCHAR(10)) ='NA' THEN 0 --- RR A NEW Condition added.
                                                       ELSE CAST(JSON_VALUE([OrderAmountData],'$.benefitAvailable') AS DECIMAL)
                                                END) AS [BenefitAvailable],
                                         (CASE WHEN CAST(JSON_VALUE([OrderAmountData],'$.adjustments') AS NVARCHAR(10)) IS NULL THEN 0 
                                                       ELSE CAST(JSON_VALUE([OrderAmountData],'$.adjustments') AS DECIMAL)
                                                END) AS [AdjustmentAmount],
                                         (CASE WHEN CAST(JSON_VALUE([OrderAmountData],'$.memberResponsibility') AS NVARCHAR(10)) IS NULL THEN 0 
                                                       ELSE CAST(JSON_VALUE([OrderAmountData],'$.memberResponsibility') AS DECIMAL)
                                         END) AS [MemberResponsibleAmount],JSON_VALUE([OrderAmountData],'$.memberResponsibility') [MemberResponsibilityAmount],
										 (CASE WHEN CAST(JSON_VALUE([OrderAmountData],'$.itemsTotal') AS NVARCHAR(10)) IS NULL THEN 0 
                                                       ELSE CAST(JSON_VALUE([OrderAmountData],'$.itemsTotal') AS DECIMAL)
                                         END) AS [ItemTotal],
										 (CASE WHEN CAST(JSON_VALUE([OrderAmountData],'$.exchangeCredit') AS NVARCHAR(10)) IS NULL THEN 0 
                                                       ELSE CAST(JSON_VALUE([OrderAmountData],'$.exchangeCredit') AS DECIMAL)
                                         END) AS [exchangeCredit],
										  (CASE WHEN CAST(JSON_VALUE([OrderAmountData],'$.cancelCredit') AS NVARCHAR(10)) IS NULL THEN 0 
                                                       ELSE CAST(JSON_VALUE([OrderAmountData],'$.cancelCredit') AS DECIMAL)
                                         END) AS [cancelCredit],
                                         (CASE WHEN CAST(PAY.[PaymentAmount1] AS DECIMAL) + CAST(PAY.[PaymentAmount2] AS DECIMAL) + CAST(PAY.[PaymentAmount3] AS DECIMAL) IS NULL THEN 0 
                                                  ELSE CAST(PAY.[PaymentAmount1] AS DECIMAL) + CAST(PAY.[PaymentAmount2] AS DECIMAL) + CAST(PAY.[PaymentAmount3] AS DECIMAL)
                                         END) 'MemberPayment',
                                         (CASE WHEN CONVERT(VARCHAR(10), PO.[PO DATE],101) IS NULL THEN '' 
                                                  ELSE CONVERT(VARCHAR(10), PO.[PO DATE],101) 
                                          END) AS 'PODate',
                                         (CASE WHEN PO.PONumber IS NULL THEN ''
                                           ELSE PO.PONumber
                                         END) AS 'PONumber',
                                         (CASE WHEN CLM.[Fitting Date] IS NULL THEN '' 
                                                  ELSE CLM.[Fitting Date]
                                         END) AS 'FittingDate' ,
                                         (CASE WHEN CLM.[PurchaseDate] IS NULL THEN '' 
                                          ELSE CLM.[PurchaseDate]
                                         END) AS 'PurchaseAgreementDate', 
                                          (CASE WHEN CLM.[DeliveryDate] IS NULL THEN '' 
                                          ELSE CLM.[DeliveryDate]
                                         END) AS 'DeliveryRcptDate', 
                                          (CASE WHEN   CONVERT(VARCHAR(10), RET.[Return Date],101) IS NULL THEN '' ELSE
                                                  CONVERT(VARCHAR(10), RET.[Return Date] ,101)
                                           END) AS 'ReturnDate',
                                         (CASE WHEN CLM.[Claim Required] IS NULL THEN '' ELSE
                                                  CLM.[Claim Required]
                                           END) AS 'ClaimRequired',
                                         P.[PerDeviceDispensingFee] [FittingFeePerDevice],
                                         --(P.[PerDeviceDispensingFee] * [DeviceCount]) as 'TotalFittingFee',--(OLD) RR
                                         (P.[PerDeviceDispensingFee] *  nn.[Quantity]) AS 'TotalFittingFee',
                                         (CASE WHEN CAST(CLM.[ClaimAmount] AS NVARCHAR(10)) IS NULL THEN '0' 
                                                  ELSE CAST(CLM.[ClaimAmount] AS NVARCHAR(10))
                                         END) 'ClaimAmount',
                                         JSON_VALUE(O.MEMBERDATA, '$.insurance.carrierName') + ':' + JSON_VALUE([MemberData],'$.firstName') + ' ' +JSON_VALUE([MemberData],'$.lastName') AS 'QBJobName'
                                  FROM

                                  Orders.Orders O WITH (NOLOCK)

                                  -----RR Included Orders.OrderItems table to get TECHNOLOGYLEVELCODE,BrandCode,FamilyCode,DeviceCount

                                  LEFT OUTER JOIN
                                  Orders.OrderItems OI ON (OI.OrderID=O.OrderID and itemtype in ('HA'))
								  LEFT OUTER JOIN (select orderid, sum(quantity) Quantity from orders.orderItems where itemtype in ('HA','CROS') group by orderid) nn
								  on (nn.orderid = O.orderid)
                                  LEFT OUTER JOIN
                                  (
                                  SELECT ORDERID,[OrderTransactionData],
                                                (CASE WHEN CONVERT(VARCHAR(10),JSON_VALUE([OrderTransactionData],'$.fittingDate'),101)  = '01/01/0001' THEN ''
                                                         WHEN CONVERT(VARCHAR(10),JSON_VALUE([OrderTransactionData],'$.fittingDate'),101) IS NULL THEN ''
                                                ELSE CONVERT(VARCHAR(10),JSON_VALUE([OrderTransactionData],'$.fittingDate'),101)
                                                END)  AS [Fitting Date],
                                                JSON_VALUE([OrderTransactionData],'$.purchaseAgreementReceived') AS [PurchaseAgreementRcvd],
                                                (CASE WHEN CONVERT(VARCHAR(10),JSON_VALUE([OrderTransactionData],'$.purchaseDate'),101) IS NULL THEN '' 
                                                 ELSE CONVERT(VARCHAR(10),JSON_VALUE([OrderTransactionData],'$.purchaseDate'),101) 
                                                 END) AS [PurchaseDate],
                                                JSON_VALUE([OrderTransactionData],'$.deliveryReceipt') AS [DeliveryReceiptRcvd],
                                                (CASE WHEN CONVERT(VARCHAR(10),JSON_VALUE([OrderTransactionData],'$.deliveryDate'),101) IS NULL THEN '' 
                                                 ELSE CONVERT(VARCHAR(10),JSON_VALUE([OrderTransactionData],'$.deliveryDate'),101) 
                                                 END) AS [DeliveryDate],
                                                JSON_VALUE([OrderTransactionData],'$.isClaimSubmitted') AS [Claim Required],
                                                --JSON_VALUE([OrderTransactionData],'$.copayDues.hfCopayDue') AS [Fitting Fee],
                                                (CASE WHEN JSON_VALUE([OrderTransactionData],'$.claimAmount') IS NULL THEN '0'
                                                ELSE JSON_VALUE([OrderTransactionData],'$.claimAmount') 
                                                 END) AS [ClaimAmount]
                                         FROM 
                                                [Orders].[OrderTransactionDetails] OD1 WITH (NOLOCK)
                                                WHERE OD1.OrderStatusCode='CLM' AND IsActive=1
                                         )CLM ON (O.ORDERID = CLM.ORDERID)
                                  LEFT OUTER JOIN
                                  (
                                  SELECT CAST(JSON_VALUE(Ordertransactiondata,'$.returnDt') AS DATE) [Return Date],ORDERID
                                  FROM 
                                  [Orders].[OrderTransactionDetails] OD1 WITH (NOLOCK)
                                  WHERE OD1.OrderStatusCode='RET' AND IsActive=1
                                  )RET ON (O.ORDERID = RET.ORDERID)
                                  LEFT OUTER JOIN
                                  (
                                  SELECT  ORDERID,
                                  (CASE 
                                         WHEN OrderTransactionData='' THEN 0
                                                WHEN JSON_VALUE([OrderTransactionData],'$.transactions[0].amountPaid') IS NULL THEN 0
                                                       ELSE CAST(JSON_VALUE([OrderTransactionData],'$.transactions[0].amountPaid')  AS DECIMAL)
                                                END) [PaymentAmount1],
                                  (CASE 
                                         WHEN OrderTransactionData='' THEN 0
                                         WHEN JSON_VALUE([OrderTransactionData],'$.transactions[1].amountPaid') IS NULL THEN 0
                                                ELSE CAST(JSON_VALUE([OrderTransactionData],'$.transactions[1].amountPaid') AS DECIMAL)
                                         END) [PaymentAmount2],
                                  (CASE 
                                          WHEN OrderTransactionData='' THEN 0
                                                WHEN JSON_VALUE([OrderTransactionData],'$.transactions[2].amountPaid') IS NULL THEN 0
                                                       ELSE CAST(JSON_VALUE([OrderTransactionData],'$.transactions[2].amountPaid') AS DECIMAL)
                                                       END) [PaymentAmount3],
                                  (CASE 
                                          WHEN OrderTransactionData='' THEN 0
                                                WHEN JSON_VALUE([OrderTransactionData],'$.transactions[3].amountPaid') IS NULL THEN 0
                                                       ELSE CAST(JSON_VALUE([OrderTransactionData],'$.transactions[3].amountPaid') AS DECIMAL)
                                  END) [PaymentAmount4]
                                  FROM
                                  [Orders].[OrderTransactionDetails] OD3 WITH (NOLOCK)
                                         WHERE OD3.OrderStatusCode='PAY' AND IsActive=1
                                  )PAY ON (O.ORDERID = PAY.ORDERID) 
                                  LEFT OUTER JOIN
                                  (
                                         SELECT ORDERID,
                                         JSON_VALUE(od4.[OrderTransactionData],'$.poDate') AS [PO DATE], JSON_VALUE(od4.[OrderTransactionData],'$.poNumber') AS PONumber
                                         FROM   [Orders].[OrderTransactionDetails] OD4 WITH (NOLOCK)
                                         WHERE OD4.OrderStatusCode='PO' AND IsActive=1
                                  )PO ON (O.ORDERID = PO.ORDERID) 

                                  LEFT OUTER JOIN Insurance.HealthPlanContracts B ON B.InsuranceHealthPlanID = JSON_VALUE(O.MEMBERDATA, '$.insPlanId')
                                  LEFT OUTER JOIN 
                                                ( SELECT DISTINCT FAMILYPRODUCTCATCODE, FAMILYPRODUCTCODE, HealthPlanContractID, [PerDeviceCOGSPrice],[PerDeviceDispensingFee] 
                                                       FROM INSURANCE.CONTRACTPRODUCTS) P ON OI.TECHNOLOGYLEVELCODE = P.FAMILYPRODUCTCODE AND P.HealthPlanContractId = B.HealthPlanContractId

                                  INNER JOIN [Master].[Members] DS WITH (NOLOCK) ON DS.[NHMemberID] = O.NHMemberID AND DS.IsActive=1
                           WHERE O.IsActive=1 AND O.Status not in ('ALAN','CANCELLED') AND OI.ItemType IN('HA','CROS')
                           --AND o.OrderID=180020514
                           --order BY o.orderid
                           
                            )a
                           /*  GROUP BY 
                            NHMemberID, OrderNumber,a.OrderSource, EligSource,OrderRcvdDate, OrderCreatedDate, OrderType,OrderRef,Status,Carrier, [Plan], MemberFirstName,
                           MemberLastName,ProviderID,ProviderLegalName,ProviderDBA, ProviderDispenser, ProviderAddress, ProviderCity,
                           ProviderState, ProviderZip, ShippingDBA, ShippingDispenser, Manufacturer, Family,Product,TechnologyLevel,
                           COGS, TotalCOGS,BenefitAmount,ProductPrice,BenefitAvailable,AdjustmentAmount, MemberResponsibleAmount,
                           MemberPayment, PODate, PONumber,FittingDate, PurchaseAgreementDate,DeliveryRcptDate, ReturnDate, ClaimRequired,
                           FittingFeePerDevice,TotalFittingFee,QBJobName, ClaimAmount, qty

*/




CREATE VIEW  [ReportsData].[viewMemberInfoRpt1_John]
 AS
    select distinct 
		provider.MemberProfiles.NHMemberId  [NHMemberId]
		,case 
			when (Insurance.InsuranceCarriers.InsuranceCarrierName like '%none%' or Insurance.InsuranceCarriers.InsuranceCarrierName is null) then 'None'
			else Insurance.InsuranceCarriers.InsuranceCarrierName end as [Program Name]
		,provider.MemberProfiles.FirstName                                                     [First Name]
		,provider.MemberProfiles.LastName                                                     [Last Name]
		,case when provider.MemberProfiles.DateOfBirth = CONVERT(datetime2, '0001-01-01 00:00:00.0000000') then NULL else cast(provider.MemberProfiles.DateOfBirth as date) end as DOB
		,memberlocations.State                                                                                           [State]
		,[Member Phone Number] = (select top 1 phonenumber from provider.memberphonenumbers where provider.memberphonenumbers.memberprofileid = provider.memberprofiles.memberprofileid and isActive = 1 and (phonetypeid= 1 or phonetypeid = 4))
		,provider.AppointmentTypes.AppointmentTypeName      [Appointment Type Name]
		,cast(MemberAppointments.StartDate as Date)                 [Latest Appt Date]
		,provider.MemberProfiles.CreateUser                                                   [Add User]
		,provider.MemberProfiles.ModifyUser                                                  [Modify User]
        from 
		(
			select nhmemberid, max(id) id, max(lastcalltime_est) lastcalltime_est, min(firstcalltime_est) firstcalltime_est
			from
			(
				select nhmemberid
					,case when ModifyUser <> 'VanillaSoft' then dateadd(hour, -5, lastcalltime) else lastcalltime end as lastcalltime_est
					,case when ModifyUser <> 'VanillaSoft' then dateadd(hour, -5, firstCalltime) else firstCalltime end as firstcalltime_est
					,id
				from
				(
					select  
						MemberNHMemberId as NHmemberId
						,max(StartTime) lastCalltime
						,min(StartTime) firstCalltime
						,max(callconversationid) id
						,ModifyUser
					from callcenter.CallConversations
					where 
						IsActive = 1
					group by MemberNHMemberId, ModifyUser
				) sometable
			) sometable2
			group by nhmemberid
		) callconversations
		LEFT OUTER JOIN (
			select
				callconversationid,
				max(evnts.EventName) eventname
			from callcenter.callpageevents cpe
			inner join (select * from jobs.events where EventTriggerBy = 'disposition') evnts on evnts.eventid = cpe.EventId
			group by callconversationid
		) callevents on callevents.callconversationid = callconversations.id
		LEFT OUTER JOIN provider.MemberProfiles with (nolock) ON provider.MemberProfiles.NHmemberid = callconversations.nhmemberid
		LEFT OUTER JOIN (select * from provider.MemberInsurances with (nolock) where isactive = 1 and (ModifyUser = 'SystemUser' and UseForBenefits = 1) or (ModifyUser <> 'SystemUser' and InsuranceCarrierId <> 207)) memberinsurances ON provider.MemberProfiles.MemberProfileId = memberinsurances.MemberProfileId
		LEFT OUTER JOIN provider.MemberInsuranceDetails with (nolock) ON provider.MemberInsuranceDetails.MemberInsuranceId = memberinsurances.MemberInsuranceId
		LEFT OUTER JOIN Insurance.InsuranceCarriers with (nolock) ON memberinsurances.InsuranceCarrierId = Insurance.InsuranceCarriers.InsuranceCarrierId
		LEFT OUTER JOIN (
			SELECT [HealthPlanContractID]
					,[InsuranceCarrierID]
					,[InsuranceHealthPlanID]
			FROM [Insurance].[HealthPlanContracts] with (nolock) 
		) HealthPlanContracts ON memberinsurances.InsuranceCarrierId = HealthPlanContracts.[InsuranceCarrierID]
			AND memberinsurances.InsuranceHealthPlanId = HealthPlanContracts.[InsuranceHealthPlanID]
		LEFT OUTER JOIN (
			SELECT  [BenefitAmt]
                    ,[HealthPlanContractID]
			FROM [Insurance].[ContractBenefits] with (nolock) 
		) ContractBenefits ON HealthPlanContracts.HealthPlanContractId = ContractBenefits.[HealthPlanContractID]
		LEFT OUTER JOIN
		(
			select MemberLocationId
					,Address1
					,Address2
					,AddressTypeId
					,City
					,IsActive
					,MemberProfileId
					,State
					,ZipCode
			from provider.MemberLocations a with (nolock) 
			where
				IsActive = 1
				--and AddressTypeId = 1
				and MemberLocationId = 
				(
					select min(memberlocationid) 
					from provider.MemberLocations 
					where 
						MemberProfileId = a.MemberProfileId
				)
		) memberlocations ON provider.MemberProfiles.MemberProfileId = memberlocations.MemberProfileId 
		LEFT OUTER JOIN provider.MemberCharts charts with (nolock) on charts.MemberProfileId = provider.MemberProfiles.MemberProfileId
		LEFT OUTER JOIN
		(
			select a.*, z.memberchartid, d.locationid, d.providerid
			from provider.MemberAppointments a with (nolock)
			inner join provider.memberchartdata d on a.memberchartdataid = d.memberchartdataid
			inner join provider.membercharts z on z.memberchartid = d.memberchartid
			where
				a.IsActive = 1
			and memberappointmentid = (
				select max(memberappointmentid)
				from provider.MemberAppointments b with (nolock)
				inner join provider.memberchartdata c on b.memberchartdataid = c.memberchartdataid
				where
					c.memberchartid = z.memberchartid and
					b.isactive = 1 and 
					b.AppointmentStatus <> 'Cancel'
			)
		) Memberappointments ON charts.MemberChartId = Memberappointments.MemberChartId
		LEFT OUTER JOIN provider.AppointmentTypes with (nolock) ON provider.AppointmentTypes.AppointmentTypeId = MemberAppointments.AppointmentTypeId
		LEFT OUTER JOIN provider.Locations with (nolock) ON Memberappointments.LocationId = provider.Locations.LocationId
		LEFT OUTER JOIN provider.ProviderProfiles with (nolock) ON Memberappointments.ProviderId = provider.ProviderProfiles.ProviderId
		LEFT OUTER JOIN [vsdatamig].[DMContacts] with (nolock) ON provider.memberprofiles.nhmemberid=[vsdatamig].[DMContacts].nhmemberid
    where 
		memberinsurances.CreateDate=
		(
			select max(provider.MemberInsurances.CreateDate) 
			from provider.MemberInsurances with (nolock) 
			where 
				provider.MemberProfiles.MemberProfileId = provider.MemberInsurances.MemberProfileId 
		)


CREATE VIEW [ReportsData].[viewMarketShare]
AS

		select [carriername] CARRIER,
       ISNULL([GNR],0) GNR,ISNULL([BELTONE],0) BELTONE,ISNULL([STARKEY],0) STARKEY,ISNULL([PHONAK],0) PHONAK
       ,ISNULL([SIGNIA],0) SIGNIA,ISNULL([WIDEX],0) WIDEX,ISNULL([UNITRON],0) UNITRON,ISNULL([OTICON],0) OTICON
       from (select carriername, brandcode, sum(devicecount) as 'cnt' 
       FROM(
			SELECT 
				   O.ORDERID, O.NHMEMBERID, OI.BRANDCODE, OI.TECHNOLOGYLEVELCODE, UPPER(P.FAMILYPRODUCTCATCODE) CATEGORY, OI.QUANTITY DEVICECOUNT
				   ,CAST(O.DATEORDERRECEIVED AS DATE) ORDERRECEIVEDDATE, CAST(O.DATEORDERINITIATED AS DATE) ORDERINITIATEDDATE,ISNULL(json_value(OrdertransactionData, '$.poDate'),json_value(OrdertransactionData, '$[0].poDate')) ORDERAPPROVEDDATE
				   ,   IC.INSURANCECARRIERNAME CARRIERNAME
			FROM  ORDERS.ORDERS O
			INNER JOIN ORDERS.ORDERITEMS OI ON OI.OrderID = O.OrderID
			INNER JOIN INSURANCE.INSURANCECARRIERS IC ON IC.INSURANCECARRIERID = JSON_VALUE(O.MEMBERDATA, '$.insCarrierId')
			INNER JOIN ORDERS.ORDERTRANSACTIONDETAILS OT ON        O.ORDERID = OT.ORDERID
			LEFT JOIN 
				   (SELECT X.* FROM 
						 (
								SELECT FAMILYPRODUCTCATCODE, FAMILYPRODUCTCODE,ROW_NUMBER() OVER(PARTITION BY FAMILYPRODUCTCODE ORDER BY CONTRACTPRODUCTID DESC) RN
								FROM INSURANCE.CONTRACTPRODUCTS
						 )X  WHERE X.RN = 1
				   ) P ON OI.TECHNOLOGYLEVELCODE = P.FAMILYPRODUCTCODE
			WHERE O.MEMBERDATA <>'' AND OT.ORDERSTATUSCODE = 'PO' AND OT.ISCOMPLETE = 1
			and O.ordertype = 'NEW'
			and O.status = 'ACTIVE'
			and OI.ITEMTYPE <> 'EM'
			--and ISNULL(json_value(OrdertransactionData, '$.poDate'),json_value(OrdertransactionData, '$[0].poDate'))  between @startDate and @endDate
			) t
			  group by carriername, brandcode ) a
				   pivot
				   (   sum(cnt)
					   for brandcode in ([GNR],[BELTONE],[STARKEY],[PHONAK],[SIGNIA],[WIDEX],[UNITRON],[OTICON])
				   ) as P




CREATE VIEW [ReportsData].[viewMarketSharePivot]
	AS
	
	
	 select [providerName] [PROVIDER],[PROVIDERID],[LOCATIONID],LocationName
       ,ISNULL([GNR],0) GNR,ISNULL([BELTONE],0) BELTONE,ISNULL([STARKEY],0) STARKEY,ISNULL([PHONAK],0) PHONAK
       ,ISNULL([SIGNIA],0) SIGNIA,ISNULL([WIDEX],0) WIDEX,ISNULL([UNITRON],0) UNITRON,ISNULL([OTICON],0) OTICON
       from (select providerName,[PROVIDERID],[LOCATIONID],LocationName, brandcode, sum(QUANTITY) as 'cnt' 
       FROM(
SELECT        O.ORDERID, O.NHMEMBERID, OI.BRANDCODE, OI.TECHNOLOGYLEVELCODE, UPPER(P.FAMILYPRODUCTCATCODE) CATEGORY, OI.QUANTITY
       ,CAST(O.DATEORDERRECEIVED AS DATE) ORDERRECEIVEDDATE, CAST(O.DATEORDERINITIATED AS DATE) ORDERINITIATEDDATE,ISNULL(json_value(OrdertransactionData, '$.poDate'),json_value(OrdertransactionData, '$[0].poDate')) ORDERAPPROVEDDATE
         ,UPPER(Pp.ProviderName) ProviderName, JSON_VALUE(O.PROVIDERDATA, '$.providerId') providerId
         , JSON_VALUE(O.PROVIDERDATA, '$.address.locationId') locationId, UPPER(l.businessname)  LocationName
		 --JSON_VALUE(O.SHIPPINGDATA, '$.providerBusinessName') LocationName
FROM  ORDERS.ORDERS O
INNER JOIN ORDERS.ORDERITEMS OI ON        O.ORDERID = OI.ORDERID
INNER JOIN ORDERS.ORDERTRANSACTIONDETAILS OT ON        O.ORDERID = OT.ORDERID
LEFT JOIN 
       (
             SELECT X.* FROM 
             (
                    SELECT FAMILYPRODUCTCATCODE, FAMILYPRODUCTCODE,ROW_NUMBER() OVER(PARTITION BY FAMILYPRODUCTCODE ORDER BY CONTRACTPRODUCTID DESC) RN
                    FROM INSURANCE.CONTRACTPRODUCTS
             )X  WHERE X.RN = 1
       ) P    ON OI.TECHNOLOGYLEVELCODE = P.FAMILYPRODUCTCODE
LEFT JOIN provider.ProviderProfiles pp ON pp.providerId = JSON_VALUE(O.PROVIDERDATA, '$.providerId')
LEFT JOIN provider.locations l ON l.locationid = JSON_VALUE(O.PROVIDERDATA, '$.address.locationId')
WHERE O.MEMBERDATA <>'' AND OT.ORDERSTATUSCODE = 'PO' AND OT.ISCOMPLETE = 1
and O.ordertype = 'NEW'
and O.status = 'ACTIVE'
and OI.ITEMTYPE <> 'EM'
--and ISNULL(json_value(OrdertransactionData, '$.poDate'),json_value(OrdertransactionData, '$[0].poDate'))  between  @startDate and @endDate
) t
  group by providerName,[PROVIDERID],[LOCATIONID],LocationName, brandcode ) a
       pivot
       (   sum(cnt)
           for brandcode in ([GNR],[BELTONE],[STARKEY],[PHONAK],[SIGNIA],[WIDEX],[UNITRON],[OTICON])
       ) as P
       --order by 
       --[PROVIDER],[PROVIDERID],[LOCATIONID],LocationName



CREATE VIEW [ReportsData].[viewPerformanceReport]

As

select  --cast (DATEADD(WEEK, WeekNumber - 1, @FirstMondayOfYear) as date),
 cast(DATEADD(WEEK, 1, DATEADD(WEEK, WeekNumber - 1, DATEADD(WEEK, DATEDIFF(WEEK, 0, DATEADD(DAY, 6 - DATEPART(DAY, firstDayYear), firstDayYear)), 0) - 1)) as date) AS [Week Ended],
   UnitsSold
from 
(
	select datepart(week,dateorderreceived) WeekNumber, sum(devicecount) UnitsSold,
	CAST('1/1/' + CAST(Year(getdate()) AS VARCHAR) AS DATETIME) firstDayYear
	from orders.orders
	where orderid in
	(
		select orderid 
		from [Orders].[OrderTransactionDetails]
		where orderstatuscode='APP' 
		and iscomplete=1
		and YEAR(json_value(ordertransactiondata, '$.approvedDate')) = YEAR(getdate()) 
		and MONTH(json_value(ordertransactiondata, '$.approvedDate')) = MONTH(getdate())
	)
	and status = 'ACTIVE'
	--and ordersource='CRM'
	group by datepart(week,dateorderreceived)
) a

CREATE VIEW [ReportsData].[7_viewAccountingPOReport]
AS
--09/21/2018  Changed by Rajeshwar 
	SELECT  NHMemberID, OrderNumber, EligSource,OrderRcvdDate, OrderCreatedDate, OrderType,OrderRef,Status,Carrier, [Plan], MemberFirstName,
				 MemberLastName,ProviderID,ProviderLegalName,ProviderDBA, ProviderDispenser, ProviderAddress, ProviderCity,
				 ProviderState, ProviderZip, ShippingDBA, ShippingDispenser, Manufacturer, Family,Product,TechnologyLevel,
				SUM( Qty) AS Qty,COGS, TotalCOGS,BenefitAmount,ProductPrice,BenefitAvailable,AdjustmentAmount, MemberResponsibleAmount,
				 MemberPayment, PODate, PONumber,FittingDate, PurchaseAgreementDate,DeliveryRcptDate, ReturnDate, ClaimRequired,
				 FittingFeePerDevice,TotalFittingFee,QBJobName, ClaimAmount
	 FROM (

			SELECT	 	o.NHMemberID,
						o.orderid AS 'OrderNumber',
					--	OI.ItemType,
						--OI.orderSource as 'OrderSource',(OLD) RR
						O.Source AS 'OrderSource',
						DS.DataSource as 'EligSource',
						CONVERT(VARCHAR(10), o.[DateOrderReceived],101) AS 'OrderRcvdDate',
						CONVERT(VARCHAR(10), o.[DateOrderInitiated],101) AS 'OrderCreatedDate',
						o.[OrderType],
						(CASE WHEN o.[OrderType] in ('EXCHANGE','LSRD') 
								THEN o.[OrderType] +'( of order:' + CAST(o.[RefOrderId] AS NVARCHAR(10)) + ')' ------RR Converted RefOrderId to Nvarchar--------------------
									ELSE o.[OrderType]
									END) 'OrderRef',
						o.[Status],
						(CASE WHEN JSON_VALUE(O.MEMBERDATA, '$.insurance.carrierName') = 'None' or JSON_VALUE(O.MEMBERDATA, '$.insurance.carrierName') = '' 
								THEN 
									JSON_VALUE(O.MEMBERDATA, '$.insurance.programeName')
								ELSE JSON_VALUE(O.MEMBERDATA, '$.insurance.carrierName')
								END) AS 'Carrier',
						JSON_VALUE(O.MEMBERDATA, '$.insurance.planName') AS 'Plan',
						JSON_VALUE([MemberData],'$.firstName') AS [MemberFirstName],
						JSON_VALUE([MemberData],'$.lastName') AS [MemberLastName],
						JSON_VALUE([ProviderData],'$.providerId') AS [ProviderID],
						JSON_VALUE([ProviderData],'$.providerLeagalBusinessName') AS [ProviderLegalName],	
						JSON_VALUE([ProviderData],'$.dba') AS [ProviderDBA],
						JSON_VALUE([ProviderData],'$.dispenser') AS [ProviderDispenser],
						JSON_VALUE([ProviderData],'$.address.address') AS [ProviderAddress],
						JSON_VALUE([ProviderData],'$.address.city') AS [ProviderCity], 
						JSON_VALUE([ProviderData],'$.address.state') AS [ProviderState],
						JSON_VALUE([ProviderData],'$.address.zip') AS [ProviderZip],
						JSON_VALUE([ShippingData],'$.dba') AS [ShippingDBA],
						JSON_VALUE([ShippingData],'$.dispenser') AS [ShippingDispenser],
						OI.BrandCode As [Manufacturer] ,
						OI.FamilyCode As [Family],
						OI.TechnologyLevelCode [Product],
						P.FAMILYPRODUCTCATCODE [TechnologyLevel],
						--[DeviceCount] as 'Qty', (old) RR
						--(SELECT SUM(Quantity) FROM Orders.OrderItems OI1 WHERE  OI1.OrderID=OI.OrderID
						--GROUP BY Quantity) AS 'Qty',
						OI.Quantity AS 'Qty',
						P.[PerDeviceCOGSPrice] AS 'COGS',
						--P.[PerDeviceCOGSPrice] * [DeviceCount] as 'TotalCOGS', (OLD) RR
						(P.[PerDeviceCOGSPrice] * OI.[Quantity]) AS 'TotalCOGS',
						(CASE WHEN CAST(JSON_VALUE([OrderAmountData],'$.insuranceBenefit') AS NVARCHAR(10)) IS NULL THEN 0 
									WHEN CAST(JSON_VALUE([OrderAmountData],'$.insuranceBenefit') AS NVARCHAR(10)) ='NA' THEN 0 ---RR A NEW Condition added.
									ELSE CAST(JSON_VALUE([OrderAmountData],'$.insuranceBenefit') AS decimal)
						 END) [BenefitAmount],
						(CASE WHEN CAST(JSON_VALUE([OrderAmountData],'$.productPrice') as NVARCHAR(10)) IS NULL THEN 0 
						 else CAST(JSON_VALUE([OrderAmountData],'$.productPrice') AS decimal)
						 end) AS [ProductPrice],
						(CASE WHEN CAST(JSON_VALUE([OrderAmountData],'$.benefitAvailable') AS NVARCHAR(10)) IS NULL THEN 0
							  WHEN CAST(JSON_VALUE([OrderAmountData],'$.benefitAvailable') AS NVARCHAR(10)) ='NA' THEN 0 --- RR A NEW Condition added.
								ELSE CAST(JSON_VALUE([OrderAmountData],'$.benefitAvailable') AS decimal)
							END) AS [BenefitAvailable],
						 (CASE WHEN CAST(JSON_VALUE([OrderAmountData],'$.adjustments') AS NVARCHAR(10)) IS NULL THEN 0 
								ELSE CAST(JSON_VALUE([OrderAmountData],'$.adjustments') AS decimal)
							END) AS [AdjustmentAmount],
						(CASE WHEN CAST(JSON_VALUE([OrderAmountData],'$.memberResponsibility') AS NVARCHAR(10)) IS NULL THEN 0 
								ELSE CAST(JSON_VALUE([OrderAmountData],'$.memberResponsibility') AS DECIMAL)
						 END) AS [MemberResponsibleAmount],
						(CASE WHEN CAST(PAY.[PaymentAmount1] AS DECIMAL) + CAST(PAY.[PaymentAmount2] AS DECIMAL) + CAST(PAY.[PaymentAmount3] AS DECIMAL) IS NULL THEN 0 
							  ELSE CAST(PAY.[PaymentAmount1] AS DECIMAL) + CAST(PAY.[PaymentAmount2] AS DECIMAL) + CAST(PAY.[PaymentAmount3] AS DECIMAL)
						 END) 'MemberPayment',
						(CASE WHEN CONVERT(VARCHAR(10), PO.[PO DATE],101) IS NULL THEN '' 
							  ELSE CONVERT(VARCHAR(10), PO.[PO DATE],101) 
						 END) AS 'PODate',
						(CASE WHEN PO.PONumber IS NULL THEN ''
						  ELSE PO.PONumber
						 END) AS 'PONumber',
						(CASE WHEN CLM.[Fitting Date] IS NULL THEN '' 
							  ELSE CLM.[Fitting Date]
						 END) AS 'FittingDate' ,
						(CASE WHEN CLM.[PurchaseDate] IS NULL THEN '' 
						 ELSE CLM.[PurchaseDate]
						 END) AS 'PurchaseAgreementDate', 
						 (CASE WHEN CLM.[DeliveryDate] IS NULL THEN '' 
						 ELSE CLM.[DeliveryDate]
						 END) AS 'DeliveryRcptDate', 
						 (CASE WHEN   CONVERT(varchar(10), RET.[Return Date],101) IS NULL THEN '' ELSE
							  CONVERT(varchar(10), RET.[Return Date] ,101)
						  END) AS 'ReturnDate',
						(CASE WHEN CLM.[Claim Required] IS NULL THEN '' ELSE
							  CLM.[Claim Required]
						  END) AS 'ClaimRequired',
						P.[PerDeviceDispensingFee] [FittingFeePerDevice],
						--(P.[PerDeviceDispensingFee] * [DeviceCount]) as 'TotalFittingFee',--(OLD) RR
						(P.[PerDeviceDispensingFee] *  OI.[Quantity]) AS 'TotalFittingFee',
						(CASE WHEN CAST(CLM.[ClaimAmount] AS NVARCHAR(10)) IS NULL THEN '0' 
							  ELSE CAST(CLM.[ClaimAmount] AS NVARCHAR(10))
						 END) 'ClaimAmount',
						JSON_VALUE(O.MEMBERDATA, '$.insurance.carrierName') + ':' + JSON_VALUE([MemberData],'$.firstName') + ' ' +JSON_VALUE([MemberData],'$.lastName') AS 'QBJobName'
					FROM

					Orders.Orders O WITH (NOLOCK)

					-----RR Included Orders.OrderItems table to get TECHNOLOGYLEVELCODE,BrandCode,FamilyCode,DeviceCount

					LEFT OUTER JOIN
					Orders.OrderItems OI ON OI.OrderID=O.OrderID
					LEFT OUTER JOIN
					(
					SELECT ORDERID,[OrderTransactionData],
							(CASE WHEN CONVERT(varchar(10),JSON_VALUE([OrderTransactionData],'$.fittingDate'),101)  = '01/01/0001' THEN ''
								  WHEN CONVERT(varchar(10),JSON_VALUE([OrderTransactionData],'$.fittingDate'),101) IS NULL THEN ''
							 ELSE CONVERT(varchar(10),JSON_VALUE([OrderTransactionData],'$.fittingDate'),101)
							 END)  AS [Fitting Date],
							JSON_VALUE([OrderTransactionData],'$.purchaseAgreementReceived') AS [PurchaseAgreementRcvd],
							(CASE WHEN CONVERT(varchar(10),JSON_VALUE([OrderTransactionData],'$.purchaseDate'),101) IS NULL THEN '' 
							 ELSE CONVERT(varchar(10),JSON_VALUE([OrderTransactionData],'$.purchaseDate'),101) 
							 END) AS [PurchaseDate],
							 JSON_VALUE([OrderTransactionData],'$.deliveryReceipt') AS [DeliveryReceiptRcvd],
							(CASE WHEN CONVERT(varchar(10),JSON_VALUE([OrderTransactionData],'$.deliveryDate'),101) IS NULL THEN '' 
							 ELSE CONVERT(varchar(10),JSON_VALUE([OrderTransactionData],'$.deliveryDate'),101) 
							 END) AS [DeliveryDate],
							JSON_VALUE([OrderTransactionData],'$.isClaimSubmitted') AS [Claim Required],
							--JSON_VALUE([OrderTransactionData],'$.copayDues.hfCopayDue') AS [Fitting Fee],
							(CASE WHEN JSON_VALUE([OrderTransactionData],'$.claimAmount') IS NULL THEN '0'
							 ELSE JSON_VALUE([OrderTransactionData],'$.claimAmount') 
							 END) AS [ClaimAmount]
						FROM 
							[Orders].[OrderTransactionDetails] OD1 WITH (NOLOCK)
							WHERE OD1.OrderStatusCode='CLM' and IsActive=1
						)CLM ON (O.ORDERID = CLM.ORDERID)
					LEFT OUTER JOIN
					(
					SELECT CAST(json_value(Ordertransactiondata,'$.returnDt') AS DATE) [Return Date],ORDERID
					FROM 
					[Orders].[OrderTransactionDetails] OD1 WITH (NOLOCK)
					where OD1.OrderStatusCode='RET' and IsActive=1
					)RET ON (O.ORDERID = RET.ORDERID)
					LEFT OUTER JOIN
					(
					SELECT  ORDERID,
					(CASE 
						WHEN OrderTransactionData='' THEN 0
							 WHEN JSON_VALUE([OrderTransactionData],'$.transactions[0].amountPaid') IS NULL THEN 0
								ELSE CAST(JSON_VALUE([OrderTransactionData],'$.transactions[0].amountPaid')  As DECIMAL)
							END) [PaymentAmount1],
					(CASE 
						WHEN OrderTransactionData='' THEN 0
						 WHEN JSON_VALUE([OrderTransactionData],'$.transactions[1].amountPaid') IS NULL THEN 0
							ELSE cast(JSON_VALUE([OrderTransactionData],'$.transactions[1].amountPaid') AS DECIMAL)
						END) [PaymentAmount2],
					(CASE 
						 WHEN OrderTransactionData='' THEN 0
							 WHEN JSON_VALUE([OrderTransactionData],'$.transactions[2].amountPaid') IS NULL THEN 0
								 ELSE cast(JSON_VALUE([OrderTransactionData],'$.transactions[2].amountPaid') AS DECIMAL)
								END) [PaymentAmount3],
					(CASE 
						 WHEN OrderTransactionData='' THEN 0
							 WHEN JSON_VALUE([OrderTransactionData],'$.transactions[3].amountPaid') IS NULL THEN 0
								ELSE cast(JSON_VALUE([OrderTransactionData],'$.transactions[3].amountPaid') AS DECIMAL)
					END) [PaymentAmount4]
					FROM
					[Orders].[OrderTransactionDetails] OD3 WITH (NOLOCK)
						 WHERE OD3.OrderStatusCode='PAY' and IsActive=1
					)PAY ON (O.ORDERID = PAY.ORDERID) 
					LEFT OUTER JOIN
					(
						SELECT ORDERID,
						JSON_VALUE(od4.[OrderTransactionData],'$.poDate') AS [PO DATE], JSON_VALUE(od4.[OrderTransactionData],'$.poNumber') AS PONumber
						FROM	[Orders].[OrderTransactionDetails] OD4 WITH (NOLOCK)
						WHERE OD4.OrderStatusCode='PO' AND IsActive=1
					)PO ON (O.ORDERID = PO.ORDERID) 

					LEFT OUTER JOIN Insurance.HealthPlanContracts B ON B.InsuranceHealthPlanID = JSON_VALUE(O.MEMBERDATA, '$.insPlanId')
					LEFT OUTER JOIN 
							( SELECT DISTINCT FAMILYPRODUCTCATCODE, FAMILYPRODUCTCODE, HealthPlanContractID, [PerDeviceCOGSPrice],[PerDeviceDispensingFee] 
								FROM INSURANCE.CONTRACTPRODUCTS) P ON OI.TECHNOLOGYLEVELCODE = P.FAMILYPRODUCTCODE AND P.HealthPlanContractId = B.HealthPlanContractId

					INNER JOIN [Master].[Members] DS WITH (NOLOCK) ON DS.[NHMemberID] = O.NHMemberID AND DS.IsActive=1
				 WHERE O.IsActive=1 AND O.Status <> 'ALAN' AND OI.ItemType IN('HA','CROS'))a

				  GROUP BY 
				 NHMemberID, OrderNumber, EligSource,OrderRcvdDate, OrderCreatedDate, OrderType,OrderRef,Status,Carrier, [Plan], MemberFirstName,
				 MemberLastName,ProviderID,ProviderLegalName,ProviderDBA, ProviderDispenser, ProviderAddress, ProviderCity,
				 ProviderState, ProviderZip, ShippingDBA, ShippingDispenser, Manufacturer, Family,Product,TechnologyLevel,
				 COGS, TotalCOGS,BenefitAmount,ProductPrice,BenefitAvailable,AdjustmentAmount, MemberResponsibleAmount,
				 MemberPayment, PODate, PONumber,FittingDate, PurchaseAgreementDate,DeliveryRcptDate, ReturnDate, ClaimRequired,
				 FittingFeePerDevice,TotalFittingFee,QBJobName, ClaimAmount





CREATE VIEW  [ReportsData].[8_viewPaymentDetails]
AS

		SELECT 
				b.Source AS 'OrderSource',
				b.[OrderID],
				b.OrderType, 
				b.Status,
				CAST(b.[DateOrderInitiated] AS DATE) AS 'OrderCreateDate', 
				(CASE WHEN I.carrierName = ''  OR I.carrierName = 'None' THEN I.programeName
				 ELSE I.carrierName 
				 END) 'Carrier',
				M.firstName 'First Name',
				M.lastName  'Last Name',
				I.nhMemberId 'NHMemberID',
				p.paymentDate 'Payment Date',
				p.paymentType 'Payment Mode',
				(CASE  WHEN p.cardOrBank IS NULL AND p.paymentType = 'ACH' THEN 'ACH' 
 					   WHEN p.cardOrBank IS NULL AND p.paymentType = 'Finance' THEN F.financeCompany
					   ELSE p.cardOrBank
				END) 'Payment Type',
				p.amountPaid 'Payment',
				F.name 'Account holder Name',
				PO1.poDate,
				CASE WHEN IsNull(po2.ponumber,'')=po2.ponumber then po1.ponumber+','+po2.ponumber ELSE po1.ponumber END poNumber,
				(CASE WHEN   CONVERT(VARCHAR(10), RET.returnDt,101) IS NULL THEN '' WHEN CONVERT(VARCHAR(10), RET.returnDt,101) ='' THEN ''ELSE
							  CONVERT(VARCHAR(10), CAST(RET.returnDt AS DATE),101)
						  END) AS 'ReturnDate'
				FROM [Orders].[OrderTransactionDetails] a WITH (NOLOCK)
				OUTER APPLY OPENJSON(a.[OrderTransactionData], '$.transactions') 
					  WITH (
							 paymentDate DATE,
							 paymentType NVARCHAR(20),
							 amountPaid decimal,
							 cardOrBank NVARCHAR(20),
							 formInputDetails NVARCHAR(MAX) AS JSON
						   ) AS P
				OUTER APPLY OPENJSON(P.[formInputDetails], '$')
					  WITH(
							name NVARCHAR(30),
							financeCompany NVARCHAR(30)
						  ) AS F
				LEFT OUTER JOIN orders.orders b WITH (NOLOCK) ON b.[OrderID]=a.[OrderID] 
				OUTER APPLY OPENJSON(b.[MemberData], '$')
					  WITH(
							firstName NVARCHAR(30),
							lastName  NVARCHAR(30),
							insurance NVARCHAR(MAX) AS JSON
							) AS M
				OUTER APPLY OPENJSON(M.[insurance], '$')
					 WITH( 
							nhMemberId NVARCHAR(30),
							carrierName NVARCHAR(50),
							programeName NVARCHAR(50)
						) AS I
			
				LEFT OUTER JOIN [Orders].[OrderTransactionDetails] O2 WITH (NOLOCK) ON O2.OrderId=a.OrderID AND O2.[OrderStatusCode] = 'PO'
				OUTER APPLY OPENJSON(O2.[OrderTransactionData], '$[0]')
					  WITH(
							poNumber NVARCHAR(20),
							poDate  DATE
						   ) AS PO1	     
				LEFT OUTER JOIN [Orders].[OrderTransactionDetails] O3 WITH (NOLOCK) ON O3.OrderId=a.OrderID AND O3.[OrderStatusCode] = 'PO'
				OUTER APPLY OPENJSON(O3.[OrderTransactionData], '$[1]')
					  WITH(
							poNumber NVARCHAR(20),
							poDate  DATE
						   ) AS PO2	       
						      
				LEFT OUTER JOIN [Orders].[OrderTransactionDetails] Oret WITH (NOLOCK) ON Oret.OrderId=a.OrderID AND Oret.[OrderStatusCode] = 'RET'
				OUTER APPLY OPENJSON(Oret.[OrderTransactionData], '$')
					  WITH(
							returnDt  DATE
						   ) AS RET

				WHERE  a.[OrderStatusCode] = 'PAY' 
						AND p.amountPaid is not null 
						AND ISJSON(b.[MemberData]) > 0 
						AND ISJSON(a.[OrderTransactionData]) > 0
						AND a.ISACTIVE = 1
						ANd b.OrderType not in ('OTC')




	







CREATE VIEW [ReportsData].[4_CRMOrders]
AS

select 
       a.OrderID
       ,a.NHMemberId
       ,ins.insuranceCarrierName  'Insurance Carrier Name'
       ,case when md.insuranceCarrierName = 'None' then md.programName else md.insurancePlanName end as 'Plan or Program Name'
       ,b.FirstName               'First Name'
       ,b.LastName                       'Last Name'
       ,case when convert(varchar,shpDetails.ReceivedDate, 101)      = '01/01/1900' then null else convert(varchar,shpDetails.ReceivedDate, 101) end                    'Order Received Date'
       ,case when a.source = 'VS' 
			then case when convert(varchar,a.CreateDate, 101) = '01/01/1980' then null else convert(varchar,a.CreateDate, 101) end 
			else convert(varchar, CAST(CAST(a.CreateDate AS DATETIME) AT TIME ZONE 'UTC'   AT TIME ZONE 'Eastern Standard Time' AS DATETIME), 101)
			end as 'Date Created'
       ,case when a.source = 'VS' 
			then case when convert(varchar,a.DateOrderInitiated, 101) = '01/01/1980' then null else convert(varchar,a.DateOrderInitiated, 101) end
			else convert(varchar, CAST(CAST(a.DateOrderInitiated AS DATETIME) AT TIME ZONE 'UTC'   AT TIME ZONE 'Eastern Standard Time' AS DATETIME), 101)
			end as 'Date Initiated'
       ,case when a.source = 'VS' 
			then case when convert(varchar,a.DateOrderReceived, 101) = '01/01/1980' then null else convert(varchar,a.DateOrderReceived, 101) end
			else convert(varchar, CAST(CAST(a.DateOrderReceived AS DATETIME) AT TIME ZONE 'UTC'   AT TIME ZONE 'Eastern Standard Time' AS DATETIME), 101)
			end as 'Date Received'
       ,case when a.source = 'VS' 
			then convert(varchar,approvals.approvedDate, 101) 
			else convert(varchar, CAST(CAST(approvals.createddate AS DATETIME) AT TIME ZONE 'UTC'   AT TIME ZONE 'Eastern Standard Time' AS DATETIME), 101) 
			end as 'Date Approved'
       ,approvals.approvedBy      'Approved By'
       ,a.OrderStatusCode         'Status Code'
       ,a.OrderType               'Order Type'
       ,a.Status                         'Status'
       ,vanilla.OrderStatus 'VanillaSoft Order Status (if exists)'
       ,pos.PONumber              'PONumber'
       ,(select sum(quantity) from orders.orderitems where orderid = a.orderid and itemtype in ('HA', 'CROS'))                   'Device Count'
       ,(select top 1 BrandCode from orders.orderitems where orderid = a.orderid and BrandCode is not NULL and itemtype in ('HA', 'CROS'))                   'Brand'
       ,(select top 1 StyleCode from orders.orderitems where orderid = a.orderid and StyleCode is not NULL and itemtype in ('HA', 'CROS'))                   'Style'
       ,(select top 1 TechnologyLevelCode from orders.orderitems where orderid = a.orderid and TechnologyLevelCode is not NULL and itemtype in ('HA', 'CROS'))      'Technology'
       ,'Tech Level' = (select top 1 FamilyProductCatCode from insurance.contractproducts where FamilyProductCode = (select top 1 TechnologyLevelCode from orders.orderitems where orderid = a.orderid and TechnologyLevelCode is not NULL and itemtype in ('HA', 'CROS')))
       ,od.productPrice           'Product Price'
       ,od.insuranceBenefit 'Benefit Amount (at time of purchase)'
       ,od.benefitUsed                   'Benefit Used (at time of purchase)'
       ,od.benefitAvailable 'Benefit Available (at time of purchase)'
       ,od.memberResponsibility 'Member Responsibility (at time of purchase)'
       ,leod.color                       'Left Ear Color'
       ,leod.batterySize          'Left Ear Battery Size'
       ,leod.receiverSize         'Left Ear Receiver Size'
       ,leod.receiverPower        'Left Ear Receiver Power'
       ,(select case when count(*) = 0 then 'FALSE' else 'TRUE' end as em from orders.orderitems where orderid = a.orderid and modifier = 'LT' and ItemType in ('EM')) 'Left Ear Earmolds'
       ,reod.color                       'Right Ear Color'
       ,reod.batterySize          'Right Ear Battery Size'
       ,reod.receiverSize         'Right Ear Receiver Size'
       ,reod.receiverPower        'Right Ear Receiver Power'
       ,(select case when count(*) = 0 then 'FALSE' else 'TRUE' end as em from orders.orderitems where orderid = a.orderid and modifier = 'RT' and ItemType in ('EM')) 'Right Ear Earmolds'
       ,ship.shippingInstructions 'Shipping Instructions'
       ,ship.providerBusinessName 'Ship To Name'
       ,ship.dba                                'Ship To DBA'
       ,ship.dispenser                          'Ship To Dispenser'
       ,ship.address1                           'Ship To Address1'
       ,ship.address2                           'Ship To Address2'
       ,ship.city                               'Ship To City'
       ,ship.state                              'Ship To State'
       ,ship.zip                                'Ship To Zip'
       ,ship.email                              'Ship To Email'
       ,prov.providerId                                       'ProviderId'
       ,prov.providerLeagalBusinessName         'Provider Name'
       ,prov.dba                                                     'Provider DBA'
       ,prov.dispenser                                               'Provider Dispenser'
       ,prov.state                                                   'Provider State'
       ,prov.zip                                                     'Provider Zip'
       ,shpDetails.orderConfirmationNo                 'Order Confirmation #'
       ,shpDetails.receivedBy                                 'Order Received By'
       ,shpDetails.leftHearingAidSerialNumber   'Left HA Serial Number'
       ,shpDetails.rightHearingAidSerialNumber  'Right HA Serial Number'
       ,shpDetails.hearingAidManufacturerInvoiceNumber 'Hearing Aid Mfg Invoice #'
       ,case when convert(varchar, shpDetails.hearingAidInvoiceDate, 101) = '01/01/1900' then null else convert(varchar, shpDetails.hearingAidInvoiceDate, 101) end     'Hearing Aid Invoice Date'
       ,shpDetails.manufacturerInvoiceNumber    'Earmold Mfg Invoice #'
       ,case when convert(varchar, shpDetails.invoiceDate, 101) = '01/01/1900' then null else convert(varchar, shpDetails.invoiceDate, 101) end      'Earmold Invoice Date'
       ,a.CreateUser                                          'Creator'
       ,docs.hipaa                                                   'HIPAA Received'
       ,docs.aob                                                     'AOB Received'
       ,docs.audiogram                                               'Audiogram Received'
       ,claims.deliveryReceipt                                'Delivery Receipt Received'
       ,claims.purchaseAgreementReceived                                    'Purchase Agreement Received'
       ,case when convert(varchar,docs.hipaaReceivedDate, 101)       = '01/01/1900' then null else convert(varchar,docs.hipaaReceivedDate, 101) end              'HIPAA Received Date'
       ,case when convert(varchar,docs.aobReceivedDate, 101) = '01/01/1900' then null else convert(varchar,docs.aobReceivedDate, 101) end                'AOB Received Date'
       ,case when convert(varchar,docs.audiogramReceivedDate, 101)   = '01/01/1900' then null else convert(varchar,docs.audiogramReceivedDate, 101) end   'Audiogram Received Date'
       ,case when convert(varchar,claims.claimSubmitDate, 101)       = '01/01/0001' then null else convert(varchar,claims.claimSubmitDate, 101) end              'Date Claim Submitted'
       ,case when convert(varchar,claims.fittingDate   , 101) = '01/01/0001' then null else convert(varchar,claims.fittingDate , 101) end                 'Date of Fitting'
       ,claims.claimSubmittedBy                        'Claim Submitted By'
       ,claims.claimAmount                                    'Claim Amount'
       ,claims.benefitAmount                                  'Benefit Amount (Sent to claim)'
from orders.Orders a with (nolock)
       outer apply openjson(case when ISJSON(a.MemberData) = 1 then a.MemberData else '{}' end) with (
              insuranceCarrierName varchar(300)  '$.insurance.carrierName'
              ,insurancePlanName         varchar(300)  '$.insurance.planName'
              ,programName               varchar(300)  '$.insurance.programeName'
              ,insCarrierId              int
       ) as md
       outer apply openjson(a.OrderAmountData) with (
              productPrice               decimal
              ,insuranceBenefit          decimal --RAJ changed to decimal 12/3/18
              ,benefitUsed               decimal --RAJ changed to decimal 12/3/18
              ,benefitAvailable          decimal --RAJ changed to decimal 12/3/18
              ,memberResponsibility      decimal
       ) as od
       outer apply openjson((select case when ItemData is NULL then '{}' else ItemData end as ItemData from orders.orderitems where orderid = a.orderid and modifier = 'LT' and ItemType in ('HA', 'CROS'))) with (
              color                varchar(50)
              ,batterySize  varchar(10)
              ,receiverSize varchar(10)
              ,receiverPower       varchar(20)
       ) as leod
       outer apply openjson((select case when ItemData is NULL then '{}' else ItemData end as ItemData from orders.orderitems where orderid = a.orderid and modifier = 'RT' and ItemType in ('HA', 'CROS'))) with (
              color                varchar(50)
              ,batterySize  varchar(10)
              ,receiverSize varchar(10)
              ,receiverPower       varchar(20)
       ) as reod
       outer apply openjson(a.ShippingData) with (
              providerBusinessName varchar(200)
              ,dba                              varchar(200)
              ,dispenser                        varchar(50)
              ,address1                         varchar(200) '$.address.address1'
              ,address2                         varchar(50) '$.address.address2'
              ,city                             varchar(100) '$.address.city'
              ,state                            varchar(10)   '$.address.state'
              ,zip                              varchar(10) '$.address.zip'
              ,email                            varchar(100)
              ,phoneNumber               varchar(15)
              ,shippingInstructions      varchar(400)
       ) as ship
       outer apply openjson(case when a.ProviderData = '' then '{}' else a.ProviderData end) with (
              providerLeagalBusinessName        varchar(200)
              ,dba                                            varchar(200)
              ,dispenser                                      varchar(50)
              ,state                                          varchar(2)           '$.address.state'
              ,zip                                            varchar(10)          '$.address.zip'
              ,providerId                                     bigint
       ) as prov
left outer join Insurance.InsuranceCarriers ins with (nolock) on ins.InsuranceCarrierId = md.insCarrierId
left outer join provider.memberprofiles b with (nolock) on a.NHMemberId = b.NHMemberId
left outer join (
       select OrderId, d.hipaa, d.aob, d.audiogram, d.hipaaReceivedDate, d.aobReceivedDate, d.audiogramReceivedDate
       from Orders.OrderTransactionDetails a with (nolock) 
       outer apply OPENJSON(a.OrderTransactionData) with (   
              hipaa                             varchar(10),  
              hipaaReceivedDate     datetime2,
              aob                               varchar(10),  
              aobReceivedDate            datetime2,
              audiogram                         varchar(10),  
              audiogramReceivedDate datetime2
       ) as [d]
       where OrderStatusCode = 'DOC'
) docs on a.orderid = docs.OrderID
left outer join (
       select OrderId, d.orderConfirmationNo, d.receivedBy, d.receivedDate, d.leftHearingAidSerialNumber, d.rightHearingAidSerialNumber, d.hearingAidManufacturerInvoiceNumber, d.hearingAidInvoiceDate, d.manufacturerInvoiceNumber, d.invoiceDate
       from orders.OrderTransactionDetails a with (nolock)
       outer apply OpenJson(a.OrderTransactionData) with (
              orderConfirmationNo        varchar(20)
              ,receivedBy                              varchar(100)
              ,receivedDate                     datetime2
              ,leftHearingAidSerialNumber varchar(20)
              ,rightHearingAidSerialNumber      varchar(20)
              ,hearingAidManufacturerInvoiceNumber     varchar(20)
              ,hearingAidInvoiceDate            datetime2
              ,manufacturerInvoiceNumber varchar(20)
              ,invoiceDate                      datetime2
       ) as d
       where OrderStatusCode = 'SHI'
) shpdetails on a.orderid = shpdetails.orderid
left outer join (
       select orderid, d.hearingTestCopayDue, d.hearingAidCopayDue, d.fittingCopayDue, d.hearingTestHCPCSCodes, d.claimSubmitDate, d.claimSubmittedBy, d.deliveryReceipt, d.purchaseAgreementReceived, d.claimAmount, d.benefitAmount, d.fittingDate
       from orders.OrderTransactionDetails a with (nolock)
       outer apply openjson(a.OrderTransactionData) with (
              claimSubmitDate                          datetime2
              ,claimSubmittedBy                 varchar(100)
              ,isClaimSubmitted                 bit
              ,claimAmount                      nvarchar(10)
              ,benefitAmount                           nvarchar(10)
              ,isComplete                              bit
              ,deliveryReceipt                  bit
              ,purchaseAgreementReceived bit
              ,hearingTestCopayDue       decimal '$.copayDues.htCopayDue'
              ,hearingAidCopayDue               decimal '$.copayDues.haCopayDue'
              ,fittingCopayDue                  decimal '$.copayDues.hfCopayDue'
              ,hearingTestHCPCSCodes            nvarchar(max) '$.hcpcs.htHCPCS'
              ,fittingDate                      datetime2
       ) as d
              --cross apply openjson(d.hearingTestHCPCSCodes) with (
                     --hcpcs varchar(10) '$'
              --) as htHCPCS
       where OrderStatusCode = 'CLM'
) claims on a.orderid = claims.orderid 
left outer join (
       select orderid, d.approvedBy, d.approvedDate, CreateDate createddate
       from orders.OrderTransactionDetails a with (nolock)
       outer apply openjson(a.OrderTransactionData) with (
              approvedBy           varchar(100)
              ,approvedDate datetime
              ,comments            varchar(200)
       ) as d
       where OrderStatusCode = 'APP'
) approvals on a.orderid = approvals.orderid


/*
left outer join (
       select orderid, d.poDate, d.poNumber
       from orders.OrderTransactionDetails a with (nolock)
       outer apply openjson(a.OrderTransactionData) with (
              poDate               datetime2
              ,poSentDate          datetime2
              ,poNumber            varchar(50)
       ) as d
       where OrderStatusCode = 'PO'
) pos on a.orderid = pos.orderid
*/
-- Updated code to eliminate PO's for EARMOLD items


left outer join (
       select t.* from 
		(
			select a.orderid, d.poDate, d.poNumber
				   from orders.OrderTransactionDetails a with (nolock)
	   
				   outer apply openjson(a.OrderTransactionData) with 
				   (
						  poDate               datetime2
						  ,poSentDate          datetime2
						  ,poNumber            varchar(50)
				   ) as d
				   where OrderStatusCode = 'PO'
		) t
		join (select distinct orderid,ponumber from  orders.OrderItems where ItemType in ('CROS','HA')) oi on (oi.OrderId=t.OrderID  and oi.PONumber=t.poNumber)
) pos on a.orderid = pos.orderid



left outer join (
       select PONumber, OrderStatus from [Orders].[MemberOrdersVStoCRM] with (nolock)
) vanilla on pos.poNumber = vanilla.PONumber

--where a.OrderID <> 180027543 -- added by SD on 12-07-2018 temporarly both HA were assigned as LT and subquery failed to run leod


CREATE VIEW [ReportsData].[2_OrdersNotApproved]
AS

SELECT  ORDERS.ORDERS.ORDERID, [OrderType],NHMEMBERID, 
        CONVERT(VARCHAR(10), DATEORDERRECEIVED, 101) AS 'Order Received Date', 
		CONVERT(VARCHAR(10), DATEORDERINITIATED, 101) AS 'Order Created Date', 
		BRANDCODE, FAMILYCODE, TECHNOLOGYLEVELCODE, STYLECODE, MODELCODE,DEVICECOUNT 
FROM    ORDERS.ORDERS 
WHERE ORDERS.ORDERS.ORDERID NOT IN
(SELECT DISTINCT ORDERID FROM ORDERS.ORDERTRANSACTIONDETAILS WHERE ORDERSTATUSCODE = 'APP')
AND 
	ORDERS.STATUS NOT IN ('CANCELLED','RETURNED')
AND 
	ORDERS.ORDERSOURCE NOT IN ('VS')






CREATE VIEW  [ReportsData].[7_viewAccountingNEW_COGS_DISP] AS
          SELECT DISTINCT
          o.NHMemberID,
          o.orderid AS 'OrderNumber',
          o.Source AS 'OrderSource',
          DS.DataSource AS 'EligSource',
		  CAST(o.[DateOrderReceived] AS DATE) AS 'OrderRcvdDate',
		  CAST(o.[DateOrderInitiated] AS DATE) AS 'OrderCreatedDate',
          o.[OrderType],
          (CASE WHEN o.[OrderType] IN ('EXCHANGE','LSandD') THEN o.[OrderType] +'( of order:' + case when o.[RefOrderId] is null then ' ' else  CAST(o.[RefOrderId]AS VARCHAR)  end + ')'
          ELSE o.[OrderType]
          END) 'OrderRef',
          o.[Status],
          (CASE WHEN JSON_VALUE(O.MEMBERDATA, '$.insurance.carrierName') = 'None' OR
          JSON_VALUE(O.MEMBERDATA, '$.insurance.carrierName') = '' THEN
          JSON_VALUE(O.MEMBERDATA, '$.insurance.programeName')
          ELSE JSON_VALUE(O.MEMBERDATA, '$.insurance.carrierName')
          END) AS 'Carrier',
          JSON_VALUE(O.MEMBERDATA, '$.insurance.planName') AS 'Plan',
          JSON_VALUE([MemberData],'$.firstName') AS [MemberFirstName],
          JSON_VALUE([MemberData],'$.lastName') AS [MemberLastName],
          JSON_VALUE([ProviderData],'$.providerId') AS [ProviderID],
          JSON_VALUE([ProviderData],'$.providerLeagalBusinessName') AS [ProviderLegalName],
          JSON_VALUE([ProviderData],'$.dba') AS [ProviderDBA],
          JSON_VALUE([ProviderData],'$.dispenser') AS [ProviderDispenser],
          JSON_VALUE([ProviderData],'$.address.address') AS [ProviderAddress],
          JSON_VALUE([ProviderData],'$.address.city') AS [ProviderCity],
          JSON_VALUE([ProviderData],'$.address.state') AS [ProviderState],
          JSON_VALUE([ProviderData],'$.address.zip') AS [ProviderZip],
          JSON_VALUE([ShippingData],'$.dba') AS [ShippingDBA],
          JSON_VALUE([ShippingData],'$.dispenser') AS [ShippingDispenser],
          [BrandCode] AS [Manufacturer] ,
          [FamilyCode] AS [Family],
          [TechnologyLevelCode] [Product],
          P.FAMILYPRODUCTCATCODE [TechnologyLevel],
          [DeviceCount] AS 'Qty',
          CASE WHEN [DeviceCountRet] is NULL THEN '' ELSE [DeviceCountRet] END AS 'QtyReturned',
          cg.UnitCOGS AS 'COGS',
          cg.UnitCOGS * ([DeviceCount]-( CASE WHEN [DeviceCountRet] is NULL THEN '' ELSE [DeviceCountRet] END)) AS 'TotalCOGS',
          (CASE WHEN CAST(JSON_VALUE([OrderAmountData],'$.insuranceBenefit') AS NVARCHAR(10)) IS NULL THEN 0
          ELSE CAST(JSON_VALUE([OrderAmountData],'$.insuranceBenefit') AS DECIMAL)
          END) [BenefitAmount],

          (CASE WHEN CAST(JSON_VALUE([OrderAmountData],'$.medicaidBenefit') AS NVARCHAR(10)) IS NULL THEN 0
          ELSE CAST(JSON_VALUE([OrderAmountData],'$.medicaidBenefit') AS DECIMAL)
          END) [medicaidBenefit],

          (CASE WHEN CAST(JSON_VALUE([OrderAmountData],'$.productPrice') AS NVARCHAR(10)) IS NULL THEN 0
          ELSE CAST(JSON_VALUE([OrderAmountData],'$.productPrice') AS DECIMAL)
          END) AS [ProductPrice],
          (CASE WHEN CAST(JSON_VALUE([OrderAmountData],'$.benefitAvailable') AS NVARCHAR(10)) IS NULL THEN 0
          ELSE CAST(JSON_VALUE([OrderAmountData],'$.benefitAvailable') AS DECIMAL)
          END) AS [BenefitAvailable],
          (CASE WHEN CAST(JSON_VALUE([OrderAmountData],'$.adjustments') AS NVARCHAR(10)) IS NULL THEN 0
          ELSE CAST(JSON_VALUE([OrderAmountData],'$.adjustments') AS DECIMAL)
          END) AS [AdjustmentAmount],
          (CASE WHEN CAST(JSON_VALUE([OrderAmountData],'$.memberResponsibility') AS NVARCHAR(10)) IS NULL THEN 0
			  ELSE CAST(JSON_VALUE([OrderAmountData],'$.memberResponsibility') AS DECIMAL)
			  END) AS [MemberResponsibleAmount],
		(CASE WHEN CAST(JSON_VALUE([OrderAmountData],'$.exchangeCredit') AS NVARCHAR(10)) IS NULL THEN 0
			ELSE CAST(JSON_VALUE([OrderAmountData],'$.exchangeCredit') AS DECIMAL)
			END) AS [ExchangeCredit],
		(CASE WHEN CAST(JSON_VALUE([OrderAmountData],'$.cancelCredit') AS NVARCHAR(10)) IS NULL THEN 0
			ELSE CAST(JSON_VALUE([OrderAmountData],'$.cancelCredit') AS DECIMAL)
			END) AS [CancelCredit],
          (CASE WHEN CAST(PAY.[PaymentAmount1] AS DECIMAL) + CAST(PAY.[PaymentAmount2] AS DECIMAL) + CAST(PAY.[PaymentAmount3] AS DECIMAL) IS NULL THEN 0
			  ELSE CAST(PAY.[PaymentAmount1] AS DECIMAL) + CAST(PAY.[PaymentAmount2] AS DECIMAL) + CAST(PAY.[PaymentAmount3] AS DECIMAL)
			  END) 'MemberPayment',		  
			CASE when REF.RefundAmount IS NULL THEN 0 else REF.RefundAmount END RefundAmount,
          (CASE WHEN PO.PONumber IS NULL THEN ''
			  ELSE PO.PONumber
			  END) AS 'PONumber',
          (CASE WHEN PO.[PO DATE] IS NULL THEN NULL WHEN PO.[PO DATE] ='' THEN NULL
			  ELSE cast(PO.[PO DATE] as date)
			  END) AS 'PODate',	
          (CASE WHEN CLM.[Fitting Date] IS NULL THEN NULL  WHEN CLM.[Fitting Date] ='' THEN NULL
			  ELSE cast(CLM.[Fitting Date] as date)
			  END) AS 'FittingDate' ,
          (CASE WHEN CLM.[PurchaseDate] IS NULL THEN NULL WHEN CLM.[PurchaseDate] ='' THEN NULL
			  ELSE cast(CLM.[PurchaseDate] as date)
			  END) AS 'PurchaseAgreementDate',
          (CASE WHEN CLM.[DeliveryDate] IS NULL THEN NULL WHEN CLM.[DeliveryDate] ='' THEN NULL
			  ELSE cast(CLM.[DeliveryDate] as date)
			  END) AS 'DeliveryRcptDate',
		   (CASE WHEN CLM.[ClaimDate] IS NULL THEN NULL WHEN CLM.[ClaimDate] ='' THEN NULL
			  ELSE cast(CLM.[ClaimDate] as date)
			  END) AS 'ClaimDate',
          (CASE WHEN RET.[Return Date] IS NULL THEN NULL  WHEN RET.[Return Date] ='' THEN NULL
			  ELSE cast(RET.[Return Date] as date)
			  END) AS 'ReturnDate',
          (CASE WHEN CLM.[Claim Required] IS NULL THEN '' ELSE CLM.[Claim Required]  END) AS 'ClaimRequired',
          P.[PerDeviceDispensingFee] [FittingFeePerDevice],
          CASE WHEN ([DeviceCount]-( CASE WHEN [DeviceCountRet] is NULL THEN 0 ELSE [DeviceCountRet] END))=2 THEN P.[PerPairDispensingFee] 
				WHEN  ([DeviceCount]-( CASE WHEN [DeviceCountRet] is NULL THEN 0 ELSE [DeviceCountRet] END))=1 THEN P.[PerDeviceDispensingFee] ELSE 0 END AS 'TotalFittingFee',
          CLM.[ClaimAmount]  'ClaimAmount',
          JSON_VALUE(O.MEMBERDATA, '$.insurance.carrierName') + ':' + JSON_VALUE([MemberData],'$.firstName') + ' ' +JSON_VALUE([MemberData],'$.lastName') AS 'QBJobName'
          FROM
          (
          SELECT s.* , oi.BrandCode, oi.FamilyCode, oi.StyleCode, oi.TechnologyLevelCode, oi.ProductModelCode, oi.ItemCode, oq.DeviceCount, oqret.DeviceCountRet
          FROM orders.orders s
          INNER JOIN
          (
          SELECT DISTINCT orderid, BrandCode, FamilyCode, StyleCode, TechnologyLevelCode, ProductModelCode, ItemCode
          FROM orders.OrderItems
          WHERE 1 = 1
          AND ItemType IN ('HA')
          AND IsActive = 1
          ) oi ON (oi.orderid = s.orderid)
          INNER JOIN
          (
			  SELECT orderid, SUM(Quantity) DeviceCount
			  FROM orders.OrderItems
			  WHERE 1 = 1
			  AND ItemType IN ('HA','CROS')
			  AND IsActive = 1
			  GROUP BY ORDERID
          ) oq ON (oq.orderid = s.orderid)
		  LEFT JOIN
          (
			  SELECT orderid, SUM(Quantity) DeviceCountRet
			  FROM orders.OrderItems
			  WHERE 1 = 1
			  AND ItemType IN ('HA','CROS')
			  AND IsActive = 1
			  and STATUS='RETURNED'
			  GROUP BY ORDERID,STATUS
          ) oqret ON (oqret.orderid = s.orderid)
          )  O
          LEFT OUTER JOIN
          (
			  SELECT ORDERID,[OrderTransactionData],
				  (CASE WHEN CONVERT(VARCHAR(10),JSON_VALUE([OrderTransactionData],'$.fittingDate'),101)  = '01/01/0001' THEN ''
				  WHEN CONVERT(VARCHAR(10),JSON_VALUE([OrderTransactionData],'$.fittingDate'),101) IS NULL THEN ''
				  ELSE CONVERT(VARCHAR(10),JSON_VALUE([OrderTransactionData],'$.fittingDate'),101)
				  END)  AS [Fitting Date],
			  JSON_VALUE([OrderTransactionData],'$.purchaseAgreementReceived') AS [PurchaseAgreementRcvd],
			  (CASE WHEN CONVERT(VARCHAR(10),JSON_VALUE([OrderTransactionData],'$.purchaseDate'),101) IS NULL THEN ''
			  ELSE CONVERT(VARCHAR(10),JSON_VALUE([OrderTransactionData],'$.purchaseDate'),101)
			  END) AS [PurchaseDate],
			  JSON_VALUE([OrderTransactionData],'$.deliveryReceipt') AS [DeliveryReceiptRcvd],
			  (CASE WHEN CONVERT(VARCHAR(10),JSON_VALUE([OrderTransactionData],'$.deliveryDate'),101) IS NULL THEN ''
			  ELSE CONVERT(VARCHAR(10),JSON_VALUE([OrderTransactionData],'$.deliveryDate'),101)
			  END) AS [DeliveryDate],
				(CASE WHEN CONVERT(VARCHAR(10),JSON_VALUE([OrderTransactionData],'$.claimSubmitDate'),101) IS NULL THEN ''
			  ELSE CONVERT(VARCHAR(10),JSON_VALUE([OrderTransactionData],'$.claimSubmitDate'),101)
			  END) AS [ClaimDate],
			  JSON_VALUE([OrderTransactionData],'$.isClaimSubmitted') AS [Claim Required]
			  ,(CASE WHEN JSON_VALUE([OrderTransactionData],'$.claimAmount') IS NULL THEN 0  WHEN JSON_VALUE([OrderTransactionData],'$.claimAmount') ='' THEN 0
				  ELSE  CAST(JSON_VALUE([OrderTransactionData],'$.claimAmount') AS decimal(18,2))
				  END) AS [ClaimAmount]
			  FROM
			  [Orders].[OrderTransactionDetails] OD1 WITH (NOLOCK)
			  WHERE OD1.OrderStatusCode='CLM' AND IsActive=1
          )CLM ON (O.ORDERID = CLM.ORDERID)
          LEFT OUTER JOIN
          (
          SELECT CAST(JSON_VALUE(Ordertransactiondata,'$.returnDt') AS DATE) [Return Date],ORDERID
          FROM
          [Orders].[OrderTransactionDetails] OD1 WITH (NOLOCK)
          WHERE OD1.OrderStatusCode='RET' AND IsActive=1
          )RET ON (O.ORDERID = RET.ORDERID)
		   LEFT OUTER JOIN
          (
          SELECT CAST(JSON_VALUE(Ordertransactiondata,'$.returnDt') AS DATE) [Refund Date],JSON_VALUE([OrderTransactionData],'$.transactions[0].amountPaid') RefundAmount,ORDERID
          FROM
          [Orders].[OrderTransactionDetails] OD1 WITH (NOLOCK)
          WHERE OD1.OrderStatusCode='REF' AND IsActive=1
          )REF ON (O.ORDERID = REF.ORDERID)
          LEFT OUTER JOIN
          (
          SELECT  ORDERID,
          (CASE
          WHEN JSON_VALUE([OrderTransactionData],'$.transactions[0].amountPaid') IS NULL THEN 0
          ELSE CAST(JSON_VALUE([OrderTransactionData],'$.transactions[0].amountPaid')  AS DECIMAL)
          END) [PaymentAmount1],
          (CASE
          WHEN JSON_VALUE([OrderTransactionData],'$.transactions[1].amountPaid') IS NULL THEN 0
          ELSE CAST(JSON_VALUE([OrderTransactionData],'$.transactions[1].amountPaid') AS DECIMAL)
          END) [PaymentAmount2],
          (CASE
          WHEN JSON_VALUE([OrderTransactionData],'$.transactions[2].amountPaid') IS NULL THEN 0
          ELSE CAST(JSON_VALUE([OrderTransactionData],'$.transactions[2].amountPaid') AS DECIMAL)
          END) [PaymentAmount3],
          (CASE
          WHEN JSON_VALUE([OrderTransactionData],'$.transactions[3].amountPaid') IS NULL THEN 0
          ELSE CAST(JSON_VALUE([OrderTransactionData],'$.transactions[3].amountPaid') AS DECIMAL)
          END) [PaymentAmount4]
          FROM
          [Orders].[OrderTransactionDetails] OD3 WITH (NOLOCK)
          WHERE OD3.OrderStatusCode='PAY' AND IsActive=1
          )PAY ON (O.ORDERID = PAY.ORDERID)
          LEFT OUTER JOIN
          (
          SELECT ORDERID,
          ISNULL(json_value(OrdertransactionData, '$.poDate'),json_value(OrdertransactionData, '$[0].poDate'))  AS [PO DATE],
          ISNULL(json_value(OrdertransactionData, '$.poNumber'),json_value(OrdertransactionData, '$[0].poNumber')) AS PONumber
          FROM   [Orders].[OrderTransactionDetails] OD4 WITH (NOLOCK)
          WHERE OD4.OrderStatusCode='PO' AND IsActive=1
          )PO
          ON (O.ORDERID = PO.ORDERID)

          LEFT OUTER JOIN Insurance.HealthPlanContracts B ON B.InsuranceHealthPlanID = JSON_VALUE(O.MEMBERDATA, '$.insPlanId')
          LEFT OUTER JOIN (SELECT DISTINCT HealthPlanContractID,FAMILYPRODUCTCATCODE, 0 [PerDeviceCOGSPrice],[PerDeviceDispensingFee] , ITEMCODE,PerPairDispensingFee
          FROM INSURANCE.CONTRACTPRODUCTS where (BrandCode='STARKEY' AND IsActive=1)  OR  (BrandCode!='STARKEY' ) ) P ON ((case when O.ItemCode like '%DWRZ' then replace(O.ItemCode, 'DWRZ', 'DRWZ') else O.ItemCode end) = P.ITEMCODE AND P.HealthPlanContractId = B.HealthPlanContractId)

		  LEFT JOIN bireports.POrderCOGS cg on (cg.OrderNumber=o.OrderID)
          INNER JOIN [Master].[Members] DS WITH (NOLOCK) ON DS.[NHMemberID] = O.NHMemberID AND DS.IsActive=1

          WHERE
          O.IsActive=1
          AND O.Status <> 'ALAN'
		  AND O.OrderType not in ('OTC')

		  UNION

		  
          SELECT DISTINCT
          o.NHMemberID,
          o.orderid AS 'OrderNumber',
          o.Source AS 'OrderSource',
          DS.DataSource AS 'EligSource',
		  CAST(o.[DateOrderReceived] AS DATE) AS 'OrderRcvdDate',
		  CAST(o.[DateOrderInitiated] AS DATE) AS 'OrderCreatedDate',
          o.[OrderType],
          (CASE WHEN o.[OrderType] IN ('EXCHANGE','LSandD') THEN o.[OrderType] +'( of order:' + case when o.[RefOrderId] is null then ' ' else  CAST(o.[RefOrderId]AS VARCHAR)  end + ')'
          ELSE o.[OrderType]
          END) 'OrderRef',
          o.[Status],
          (CASE WHEN JSON_VALUE(O.MEMBERDATA, '$.insurance.carrierName') = 'None' OR
          JSON_VALUE(O.MEMBERDATA, '$.insurance.carrierName') = '' THEN
          JSON_VALUE(O.MEMBERDATA, '$.insurance.programeName')
          ELSE JSON_VALUE(O.MEMBERDATA, '$.insurance.carrierName')
          END) AS 'Carrier',
          JSON_VALUE(O.MEMBERDATA, '$.insurance.planName') AS 'Plan',
          JSON_VALUE([MemberData],'$.firstName') AS [MemberFirstName],
          JSON_VALUE([MemberData],'$.lastName') AS [MemberLastName],
          JSON_VALUE([ProviderData],'$.providerId') AS [ProviderID],
          JSON_VALUE([ProviderData],'$.providerLeagalBusinessName') AS [ProviderLegalName],
          JSON_VALUE([ProviderData],'$.dba') AS [ProviderDBA],
          JSON_VALUE([ProviderData],'$.dispenser') AS [ProviderDispenser],
          JSON_VALUE([ProviderData],'$.address.address') AS [ProviderAddress],
          JSON_VALUE([ProviderData],'$.address.city') AS [ProviderCity],
          JSON_VALUE([ProviderData],'$.address.state') AS [ProviderState],
          JSON_VALUE([ProviderData],'$.address.zip') AS [ProviderZip],
          JSON_VALUE([ShippingData],'$.dba') AS [ShippingDBA],
          JSON_VALUE([ShippingData],'$.dispenser') AS [ShippingDispenser],
          [BrandCode] AS [Manufacturer] ,
          [FamilyCode] AS [Family],
          [TechnologyLevelCode] [Product],
          P.FAMILYPRODUCTCATCODE [TechnologyLevel],
          [DeviceCount] AS 'Qty',
          CASE WHEN [DeviceCountRet] is NULL THEN '' ELSE [DeviceCountRet] END AS 'QtyReturned',
          cg.UnitCOGS AS 'COGS',
          cg.UnitCOGS * ([DeviceCount]-( CASE WHEN [DeviceCountRet] is NULL THEN '' ELSE [DeviceCountRet] END)) AS 'TotalCOGS',
          (CASE WHEN CAST(JSON_VALUE([OrderAmountData],'$.insuranceBenefit') AS NVARCHAR(10)) IS NULL THEN 0
          ELSE CAST(JSON_VALUE([OrderAmountData],'$.insuranceBenefit') AS DECIMAL)
          END) [BenefitAmount],

          (CASE WHEN CAST(JSON_VALUE([OrderAmountData],'$.medicaidBenefit') AS NVARCHAR(10)) IS NULL THEN 0
          ELSE CAST(JSON_VALUE([OrderAmountData],'$.medicaidBenefit') AS DECIMAL)
          END) [medicaidBenefit],

          (CASE WHEN CAST(JSON_VALUE([OrderAmountData],'$.productPrice') AS NVARCHAR(10)) IS NULL THEN 0
          ELSE CAST(JSON_VALUE([OrderAmountData],'$.productPrice') AS DECIMAL)
          END) AS [ProductPrice],
          (CASE WHEN CAST(JSON_VALUE([OrderAmountData],'$.benefitAvailable') AS NVARCHAR(10)) IS NULL THEN 0
          ELSE CAST(JSON_VALUE([OrderAmountData],'$.benefitAvailable') AS DECIMAL)
          END) AS [BenefitAvailable],
          (CASE WHEN CAST(JSON_VALUE([OrderAmountData],'$.adjustments') AS NVARCHAR(10)) IS NULL THEN 0
          ELSE CAST(JSON_VALUE([OrderAmountData],'$.adjustments') AS DECIMAL)
          END) AS [AdjustmentAmount],
          (CASE WHEN CAST(JSON_VALUE([OrderAmountData],'$.memberResponsibility') AS NVARCHAR(10)) IS NULL THEN 0
			  ELSE CAST(JSON_VALUE([OrderAmountData],'$.memberResponsibility') AS DECIMAL)
			  END) AS [MemberResponsibleAmount],
		(CASE WHEN CAST(JSON_VALUE([OrderAmountData],'$.exchangeCredit') AS NVARCHAR(10)) IS NULL THEN 0
			ELSE CAST(JSON_VALUE([OrderAmountData],'$.exchangeCredit') AS DECIMAL)
			END) AS [ExchangeCredit],
		(CASE WHEN CAST(JSON_VALUE([OrderAmountData],'$.cancelCredit') AS NVARCHAR(10)) IS NULL THEN 0
			ELSE CAST(JSON_VALUE([OrderAmountData],'$.cancelCredit') AS DECIMAL)
			END) AS [CancelCredit],
          (CASE WHEN CAST(PAY.[PaymentAmount1] AS DECIMAL) + CAST(PAY.[PaymentAmount2] AS DECIMAL) + CAST(PAY.[PaymentAmount3] AS DECIMAL) IS NULL THEN 0
			  ELSE CAST(PAY.[PaymentAmount1] AS DECIMAL) + CAST(PAY.[PaymentAmount2] AS DECIMAL) + CAST(PAY.[PaymentAmount3] AS DECIMAL)
			  END) 'MemberPayment',		     
			CASE when REF.RefundAmount IS NULL THEN 0 else REF.RefundAmount END RefundAmount,
          (CASE WHEN PO.PONumber IS NULL THEN ''
			  ELSE PO.PONumber
			  END) AS 'PONumber',
          (CASE WHEN PO.[PO DATE] IS NULL THEN NULL WHEN PO.[PO DATE] ='' THEN NULL
			  ELSE cast(PO.[PO DATE] as date)
			  END) AS 'PODate',	
          (CASE WHEN CLM.[Fitting Date] IS NULL THEN NULL  WHEN CLM.[Fitting Date] ='' THEN NULL
			  ELSE cast(CLM.[Fitting Date] as date)
			  END) AS 'FittingDate' ,
          (CASE WHEN CLM.[PurchaseDate] IS NULL THEN NULL WHEN CLM.[PurchaseDate] ='' THEN NULL
			  ELSE cast(CLM.[PurchaseDate] as date)
			  END) AS 'PurchaseAgreementDate',
          (CASE WHEN CLM.[DeliveryDate] IS NULL THEN NULL WHEN CLM.[DeliveryDate] ='' THEN NULL
			  ELSE cast(CLM.[DeliveryDate] as date)
			  END) AS 'DeliveryRcptDate',
		   (CASE WHEN CLM.[ClaimDate] IS NULL THEN NULL WHEN CLM.[ClaimDate] ='' THEN NULL
			  ELSE cast(CLM.[ClaimDate] as date)
			  END) AS 'ClaimDate',
          (CASE WHEN RET.[Return Date] IS NULL THEN NULL  WHEN RET.[Return Date] ='' THEN NULL 
			  ELSE cast(RET.[Return Date] as date)
			  END) AS 'ReturnDate',
          (CASE WHEN CLM.[Claim Required] IS NULL THEN '' ELSE CLM.[Claim Required]  END) AS 'ClaimRequired',
          P.[PerDeviceDispensingFee] [FittingFeePerDevice],
          CASE WHEN ([DeviceCount]-( CASE WHEN [DeviceCountRet] is NULL THEN 0 ELSE [DeviceCountRet] END))=2 THEN P.[PerPairDispensingFee] 
				WHEN  ([DeviceCount]-( CASE WHEN [DeviceCountRet] is NULL THEN 0 ELSE [DeviceCountRet] END))=1 THEN P.[PerDeviceDispensingFee] ELSE 0 END AS 'TotalFittingFee',
          CLM.[ClaimAmount]   'ClaimAmount',
          JSON_VALUE(O.MEMBERDATA, '$.insurance.carrierName') + ':' + JSON_VALUE([MemberData],'$.firstName') + ' ' +JSON_VALUE([MemberData],'$.lastName') AS 'QBJobName'
          FROM
          (
          SELECT s.* , oi.BrandCode, oi.FamilyCode, oi.StyleCode, oi.TechnologyLevelCode, oi.ProductModelCode, oi.ItemCode, oq.DeviceCount, oqret.DeviceCountRet
          FROM orders.orders s
          INNER JOIN
          (
			  SELECT DISTINCT orderid, BrandCode, FamilyCode, StyleCode, TechnologyLevelCode, ProductModelCode, ItemCode
			  FROM orders.OrderItems
			  WHERE 1 = 1
			  AND ItemType IN ('CROS')
			  AND IsActive = 1
			  and OrderId in (
			  select orderid from orders.OrderItems group by orderid having count(1)=1
			  )
          ) oi ON (oi.orderid = s.orderid)
          INNER JOIN
          (
          SELECT orderid, SUM(Quantity) DeviceCount
          FROM orders.OrderItems
          WHERE 1 = 1
          AND ItemType IN ('HA','CROS')
          AND IsActive = 1
          GROUP BY ORDERID
          ) oq ON (oq.orderid = s.orderid)
		  LEFT JOIN
          (
			  SELECT orderid, SUM(Quantity) DeviceCountRet
			  FROM orders.OrderItems
			  WHERE 1 = 1
			  AND ItemType IN ('HA','CROS')
			  AND IsActive = 1
			  and STATUS='RETURNED'
			  GROUP BY ORDERID,STATUS
          ) oqret ON (oqret.orderid = s.orderid)
          )  O
          LEFT OUTER JOIN
          (
          SELECT ORDERID,[OrderTransactionData],
          (CASE WHEN CONVERT(VARCHAR(10),JSON_VALUE([OrderTransactionData],'$.fittingDate'),101)  = '01/01/0001' THEN ''
          WHEN CONVERT(VARCHAR(10),JSON_VALUE([OrderTransactionData],'$.fittingDate'),101) IS NULL THEN ''
          ELSE CONVERT(VARCHAR(10),JSON_VALUE([OrderTransactionData],'$.fittingDate'),101)
          END)  AS [Fitting Date],
          JSON_VALUE([OrderTransactionData],'$.purchaseAgreementReceived') AS [PurchaseAgreementRcvd],
          (CASE WHEN CONVERT(VARCHAR(10),JSON_VALUE([OrderTransactionData],'$.purchaseDate'),101) IS NULL THEN ''
          ELSE CONVERT(VARCHAR(10),JSON_VALUE([OrderTransactionData],'$.purchaseDate'),101)
          END) AS [PurchaseDate],
          JSON_VALUE([OrderTransactionData],'$.deliveryReceipt') AS [DeliveryReceiptRcvd],
          (CASE WHEN CONVERT(VARCHAR(10),JSON_VALUE([OrderTransactionData],'$.deliveryDate'),101) IS NULL THEN ''
          ELSE CONVERT(VARCHAR(10),JSON_VALUE([OrderTransactionData],'$.deliveryDate'),101)
          END) AS [DeliveryDate],
		    (CASE WHEN CONVERT(VARCHAR(10),JSON_VALUE([OrderTransactionData],'$.claimSubmitDate'),101) IS NULL THEN ''
          ELSE CONVERT(VARCHAR(10),JSON_VALUE([OrderTransactionData],'$.claimSubmitDate'),101)
          END) AS [ClaimDate],
          JSON_VALUE([OrderTransactionData],'$.isClaimSubmitted') AS [Claim Required],
           (CASE WHEN  JSON_VALUE([OrderTransactionData],'$.claimAmount') IS NULL THEN 0  WHEN  JSON_VALUE([OrderTransactionData],'$.claimAmount') ='' THEN 0
          ELSE  CAST(JSON_VALUE([OrderTransactionData],'$.claimAmount') AS DECIMAL(18,2))
          END) AS [ClaimAmount]
          FROM
          [Orders].[OrderTransactionDetails] OD1 WITH (NOLOCK)
          WHERE OD1.OrderStatusCode='CLM' AND IsActive=1
          )CLM ON (O.ORDERID = CLM.ORDERID)
          LEFT OUTER JOIN
          (
          SELECT CAST(JSON_VALUE(Ordertransactiondata,'$.returnDt') AS DATE) [Return Date],ORDERID
          FROM
          [Orders].[OrderTransactionDetails] OD1 WITH (NOLOCK)
          WHERE OD1.OrderStatusCode='RET' AND IsActive=1
          )RET ON (O.ORDERID = RET.ORDERID)
		   LEFT OUTER JOIN
          (
          SELECT CAST(JSON_VALUE(Ordertransactiondata,'$.returnDt') AS DATE) [Refund Date],JSON_VALUE([OrderTransactionData],'$.transactions[0].amountPaid') RefundAmount,ORDERID
          FROM
          [Orders].[OrderTransactionDetails] OD1 WITH (NOLOCK)
          WHERE OD1.OrderStatusCode='REF' AND IsActive=1
          )REF ON (O.ORDERID = REF.ORDERID)
          LEFT OUTER JOIN
          (
          SELECT  ORDERID,
          (CASE
          WHEN JSON_VALUE([OrderTransactionData],'$.transactions[0].amountPaid') IS NULL THEN 0
          ELSE CAST(JSON_VALUE([OrderTransactionData],'$.transactions[0].amountPaid')  AS DECIMAL)
          END) [PaymentAmount1],
          (CASE
          WHEN JSON_VALUE([OrderTransactionData],'$.transactions[1].amountPaid') IS NULL THEN 0
          ELSE CAST(JSON_VALUE([OrderTransactionData],'$.transactions[1].amountPaid') AS DECIMAL)
          END) [PaymentAmount2],
          (CASE
          WHEN JSON_VALUE([OrderTransactionData],'$.transactions[2].amountPaid') IS NULL THEN 0
          ELSE CAST(JSON_VALUE([OrderTransactionData],'$.transactions[2].amountPaid') AS DECIMAL)
          END) [PaymentAmount3],
          (CASE
          WHEN JSON_VALUE([OrderTransactionData],'$.transactions[3].amountPaid') IS NULL THEN 0
          ELSE CAST(JSON_VALUE([OrderTransactionData],'$.transactions[3].amountPaid') AS DECIMAL)
          END) [PaymentAmount4]
          FROM
          [Orders].[OrderTransactionDetails] OD3 WITH (NOLOCK)
          WHERE OD3.OrderStatusCode='PAY' AND IsActive=1
          )PAY ON (O.ORDERID = PAY.ORDERID)
          LEFT OUTER JOIN
          (
          SELECT ORDERID,
          ISNULL(json_value(OrdertransactionData, '$.poDate'),json_value(OrdertransactionData, '$[0].poDate'))  AS [PO DATE],
          ISNULL(json_value(OrdertransactionData, '$.poNumber'),json_value(OrdertransactionData, '$[0].poNumber')) AS PONumber
          FROM   [Orders].[OrderTransactionDetails] OD4 WITH (NOLOCK)
          WHERE OD4.OrderStatusCode='PO' AND IsActive=1
          )PO
          ON (O.ORDERID = PO.ORDERID)

          LEFT OUTER JOIN Insurance.HealthPlanContracts B ON B.InsuranceHealthPlanID = JSON_VALUE(O.MEMBERDATA, '$.insPlanId')
          LEFT OUTER JOIN (SELECT DISTINCT HealthPlanContractID,FAMILYPRODUCTCATCODE, 0 [PerDeviceCOGSPrice],[PerDeviceDispensingFee] , ITEMCODE,PerPairDispensingFee
          FROM INSURANCE.CONTRACTPRODUCTS where (BrandCode='STARKEY' AND IsActive=1)  OR  (BrandCode!='STARKEY' ) ) P ON ((case when O.ItemCode like '%DWRZ' then replace(O.ItemCode, 'DWRZ', 'DRWZ') else O.ItemCode end) = P.ITEMCODE AND P.HealthPlanContractId = B.HealthPlanContractId)

          INNER JOIN [Master].[Members] DS WITH (NOLOCK) ON DS.[NHMemberID] = O.NHMemberID AND DS.IsActive=1

		  LEFT JOIN bireports.POrderCOGS cg on (cg.OrderNumber=o.OrderID)
          WHERE
          O.IsActive=1
          AND O.Status <> 'ALAN'
		  AND O.OrderType not in ('OTC')








CREATE VIEW  [ReportsData].[viewMemberInfoRpt1]
 AS
    
select distinct 
		provider.MemberProfiles.NHMemberId  [NHMemberId]
		,case 
			when (Insurance.InsuranceCarriers.InsuranceCarrierName like '%none%' or Insurance.InsuranceCarriers.InsuranceCarrierName is null) then 'None'
			else Insurance.InsuranceCarriers.InsuranceCarrierName end as [Program Name]
			,hp.HealthPlanName
		,callconversations.lastcalltime_est                                                         [Last Time Called]
		,callconversations.firstcalltime_est                                         [First Time Called]
		,callevents.ParentEventName															[Disposition]
		,callevents.eventname																[Reason]
		,provider.MemberProfiles.FirstName                                                     [First Name]
		,provider.MemberProfiles.LastName                                                     [Last Name]
		,case when provider.MemberProfiles.DateOfBirth = CONVERT(datetime2, '0001-01-01 00:00:00.0000000') then NULL else cast(provider.MemberProfiles.DateOfBirth as date) end as DOB
		,case when Insurance.InsuranceCarriers.InsuranceCarrierName like '%none%' or Insurance.InsuranceCarriers.InsuranceCarrierName is null then '' else provider.MemberInsuranceDetails.InsuranceNbr end as [Member Insurance ID]
		,case when ContractBenefits.BenefitAmt is NULL then 0 else ContractBenefits.BenefitAmt end             [Benefit Amount]
		,COALESCE(memberlocations.Address1, ' ') + ' ' + COALESCE(memberlocations.Address2, ' ') Address
		,memberlocations.City                                                                                              [City]
		,memberlocations.State                                                                                           [State]
		,memberlocations.ZipCode                                                                                      [ZipCode]
		,[Member Phone Number] = (select top 1 phonenumber from provider.memberphonenumbers where provider.memberphonenumbers.memberprofileid = provider.memberprofiles.memberprofileid and isActive = 1 and (phonetypeid= 1 or phonetypeid = 4))
		,provider.AppointmentTypes.AppointmentTypeName      [Appointment Type Name]
		,cast(MemberAppointments.StartDate as Date)                 [Latest Appt Date]
		,cast((CAST(MemberAppointments.CreateDate AT TIME ZONE 'UTC' AT TIME ZONE 'Eastern Standard Time' AS DATETIME)) as Date)              [Date Appt was Created]
		,MemberAppointments.AppointmentStatus                                        [Appt Status]
		,case when MemberAppointments.WalkIn = 1 then 'True' else 'False' end as [Walk-In]
		,provider.ProviderProfiles.ProviderId ProviderId
		,provider.ProviderProfiles.Brands                                                           [Manufacturer]
		,provider.ProviderProfiles.ProviderName                                             [Provider Name]
		,provider.Locations.BusinessName                                                         [Legal Business Name]
		,[provider].Locations.LocationEmailAddress            [Email Address]
		,provider.Locations.LocationId LocationId
		,provider.Locations.[Dispenser]                                                               [Dispenser #]
		,[Provider Phone Number] = (select top 1 phonenumber from  provider.locationphonenumbers where locationphonenumbers.locationid = provider.locations.locationid and phonetypeid = 1)
		,[Provider Fax Number] = (select top 1 phonenumber from  provider.locationphonenumbers where locationphonenumbers.locationid = provider.locations.locationid and phonetypeid = 3)
		,COALESCE(provider.Locations.Address1, ' ') + ' ' + COALESCE(provider.Locations.Address2, ' ') AS [Provider Address]
		,provider.Locations.City                                                                            [Provider City]
		,provider.Locations.State                                                                                         [Provider State]
		,provider.Locations.Zip as                                                                                       [Provider Zipcode]
		,provider.MemberProfiles.CreateUser                                                   [Add User]
		,provider.MemberProfiles.ModifyUser                                                  [Modify User]
		,[vsdatamig].[DMContacts].[AddUserNameLastFirst]         [VS Add User]
		,[vsdatamig].[DMContacts].Contactid                                                   [VS Contact Id]
		,q1.Question AS Question1,a1.Answer AS Answer1,q2.Question AS Question2,a2.Answer AS Answer2
    from 
		(
			select nhmemberid, max(id) id, max(lastcalltime_est) lastcalltime_est, min(firstcalltime_est) firstcalltime_est
			from
			(
				select nhmemberid
					,case when ModifyUser <> 'VanillaSoft' then dateadd(hour, -5, lastcalltime) else lastcalltime end as lastcalltime_est
					,case when ModifyUser <> 'VanillaSoft' then dateadd(hour, -5, firstCalltime) else firstCalltime end as firstcalltime_est
					,id
				from
				(
					select  
						MemberNHMemberId as NHmemberId
						,max(StartTime) lastCalltime
						,min(StartTime) firstCalltime
						,max(callconversationid) id
						,ModifyUser
					from callcenter.CallConversations
					where 
						IsActive = 1
					group by MemberNHMemberId, ModifyUser
				) sometable
			) sometable2
			group by nhmemberid
		) callconversations
		LEFT OUTER JOIN (
			select
				callconversationid,
				case when evnts.ParentEventId IS NULL then evnts.EventName 
					 when evnts.ParentEventId IS NOT NULL then parentevnts.EventName END AS ParentEventName,
				case when evnts.ParentEventId IS NULL then NULL
					 when evnts.ParentEventId IS NOT NULL then evnts.EventName END AS eventname
			from callcenter.callpageevents cpe
			inner join (select * from jobs.events where EventTriggerBy = 'disposition') evnts on evnts.eventid = cpe.EventId
			left join (select * from jobs.events where EventTriggerBy = 'disposition') parentevnts on (parentevnts.eventid = evnts.ParentEventId and evnts.ParentEventId is not null)
			group by callconversationid
			,case when evnts.ParentEventId IS NULL then evnts.EventName 
					 when evnts.ParentEventId IS NOT NULL then parentevnts.EventName END,
				case when evnts.ParentEventId IS NULL then NULL
					 when evnts.ParentEventId IS NOT NULL then evnts.EventName END
		) callevents on callevents.callconversationid = callconversations.id
		LEFT OUTER JOIN provider.MemberProfiles with (nolock) ON provider.MemberProfiles.NHmemberid = callconversations.nhmemberid
		LEFT OUTER JOIN 
		(
			select MemberProfileId, carrid as InsuranceCarrierId, planid as InsuranceHealthPlanId, insid as MemberInsuranceId
			from
			(
				select memberprofileid, max(memberinsuranceid) insid, max(insurancecarrierid) carrid, max(insurancehealthplanid) planid
				from provider.MemberInsurances
				where UseForBenefits = 1 and isactive = 1
				group by MemberProfileId
			union all
				select memberprofileid, max(memberinsuranceid) insid, max(insurancecarrierid) carrid, max(insurancehealthplanid) planid
				from provider.MemberInsurances
				where UseForBenefits = 0 and isactive = 1 and MemberProfileId not in
				(
					select memberprofileid
					from provider.MemberInsurances
					where UseForBenefits = 1 and isactive = 1
					group by MemberProfileId
				)
				group by MemberProfileId
			) ub
		) memberinsurances ON provider.MemberProfiles.MemberProfileId = memberinsurances.MemberProfileId
		LEFT OUTER JOIN provider.MemberInsuranceDetails with (nolock) ON provider.MemberInsuranceDetails.MemberInsuranceId = memberinsurances.MemberInsuranceId
		LEFT OUTER JOIN Insurance.InsuranceCarriers with (nolock) ON memberinsurances.InsuranceCarrierId = Insurance.InsuranceCarriers.InsuranceCarrierId
		LEFT OUTER JOIN Insurance.InsuranceHealthPlans hp with (nolock) on memberinsurances.InsuranceHealthPlanId=hp.InsuranceHealthPlanID
		LEFT OUTER JOIN (
			SELECT [HealthPlanContractID]
					,[InsuranceCarrierID]
					,[InsuranceHealthPlanID]
			FROM [Insurance].[HealthPlanContracts] with (nolock) 
		) HealthPlanContracts ON memberinsurances.InsuranceCarrierId = HealthPlanContracts.[InsuranceCarrierID]
			AND memberinsurances.InsuranceHealthPlanId = HealthPlanContracts.[InsuranceHealthPlanID]
		LEFT OUTER JOIN (
			SELECT  [BenefitAmt]
                    ,[HealthPlanContractID]
			FROM [Insurance].[ContractBenefits] with (nolock) 
		) ContractBenefits ON HealthPlanContracts.HealthPlanContractId = ContractBenefits.[HealthPlanContractID]
		LEFT OUTER JOIN
		(
			select MemberLocationId
					,Address1
					,Address2
					,AddressTypeId
					,City
					,IsActive
					,MemberProfileId
					,State
					,ZipCode
			from provider.MemberLocations a with (nolock) 
			where
				IsActive = 1
				--and AddressTypeId = 1
				and MemberLocationId = 
				(
					select min(memberlocationid) 
					from provider.MemberLocations 
					where 
						MemberProfileId = a.MemberProfileId
				)
		) memberlocations ON provider.MemberProfiles.MemberProfileId = memberlocations.MemberProfileId 
		LEFT OUTER JOIN provider.MemberCharts charts with (nolock) on charts.MemberProfileId = provider.MemberProfiles.MemberProfileId
		LEFT OUTER JOIN
		(
			select a.*, z.memberchartid, d.locationid, d.providerid
			from provider.MemberAppointments a with (nolock)
			inner join provider.memberchartdata d on a.memberchartdataid = d.memberchartdataid
			inner join provider.membercharts z on z.memberchartid = d.memberchartid
			where
				a.IsActive = 1
			and memberappointmentid = (
				select max(memberappointmentid)
				from provider.MemberAppointments b with (nolock)
				inner join provider.memberchartdata c on b.memberchartdataid = c.memberchartdataid
				where
					c.memberchartid = z.memberchartid and
					b.isactive = 1 and 
					b.AppointmentStatus <> 'Cancel'
			)
		) Memberappointments ON charts.MemberChartId = Memberappointments.MemberChartId
		LEFT OUTER JOIN provider.AppointmentTypes with (nolock) ON provider.AppointmentTypes.AppointmentTypeId = MemberAppointments.AppointmentTypeId
		LEFT OUTER JOIN provider.Locations with (nolock) ON Memberappointments.LocationId = provider.Locations.LocationId
		LEFT OUTER JOIN provider.ProviderProfiles with (nolock) ON Memberappointments.ProviderId = provider.ProviderProfiles.ProviderId
		LEFT OUTER JOIN [vsdatamig].[DMContacts] with (nolock) ON provider.memberprofiles.nhmemberid=[vsdatamig].[DMContacts].nhmemberid
		left join (
			select s.NHMemberID,max(s1.QuestionId) QuestionId1,max(s2.QuestionId) QuestionId2,max(s1.AnswerId) AnswerId1,max(s2.AnswerId) AnswerId2
			from [survey].[MemberSurveyQuestions] s
			left join (select * from [survey].[MemberSurveyQuestions]  where QuestionId=1) s1 on (s.NHMemberID=s1.NHMemberID)
			left join (select * from [survey].[MemberSurveyQuestions]  where QuestionId=2) s2 on (s.NHMemberID=s2.NHMemberID)
			group by s.NHMemberID
          ) survey on (callconversations.nhmemberid=survey.NHMemberID)
		left join survey.SurveyQuestions q1 on (q1.QuestionId=survey.QuestionId1)
		left join survey.SurveyQuestions q2 on (q2.QuestionId=survey.QuestionId2)
		left join survey.SurveyAnswers a1 on (a1.AnswerId=survey.AnswerId1)
		left join survey.SurveyAnswers a2 on (a2.AnswerId=survey.AnswerId2)
		




CREATE VIEW  [ReportsData].[7_viewAccountingNEW3] AS
          SELECT
          o.NHMemberID,
          o.orderid AS 'OrderNumber',
          o.Source AS 'OrderSource',
          DS.DataSource AS 'EligSource',
		  CAST(o.[DateOrderReceived] AS DATE) AS 'OrderRcvdDate',
		  CAST(o.[DateOrderInitiated] AS DATE) AS 'OrderCreatedDate',
          o.[OrderType],
          (CASE WHEN o.[OrderType] IN ('EXCHANGE','LSandD') THEN o.[OrderType] +'( of order:' + case when o.[RefOrderId] is null then ' ' else  CAST(o.[RefOrderId]AS VARCHAR)  end + ')'
          ELSE o.[OrderType]
          END) 'OrderRef',
          o.[Status],
          (CASE WHEN JSON_VALUE(O.MEMBERDATA, '$.insurance.carrierName') = 'None' OR
          JSON_VALUE(O.MEMBERDATA, '$.insurance.carrierName') = '' THEN
          JSON_VALUE(O.MEMBERDATA, '$.insurance.programeName')
          ELSE JSON_VALUE(O.MEMBERDATA, '$.insurance.carrierName')
          END) AS 'Carrier',
          JSON_VALUE(O.MEMBERDATA, '$.insurance.planName') AS 'Plan',
          JSON_VALUE([MemberData],'$.firstName') AS [MemberFirstName],
          JSON_VALUE([MemberData],'$.lastName') AS [MemberLastName],
          JSON_VALUE([ProviderData],'$.providerId') AS [ProviderID],
          JSON_VALUE([ProviderData],'$.providerLeagalBusinessName') AS [ProviderLegalName],
          JSON_VALUE([ProviderData],'$.dba') AS [ProviderDBA],
          JSON_VALUE([ProviderData],'$.dispenser') AS [ProviderDispenser],
          JSON_VALUE([ProviderData],'$.address.address') AS [ProviderAddress],
          JSON_VALUE([ProviderData],'$.address.city') AS [ProviderCity],
          JSON_VALUE([ProviderData],'$.address.state') AS [ProviderState],
          JSON_VALUE([ProviderData],'$.address.zip') AS [ProviderZip],
          JSON_VALUE([ShippingData],'$.dba') AS [ShippingDBA],
          JSON_VALUE([ShippingData],'$.dispenser') AS [ShippingDispenser],
          [BrandCode] AS [Manufacturer] ,
          [FamilyCode] AS [Family],
          [TechnologyLevelCode] [Product],
          P.FAMILYPRODUCTCATCODE [TechnologyLevel],
          [DeviceCount] AS 'Qty',
          CASE WHEN [DeviceCountRet] is NULL THEN '' ELSE [DeviceCountRet] END AS 'QtyReturned',
          P.[PerDeviceCOGSPrice] AS 'COGS',
          P.[PerDeviceCOGSPrice] * ([DeviceCount]-( CASE WHEN [DeviceCountRet] is NULL THEN '' ELSE [DeviceCountRet] END)) AS 'TotalCOGS',
          (CASE WHEN CAST(JSON_VALUE([OrderAmountData],'$.insuranceBenefit') AS NVARCHAR(10)) IS NULL THEN 0
          ELSE CAST(JSON_VALUE([OrderAmountData],'$.insuranceBenefit') AS DECIMAL)
          END) [BenefitAmount],

          (CASE WHEN CAST(JSON_VALUE([OrderAmountData],'$.medicaidBenefit') AS NVARCHAR(10)) IS NULL THEN 0
          ELSE CAST(JSON_VALUE([OrderAmountData],'$.medicaidBenefit') AS DECIMAL)
          END) [medicaidBenefit],

          (CASE WHEN CAST(JSON_VALUE([OrderAmountData],'$.productPrice') AS NVARCHAR(10)) IS NULL THEN 0
          ELSE CAST(JSON_VALUE([OrderAmountData],'$.productPrice') AS DECIMAL)
          END) AS [ProductPrice],
          (CASE WHEN CAST(JSON_VALUE([OrderAmountData],'$.benefitAvailable') AS NVARCHAR(10)) IS NULL THEN 0
          ELSE CAST(JSON_VALUE([OrderAmountData],'$.benefitAvailable') AS DECIMAL)
          END) AS [BenefitAvailable],
          (CASE WHEN CAST(JSON_VALUE([OrderAmountData],'$.adjustments') AS NVARCHAR(10)) IS NULL THEN 0
          ELSE CAST(JSON_VALUE([OrderAmountData],'$.adjustments') AS DECIMAL)
          END) AS [AdjustmentAmount],
          (CASE WHEN CAST(JSON_VALUE([OrderAmountData],'$.memberResponsibility') AS NVARCHAR(10)) IS NULL THEN 0
			  ELSE CAST(JSON_VALUE([OrderAmountData],'$.memberResponsibility') AS DECIMAL)
			  END) AS [MemberResponsibleAmount],
		(CASE WHEN CAST(JSON_VALUE([OrderAmountData],'$.exchangeCredit') AS NVARCHAR(10)) IS NULL THEN 0
			ELSE CAST(JSON_VALUE([OrderAmountData],'$.exchangeCredit') AS DECIMAL)
			END) AS [ExchangeCredit],
		(CASE WHEN CAST(JSON_VALUE([OrderAmountData],'$.cancelCredit') AS NVARCHAR(10)) IS NULL THEN 0
			ELSE CAST(JSON_VALUE([OrderAmountData],'$.cancelCredit') AS DECIMAL)
			END) AS [CancelCredit],
          (CASE WHEN CAST(PAY.[PaymentAmount1] AS DECIMAL) + CAST(PAY.[PaymentAmount2] AS DECIMAL) + CAST(PAY.[PaymentAmount3] AS DECIMAL) IS NULL THEN 0
			  ELSE CAST(PAY.[PaymentAmount1] AS DECIMAL) + CAST(PAY.[PaymentAmount2] AS DECIMAL) + CAST(PAY.[PaymentAmount3] AS DECIMAL)
			  END) 'MemberPayment',		  
			CASE when REF.RefundAmount IS NULL THEN 0 else REF.RefundAmount END RefundAmount,
          (CASE WHEN PO.PONumber IS NULL THEN ''
			  ELSE PO.PONumber
			  END) AS 'PONumber',
          (CASE WHEN PO.[PO DATE] IS NULL THEN NULL WHEN PO.[PO DATE] ='' THEN NULL
			  ELSE cast(PO.[PO DATE] as date)
			  END) AS 'PODate',	
          (CASE WHEN CLM.[Fitting Date] IS NULL THEN NULL  WHEN CLM.[Fitting Date] ='' THEN NULL
			  ELSE cast(CLM.[Fitting Date] as date)
			  END) AS 'FittingDate' ,
          (CASE WHEN CLM.[PurchaseDate] IS NULL THEN NULL WHEN CLM.[PurchaseDate] ='' THEN NULL
			  ELSE cast(CLM.[PurchaseDate] as date)
			  END) AS 'PurchaseAgreementDate',
          (CASE WHEN CLM.[DeliveryDate] IS NULL THEN NULL WHEN CLM.[DeliveryDate] ='' THEN NULL
			  ELSE cast(CLM.[DeliveryDate] as date)
			  END) AS 'DeliveryRcptDate',
		   (CASE WHEN CLM.[ClaimDate] IS NULL THEN NULL WHEN CLM.[ClaimDate] ='' THEN NULL
			  ELSE cast(CLM.[ClaimDate] as date)
			  END) AS 'ClaimDate',
          (CASE WHEN RET.[Return Date] IS NULL THEN NULL  WHEN RET.[Return Date] ='' THEN NULL
			  ELSE cast(RET.[Return Date] as date)
			  END) AS 'ReturnDate',
          (CASE WHEN CLM.[Claim Required] IS NULL THEN '' ELSE CLM.[Claim Required]  END) AS 'ClaimRequired',
          P.[PerDeviceDispensingFee] [FittingFeePerDevice],
          CASE WHEN ([DeviceCount]-( CASE WHEN [DeviceCountRet] is NULL THEN 0 ELSE [DeviceCountRet] END))=2 THEN P.[PerPairDispensingFee] 
				WHEN  ([DeviceCount]-( CASE WHEN [DeviceCountRet] is NULL THEN 0 ELSE [DeviceCountRet] END))=1 THEN P.[PerDeviceDispensingFee] ELSE 0 END AS 'TotalFittingFee',
          CLM.[ClaimAmount]  'ClaimAmount',
          JSON_VALUE(O.MEMBERDATA, '$.insurance.carrierName') + ':' + JSON_VALUE([MemberData],'$.firstName') + ' ' +JSON_VALUE([MemberData],'$.lastName') AS 'QBJobName'
          FROM
          (
          SELECT s.* , oi.BrandCode, oi.FamilyCode, oi.StyleCode, oi.TechnologyLevelCode, oi.ProductModelCode, oi.ItemCode, oq.DeviceCount, oqret.DeviceCountRet
          FROM orders.orders s
          INNER JOIN
          (
          SELECT DISTINCT orderid, BrandCode, FamilyCode, StyleCode, TechnologyLevelCode, ProductModelCode, ItemCode
          FROM orders.OrderItems
          WHERE 1 = 1
          AND ItemType IN ('HA')
          AND IsActive = 1
          ) oi ON (oi.orderid = s.orderid)
          INNER JOIN
          (
			  SELECT orderid, SUM(Quantity) DeviceCount
			  FROM orders.OrderItems
			  WHERE 1 = 1
			  AND ItemType IN ('HA','CROS')
			  AND IsActive = 1
			  GROUP BY ORDERID
          ) oq ON (oq.orderid = s.orderid)
		  LEFT JOIN
          (
			  SELECT orderid, SUM(Quantity) DeviceCountRet
			  FROM orders.OrderItems
			  WHERE 1 = 1
			  AND ItemType IN ('HA','CROS')
			  AND IsActive = 1
			  and STATUS='RETURNED'
			  GROUP BY ORDERID,STATUS
          ) oqret ON (oqret.orderid = s.orderid)
          )  O
          LEFT OUTER JOIN
          (
			  SELECT ORDERID,[OrderTransactionData],
				  (CASE WHEN CONVERT(VARCHAR(10),JSON_VALUE([OrderTransactionData],'$.fittingDate'),101)  = '01/01/0001' THEN ''
				  WHEN CONVERT(VARCHAR(10),JSON_VALUE([OrderTransactionData],'$.fittingDate'),101) IS NULL THEN ''
				  ELSE CONVERT(VARCHAR(10),JSON_VALUE([OrderTransactionData],'$.fittingDate'),101)
				  END)  AS [Fitting Date],
			  JSON_VALUE([OrderTransactionData],'$.purchaseAgreementReceived') AS [PurchaseAgreementRcvd],
			  (CASE WHEN CONVERT(VARCHAR(10),JSON_VALUE([OrderTransactionData],'$.purchaseDate'),101) IS NULL THEN ''
			  ELSE CONVERT(VARCHAR(10),JSON_VALUE([OrderTransactionData],'$.purchaseDate'),101)
			  END) AS [PurchaseDate],
			  JSON_VALUE([OrderTransactionData],'$.deliveryReceipt') AS [DeliveryReceiptRcvd],
			  (CASE WHEN CONVERT(VARCHAR(10),JSON_VALUE([OrderTransactionData],'$.deliveryDate'),101) IS NULL THEN ''
			  ELSE CONVERT(VARCHAR(10),JSON_VALUE([OrderTransactionData],'$.deliveryDate'),101)
			  END) AS [DeliveryDate],
				(CASE WHEN CONVERT(VARCHAR(10),JSON_VALUE([OrderTransactionData],'$.claimSubmitDate'),101) IS NULL THEN ''
			  ELSE CONVERT(VARCHAR(10),JSON_VALUE([OrderTransactionData],'$.claimSubmitDate'),101)
			  END) AS [ClaimDate],
			  JSON_VALUE([OrderTransactionData],'$.isClaimSubmitted') AS [Claim Required]
			  ,(CASE WHEN JSON_VALUE([OrderTransactionData],'$.claimAmount') IS NULL THEN 0  WHEN JSON_VALUE([OrderTransactionData],'$.claimAmount') ='' THEN 0
				  ELSE  CAST(JSON_VALUE([OrderTransactionData],'$.claimAmount') AS decimal(18,2))
				  END) AS [ClaimAmount]
			  FROM
			  [Orders].[OrderTransactionDetails] OD1 WITH (NOLOCK)
			  WHERE OD1.OrderStatusCode='CLM' AND IsActive=1
          )CLM ON (O.ORDERID = CLM.ORDERID)
          LEFT OUTER JOIN
          (
          SELECT CAST(JSON_VALUE(Ordertransactiondata,'$.returnDt') AS DATE) [Return Date],ORDERID
          FROM
          [Orders].[OrderTransactionDetails] OD1 WITH (NOLOCK)
          WHERE OD1.OrderStatusCode='RET' AND IsActive=1
          )RET ON (O.ORDERID = RET.ORDERID)
		   LEFT OUTER JOIN
          (
          SELECT CAST(JSON_VALUE(Ordertransactiondata,'$.returnDt') AS DATE) [Refund Date],JSON_VALUE([OrderTransactionData],'$.transactions[0].amountPaid') RefundAmount,ORDERID
          FROM
          [Orders].[OrderTransactionDetails] OD1 WITH (NOLOCK)
          WHERE OD1.OrderStatusCode='REF' AND IsActive=1
          )REF ON (O.ORDERID = REF.ORDERID)
          LEFT OUTER JOIN
          (
          SELECT  ORDERID,
          (CASE
          WHEN JSON_VALUE([OrderTransactionData],'$.transactions[0].amountPaid') IS NULL THEN 0
          ELSE CAST(JSON_VALUE([OrderTransactionData],'$.transactions[0].amountPaid')  AS DECIMAL)
          END) [PaymentAmount1],
          (CASE
          WHEN JSON_VALUE([OrderTransactionData],'$.transactions[1].amountPaid') IS NULL THEN 0
          ELSE CAST(JSON_VALUE([OrderTransactionData],'$.transactions[1].amountPaid') AS DECIMAL)
          END) [PaymentAmount2],
          (CASE
          WHEN JSON_VALUE([OrderTransactionData],'$.transactions[2].amountPaid') IS NULL THEN 0
          ELSE CAST(JSON_VALUE([OrderTransactionData],'$.transactions[2].amountPaid') AS DECIMAL)
          END) [PaymentAmount3],
          (CASE
          WHEN JSON_VALUE([OrderTransactionData],'$.transactions[3].amountPaid') IS NULL THEN 0
          ELSE CAST(JSON_VALUE([OrderTransactionData],'$.transactions[3].amountPaid') AS DECIMAL)
          END) [PaymentAmount4]
          FROM
          [Orders].[OrderTransactionDetails] OD3 WITH (NOLOCK)
          WHERE OD3.OrderStatusCode='PAY' AND IsActive=1
          )PAY ON (O.ORDERID = PAY.ORDERID)
          LEFT OUTER JOIN
          (
          SELECT ORDERID,
          ISNULL(json_value(OrdertransactionData, '$.poDate'),json_value(OrdertransactionData, '$[0].poDate'))  AS [PO DATE],
          ISNULL(json_value(OrdertransactionData, '$.poNumber'),json_value(OrdertransactionData, '$[0].poNumber')) AS PONumber
          FROM   [Orders].[OrderTransactionDetails] OD4 WITH (NOLOCK)
          WHERE OD4.OrderStatusCode='PO' AND IsActive=1
          )PO
          ON (O.ORDERID = PO.ORDERID)

          LEFT OUTER JOIN Insurance.HealthPlanContracts B ON B.InsuranceHealthPlanID = JSON_VALUE(O.MEMBERDATA, '$.insPlanId')
          LEFT OUTER JOIN (SELECT DISTINCT FAMILYPRODUCTCATCODE, FAMILYPRODUCTCODE, HealthPlanContractID, [PerDeviceCOGSPrice],[PerDeviceDispensingFee] , ITEMCODE,PerPairDispensingFee
          FROM INSURANCE.CONTRACTPRODUCTS where isactive = 1) P ON O.ITEMCODE = P.ITEMCODE AND P.HealthPlanContractId = B.HealthPlanContractId

          INNER JOIN [Master].[Members] DS WITH (NOLOCK) ON DS.[NHMemberID] = O.NHMemberID AND DS.IsActive=1

          WHERE
          O.IsActive=1
          AND O.Status <> 'ALAN'
		  AND O.OrderType not in ('OTC')

		  UNION

		  
          SELECT
          o.NHMemberID,
          o.orderid AS 'OrderNumber',
          o.Source AS 'OrderSource',
          DS.DataSource AS 'EligSource',
		  CAST(o.[DateOrderReceived] AS DATE) AS 'OrderRcvdDate',
		  CAST(o.[DateOrderInitiated] AS DATE) AS 'OrderCreatedDate',
          o.[OrderType],
          (CASE WHEN o.[OrderType] IN ('EXCHANGE','LSandD') THEN o.[OrderType] +'( of order:' + case when o.[RefOrderId] is null then ' ' else  CAST(o.[RefOrderId]AS VARCHAR)  end + ')'
          ELSE o.[OrderType]
          END) 'OrderRef',
          o.[Status],
          (CASE WHEN JSON_VALUE(O.MEMBERDATA, '$.insurance.carrierName') = 'None' OR
          JSON_VALUE(O.MEMBERDATA, '$.insurance.carrierName') = '' THEN
          JSON_VALUE(O.MEMBERDATA, '$.insurance.programeName')
          ELSE JSON_VALUE(O.MEMBERDATA, '$.insurance.carrierName')
          END) AS 'Carrier',
          JSON_VALUE(O.MEMBERDATA, '$.insurance.planName') AS 'Plan',
          JSON_VALUE([MemberData],'$.firstName') AS [MemberFirstName],
          JSON_VALUE([MemberData],'$.lastName') AS [MemberLastName],
          JSON_VALUE([ProviderData],'$.providerId') AS [ProviderID],
          JSON_VALUE([ProviderData],'$.providerLeagalBusinessName') AS [ProviderLegalName],
          JSON_VALUE([ProviderData],'$.dba') AS [ProviderDBA],
          JSON_VALUE([ProviderData],'$.dispenser') AS [ProviderDispenser],
          JSON_VALUE([ProviderData],'$.address.address') AS [ProviderAddress],
          JSON_VALUE([ProviderData],'$.address.city') AS [ProviderCity],
          JSON_VALUE([ProviderData],'$.address.state') AS [ProviderState],
          JSON_VALUE([ProviderData],'$.address.zip') AS [ProviderZip],
          JSON_VALUE([ShippingData],'$.dba') AS [ShippingDBA],
          JSON_VALUE([ShippingData],'$.dispenser') AS [ShippingDispenser],
          [BrandCode] AS [Manufacturer] ,
          [FamilyCode] AS [Family],
          [TechnologyLevelCode] [Product],
          P.FAMILYPRODUCTCATCODE [TechnologyLevel],
          [DeviceCount] AS 'Qty',
          CASE WHEN [DeviceCountRet] is NULL THEN '' ELSE [DeviceCountRet] END AS 'QtyReturned',
          P.[PerDeviceCOGSPrice] AS 'COGS',
          P.[PerDeviceCOGSPrice] * ([DeviceCount]-( CASE WHEN [DeviceCountRet] is NULL THEN '' ELSE [DeviceCountRet] END)) AS 'TotalCOGS',
          (CASE WHEN CAST(JSON_VALUE([OrderAmountData],'$.insuranceBenefit') AS NVARCHAR(10)) IS NULL THEN 0
          ELSE CAST(JSON_VALUE([OrderAmountData],'$.insuranceBenefit') AS DECIMAL)
          END) [BenefitAmount],

          (CASE WHEN CAST(JSON_VALUE([OrderAmountData],'$.medicaidBenefit') AS NVARCHAR(10)) IS NULL THEN 0
          ELSE CAST(JSON_VALUE([OrderAmountData],'$.medicaidBenefit') AS DECIMAL)
          END) [medicaidBenefit],

          (CASE WHEN CAST(JSON_VALUE([OrderAmountData],'$.productPrice') AS NVARCHAR(10)) IS NULL THEN 0
          ELSE CAST(JSON_VALUE([OrderAmountData],'$.productPrice') AS DECIMAL)
          END) AS [ProductPrice],
          (CASE WHEN CAST(JSON_VALUE([OrderAmountData],'$.benefitAvailable') AS NVARCHAR(10)) IS NULL THEN 0
          ELSE CAST(JSON_VALUE([OrderAmountData],'$.benefitAvailable') AS DECIMAL)
          END) AS [BenefitAvailable],
          (CASE WHEN CAST(JSON_VALUE([OrderAmountData],'$.adjustments') AS NVARCHAR(10)) IS NULL THEN 0
          ELSE CAST(JSON_VALUE([OrderAmountData],'$.adjustments') AS DECIMAL)
          END) AS [AdjustmentAmount],
          (CASE WHEN CAST(JSON_VALUE([OrderAmountData],'$.memberResponsibility') AS NVARCHAR(10)) IS NULL THEN 0
			  ELSE CAST(JSON_VALUE([OrderAmountData],'$.memberResponsibility') AS DECIMAL)
			  END) AS [MemberResponsibleAmount],
		(CASE WHEN CAST(JSON_VALUE([OrderAmountData],'$.exchangeCredit') AS NVARCHAR(10)) IS NULL THEN 0
			ELSE CAST(JSON_VALUE([OrderAmountData],'$.exchangeCredit') AS DECIMAL)
			END) AS [ExchangeCredit],
		(CASE WHEN CAST(JSON_VALUE([OrderAmountData],'$.cancelCredit') AS NVARCHAR(10)) IS NULL THEN 0
			ELSE CAST(JSON_VALUE([OrderAmountData],'$.cancelCredit') AS DECIMAL)
			END) AS [CancelCredit],
          (CASE WHEN CAST(PAY.[PaymentAmount1] AS DECIMAL) + CAST(PAY.[PaymentAmount2] AS DECIMAL) + CAST(PAY.[PaymentAmount3] AS DECIMAL) IS NULL THEN 0
			  ELSE CAST(PAY.[PaymentAmount1] AS DECIMAL) + CAST(PAY.[PaymentAmount2] AS DECIMAL) + CAST(PAY.[PaymentAmount3] AS DECIMAL)
			  END) 'MemberPayment',		     
			CASE when REF.RefundAmount IS NULL THEN 0 else REF.RefundAmount END RefundAmount,
          (CASE WHEN PO.PONumber IS NULL THEN ''
			  ELSE PO.PONumber
			  END) AS 'PONumber',
          (CASE WHEN PO.[PO DATE] IS NULL THEN NULL WHEN PO.[PO DATE] ='' THEN NULL
			  ELSE cast(PO.[PO DATE] as date)
			  END) AS 'PODate',	
          (CASE WHEN CLM.[Fitting Date] IS NULL THEN NULL  WHEN CLM.[Fitting Date] ='' THEN NULL
			  ELSE cast(CLM.[Fitting Date] as date)
			  END) AS 'FittingDate' ,
          (CASE WHEN CLM.[PurchaseDate] IS NULL THEN NULL WHEN CLM.[PurchaseDate] ='' THEN NULL
			  ELSE cast(CLM.[PurchaseDate] as date)
			  END) AS 'PurchaseAgreementDate',
          (CASE WHEN CLM.[DeliveryDate] IS NULL THEN NULL WHEN CLM.[DeliveryDate] ='' THEN NULL
			  ELSE cast(CLM.[DeliveryDate] as date)
			  END) AS 'DeliveryRcptDate',
		   (CASE WHEN CLM.[ClaimDate] IS NULL THEN NULL WHEN CLM.[ClaimDate] ='' THEN NULL
			  ELSE cast(CLM.[ClaimDate] as date)
			  END) AS 'ClaimDate',
          (CASE WHEN RET.[Return Date] IS NULL THEN NULL  WHEN RET.[Return Date] ='' THEN NULL 
			  ELSE cast(RET.[Return Date] as date)
			  END) AS 'ReturnDate',
          (CASE WHEN CLM.[Claim Required] IS NULL THEN '' ELSE CLM.[Claim Required]  END) AS 'ClaimRequired',
          P.[PerDeviceDispensingFee] [FittingFeePerDevice],
          CASE WHEN ([DeviceCount]-( CASE WHEN [DeviceCountRet] is NULL THEN 0 ELSE [DeviceCountRet] END))=2 THEN P.[PerPairDispensingFee] 
				WHEN  ([DeviceCount]-( CASE WHEN [DeviceCountRet] is NULL THEN 0 ELSE [DeviceCountRet] END))=1 THEN P.[PerDeviceDispensingFee] ELSE 0 END AS 'TotalFittingFee',
          CLM.[ClaimAmount]   'ClaimAmount',
          JSON_VALUE(O.MEMBERDATA, '$.insurance.carrierName') + ':' + JSON_VALUE([MemberData],'$.firstName') + ' ' +JSON_VALUE([MemberData],'$.lastName') AS 'QBJobName'
          FROM
          (
          SELECT s.* , oi.BrandCode, oi.FamilyCode, oi.StyleCode, oi.TechnologyLevelCode, oi.ProductModelCode, oi.ItemCode, oq.DeviceCount, oqret.DeviceCountRet
          FROM orders.orders s
          INNER JOIN
          (
			  SELECT DISTINCT orderid, BrandCode, FamilyCode, StyleCode, TechnologyLevelCode, ProductModelCode, ItemCode
			  FROM orders.OrderItems
			  WHERE 1 = 1
			  AND ItemType IN ('CROS')
			  AND IsActive = 1
			  and OrderId in (
			  select orderid from orders.OrderItems group by orderid having count(1)=1
			  )
          ) oi ON (oi.orderid = s.orderid)
          INNER JOIN
          (
          SELECT orderid, SUM(Quantity) DeviceCount
          FROM orders.OrderItems
          WHERE 1 = 1
          AND ItemType IN ('HA','CROS')
          AND IsActive = 1
          GROUP BY ORDERID
          ) oq ON (oq.orderid = s.orderid)
		  LEFT JOIN
          (
			  SELECT orderid, SUM(Quantity) DeviceCountRet
			  FROM orders.OrderItems
			  WHERE 1 = 1
			  AND ItemType IN ('HA','CROS')
			  AND IsActive = 1
			  and STATUS='RETURNED'
			  GROUP BY ORDERID,STATUS
          ) oqret ON (oqret.orderid = s.orderid)
          )  O
          LEFT OUTER JOIN
          (
          SELECT ORDERID,[OrderTransactionData],
          (CASE WHEN CONVERT(VARCHAR(10),JSON_VALUE([OrderTransactionData],'$.fittingDate'),101)  = '01/01/0001' THEN ''
          WHEN CONVERT(VARCHAR(10),JSON_VALUE([OrderTransactionData],'$.fittingDate'),101) IS NULL THEN ''
          ELSE CONVERT(VARCHAR(10),JSON_VALUE([OrderTransactionData],'$.fittingDate'),101)
          END)  AS [Fitting Date],
          JSON_VALUE([OrderTransactionData],'$.purchaseAgreementReceived') AS [PurchaseAgreementRcvd],
          (CASE WHEN CONVERT(VARCHAR(10),JSON_VALUE([OrderTransactionData],'$.purchaseDate'),101) IS NULL THEN ''
          ELSE CONVERT(VARCHAR(10),JSON_VALUE([OrderTransactionData],'$.purchaseDate'),101)
          END) AS [PurchaseDate],
          JSON_VALUE([OrderTransactionData],'$.deliveryReceipt') AS [DeliveryReceiptRcvd],
          (CASE WHEN CONVERT(VARCHAR(10),JSON_VALUE([OrderTransactionData],'$.deliveryDate'),101) IS NULL THEN ''
          ELSE CONVERT(VARCHAR(10),JSON_VALUE([OrderTransactionData],'$.deliveryDate'),101)
          END) AS [DeliveryDate],
		    (CASE WHEN CONVERT(VARCHAR(10),JSON_VALUE([OrderTransactionData],'$.claimSubmitDate'),101) IS NULL THEN ''
          ELSE CONVERT(VARCHAR(10),JSON_VALUE([OrderTransactionData],'$.claimSubmitDate'),101)
          END) AS [ClaimDate],
          JSON_VALUE([OrderTransactionData],'$.isClaimSubmitted') AS [Claim Required],
           (CASE WHEN  JSON_VALUE([OrderTransactionData],'$.claimAmount') IS NULL THEN 0  WHEN  JSON_VALUE([OrderTransactionData],'$.claimAmount') ='' THEN 0
          ELSE  CAST(JSON_VALUE([OrderTransactionData],'$.claimAmount') AS DECIMAL(18,2))
          END) AS [ClaimAmount]
          FROM
          [Orders].[OrderTransactionDetails] OD1 WITH (NOLOCK)
          WHERE OD1.OrderStatusCode='CLM' AND IsActive=1
          )CLM ON (O.ORDERID = CLM.ORDERID)
          LEFT OUTER JOIN
          (
          SELECT CAST(JSON_VALUE(Ordertransactiondata,'$.returnDt') AS DATE) [Return Date],ORDERID
          FROM
          [Orders].[OrderTransactionDetails] OD1 WITH (NOLOCK)
          WHERE OD1.OrderStatusCode='RET' AND IsActive=1
          )RET ON (O.ORDERID = RET.ORDERID)
		   LEFT OUTER JOIN
          (
          SELECT CAST(JSON_VALUE(Ordertransactiondata,'$.returnDt') AS DATE) [Refund Date],JSON_VALUE([OrderTransactionData],'$.transactions[0].amountPaid') RefundAmount,ORDERID
          FROM
          [Orders].[OrderTransactionDetails] OD1 WITH (NOLOCK)
          WHERE OD1.OrderStatusCode='REF' AND IsActive=1
          )REF ON (O.ORDERID = REF.ORDERID)
          LEFT OUTER JOIN
          (
          SELECT  ORDERID,
          (CASE
          WHEN JSON_VALUE([OrderTransactionData],'$.transactions[0].amountPaid') IS NULL THEN 0
          ELSE CAST(JSON_VALUE([OrderTransactionData],'$.transactions[0].amountPaid')  AS DECIMAL)
          END) [PaymentAmount1],
          (CASE
          WHEN JSON_VALUE([OrderTransactionData],'$.transactions[1].amountPaid') IS NULL THEN 0
          ELSE CAST(JSON_VALUE([OrderTransactionData],'$.transactions[1].amountPaid') AS DECIMAL)
          END) [PaymentAmount2],
          (CASE
          WHEN JSON_VALUE([OrderTransactionData],'$.transactions[2].amountPaid') IS NULL THEN 0
          ELSE CAST(JSON_VALUE([OrderTransactionData],'$.transactions[2].amountPaid') AS DECIMAL)
          END) [PaymentAmount3],
          (CASE
          WHEN JSON_VALUE([OrderTransactionData],'$.transactions[3].amountPaid') IS NULL THEN 0
          ELSE CAST(JSON_VALUE([OrderTransactionData],'$.transactions[3].amountPaid') AS DECIMAL)
          END) [PaymentAmount4]
          FROM
          [Orders].[OrderTransactionDetails] OD3 WITH (NOLOCK)
          WHERE OD3.OrderStatusCode='PAY' AND IsActive=1
          )PAY ON (O.ORDERID = PAY.ORDERID)
          LEFT OUTER JOIN
          (
          SELECT ORDERID,
          ISNULL(json_value(OrdertransactionData, '$.poDate'),json_value(OrdertransactionData, '$[0].poDate'))  AS [PO DATE],
          ISNULL(json_value(OrdertransactionData, '$.poNumber'),json_value(OrdertransactionData, '$[0].poNumber')) AS PONumber
          FROM   [Orders].[OrderTransactionDetails] OD4 WITH (NOLOCK)
          WHERE OD4.OrderStatusCode='PO' AND IsActive=1
          )PO
          ON (O.ORDERID = PO.ORDERID)

          LEFT OUTER JOIN Insurance.HealthPlanContracts B ON B.InsuranceHealthPlanID = JSON_VALUE(O.MEMBERDATA, '$.insPlanId')
          LEFT OUTER JOIN (SELECT DISTINCT FAMILYPRODUCTCATCODE, FAMILYPRODUCTCODE, HealthPlanContractID, [PerDeviceCOGSPrice],[PerDeviceDispensingFee] , ITEMCODE,PerPairDispensingFee
          FROM INSURANCE.CONTRACTPRODUCTS where isactive = 1) P ON O.ITEMCODE = P.ITEMCODE AND P.HealthPlanContractId = B.HealthPlanContractId

          INNER JOIN [Master].[Members] DS WITH (NOLOCK) ON DS.[NHMemberID] = O.NHMemberID AND DS.IsActive=1

          WHERE
          O.IsActive=1
          AND O.Status <> 'ALAN'
		  AND O.OrderType not in ('OTC')
CREATE VIEW [ReportsData].[7_viewAccountingOLD]
AS

SELECT  
   --     (case when O.Status = 'ALAN' then 'BAD'
		 --else 'GOOD'
		 --end) as 'Record',
        o.NHMemberID,
		o.orderid as 'OrderNumber',
		o.orderSource as 'OrderSource',
		DS.DataSource as 'EligSource',
		CONVERT(varchar(10), o.[DateOrderReceived],101) as 'OrderRcvdDate',
		CONVERT(varchar(10), o.[DateOrderInitiated],101) as 'OrderCreatedDate',
		o.[OrderType],
        --(case when o.[OrderType] in ('EXCHANGE','LSRD') then o.[OrderType] +'( of order:' +o.[RefOrderId] + ')'  else o.[OrderType] end) 'OrderRef',
		--o.[Status],
	    (case when JSON_VALUE(O.MEMBERDATA, '$.insurance.carrierName') = 'None' or 
		           JSON_VALUE(O.MEMBERDATA, '$.insurance.carrierName') = '' then 
		     JSON_VALUE(O.MEMBERDATA, '$.insurance.programeName')
			 else JSON_VALUE(O.MEMBERDATA, '$.insurance.carrierName')
	    end) as 'Carrier',
		JSON_VALUE(O.MEMBERDATA, '$.insurance.planName') as 'Plan',
		JSON_VALUE([MemberData],'$.firstName') as [MemberFirstName],
		JSON_VALUE([MemberData],'$.lastName') AS [MemberLastName],
		JSON_VALUE([ProviderData],'$.providerId') AS [ProviderID],
		JSON_VALUE([ProviderData],'$.providerLeagalBusinessName') AS [ProviderLegalName],	
		JSON_VALUE([ProviderData],'$.dba') AS [ProviderDBA],
		JSON_VALUE([ProviderData],'$.dispenser') AS [ProviderDispenser],
		JSON_VALUE([ProviderData],'$.address.address') AS [ProviderAddress],
		JSON_VALUE([ProviderData],'$.address.city') AS [ProviderCity], 
		JSON_VALUE([ProviderData],'$.address.state') AS [ProviderState],
		JSON_VALUE([ProviderData],'$.address.zip') AS [ProviderZip],
		JSON_VALUE([ShippingData],'$.dba') AS [ShippingDBA],
		JSON_VALUE([ShippingData],'$.dispenser') AS [ShippingDispenser],
		[BrandCode] As [Manufacturer] ,
		[FamilyCode] As [Family],
		[TechnologyLevelCode] [Product],
		P.FAMILYPRODUCTCATCODE [TechnologyLevel],
	--	[DeviceCount] as 'Qty', 
		P.[PerDeviceCOGSPrice] as 'COGS',
	--	P.[PerDeviceCOGSPrice] * [DeviceCount] as 'TotalCOGS',
		(case when CAST(JSON_VALUE([OrderAmountData],'$.insuranceBenefit') as nvarchar(10)) is null then 0 
		 else CAST(JSON_VALUE([OrderAmountData],'$.insuranceBenefit') as decimal)
		 end) [BenefitAmount],
		(case when CAST(JSON_VALUE([OrderAmountData],'$.productPrice') as nvarchar(10)) is null then 0 
		 else CAST(JSON_VALUE([OrderAmountData],'$.productPrice') as decimal)
		 end) AS [ProductPrice],
		--JSON_VALUE([OrderAmountData],'$.benefitUsed') AS [Benefit Used],
		(case when CAST(JSON_VALUE([OrderAmountData],'$.benefitAvailable') as nvarchar(10)) is null then 0
		 else CAST(JSON_VALUE([OrderAmountData],'$.benefitAvailable') as decimal)
		 end) AS [BenefitAvailable],
		 (case when CAST(JSON_VALUE([OrderAmountData],'$.adjustments') as nvarchar(10)) is null then 0 
		 else CAST(JSON_VALUE([OrderAmountData],'$.adjustments') as decimal)
		 end) AS [AdjustmentAmount],
		(case when CAST(JSON_VALUE([OrderAmountData],'$.memberResponsibility') as nvarchar(10)) is null then 0 
		 else CAST(JSON_VALUE([OrderAmountData],'$.memberResponsibility') as decimal)
		 end) AS [MemberResponsibleAmount],
		(case when CAST(PAY.[PaymentAmount1] as decimal) + CAST(PAY.[PaymentAmount2] as decimal) + CAST(PAY.[PaymentAmount3] as decimal) is null then 0 
		      else CAST(PAY.[PaymentAmount1] as decimal) + CAST(PAY.[PaymentAmount2] as decimal) + CAST(PAY.[PaymentAmount3] as decimal)
		 end) 'MemberPayment',
		(case when CONVERT(varchar(10), PO.[PO DATE],101) is null then '' 
		      else CONVERT(varchar(10), PO.[PO DATE],101) 
		 end) as 'PODate',
		(case when PO.PONumber is null then ''
		  else PO.PONumber
		 end) as 'PONumber',
		(case when CLM.[Fitting Date] is null then '' 
		      else CLM.[Fitting Date]
	     end) as 'FittingDate' ,
		(case when CLM.[PurchaseDate] is null then '' 
		 else CLM.[PurchaseDate]
		 end) as 'PurchaseAgreementDate', 
		 (case when CLM.[DeliveryDate] is null then '' 
		 else CLM.[DeliveryDate]
		 end) as 'DeliveryRcptDate', 
		 (case when   CONVERT(varchar(10), RET.[Return Date],101) is null then '' else
		      CONVERT(varchar(10), RET.[Return Date] ,101)
		  end) as 'ReturnDate',
		(case when CLM.[Claim Required] is null then '' else
		      CLM.[Claim Required]
		  end) as 'ClaimRequired',
		P.[PerDeviceDispensingFee] [FittingFeePerDevice],
	--	(P.[PerDeviceDispensingFee] * [DeviceCount]) as 'TotalFittingFee',
		(case when CAST(CLM.[ClaimAmount] as nvarchar(10)) is null then '0' 
		      else CAST(CLM.[ClaimAmount] as nvarchar(10))
		 end) 'ClaimAmount',
		JSON_VALUE(O.MEMBERDATA, '$.insurance.carrierName') + ':' + JSON_VALUE([MemberData],'$.firstName') + ' ' +JSON_VALUE([MemberData],'$.lastName') as 'QBJobName'
from
Orders.Orders_old O with (NOLOCK)

LEFT OUTER JOIN
(
SELECT ORDERID,[OrderTransactionData],
			(case when CONVERT(varchar(10),JSON_VALUE([OrderTransactionData],'$.fittingDate'),101)  = '01/01/0001' then ''
			      when CONVERT(varchar(10),JSON_VALUE([OrderTransactionData],'$.fittingDate'),101) is null then ''
			 else CONVERT(varchar(10),JSON_VALUE([OrderTransactionData],'$.fittingDate'),101)
			 end)  AS [Fitting Date],
            JSON_VALUE([OrderTransactionData],'$.purchaseAgreementReceived') as [PurchaseAgreementRcvd],
			(case when CONVERT(varchar(10),JSON_VALUE([OrderTransactionData],'$.purchaseDate'),101) is null then '' 
			 else CONVERT(varchar(10),JSON_VALUE([OrderTransactionData],'$.purchaseDate'),101) 
			 end) AS [PurchaseDate],
			 JSON_VALUE([OrderTransactionData],'$.deliveryReceipt') as [DeliveryReceiptRcvd],
			(case when CONVERT(varchar(10),JSON_VALUE([OrderTransactionData],'$.deliveryDate'),101) is null then '' 
			 else CONVERT(varchar(10),JSON_VALUE([OrderTransactionData],'$.deliveryDate'),101) 
			 end) AS [DeliveryDate],
			JSON_VALUE([OrderTransactionData],'$.isClaimSubmitted') AS [Claim Required],
			--JSON_VALUE([OrderTransactionData],'$.copayDues.hfCopayDue') AS [Fitting Fee],
			(case when JSON_VALUE([OrderTransactionData],'$.claimAmount') is null then '0'
			 else JSON_VALUE([OrderTransactionData],'$.claimAmount') 
			 end) AS [ClaimAmount]
FROM 
	[Orders].[OrderTransactionDetails] OD1 with (NOLOCK)
	where OD1.OrderStatusCode='CLM' and IsActive=1
)CLM ON (O.ORDERID = CLM.ORDERID)
LEFT OUTER JOIN
(
SELECT CAST(json_value(Ordertransactiondata,'$.returnDt') AS DATE) [Return Date],ORDERID
FROM 
	[Orders].[OrderTransactionDetails] OD1 with (NOLOCK)
	where OD1.OrderStatusCode='RET' and IsActive=1
)RET ON (O.ORDERID = RET.ORDERID)
LEFT OUTER JOIN
(
SELECT  ORDERID,
--JSON_VALUE([OrderTransactionData],'$.transactions[0].paymentDate') [Transaction Date],
--JSON_VALUE([OrderTransactionData],'$.transactions[0].paymentType')[paymentType],
(case 
     when JSON_VALUE([OrderTransactionData],'$.transactions[0].amountPaid') is null then 0
	 else CAST(JSON_VALUE([OrderTransactionData],'$.transactions[0].amountPaid')  as decimal)
end) [PaymentAmount1],
(case 
     when JSON_VALUE([OrderTransactionData],'$.transactions[1].amountPaid') is null then 0
	 else cast(JSON_VALUE([OrderTransactionData],'$.transactions[1].amountPaid') as decimal)
end) [PaymentAmount2],
(case 
     when JSON_VALUE([OrderTransactionData],'$.transactions[2].amountPaid') is null then 0
	 else cast(JSON_VALUE([OrderTransactionData],'$.transactions[2].amountPaid') as decimal)
end) [PaymentAmount3],
(case 
     when JSON_VALUE([OrderTransactionData],'$.transactions[3].amountPaid') is null then 0
	 else cast(JSON_VALUE([OrderTransactionData],'$.transactions[3].amountPaid') as decimal)
end) [PaymentAmount4]
--JSON_VALUE([OrderTransactionData],'$.transactions[0].cardOrBank') [cardOrBank],
--JSON_VALUE([OrderTransactionData],'$.transactions[0].formInputDetails.financeCompany') [financeCompany]
from
[Orders].[OrderTransactionDetails] OD3 with (NOLOCK)
	 where OD3.OrderStatusCode='PAY' and IsActive=1
)PAY ON (O.ORDERID = PAY.ORDERID) 
LEFT OUTER JOIN
(
SELECT ORDERID,
	JSON_VALUE(od4.[OrderTransactionData],'$.poDate') AS [PO DATE], JSON_VALUE(od4.[OrderTransactionData],'$.poNumber') AS PONumber
from	[Orders].[OrderTransactionDetails] OD4 with (NOLOCK)
 where OD4.OrderStatusCode='PO' and IsActive=1
 )PO
 	ON (O.ORDERID = PO.ORDERID) 

LEFT OUTER JOIN Insurance.HealthPlanContracts B ON B.InsuranceHealthPlanID = JSON_VALUE(O.MEMBERDATA, '$.insPlanId')
LEFT OUTER JOIN (select distinct FAMILYPRODUCTCATCODE, FAMILYPRODUCTCODE, HealthPlanContractID, [PerDeviceCOGSPrice],[PerDeviceDispensingFee] 
     from INSURANCE.CONTRACTPRODUCTS) P ON O.TECHNOLOGYLEVELCODE = P.FAMILYPRODUCTCODE AND P.HealthPlanContractId = B.HealthPlanContractId

INNER JOIN [Master].[Members] DS with (NOLOCK) on DS.[NHMemberID] = O.NHMemberID and DS.IsActive=1

where 
O.IsActive=1 
and O.Status <> 'ALAN'


CREATE VIEW [ReportsData].[7_viewAccountingNEW]
AS
SELECT  
   --     (case when O.Status = 'ALAN' then 'BAD'
              --else 'GOOD'
              --end) as 'Record',
        o.NHMemberID,
              o.orderid AS 'OrderNumber',
              --o.orderSource AS 'OrderSource', RAj
              o.Source AS 'OrderSource',
              DS.DataSource AS 'EligSource',
              CONVERT(VARCHAR(10), o.[DateOrderReceived],101) AS 'OrderRcvdDate',
              CONVERT(VARCHAR(10), o.[DateOrderInitiated],101) AS 'OrderCreatedDate',
              o.[OrderType],
        (CASE WHEN o.[OrderType] IN ('EXCHANGE','LSRD') THEN o.[OrderType] +'( of order:' +CAST(o.[RefOrderId] AS VARCHAR) + ')'
              ELSE o.[OrderType]
              END) 'OrderRef',
              o.[Status],
           (CASE WHEN JSON_VALUE(O.MEMBERDATA, '$.insurance.carrierName') = 'None' OR 
                         JSON_VALUE(O.MEMBERDATA, '$.insurance.carrierName') = '' THEN 
                   JSON_VALUE(O.MEMBERDATA, '$.insurance.programeName')
                     ELSE JSON_VALUE(O.MEMBERDATA, '$.insurance.carrierName')
           END) AS 'Carrier',
              JSON_VALUE(O.MEMBERDATA, '$.insurance.planName') AS 'Plan',
              JSON_VALUE([MemberData],'$.firstName') AS [MemberFirstName],
              JSON_VALUE([MemberData],'$.lastName') AS [MemberLastName],
              JSON_VALUE([ProviderData],'$.providerId') AS [ProviderID],
              JSON_VALUE([ProviderData],'$.providerLeagalBusinessName') AS [ProviderLegalName], 
              JSON_VALUE([ProviderData],'$.dba') AS [ProviderDBA],
              JSON_VALUE([ProviderData],'$.dispenser') AS [ProviderDispenser],
              JSON_VALUE([ProviderData],'$.address.address') AS [ProviderAddress],
              JSON_VALUE([ProviderData],'$.address.city') AS [ProviderCity], 
              JSON_VALUE([ProviderData],'$.address.state') AS [ProviderState],
              JSON_VALUE([ProviderData],'$.address.zip') AS [ProviderZip],
              JSON_VALUE([ShippingData],'$.dba') AS [ShippingDBA],
              JSON_VALUE([ShippingData],'$.dispenser') AS [ShippingDispenser],
              [BrandCode] AS [Manufacturer] ,
              [FamilyCode] AS [Family],
              [TechnologyLevelCode] [Product],
              P.FAMILYPRODUCTCATCODE [TechnologyLevel],
              [DeviceCount] AS 'Qty',
			  
			  ---------New Logic for COGS

             -- P.[PerDeviceCOGSPrice] AS 'COGS',
              --P.[PerDeviceCOGSPrice] * [DeviceCount] AS 'TotalCOGS',
			   N.UnitCOGS AS 'COGS',
			   N.UnitCOGS * DeviceCount AS 'TotalCOGS',
              (CASE WHEN CAST(JSON_VALUE([OrderAmountData],'$.insuranceBenefit') AS NVARCHAR(10)) IS NULL THEN 0 
               ELSE CAST(JSON_VALUE([OrderAmountData],'$.insuranceBenefit') AS DECIMAL)
              END) [BenefitAmount],
              (CASE WHEN CAST(JSON_VALUE([OrderAmountData],'$.productPrice') AS NVARCHAR(10)) IS NULL THEN 0 
               ELSE CAST(JSON_VALUE([OrderAmountData],'$.productPrice') AS DECIMAL)
              END) AS [ProductPrice],
              --JSON_VALUE([OrderAmountData],'$.benefitUsed') AS [Benefit Used],
              (CASE WHEN CAST(JSON_VALUE([OrderAmountData],'$.benefitAvailable') AS NVARCHAR(10)) IS NULL THEN 0
              ELSE CAST(JSON_VALUE([OrderAmountData],'$.benefitAvailable') AS DECIMAL)
              END) AS [BenefitAvailable],
              (CASE WHEN CAST(JSON_VALUE([OrderAmountData],'$.adjustments') AS NVARCHAR(10)) IS NULL THEN 0 
               ELSE CAST(JSON_VALUE([OrderAmountData],'$.adjustments') AS DECIMAL)
              END) AS [AdjustmentAmount],
              (CASE WHEN CAST(JSON_VALUE([OrderAmountData],'$.memberResponsibility') AS NVARCHAR(10)) IS NULL THEN 0 
               ELSE CAST(JSON_VALUE([OrderAmountData],'$.memberResponsibility') AS DECIMAL)
              END) AS [MemberResponsibleAmount],
              (CASE WHEN CAST(PAY.[PaymentAmount1] AS DECIMAL) + CAST(PAY.[PaymentAmount2] AS DECIMAL) + CAST(PAY.[PaymentAmount3] AS DECIMAL) IS NULL THEN 0 
                    ELSE CAST(PAY.[PaymentAmount1] AS DECIMAL) + CAST(PAY.[PaymentAmount2] AS DECIMAL) + CAST(PAY.[PaymentAmount3] AS DECIMAL)
              END) 'MemberPayment',
              (CASE WHEN CONVERT(VARCHAR(10), PO.[PO DATE],101) IS NULL THEN '' 
                    ELSE CONVERT(VARCHAR(10), PO.[PO DATE],101) 
               END) AS 'PODate',
              (CASE WHEN PO.PONumber IS NULL THEN ''
                ELSE PO.PONumber
              END) AS 'PONumber',
              (CASE WHEN CLM.[Fitting Date] IS NULL THEN '' 
                    ELSE CLM.[Fitting Date]
            END) AS 'FittingDate' ,
              (CASE WHEN CLM.[PurchaseDate] IS NULL THEN '' 
               ELSE CLM.[PurchaseDate]
              END) AS 'PurchaseAgreementDate', 
               (CASE WHEN CLM.[DeliveryDate] IS NULL THEN '' 
               ELSE CLM.[DeliveryDate]
              END) AS 'DeliveryRcptDate', 
               (CASE WHEN   CONVERT(VARCHAR(10), RET.[Return Date],101) IS NULL THEN '' ELSE
                    CONVERT(VARCHAR(10), RET.[Return Date] ,101)
                END) AS 'ReturnDate',
              (CASE WHEN CLM.[Claim Required] IS NULL THEN '' ELSE
                    CLM.[Claim Required]
                END) AS 'ClaimRequired',
              P.[PerDeviceDispensingFee] [FittingFeePerDevice],
              (P.[PerDeviceDispensingFee] * [DeviceCount]) AS 'TotalFittingFee',
              (CASE WHEN CAST(CLM.[ClaimAmount] AS NVARCHAR(10)) IS NULL THEN '0' 
                    ELSE CAST(CLM.[ClaimAmount] AS NVARCHAR(10))
              END) 'ClaimAmount',
              JSON_VALUE(O.MEMBERDATA, '$.insurance.carrierName') + ':' + JSON_VALUE([MemberData],'$.firstName') + ' ' +JSON_VALUE([MemberData],'$.lastName') AS 'QBJobName'
FROM
(
SELECT s.* , oi.BrandCode, oi.FamilyCode, oi.StyleCode, oi.TechnologyLevelCode, oi.ProductModelCode, oi.ItemCode, oq.DeviceCount
  FROM orders.orders s
INNER JOIN 
(
              SELECT DISTINCT orderid, BrandCode, FamilyCode, StyleCode, TechnologyLevelCode, ProductModelCode, ItemCode
              FROM orders.OrderItems
              WHERE 1 = 1
              AND ItemType IN ('HA') 
              AND IsActive = 1
              ) oi ON (oi.orderid = s.orderid)
INNER JOIN 
(
              SELECT orderid, SUM(Quantity) DeviceCount
              FROM orders.OrderItems
              WHERE 1 = 1
              AND ItemType IN ('HA','CROS') 
              AND IsActive = 1
              --AND Status = 'ACTIVE'
              GROUP BY ORDERID
              ) oq ON (oq.orderid = s.orderid)
              )  O
LEFT OUTER JOIN
(
SELECT ORDERID,[OrderTransactionData],
                     (CASE WHEN CONVERT(VARCHAR(10),JSON_VALUE([OrderTransactionData],'$.fittingDate'),101)  = '01/01/0001' THEN ''
                           WHEN CONVERT(VARCHAR(10),JSON_VALUE([OrderTransactionData],'$.fittingDate'),101) IS NULL THEN ''
                     ELSE CONVERT(VARCHAR(10),JSON_VALUE([OrderTransactionData],'$.fittingDate'),101)
                     END)  AS [Fitting Date],
            JSON_VALUE([OrderTransactionData],'$.purchaseAgreementReceived') AS [PurchaseAgreementRcvd],
                     (CASE WHEN CONVERT(VARCHAR(10),JSON_VALUE([OrderTransactionData],'$.purchaseDate'),101) IS NULL THEN '' 
                      ELSE CONVERT(VARCHAR(10),JSON_VALUE([OrderTransactionData],'$.purchaseDate'),101) 
                      END) AS [PurchaseDate],
                     JSON_VALUE([OrderTransactionData],'$.deliveryReceipt') AS [DeliveryReceiptRcvd],
                     (CASE WHEN CONVERT(VARCHAR(10),JSON_VALUE([OrderTransactionData],'$.deliveryDate'),101) IS NULL THEN '' 
                      ELSE CONVERT(VARCHAR(10),JSON_VALUE([OrderTransactionData],'$.deliveryDate'),101) 
                      END) AS [DeliveryDate],
                     JSON_VALUE([OrderTransactionData],'$.isClaimSubmitted') AS [Claim Required],
                     --JSON_VALUE([OrderTransactionData],'$.copayDues.hfCopayDue') AS [Fitting Fee],
                     (CASE WHEN JSON_VALUE([OrderTransactionData],'$.claimAmount') IS NULL THEN '0'
                     ELSE JSON_VALUE([OrderTransactionData],'$.claimAmount') 
                      END) AS [ClaimAmount]
FROM 
       [Orders].[OrderTransactionDetails] OD1 WITH (NOLOCK)
       WHERE OD1.OrderStatusCode='CLM' AND IsActive=1
)CLM ON (O.ORDERID = CLM.ORDERID)
LEFT OUTER JOIN
(
SELECT CAST(JSON_VALUE(Ordertransactiondata,'$.returnDt') AS DATE) [Return Date],ORDERID
FROM 
       [Orders].[OrderTransactionDetails] OD1 WITH (NOLOCK)
       WHERE OD1.OrderStatusCode='RET' AND IsActive=1
)RET ON (O.ORDERID = RET.ORDERID)
LEFT OUTER JOIN
(
SELECT  ORDERID,
--JSON_VALUE([OrderTransactionData],'$.transactions[0].paymentDate') [Transaction Date],
--JSON_VALUE([OrderTransactionData],'$.transactions[0].paymentType')[paymentType],
(CASE 
     WHEN JSON_VALUE([OrderTransactionData],'$.transactions[0].amountPaid') IS NULL THEN 0
       ELSE CAST(JSON_VALUE([OrderTransactionData],'$.transactions[0].amountPaid')  AS DECIMAL)
END) [PaymentAmount1],
(CASE 
     WHEN JSON_VALUE([OrderTransactionData],'$.transactions[1].amountPaid') IS NULL THEN 0
       ELSE CAST(JSON_VALUE([OrderTransactionData],'$.transactions[1].amountPaid') AS DECIMAL)
END) [PaymentAmount2],
(CASE 
     WHEN JSON_VALUE([OrderTransactionData],'$.transactions[2].amountPaid') IS NULL THEN 0
       ELSE CAST(JSON_VALUE([OrderTransactionData],'$.transactions[2].amountPaid') AS DECIMAL)
END) [PaymentAmount3],
(CASE 
     WHEN JSON_VALUE([OrderTransactionData],'$.transactions[3].amountPaid') IS NULL THEN 0
       ELSE CAST(JSON_VALUE([OrderTransactionData],'$.transactions[3].amountPaid') AS DECIMAL)
END) [PaymentAmount4]
--JSON_VALUE([OrderTransactionData],'$.transactions[0].cardOrBank') [cardOrBank],
--JSON_VALUE([OrderTransactionData],'$.transactions[0].formInputDetails.financeCompany') [financeCompany]
FROM
[Orders].[OrderTransactionDetails] OD3 WITH (NOLOCK)
       WHERE OD3.OrderStatusCode='PAY' AND IsActive=1
)PAY ON (O.ORDERID = PAY.ORDERID) 
LEFT OUTER JOIN
(
SELECT ORDERID,
ISNULL(json_value(OrdertransactionData, '$.poDate'),json_value(OrdertransactionData, '$[0].poDate'))  AS [PO DATE], 
ISNULL(json_value(OrdertransactionData, '$.poNumber'),json_value(OrdertransactionData, '$[0].poNumber')) AS PONumber
FROM   [Orders].[OrderTransactionDetails] OD4 WITH (NOLOCK)
WHERE OD4.OrderStatusCode='PO' AND IsActive=1
)PO
      ON (O.ORDERID = PO.ORDERID) 

LEFT OUTER JOIN Insurance.HealthPlanContracts B ON B.InsuranceHealthPlanID = JSON_VALUE(O.MEMBERDATA, '$.insPlanId')
LEFT OUTER JOIN (SELECT DISTINCT FAMILYPRODUCTCATCODE, FAMILYPRODUCTCODE, HealthPlanContractID, [PerDeviceCOGSPrice],[PerDeviceDispensingFee] 
     FROM INSURANCE.CONTRACTPRODUCTS) P ON O.TECHNOLOGYLEVELCODE = P.FAMILYPRODUCTCODE AND P.HealthPlanContractId = B.HealthPlanContractId

	 ------- Fetching COGS from catalog.ItemMasterPriceList based on PO Date
LEFT OUTER JOIN
(
SELECT DISTINCT PL.ItemCode,PL.PriceType,PL.UnitCOGS,PL.PairCOGS,PL.RebateUnitPrice,PL.RebatePairPrice,PL.EffectiveFrom,PL.EffectiveTo,PL.PriceVersion,HP.HealthPlanName,HP.InsuranceHealthPlanID,O.OrderId
FROM catalog.ItemMasterPriceList  PL
INNER JOIN Orders.orderitems OI ON OI.ItemCode=PL.ItemCode
INNER JOIN Orders.orders O ON O.OrderId=OI.OrderId
INNER JOIN Orders.OrderTransactionDetails TD ON TD.OrderID=OI.OrderId AND TD.IsActive=1 AND TD.OrderStatusCode='PO'
INNER JOIN Insurance.InsuranceHealthPlans HP ON HP.InsuranceHealthPlanID=JSON_VALUE(O.MEMBERDATA, '$.insPlanId')
INNER JOIN [Insurance].[InsuranceCarriers] IC ON IC.InsuranceCarrierID=HP.InsuranceCarrierID
AND  ((HP.IsMedicaid=1 AND PL.PriceType IN('Medicaid')) OR ((IC.InsuranceCarrierName LIKE '%Anthem%') AND (ISNULL(HP.IsMedicaid,0)<>1) AND PL.PriceType IN('AnthemPrice'))
OR((IC.InsuranceCarrierName NOT LIKE '%Anthem%') AND (ISNULL(HP.IsMedicaid,0)<>1)  AND PL.PriceType IN('Standard')))
WHERE (CONVERT(NVARCHAR,CAST(ISNULL(json_value(OrdertransactionData, '$.poDate'),json_value(OrdertransactionData, '$[0].poDate'))AS DATE), 23)) BETWEEN CONVERT(VARCHAR, PL.EffectiveFrom, 23)	AND CONVERT(VARCHAR,CONVERT(datetime,dateadd(DAY, -1, PL.EffectiveTo)),23) 
) N ON N.orderID=O.orderID AND N.InsuranceHealthPlanID= JSON_VALUE(O.MEMBERDATA, '$.insPlanId')

-------
INNER JOIN [Master].[Members] DS WITH (NOLOCK) ON DS.[NHMemberID] = O.NHMemberID AND DS.IsActive=1 WHERE O.IsActive=1 AND O.Status <> 'ALAN'  --






--USE [NHCRM_PROD]
--GO

--/****** Object:  View [ReportsData].[viewAccountingPOReport]    Script Date: 3/29/2018 4:31:19 PM ******/
--DROP VIEW [ReportsData].[viewAccountingPOReport]
--GO

--/****** Object:  View [ReportsData].[viewAccountingPOReport]    Script Date: 3/29/2018 4:31:20 PM ******/
--SET ANSI_NULLS ON
--GO

--SET QUOTED_IDENTIFIER ON
--GO



CREATE VIEW [ReportsData].[viewAccountingPOReport]
AS

SELECT  
        o.NHMemberID,
		o.orderid as 'OrderNumber',
		CONVERT(varchar(10), o.[DateOrderReceived],101) as 'OrderRcvdDate',
		CONVERT(varchar(10), o.[DateOrderInitiated],101) as 'OrderCreatedDate',
		o.[OrderType],
        (case when o.[OrderType] in ('EXCHANGE','LSRD') then o.[OrderType] +'( of order:' +o.[RefOrderId] + ')'
		 else o.[OrderType]
		 end) 'OrderRef',
		o.[Status],
--case  when UPPER(JSON_VALUE(O.MEMBERDATA, '$.insurance.programeName')) <>'' then  UPPER(JSON_VALUE(O.MEMBERDATA, '$.insurance.programeName'))
--	  else UPPER(JSON_VALUE(O.MEMBERDATA, '$.insurance.carrierName')) end REFERENCECARRIERNAME, 
	    JSON_VALUE(O.MEMBERDATA, '$.insurance.carrierName') as 'Carrier',
		JSON_VALUE(O.MEMBERDATA, '$.insurance.planName') as 'Plan',
		JSON_VALUE([MemberData],'$.firstName') + ' ' +JSON_VALUE([MemberData],'$.lastName') AS [MemberName],
		--JSON_VALUE([MemberData],'$.address.state') AS [STATE],
		--JSON_VALUE([ProviderData],'$.dispenser') AS [DISPENSING NUMBER],
		JSON_VALUE([ProviderData],'$.providerLeagalBusinessName') AS [ProviderLegalName],	
		JSON_VALUE([ProviderData],'$.address.address') AS [ProviderAddress],
		JSON_VALUE([ProviderData],'$.address.city') AS [ProviderCity], 
		JSON_VALUE([ProviderData],'$.address.state') AS [ProviderState],
		JSON_VALUE([ProviderData],'$.address.zip') AS [ProviderZip],
		JSON_VALUE([ShippingData],'$.dba') AS [ShippingDBA],
		JSON_VALUE([ShippingData],'$.dispenser') AS [ShippingDispenser],
		[BrandCode] As [Manufacturer] ,
		[FamilyCode] As [Family],
		[TechnologyLevelCode] [Product],
		P.FAMILYPRODUCTCATCODE [TechnologyLevel],
		[DeviceCount] as 'Qty', 
		P.[PerDeviceCOGSPrice] as 'COGS',
		P.[PerDeviceCOGSPrice] * [DeviceCount] as 'TotalCOGS',
		(case when CAST(JSON_VALUE([OrderAmountData],'$.insuranceBenefit') as decimal) is null then 0 
		 else CAST(JSON_VALUE([OrderAmountData],'$.insuranceBenefit') as decimal)
		 end) [BenefitAmount],
		(case when CAST(JSON_VALUE([OrderAmountData],'$.productPrice') as decimal) is null then 0 
		 else CAST(JSON_VALUE([OrderAmountData],'$.productPrice') as decimal)
		 end) AS [ProductPrice],
		--JSON_VALUE([OrderAmountData],'$.benefitUsed') AS [Benefit Used],
		(case when CAST(JSON_VALUE([OrderAmountData],'$.benefitAvailable') as decimal) is null then 0
		 else CAST(JSON_VALUE([OrderAmountData],'$.benefitAvailable') as decimal)
		 end) AS [BenefitAvailable],
		(case when CAST(JSON_VALUE([OrderAmountData],'$.memberResponsibility') as decimal) is null then 0 
		 else CAST(JSON_VALUE([OrderAmountData],'$.memberResponsibility') as decimal)
		 end) AS [MemberResponsibleAmount],
		--CONVERT(varchar(10), PAY.[Transaction Date],101) as 'PaymentDate',
		--PAY.paymentType 'PaymentMode',
  --      (case  when PAY.cardOrBank is null and PAY.paymentType = 'ACH' then 'ACH' 
 	--           when PAY.cardOrBank is null and PAY.paymentType = 'Finance' then PAY.financeCompany
	 --          else PAY.cardOrBank
  --      end) 'PaymentType',
		(case when CAST(PAY.[PaymentAmount1] as decimal) + CAST(PAY.[PaymentAmount2] as decimal) is null then 0 
		      else CAST(PAY.[PaymentAmount1] as decimal) + CAST(PAY.[PaymentAmount2] as decimal)
		 end) 'MemberPayment',
		
		--((case when CAST(JSON_VALUE([OrderAmountData],'$.memberResponsibility') as decimal) is null then 0 
		--      else CAST(JSON_VALUE([OrderAmountData],'$.memberResponsibility') as decimal)
		-- end) - 
		--      (PAY.[PaymentAmount1] + PAY.[PaymentAmount2])) as 'MemberDue',
		(case when CONVERT(varchar(10), PO.[PO DATE],101) is null then '' 
		      else CONVERT(varchar(10), PO.[PO DATE],101) 
		 end) as 'PODate',
		(case when PO.PONumber is null then ''
		  else PO.PONumber
		 end) as 'PONumber',
		(case when CLM.[Fitting Date] is null then '' 
		      else CLM.[Fitting Date]
	     end) as 'FittingDate' ,
		(case when CLM.[PurchaseDate] is null then '' 
		 else CLM.[PurchaseDate]
		 end) as 'PurchaseDate', 
		(case when CLM.[Claim Required] is null then '' else
		      CLM.[Claim Required]
		  end) as 'ClaimRequired',
		P.[PerDeviceDispensingFee] [FittingFeePerDevice],
		(P.[PerDeviceDispensingFee] * [DeviceCount]) as 'TotalFittingFee',
		(case when CAST(CLM.[ClaimAmount] as decimal) is null then 0 
		      else CAST(CLM.[ClaimAmount] as decimal)
		 end) 'ClaimAmount',
		JSON_VALUE(O.MEMBERDATA, '$.insurance.carrierName') + ':' + JSON_VALUE([MemberData],'$.firstName') + ' ' +JSON_VALUE([MemberData],'$.lastName') as 'QBJobName'
from
Orders.Orders O with (NOLOCK)

LEFT OUTER JOIN
(
SELECT ORDERID,[OrderTransactionData],
			(case when CONVERT(varchar(10),JSON_VALUE([OrderTransactionData],'$.fittingDate'),101)  = '01/01/0001' then ''
			      when CONVERT(varchar(10),JSON_VALUE([OrderTransactionData],'$.fittingDate'),101) is null then ''
			 else CONVERT(varchar(10),JSON_VALUE([OrderTransactionData],'$.fittingDate'),101)
			 end)  AS [Fitting Date],
            JSON_VALUE([OrderTransactionData],'$.purchaseAgreementReceived') as [PurchaseAgreementRcvd],
			(case when CONVERT(varchar(10),JSON_VALUE([OrderTransactionData],'$.purchaseDate'),101) is null then '' 
			 else CONVERT(varchar(10),JSON_VALUE([OrderTransactionData],'$.purchaseDate'),101) 
			 end) AS [PurchaseDate],
			JSON_VALUE([OrderTransactionData],'$.isClaimSubmitted') AS [Claim Required],
			--JSON_VALUE([OrderTransactionData],'$.copayDues.hfCopayDue') AS [Fitting Fee],
			(case when JSON_VALUE([OrderTransactionData],'$.claimAmount') is null then '0'
			 else JSON_VALUE([OrderTransactionData],'$.claimAmount') 
			 end) AS [ClaimAmount]
FROM 
	[Orders].[OrderTransactionDetails] OD1 with (NOLOCK)
	where OD1.OrderStatusCode='CLM' and IsActive=1
)CLM ON (O.ORDERID = CLM.ORDERID)

LEFT OUTER JOIN
(
SELECT  ORDERID,
--JSON_VALUE([OrderTransactionData],'$.transactions[0].paymentDate') [Transaction Date],
--JSON_VALUE([OrderTransactionData],'$.transactions[0].paymentType')[paymentType],
(case 
     when JSON_VALUE([OrderTransactionData],'$.transactions[0].amountPaid') is null then 0
	 else CAST(JSON_VALUE([OrderTransactionData],'$.transactions[0].amountPaid')  as decimal)
end) [PaymentAmount1],
(case 
     when JSON_VALUE([OrderTransactionData],'$.transactions[1].amountPaid') is null then 0
	 else cast(JSON_VALUE([OrderTransactionData],'$.transactions[1].amountPaid') as decimal)
end) [PaymentAmount2]
--JSON_VALUE([OrderTransactionData],'$.transactions[0].cardOrBank') [cardOrBank],
--JSON_VALUE([OrderTransactionData],'$.transactions[0].formInputDetails.financeCompany') [financeCompany]
from
[Orders].[OrderTransactionDetails] OD3 with (NOLOCK)
	 where OD3.OrderStatusCode='PAY' and IsActive=1
)PAY ON (O.ORDERID = PAY.ORDERID) 
LEFT OUTER JOIN
(
SELECT ORDERID,
	JSON_VALUE(od4.[OrderTransactionData],'$.poDate') AS [PO DATE], JSON_VALUE(od4.[OrderTransactionData],'$.poNumber') AS PONumber
from	[Orders].[OrderTransactionDetails] OD4 with (NOLOCK)
 where OD4.OrderStatusCode='PO' and IsActive=1
 )PO
 	ON (O.ORDERID = PO.ORDERID) 

LEFT OUTER JOIN 
(
	SELECT X.* 
	FROM 
	(
		SELECT FAMILYPRODUCTCATCODE, FAMILYPRODUCTCODE,[PerDeviceCOGSPrice],[PerDeviceDispensingFee],
			ROW_NUMBER() OVER(PARTITION BY FAMILYPRODUCTCODE ORDER BY CONTRACTPRODUCTID DESC) RN
		FROM INSURANCE.CONTRACTPRODUCTS) X 
		WHERE X.RN = 1
	) P 
ON O.TECHNOLOGYLEVELCODE = P.FAMILYPRODUCTCODE
where 
--[MemberData] is not null and [MemberData] <>''
IsActive=1 and Status <> 'ALAN' 
--and o.[CreateDate] > '03/23/2018' and o.[OrderId] > 180015000









CREATE VIEW  [ReportsData].[viewMemberInfoRpt1]
 AS
    
select distinct 
		provider.MemberProfiles.NHMemberId  [NHMemberId]
		,case 
			when (Insurance.InsuranceCarriers.InsuranceCarrierName like '%none%' or Insurance.InsuranceCarriers.InsuranceCarrierName is null) then 'None'
			else Insurance.InsuranceCarriers.InsuranceCarrierName end as [Program Name]
		,callconversations.lastcalltime_est                                                         [Last Time Called]
		,callconversations.firstcalltime_est                                         [First Time Called]
		,callevents.ParentEventName															[Disposition]
		,callevents.eventname																[Reason]
		,provider.MemberProfiles.FirstName                                                     [First Name]
		,provider.MemberProfiles.LastName                                                     [Last Name]
		,case when provider.MemberProfiles.DateOfBirth = CONVERT(datetime2, '0001-01-01 00:00:00.0000000') then NULL else cast(provider.MemberProfiles.DateOfBirth as date) end as DOB
		,case when Insurance.InsuranceCarriers.InsuranceCarrierName like '%none%' or Insurance.InsuranceCarriers.InsuranceCarrierName is null then '' else provider.MemberInsuranceDetails.InsuranceNbr end as [Member Insurance ID]
		,case when ContractBenefits.BenefitAmt is NULL then 0 else ContractBenefits.BenefitAmt end             [Benefit Amount]
		,COALESCE(memberlocations.Address1, ' ') + ' ' + COALESCE(memberlocations.Address2, ' ') Address
		,memberlocations.City                                                                                              [City]
		,memberlocations.State                                                                                           [State]
		,memberlocations.ZipCode                                                                                      [ZipCode]
		,[Member Phone Number] = (select top 1 phonenumber from provider.memberphonenumbers where provider.memberphonenumbers.memberprofileid = provider.memberprofiles.memberprofileid and isActive = 1 and (phonetypeid= 1 or phonetypeid = 4))
		,provider.AppointmentTypes.AppointmentTypeName      [Appointment Type Name]
		,cast(MemberAppointments.StartDate as Date)                 [Latest Appt Date]
		,cast(MemberAppointments.CreateDate as Date)              [Date Appt was Created]
		,MemberAppointments.AppointmentStatus                                        [Appt Status]
		,case when MemberAppointments.WalkIn = 1 then 'True' else 'False' end as [Walk-In]
		,provider.ProviderProfiles.ProviderId ProviderId
		,provider.ProviderProfiles.Brands                                                           [Manufacturer]
		,provider.ProviderProfiles.ProviderName                                             [Provider Name]
		,provider.Locations.BusinessName                                                         [Legal Business Name]
		,[provider].Locations.LocationEmailAddress            [Email Address]
		,provider.Locations.LocationId LocationId
		,provider.Locations.[Dispenser]                                                               [Dispenser #]
		,[Provider Phone Number] = (select top 1 phonenumber from  provider.locationphonenumbers where locationphonenumbers.locationid = provider.locations.locationid and phonetypeid = 1)
		,[Provider Fax Number] = (select top 1 phonenumber from  provider.locationphonenumbers where locationphonenumbers.locationid = provider.locations.locationid and phonetypeid = 3)
		,COALESCE(provider.Locations.Address1, ' ') + ' ' + COALESCE(provider.Locations.Address2, ' ') AS [Provider Address]
		,provider.Locations.City                                                                            [Provider City]
		,provider.Locations.State                                                                                         [Provider State]
		,provider.Locations.Zip as                                                                                       [Provider Zipcode]
		,provider.MemberProfiles.CreateUser                                                   [Add User]
		,provider.MemberProfiles.ModifyUser                                                  [Modify User]
		,[vsdatamig].[DMContacts].[AddUserNameLastFirst]         [VS Add User]
		,[vsdatamig].[DMContacts].Contactid                                                   [VS Contact Id]
    from 
		(
			select nhmemberid, max(id) id, max(lastcalltime_est) lastcalltime_est, min(firstcalltime_est) firstcalltime_est
			from
			(
				select nhmemberid
					,case when ModifyUser <> 'VanillaSoft' then dateadd(hour, -5, lastcalltime) else lastcalltime end as lastcalltime_est
					,case when ModifyUser <> 'VanillaSoft' then dateadd(hour, -5, firstCalltime) else firstCalltime end as firstcalltime_est
					,id
				from
				(
					select  
						MemberNHMemberId as NHmemberId
						,max(StartTime) lastCalltime
						,min(StartTime) firstCalltime
						,max(callconversationid) id
						,ModifyUser
					from callcenter.CallConversations
					where 
						IsActive = 1
					group by MemberNHMemberId, ModifyUser
				) sometable
			) sometable2
			group by nhmemberid
		) callconversations
		LEFT OUTER JOIN (
			select
				callconversationid,
				case when evnts.ParentEventId IS NULL then evnts.EventName 
					 when evnts.ParentEventId IS NOT NULL then parentevnts.EventName END AS ParentEventName,
				case when evnts.ParentEventId IS NULL then NULL
					 when evnts.ParentEventId IS NOT NULL then evnts.EventName END AS eventname
			from callcenter.callpageevents cpe
			inner join (select * from jobs.events where EventTriggerBy = 'disposition') evnts on evnts.eventid = cpe.EventId
			left join (select * from jobs.events where EventTriggerBy = 'disposition') parentevnts on (parentevnts.eventid = evnts.ParentEventId and evnts.ParentEventId is not null)
			group by callconversationid
			,case when evnts.ParentEventId IS NULL then evnts.EventName 
					 when evnts.ParentEventId IS NOT NULL then parentevnts.EventName END,
				case when evnts.ParentEventId IS NULL then NULL
					 when evnts.ParentEventId IS NOT NULL then evnts.EventName END
		) callevents on callevents.callconversationid = callconversations.id
		LEFT OUTER JOIN provider.MemberProfiles with (nolock) ON provider.MemberProfiles.NHmemberid = callconversations.nhmemberid
		LEFT OUTER JOIN 
		(
			select MemberProfileId, carrid as InsuranceCarrierId, planid as InsuranceHealthPlanId, insid as MemberInsuranceId
			from
			(
				select memberprofileid, max(memberinsuranceid) insid, max(insurancecarrierid) carrid, max(insurancehealthplanid) planid
				from provider.MemberInsurances
				where UseForBenefits = 1 and isactive = 1
				group by MemberProfileId
			union all
				select memberprofileid, max(memberinsuranceid) insid, max(insurancecarrierid) carrid, max(insurancehealthplanid) planid
				from provider.MemberInsurances
				where UseForBenefits = 0 and isactive = 1 and MemberProfileId not in
				(
					select memberprofileid
					from provider.MemberInsurances
					where UseForBenefits = 1 and isactive = 1
					group by MemberProfileId
				)
				group by MemberProfileId
			) ub
		) memberinsurances ON provider.MemberProfiles.MemberProfileId = memberinsurances.MemberProfileId
		LEFT OUTER JOIN provider.MemberInsuranceDetails with (nolock) ON provider.MemberInsuranceDetails.MemberInsuranceId = memberinsurances.MemberInsuranceId
		LEFT OUTER JOIN Insurance.InsuranceCarriers with (nolock) ON memberinsurances.InsuranceCarrierId = Insurance.InsuranceCarriers.InsuranceCarrierId
		LEFT OUTER JOIN (
			SELECT [HealthPlanContractID]
					,[InsuranceCarrierID]
					,[InsuranceHealthPlanID]
			FROM [Insurance].[HealthPlanContracts] with (nolock) 
		) HealthPlanContracts ON memberinsurances.InsuranceCarrierId = HealthPlanContracts.[InsuranceCarrierID]
			AND memberinsurances.InsuranceHealthPlanId = HealthPlanContracts.[InsuranceHealthPlanID]
		LEFT OUTER JOIN (
			SELECT  [BenefitAmt]
                    ,[HealthPlanContractID]
			FROM [Insurance].[ContractBenefits] with (nolock) 
		) ContractBenefits ON HealthPlanContracts.HealthPlanContractId = ContractBenefits.[HealthPlanContractID]
		LEFT OUTER JOIN
		(
			select MemberLocationId
					,Address1
					,Address2
					,AddressTypeId
					,City
					,IsActive
					,MemberProfileId
					,State
					,ZipCode
			from provider.MemberLocations a with (nolock) 
			where
				IsActive = 1
				--and AddressTypeId = 1
				and MemberLocationId = 
				(
					select min(memberlocationid) 
					from provider.MemberLocations 
					where 
						MemberProfileId = a.MemberProfileId
				)
		) memberlocations ON provider.MemberProfiles.MemberProfileId = memberlocations.MemberProfileId 
		LEFT OUTER JOIN provider.MemberCharts charts with (nolock) on charts.MemberProfileId = provider.MemberProfiles.MemberProfileId
		LEFT OUTER JOIN
		(
			select a.*, z.memberchartid, d.locationid, d.providerid
			from provider.MemberAppointments a with (nolock)
			inner join provider.memberchartdata d on a.memberchartdataid = d.memberchartdataid
			inner join provider.membercharts z on z.memberchartid = d.memberchartid
			where
				a.IsActive = 1
			and memberappointmentid = (
				select max(memberappointmentid)
				from provider.MemberAppointments b with (nolock)
				inner join provider.memberchartdata c on b.memberchartdataid = c.memberchartdataid
				where
					c.memberchartid = z.memberchartid and
					b.isactive = 1 and 
					b.AppointmentStatus <> 'Cancel'
			)
		) Memberappointments ON charts.MemberChartId = Memberappointments.MemberChartId
		LEFT OUTER JOIN provider.AppointmentTypes with (nolock) ON provider.AppointmentTypes.AppointmentTypeId = MemberAppointments.AppointmentTypeId
		LEFT OUTER JOIN provider.Locations with (nolock) ON Memberappointments.LocationId = provider.Locations.LocationId
		LEFT OUTER JOIN provider.ProviderProfiles with (nolock) ON Memberappointments.ProviderId = provider.ProviderProfiles.ProviderId
		LEFT OUTER JOIN [vsdatamig].[DMContacts] with (nolock) ON provider.memberprofiles.nhmemberid=[vsdatamig].[DMContacts].nhmemberid
		



CREATE View [ReportsData].[7_viewAccountingNEW2]  AS

SELECT  
        o.NHMemberID,
		o.orderid AS 'OrderNumber',
		o.Source AS 'OrderSource',
		DS.DataSource AS 'EligSource',
		CONVERT(VARCHAR(10), o.[DateOrderReceived],101) AS 'OrderRcvdDate',
		CONVERT(VARCHAR(10), o.[DateOrderInitiated],101) AS 'OrderCreatedDate',
		o.[OrderType],
        (CASE WHEN o.[OrderType] IN ('EXCHANGE','LSandD') THEN o.[OrderType] +'( of order:' + case when o.[RefOrderId] is null then ' ' else  CAST(o.[RefOrderId]AS VARCHAR)  end + ')'
		 ELSE o.[OrderType]
		 END) 'OrderRef',
		o.[Status],
	    (CASE WHEN JSON_VALUE(O.MEMBERDATA, '$.insurance.carrierName') = 'None' OR 
		           JSON_VALUE(O.MEMBERDATA, '$.insurance.carrierName') = '' THEN 
		     JSON_VALUE(O.MEMBERDATA, '$.insurance.programeName')
			 ELSE JSON_VALUE(O.MEMBERDATA, '$.insurance.carrierName')
	    END) AS 'Carrier',
		JSON_VALUE(O.MEMBERDATA, '$.insurance.planName') AS 'Plan',
		JSON_VALUE([MemberData],'$.firstName') AS [MemberFirstName],
		JSON_VALUE([MemberData],'$.lastName') AS [MemberLastName],
		JSON_VALUE([ProviderData],'$.providerId') AS [ProviderID],
		JSON_VALUE([ProviderData],'$.providerLeagalBusinessName') AS [ProviderLegalName],	
		JSON_VALUE([ProviderData],'$.dba') AS [ProviderDBA],
		JSON_VALUE([ProviderData],'$.dispenser') AS [ProviderDispenser],
		JSON_VALUE([ProviderData],'$.address.address') AS [ProviderAddress],
		JSON_VALUE([ProviderData],'$.address.city') AS [ProviderCity], 
		JSON_VALUE([ProviderData],'$.address.state') AS [ProviderState],
		JSON_VALUE([ProviderData],'$.address.zip') AS [ProviderZip],
		JSON_VALUE([ShippingData],'$.dba') AS [ShippingDBA],
		JSON_VALUE([ShippingData],'$.dispenser') AS [ShippingDispenser],
		[BrandCode] AS [Manufacturer] ,
		[FamilyCode] AS [Family],
		[TechnologyLevelCode] [Product],
		P.FAMILYPRODUCTCATCODE [TechnologyLevel],
		[DeviceCount] AS 'Qty', 
		P.[PerDeviceCOGSPrice] AS 'COGS',
		P.[PerDeviceCOGSPrice] * [DeviceCount] AS 'TotalCOGS',
		(CASE WHEN CAST(JSON_VALUE([OrderAmountData],'$.insuranceBenefit') AS NVARCHAR(10)) IS NULL THEN 0 
		 ELSE CAST(JSON_VALUE([OrderAmountData],'$.insuranceBenefit') AS DECIMAL)
		 END) [BenefitAmount],

		(CASE WHEN CAST(JSON_VALUE([OrderAmountData],'$.medicaidBenefit') AS NVARCHAR(10)) IS NULL THEN 0 
		 ELSE CAST(JSON_VALUE([OrderAmountData],'$.medicaidBenefit') AS DECIMAL)
		 END) [medicaidBenefit],

		(CASE WHEN CAST(JSON_VALUE([OrderAmountData],'$.productPrice') AS NVARCHAR(10)) IS NULL THEN 0 
		 ELSE CAST(JSON_VALUE([OrderAmountData],'$.productPrice') AS DECIMAL)
		 END) AS [ProductPrice],
		--JSON_VALUE([OrderAmountData],'$.benefitUsed') AS [Benefit Used],
		(CASE WHEN CAST(JSON_VALUE([OrderAmountData],'$.benefitAvailable') AS NVARCHAR(10)) IS NULL THEN 0
		 ELSE CAST(JSON_VALUE([OrderAmountData],'$.benefitAvailable') AS DECIMAL)
		 END) AS [BenefitAvailable],
		 (CASE WHEN CAST(JSON_VALUE([OrderAmountData],'$.adjustments') AS NVARCHAR(10)) IS NULL THEN 0 
		 ELSE CAST(JSON_VALUE([OrderAmountData],'$.adjustments') AS DECIMAL)
		 END) AS [AdjustmentAmount],
		(CASE WHEN CAST(JSON_VALUE([OrderAmountData],'$.memberResponsibility') AS NVARCHAR(10)) IS NULL THEN 0 
		 ELSE CAST(JSON_VALUE([OrderAmountData],'$.memberResponsibility') AS DECIMAL)
		 END) AS [MemberResponsibleAmount],
		(CASE WHEN CAST(PAY.[PaymentAmount1] AS DECIMAL) + CAST(PAY.[PaymentAmount2] AS DECIMAL) + CAST(PAY.[PaymentAmount3] AS DECIMAL) IS NULL THEN 0 
		      ELSE CAST(PAY.[PaymentAmount1] AS DECIMAL) + CAST(PAY.[PaymentAmount2] AS DECIMAL) + CAST(PAY.[PaymentAmount3] AS DECIMAL)
		 END) 'MemberPayment',
		(CASE WHEN CONVERT(VARCHAR(10), PO.[PO DATE],101) IS NULL THEN '' 
		      ELSE CONVERT(VARCHAR(10), PO.[PO DATE],101) 
		 END) AS 'PODate',
		(CASE WHEN PO.PONumber IS NULL THEN ''
		  ELSE PO.PONumber
		 END) AS 'PONumber',
		(CASE WHEN CLM.[Fitting Date] IS NULL THEN '' 
		      ELSE CLM.[Fitting Date]
	     END) AS 'FittingDate' ,
		(CASE WHEN CLM.[PurchaseDate] IS NULL THEN '' 
		 ELSE CLM.[PurchaseDate]
		 END) AS 'PurchaseAgreementDate', 
		 (CASE WHEN CLM.[DeliveryDate] IS NULL THEN '' 
		 ELSE CLM.[DeliveryDate]
		 END) AS 'DeliveryRcptDate', 
		 (CASE WHEN   CONVERT(VARCHAR(10), RET.[Return Date],101) IS NULL THEN '' ELSE
		      CONVERT(VARCHAR(10), RET.[Return Date] ,101)
		  END) AS 'ReturnDate',
		(CASE WHEN CLM.[Claim Required] IS NULL THEN '' ELSE
		      CLM.[Claim Required]
		  END) AS 'ClaimRequired',
		P.[PerDeviceDispensingFee] [FittingFeePerDevice],
		(P.[PerDeviceDispensingFee] * [DeviceCount]) AS 'TotalFittingFee',
		(CASE WHEN CAST(CLM.[ClaimAmount] AS NVARCHAR(10)) IS NULL THEN '0' 
		      ELSE CAST(CLM.[ClaimAmount] AS NVARCHAR(10))
		 END) 'ClaimAmount',
		JSON_VALUE(O.MEMBERDATA, '$.insurance.carrierName') + ':' + JSON_VALUE([MemberData],'$.firstName') + ' ' +JSON_VALUE([MemberData],'$.lastName') AS 'QBJobName'
FROM
(
SELECT s.* , oi.BrandCode, oi.FamilyCode, oi.StyleCode, oi.TechnologyLevelCode, oi.ProductModelCode, oi.ItemCode, oq.DeviceCount
  FROM orders.orders s
INNER JOIN 
(
		SELECT DISTINCT orderid, BrandCode, FamilyCode, StyleCode, TechnologyLevelCode, ProductModelCode, ItemCode
		FROM orders.OrderItems
		WHERE 1 = 1
		AND ItemType IN ('HA') 
		AND IsActive = 1
		) oi ON (oi.orderid = s.orderid)
INNER JOIN 
(
		SELECT orderid, SUM(Quantity) DeviceCount
		FROM orders.OrderItems
		WHERE 1 = 1
		AND ItemType IN ('HA','CROS') 
		AND IsActive = 1
		--AND Status = 'ACTIVE'
		GROUP BY ORDERID
		) oq ON (oq.orderid = s.orderid)
		)  O
 LEFT OUTER JOIN
(
SELECT ORDERID,[OrderTransactionData],
			(CASE WHEN CONVERT(VARCHAR(10),JSON_VALUE([OrderTransactionData],'$.fittingDate'),101)  = '01/01/0001' THEN ''
			      WHEN CONVERT(VARCHAR(10),JSON_VALUE([OrderTransactionData],'$.fittingDate'),101) IS NULL THEN ''
			 ELSE CONVERT(VARCHAR(10),JSON_VALUE([OrderTransactionData],'$.fittingDate'),101)
			 END)  AS [Fitting Date],
            JSON_VALUE([OrderTransactionData],'$.purchaseAgreementReceived') AS [PurchaseAgreementRcvd],
			(CASE WHEN CONVERT(VARCHAR(10),JSON_VALUE([OrderTransactionData],'$.purchaseDate'),101) IS NULL THEN '' 
			 ELSE CONVERT(VARCHAR(10),JSON_VALUE([OrderTransactionData],'$.purchaseDate'),101) 
			 END) AS [PurchaseDate],
			 JSON_VALUE([OrderTransactionData],'$.deliveryReceipt') AS [DeliveryReceiptRcvd],
			(CASE WHEN CONVERT(VARCHAR(10),JSON_VALUE([OrderTransactionData],'$.deliveryDate'),101) IS NULL THEN '' 
			 ELSE CONVERT(VARCHAR(10),JSON_VALUE([OrderTransactionData],'$.deliveryDate'),101) 
			 END) AS [DeliveryDate],
			JSON_VALUE([OrderTransactionData],'$.isClaimSubmitted') AS [Claim Required],
			--JSON_VALUE([OrderTransactionData],'$.copayDues.hfCopayDue') AS [Fitting Fee],
			(CASE WHEN JSON_VALUE([OrderTransactionData],'$.claimAmount') IS NULL THEN '0'
			 ELSE JSON_VALUE([OrderTransactionData],'$.claimAmount') 
			 END) AS [ClaimAmount]
FROM 
	[Orders].[OrderTransactionDetails] OD1 WITH (NOLOCK)
	WHERE OD1.OrderStatusCode='CLM' AND IsActive=1
)CLM ON (O.ORDERID = CLM.ORDERID)
LEFT OUTER JOIN
(
SELECT CAST(JSON_VALUE(Ordertransactiondata,'$.returnDt') AS DATE) [Return Date],ORDERID
FROM 
	[Orders].[OrderTransactionDetails] OD1 WITH (NOLOCK)
	WHERE OD1.OrderStatusCode='RET' AND IsActive=1
)RET ON (O.ORDERID = RET.ORDERID)
LEFT OUTER JOIN
(
SELECT  ORDERID,
--JSON_VALUE([OrderTransactionData],'$.transactions[0].paymentDate') [Transaction Date],
--JSON_VALUE([OrderTransactionData],'$.transactions[0].paymentType')[paymentType],
(CASE 
     WHEN JSON_VALUE([OrderTransactionData],'$.transactions[0].amountPaid') IS NULL THEN 0
	 ELSE CAST(JSON_VALUE([OrderTransactionData],'$.transactions[0].amountPaid')  AS DECIMAL)
END) [PaymentAmount1],
(CASE 
     WHEN JSON_VALUE([OrderTransactionData],'$.transactions[1].amountPaid') IS NULL THEN 0
	 ELSE CAST(JSON_VALUE([OrderTransactionData],'$.transactions[1].amountPaid') AS DECIMAL)
END) [PaymentAmount2],
(CASE 
     WHEN JSON_VALUE([OrderTransactionData],'$.transactions[2].amountPaid') IS NULL THEN 0
	 ELSE CAST(JSON_VALUE([OrderTransactionData],'$.transactions[2].amountPaid') AS DECIMAL)
END) [PaymentAmount3],
(CASE 
     WHEN JSON_VALUE([OrderTransactionData],'$.transactions[3].amountPaid') IS NULL THEN 0
	 ELSE CAST(JSON_VALUE([OrderTransactionData],'$.transactions[3].amountPaid') AS DECIMAL)
END) [PaymentAmount4]
--JSON_VALUE([OrderTransactionData],'$.transactions[0].cardOrBank') [cardOrBank],
--JSON_VALUE([OrderTransactionData],'$.transactions[0].formInputDetails.financeCompany') [financeCompany]
FROM
[Orders].[OrderTransactionDetails] OD3 WITH (NOLOCK)
	 WHERE OD3.OrderStatusCode='PAY' AND IsActive=1
)PAY ON (O.ORDERID = PAY.ORDERID) 
LEFT OUTER JOIN
(
 SELECT ORDERID,
ISNULL(json_value(OrdertransactionData, '$.poDate'),json_value(OrdertransactionData, '$[0].poDate'))  AS [PO DATE], 
ISNULL(json_value(OrdertransactionData, '$.poNumber'),json_value(OrdertransactionData, '$[0].poNumber')) AS PONumber
FROM   [Orders].[OrderTransactionDetails] OD4 WITH (NOLOCK)
WHERE OD4.OrderStatusCode='PO' AND IsActive=1
 )PO
 	ON (O.ORDERID = PO.ORDERID) 

LEFT OUTER JOIN Insurance.HealthPlanContracts B ON B.InsuranceHealthPlanID = JSON_VALUE(O.MEMBERDATA, '$.insPlanId')
LEFT OUTER JOIN (SELECT DISTINCT FAMILYPRODUCTCATCODE, FAMILYPRODUCTCODE, HealthPlanContractID, [PerDeviceCOGSPrice],[PerDeviceDispensingFee] 
     FROM INSURANCE.CONTRACTPRODUCTS) P ON O.TECHNOLOGYLEVELCODE = P.FAMILYPRODUCTCODE AND P.HealthPlanContractId = B.HealthPlanContractId

INNER JOIN [Master].[Members] DS WITH (NOLOCK) ON DS.[NHMemberID] = O.NHMemberID AND DS.IsActive=1

WHERE 
O.IsActive=1 
AND O.Status <> 'ALAN'



CREATE VIEW [ReportsData].[6_MarketSharePivot]
	AS
	
	select [referencecarriername] CARRIER,
	ISNULL([GNR],0) GNR,ISNULL([BELTONE],0) BELTONE,ISNULL([STARKEY],0) STARKEY,ISNULL([PHONAK],0) PHONAK
	 ,ISNULL([SIGNIA],0) SIGNIA,ISNULL([WIDEX],0) WIDEX,ISNULL([UNITRON],0) UNITRON,ISNULL([OTICON],0) OTICON
	from (select referencecarriername, brandcode, sum(devicecount) as 'cnt' from ReportsData.viewMarketShare
	    group by referencecarriername, brandcode ) a
	pivot
	(   sum(cnt)
	    for brandcode in ([GNR],[BELTONE],[STARKEY],[PHONAK],[SIGNIA],[WIDEX],[UNITRON],[OTICON])
	) as P
CREATE VIEW  [ReportsData].[viewMemberInfoRpt1]
 AS
    
select distinct 
		provider.MemberProfiles.NHMemberId  [NHMemberId]
		,case 
			when (Insurance.InsuranceCarriers.InsuranceCarrierName like '%none%' or Insurance.InsuranceCarriers.InsuranceCarrierName is null) then 'None'
			else Insurance.InsuranceCarriers.InsuranceCarrierName end as [Program Name]
		,callconversations.lastcalltime_est                                                         [Last Time Called]
		,callconversations.firstcalltime_est                                         [First Time Called]
		,callevents.eventname															[Latest Disposition]
		,provider.MemberProfiles.FirstName                                                     [First Name]
		,provider.MemberProfiles.LastName                                                     [Last Name]
		,case when provider.MemberProfiles.DateOfBirth = CONVERT(datetime2, '0001-01-01 00:00:00.0000000') then NULL else cast(provider.MemberProfiles.DateOfBirth as date) end as DOB
		,case when Insurance.InsuranceCarriers.InsuranceCarrierName like '%none%' or Insurance.InsuranceCarriers.InsuranceCarrierName is null then '' else provider.MemberInsuranceDetails.InsuranceNbr end as [Member Insurance ID]
		,case when ContractBenefits.BenefitAmt is NULL then 0 else ContractBenefits.BenefitAmt end             [Benefit Amount]
		,COALESCE(memberlocations.Address1, ' ') + ' ' + COALESCE(memberlocations.Address2, ' ') Address
		,memberlocations.City                                                                                              [City]
		,memberlocations.State                                                                                           [State]
		,memberlocations.ZipCode                                                                                      [ZipCode]
		,[Member Phone Number] = (select top 1 phonenumber from provider.memberphonenumbers where provider.memberphonenumbers.memberprofileid = provider.memberprofiles.memberprofileid and isActive = 1 and (phonetypeid= 1 or phonetypeid = 4))
		,provider.AppointmentTypes.AppointmentTypeName      [Appointment Type Name]
		,cast(MemberAppointments.StartDate as Date)                 [Latest Appt Date]
		,cast(MemberAppointments.CreateDate as Date)              [Date Appt was Created]
		,MemberAppointments.AppointmentStatus                                        [Appt Status]
		,case when MemberAppointments.WalkIn = 1 then 'True' else 'False' end as [Walk-In]
		,provider.ProviderProfiles.ProviderId ProviderId
		,provider.ProviderProfiles.Brands                                                           [Manufacturer]
		,provider.ProviderProfiles.ProviderName                                             [Provider Name]
		,provider.Locations.BusinessName                                                         [Legal Business Name]
		,[provider].Locations.LocationEmailAddress            [Email Address]
		,provider.Locations.LocationId LocationId
		,provider.Locations.[Dispenser]                                                               [Dispenser #]
		,[Provider Phone Number] = (select top 1 phonenumber from  provider.locationphonenumbers where locationphonenumbers.locationid = provider.locations.locationid and phonetypeid = 1)
		,[Provider Fax Number] = (select top 1 phonenumber from  provider.locationphonenumbers where locationphonenumbers.locationid = provider.locations.locationid and phonetypeid = 3)
		,COALESCE(provider.Locations.Address1, ' ') + ' ' + COALESCE(provider.Locations.Address2, ' ') AS [Provider Address]
		,provider.Locations.City                                                                            [Provider City]
		,provider.Locations.State                                                                                         [Provider State]
		,provider.Locations.Zip as                                                                                       [Provider Zipcode]
		,provider.MemberProfiles.CreateUser                                                   [Add User]
		,provider.MemberProfiles.ModifyUser                                                  [Modify User]
		,[vsdatamig].[DMContacts].[AddUserNameLastFirst]         [VS Add User]
		,[vsdatamig].[DMContacts].Contactid                                                   [VS Contact Id]
    from 
		(
			select nhmemberid, max(id) id, max(lastcalltime_est) lastcalltime_est, min(firstcalltime_est) firstcalltime_est
			from
			(
				select nhmemberid
					,case when ModifyUser <> 'VanillaSoft' then dateadd(hour, -5, lastcalltime) else lastcalltime end as lastcalltime_est
					,case when ModifyUser <> 'VanillaSoft' then dateadd(hour, -5, firstCalltime) else firstCalltime end as firstcalltime_est
					,id
				from
				(
					select  
						MemberNHMemberId as NHmemberId
						,max(StartTime) lastCalltime
						,min(StartTime) firstCalltime
						,max(callconversationid) id
						,ModifyUser
					from callcenter.CallConversations
					where 
						IsActive = 1
					group by MemberNHMemberId, ModifyUser
				) sometable
			) sometable2
			group by nhmemberid
		) callconversations
		LEFT OUTER JOIN (
			select
				callconversationid,
				max(evnts.EventName) eventname
			from callcenter.callpageevents cpe
			inner join (select * from jobs.events where EventTriggerBy = 'disposition') evnts on evnts.eventid = cpe.EventId
			group by callconversationid
		) callevents on callevents.callconversationid = callconversations.id
		LEFT OUTER JOIN provider.MemberProfiles with (nolock) ON provider.MemberProfiles.NHmemberid = callconversations.nhmemberid
		LEFT OUTER JOIN 
		(
			select MemberProfileId, carrid as InsuranceCarrierId, planid as InsuranceHealthPlanId, insid as MemberInsuranceId
			from
			(
				select memberprofileid, max(memberinsuranceid) insid, max(insurancecarrierid) carrid, max(insurancehealthplanid) planid
				from provider.MemberInsurances
				where UseForBenefits = 1 and isactive = 1
				group by MemberProfileId
			union all
				select memberprofileid, max(memberinsuranceid) insid, max(insurancecarrierid) carrid, max(insurancehealthplanid) planid
				from provider.MemberInsurances
				where UseForBenefits = 0 and isactive = 1 and MemberProfileId not in
				(
					select memberprofileid
					from provider.MemberInsurances
					where UseForBenefits = 1 and isactive = 1
					group by MemberProfileId
				)
				group by MemberProfileId
			) ub
		) memberinsurances ON provider.MemberProfiles.MemberProfileId = memberinsurances.MemberProfileId
		LEFT OUTER JOIN provider.MemberInsuranceDetails with (nolock) ON provider.MemberInsuranceDetails.MemberInsuranceId = memberinsurances.MemberInsuranceId
		LEFT OUTER JOIN Insurance.InsuranceCarriers with (nolock) ON memberinsurances.InsuranceCarrierId = Insurance.InsuranceCarriers.InsuranceCarrierId
		LEFT OUTER JOIN (
			SELECT [HealthPlanContractID]
					,[InsuranceCarrierID]
					,[InsuranceHealthPlanID]
			FROM [Insurance].[HealthPlanContracts] with (nolock) 
		) HealthPlanContracts ON memberinsurances.InsuranceCarrierId = HealthPlanContracts.[InsuranceCarrierID]
			AND memberinsurances.InsuranceHealthPlanId = HealthPlanContracts.[InsuranceHealthPlanID]
		LEFT OUTER JOIN (
			SELECT  [BenefitAmt]
                    ,[HealthPlanContractID]
			FROM [Insurance].[ContractBenefits] with (nolock) 
		) ContractBenefits ON HealthPlanContracts.HealthPlanContractId = ContractBenefits.[HealthPlanContractID]
		LEFT OUTER JOIN
		(
			select MemberLocationId
					,Address1
					,Address2
					,AddressTypeId
					,City
					,IsActive
					,MemberProfileId
					,State
					,ZipCode
			from provider.MemberLocations a with (nolock) 
			where
				IsActive = 1
				--and AddressTypeId = 1
				and MemberLocationId = 
				(
					select min(memberlocationid) 
					from provider.MemberLocations 
					where 
						MemberProfileId = a.MemberProfileId
				)
		) memberlocations ON provider.MemberProfiles.MemberProfileId = memberlocations.MemberProfileId 
		LEFT OUTER JOIN provider.MemberCharts charts with (nolock) on charts.MemberProfileId = provider.MemberProfiles.MemberProfileId
		LEFT OUTER JOIN
		(
			select a.*, z.memberchartid, d.locationid, d.providerid
			from provider.MemberAppointments a with (nolock)
			inner join provider.memberchartdata d on a.memberchartdataid = d.memberchartdataid
			inner join provider.membercharts z on z.memberchartid = d.memberchartid
			where
				a.IsActive = 1
			and memberappointmentid = (
				select max(memberappointmentid)
				from provider.MemberAppointments b with (nolock)
				inner join provider.memberchartdata c on b.memberchartdataid = c.memberchartdataid
				where
					c.memberchartid = z.memberchartid and
					b.isactive = 1 and 
					b.AppointmentStatus <> 'Cancel'
			)
		) Memberappointments ON charts.MemberChartId = Memberappointments.MemberChartId
		LEFT OUTER JOIN provider.AppointmentTypes with (nolock) ON provider.AppointmentTypes.AppointmentTypeId = MemberAppointments.AppointmentTypeId
		LEFT OUTER JOIN provider.Locations with (nolock) ON Memberappointments.LocationId = provider.Locations.LocationId
		LEFT OUTER JOIN provider.ProviderProfiles with (nolock) ON Memberappointments.ProviderId = provider.ProviderProfiles.ProviderId
		LEFT OUTER JOIN [vsdatamig].[DMContacts] with (nolock) ON provider.memberprofiles.nhmemberid=[vsdatamig].[DMContacts].nhmemberid
		
CREATE VIEW [ReportsData].[RajVNew]
AS

SELECT  
   --     (case when O.Status = 'ALAN' then 'BAD'
		 --else 'GOOD'
		 --end) as 'Record',
        o.NHMemberID,
		o.orderid AS 'OrderNumber',
		--o.orderSource AS 'OrderSource', RAj
		o.Source AS 'OrderSource',
		DS.DataSource AS 'EligSource',
		CONVERT(VARCHAR(10), o.[DateOrderReceived],101) AS 'OrderRcvdDate',
		CONVERT(VARCHAR(10), o.[DateOrderInitiated],101) AS 'OrderCreatedDate',
		o.[OrderType],
        (CASE WHEN o.[OrderType] IN ('EXCHANGE','LSRD') THEN o.[OrderType] +'( of order:' +o.[RefOrderId] + ')'
		 ELSE o.[OrderType]
		 END) 'OrderRef',
		o.[Status],
	    (CASE WHEN JSON_VALUE(O.MEMBERDATA, '$.insurance.carrierName') = 'None' OR 
		           JSON_VALUE(O.MEMBERDATA, '$.insurance.carrierName') = '' THEN 
		     JSON_VALUE(O.MEMBERDATA, '$.insurance.programeName')
			 ELSE JSON_VALUE(O.MEMBERDATA, '$.insurance.carrierName')
	    END) AS 'Carrier',
		JSON_VALUE(O.MEMBERDATA, '$.insurance.planName') AS 'Plan',
		JSON_VALUE([MemberData],'$.firstName') AS [MemberFirstName],
		JSON_VALUE([MemberData],'$.lastName') AS [MemberLastName],
		JSON_VALUE([ProviderData],'$.providerId') AS [ProviderID],
		JSON_VALUE([ProviderData],'$.providerLeagalBusinessName') AS [ProviderLegalName],	
		JSON_VALUE([ProviderData],'$.dba') AS [ProviderDBA],
		JSON_VALUE([ProviderData],'$.dispenser') AS [ProviderDispenser],
		JSON_VALUE([ProviderData],'$.address.address') AS [ProviderAddress],
		JSON_VALUE([ProviderData],'$.address.city') AS [ProviderCity], 
		JSON_VALUE([ProviderData],'$.address.state') AS [ProviderState],
		JSON_VALUE([ProviderData],'$.address.zip') AS [ProviderZip],
		JSON_VALUE([ShippingData],'$.dba') AS [ShippingDBA],
		JSON_VALUE([ShippingData],'$.dispenser') AS [ShippingDispenser],
		[BrandCode] AS [Manufacturer] ,
		[FamilyCode] AS [Family],
		[TechnologyLevelCode] [Product],
		P.FAMILYPRODUCTCATCODE [TechnologyLevel],
		[DeviceCount] AS 'Qty', 
		P.[PerDeviceCOGSPrice] AS 'COGS',
		P.[PerDeviceCOGSPrice] * [DeviceCount] AS 'TotalCOGS',
		(CASE WHEN CAST(JSON_VALUE([OrderAmountData],'$.insuranceBenefit') AS NVARCHAR(10)) IS NULL THEN 0 
		 ELSE CAST(JSON_VALUE([OrderAmountData],'$.insuranceBenefit') AS DECIMAL)
		 END) [BenefitAmount],
		(CASE WHEN CAST(JSON_VALUE([OrderAmountData],'$.productPrice') AS NVARCHAR(10)) IS NULL THEN 0 
		 ELSE CAST(JSON_VALUE([OrderAmountData],'$.productPrice') AS DECIMAL)
		 END) AS [ProductPrice],
		--JSON_VALUE([OrderAmountData],'$.benefitUsed') AS [Benefit Used],
		(CASE WHEN CAST(JSON_VALUE([OrderAmountData],'$.benefitAvailable') AS NVARCHAR(10)) IS NULL THEN 0
		 ELSE CAST(JSON_VALUE([OrderAmountData],'$.benefitAvailable') AS DECIMAL)
		 END) AS [BenefitAvailable],
		 (CASE WHEN CAST(JSON_VALUE([OrderAmountData],'$.adjustments') AS NVARCHAR(10)) IS NULL THEN 0 
		 ELSE CAST(JSON_VALUE([OrderAmountData],'$.adjustments') AS DECIMAL)
		 END) AS [AdjustmentAmount],
		(CASE WHEN CAST(JSON_VALUE([OrderAmountData],'$.memberResponsibility') AS NVARCHAR(10)) IS NULL THEN 0 
		 ELSE CAST(JSON_VALUE([OrderAmountData],'$.memberResponsibility') AS DECIMAL)
		 END) AS [MemberResponsibleAmount],
		(CASE WHEN CAST(PAY.[PaymentAmount1] AS DECIMAL) + CAST(PAY.[PaymentAmount2] AS DECIMAL) + CAST(PAY.[PaymentAmount3] AS DECIMAL) IS NULL THEN 0 
		      ELSE CAST(PAY.[PaymentAmount1] AS DECIMAL) + CAST(PAY.[PaymentAmount2] AS DECIMAL) + CAST(PAY.[PaymentAmount3] AS DECIMAL)
		 END) 'MemberPayment',
		(CASE WHEN CONVERT(VARCHAR(10), PO.[PO DATE],101) IS NULL THEN '' 
		      ELSE CONVERT(VARCHAR(10), PO.[PO DATE],101) 
		 END) AS 'PODate',
		(CASE WHEN PO.PONumber IS NULL THEN ''
		  ELSE PO.PONumber
		 END) AS 'PONumber',
		(CASE WHEN CLM.[Fitting Date] IS NULL THEN '' 
		      ELSE CLM.[Fitting Date]
	     END) AS 'FittingDate' ,
		(CASE WHEN CLM.[PurchaseDate] IS NULL THEN '' 
		 ELSE CLM.[PurchaseDate]
		 END) AS 'PurchaseAgreementDate', 
		 (CASE WHEN CLM.[DeliveryDate] IS NULL THEN '' 
		 ELSE CLM.[DeliveryDate]
		 END) AS 'DeliveryRcptDate', 
		 (CASE WHEN   CONVERT(VARCHAR(10), RET.[Return Date],101) IS NULL THEN '' ELSE
		      CONVERT(VARCHAR(10), RET.[Return Date] ,101)
		  END) AS 'ReturnDate',
		(CASE WHEN CLM.[Claim Required] IS NULL THEN '' ELSE
		      CLM.[Claim Required]
		  END) AS 'ClaimRequired',
		P.[PerDeviceDispensingFee] [FittingFeePerDevice],
		(P.[PerDeviceDispensingFee] * [DeviceCount]) AS 'TotalFittingFee',
		(CASE WHEN CAST(CLM.[ClaimAmount] AS NVARCHAR(10)) IS NULL THEN '0' 
		      ELSE CAST(CLM.[ClaimAmount] AS NVARCHAR(10))
		 END) 'ClaimAmount',
		JSON_VALUE(O.MEMBERDATA, '$.insurance.carrierName') + ':' + JSON_VALUE([MemberData],'$.firstName') + ' ' +JSON_VALUE([MemberData],'$.lastName') AS 'QBJobName'
FROM
(
SELECT s.* , oi.BrandCode, oi.FamilyCode, oi.StyleCode, oi.TechnologyLevelCode, oi.ProductModelCode, oi.ItemCode, oq.DeviceCount
  FROM orders.orders s
INNER JOIN 
(
		SELECT DISTINCT orderid, BrandCode, FamilyCode, StyleCode, TechnologyLevelCode, ProductModelCode, ItemCode
		FROM orders.OrderItems
		WHERE 1 = 1
		AND ItemType IN ('HA') 
		AND IsActive = 1
		) oi ON (oi.orderid = s.orderid)
INNER JOIN 
(
		SELECT orderid, SUM(Quantity) DeviceCount
		FROM orders.OrderItems
		WHERE 1 = 1
		AND ItemType IN ('HA','CROS') 
		AND IsActive = 1
		--AND Status = 'ACTIVE'
		GROUP BY ORDERID
		) oq ON (oq.orderid = s.orderid)
		)  O
 LEFT OUTER JOIN
(
SELECT ORDERID,[OrderTransactionData],
			(CASE WHEN CONVERT(VARCHAR(10),JSON_VALUE([OrderTransactionData],'$.fittingDate'),101)  = '01/01/0001' THEN ''
			      WHEN CONVERT(VARCHAR(10),JSON_VALUE([OrderTransactionData],'$.fittingDate'),101) IS NULL THEN ''
			 ELSE CONVERT(VARCHAR(10),JSON_VALUE([OrderTransactionData],'$.fittingDate'),101)
			 END)  AS [Fitting Date],
            JSON_VALUE([OrderTransactionData],'$.purchaseAgreementReceived') AS [PurchaseAgreementRcvd],
			(CASE WHEN CONVERT(VARCHAR(10),JSON_VALUE([OrderTransactionData],'$.purchaseDate'),101) IS NULL THEN '' 
			 ELSE CONVERT(VARCHAR(10),JSON_VALUE([OrderTransactionData],'$.purchaseDate'),101) 
			 END) AS [PurchaseDate],
			 JSON_VALUE([OrderTransactionData],'$.deliveryReceipt') AS [DeliveryReceiptRcvd],
			(CASE WHEN CONVERT(VARCHAR(10),JSON_VALUE([OrderTransactionData],'$.deliveryDate'),101) IS NULL THEN '' 
			 ELSE CONVERT(VARCHAR(10),JSON_VALUE([OrderTransactionData],'$.deliveryDate'),101) 
			 END) AS [DeliveryDate],
			JSON_VALUE([OrderTransactionData],'$.isClaimSubmitted') AS [Claim Required],
			--JSON_VALUE([OrderTransactionData],'$.copayDues.hfCopayDue') AS [Fitting Fee],
			(CASE WHEN JSON_VALUE([OrderTransactionData],'$.claimAmount') IS NULL THEN '0'
			 ELSE JSON_VALUE([OrderTransactionData],'$.claimAmount') 
			 END) AS [ClaimAmount]
FROM 
	[Orders].[OrderTransactionDetails] OD1 WITH (NOLOCK)
	WHERE OD1.OrderStatusCode='CLM' AND IsActive=1
)CLM ON (O.ORDERID = CLM.ORDERID)
LEFT OUTER JOIN
(
SELECT CAST(JSON_VALUE(Ordertransactiondata,'$.returnDt') AS DATE) [Return Date],ORDERID
FROM 
	[Orders].[OrderTransactionDetails] OD1 WITH (NOLOCK)
	WHERE OD1.OrderStatusCode='RET' AND IsActive=1
)RET ON (O.ORDERID = RET.ORDERID)
LEFT OUTER JOIN
(
SELECT  ORDERID,
--JSON_VALUE([OrderTransactionData],'$.transactions[0].paymentDate') [Transaction Date],
--JSON_VALUE([OrderTransactionData],'$.transactions[0].paymentType')[paymentType],
(CASE 
     WHEN JSON_VALUE([OrderTransactionData],'$.transactions[0].amountPaid') IS NULL THEN 0
	 ELSE CAST(JSON_VALUE([OrderTransactionData],'$.transactions[0].amountPaid')  AS DECIMAL)
END) [PaymentAmount1],
(CASE 
     WHEN JSON_VALUE([OrderTransactionData],'$.transactions[1].amountPaid') IS NULL THEN 0
	 ELSE CAST(JSON_VALUE([OrderTransactionData],'$.transactions[1].amountPaid') AS DECIMAL)
END) [PaymentAmount2],
(CASE 
     WHEN JSON_VALUE([OrderTransactionData],'$.transactions[2].amountPaid') IS NULL THEN 0
	 ELSE CAST(JSON_VALUE([OrderTransactionData],'$.transactions[2].amountPaid') AS DECIMAL)
END) [PaymentAmount3],
(CASE 
     WHEN JSON_VALUE([OrderTransactionData],'$.transactions[3].amountPaid') IS NULL THEN 0
	 ELSE CAST(JSON_VALUE([OrderTransactionData],'$.transactions[3].amountPaid') AS DECIMAL)
END) [PaymentAmount4]
--JSON_VALUE([OrderTransactionData],'$.transactions[0].cardOrBank') [cardOrBank],
--JSON_VALUE([OrderTransactionData],'$.transactions[0].formInputDetails.financeCompany') [financeCompany]
FROM
[Orders].[OrderTransactionDetails] OD3 WITH (NOLOCK)
	 WHERE OD3.OrderStatusCode='PAY' AND IsActive=1
)PAY ON (O.ORDERID = PAY.ORDERID) 
LEFT OUTER JOIN
(
SELECT ORDERID,
	JSON_VALUE(od4.[OrderTransactionData],'$.poDate') AS [PO DATE], JSON_VALUE(od4.[OrderTransactionData],'$.poNumber') AS PONumber
FROM	[Orders].[OrderTransactionDetails] OD4 WITH (NOLOCK)
 WHERE OD4.OrderStatusCode='PO' AND IsActive=1
 )PO
 	ON (O.ORDERID = PO.ORDERID) 

LEFT OUTER JOIN Insurance.HealthPlanContracts B ON B.InsuranceHealthPlanID = JSON_VALUE(O.MEMBERDATA, '$.insPlanId')
LEFT OUTER JOIN (SELECT DISTINCT FAMILYPRODUCTCATCODE, FAMILYPRODUCTCODE, HealthPlanContractID, [PerDeviceCOGSPrice],[PerDeviceDispensingFee] 
     FROM INSURANCE.CONTRACTPRODUCTS) P ON O.TECHNOLOGYLEVELCODE = P.FAMILYPRODUCTCODE AND P.HealthPlanContractId = B.HealthPlanContractId

INNER JOIN [Master].[Members] DS WITH (NOLOCK) ON DS.[NHMemberID] = O.NHMemberID AND DS.IsActive=1

WHERE 
O.IsActive=1 
AND O.Status <> 'ALAN'


CREATE VIEW [ReportsData].[5_MarketShare]
AS

SELECT 
	O.ORDERID, O.NHMEMBERID, O.BRANDCODE, O.TECHNOLOGYLEVELCODE, UPPER(P.FAMILYPRODUCTCATCODE) CATEGORY, O.DEVICECOUNT
	,CAST(O.DATEORDERRECEIVED AS DATE) ORDERRECEIVEDDATE, CAST(O.DATEORDERINITIATED AS DATE) ORDERINITIATEDDATE,JSON_VALUE(OT.ORDERTRANSACTIONDATA,'$.approvedDate') ORDERAPPROVEDDATE
	, case  when UPPER(JSON_VALUE(O.MEMBERDATA, '$.insurance.programeName')) <>'' then  UPPER(JSON_VALUE(O.MEMBERDATA, '$.insurance.programeName'))
	  else UPPER(JSON_VALUE(O.MEMBERDATA, '$.insurance.carrierName')) end CARRIERNAME
	--,JSON_VALUE(O.MEMBERDATA, '$.insCarrierId') CARRIERID
	--,UPPER(I.INSURANCECARRIERNAME) REFERENCECARRIERNAME
FROM 
	ORDERS.ORDERS O
INNER JOIN
	ORDERS.ORDERTRANSACTIONDETAILS OT
	ON 
		O.ORDERID = OT.ORDERID
LEFT JOIN 
	(
		SELECT X.* 
		FROM 
		(
			SELECT FAMILYPRODUCTCATCODE, FAMILYPRODUCTCODE,
				ROW_NUMBER() OVER(PARTITION BY FAMILYPRODUCTCODE ORDER BY CONTRACTPRODUCTID DESC) RN
			FROM INSURANCE.CONTRACTPRODUCTS
		)X 
		WHERE X.RN = 1
	) P
	ON
		O.TECHNOLOGYLEVELCODE = P.FAMILYPRODUCTCODE
--INNER JOIN 
--	INSURANCE.INSURANCECARRIERS I
--	ON I.INSURANCECARRIERID = JSON_VALUE(O.MEMBERDATA, '$.insCarrierId')
WHERE O.MEMBERDATA <>'' 
	AND OT.ORDERSTATUSCODE = 'APP' AND OT.ISCOMPLETE = 1




CREATE VIEW [ReportsData].[RajVOld]
AS

SELECT  
   --     (case when O.Status = 'ALAN' then 'BAD'
		 --else 'GOOD'
		 --end) as 'Record',
        o.NHMemberID,
		o.orderid AS 'OrderNumber',
		o.orderSource AS 'OrderSource',
		DS.DataSource AS 'EligSource',
		CONVERT(VARCHAR(10), o.[DateOrderReceived],101) AS 'OrderRcvdDate',
		CONVERT(VARCHAR(10), o.[DateOrderInitiated],101) AS 'OrderCreatedDate',
		o.[OrderType],
        (CASE WHEN o.[OrderType] IN ('EXCHANGE','LSRD') THEN o.[OrderType] +'( of order:' +o.[RefOrderId] + ')'
		 ELSE o.[OrderType]
		 END) 'OrderRef',
		o.[Status],
	    (CASE WHEN JSON_VALUE(O.MEMBERDATA, '$.insurance.carrierName') = 'None' OR 
		           JSON_VALUE(O.MEMBERDATA, '$.insurance.carrierName') = '' THEN 
		     JSON_VALUE(O.MEMBERDATA, '$.insurance.programeName')
			 ELSE JSON_VALUE(O.MEMBERDATA, '$.insurance.carrierName')
	    END) AS 'Carrier',
		JSON_VALUE(O.MEMBERDATA, '$.insurance.planName') AS 'Plan',
		JSON_VALUE([MemberData],'$.firstName') AS [MemberFirstName],
		JSON_VALUE([MemberData],'$.lastName') AS [MemberLastName],
		JSON_VALUE([ProviderData],'$.providerId') AS [ProviderID],
		JSON_VALUE([ProviderData],'$.providerLeagalBusinessName') AS [ProviderLegalName],	
		JSON_VALUE([ProviderData],'$.dba') AS [ProviderDBA],
		JSON_VALUE([ProviderData],'$.dispenser') AS [ProviderDispenser],
		JSON_VALUE([ProviderData],'$.address.address') AS [ProviderAddress],
		JSON_VALUE([ProviderData],'$.address.city') AS [ProviderCity], 
		JSON_VALUE([ProviderData],'$.address.state') AS [ProviderState],
		JSON_VALUE([ProviderData],'$.address.zip') AS [ProviderZip],
		JSON_VALUE([ShippingData],'$.dba') AS [ShippingDBA],
		JSON_VALUE([ShippingData],'$.dispenser') AS [ShippingDispenser],
		[BrandCode] AS [Manufacturer] ,
		[FamilyCode] AS [Family],
		[TechnologyLevelCode] [Product],
		P.FAMILYPRODUCTCATCODE [TechnologyLevel],
		[DeviceCount] AS 'Qty', 
		P.[PerDeviceCOGSPrice] AS 'COGS',
		P.[PerDeviceCOGSPrice] * [DeviceCount] AS 'TotalCOGS',
		(CASE WHEN CAST(JSON_VALUE([OrderAmountData],'$.insuranceBenefit') AS NVARCHAR(10)) IS NULL THEN 0 
		 ELSE CAST(JSON_VALUE([OrderAmountData],'$.insuranceBenefit') AS DECIMAL)
		 END) [BenefitAmount],
		(CASE WHEN CAST(JSON_VALUE([OrderAmountData],'$.productPrice') AS NVARCHAR(10)) IS NULL THEN 0 
		 ELSE CAST(JSON_VALUE([OrderAmountData],'$.productPrice') AS DECIMAL)
		 END) AS [ProductPrice],
		--JSON_VALUE([OrderAmountData],'$.benefitUsed') AS [Benefit Used],
		(CASE WHEN CAST(JSON_VALUE([OrderAmountData],'$.benefitAvailable') AS NVARCHAR(10)) IS NULL THEN 0
		 ELSE CAST(JSON_VALUE([OrderAmountData],'$.benefitAvailable') AS DECIMAL)
		 END) AS [BenefitAvailable],
		 (CASE WHEN CAST(JSON_VALUE([OrderAmountData],'$.adjustments') AS NVARCHAR(10)) IS NULL THEN 0 
		 ELSE CAST(JSON_VALUE([OrderAmountData],'$.adjustments') AS DECIMAL)
		 END) AS [AdjustmentAmount],
		(CASE WHEN CAST(JSON_VALUE([OrderAmountData],'$.memberResponsibility') AS NVARCHAR(10)) IS NULL THEN 0 
		 ELSE CAST(JSON_VALUE([OrderAmountData],'$.memberResponsibility') AS DECIMAL)
		 END) AS [MemberResponsibleAmount],
		(CASE WHEN CAST(PAY.[PaymentAmount1] AS DECIMAL) + CAST(PAY.[PaymentAmount2] AS DECIMAL) + CAST(PAY.[PaymentAmount3] AS DECIMAL) IS NULL THEN 0 
		      ELSE CAST(PAY.[PaymentAmount1] AS DECIMAL) + CAST(PAY.[PaymentAmount2] AS DECIMAL) + CAST(PAY.[PaymentAmount3] AS DECIMAL)
		 END) 'MemberPayment',
		(CASE WHEN CONVERT(VARCHAR(10), PO.[PO DATE],101) IS NULL THEN '' 
		      ELSE CONVERT(VARCHAR(10), PO.[PO DATE],101) 
		 END) AS 'PODate',
		(CASE WHEN PO.PONumber IS NULL THEN ''
		  ELSE PO.PONumber
		 END) AS 'PONumber',
		(CASE WHEN CLM.[Fitting Date] IS NULL THEN '' 
		      ELSE CLM.[Fitting Date]
	     END) AS 'FittingDate' ,
		(CASE WHEN CLM.[PurchaseDate] IS NULL THEN '' 
		 ELSE CLM.[PurchaseDate]
		 END) AS 'PurchaseAgreementDate', 
		 (CASE WHEN CLM.[DeliveryDate] IS NULL THEN '' 
		 ELSE CLM.[DeliveryDate]
		 END) AS 'DeliveryRcptDate', 
		 (CASE WHEN   CONVERT(VARCHAR(10), RET.[Return Date],101) IS NULL THEN '' ELSE
		      CONVERT(VARCHAR(10), RET.[Return Date] ,101)
		  END) AS 'ReturnDate',
		(CASE WHEN CLM.[Claim Required] IS NULL THEN '' ELSE
		      CLM.[Claim Required]
		  END) AS 'ClaimRequired',
		P.[PerDeviceDispensingFee] [FittingFeePerDevice],
		(P.[PerDeviceDispensingFee] * [DeviceCount]) AS 'TotalFittingFee',
		(CASE WHEN CAST(CLM.[ClaimAmount] AS NVARCHAR(10)) IS NULL THEN '0' 
		      ELSE CAST(CLM.[ClaimAmount] AS NVARCHAR(10))
		 END) 'ClaimAmount',
		JSON_VALUE(O.MEMBERDATA, '$.insurance.carrierName') + ':' + JSON_VALUE([MemberData],'$.firstName') + ' ' +JSON_VALUE([MemberData],'$.lastName') AS 'QBJobName'
FROM
Orders.Orders_old O WITH (NOLOCK)

LEFT OUTER JOIN
(
SELECT ORDERID,[OrderTransactionData],
			(CASE WHEN CONVERT(VARCHAR(10),JSON_VALUE([OrderTransactionData],'$.fittingDate'),101)  = '01/01/0001' THEN ''
			      WHEN CONVERT(VARCHAR(10),JSON_VALUE([OrderTransactionData],'$.fittingDate'),101) IS NULL THEN ''
			 ELSE CONVERT(VARCHAR(10),JSON_VALUE([OrderTransactionData],'$.fittingDate'),101)
			 END)  AS [Fitting Date],
            JSON_VALUE([OrderTransactionData],'$.purchaseAgreementReceived') AS [PurchaseAgreementRcvd],
			(CASE WHEN CONVERT(VARCHAR(10),JSON_VALUE([OrderTransactionData],'$.purchaseDate'),101) IS NULL THEN '' 
			 ELSE CONVERT(VARCHAR(10),JSON_VALUE([OrderTransactionData],'$.purchaseDate'),101) 
			 END) AS [PurchaseDate],
			 JSON_VALUE([OrderTransactionData],'$.deliveryReceipt') AS [DeliveryReceiptRcvd],
			(CASE WHEN CONVERT(VARCHAR(10),JSON_VALUE([OrderTransactionData],'$.deliveryDate'),101) IS NULL THEN '' 
			 ELSE CONVERT(VARCHAR(10),JSON_VALUE([OrderTransactionData],'$.deliveryDate'),101) 
			 END) AS [DeliveryDate],
			JSON_VALUE([OrderTransactionData],'$.isClaimSubmitted') AS [Claim Required],
			--JSON_VALUE([OrderTransactionData],'$.copayDues.hfCopayDue') AS [Fitting Fee],
			(CASE WHEN JSON_VALUE([OrderTransactionData],'$.claimAmount') IS NULL THEN '0'
			 ELSE JSON_VALUE([OrderTransactionData],'$.claimAmount') 
			 END) AS [ClaimAmount]
FROM 
	[Orders].[OrderTransactionDetails] OD1 WITH (NOLOCK)
	WHERE OD1.OrderStatusCode='CLM' AND IsActive=1
)CLM ON (O.ORDERID = CLM.ORDERID)
LEFT OUTER JOIN
(
SELECT CAST(JSON_VALUE(Ordertransactiondata,'$.returnDt') AS DATE) [Return Date],ORDERID
FROM 
	[Orders].[OrderTransactionDetails] OD1 WITH (NOLOCK)
	WHERE OD1.OrderStatusCode='RET' AND IsActive=1
)RET ON (O.ORDERID = RET.ORDERID)
LEFT OUTER JOIN
(
SELECT  ORDERID,
--JSON_VALUE([OrderTransactionData],'$.transactions[0].paymentDate') [Transaction Date],
--JSON_VALUE([OrderTransactionData],'$.transactions[0].paymentType')[paymentType],
(CASE 
     WHEN JSON_VALUE([OrderTransactionData],'$.transactions[0].amountPaid') IS NULL THEN 0
	 ELSE CAST(JSON_VALUE([OrderTransactionData],'$.transactions[0].amountPaid')  AS DECIMAL)
END) [PaymentAmount1],
(CASE 
     WHEN JSON_VALUE([OrderTransactionData],'$.transactions[1].amountPaid') IS NULL THEN 0
	 ELSE CAST(JSON_VALUE([OrderTransactionData],'$.transactions[1].amountPaid') AS DECIMAL)
END) [PaymentAmount2],
(CASE 
     WHEN JSON_VALUE([OrderTransactionData],'$.transactions[2].amountPaid') IS NULL THEN 0
	 ELSE CAST(JSON_VALUE([OrderTransactionData],'$.transactions[2].amountPaid') AS DECIMAL)
END) [PaymentAmount3],
(CASE 
     WHEN JSON_VALUE([OrderTransactionData],'$.transactions[3].amountPaid') IS NULL THEN 0
	 ELSE CAST(JSON_VALUE([OrderTransactionData],'$.transactions[3].amountPaid') AS DECIMAL)
END) [PaymentAmount4]
--JSON_VALUE([OrderTransactionData],'$.transactions[0].cardOrBank') [cardOrBank],
--JSON_VALUE([OrderTransactionData],'$.transactions[0].formInputDetails.financeCompany') [financeCompany]
FROM
[Orders].[OrderTransactionDetails] OD3 WITH (NOLOCK)
	 WHERE OD3.OrderStatusCode='PAY' AND IsActive=1
)PAY ON (O.ORDERID = PAY.ORDERID) 
LEFT OUTER JOIN
(
SELECT ORDERID,
	JSON_VALUE(od4.[OrderTransactionData],'$.poDate') AS [PO DATE], JSON_VALUE(od4.[OrderTransactionData],'$.poNumber') AS PONumber
FROM	[Orders].[OrderTransactionDetails] OD4 WITH (NOLOCK)
 WHERE OD4.OrderStatusCode='PO' AND IsActive=1
 )PO
 	ON (O.ORDERID = PO.ORDERID) 

LEFT OUTER JOIN Insurance.HealthPlanContracts B ON B.InsuranceHealthPlanID = JSON_VALUE(O.MEMBERDATA, '$.insPlanId')
LEFT OUTER JOIN (SELECT DISTINCT FAMILYPRODUCTCATCODE, FAMILYPRODUCTCODE, HealthPlanContractID, [PerDeviceCOGSPrice],[PerDeviceDispensingFee] 
     FROM INSURANCE.CONTRACTPRODUCTS) P ON O.TECHNOLOGYLEVELCODE = P.FAMILYPRODUCTCODE AND P.HealthPlanContractId = B.HealthPlanContractId

INNER JOIN [Master].[Members] DS WITH (NOLOCK) ON DS.[NHMemberID] = O.NHMemberID AND DS.IsActive=1

WHERE 
O.IsActive=1 
AND O.Status <> 'ALAN'

CREATE  VIEW [ReportsData].[3_AllApprovedOrderDetails]
AS
SELECT  o.NHMemberID,o.orderid,
case when UPPER(JSON_VALUE(O.MEMBERDATA, '$.insurance.programeName')) <>'' then  UPPER(JSON_VALUE(O.MEMBERDATA, '$.insurance.programeName'))
	 else UPPER(JSON_VALUE(O.MEMBERDATA, '$.insurance.carrierName')) end REFERENCECARRIERNAME, 
		JSON_VALUE([MemberData],'$.firstName') + ' ' +JSON_VALUE([MemberData],'$.lastName') AS [FULL NAME],
		JSON_VALUE([MemberData],'$.address.state') AS [STATE],
		JSON_VALUE([ProviderData],'$.dispenser') AS [DISPENSING NUMBER],
		JSON_VALUE([ProviderData],'$.providerLeagalBusinessName') AS [Provider Legal Name],	
		JSON_VALUE([ProviderData],'$.address.address') AS [Provider Address],
		JSON_VALUE([ProviderData],'$.address.city') AS [Provider City], 
		JSON_VALUE([ProviderData],'$.address.state') AS [Provider State],
		JSON_VALUE([ProviderData],'$.address.zip') AS [Provider Zip Code],
		[BrandCode] As [Manufacturer] ,[FamilyCode] As [Product Family],
		 P.FAMILYPRODUCTCATCODE [Technology],
		[TechnologyLevelCode],[DeviceCount], P.[PerDeviceCOGSPrice] COGS,
		JSON_VALUE([OrderAmountData],'$.insuranceBenefit') AS [Benefit Amount],
		JSON_VALUE([OrderAmountData],'$.productPrice') AS [Product Price],
		JSON_VALUE([OrderAmountData],'$.benefitUsed') AS [Benefit Used],
		JSON_VALUE([OrderAmountData],'$.benefitAvailable') AS [Benefit Available],
		JSON_VALUE([OrderAmountData],'$.memberResponsibility') AS [Member Responsible Amount],
		PO.[PO DATE], PO.PONumber,CLM.[Fitting Date],CLM.[Fitting Documents Received Date], CLM.[Claim Required],P.[PerDeviceDispensingFee] [Fitting Fee],
		 CLM.[Claim Amount],PAY.[Payment Date],PAY.[Payment Method] , PAY.[Payment Amount]

from
Orders.Orders O

LEFT JOIN
(
SELECT ORDERID,
			JSON_VALUE([OrderTransactionData],'$.fittingDate') AS [Fitting Date],
			JSON_VALUE([OrderTransactionData],'$.purchaseDate') AS [Fitting Documents Received Date],
			JSON_VALUE([OrderTransactionData],'$.isClaimSubmitted') AS [Claim Required],JSON_VALUE([OrderTransactionData],'$.copayDues.hfCopayDue') AS [Fitting Fee],
			JSON_VALUE([OrderTransactionData],'$.claimAmount') AS [Claim Amount]
FROM 
	[Orders].[OrderTransactionDetails] OD1 
	where OD1.OrderStatusCode='CLM'
)CLM ON (O.ORDERID = CLM.ORDERID)

LEFT JOIN
(
SELECT  ORDERID,
JSON_VALUE([OrderTransactionData],'$.transactions[0].paymentDate') [Payment Date],JSON_VALUE([OrderTransactionData],'$.transactions[0].paymentType')[Payment Method] ,
							JSON_VALUE([OrderTransactionData],'$.transactions[0].amountPaid') [Payment Amount]
from
[Orders].[OrderTransactionDetails] OD3
	 where OD3.OrderStatusCode='PAY'
)PAY ON (O.ORDERID = PAY.ORDERID) 
LEFT JOIN
(
SELECT ORDERID,
	JSON_VALUE(od4.[OrderTransactionData],'$.poDate') AS [PO DATE], JSON_VALUE(od4.[OrderTransactionData],'$.poNumber') AS PONumber
from	[Orders].[OrderTransactionDetails] OD4
 where OD4.OrderStatusCode='PO'
 )PO
 	ON (O.ORDERID = PO.ORDERID)

LEFT OUTER JOIN Insurance.HealthPlanContracts B ON B.InsuranceHealthPlanID = JSON_VALUE(O.MEMBERDATA, '$.insPlanId')
LEFT OUTER JOIN (select FAMILYPRODUCTCATCODE, FAMILYPRODUCTCODE, HealthPlanContractID, [PerDeviceCOGSPrice],[PerDeviceDispensingFee] from INSURANCE.CONTRACTPRODUCTS) P ON O.TECHNOLOGYLEVELCODE = P.FAMILYPRODUCTCODE AND P.HealthPlanContractId = B.HealthPlanContractId

where [MemberData] is not null and [MemberData] <>''
and [ProviderData] is not null and [ProviderData] <>''


-- =================================================================================
-- Create View template for Azure SQL Database and Azure SQL Data Warehouse Database
-- =================================================================================

CREATE VIEW [ReportsData].[7_viewAccountingNEW_TEST]
AS
SELECT  NHMemberID, OrderNumber,OrderSource, EligSource,OrderRcvdDate, OrderCreatedDate, OrderType,
OrderRef,
Status,
Carrier, [Plan], MemberFirstName,
                           MemberLastName,ProviderID,ProviderLegalName,ProviderDBA, ProviderDispenser, ProviderAddress, ProviderCity,
                           ProviderState, ProviderZip, ShippingDBA, ShippingDispenser, Manufacturer, Family,Product,TechnologyLevel,
                           Qty,
						   COGS, 
						   TotalCOGS ,
						   BenefitAmount,ProductPrice,BenefitAvailable,AdjustmentAmount, MemberResponsibleAmount,
						   [ItemTotal],[exchangeCredit],
                           MemberPayment, PODate, PONumber,FittingDate, PurchaseAgreementDate,DeliveryRcptDate, ReturnDate, ClaimRequired,
                           FittingFeePerDevice, 
						   TotalFittingFee, 
						   ClaimAmount,QBJobName
       FROM (
                     SELECT       o.NHMemberID,
                                         o.orderid AS 'OrderNumber',
                                  --     OI.ItemType,
                                         --OI.orderSource as 'OrderSource',(OLD) RR
                                         O.Source AS 'OrderSource',
                                         DS.DataSource AS 'EligSource',
                                         CONVERT(VARCHAR(10), o.[DateOrderReceived],101) AS 'OrderRcvdDate',
                                         CONVERT(VARCHAR(10), o.[DateOrderInitiated],101) AS 'OrderCreatedDate',
                                         o.[OrderType],
                                         (CASE WHEN o.[OrderType] IN ('EXCHANGE','LSRD') 
                                                       THEN o.[OrderType] +'( of order:' + CAST(o.[RefOrderId] AS NVARCHAR(10)) + ')' ------RR Converted RefOrderId to Nvarchar--------------------
                                                              ELSE o.[OrderType]
                                                              END) 'OrderRef',
                                         o.[Status],
                                         (CASE WHEN JSON_VALUE(O.MEMBERDATA, '$.insurance.carrierName') = 'None' OR JSON_VALUE(O.MEMBERDATA, '$.insurance.carrierName') = '' 
                                                       THEN 
                                                              JSON_VALUE(O.MEMBERDATA, '$.insurance.programeName')
                                                       ELSE JSON_VALUE(O.MEMBERDATA, '$.insurance.carrierName')
                                                       END) AS 'Carrier',
                                         JSON_VALUE(O.MEMBERDATA, '$.insurance.planName') AS 'Plan',
                                         JSON_VALUE([MemberData],'$.firstName') AS [MemberFirstName],
                                         JSON_VALUE([MemberData],'$.lastName') AS [MemberLastName],
                                         JSON_VALUE([ProviderData],'$.providerId') AS [ProviderID],
                                         JSON_VALUE([ProviderData],'$.providerLeagalBusinessName') AS [ProviderLegalName], 
                                         JSON_VALUE([ProviderData],'$.dba') AS [ProviderDBA],
                                         JSON_VALUE([ProviderData],'$.dispenser') AS [ProviderDispenser],
                                         JSON_VALUE([ProviderData],'$.address.address') AS [ProviderAddress],
                                         JSON_VALUE([ProviderData],'$.address.city') AS [ProviderCity], 
                                         JSON_VALUE([ProviderData],'$.address.state') AS [ProviderState],
                                         JSON_VALUE([ProviderData],'$.address.zip') AS [ProviderZip],
                                         JSON_VALUE([ShippingData],'$.dba') AS [ShippingDBA],
                                         JSON_VALUE([ShippingData],'$.dispenser') AS [ShippingDispenser],
                                         OI.BrandCode AS [Manufacturer] ,
                                         OI.FamilyCode AS [Family],
                                         OI.TechnologyLevelCode [Product],
                                         P.FAMILYPRODUCTCATCODE [TechnologyLevel],
                                         --[DeviceCount] as 'Qty', (old) RR
                                         --(SELECT SUM(Quantity) FROM Orders.OrderItems OI1 WHERE  OI1.OrderID=OI.OrderID
                                         --GROUP BY Quantity) AS 'Qty',
                                         nn.Quantity AS 'Qty',
                                         P.[PerDeviceCOGSPrice] AS 'COGS',
                                         --P.[PerDeviceCOGSPrice] * [DeviceCount] as 'TotalCOGS', (OLD) RR
                                         (P.[PerDeviceCOGSPrice] * nn.[Quantity]) AS 'TotalCOGS',
                                         (CASE WHEN CAST(JSON_VALUE([OrderAmountData],'$.insuranceBenefit') AS NVARCHAR(10)) IS NULL THEN 0 
                                                              WHEN CAST(JSON_VALUE([OrderAmountData],'$.insuranceBenefit') AS NVARCHAR(10)) ='NA' THEN 0 ---RR A NEW Condition added.
                                                              ELSE CAST(JSON_VALUE([OrderAmountData],'$.insuranceBenefit') AS DECIMAL)
                                         END) [BenefitAmount],
                                         (CASE WHEN CAST(JSON_VALUE([OrderAmountData],'$.productPrice') AS NVARCHAR(10)) IS NULL THEN 0 
                                          ELSE CAST(JSON_VALUE([OrderAmountData],'$.productPrice') AS DECIMAL)
                                         END) AS [ProductPrice],
                                         (CASE WHEN CAST(JSON_VALUE([OrderAmountData],'$.benefitAvailable') AS NVARCHAR(10)) IS NULL THEN 0
                                                  WHEN CAST(JSON_VALUE([OrderAmountData],'$.benefitAvailable') AS NVARCHAR(10)) ='NA' THEN 0 --- RR A NEW Condition added.
                                                       ELSE CAST(JSON_VALUE([OrderAmountData],'$.benefitAvailable') AS DECIMAL)
                                                END) AS [BenefitAvailable],
                                         (CASE WHEN CAST(JSON_VALUE([OrderAmountData],'$.adjustments') AS NVARCHAR(10)) IS NULL THEN 0 
                                                       ELSE CAST(JSON_VALUE([OrderAmountData],'$.adjustments') AS DECIMAL)
                                                END) AS [AdjustmentAmount],
                                         (CASE WHEN CAST(JSON_VALUE([OrderAmountData],'$.memberResponsibility') AS NVARCHAR(10)) IS NULL THEN 0 
                                                       ELSE CAST(JSON_VALUE([OrderAmountData],'$.memberResponsibility') AS DECIMAL)
                                         END) AS [MemberResponsibleAmount],
										 (CASE WHEN CAST(JSON_VALUE([OrderAmountData],'$.itemsTotal') AS NVARCHAR(10)) IS NULL THEN 0 
                                                       ELSE CAST(JSON_VALUE([OrderAmountData],'$.itemsTotal') AS DECIMAL)
                                         END) AS [ItemTotal],
										 (CASE WHEN CAST(JSON_VALUE([OrderAmountData],'$.exchangeCredit') AS NVARCHAR(10)) IS NULL THEN 0 
                                                       ELSE CAST(JSON_VALUE([OrderAmountData],'$.exchangeCredit') AS DECIMAL)
                                         END) AS [exchangeCredit],

                                         (CASE WHEN CAST(PAY.[PaymentAmount1] AS DECIMAL) + CAST(PAY.[PaymentAmount2] AS DECIMAL) + CAST(PAY.[PaymentAmount3] AS DECIMAL) IS NULL THEN 0 
                                                  ELSE CAST(PAY.[PaymentAmount1] AS DECIMAL) + CAST(PAY.[PaymentAmount2] AS DECIMAL) + CAST(PAY.[PaymentAmount3] AS DECIMAL)
                                         END) 'MemberPayment',
                                         (CASE WHEN CONVERT(VARCHAR(10), PO.[PO DATE],101) IS NULL THEN '' 
                                                  ELSE CONVERT(VARCHAR(10), PO.[PO DATE],101) 
                                          END) AS 'PODate',
                                         (CASE WHEN PO.PONumber IS NULL THEN ''
                                           ELSE PO.PONumber
                                         END) AS 'PONumber',
                                         (CASE WHEN CLM.[Fitting Date] IS NULL THEN '' 
                                                  ELSE CLM.[Fitting Date]
                                         END) AS 'FittingDate' ,
                                         (CASE WHEN CLM.[PurchaseDate] IS NULL THEN '' 
                                          ELSE CLM.[PurchaseDate]
                                         END) AS 'PurchaseAgreementDate', 
                                          (CASE WHEN CLM.[DeliveryDate] IS NULL THEN '' 
                                          ELSE CLM.[DeliveryDate]
                                         END) AS 'DeliveryRcptDate', 
                                          (CASE WHEN   CONVERT(VARCHAR(10), RET.[Return Date],101) IS NULL THEN '' ELSE
                                                  CONVERT(VARCHAR(10), RET.[Return Date] ,101)
                                           END) AS 'ReturnDate',
                                         (CASE WHEN CLM.[Claim Required] IS NULL THEN '' ELSE
                                                  CLM.[Claim Required]
                                           END) AS 'ClaimRequired',
                                         P.[PerDeviceDispensingFee] [FittingFeePerDevice],
                                         --(P.[PerDeviceDispensingFee] * [DeviceCount]) as 'TotalFittingFee',--(OLD) RR
                                         (P.[PerDeviceDispensingFee] *  nn.[Quantity]) AS 'TotalFittingFee',
                                         (CASE WHEN CAST(CLM.[ClaimAmount] AS NVARCHAR(10)) IS NULL THEN '0' 
                                                  ELSE CAST(CLM.[ClaimAmount] AS NVARCHAR(10))
                                         END) 'ClaimAmount',
                                         JSON_VALUE(O.MEMBERDATA, '$.insurance.carrierName') + ':' + JSON_VALUE([MemberData],'$.firstName') + ' ' +JSON_VALUE([MemberData],'$.lastName') AS 'QBJobName'
                                  FROM

                                  Orders.Orders O WITH (NOLOCK)

                                  -----RR Included Orders.OrderItems table to get TECHNOLOGYLEVELCODE,BrandCode,FamilyCode,DeviceCount

                                  LEFT OUTER JOIN
                                  Orders.OrderItems OI ON (OI.OrderID=O.OrderID and itemtype in ('HA'))
								  LEFT OUTER JOIN (select orderid, sum(quantity) Quantity from orders.orderItems where itemtype in ('HA','CROS') group by orderid) nn
								  on (nn.orderid = O.orderid)
                                  LEFT OUTER JOIN
                                  (
                                  SELECT ORDERID,[OrderTransactionData],
                                                (CASE WHEN CONVERT(VARCHAR(10),JSON_VALUE([OrderTransactionData],'$.fittingDate'),101)  = '01/01/0001' THEN ''
                                                         WHEN CONVERT(VARCHAR(10),JSON_VALUE([OrderTransactionData],'$.fittingDate'),101) IS NULL THEN ''
                                                ELSE CONVERT(VARCHAR(10),JSON_VALUE([OrderTransactionData],'$.fittingDate'),101)
                                                END)  AS [Fitting Date],
                                                JSON_VALUE([OrderTransactionData],'$.purchaseAgreementReceived') AS [PurchaseAgreementRcvd],
                                                (CASE WHEN CONVERT(VARCHAR(10),JSON_VALUE([OrderTransactionData],'$.purchaseDate'),101) IS NULL THEN '' 
                                                 ELSE CONVERT(VARCHAR(10),JSON_VALUE([OrderTransactionData],'$.purchaseDate'),101) 
                                                 END) AS [PurchaseDate],
                                                JSON_VALUE([OrderTransactionData],'$.deliveryReceipt') AS [DeliveryReceiptRcvd],
                                                (CASE WHEN CONVERT(VARCHAR(10),JSON_VALUE([OrderTransactionData],'$.deliveryDate'),101) IS NULL THEN '' 
                                                 ELSE CONVERT(VARCHAR(10),JSON_VALUE([OrderTransactionData],'$.deliveryDate'),101) 
                                                 END) AS [DeliveryDate],
                                                JSON_VALUE([OrderTransactionData],'$.isClaimSubmitted') AS [Claim Required],
                                                --JSON_VALUE([OrderTransactionData],'$.copayDues.hfCopayDue') AS [Fitting Fee],
                                                (CASE WHEN JSON_VALUE([OrderTransactionData],'$.claimAmount') IS NULL THEN '0'
                                                ELSE JSON_VALUE([OrderTransactionData],'$.claimAmount') 
                                                 END) AS [ClaimAmount]
                                         FROM 
                                                [Orders].[OrderTransactionDetails] OD1 WITH (NOLOCK)
                                                WHERE OD1.OrderStatusCode='CLM' AND IsActive=1
                                         )CLM ON (O.ORDERID = CLM.ORDERID)
                                  LEFT OUTER JOIN
                                  (
                                  SELECT CAST(JSON_VALUE(Ordertransactiondata,'$.returnDt') AS DATE) [Return Date],ORDERID
                                  FROM 
                                  [Orders].[OrderTransactionDetails] OD1 WITH (NOLOCK)
                                  WHERE OD1.OrderStatusCode='RET' AND IsActive=1
                                  )RET ON (O.ORDERID = RET.ORDERID)
                                  LEFT OUTER JOIN
                                  (
                                  SELECT  ORDERID,
                                  (CASE 
                                         WHEN OrderTransactionData='' THEN 0
                                                WHEN JSON_VALUE([OrderTransactionData],'$.transactions[0].amountPaid') IS NULL THEN 0
                                                       ELSE CAST(JSON_VALUE([OrderTransactionData],'$.transactions[0].amountPaid')  AS DECIMAL)
                                                END) [PaymentAmount1],
                                  (CASE 
                                         WHEN OrderTransactionData='' THEN 0
                                         WHEN JSON_VALUE([OrderTransactionData],'$.transactions[1].amountPaid') IS NULL THEN 0
                                                ELSE CAST(JSON_VALUE([OrderTransactionData],'$.transactions[1].amountPaid') AS DECIMAL)
                                         END) [PaymentAmount2],
                                  (CASE 
                                          WHEN OrderTransactionData='' THEN 0
                                                WHEN JSON_VALUE([OrderTransactionData],'$.transactions[2].amountPaid') IS NULL THEN 0
                                                       ELSE CAST(JSON_VALUE([OrderTransactionData],'$.transactions[2].amountPaid') AS DECIMAL)
                                                       END) [PaymentAmount3],
                                  (CASE 
                                          WHEN OrderTransactionData='' THEN 0
                                                WHEN JSON_VALUE([OrderTransactionData],'$.transactions[3].amountPaid') IS NULL THEN 0
                                                       ELSE CAST(JSON_VALUE([OrderTransactionData],'$.transactions[3].amountPaid') AS DECIMAL)
                                  END) [PaymentAmount4]
                                  FROM
                                  [Orders].[OrderTransactionDetails] OD3 WITH (NOLOCK)
                                         WHERE OD3.OrderStatusCode='PAY' AND IsActive=1
                                  )PAY ON (O.ORDERID = PAY.ORDERID) 
                                  LEFT OUTER JOIN
                                  (
                                         SELECT ORDERID,
                                         JSON_VALUE(od4.[OrderTransactionData],'$.poDate') AS [PO DATE], JSON_VALUE(od4.[OrderTransactionData],'$.poNumber') AS PONumber
                                         FROM   [Orders].[OrderTransactionDetails] OD4 WITH (NOLOCK)
                                         WHERE OD4.OrderStatusCode='PO' AND IsActive=1
                                  )PO ON (O.ORDERID = PO.ORDERID) 

                                  LEFT OUTER JOIN Insurance.HealthPlanContracts B ON B.InsuranceHealthPlanID = JSON_VALUE(O.MEMBERDATA, '$.insPlanId')
                                  LEFT OUTER JOIN 
                                                ( SELECT DISTINCT FAMILYPRODUCTCATCODE, FAMILYPRODUCTCODE, HealthPlanContractID, [PerDeviceCOGSPrice],[PerDeviceDispensingFee] 
                                                       FROM INSURANCE.CONTRACTPRODUCTS) P ON OI.TECHNOLOGYLEVELCODE = P.FAMILYPRODUCTCODE AND P.HealthPlanContractId = B.HealthPlanContractId

                                  INNER JOIN [Master].[Members] DS WITH (NOLOCK) ON DS.[NHMemberID] = O.NHMemberID AND DS.IsActive=1
                           WHERE O.IsActive=1 AND O.Status <> 'ALAN' AND OI.ItemType IN('HA','CROS')
                           --AND o.OrderID=180020514
                           --order BY o.orderid
                           
                            )a
                           /*  GROUP BY 
                            NHMemberID, OrderNumber,a.OrderSource, EligSource,OrderRcvdDate, OrderCreatedDate, OrderType,OrderRef,Status,Carrier, [Plan], MemberFirstName,
                           MemberLastName,ProviderID,ProviderLegalName,ProviderDBA, ProviderDispenser, ProviderAddress, ProviderCity,
                           ProviderState, ProviderZip, ShippingDBA, ShippingDispenser, Manufacturer, Family,Product,TechnologyLevel,
                           COGS, TotalCOGS,BenefitAmount,ProductPrice,BenefitAvailable,AdjustmentAmount, MemberResponsibleAmount,
                           MemberPayment, PODate, PONumber,FittingDate, PurchaseAgreementDate,DeliveryRcptDate, ReturnDate, ClaimRequired,
                           FittingFeePerDevice,TotalFittingFee,QBJobName, ClaimAmount, qty

*/


CREATE VIEW [ReportsData].[1_OrdersWithoutFittingDate]
AS
SELECT 	ORDERS.ORDERS.ORDERID, NHMEMBERID, DATEORDERRECEIVED, DATEORDERINITIATED, BRANDCODE, FAMILYCODE, TECHNOLOGYLEVELCODE, STYLECODE, MODELCODE, 
JSON_VALUE(C.[OrderTransactionData],'$.poDate') as 'PO Date',
JSON_VALUE(C.[OrderTransactionData],'$.poNumber') as 'PO Number'
,JSON_VALUE(B.[OrderTransactionData],'$.fittingDate') as 'FittingDate'
FROM    ORDERS.ORDERS
LEFT OUTER JOIN ORDERS.ORDERTRANSACTIONDETAILS B 
       ON (B.ORDERID = ORDERS.ORDERS.ORDERID AND  B.ORDERSTATUSCODE = 'CLM' AND 
	      (JSON_VALUE(B.[OrderTransactionData],'$.fittingDate') = '' OR JSON_VALUE(B.[OrderTransactionData],'$.fittingDate') = null))
LEFT OUTER JOIN ORDERS.ORDERTRANSACTIONDETAILS C
       ON (C.ORDERID = ORDERS.ORDERS.ORDERID AND  C.ORDERSTATUSCODE = 'PO')
-- =============================================
-- Author:      Micah Elliott
-- Create Date: 9/13/2019
-- Description: Creates a new Provider Owner Account with the given details, and activation link sending to given email, or
-- =============================================
CREATE PROCEDURE [support].[CreateProviderOwnerAccount]
(
    @FirstName varchar(50) = '',
	@LastName varchar(100) = '',
	@ProviderId bigint = NULL,
	@LocationId bigint = NULL,
	@Username varchar(12) = NULL
)
AS
BEGIN
    -- SET NOCOUNT ON added to prevent extra result sets from
    -- interfering with SELECT statements.
    SET NOCOUNT ON

	declare @createuser varchar(100)

	declare @appmoduleroleid bigint
	declare @appmoduleid bigint
	declare @userprofileid bigint
	declare @usergroupid bigint
	declare @usergroupmoduleid bigint
	declare @usergroupmoduleroleid bigint
	declare @appmodulerolemenuid bigint

	declare @output table (id bigint)

	-------------------
	set @createuser = 'NHAdmin'
	-------------------

	-- Get Module
	set @appmoduleid = (select AppModuleId from auth.AppModules where ModuleName = 'Provider Portal')

	-- Get role
	set @appmoduleroleid = (select AppModuleRoleId from auth.AppModuleRoles where AppModuleId = @appmoduleid and AppModuleRoleName = 'Provider Business Owner')

	-- Get Menus for Role
	set @appmodulerolemenuid = (select AppModuleRoleMenuId from auth.AppModuleRoleMenus where AppModuleRoleId = @appmoduleroleid and AppModuleRoleMenuName = 'Home')

	-- Get User Groups for Role
	set @usergroupid = (select UserGroupId from auth.UserGroups where UserGroupName = 'NH-Provider-Owner User Group')

	-- Get usergroup<-->appmodule connection for Role
	set @usergroupmoduleid = (select UserGroupModuleId from auth.UserGroupModules where AppModuleId = @appmoduleid and UserGroupId = @usergroupid)

	-- Get usergroup<-->appmodulerole connection for Role
	set @usergroupmoduleroleid = (select UserGroupModuleRoleId from auth.UserGroupModuleRoles where UserGroupId = @usergroupid and AppModuleRoleId = @appmoduleroleid)

	-- Create new user 
	insert into auth.UserProfiles(FirstName, MiddleName, LastName, IsBlocked, IsEnabled, IsRegister, TemproryKeyCode, UserName, 
		CreateUser, CreateDate, ModifyUser, ModifyDate, IsActive)
	output inserted.UserProfileId into @output
	values (
		@firstname,
		'',
		@lastname,
		0, 1, 0,
		@lastname,
		ISNULL(@Username, LOWER(CONCAT(LEFT(@firstname, 1), @lastname))),
		@createuser, GETDATE(), @createuser, GETDATE(), 1
	)
	set @userprofileid = (select top 1 id from @output)
	delete from @output

	-- Add user group
	insert into auth.UserProfileGroups(UserGroupId, UserProfileId, CreateUser, CreateDate, ModifyUser, ModifyDate, IsActive)
	values (
		@usergroupid,
		@userprofileid,
		@createuser, GETDATE(), @createuser, GETDATE(), 1
	)

	-- Add user settings
	insert into auth.UserProfileSettings(UserProfileId, SettingName, SettingValue, CreateUser, CreateDate, ModifyUser, ModifyDate, IsActive)
	values (
		@userprofileid,
		'Roles',
		'["'+ cast(@appmoduleroleid as varchar) +'"]',
		@createuser, GETDATE(), @createuser, GETDATE(), 1
	)

	if 
		(select count(*) from provider.providerlocations where locationid = @LocationId and IsActive = 1) > 0
		and (select count(*) from provider.providerprofiles where providerid = @ProviderId and IsActive = 1) > 0
		and (select count(*) from provider.locations where locationid = @LocationId and IsActive = 1) > 0
	begin
		insert into provider.providerusers([ProviderId], [UserProfileId], [CreateDate], [CreateUser], [IsActive], [ModifyDate], [ModifyUser])
		values(
			@ProviderId,
			@userprofileid,
			GETDATE(),
			@createuser,
			1,
			GETDATE(),
			@createuser
			)

		insert into provider.provideruserlocations([ProviderId], [LocationId], [UserProfileId], [CreateDate], [CreateUser], [IsActive], [ModifyDate], [ModifyUser])
		values(
			@ProviderId,
			@LocationId,
			@userprofileid,
			GETDATE(),
			@createuser,
			1,
			GETDATE(),
			@createuser
			)

		update auth.userprofiles set ProviderCode = (select ProviderCode from provider.providerprofiles where providerid = @ProviderId and IsActive = 1) where userprofileid = @userprofileid
	end
	else
		begin
			select 'ERROR: Provider or location does not exist or is not active'
			union
			select 'Please check the following tables:'
			union
			select * from (values('provider.locations'), ('provider.providerprofiles'), ('provider.providerlocations')) AS tbl(col1)
		end

	select @userprofileid
END
CREATE PROCEDURE [survey].[GetAdditionalQuestionAndAnswers]
	
AS
BEGIN
	SELECT row_number() over(order by QA.AnswerId) ID, QA.QuestionId, Q.Question, QA.AnswerId, A.Answer,Q.CreateDate,Q.CreateUser,Q.ModifyDate,Q.ModifyUser FROM  
 [survey].[ServeyQuestionsandAnswers] QA  
 inner join [survey].[SurveyQuestions] Q ON QA.QuestionId = Q.QuestionId  
 inner join [survey].[SurveyAnswers] A ON QA.AnswerId = A.AnswerId  
END
CREATE VIEW sys.database_firewall_rules AS SELECT id, name, start_ip_address, end_ip_address, create_date, modify_date FROM sys.database_firewall_rules_table
Create view temp.LocationLanguages as
select 
 ProviderId
,LocationId
,TRIM(Value) Languages
From dbo.ProviderDataLocations
	CROSS APPLY STRING_SPLIT(Languages, ',')
where isnull(languages,'') not in ('N/A','')

-- exec [ult].[ULT_elig_file_load_ssis_sp_merge] 'ELIG_ULT'

CREATE PROCEDURE [ult].[ULT_elig_file_load_ssis_sp_merge] 
@Client_Name varchar(20)
AS


IF @Client_Name = 'ELIG_ULT'

BEGIN

		BEGIN TRY
	    BEGIN TRANSACTION ULT_elig_file_load_ssis

			EXEC [ult].[ULT_elig_file_load_ssis_sp_merge_stg_to_ult]

			EXEC [ult].[ULT_elig_file_load_ssis_sp_merge_ult_to_masters]

		COMMIT TRANSACTION ULT_elig_file_load_ssis

		PRINT 'SUCCESS'
		END TRY

		BEGIN CATCH
		DECLARE @ErrorMessage NVARCHAR(4000);  
		DECLARE @ErrorSeverity INT;  
		DECLARE @ErrorState INT;  

		SELECT   
			@ErrorMessage = ERROR_MESSAGE(),  
			@ErrorSeverity = ERROR_SEVERITY(),  
			@ErrorState = ERROR_STATE();  

		IF (@@TRANCOUNT > 0)
		BEGIN
			ROLLBACK TRANSACTION ULT_elig_file_load_ssis
			RAISERROR(@ErrorMessage,@ErrorSeverity,@ErrorState);
			PRINT 'FAILED'
		END

		END CATCH


END


-- EXEC [ult].[ULT_elig_file_load_ssis_sp_merge_stg_to_ult]

CREATE PROCEDURE [ult].[ULT_elig_file_load_ssis_sp_merge_stg_to_ult]
AS


BEGIN

	--BEGIN TRY
	--BEGIN TRANSACTION ULT_ELIG_MERGE_stg_to_ult




		DECLARE @sys_usr CHAR(30)
		       ,@sys_date DATETIME;  

		SET @sys_usr = SYSTEM_USER
		SET @sys_date = CAST(GETDATE() AT TIME ZONE 'UTC' AT TIME ZONE 'Eastern Standard Time' AS DATETIME);  -- Time in EST

		drop table if exists ult.DataUltMemNewnChanges
		drop table if exists ult.DataUltMemNotRcvd
		drop table if exists ult.DataUltInsNewnChanges
		drop table if exists ult.DataUltInsNotRcvd


		--Members who are new or have changes
		select * 
		into ult.DataUltMemNewnChanges 
		from ult.ViewULTMemNeworChanges 

		create index dataview_idx1 on ult.DataUltMemNewnChanges (NHLinkID) 

--
		select * 
		into ult.DataUltMemNotRcvd 
		from ult.ViewUltMemNotRcvd n 
		where not exists (select 1 from ult.DataUltMemNewnChanges d where d.NHLinkID = n.NHLinkID) 
		
		create index dataview_idx2 on ult.DataUltMemNotRcvd (NHLinkID)
		
		select * 
		into ult.DataUltInsNewnChanges 
		from ult.ViewULTInsNeworChanges

		create index dataview_idx3 on ult.DataUltInsNewnChanges (NHLinkID)

		select * 
		into ult.DataUltInsNotRcvd 
		from ult.ViewUltInsNotRcvd n 
		where not exists (select 1 from ult.DataUltInsNewnChanges d where d.NHLinkID = n.NHLinkID and d.EligibilityEffectiveDate = n.EligibilityEffectiveDate)

		create index dataview_idx4 on ult.DataUltInsNotRcvd (NHLinkID)


			-- Set all records not to be processed
		UPDATE 
		ult.Ultmembers
		SET ToBeProcessed = 'N'	
		where ToBeProcessed = 'Y'	--@@

		UPDATE 
		ult.ultinsurance
		SET ToBeProcessed = 'N'
		where ToBeProcessed = 'Y'

		MERGE ult.Ultmembers m USING ult.DataUltMemNewnChanges d
		ON (m.NHLinkID = d.NHLinkID)
		WHEN MATCHED THEN
		UPDATE SET
		MemberIdentificationNumber = d.MemberIdentificationNumber,
		MemberDateOfBirth = d.MemberDateOfBirth,
		MemberLastName = d.MemberLastName,
		MemberFirstName = d.MemberFirstName,
		MemberMiddleName = d.MemberMiddleName,
		MemberPhoneNumber = d.MemberPhoneNumber,
		MemberAddressLine1 = d.MemberAddressLine1,
		MemberAddressLine2 = d.MemberAddressLine2,
		MemberCityName = d.MemberCityName,
		MemberStateName = d.MemberStateName,
		MemberZipCode = d.MemberZipCode,
		MemberGender = d.MemberGender,
		MemberLanguage = d.Language,
		MemberMailingAddressLine1 = d.MemberMailingAddressLine1,
		MemberMailingAddressLine2 = d.MemberMailingAddressLine2,
		MemberMailingCityName = d.MemberMailingCityName,
		MemberMailingStateName = d.MemberMailingStateName,
		MemberMailingZipCode = d.MemberMailingZipCode,
		statusflag = 'U',
		tobeprocessed = 'Y',
		ModifyDate = @sys_date,
		ModifyUser = @sys_usr
		WHEN NOT MATCHED THEN
		INSERT (
		NHLinkID,
		MemberIdentificationNumber,
		MemberDateOfBirth,
		MemberLastName,
		MemberFirstName,
		MemberMiddleName,
		MemberPhoneNumber,
		MemberAddressLine1,
		MemberAddressLine2,
		MemberCityName,
		MemberStateName,
		MemberZipCode,
		MemberGender,
		MemberLanguage,
		MemberMailingAddressLine1,
		MemberMailingAddressLine2,
		MemberMailingCityName,
		MemberMailingStateName,
		MemberMailingZipCode,
		statusflag,
		tobeprocessed,
		CreateUser,
		ModifyDate,
		ModifyUser)
		VALUES (
		d.NHLinkID,
		d.MemberIdentificationNumber,
		d.MemberDateOfBirth,
		d.MemberLastName,
		d.MemberFirstName,
		d.MemberMiddleName,
		d.MemberPhoneNumber,
		d.MemberAddressLine1,
		d.MemberAddressLine2,
		d.MemberCityName,
		d.MemberStateName,
		d.MemberZipCode,
		d.MemberGender,
		d.Language,
		d.MemberMailingAddressLine1,
		d.MemberMailingAddressLine2,
		d.MemberMailingCityName,
		d.MemberMailingStateName,
		d.MemberMailingZipCode,
		'N',
		'Y',
		@sys_usr, @sys_date, @sys_usr);


		MERGE ult.ultinsurance i USING ult.DataUltInsNewnChanges d
		ON (i.NHLinkID = d.NHLinkID and i.EligibilityEffectiveDate = d.EligibilityEffectiveDate)
		WHEN MATCHED THEN
		UPDATE SET
		[EligibilityTerminationDate] = d.[EligibilityTerminationDate],
		PlanNumber=d.PlanNumber,
		HICN =d.HICN,
		ProductID=d.ProductID,CMS_ContractID=d.CMS_ContractID,
		PBPID=d.PBPID,
		statusflag = 'U',
		tobeprocessed = 'Y',
		ModifyDate = @sys_date,
		ModifyUser = @sys_usr
		WHEN NOT MATCHED THEN
		INSERT (
		NHLinkID,
		MemberIdentificationNumber,
		[EligibilityEffectiveDate],
		[EligibilityTerminationDate],
		PlanNumber,HICN,
		ProductID,CMS_ContractID,PBPID,
		statusflag,
		tobeprocessed,
		CreateUser,
		ModifyDate,
		ModifyUser)
		VALUES (
		d.NHLinkID,
		d.MemberIdentificationNumber,
		 d.EligibilityEffectiveDate,d.EligibilityTerminationDate,d.PlanNumber,d.HICN,
		d.ProductID,d.CMS_ContractID,d.PBPID,
		'N',
		'Y',
		@sys_usr, @sys_date, @sys_usr);


		update  i
		set healthplanid = hp.insurancehealthplanid
		from ult.[ultInsurance]  i
		inner join insurance.insurancehealthplans hp
		on (i.CMS_ContractID + i.PlanNumber = hp.healthplannumber and hp.insurancecarrierid = 14 and hp.healthplannumber is not null)
		where statusflag <> 'E'



		


	--COMMIT TRANSACTION ULT_ELIG_MERGE_stg_to_ult
	--PRINT 'SUCCESS'
	--END TRY

	--BEGIN CATCH
	--DECLARE @ErrorMessage NVARCHAR(4000);  
 --   DECLARE @ErrorSeverity INT;  
 --   DECLARE @ErrorState INT;  

 --   SELECT   
 --       @ErrorMessage = ERROR_MESSAGE(),  
 --       @ErrorSeverity = ERROR_SEVERITY(),  
 --       @ErrorState = ERROR_STATE();  

	--IF (@@TRANCOUNT > 0)
	--BEGIN
	--	ROLLBACK TRANSACTION ULT_ELIG_MERGE_stg_to_ult
	--	RAISERROR(@ErrorMessage,@ErrorSeverity,@ErrorState);
	--	PRINT 'FAILED'
	--END

	--END CATCH

END


-- EXEC [ult].[ULT_elig_file_load_ssis_sp_merge_ult_to_masters]

CREATE PROCEDURE [ult].[ULT_elig_file_load_ssis_sp_merge_ult_to_masters]
AS


BEGIN

	--BEGIN TRY
	--BEGIN TRANSACTION ULT_ELIG_MERGE_ult_to_masters




		DECLARE @sys_usr CHAR(30)
		       ,@sys_date DATETIME;  

		SET @sys_usr = SYSTEM_USER
		SET @sys_date = CAST(GETDATE() AT TIME ZONE 'UTC' AT TIME ZONE 'Eastern Standard Time' AS DATETIME);  -- Time in EST

		-- drop not null record insert constraint (unique index) on NHMemberID in master.members before inserting new members or updating NHMemberID for new records inserted
		ALTER TABLE [otc].[Cards] DROP CONSTRAINT [FK_Cards_NHMemberId]

		ALTER TABLE [Master].[Members] DROP CONSTRAINT [IX_Members_NHMemberID_U]

		merge into master.members d
		using (select * from ult.Ultmembers where tobeprocessed = 'Y') s
		on (d.memberid = s.mastermemberid )
		when matched then 
		update set
		d.EligFile = 'ELIG_ULT',
		d.eligFileID = s.ID,
		d.DateOfBirth = s.MemberDateOfBirth,
		d.FirstName = s.MemberFirstName,
		d.Gender = s.MemberGender,
		d.IsActive = 1,
		d.LastName = s.MemberLastName,
		d.MiddleInitial = s.MemberMiddleName,
		d.ModifyDate = @sys_date,
		d.ModifyUser = @sys_usr
		when not matched then 
		insert ( 
		 CreateDate,
		 CreateUser,
		 DataSource,
		 DateOfBirth,
		 FirstName,
		 Gender,
		 IsActive,
		 LastName,
		 MiddleInitial,
		 ModifyDate,
		 ModifyUser,
		 EligFile,
		 EligFileID) 
		 values 
		 (
		 @sys_date
		,@sys_usr
		,'ELIG_ULT'
		,MemberDateOfBirth
		,MemberFirstName
		,MemberGender
		,1
		,MemberLastName
		,MemberMiddleName
		,@sys_date
		,@sys_usr
		,'ELIG_ULT'
		,ID
		);
			
		
		-- Update NHMemberID for newly inserted members 
		UPDATE [Master].[Members]
		SET nhmemberid = 'NH'+RIGHT(YEAR(GETDATE()),4)+ FORMAT(memberid,'00000000')							 --    'NH2018'+ FORMAT(memberid,'00000000')
		WHERE EligFile = 'ELIG_ULT'
		AND nhmemberid IS NULL


		-- Re create the unique NHMemberID index
		ALTER TABLE [Master].[Members] ADD  CONSTRAINT [IX_Members_NHMemberID_U] UNIQUE NONCLUSTERED 
				(
					[NHMemberID] ASC
				)

		ALTER TABLE [otc].[Cards]  ADD  CONSTRAINT [FK_Cards_NHMemberId] FOREIGN KEY
		(
			[NHMemberId]
		)
		REFERENCES [Master].[Members] ([NHMemberID])

		update a 
		set a.mastermemberid = (select memberid from master.members m where m.EligFileID = a.id and m.EligFile='ELIG_ULT')
		from ult.ULTmembers a
		where 1 = 1
		and a.ToBeProcessed = 'Y'
		and mastermemberid is null

		update i
		set mastermemberid = (select mastermemberid from ult.ULTMembers m where m.NHLinkID = i.NHLinkID )
		from ult.ULTInsurance i
		where exists (select 1 from ult.ULTmembers m1 where m1.NHLinkID = i.NHLinkID)
		and i.ToBeProcessed = 'Y'
		and mastermemberid is null 

		merge master.addresses d
		using (select * from ult.ULTmembers where tobeprocessed = 'Y' and MemberAddressLine1 <> '') s
		on (d.memberid = s.mastermemberid and d.AddressTypeCode = 'PERM')
		when matched then
		update set
		Address1 = s.MemberAddressLine1
		,Address2 = s.MemberAddressLine2
		,City = s.MemberCityName
		,State = s.MemberStateName
		,ZipCode = s.MemberZipCode
		,IsActive = 1
		,IsPreferredAddress = 1
		,MemberID = s.mastermemberid
		,ModifyDate = @sys_date
		, ModifyUser = @sys_usr
		when not matched then 
		insert (
		 Address1
		,Address2
		,AddressTypeCode
		,City
		,State
		,ZipCode
		,EffectiveFromDate
		,EffectiveToDate
		,IsActive
		,IsPreferredAddress
		,MemberID
		,CreateDate
		,CreateUser
		,ModifyDate
		, ModifyUser
		)
		values(
		 s.[MemberAddressLine1]
		,s.[MemberAddressLine2]
		,'PERM'
		,s.[MemberCityName]
		,s.[MemberStateName]
		,s.[MemberZipCode]
		,@sys_date
		,cast('20991231' as date) 
		,1 
		,1 
		,s.[mastermemberid]
		,@sys_date,@sys_usr,@sys_date,@sys_usr);

		merge master.addresses d
		using (select * from ult.ULTmembers where tobeprocessed = 'Y' and MemberMailingAddressLine1 <> '') s
		on (d.memberid = s.mastermemberid and d.AddressTypeCode = 'MAIL')
		when matched then
		update set
		Address1 = s.MemberMailingAddressLine1
		,Address2 = s.MemberMailingAddressLine2
		,City = s.MemberMailingCityName
		,State = s.MemberMailingStateName
		,ZipCode = s.MemberMailingZipCode
		,IsActive = 1
		,MemberID = s.mastermemberid
		,ModifyDate = @sys_date
		, ModifyUser = @sys_usr
		when not matched then 
		insert (
		 Address1
		,Address2
		,AddressTypeCode
		,City
		,State
		,ZipCode
		,EffectiveFromDate
		,EffectiveToDate
		,IsActive
		,IsPreferredAddress
		,MemberID
		,CreateDate
		,CreateUser
		,ModifyDate
		, ModifyUser
		)
		values(
		 s.MemberMailingAddressLine1
		,s.MemberMailingAddressLine2
		,'MAIL'
		,s.MemberMailingCityName
		,s.MemberMailingStateName
		,s.MemberMailingZipCode
		,@sys_date
		,cast('20991231' as date) 
		,1 
		,0 
		,s.[mastermemberid]
		,@sys_date,@sys_usr,@sys_date,@sys_usr);





		merge master.PhoneNumbers d
		using (select * from ult.ULTmembers where tobeprocessed = 'Y' and MemberPhoneNumber <> 0) s
		on (d.memberid = s.mastermemberid and d.PhoneTypeCode = 'HOME')
		when matched then 
		update set
		CountryCode = '001'
		,PhoneNbr = s.MemberPhoneNumber
		, IsActive = 1
		,MemberID = s.mastermemberid
		, ModifyDate = @sys_date
		, ModifyUser = @sys_usr
		when not matched then 
		insert (
		CountryCode
		,PhoneNbr
		, PhoneTypeCode
		, EffectiveFromDate
		,EffectiveToDate
		, IsActive
		,IsPreferredPhoneNumber
		,MemberID
		,CreateDate
		, CreateUser
		, ModifyDate
		, ModifyUser
		)
		Values ( 
		'001' 
		,s.[MemberPhoneNumber] 
		,'HOME' 
		,@sys_date
		,cast('20991231' as date) 
		,1 
		,0 
		,s.[mastermemberid] 
		,@sys_date,@sys_usr,@sys_date,@sys_usr );


		--Need to compare with memberId and InsuranceEffectiveDate if found then update if not found then insert
		--New Query for this time
		merge into master.memberinsurances d
		using (select * from ult.ULTinsurance where tobeprocessed = 'Y' and HealthPlanId is not null) s
		on (s.masterMemberId = d.MemberID and s.EligibilityEffectiveDate = d.InsuranceEffectiveDate)
		when matched then
		update set
		InsuranceCarrierID = 14,
		InsuranceEndDate = EligibilityTerminationDate,
		InsuranceHealthPlanID = s.healthplanid,
		IsActive = 1 ,
		ModifyDate = @sys_date,
		ModifyUser = @sys_usr,
		eligFileID = s.ID
		when not matched then 
		insert (CreateDate,CreateUser,InsuranceCarrierID,InsuranceEffectiveDate,InsuranceEndDate,
		InsuranceHealthPlanID,IsActive,MemberID,ModifyDate,ModifyUser,eligFileID)
		values (
		@sys_date
		, @sys_usr 
		,14 
		,EligibilityEffectiveDate 
		,EligibilityTerminationDate 
		,healthplanid 
		,1 
		,mastermemberid 
		,@sys_date 
		, @sys_usr ,s.ID );

		
		--Updating the ID from MemberInsurances so it can be used to insert data into MemberInsuranceDetails
		update i
		set memberinsuranceid = (select m.id from master.memberinsurances m where m.memberid = i.mastermemberid and m.eligFileID = i.ID and m.insurancecarrierid = 14)
		from ult.ULTinsurance i
		where tobeprocessed = 'Y'
		and memberinsuranceid is null


		merge master.MemberInsuranceDetails d
		using (select    ID
						,MemberIdentificationNumber
						,HICN
						,PlanNumber
						,EligibilityEffectiveDate
						,EligibilityTerminationDate
						,CMS_ContractID
						,ProductID
						,PBPID
						,MasterMemberId
						,NHLinkID
						,MemberInsuranceID
						,HealthPlanId
						,ToBeProcessed
						,ProcessedDate
						,CreateDate
						,CreateUser
						,ModifyDate
						,ModifyUser
						,StatusFlag, 
						case when eligibilityterminationdate < getdate() then 0 else 1 end IsInsuranceEligibilityVerified 
						 from ult.ULTinsurance where tobeprocessed = 'Y') s
		on (d.MemberInsuranceID = s.memberinsuranceid)
		when matched then 
		update set
		InsuranceNbr = s.MemberIdentificationNumber,
		IsInsuranceEligibilityVerified = s.IsInsuranceEligibilityVerified,
		ModifyDate = @sys_date,
		ModifyUser = @sys_usr,
		ISActive = 1
		when not matched then
		insert (
		CreateDate
		, CreateUser
		,InsuranceNbr
		,IsActive
		,IsInsuranceEligibilityVerified
		,MemberInsuranceID
		,ModifyDate
		,ModifyUser
		)
		values ( 
		@sys_date
		,@sys_usr
		,s.MemberIdentificationNumber
		,1 
		,s.IsInsuranceEligibilityVerified
		,s.MemberInsuranceID
		,@sys_date 
		,@sys_usr
		);




	--COMMIT TRANSACTION ULT_ELIG_MERGE_ult_to_masters
	--PRINT 'SUCCESS'
	--END TRY

	--BEGIN CATCH
	--DECLARE @ErrorMessage NVARCHAR(4000);  
 --   DECLARE @ErrorSeverity INT;  
 --   DECLARE @ErrorState INT;  

 --   SELECT   
 --       @ErrorMessage = ERROR_MESSAGE(),  
 --       @ErrorSeverity = ERROR_SEVERITY(),  
 --       @ErrorState = ERROR_STATE();  

	--IF (@@TRANCOUNT > 0)
	--BEGIN
	--	ROLLBACK TRANSACTION ULT_ELIG_MERGE_ult_to_masters
	--	RAISERROR(@ErrorMessage,@ErrorSeverity,@ErrorState);
	--	PRINT 'FAILED'
	--END

	--END CATCH

END
create view ult.ViewUltInsNotRcvd as
SELECT 
	 NHLinkID,
	[MemberIdentificationNumber],
	PlanNumber,
	[EligibilityEffectiveDate],
	[EligibilityTerminationDate],[HICN],[ProductID],
	[CMS_ContractID],[PBPID]
FROM ult.[ultInsurance] where statusflag <> 'D'
EXCEPT
SELECT	
	[MemberIdentificationNumber] NHLinkID,
	[MemberIdentificationNumber],
	PlanNumber,
	[EligibilityEffectiveDate],
	[EligibilityTerminationDate],[HICN],[ProductID],
	[CMS_ContractID],[PBPID]
FROM ult.ultStgEligData 


create view ult.ViewULTInsurance as
SELECT	
	 [MemberIdentificationNumber] NHLinkID,
	[MemberIdentificationNumber],
	PlanNumber,
	[EligibilityEffectiveDate],
	[EligibilityTerminationDate],[HICN],[ProductID],
	[CMS_ContractID],[PBPID]
FROM ult.UltStgEligData 
EXCEPT 
SELECT 
	[NHLinkID],
	[MemberIdentificationNumber],
	PlanNumber,
	[EligibilityEffectiveDate],
	[EligibilityTerminationDate],[HICN],[ProductID],
	[CMS_ContractID],[PBPID]
FROM ult.[UltInsurance]




 create view ult.ViewULTMembers as
SELECT DISTINCT [MemberIdentificationNumber] NHLinkID,
		[MemberIdentificationNumber],
		[MemberDateOfBirth],
		[MemberLastName],
		[MemberFirstName],
		[MemberMiddleName],
		[MemberPhoneNumber],
		[MemberAddressLine1],
		[MemberAddressLine2],
		[MemberCityName],
		[MemberStateName],
		[MemberZipCode],
		[MemberGender],
		[Language],
		[MemberMailingAddressLine1],
		[MemberMailingAddressLine2],
		[MemberMailingCityName],
		[MemberMailingStateName],
		[MemberMailingZipCode]
		from ult.[ULTStgEligData]
EXCEPT
SELECT 
		[NHLinkID],
		[MemberIdentificationNumber],
		[MemberDateOfBirth],
		[MemberLastName],
		[MemberFirstName],
		[MemberMiddleName],
		[MemberPhoneNumber],
		[MemberAddressLine1],
		[MemberAddressLine2],
		[MemberCityName],
		[MemberStateName],
		[MemberZipCode],
		[MemberGender],
		[MemberLanguage],
		[MemberMailingAddressLine1],
		[MemberMailingAddressLine2],
		[MemberMailingCityName],
		[MemberMailingStateName],
		[MemberMailingZipCode]
from ult.[ULTMembers]


CREATE view ult.ViewULTMemNotRcvd as
SELECT  NHLinkID,
		[MemberIdentificationNumber],
		[MemberDateOfBirth],
	--	PlanNumber,
		[MemberLastName],
		[MemberFirstName],
		[MemberMiddleName],
		[MemberPhoneNumber],
		[MemberAddressLine1],
		[MemberAddressLine2],
		[MemberCityName],
		[MemberStateName],
		[MemberZipCode],
		[MemberGender],
		[MemberLanguage],
		[MemberMailingAddressLine1],
		[MemberMailingAddressLine2],
		[MemberMailingCityName],
		[MemberMailingStateName],
		[MemberMailingZipCode]
from ult.[ultMembers] where statusflag <> 'D'
EXCEPT
SELECT DISTINCT [MemberIdentificationNumber] NHLinkID,
		[MemberIdentificationNumber],
		[MemberDateOfBirth],
		--PlanNumber,
		[MemberLastName],
		[MemberFirstName],
		[MemberMiddleName],
		[MemberPhoneNumber],
		[MemberAddressLine1],
		[MemberAddressLine2],
		[MemberCityName],
		[MemberStateName],
		[MemberZipCode],
		[MemberGender],
		[Language],
		[MemberMailingAddressLine1],
		[MemberMailingAddressLine2],
		[MemberMailingCityName],
		[MemberMailingStateName],
		[MemberMailingZipCode]
from ult.[ultStgEligData]
create view ult.ViewULTInsNeworChanges as
SELECT	
	 [MemberIdentificationNumber] NHLinkID,
	[MemberIdentificationNumber],
	PlanNumber,
	[EligibilityEffectiveDate],
	[EligibilityTerminationDate],[HICN],[ProductID],
	[CMS_ContractID],[PBPID]
FROM ult.UltStgEligData 
EXCEPT 
SELECT 
	[NHLinkID],
	[MemberIdentificationNumber],
	PlanNumber,
	[EligibilityEffectiveDate],
	[EligibilityTerminationDate],[HICN],[ProductID],
	[CMS_ContractID],[PBPID]
FROM ult.[UltInsurance] where statusflag <> 'D'
create view ult.ViewULTMemNeworChanges as
SELECT DISTINCT [MemberIdentificationNumber] NHLinkID,
		[MemberIdentificationNumber],
		[MemberDateOfBirth],
		[MemberLastName],
		[MemberFirstName],
		[MemberMiddleName],
		[MemberPhoneNumber],
		[MemberAddressLine1],
		[MemberAddressLine2],
		[MemberCityName],
		[MemberStateName],
		[MemberZipCode],
		[MemberGender],
		[Language],
		[MemberMailingAddressLine1],
		[MemberMailingAddressLine2],
		[MemberMailingCityName],
		[MemberMailingStateName],
		[MemberMailingZipCode]
		from ult.[ULTStgEligData]
EXCEPT
SELECT 
		[NHLinkID],
		[MemberIdentificationNumber],
		[MemberDateOfBirth],
		[MemberLastName],
		[MemberFirstName],
		[MemberMiddleName],
		[MemberPhoneNumber],
		[MemberAddressLine1],
		[MemberAddressLine2],
		[MemberCityName],
		[MemberStateName],
		[MemberZipCode],
		[MemberGender],
		[MemberLanguage],
		[MemberMailingAddressLine1],
		[MemberMailingAddressLine2],
		[MemberMailingCityName],
		[MemberMailingStateName],
		[MemberMailingZipCode]
from ult.[ULTMembers] where statusflag <> 'D'
CREATE PROCEDURE [uofm].[UOM_elig_file_load_ssis_sp_merge] 
@Client_Name varchar(20)
AS


IF @Client_Name = 'ELIG_UM'

BEGIN

		BEGIN TRY
	    BEGIN TRANSACTION UOM_elig_file_load_ssis

			EXEC [uofm].[UOM_elig_file_load_ssis_sp_merge_stg_to_uofm]

			EXEC [uofm].[UOM_elig_file_load_ssis_sp_merge_uofm_to_masters]


		COMMIT TRANSACTION UOM_elig_file_load_ssis

		PRINT 'SUCCESS'
		END TRY

		BEGIN CATCH
		DECLARE @ErrorMessage NVARCHAR(4000);  
		DECLARE @ErrorSeverity INT;  
		DECLARE @ErrorState INT;  

		SELECT   
			@ErrorMessage = ERROR_MESSAGE(),  
			@ErrorSeverity = ERROR_SEVERITY(),  
			@ErrorState = ERROR_STATE();  

		IF (@@TRANCOUNT > 0)
		BEGIN
			ROLLBACK TRANSACTION UOM_elig_file_load_ssis
			RAISERROR(@ErrorMessage,@ErrorSeverity,@ErrorState);
			PRINT 'FAILED'
		END

		END CATCH


END


-- EXEC [uofm].[UOM_elig_file_load_ssis_sp_merge_uofm_to_masters]

CREATE PROCEDURE [uofm].[UOM_elig_file_load_ssis_sp_merge_uofm_to_masters]
AS


BEGIN

	--BEGIN TRY
	--BEGIN TRANSACTION UOM_ELIG_MERGE_uofm_to_masters




		DECLARE @sys_usr CHAR(30)
		       ,@sys_date DATETIME;  

		SET @sys_usr = SYSTEM_USER
		SET @sys_date = CAST(GETDATE() AT TIME ZONE 'UTC' AT TIME ZONE 'Eastern Standard Time' AS DATETIME);  -- Time in EST

		-- drop not null record insert constraint (unique index) on NHMemberID in master.members before inserting new members or updating NHMemberID for new records inserted
		ALTER TABLE [otc].[Cards] DROP CONSTRAINT [FK_Cards_NHMemberId]
		
		ALTER TABLE [Master].[Members] DROP CONSTRAINT [IX_Members_NHMemberID_U]


		merge into master.members d
		using (select * from uofm.UMmembers where tobeprocessed = 'Y') s
		on (d.memberid = s.mastermemberid )
		when matched then 
		update set
		d.EligFile = 'ELIG_UM',
		d.eligFileID = s.ID,
		d.datasource = 'ELIG_UM',
		d.DateOfBirth = s.MembersDateOfBirth,
		d.FirstName = s.MemberFirstName,
		d.Gender = s.MemberSex,
		d.IsActive = 1,
		d.LastName = s.MemberLastName,
		d.MiddleInitial = s.MemberMiddleName,
		d.ModifyDate = @sys_date,
		d.ModifyUser = @sys_usr
		when not matched then 
		insert 
		( EligFile, EligFileID, DataSource, CreateDate, CreateUser,
		 DateOfBirth, FirstName, Gender, IsActive, LastName,
		 MiddleInitial, ModifyDate, ModifyUser ) 
		 values 
		 ('ELIG_UM',ID,'ELIG_UM',@sys_date,@sys_usr
		,MembersDateOfBirth,MemberFirstName
		,MemberSex,1,MemberLastName
		,MemberMiddleName,@sys_date,@sys_usr);

		-- Assign mastermemberid in uofm after inserting new records into master.members
		update a 
		set mastermemberid = (select memberid from master.members m where m.EligFileID = a.id and m.EligFile = 'ELIG_UM')
		from uofm.UMmembers a
		where tobeprocessed = 'Y'
		and mastermemberid is null
		
		
		-- Update NHMemberID for newly inserted members 
		UPDATE [Master].[Members]
		SET nhmemberid = 'NH'+RIGHT(YEAR(GETDATE()),4)+ FORMAT(memberid,'00000000')							 --    'NH2018'+ FORMAT(memberid,'00000000')
		WHERE EligFile = 'ELIG_UM'
		AND nhmemberid IS NULL


		-- Re create the unique NHMemberID index
		ALTER TABLE [Master].[Members] ADD  CONSTRAINT [IX_Members_NHMemberID_U] UNIQUE NONCLUSTERED 
				(
					[NHMemberID] ASC
				)

		ALTER TABLE [otc].[Cards]  ADD  CONSTRAINT [FK_Cards_NHMemberId] FOREIGN KEY
		(
			[NHMemberId]
		)
		REFERENCES [Master].[Members] ([NHMemberID])

		-- Assign mastermemberid to uofm records from members joining on NHLinkID		
		update i
		set mastermemberid = (select mastermemberid from uofm.UMMembers m where m.NHLinkID = i.NHLinkID )
		from uofm.UMInsurance i
		where exists (select 1 from uofm.UMmembers m1 where m1.NHLinkID = i.NHLinkID)
		and mastermemberid is null 

		-- Update address
		merge master.addresses d
		using (select * from uofm.UMmembers where tobeprocessed = 'Y' and MemberAddressLine1 <> '') s
		on (d.memberid = s.mastermemberid and d.AddressTypeCode = 'PERM')
		when matched then
		update set
		Address1 = s.MemberAddressLine1
		,Address2 = s.MemberAddressLine2
		,City = s.MemberCityName
		,State = s.MemberStateName
		,ZipCode = s.MemberZipCode
		,IsActive = 1
		,IsPreferredAddress = 1
		,MemberID = s.mastermemberid
		,ModifyDate = @sys_date
		, ModifyUser = @sys_usr
		when not matched then 
		insert 
		( Address1,Address2,AddressTypeCode,City,State,ZipCode
		,EffectiveFromDate,EffectiveToDate,IsActive,IsPreferredAddress,MemberID
		,CreateDate,CreateUser,ModifyDate, ModifyUser)
		values
		( s.MemberAddressLine1,s.MemberAddressLine2,'PERM',s.MemberCityName,s.MemberStateName,s.MemberZipCode
		,@sys_date ,cast('20991231' as date) ,1 ,1 ,s.mastermemberid
		,@sys_date,@sys_usr,@sys_date,@sys_usr);


		merge master.addresses d
		using (select * from uofm.UMmembers where tobeprocessed = 'Y' and MemberMailingAddressLine1 <> '') s
		on (d.memberid = s.mastermemberid and d.AddressTypeCode = 'MAIL')
		when matched then
		update set
		Address1 = s.MemberMailingAddressLine1
		,Address2 = s.MemberMailingAddressLine2
		,City = s.MemberMailingCityName
		,State = s.MemberMailingStateName
		,ZipCode = s.MemberMailingZipCode
		,IsActive = 1
		,MemberID = s.mastermemberid
		,ModifyDate = @sys_date
		, ModifyUser = @sys_usr
		when not matched then 
		insert 
		( Address1,Address2,AddressTypeCode,City,State,ZipCode
		,EffectiveFromDate,EffectiveToDate,IsActive,IsPreferredAddress,MemberID
		,CreateDate,CreateUser,ModifyDate, ModifyUser)
		values(
		 s.MemberMailingAddressLine1,s.MemberMailingAddressLine2,'MAIL',s.MemberMailingCityName,s.MemberMailingStateName,s.MemberMailingZipCode
		,@sys_date ,cast('20991231' as date) ,1 ,0 ,s.mastermemberid
		,@sys_date,@sys_usr,@sys_date,@sys_usr);


		merge master.PhoneNumbers d
		using (select * from uofm.UMmembers where tobeprocessed = 'Y' and MemberPhoneNumber <> 0) s
		on (d.memberid = s.mastermemberid and d.PhoneTypeCode = 'HOME')
		when matched then 
		update set
		CountryCode = '001'
		,PhoneNbr = s.MemberPhoneNumber
		, IsActive = 1
		,MemberID = s.mastermemberid
		, ModifyDate = @sys_date
		, ModifyUser = @sys_usr
		when not matched then 
		insert (CountryCode,PhoneNbr, PhoneTypeCode, EffectiveFromDate,EffectiveToDate
		, IsActive,IsPreferredPhoneNumber,MemberID,CreateDate, CreateUser, ModifyDate, ModifyUser
		)
		Values ( '001' ,s.MemberPhoneNumber ,'HOME' ,@sys_date ,cast('20991231' as date) 
		,1 ,0 ,s.mastermemberid ,@sys_date ,@sys_usr ,@sys_date ,@sys_usr );


		merge into master.memberinsurances d
		using (select * from uofm.UMinsurance where tobeprocessed = 'Y' ) s
		on (s.memberinsuranceid = d.id)
		when matched then
		update set
		d.InsuranceEndDate = CASE statusflag WHEN 'D' THEN (CASE WHEN DATEDIFF(dd, cast(d.InsuranceEndDate AS DATE), CAST(GETDATE()-1 AS DATE)) < 0 THEN CAST(GETDATE()-1 AS DATE) ELSE cast(d.InsuranceEndDate AS DATE) END  )  ELSE EligibilityTerminationDate END,
		--InsuranceEndDate = case statusflag when 'D' then cast(getdate()-1 as date) else EligibilityTerminationDate end, 
		InsuranceHealthPlanID = s.healthplanid,
		IsActive = case statusflag when 'D' then 0 else 1 end,
		ModifyDate = @sys_date,
		ModifyUser = @sys_usr
		when not matched then 
		insert (CreateDate,CreateUser,InsuranceCarrierID,InsuranceEffectiveDate,InsuranceEndDate,
		InsuranceHealthPlanID,IsActive,MemberID,ModifyDate,ModifyUser,eligFileID,eligFile)
		values (
		@sys_date
		,@sys_usr
		,15 
		,EligibilityEffectiveDate 
		,EligibilityTerminationDate 
		,healthplanid 
		,1 
		,mastermemberid 
		,@sys_date
		,@sys_usr ,s.ID ,'ELIG_UM');


		update i
		set memberinsuranceid = (select m.id from master.memberinsurances m where m.memberid = i.mastermemberid and m.eligfileid = i.ID  and m.insurancecarrierid = 15)
		from uofm.UMinsurance i
		where tobeprocessed = 'Y'
		and memberinsuranceid is null


		merge master.MemberInsuranceDetails d
		using (select * from uofm.UMinsurance where tobeprocessed = 'Y') s
		on (d.MemberInsuranceID = s.memberinsuranceid)
		when matched then 
		update set
		GroupNbr = s.GroupNumber,
		InsuranceNbr = s.MemberIdentificationNumber,
		IsInsuranceEligibilityVerified = case s.statusflag when 'D' then 0 else 1 end,
		ModifyDate = @sys_date,
		ModifyUser = @sys_usr
		when not matched then
		insert (
		CreateDate
		, CreateUser
		,GroupNbr
		,InsuranceNbr
		,IsActive
		,IsInsuranceEligibilityVerified
		,MemberInsuranceID
		,ModifyDate
		,ModifyUser
		)
		values ( 
		@sys_date 
		,@sys_usr
		,s.GroupNumber 
		,s.MemberIdentificationNumber
		,1 
		,1 
		,s.MemberInsuranceID
		,@sys_date
		,@sys_usr 
		);




	--COMMIT TRANSACTION UOM_ELIG_MERGE_uofm_to_masters
	--PRINT 'SUCCESS'
	--END TRY

	--BEGIN CATCH
	--DECLARE @ErrorMessage NVARCHAR(4000);  
 --   DECLARE @ErrorSeverity INT;  
 --   DECLARE @ErrorState INT;  

 --   SELECT   
 --       @ErrorMessage = ERROR_MESSAGE(),  
 --       @ErrorSeverity = ERROR_SEVERITY(),  
 --       @ErrorState = ERROR_STATE();  

	--IF (@@TRANCOUNT > 0)
	--BEGIN
	--	ROLLBACK TRANSACTION UOM_ELIG_MERGE_uofm_to_masters
	--	RAISERROR(@ErrorMessage,@ErrorSeverity,@ErrorState);
	--	PRINT 'FAILED'
	--END

	--END CATCH

END


-- EXEC [uofm].[UOM_elig_file_load_ssis_sp_merge_stg_to_uofm]

CREATE PROCEDURE [uofm].[UOM_elig_file_load_ssis_sp_merge_stg_to_uofm]
AS


BEGIN

	--BEGIN TRY
	--BEGIN TRANSACTION UOM_ELIG_MERGE_stg_to_uofm




		DECLARE @sys_usr CHAR(30)
		       ,@sys_date DATETIME;  

		SET @sys_usr = SYSTEM_USER
		SET @sys_date = CAST(GETDATE() AT TIME ZONE 'UTC' AT TIME ZONE 'Eastern Standard Time' AS DATETIME);  -- Time in EST

		DROP TABLE IF EXISTS uofm.DataViewUMMembers
		
        DROP TABLE IF EXISTS uofm.DataVUMMemNotRcvd

		DROP TABLE IF EXISTS uofm.DataVUMIns
		
        DROP TABLE IF EXISTS uofm.DataVUMInsNotRcvd


		--create index UMstgeligdata_idx4 on uofm.UMStgEligData (memberidentificationnumber)

		-- Update phonenumbers by removing chars
		UPDATE uofm.UMStgEligData
		SET memberPhoneNumber = dbo.fn_extract_numbers_Only(MemberPhoneNumber)
		WHERE LEN(MemberPhoneNumber) <> 10


		SELECT * 
		INTO uofm.DataViewUMMembers 
		FROM uofm.ViewUMMembers 

		CREATE INDEX dataview_idx1 ON uofm.DataViewUMMembers(NHLinkID) 

		SELECT * 
		INTO uofm.DataVUMMemNotRcvd 
		FROM uofm.ViewUMMemNotRcvd n 
		WHERE not exists (select 1 from uofm.DataViewUMMembers d where d.NHLinkID = n.NHLinkID) 

		create index dataview_idx2 on uofm.DataVUMMemNotRcvd (NHLinkID)

		----------------------------------------------------------------------------------------------

		select * 
		into uofm.DataVUMIns 
		from uofm.ViewUMInsurance

		create index dataview_idx3 on uofm.DataVUMIns(NHLinkID) 

		select * 
		into uofm.DataVUMInsNotRcvd 
		from uofm.ViewUMInsNotRcvd n 
		where not exists (select 1 from uofm.DataVUMIns d where d.NHLinkID = n.NHLinkID and d.EligibilityEffectiveDate = n.EligibilityEffectiveDate)

		create index dataview_idx4 on uofm.DataVUMInsNotRcvd (NHLinkID,EligibilityEffectiveDate)	--@@

		
		-- Set all records not to be processed
		UPDATE 
		uofm.UMmembers
		SET ToBeProcessed = 'N'	
		where ToBeProcessed = 'Y'	--@@

		UPDATE 
		uofm.UMinsurance
		SET ToBeProcessed = 'N'
		where ToBeProcessed = 'Y'

		-- Insert if there are any new members or update any changes to existing members
		MERGE uofm.UMmembers m USING uofm.DataViewUMMembers d
		ON (m.NHLinkID = d.NHLinkID)
		WHEN MATCHED THEN
		UPDATE SET
		MemberIdentificationNumber = d.MemberIdentificationNumber,
		MembersDateOfBirth = d.MembersDateOfBirth,
		MemberLastName = d.MemberLastName,
		MemberFirstName = d.MemberFirstName,
		MemberMiddleName = d.MemberMiddleName,
		MemberPhoneNumber = d.MemberPhoneNumber,
		MemberAddressLine1 = d.MemberAddressLine1,
		MemberAddressLine2 = d.MemberAddressLine2,
		MemberCityName = d.MemberCityName,
		MemberStateName = d.MemberStateName,
		MemberZipCode = d.MemberZipCode,
		MemberDateOfDeath = d.MemberDateOfDeath,
		MemberSex = d.MemberSex,
		MemberRace = d.MemberRace,
		MemberLanguage = d.MemberLanguage,
		MemberMailingAddressLine1 = d.MemberMailingAddressLine1,
		MemberMailingAddressLine2 = d.MemberMailingAddressLine2,
		MemberMailingCityName = d.MemberMailingCityName,
		MemberMailingStateName = d.MemberMailingStateName,
		MemberMailingZipCode = d.MemberMailingZipCode,
		statusflag = 'U',
		tobeprocessed = 'Y',
		ModifyDate = @sys_date,
		ModifyUser = @sys_usr
		WHEN NOT MATCHED THEN
		INSERT (
		NHLinkID,
		MemberIdentificationNumber,
		MembersDateOfBirth,
		MemberLastName,
		MemberFirstName,
		MemberMiddleName,
		MemberPhoneNumber,
		MemberAddressLine1,
		MemberAddressLine2,
		MemberCityName,
		MemberStateName,
		MemberZipCode,
		MemberDateOfDeath,
		MemberSex,
		MemberRace,
		MemberLanguage,
		MemberMailingAddressLine1,
		MemberMailingAddressLine2,
		MemberMailingCityName,
		MemberMailingStateName,
		MemberMailingZipCode,
		statusflag,
		tobeprocessed,
		CreateUser,
		ModifyDate,
		ModifyUser)
		VALUES (
		d.NHLinkID,
		d.MemberIdentificationNumber,
		d.MembersDateOfBirth,
		d.MemberLastName,
		d.MemberFirstName,
		d.MemberMiddleName,
		d.MemberPhoneNumber,
		d.MemberAddressLine1,
		d.MemberAddressLine2,
		d.MemberCityName,
		d.MemberStateName,
		d.MemberZipCode,
		d.MemberDateOfDeath,
		d.MemberSex,
		d.MemberRace,
		d.MemberLanguage,
		d.MemberMailingAddressLine1,
		d.MemberMailingAddressLine2,
		d.MemberMailingCityName,
		d.MemberMailingStateName,
		d.MemberMailingZipCode,
		'N',
		'Y',
		@sys_usr
		, @sys_date
		, @sys_usr
		);


		-- Update status flag for records which we didn't received in new eligibility file 
		UPDATE a
		SET StatusFlag = 'D',		--@@
		ToBeProcessed = 'Y', 
		ModifyDate = @sys_date, 
		ModifyUser = @sys_usr
		FROM uofm.UMmembers a
		WHERE EXISTS ( SELECT 1 FROM uofm.DataVUMMemNotRcvd d WHERE d.NHLinkID = a.NHLinkID )        
		AND a.StatusFlag <> 'D'

		-- Insert if there are any new members or update any changes to existing members
		MERGE uofm.UMinsurance i USING uofm.DataVUMIns d
		ON (i.NHLinkID = d.NHLinkID and i.EligibilityEffectiveDate = d.EligibilityEffectiveDate)
		WHEN MATCHED THEN
		UPDATE SET
		EligibilityTerminationDate = d.EligibilityTerminationDate,
		GroupNumber = d.GroupNumber,
		statusflag = 'U',
		tobeprocessed = 'Y',
		ModifyDate = @sys_date,
		ModifyUser = @sys_usr
		WHEN NOT MATCHED THEN
		INSERT (
		NHLinkID,MemberIdentificationNumber,EligibilityEffectiveDate,EligibilityTerminationDate,
		GroupNumber,PlanNumber,statusflag,tobeprocessed,
		CreateUser,ModifyDate,ModifyUser)
		VALUES (
		d.NHLinkID,d.MemberIdentificationNumber, d.EligibilityEffectiveDate,d.EligibilityTerminationDate
		,d.GroupNumber,d.ClaimNumber,'N','Y',
		@sys_usr, @sys_date, @sys_usr);


		-- Update status flag in records for which we didn't received in new eligibility file 
		update a
		set statusflag = 'D', 
		tobeprocessed = 'Y', 
		EligibilityTerminationDate = cast(getdate()-1 as date),  
		modifydate = @sys_date, 
		modifyuser = @sys_usr
		from uofm.UMinsurance a
		where exists (select 1 from uofm.DataVUMInsNotRcvd d where d.NHLinkID = a.NHLinkID  and d.EligibilityEffectiveDate = a.EligibilityEffectiveDate)
		and  a.EligibilityTerminationDate > cast(getdate() as date)	
		AND a.StatusFlag <> 'D'

		-- Update healthplanid based on carrier and insurance health plan
		update i
		set healthplanid = (select insurancehealthplanid from insurance.insurancehealthplans hp 
							 where hp.insurancecarrierid = 15 
							   and hp.InsuranceHealthPlanID <> 37
							   and hp.healthplannumber is not null
							   and hp.healthplannumber = i.PlanNumber )
		from  uofm.UMInsurance i
		where tobeprocessed = 'Y' 

		-- Update records where plan number is not available
		update uofm.uminsurance
		set statusflag = 'E', tobeprocessed = 'E' 
		where tobeprocessed = 'Y' 
		and  isnull(healthplanid,'') = '' 


		


	--COMMIT TRANSACTION UOM_ELIG_MERGE_stg_to_uofm
	--PRINT 'SUCCESS'
	--END TRY

	--BEGIN CATCH
	--DECLARE @ErrorMessage NVARCHAR(4000);  
 --   DECLARE @ErrorSeverity INT;  
 --   DECLARE @ErrorState INT;  

 --   SELECT   
 --       @ErrorMessage = ERROR_MESSAGE(),  
 --       @ErrorSeverity = ERROR_SEVERITY(),  
 --       @ErrorState = ERROR_STATE();  

	--IF (@@TRANCOUNT > 0)
	--BEGIN
	--	ROLLBACK TRANSACTION UOM_ELIG_MERGE_stg_to_uofm
	--	RAISERROR(@ErrorMessage,@ErrorSeverity,@ErrorState);
	--	PRINT 'FAILED'
	--END

	--END CATCH

END


create view uofm.ViewUMInsurance as
SELECT	
	 MemberIdentificationNumber NHLinkID,
	MemberIdentificationNumber,
	ClaimNumber,
	EligibilityEffectiveDate,
	EligibilityTerminationDate,
	GroupNumber
FROM uofm.UMStgEligData 
EXCEPT 
SELECT 
	MemberIdentificationNumber NHLinkID,
	MemberIdentificationNumber,
	PlanNumber,
	EligibilityEffectiveDate,
	EligibilityTerminationDate,
	GroupNumber
FROM uofm.UMInsurance
create view uofm.ViewUMInsNotRcvd as
SELECT 
	MemberIdentificationNumber NHLinkID,
	MemberIdentificationNumber,
	PlanNumber,
	EligibilityEffectiveDate,
	EligibilityTerminationDate,
	GroupNumber
FROM uofm.UMInsurance
EXCEPT
SELECT	
	MemberIdentificationNumber NHLinkID,
	MemberIdentificationNumber,
	ClaimNumber,
	EligibilityEffectiveDate,
	EligibilityTerminationDate,
	GroupNumber
FROM uofm.UMStgEligData 

CREATE view uofm.ViewUMMemNotRcvd as
SELECT MemberIdentificationNumber NHLinkID,
		MemberIdentificationNumber,
		MembersDateOfBirth,
		MemberLastName,
		MemberFirstName,
		MemberMiddleName,
		MemberPhoneNumber,
		MemberAddressLine1,
		MemberAddressLine2,
		MemberCityName,
		MemberStateName,
		MemberZipCode,
		MemberDateOfDeath,
		MemberSex,
		MemberRace,
		MemberLanguage,
		MemberMailingAddressLine1,
		MemberMailingAddressLine2,
		MemberMailingCityName,
		MemberMailingStateName,
		MemberMailingZipCode
from uofm.UMMembers
EXCEPT
SELECT DISTINCT MemberIdentificationNumber NHLinkID,
		MemberIdentificationNumber,
		MembersDateOfBirth,
		MemberLastName,
		MemberFirstName,
		MemberMiddleName,
		MemberPhoneNumber,
		MemberAddressLine1,
		MemberAddressLine2,
		MemberCityName,
		MemberStateName,
		MemberZipCode,
		MemberDateOfDeath,
		MemberSex,
		MemberRace,
		MemberLanguage,
		MemberMailingAddressLine1,
		MemberMailingAddressLine2,
		MemberMailingCityName,
		MemberMailingStateName,
		MemberMailingZipCode
from uofm.UMStgEligData

CREATE view uofm.ViewUMMembers as
SELECT DISTINCT MemberIdentificationNumber NHLinkID,
		MemberIdentificationNumber,
		MembersDateOfBirth,
		MemberLastName,
		MemberFirstName,
		MemberMiddleName,
		MemberPhoneNumber,
		MemberAddressLine1,
		MemberAddressLine2,
		MemberCityName,
		MemberStateName,
		MemberZipCode,
		MemberDateOfDeath,
		MemberSex,
		MemberRace,
		MemberLanguage,
		MemberMailingAddressLine1,
		MemberMailingAddressLine2,
		MemberMailingCityName,
		MemberMailingStateName,
		MemberMailingZipCode
		from uofm.UMStgEligData
EXCEPT
SELECT 
		MemberIdentificationNumber NHLinkID,
		MemberIdentificationNumber,
		MembersDateOfBirth,
		MemberLastName,
		MemberFirstName,
		MemberMiddleName,
		MemberPhoneNumber,
		MemberAddressLine1,
		MemberAddressLine2,
		MemberCityName,
		MemberStateName,
		MemberZipCode,
		MemberDateOfDeath,
		MemberSex,
		MemberRace,
		MemberLanguage,
		MemberMailingAddressLine1,
		MemberMailingAddressLine2,
		MemberMailingCityName,
		MemberMailingStateName,
		MemberMailingZipCode
from uofm.UMMembers

CREATE Procedure [vsdatamig].[sp_UpdateStgUltimateElig]

AS
BEGIN
    
    SET NOCOUNT ON
	 
	Begin try  	
		      
			Begin transaction
		
			--If the Member Insurance number exists in Master, update operation_flag -> update		     
			update [vsdatamig].[ULT_NH_ELG_DATA] set [OperationType] = 'UPDATE' from [vsdatamig].[ULT_NH_ELG_DATA] stg where 
						Exists (select minsdtl.InsuranceNbr from [Master].[MemberInsuranceDetails] minsdtl where minsdtl.InsuranceNbr = stg.SubID)

		   --If Member Insurance number does not exists then update operation_flag -> add		 
   			 update [vsdatamig].[ULT_NH_ELG_DATA] set [OperationType] = 'ADD' from [vsdatamig].[ULT_NH_ELG_DATA] stg where 
						not Exists (select minsdtl.InsuranceNbr from [Master].[MemberInsuranceDetails] minsdtl where minsdtl.InsuranceNbr = stg.SubID)

		   -- If Member Insurance number exists in master and does not exist in staging insert a record with 2 fields (NHMemberID, operation_Flag-->delete)
			Insert into [vsdatamig].[ULT_NH_ELG_DATA] ( NHMemberID, [OperationType] )   
			 select NHMemberID,'DELETE' from [Master].[Members]	mem where MemberID in (select MemberID from [Master].[MemberInsurances] mins
					join [Master].[MemberInsuranceDetails] minsdtl on mins.ID= minsdtl.MemberInsuranceID  where 
						getdate() not between mins.InsuranceEffectiveDate and mins.InsuranceEndDate and mem.DataSource='ULTIMATE' and minsdtl.InsuranceNbr not in (select [SubID] from [vsdatamig].[ULT_NH_ELG_DATA] where [SubID] is not null)) 
   
		   -- Terminate Insurance (Member.MemberInsurances.effectivetodate  with getdate()-1 ) for all Delete members
		   update [Master].[MemberInsurances] set InsuranceEndDate = Getdate()-1 where MemberID in 
				  (Select MemberID from [Master].[Members] where NHMemberID in 
				   		(Select NHMemberID from [vsdatamig].[ULT_NH_ELG_DATA] where NHMemberID is not null and [OperationType] = 'DELETE' ))

	  Commit transaction           
   end try
   Begin catch
		declare @error int, @message varchar(4000), @xstate int;
        select @error = ERROR_NUMBER(),
                 @message = ERROR_MESSAGE(), @xstate = XACT_STATE();
        if @xstate = -1
            rollback transaction;
        if @xstate = 1 
            rollback transaction       
			return;
   End catch

END


CREATE Procedure [vsdatamig].[sp_UpdateStgEonElig]

AS
BEGIN
    
    SET NOCOUNT ON
	 
	Begin try  	
		      
			Begin transaction
		
			--If the Member Insurance number exists in Master, update operation_flag -> update
			update [vsdatamig].[EON_ELIG_DATA] set [OperationType] = 'UPDATE' from [vsdatamig].[EON_ELIG_DATA] stg where 
						Exists (select minsdtl.InsuranceNbr from [Master].[MemberInsuranceDetails] minsdtl where minsdtl.InsuranceNbr = stg.[Member ID])

		   --If Member Insurance number does not exists then update operation_flag -> add		 
   			 update [vsdatamig].[EON_ELIG_DATA] set [OperationType] = 'ADD' from [vsdatamig].[EON_ELIG_DATA] stg where 
						not Exists (select minsdtl.InsuranceNbr from [Master].[MemberInsuranceDetails] minsdtl where minsdtl.InsuranceNbr = stg.[Member ID])

		   -- If Member Insurance number exists in master and does not exist in staging insert a record with 2 fields (NHMemberID, operation_Flag-->delete)			
			Insert into [vsdatamig].[EON_ELIG_DATA] ( NHMemberID, [OperationType] )   
			 select NHMemberID,'DELETE' from [Master].[Members] mem where MemberID in (select MemberID from [Master].[MemberInsurances] mins 
					  join [Master].[MemberInsuranceDetails] minsdtl on mins.ID= minsdtl.MemberInsuranceID  where 
					getdate() not between mins.InsuranceEffectiveDate and mins.InsuranceEndDate and mem.DataSource='EON' and minsdtl.InsuranceNbr not in (select [Member ID] from [vsdatamig].[EON_ELIG_DATA] where [Member ID] is not null))  
   
		   -- Terminate Insurance (Member.MemberInsurances.effectivetodate  with getdate()-1 ) for all Delete members
		   update [Master].[MemberInsurances] set InsuranceEndDate = Getdate()-1 where MemberID in 
				  (Select MemberID from [Master].[Members] where NHMemberID in 
				   		(Select NHMemberID from [vsdatamig].[EON_ELIG_DATA] where NHMemberID is not null and [OperationType] = 'DELETE' ))

	  Commit transaction           
   end try
   Begin catch
		declare @error int, @message varchar(4000), @xstate int;
        select @error = ERROR_NUMBER(),
                 @message = ERROR_MESSAGE(), @xstate = XACT_STATE();
        if @xstate = -1
            rollback transaction;
        if @xstate = 1 
            rollback transaction       
			return;
   End catch

END
Create view vsdatamig.PPOInfo as
select 
 otd.OrderID
,otd.IsComplete
,otd.IsActive
,p.poDate PODate
,p.poSentDate POSentDate
,p.poNumber PONumber
from orders.OrderTransactionDetails otd 
outer apply OPENJSON(otd.OrderTransactionData) 
      WITH (
		poDate date,
		poSentDate date,
		poNumber varchar(20)
	  ) as p
where 1 = 1
and otd.OrderStatusCode = 'PO' 
Create view vsdatamig.PClaimInfo as
SELECT otd.ORDERID
,clm.TestingCopay
,clm.HACopay 
,clm.FittingCopay 
,clm.TestHCPCS 
,clm.HAHCPCS 
,clm.FittingHCPCS 
,clm.ICD10Code	
,case CONVERT(varchar(10),clm.FittingDate,101) when '01/01/0001' then '' when null then '' else  CONVERT(varchar(10),clm.FittingDate,101) end FittingDate
,case CONVERT(varchar(10),clm.PurchaseDate,101) when '01/01/0001' then '' when null then '' else  CONVERT(varchar(10),clm.PurchaseDate,101) end PurchaseDate
,clm.ClaimSubmittedBy
,clm.ClaimSubmitDate	
,clm.IsClaimSubmitted	
,case clm.ClaimAmount  when null then 0 else clm.ClaimAmount end ClaimAmount
,case clm.BenefitAmount  when null then 0 else clm.BenefitAmount end BenefitAmount
,clm.IsComplete	
,clm.DeliveryReceipt 
,clm.DeliveryDate
,clm.PurchaseAgmtChk
       --     JSON_VALUE([OrderTransactionData],'$.purchaseAgreementReceived') as [PurchaseAgreementRcvd],
FROM 
	[Orders].[OrderTransactionDetails] otd
cross apply openjson(otd.OrderTransactionData) with (
	 TestingCopay decimal '$.copayDues.htCopayDue'
	,HACopay decimal '$.copayDues.haCopayDue'
	,FittingCopay decimal '$.copayDues.hfCopayDue'
	,TestHCPCS varchar(20) '$.hcpcs.htHCPCS'
	,HAHCPCS varchar(20) '$.hcpcs.haHCPCS'
	,FittingHCPCS varchar(20) '$.hcpcs.hfHCPCS'
	,ICD10Code	varchar(20) '$.hcpcs.icd10Codes'
	,FittingDate varchar(15) '$.fittingDate'
	,PurchaseDate	varchar(20) '$.purchaseDate'
	,ClaimSubmittedBy	varchar(20) '$.claimSubmittedBy'
	,ClaimSubmitDate	varchar(20) '$.claimSubmitDate'
	,IsClaimSubmitted	varchar(20) '$.isClaimSubmitted'
	,ClaimAmount int '$.claimAmount'
	,BenefitAmount	int '$.benefitAmount'
	,IsComplete	varchar(20) '$.isComplete'
	,DeliveryReceipt	varchar(20) '$.deliveryReceipt'
	,DeliveryDate	varchar(20) '$.deliveryDate'
	,PurchaseAgmtChk	varchar(20) '$.purchaseAgreementChecked'
	) as clm
where 1 = 1
and otd.OrderStatusCode='CLM' 
and IsActive=1
Create view vsdatamig.PPaymentInfo as
select 
 otd.OrderID
,otd.OrderStatusCode
,otd.IsComplete
,otd.IsActive
,p.paymentDate PaymentDate
,p.paymentType PaymentType
,p.amountPaid AmountPaid
,p.cardOrBank CardorBank
,p.transactionStatus TransactionStatus
,f.name AccountName
,f.approvedAmount ApprovedAmount
,f.financeCompany FinanceCompany
,tm.totalAmount TotalAmount
,otd.OrderTransactionData
from orders.OrderTransactionDetails otd 
outer apply OPENJSON(otd.OrderTransactionData) 
      WITH (
		totalAmount decimal
	  ) as tm
outer apply OPENJSON(OrderTransactionData, '$.transactions') 
      WITH (
	         paymentDate date,
	         paymentType nvarchar(20),
			 amountPaid decimal,
			 cardOrBank nvarchar(20),
			 transactionStatus bit,
			 totalAmount bit,
			 formInputDetails nvarchar(max) as JSON
	       ) as p
outer apply OPENJSON(p.formInputDetails, '$')
      WITH(
	        name nvarchar(30),
			financeCompany nvarchar(30),
			approvedAmount int
		  ) as f
where 1 = 1
and otd.OrderStatusCode = 'PAY' 
and ISJSON(otd.OrderTransactionData) > 0
and p.amountPaid > 0 
CREATE view vsdatamig.PMemberAppts as
select  mp.MemberProfileID, AppointmentTypeName, ma.AppointmentStatus,  ma.isactive IsActive, cast(dateadd(hour, -4, ma.createdate) as date) CreateDate, cast(ma.StartDate as date) AppointmentDate
From [provider].[MemberAppointments] ma
LEFT OUTER JOIN [provider].[AppointmentTypes] at on (at.AppointmentTypeID = ma.AppointmentTypeID)
LEFT OUTER JOIN [provider].[MemberChartData] mcd on (ma.MemberChartDataID = mcd.MemberChartDataID)
LEFT OUTER JOIN [provider].[MemberCharts] mc on (mc.MemberChartID = mcd.MemberChartID)
LEFT OUTER JOIN provider.MemberProfiles mp on (mp.memberprofileid = mc.memberprofileid)
where 1 = 1
and ma.createuser not in 
(
'RMaram',
'testsatish',
'NHAdmin',
'testramu',
'Sareddy  Raj',
'sleathem',
'LBrown',
'rsareddy',
'sraghavendran',
'testmegha',
'testbhanu'
) 
CREATE view vsdatamig.PMemberProfiles as
--Removing duplicates
select NHMemberID, MemberProfileID,  FirstName, LastName, DateofBirth,  CreateDate
From (
select  NHMemberID, MemberProfileID,  upper(FirstName) FirstName, upper(LastName) LastName, Cast(DateofBirth as date) DateofBirth, cast(dateadd(hour, -4, createdate) as date) CreateDate,
dense_rank() over (partition by nhmemberid order by MemberProfileID desc) rank_code
From provider.memberProfiles
where isactive  = 1
) a
where rank_code = 1
Create view vsdatamig.PMemberInsurances as
select MemberProfileID,  InsuranceCarrierID from (
select  MemberProfileID,  InsuranceCarrierID , dense_rank() over (partition by MemberProfileID order by tablerank) rnkcode from 
		(
			select MemberProfileID,  InsuranceCarrierID, 1 tablerank, dense_rank() over (partition by MemberProfileID order by MemberInsuranceID desc) rankcode
					from Provider.MemberInsurances
					where 1 = 1
					and isactive = 1
					and insurancecarrierid <> 207
			UNION
			select MemberProfileID,  InsuranceCarrierID, 2 tablerank, dense_rank() over (partition by MemberProfileID order by ID desc) rankcode
					from Provider.MemberProgramDetails 
					where 1 = 1
					and isactive = 1
		) a
where rankcode = 1
) b
where rnkcode = 1
Create view vsdatamig.PInsurances as
select InsuranceCarrierID, InsuranceCarrierName
from insurance.insurancecarriers
where isactive = 1
Create view vsdatamig.POrderApprovalInfo as
select 
 otd.OrderID
,otd.IsComplete
,otd.IsActive
,p.approvedDate OrderApprovedDate
,p.approvedBy OrderApprovedBy
from orders.OrderTransactionDetails otd 
outer apply OPENJSON(otd.OrderTransactionData) 
      WITH (
		approvedBy varchar(50),
		approvedDate date
	  ) as p
where 1 = 1
and otd.OrderStatusCode = 'APP' 

Create view vsdatamig.POrderDocInfo as
select 
 otd.OrderID
,otd.IsComplete
,otd.IsActive
,p.hipaa OrderApprovedDate
,p.hipaaReceivedDate OrderApprovedBy
,p.aob AOB
,p.aobReceivedDate AOBRecvdDate
,p.audiogram Audiogram
,p.audiogramReceivedDate AudiogramRecvdDate
,p.nhMemberId NHMemberID
from orders.OrderTransactionDetails otd 
outer apply OPENJSON(otd.OrderTransactionData) 
      WITH (
		hipaa varchar(10),
		hipaaReceivedDate date,
		aob varchar(10),
		aobReceivedDate date,
		audiogram varchar(10),
		audiogramReceivedDate date,
		nhMemberId varchar(30)
	  ) as p
where 1 = 1
and otd.OrderStatusCode = 'DOC' 
CREATE view vsdatamig.POrderInfo as
select 
 OrderID
,MemberChartDataId
,BrandCode
,FamilyCode
,StyleCode
,TechnologyLevelCode
,DeviceCount
,OrderAmount
,o.NHMemberId
,OrderType
,RefOrderId
,Status
,o.ItemCode
,IsActive
,cast(dateadd(hour, -4, DateOrderReceived) as date) DateOrderReceived
,cast(dateadd(hour, -4, DateOrderInitiated) as date) DateOrderInitiated
,md.firstName	FirstName
,md.lastName	LastName
,md.phoneNumber  PhoneNumber
,md.dob  		DOB
,md.address		MemberAddress
,md.city		MemberCity
,md.state		MemberState
,md.zip			MemberZip
,md.insuranceCarrierName	OMDCarrierName
,md.insurancePlanName		OMDPlanName
,md.programName				OMDProgramName
,md.insuranceMemberId		OMDInsuranceNbr
,md.nhMemberId				OMDNHMemberID
,md.insuranceBenefit		OMDInsuranceBenefit
,md.benefitUsed				OMDBenefitUsed
,md.lastBenefitUsedDate		OMDLastBenefitUsedDate
,md.insCarrierId			OMDInsCarrierID
,md.insPlanId				OMDHealthPlanID
,oad.productPrice			OADProductPrice
,oad.insuranceBenefit		OADInsuranceBenefit
,oad.benefitUsed			OADBenefitUsed
,oad.benefitAvailable		OADBenefitAvailable
,oad.memberResponsibility	OADMemberResponsibility
,oad.itemcode				OADItemCode
,oad.vsPrice				OADVSPrice
,oad.vsTechLevel			OADVSTechLevel
,ship.providerBusinessName	    SHPProviderBusinessName
,ship.dba					    SHPDBA					
,ship.dispenser				    SHPDispenser				
,ship.address				    SHPAddress				
,ship.address1				    SHPAddress1				
,ship.address2				    SHPAddress2				
,ship.city					    SHPCity					
,ship.state					    SHPState					
,ship.zip					    SHPZip					
,ship.email					    SHPEmail					
,ship.phoneNumber			    SHPPhoneNumber			
,ship.shippingInstructions	    SHPShippingInstructions
,prov.providerLeagalBusinessName    PROVProviderLegalBusinessName
,prov.dba						    PROVDBA						
,prov.dispenser					    PROVDispenser					
,prov.state						    PROVState						
,prov.zip						    PROVZip						
,prov.providerId				    PROVProviderId				
,prov.emailId					    PROVEmailId					
,prov.locationId			        PROVLocationId			
,prov.address				        LocationAddress				
,prov.address1				        LocationAddress1				
,prov.address2				        LocationAddress2				
,prov.city					        LocationCity					
,prov.state					        LocationState					
,prov.zip					        LocationZip					
,prov.HCPFirstName			        HCPFirstName			
,prov.HCPlastName			        HCPLastName			
,prov.HCPnpiNumber			        HCPNPINumber			
,prov.HCPphoneNumber		        HCPPhoneNumber		
,prov.HCPId					        HCPId					
,prov.HCPFaxNumber			        HCPFaxNumber	
From orders.orders o
outer apply openjson(case when ISJSON(o.MemberData) = 1 then o.MemberData else '{}' end) with (
		 firstName varchar(50)
		,lastName varchar(50)
		,phoneNumber varchar(20)
		,dob varchar(20)
		,address		varchar(200)	'$.address.address'
		,city		varchar(100)	'$.address.city'
		,state		varchar(100)	'$.address.state'
		,zip			varchar(20)		'$.address.zip'
		,insuranceCarrierName	varchar(300)	'$.insurance.carrierName'
		,insurancePlanName		varchar(300)	'$.insurance.planName'
		,programName			varchar(300)	'$.insurance.programeName'
		,insuranceMemberId		varchar(30)		'$.insurance.insuranceMemberId'
		,nhMemberId				varchar(20)		'$.insurance.nhMemberId'
		,insuranceBenefit		int				'$.insurance.insuranceBenefit'
		,benefitUsed			int				'$.insurance.benefitUsed'
		,lastBenefitUsedDate	varchar(300)	'$.insurance.lastBenefitUsedDate'
		,insCarrierId			int
		,insPlanId				int
	) as md
outer apply openjson(o.OrderAmountData) with (
		productPrice			decimal
		,insuranceBenefit		int
		,benefitUsed			int
		,benefitAvailable		int
		,memberResponsibility	decimal
		,itemcode				varchar(150)
		,vsPrice				varchar(20)
		,vsTechLevel			varchar(50)
	) as oad
outer apply openjson(o.ShippingData) with (
		providerBusinessName	varchar(200)
		,dba					varchar(200)
		,dispenser				varchar(50)
		,address				varchar(200) '$.address.address'
		,address1				varchar(200) '$.address.address1'
		,address2				varchar(50) '$.address.address2'
		,city					varchar(100) '$.address.city'
		,state					varchar(10)	'$.address.state'
		,zip					varchar(10) '$.address.zip'
		,email					varchar(100)
		,phoneNumber			varchar(15)
		,shippingInstructions	varchar(400)
	) as ship
outer apply openjson(case when o.ProviderData = '' then '{}' else o.ProviderData end) with (
		providerLeagalBusinessName		varchar(200)
		,dba							varchar(200)
		,dispenser						varchar(50)
		,state							varchar(2)		'$.address.state'
		,zip							varchar(10)		'$.address.zip'
		,providerId						bigint
		,emailId				varchar(100)
		,locationId				int '$.address.locationId'
		,address				varchar(200) '$.address.address'
		,address1				varchar(200) '$.address.address1'
		,address2				varchar(50) '$.address.address2'
		,city					varchar(100) '$.address.city'
		,state					varchar(10)	'$.address.state'
		,zip					varchar(10) '$.address.zip'
		,HCPFirstName			varchar(50) '$.hcp.firstName'
		,HCPlastName			varchar(50) '$.hcp.lastName'
		,HCPnpiNumber			varchar(50) '$.hcp.npiNumber'
		,HCPphoneNumber			varchar(50) '$.hcp.phoneNumber'
		,HCPId			varchar(50) '$.hcp.hcpId'
		,HCPFaxNumber			varchar(50) '$.hcp.faxNumber'
	) as prov
Create view vsdatamig.POrderInitateInfo as
select 
 otd.OrderID
,otd.IsComplete
,otd.IsActive
,cast(p.orderDate as date) OrderDate
from orders.OrderTransactionDetails otd 
outer apply OPENJSON(otd.OrderTransactionData) 
      WITH (
		orderDate datetime
	  ) as p
where 1 = 1
and otd.OrderStatusCode = 'INI' 
create   view vsdatamig.viewCRMDataNew as
SELECT
  co.contactid,
  co.Fittingdt,
  co.Manufacturer,
  co.ProductFamily,
  co.ProductModel,
  co.Style,
  co.TechLevel,
  co.QtyOrdered,
  upper(co.Ear) Ear,
  cd.NHMemberID,
  cd.HCPNPINbr,
  cd.HCPName,
  cc.ClaimAmount,
  cc.HearingTestCoPayDue,
  cc.HearingAidCoPayDue,
  cc.FittingCoPayDue
FROM vsdatamig.vsCRMOrdersNew co
INNER JOIN vsdatamig.vsCRMDataNew cd
  ON (co.contactid = cd.contactid
  AND cd.active_flag = 'A')
INNER JOIN vsdatamig.vsCRMClaimsNew cc
  ON (co.contactid = cc.contactid
  AND cc.active_flag = 'A')
WHERE Fittingdt IS NOT NULL
--AND co.company = 'Anthem Funded'
AND co.active_flag = 'A'
Create view vsdatamig.PInsuranceDetails as
select 
  MemberInsuranceID
 ,GroupNbr
,isnull(InsuranceNbr,InsurerInsuranceNbr) InsuranceNbr
 from provider.memberinsurancedetails
 where IsActive = 1
 and isnull(InsuranceNbr,InsurerInsuranceNbr) is not null
Create view vsdatamig.ProductPricing as
SELECT DISTINCT
  hpc.InsuranceHealthPlanID,
  hpc.HealthPlanContractId,
  cp.FAMILYPRODUCTCATCODE,
  cp.FAMILYPRODUCTCODE,
  cp.PerDeviceCOGSPrice,
  cp.PerDeviceDispensingFee,
  cp.PerDeviceMemberPrice
FROM insurance.healthplancontracts hpc
LEFT OUTER JOIN INSURANCE.CONTRACTPRODUCTS cp
  ON (cp.HealthPlanContractId = hpc.HealthPlanContractId)
CREATE View vsdatamig.AnthemOrders as
select 
o.NHMemberID , 
o.OMDInsuranceNbr, 
case t.AppointmentDate when '' then '' else convert(varchar, cast(t.AppointmentDate as date), 101)  end TestScheduleDate,
case po.PODate when '' then '' else convert(varchar, cast(po.PODate as date), 101)  end PODate, 
case f.FittingDate when '' then '' else convert(varchar, cast(f.FittingDate as date), 101)  end FittingDate, 
upper(mp.FirstName) FirstName, 
upper(mp.LastName) LastName, 
upper(o.MemberAddress) Address1, 
''Address2, 
upper(o.MemberCity) City, 
o.MemberState State, 
o.MemberZip ZipCode, 
o.BrandCode Manufacturer,
o.TechnologyLevelCode ProductFamily, 
o.DeviceCount QtyOrdered, 
o.OrderType, 
o.Status OrderStatus,
m.DataSource
From [vsdatamig].[POrderInfo] o
LEFT OUTER JOIN [vsdatamig].[PPOInfo] PO on (po.orderid = o.orderid)
LEFT OUTER JOIN [vsdatamig].[PMemberProfiles] mp on (mp.NHMemberID = o.NHMemberID)
LEFT OUTER JOIN master.members m on (o.NHMemberID = m.NHMemberID)
LEFT OUTER JOIN vsdatamig.PTestingApptDates t on (t.NHMemberID = o.NHMemberID )
LEFT OUTER JOIN vsdatamig.PClaimInfo f on (f.orderid = o.orderid )
where o.OMDInsCarrierID = 24
and o.status = 'ACTIVE'
and o.OrderType in ('NEW','EXCHANGE')
and po.poDate is not null
create view vsdatamig.PTestingApptDates as
select * from (
select mp.NHMemberID, mp.MemberProfileID, AppointmentTypeName, ma.AppointmentStatus,  ma.isactive IsActive, cast(dateadd(hour, -4, ma.createdate) as date) CreateDate, 
cast(ma.StartDate as date) AppointmentDate,
dense_rank() over (partition by mp.MemberProfileID, AppointmentTypeName order by ma.CreateDate desc) rankcode
From [provider].[MemberAppointments] ma
LEFT OUTER JOIN [provider].[AppointmentTypes] at on (at.AppointmentTypeID = ma.AppointmentTypeID)
LEFT OUTER JOIN [provider].[MemberChartData] mcd on (ma.MemberChartDataID = mcd.MemberChartDataID)
LEFT OUTER JOIN [provider].[MemberCharts] mc on (mc.MemberChartID = mcd.MemberChartID)
LEFT OUTER JOIN provider.MemberProfiles mp on (mp.memberprofileid = mc.memberprofileid)
where 1 = 1
and ma.AppointmentStatus not in ('Cancel','Cancelled')
and at.AppointmentTypeName = 'Testing'
and ma.isactive = 1
and ma.createuser not in 
(
'RMaram',
'testsatish',
'NHAdmin',
'testramu',
'Sareddy  Raj',
'sleathem',
'LBrown',
'rsareddy',
'sraghavendran',
'testmegha',
'testbhanu'
) ) f
where f.rankcode = 1
CREATE   view [vsdatamig].[viewCRMClaimData] as
SELECT
  co.contactid,
  co.Fittingdt,
  co.Manufacturer,
  co.ProductFamily,
  co.ProductModel,
  co.Style,
  co.TechLevel,
  co.QtyOrdered,
  upper(co.Ear) Ear,
  cd.NHMemberID,
  cd.MemberID,
  cd.HCPNPINbr,
  cd.HCPName,
  cd.ProviderDBAName,
  cd.ProviderShipToAddress,
  cd.ProviderCity,
  cd.ProviderState,
  cd.ProviderZipcode,
  cd.providerPhoneNbr,
  cc.ICD10Codes,
  cc.HearingTestHCPCS,
  cc.HearingTestCoPayDue,
  cc.HearingAidHCPCS,
  cc.ClaimAmount,
  cc.FittingHCPCS,
  cc.HearingAidCoPayDue,
  cc.FittingCoPayDue
FROM vsdatamig.vsCRMOrdersNew co
INNER JOIN vsdatamig.vsCRMDataNew cd
  ON (co.contactid = cd.contactid
  AND cd.active_flag = 'A')
INNER JOIN vsdatamig.vsCRMClaimsNew cc
  ON (co.contactid = cc.contactid
  AND cc.active_flag = 'A')
WHERE Fittingdt IS NOT NULL
--AND co.company = 'Anthem Funded'
AND co.active_flag = 'A'
create view vsdatamig.TodaysAppointments as
select s1.AppointmentTypeName AppointmentType, s1.AppointmentStatus, s1.MemberProfileID, s1.isactive Active, s2.InsuranceCarrierName InsuranceName from (
select  AppointmentTypeName, ma.AppointmentStatus, mp.MemberProfileID, ma.isactive
From [provider].[MemberAppointments] ma
LEFT OUTER JOIN [provider].[AppointmentTypes] at on (at.AppointmentTypeID = ma.AppointmentTypeID)
LEFT OUTER JOIN [provider].[MemberChartData] mcd on (ma.MemberChartDataID = mcd.MemberChartDataID)
LEFT OUTER JOIN [provider].[MemberCharts] mc on (mc.MemberChartID = mcd.MemberChartID)
LEFT OUTER JOIN provider.MemberProfiles mp on (mp.memberprofileid = mc.memberprofileid)
where 1 = 1
and ma.createdate > convert(varchar(10),getdate(), 120)
) s1 
LEFT OUTER JOIN (
select MemberProfileID, InsuranceCarrierName from (
select mi.MemberProfileID,  MemberInsuranceID, InsuranceCarrierID, dense_rank() over (partition by MemberProfileID order by MemberInsuranceID) rankcode
from Provider.MemberInsurances mi
where 1 = 1
and mi.isactive = 1
and exists (  select 1 from (select  distinct mp.MemberProfileID
								From [provider].[MemberAppointments] ma
								LEFT OUTER JOIN [provider].[MemberChartData] mcd on (ma.MemberChartDataID = mcd.MemberChartDataID)
								LEFT OUTER JOIN [provider].[MemberCharts] mc on (mc.MemberChartID = mcd.MemberChartID)
								LEFT OUTER JOIN provider.MemberProfiles mp on (mp.memberprofileid = mc.memberprofileid)
								where 1 = 1
								and ma.createdate > convert(varchar(10),getdate(), 120)
			) a where a.MemberProfileID = mi.MemberProfileID)
) b
LEFT OUTER JOIN insurance.insuranceCarriers ic on (ic.InsuranceCarrierID = b.InsuranceCarrierID)
where b.rankcode = 1
) s2 on s1.memberprofileid = s2.memberprofileid
CREATE view [vsdatamig].[VSOrdersAmts] as
select d.ContactID , d.NHMemberID, o.PODate, case o.PONbr when  '' then o.PONBRAuto else o.PONbr end PONbr , o.PurchasePrice,  c.BenefitAmount, c.ClaimAmount, p.PaymentAmt
from [vsdatamig].[vsCRMDataNew] d
INNER JOIN [vsdatamig].[vsCRMOrdersNew] o on (o.contactid = d.contactid)
LEFT OUTER JOIN (
					select contactid, poNbr, sum(PaymentAmt) PaymentAmt
					from [vsdatamig].[vsCRMPaymentsNew]
					where TransactionType = 'Member Paid'
					group by contactid, poNbr 
				) p on (p.contactid = d.contactid  and (p.PONbr = case o.PONbr when  '' then o.PONBRAuto else o.PONbr end) )
LEFT OUTER JOIN [vsdatamig].[vsCRMClaimsNew] c on (c.contactid = d.contactid)
